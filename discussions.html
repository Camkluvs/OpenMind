<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foros - OpenMind AI</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/noti.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0f1419 100%);
            color: white;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(74, 158, 255, 0.2);
            padding: 20px;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            background: linear-gradient(45deg, #4a9eff, #00d4ff);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #8892a6;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(74, 158, 255, 0.1);
            color: #4a9eff;
        }

        .nav-link i {
            margin-right: 12px;
            width: 16px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
            padding: 0;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            position: relative;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: #8892a6;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: none;
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #4a9eff;
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .project-name-header {
            font-size: 14px;
            color: #4a9eff;
            font-weight: 500;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .welcome-text {
            color: #8892a6;
            font-size: 13px;
        }

        .user-name {
            color: #4a9eff;
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Contenedor principal con transiciones */
        .content-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 30px;
            overflow-y: auto;
        }

        .view.active {
            opacity: 1;
            transform: translateX(0);
        }

        .view.sliding-out {
            opacity: 0;
            transform: translateX(-100%);
        }

        /* Vista de lista de discusiones */
        .discussions-list-view {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .discussions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .discussions-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(45deg, #4a9eff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .new-discussion-btn {
            background: linear-gradient(45deg, #4a9eff, #0066cc);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .new-discussion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(74, 158, 255, 0.4);
        }

     .discussions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;

}


        /* Badge de estado */


        .discussion-status-badge.open {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .discussion-status-badge.closed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }



        /* Botón de eliminar en las cards - POSICIÓN CORREGIDA */
        .discussion-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            /* Cambiado de left a right para moverlo a la esquina superior derecha */
            background: rgba(239, 68, 68, 0.8);
            border: 1px solid rgba(239, 68, 68, 0.9);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .discussion-card:hover .discussion-delete-btn {
            opacity: 1;
        }

        .discussion-delete-btn:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        /* Asegurar que no interfiera con el badge de estado */
       .discussion-status-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 10;
}

        /* Alternativa: Si prefieres el botón en la esquina inferior derecha */

        /* Evitar que el click del botón trigger el click de la card */
        .discussion-delete-btn,
        .discussion-delete-btn-alternative {
            pointer-events: auto;
        }


/* Nuevo diseño de cards */
.discussion-card {
    aspect-ratio: 1.1;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 20px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.discussion-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #4a9eff, #00d4ff);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.discussion-card:hover {
    background: rgba(255, 255, 255, 0.12);
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
}

.discussion-card:hover::before {
    opacity: 1;
}

.discussion-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.discussion-card-date {
    color: #8892a6;
    font-size: 12px;
    font-weight: 500;
}


.discussion-status.open {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.discussion-status.closed {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.discussion-card-content {
    flex: 1;
    margin-bottom: 20px;
}

.discussion-card-title {
    font-size: 18px;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 12px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.discussion-card-preview {
    color: #8892a6;
    font-size: 13px;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.discussion-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.discussion-participants {
    display: flex;
    align-items: center;
    gap: 1px;
}

.participant-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255, 255, 255, 0.2);
    margin-left: -8px;  /* CAMBIAR ESTE VALOR */
    background: linear-gradient(135deg, #4a9eff, #00d4ff);
    font-size: 12px;
    font-weight: 600;
    color: white;
    position: relative;
    z-index: 1;
    transition: all 0.3s ease;
}



.participant-avatar:hover {
    transform: scale(1.1);
    z-index: 10;
}

.participant-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.participant-avatar.empty {
    background: rgba(255, 255, 255, 0.1);
    color: #8892a6;
}

.participants-count {
    color: #4a9eff;
    font-size: 12px;
    font-weight: 600;
    margin-left: 4px;
}

.discussion-card-stats {
    display: flex;
    gap: 12px;
    color: #8892a6;
    font-size: 12px;
}

.discussion-card-stat {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Tema claro */
[data-theme="light"] .discussion-card {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .discussion-card:hover {
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

[data-theme="light"] .discussion-card-title {
    color: #1e293b;
}

[data-theme="light"] .discussion-card-preview {
    color: #64748b;
}

[data-theme="light"] .discussion-card-date {
    color: #64748b;
}

[data-theme="light"] .discussion-card-stats {
    color: #64748b;
}

[data-theme="light"] .participant-avatar.empty {
    background: rgba(0, 0, 0, 0.1);
    color: #64748b;
}

[data-theme="light"] .participants-count {
    color: #3b82f6;
}


        .discussion-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-size: 11px;
            /* Reducir de 12px */
            gap: 10px;
        }

        .discussion-card-author {
            color: #4a9eff;
            font-weight: 500;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .discussion-delete-action {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #8892a6;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .discussion-card-stats {
            display: flex;
            gap: 12px;
            color: #6366f1;
            flex-shrink: 0;
        }

    




        .discussion-card-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .discussion-card-preview {
            color: #8892a6;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-box-orient: vertical;

            overflow: hidden;
        }

        .discussion-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .discussion-card-author {
            color: #4a9eff;
            font-weight: 500;
        }

        .discussion-card-stats {
            display: flex;
            gap: 15px;
            color: #6366f1;
        }

        .discussion-card-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #8892a6;
    grid-column: 1 / -1; /* Esto hace que ocupe todo el ancho del grid */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px; /* Darle altura mínima */
}

 

.empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
    display: block;
}

.empty-state h3 {
    font-size: 24px;
    margin-bottom: 12px;
    color: #ffffff;
    max-width: 400px; /* Limitar ancho para mejor legibilidad */
}

.empty-state p {
    max-width: 500px; /* Limitar ancho del párrafo */
    margin: 0 auto;
    line-height: 1.5;
}

        /* Vista de detalle de discusión */
        .discussion-detail-view {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            height: 100%;
        }

        .discussion-main {
            display: flex;
            flex-direction: column;
            gap: 24px;
            width: 90%;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #4a9eff;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            align-self: flex-start;
        }

        .back-button:hover {
            background: rgba(74, 158, 255, 0.1);
            border-color: #4a9eff;
            transform: translateX(-2px);
        }

/* Mejorar diseño del post principal */
.discussion-post {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    padding: 32px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
}

.discussion-post-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
}

.discussion-post-info {
    flex: 1;
    min-width: 300px;
}

.discussion-post-title {
    font-size: 28px;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 12px;
    line-height: 1.3;
    word-break: break-word;
}

.discussion-post-meta {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 14px;
    color: #8892a6;
    flex-wrap: wrap;
}

.discussion-post-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.discussion-admin-controls {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    flex-wrap: wrap;
}

/* Mejor alineación del estado */
.discussion-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex-shrink: 0;
}

/* Responsive mejoras */
@media (max-width: 768px) {
    .discussion-post {
        padding: 20px;
    }
    
    .discussion-post-title {
        font-size: 22px;
    }
    
    .discussion-post-header {
        flex-direction: column;
    }
    
    .discussion-post-actions {
        justify-content: stretch;
    }
    
    .action-btn {
        flex: 1;
        justify-content: center;
    }
}
    

        .discussion-post-author {
            color: #4a9eff;
            font-weight: 600;
        }

        .discussion-post-content {
            font-size: 16px;
            line-height: 1.6;
            color: #e2e8f0;
            margin-bottom: 24px;
            margin-left: 5px;
        }

  

        .action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #8892a6;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: rgba(74, 158, 255, 0.1);
            border-color: #4a9eff;
            color: #4a9eff;
        }

        .action-btn.liked {
            background: rgba(74, 158, 255, 0.2);
            border-color: #4a9eff;
            color: #4a9eff;
        }

        /* Sistema de respuestas */
        .replies-section {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .replies-header {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reply-form {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .reply-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
        }

        .reply-textarea:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
        }

        .reply-submit {
            background: linear-gradient(45deg, #4a9eff, #0066cc);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .reply-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
        }

        .replies-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .reply-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .reply-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .reply-author {
            color: #4a9eff;
            font-weight: 600;
            font-size: 14px;
        }

        .reply-date {
            color: #8892a6;
            font-size: 12px;
        }

        .reply-content {
            color: #e2e8f0;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .reply-actions {
            display: flex;
            gap: 12px;
        }

        .reply-action-btn {
            background: none;
            border: none;
            color: #8892a6;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .reply-action-btn:hover {
            color: #4a9eff;
            background: rgba(74, 158, 255, 0.1);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        /* 1. Variables para modo claro/oscuro */
        :root {
            --ai-bg: rgba(30, 44, 68, 0.92);
            --ai-border: rgba(74, 158, 255, 0.13);
            --ai-primary: #4a9eff;
            --ai-secondary: #8abfff;
            --ai-highlight: #48e0c7;
            --ai-tag: #53a4f5;
            --ai-block-bg: rgba(74, 158, 255, 0.08);
            --ai-block-list: #badcff;
            --ai-title: #4a9eff;
            --ai-label: #48e0c7;
            --ai-bold: #ffc86a;
            --ai-content: #e8eefc;
            --ai-list: #badcff;
            --ai-user-msg-bg: rgba(74, 158, 255, 0.22);
            --ai-user-msg-color: #d8eaff;
            --ai-ia-msg-bg: rgba(138, 191, 255, 0.13);
            --ai-ia-msg-color: #a9d3ff;
        }

        body[data-theme="light"] {
            --ai-bg: #f9fbff;
            --ai-border: #c9e4ff;
            --ai-primary: #0075ff;
            --ai-secondary: #339dff;
            --ai-highlight: #2ed7b5;
            --ai-tag: #3491f5;
            --ai-block-bg: #e7f2ff;
            --ai-block-list: #2d567e;
            --ai-title: #0066cc;
            --ai-label: #2ed7b5;
            --ai-bold: #f7b600;
            --ai-content: #334c6b;
            --ai-list: #2d567e;
            --ai-user-msg-bg: #e3f1ff;
            --ai-user-msg-color: #1d3557;
            --ai-ia-msg-bg: #f0f9ff;
            --ai-ia-msg-color: #0075ff;
        }

        /* 2. Fuente solo para IA */
        .ai-panel,
        .ai-chat-history,
        .ai-analysis-results,
        .ai-chat-input {
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
        }

        /* 3. Panel base responsive */
        .ai-panel {
            background: var(--ai-bg);
            border-radius: 16px;
            padding: 20px 18px;
            border: 1px solid var(--ai-border);
            box-shadow: 0 8px 32px rgba(20, 40, 80, 0.18);
            width: 390px;
            max-width: 100vw;
            min-width: 0;
            position: sticky;
         
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            height: 850px;
            margin-left: -75px;
        }

        .ai-panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 22px;
        }

        .ai-panel-icon {
            width: 38px;
            height: 38px;
            background: linear-gradient(45deg, var(--ai-primary), #00d4ff);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 23px;
        }

        .ai-panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .ai-analyze-btn {
            width: 90%;
            margin: 0 auto 16px auto;
            display: block;
            background: linear-gradient(45deg, var(--ai-primary), #0075ff);
            border: none;
            color: white;
            padding: 14px 0;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(74, 158, 255, 0.10);
        }

        .ai-analyze-btn:hover {
            transform: translateY(-2px) scale(1.025);
            box-shadow: 0 8px 20px rgba(74, 158, 255, 0.16);
        }

        .ai-intro-title {
            color: var(--ai-secondary);
            font-size: 1.10rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .ai-features-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ai-features-list li {
            color: #c1d7f5;
            font-size: 13px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* 4. HISTORIAL Y CHAT RESPONSIVE */
        .ai-chat-section {
            margin-top: 18px;
            padding-top: 14px;
            border-top: 1px solid rgba(74, 158, 255, 0.08);
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1 1 auto;
        }

        .ai-chat-history {
            /* Responsive max-height, min-height y ancho */
            max-height: 60vh;
            min-height: 90px;
            overflow-y: auto;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
            color: var(--ai-content);
            margin-bottom: 6px;
            display: flex;
            flex-direction: column;
            gap: 7px;
            padding: 0.5rem 0;
            border-radius: 9px;
            scroll-behavior: smooth;
        }

        .ai-chat-message {
            background: rgba(74, 158, 255, 0.07);
            border-radius: 7px;
            padding: 6px 10px;
            margin-right: 30%;
            width: fit-content;
            max-width: 90%;
        }

        .ai-chat-message.ai {
            background: var(--ai-ia-msg-bg);
            color: var(--ai-ia-msg-color);
            align-self: flex-start;
            margin-right: 40%;
        }

        .ai-chat-message.user {
            background: var(--ai-user-msg-bg);
            color: var(--ai-user-msg-color);
            align-self: flex-end;
            margin-left: 40%;
        }

        .ai-chat-form {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 5px 7px;
            border: 1px solid rgba(74, 158, 255, 0.08);
        }

        .ai-chat-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--ai-content);
            font-size: 1rem;
            padding: 7px 8px;
            outline: none;
        }

        /* --- ESTILOS VISUALES PARA RESPUESTAS DE IA --- */

        /* Título grande de secciones IA */
        .ai-chat-title,
        .ai-analysis-title {
            font-size: 1.18rem;
            font-weight: 700;
            color: var(--ai-title);
            margin-bottom: 7px;
            letter-spacing: 0.02em;
            line-height: 1.3;
            word-break: break-word;
        }

        /* Subtítulos o encabezados de secciones */
        .ai-chat-subtitle,
        .ai-analysis-subtitle {
            font-size: 1.02rem;
            font-weight: 600;
            color: var(--ai-secondary);
            margin: 8px 0 5px 0;
            line-height: 1.25;
            word-break: break-word;
        }

        /* Texto normal de respuesta IA */
        .ai-chat-message.ai,
        .ai-analysis-content {
            font-size: 1rem;
            color: var(--ai-content);
            line-height: 1.6;
            font-weight: 400;
            letter-spacing: 0.01em;
            padding-bottom: 2px;
            word-break: break-word;
        }

        /* Puntos destacados: Fortalezas, Debilidades, Impacto, etc. */
        .ai-analysis-label,
        .ai-chat-label {
            font-weight: 700;
            color: var(--ai-label);
            display: inline;
        }

        /* Etiquetas como "propuesta técnica" */
        .ai-analysis-tag,
        .ai-chat-tag {
            color: var(--ai-tag);
            font-weight: 600;
            font-size: 0.95rem;
            display: block;
            margin-bottom: 3px;
            letter-spacing: 0.01em;
        }

        /* Mejorar separación de bloques */
        .ai-analysis-section,
        .ai-chat-section-block {
            background: var(--ai-block-bg);
            border-radius: 9px;
            padding: 10px 13px;
            margin-bottom: 11px;
            box-sizing: border-box;
        }

        .ai-analysis-list,
        .ai-chat-list {
            padding-left: 17px;
            margin: 5px 0 9px 0;
            color: var(--ai-list);
            font-size: 0.96rem;
            word-break: break-word;
        }

        .ai-analysis-content b,
        .ai-chat-message.ai b {
            color: var(--ai-bold);
            font-weight: 700;
        }

        /* RESPONSIVE: para pantallas pequeñas */
        @media (max-width: 600px) {
            .ai-panel {
                width: 100vw;
                min-width: 0;
                padding: 10px 5px;
                border-radius: 0;
            }

            .ai-chat-history {
                max-height: 40vh;
                font-size: 0.98rem;
                padding: 2px 0;
            }

            .ai-analysis-section {
                padding: 10px 5px;
            }
        }

        @media (max-width: 480px) {

            .ai-chat-message,
            .ai-chat-message.ai,
            .ai-chat-message.user {
                max-width: 100%;
                margin-left: 0;
                margin-right: 0;
                font-size: 1rem;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal h3 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #ffffff;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .cancel-btn,
        .create-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .cancel-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .create-btn {
            background: linear-gradient(45deg, #4a9eff, #0066cc);
            color: white;
        }

        .create-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(74, 158, 255, 0.3);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.9);
            display: none;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .discussion-detail-view {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .ai-panel {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: block;
            }

            .discussions-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .discussion-card {
                padding: 20px;
            }

            .view {
                padding: 20px;
            }

            .discussion-post {
                padding: 24px;
            }

            .discussion-post-title {
                font-size: 24px;
            }

            .modal {
                width: 95%;
                padding: 20px;
            }
        }

        /* Estilos para respuestas anidadas */
        .reply-thread {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .reply-item.nested {
            margin-left: 40px;
            border-left: 2px solid rgba(74, 158, 255, 0.3);
            padding-left: 20px;
            position: relative;
        }

        .reply-item.nested::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, rgba(74, 158, 255, 0.3) 0%, transparent 100%);
        }

        .reply-form-inline {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: none;
        }

        .reply-form-inline.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .reply-form-inline .reply-textarea {
            min-height: 60px;
            margin-bottom: 8px;
        }

        .reply-form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .reply-form-btn {
            background: linear-gradient(45deg, #4a9eff, #0066cc);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .reply-form-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
        }

        .reply-form-btn:hover {
            transform: translateY(-1px);
        }

        .nested-indicator {
            font-size: 11px;
            color: #6366f1;
            margin-bottom: 8px;
            font-style: italic;
        }

        .reply-action-btn.active {
            color: #4a9eff;
            background: rgba(74, 158, 255, 0.1);
        }

        /* Estilos para respuestas anidadas - AGREGAR ESTO */
        .reply-thread {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .reply-item.nested {
            margin-left: 40px;
            border-left: 2px solid rgba(74, 158, 255, 0.3);
            padding-left: 20px;
            position: relative;
        }

        .reply-item.nested::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, rgba(74, 158, 255, 0.3) 0%, transparent 100%);
        }

        .reply-form-inline {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: none;
        }

        .reply-form-inline.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .reply-form-inline .reply-textarea {
            min-height: 60px;
            margin-bottom: 8px;
        }

        .reply-form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .reply-form-btn {
            background: linear-gradient(45deg, #4a9eff, #0066cc);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .reply-form-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
        }

        .reply-form-btn:hover {
            transform: translateY(-1px);
        }

        .nested-indicator {
            font-size: 11px;
            color: #6366f1;
            margin-bottom: 8px;
            font-style: italic;
        }

        .reply-action-btn.active {
            color: #4a9eff;
            background: rgba(74, 158, 255, 0.1);
        }

        /* ESTOS SON LOS ESTILOS IMPORTANTES PARA LOS BOTONES DE COLAPSO */
        .show-more-nested-btn,
        .show-less-nested-btn {
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.3);
            color: #4a9eff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin: 12px 0 0 40px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            max-width: fit-content;
        }

        .show-more-nested-btn:hover,
        .show-less-nested-btn:hover {
            background: rgba(74, 158, 255, 0.2);
            border-color: #4a9eff;
            transform: translateY(-1px);
        }

        .nested-replies-container {
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }



    

        .discussion-status i {
            font-size: 8px;
        }

        /* Reacciones rápidas */
        .quick-reactions {
            display: flex;
            gap: 8px;
            margin: 12px 0;
            flex-wrap: wrap;
        }

        .reaction-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #8892a6;
        }

        .reaction-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .reaction-btn.active {
            background: rgba(74, 158, 255, 0.2);
            border-color: #4a9eff;
            color: #4a9eff;
        }

        .reaction-btn .emoji {
            font-size: 14px;
        }

        .reaction-btn .count {
            font-weight: 600;
            min-width: 12px;
            text-align: center;
        }

        /* Indicador de escribiendo */
        .typing-indicator {
            padding: 8px 16px;
            margin: 8px 0;
            background: rgba(74, 158, 255, 0.1);
            border-radius: 20px;
            color: #4a9eff;
            font-size: 12px;
            font-style: italic;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .typing-indicator.show {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 2px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: #4a9eff;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingBounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Vista previa en hover */
        .reply-context-preview {
            position: absolute;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            max-width: 300px;
            font-size: 12px;
            color: #e2e8f0;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .reply-context-preview.show {
            opacity: 1;
            transform: translateY(0);
        }

        .reply-context-preview .preview-author {
            color: #4a9eff;
            font-weight: 600;
            margin-bottom: 4px;
        }

        /* Botones de admin para cerrar/abrir foro */
        .discussion-admin-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .admin-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #8892a6;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .admin-btn.close-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        .admin-btn.open-btn:hover {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
            color: #22c55e;
        }

        /* Menciones */
        .mention {
            background: rgba(74, 158, 255, 0.2);
            color: #4a9eff;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        .mention-suggestion {
            position: absolute;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            min-width: 150px;
        }

        .mention-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            color: #e2e8f0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .mention-item:hover,
        .mention-item.selected {
            background: rgba(74, 158, 255, 0.1);
            color: #4a9eff;
        }

        /* Respuestas deshabilitadas cuando está cerrado */
        .discussion-closed .reply-form,
        .discussion-closed .reply-form-inline {
            opacity: 0.5;
            pointer-events: none;
        }

        .discussion-closed .reply-action-btn {
            opacity: 0.5;
            pointer-events: none;
        }

        .closed-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin: 16px 0;
            font-size: 14px;
        }

        /* Header controls */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #8892a6;
             padding: 14px 13px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .control-btn:hover {
            background: rgba(74, 158, 255, 0.1);
            border-color: #4a9eff;
            color: #4a9eff;
        }

        /* Language Selector */
        .language-selector {
            position: relative;
            z-index: 200;
        }

        .language-dropdown {
            position: fixed;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 180px;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 99999;
        }

        .language-dropdown.show {
            display: block;
        }

        .language-option {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            color: #8892a6;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .language-option:hover {
            background: rgba(74, 158, 255, 0.1);
            color: #4a9eff;
        }

        .language-option.active {
            background: rgba(74, 158, 255, 0.2);
            color: #4a9eff;
        }

        /* TEMA CLARO - Light theme */
        [data-theme="light"] body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            color: #1e293b;
        }

        [data-theme="light"] .sidebar {
            background: rgba(248, 250, 252, 0.95);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .logo {
            color: #3b82f6;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .nav-link {
            color: #64748b;
        }

        [data-theme="light"] .nav-link:hover,
        [data-theme="light"] .nav-link.active {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        [data-theme="light"] .header {
            background: rgba(248, 250, 252, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .page-title {
            color: #1e293b;
        }

        [data-theme="light"] .project-name-header {
            color: #3b82f6;
        }

        [data-theme="light"] .welcome-text {
            color: #64748b;
        }

        [data-theme="light"] .user-name {
            color: #3b82f6;
        }

        [data-theme="light"] .logout-btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #64748b;
        }

        [data-theme="light"] .logout-btn:hover {
            background: rgba(255, 0, 0, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        [data-theme="light"] .discussions-title {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        [data-theme="light"] .new-discussion-btn {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        }

        [data-theme="light"] .discussion-card {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .discussion-card:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        [data-theme="light"] .discussion-card-title {
            color: #1e293b;
        }

        [data-theme="light"] .discussion-card-preview {
            color: #64748b;
        }

        [data-theme="light"] .discussion-card-author {
            color: #3b82f6;
        }

        [data-theme="light"] .discussion-card-stats {
            color: #3b82f6;
        }

        [data-theme="light"] .empty-state {
            color: #64748b;
        }

        [data-theme="light"] .empty-state h3 {
            color: #1e293b;
        }

        /* Discusión detalle - tema claro */
        [data-theme="light"] .discussion-post {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .discussion-post-title {
            color: #1e293b;
        }

        [data-theme="light"] .discussion-post-author {
            color: #3b82f6;
        }

        [data-theme="light"] .discussion-post-meta {
            color: #64748b;
        }

        [data-theme="light"] .discussion-post-content {
            color: #374151;
        }

        [data-theme="light"] .action-btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #64748b;
        }

        [data-theme="light"] .action-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        [data-theme="light"] .action-btn.liked {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        /* Respuestas - tema claro */
        [data-theme="light"] .replies-section {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .replies-header {
            color: #1e293b;
        }

        [data-theme="light"] .reply-form {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .reply-textarea {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1e293b;
        }

        [data-theme="light"] .reply-textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        [data-theme="light"] .reply-submit {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        }

        [data-theme="light"] .reply-item {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .reply-item:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        [data-theme="light"] .reply-author {
            color: #3b82f6;
        }

        [data-theme="light"] .reply-date {
            color: #64748b;
        }

        [data-theme="light"] .reply-content {
            color: #374151;
        }

        [data-theme="light"] .reply-action-btn {
            color: #64748b;
        }

        [data-theme="light"] .reply-action-btn:hover {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        /* Panel IA - tema claro */
        [data-theme="light"] .ai-panel {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .ai-panel-title {
            color: #1e293b;
        }

        [data-theme="light"] .ai-analyze-btn {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        }

        [data-theme="light"] .ai-suggestion-item {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .ai-suggestion-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }

        [data-theme="light"] .ai-suggestion-title {
            color: #3b82f6;
        }

        [data-theme="light"] .ai-suggestion-text {
            color: #64748b;
        }

        /* Modal - tema claro */
        [data-theme="light"] .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
        }

        [data-theme="light"] .modal {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .modal h3 {
            color: #1e293b;
        }

        [data-theme="light"] .form-group label {
            color: #1e293b;
        }

        [data-theme="light"] .form-group input[type="text"],
        [data-theme="light"] .form-group textarea {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1e293b;
        }

        [data-theme="light"] .form-group input[type="text"]:focus,
        [data-theme="light"] .form-group textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        [data-theme="light"] .cancel-btn {
            background: rgba(0, 0, 0, 0.1);
            color: #64748b;
        }

        [data-theme="light"] .cancel-btn:hover {
            background: rgba(0, 0, 0, 0.15);
        }

        [data-theme="light"] .create-btn {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        }

        /* Header controls - tema claro */
        [data-theme="light"] .control-btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #64748b;
        }

        [data-theme="light"] .control-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        [data-theme="light"] .language-dropdown {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .language-option {
            color: #64748b;
        }

        [data-theme="light"] .language-option:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        [data-theme="light"] .language-option.active {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        [data-theme="light"] .menu-toggle {
            color: #64748b;
        }

        [data-theme="light"] .menu-toggle:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #3b82f6;
        }

        [data-theme="light"] .back-button {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #3b82f6;
        }

        [data-theme="light"] .back-button:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }

        /* Respuestas anidadas - tema claro */
        [data-theme="light"] .reply-item.nested {
            border-left: 2px solid rgba(59, 130, 246, 0.3);
        }

        [data-theme="light"] .reply-form-inline {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .reply-form-btn {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        }

        [data-theme="light"] .reply-form-btn.cancel {
            background: rgba(0, 0, 0, 0.1);
            color: #64748b;
        }

        [data-theme="light"] .show-more-nested-btn,
        [data-theme="light"] .show-less-nested-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }

        [data-theme="light"] .show-more-nested-btn:hover,
        [data-theme="light"] .show-less-nested-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        [data-theme="light"] .nested-indicator {
            color: #3b82f6;
        }

        /* Funcionalidades avanzadas - tema claro */
        [data-theme="light"] .discussion-status.open {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        [data-theme="light"] .discussion-status.closed {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        [data-theme="light"] .reaction-btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #64748b;
        }

        [data-theme="light"] .reaction-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .reaction-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        [data-theme="light"] .mention {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        [data-theme="light"] .closed-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #dc2626;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-controls {
                flex-wrap: wrap;
                gap: 8px;
            }

            .control-btn span {
                display: none;
            }
        }

        /* Fondo para tema claro */
        [data-theme="light"] .main-content::before {
            content: '';
            position: fixed;
            top: 0;
            left: 260px;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            z-index: -1;
        }

        [data-theme="light"] .main-content.expanded::before {
            left: 0;
        }

        [data-theme="light"] .discussion-status-badge.open {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        [data-theme="light"] .discussion-status-badge.closed {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }


        /* Botón de eliminar en las cards */
        .discussion-delete-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(239, 68, 68, 0.8);
            border: 1px solid rgba(239, 68, 68, 0.9);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .discussion-card:hover .discussion-delete-btn {
            opacity: 1;
        }

        .discussion-delete-btn:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        /* Evitar que el click del botón trigger el click de la card */
        .discussion-delete-btn {
            pointer-events: auto;
        }


        /* Modal de confirmación de eliminación */
        .delete-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .delete-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .delete-modal {
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .delete-modal-overlay.show .delete-modal {
            transform: scale(1) translateY(0);
        }

        .delete-modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .delete-modal-icon {
            width: 40px;
            height: 40px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef4444;
            font-size: 18px;
        }

        .delete-modal h3 {
            color: #ef4444;
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .delete-modal-content {
            margin-bottom: 25px;
        }

        .delete-modal-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .delete-modal-warning h4 {
            color: #ef4444;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .delete-modal-warning ul {
            color: #e2e8f0;
            font-size: 13px;
            margin: 0;
            padding-left: 20px;
        }

        .delete-modal-warning li {
            margin-bottom: 4px;
        }

        .delete-modal-text {
            color: #e2e8f0;
            font-size: 14px;
            line-height: 1.5;
        }

        .delete-modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .delete-cancel-btn,
        .delete-confirm-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .delete-cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .delete-cancel-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .delete-confirm-btn {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
        }

        .delete-confirm-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        /* Tema claro para el modal de eliminación */
        [data-theme="light"] .delete-modal {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        [data-theme="light"] .delete-modal h3 {
            color: #dc2626;
        }

        [data-theme="light"] .delete-modal-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        [data-theme="light"] .delete-modal-warning h4 {
            color: #dc2626;
        }

        [data-theme="light"] .delete-modal-warning ul {
            color: #374151;
        }

        [data-theme="light"] .delete-modal-text {
            color: #374151;
        }

        [data-theme="light"] .delete-cancel-btn {
            background: rgba(0, 0, 0, 0.1);
            color: #64748b;
        }

        [data-theme="light"] .delete-cancel-btn:hover {
            background: rgba(0, 0, 0, 0.15);
        }

        /* CSS para el input de confirmación - AGREGAR AL FINAL DEL CSS */

        /* Tema oscuro (por defecto) */
        #delete-confirmation-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 8px;
            color: #ffffff !important;
            font-size: 14px;
            font-family: inherit;
            margin-top: 12px;
            transition: all 0.3s ease;
        }

        #delete-confirmation-input:focus {
            outline: none;
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
            background: rgba(255, 255, 255, 0.15) !important;
        }

        #delete-confirmation-input::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
            font-style: italic;
        }

        /* Tema claro */
        [data-theme="light"] #delete-confirmation-input {
            background: rgba(0, 0, 0, 0.05) !important;
            border: 1px solid rgba(0, 0, 0, 0.2) !important;
            color: #1e293b !important;
        }

        [data-theme="light"] #delete-confirmation-input:focus {
            border-color: #dc2626 !important;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
            background: rgba(0, 0, 0, 0.08) !important;
        }

        [data-theme="light"] #delete-confirmation-input::placeholder {
            color: rgba(0, 0, 0, 0.5) !important;
        }

        /* Estilos para análisis de IA */
        .ai-analysis-results {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .analysis-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .analysis-title {
            font-size: 14px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .analysis-content {
            font-size: 13px;
            color: #e2e8f0;
            line-height: 1.4;
            margin: 0;
        }

        .topics-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .topic-tag {
            background: rgba(74, 158, 255, 0.2);
            color: #4a9eff;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .metric-label {
            font-size: 11px;
            color: #8892a6;
            font-weight: 500;
        }

        .metric-value {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            text-align: center;
        }

        .sentiment-positivo {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .sentiment-negativo {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .sentiment-neutral {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .engagement-alto {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .engagement-medio {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .engagement-bajo {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .key-points-list {
            margin: 0;
            padding-left: 16px;
            font-size: 12px;
            color: #e2e8f0;
            line-height: 1.4;
        }

        .key-points-list li {
            margin-bottom: 4px;
        }

        .suggestions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .suggestion-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .suggestion-title {
            font-size: 12px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 4px;
        }

        .suggestion-desc {
            font-size: 11px;
            color: #8892a6;
            line-height: 1.3;
        }

        .moderator-section {
            border: 1px solid rgba(251, 191, 36, 0.3);
            background: rgba(251, 191, 36, 0.05);
        }

        .moderator-section .analysis-title {
            color: #fbbf24;
        }

        /* Análisis de IA - tema claro */
        [data-theme="light"] .ai-analysis-results {
            background: rgba(0, 0, 0, 0.02);
        }

        [data-theme="light"] .analysis-section {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .analysis-title {
            color: #3b82f6;
        }

        [data-theme="light"] .analysis-content {
            color: #374151;
        }

        [data-theme="light"] .topic-tag {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        [data-theme="light"] .metric-label {
            color: #64748b;
        }

        [data-theme="light"] .key-points-list {
            color: #374151;
        }

        [data-theme="light"] .suggestion-card {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .suggestion-title {
            color: #3b82f6;
        }

        [data-theme="light"] .suggestion-desc {
            color: #64748b;
        }

        [data-theme="light"] .moderator-section {
            border: 1px solid rgba(251, 191, 36, 0.4);
            background: rgba(251, 191, 36, 0.1);
        }

        [data-theme="light"] .moderator-section .analysis-title {
            color: #d97706;
        }

        .ai-intro-section {
            text-align: center;
            padding: 20px;
        }

        .ai-intro-title {
            color: #4a9eff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .ai-features-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ai-features-list li {
            color: #8892a6;
            font-size: 12px;
            margin-bottom: 6px;
            padding: 4px 0;
        }

        /* Tema claro */
        [data-theme="light"] .ai-intro-title {
            color: #3b82f6;
        }

        [data-theme="light"] .ai-features-list li {
            color: #64748b;
        }

        /* Efecto de análisis activo en el panel de IA */
        .ai-panel.analyzing {
            position: relative;
            overflow: hidden;
            animation: aiPulse 2s ease-in-out infinite;
            box-shadow:
                0 0 20px rgba(74, 158, 255, 0.3),
                0 0 40px rgba(74, 158, 255, 0.2),
                0 0 60px rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.5);
        }

        .ai-panel.analyzing::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg,
                    transparent,
                    rgba(74, 158, 255, 0.1),
                    transparent,
                    rgba(0, 212, 255, 0.1),
                    transparent);
            animation: aiSweep 3s linear infinite;
            z-index: 1;
        }

        .ai-panel.analyzing::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(74, 158, 255, 0.05) 50%,
                    transparent 100%);
            animation: aiShimmer 2s ease-in-out infinite alternate;
            z-index: 2;
        }

        .ai-panel.analyzing .ai-panel-header,
        .ai-panel.analyzing .ai-analyze-btn,
        .ai-panel.analyzing .ai-suggestions {
            position: relative;
            z-index: 3;
        }

        @keyframes aiPulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow:
                    0 0 20px rgba(74, 158, 255, 0.3),
                    0 0 40px rgba(74, 158, 255, 0.2),
                    0 0 60px rgba(74, 158, 255, 0.1);
            }

            50% {
                transform: scale(1.02);
                box-shadow:
                    0 0 30px rgba(74, 158, 255, 0.4),
                    0 0 60px rgba(74, 158, 255, 0.3),
                    0 0 90px rgba(74, 158, 255, 0.2);
            }
        }

        @keyframes aiSweep {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }

            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        @keyframes aiShimmer {
            0% {
                opacity: 0.3;
            }

            100% {
                opacity: 0.7;
            }
        }

        /* Tema claro */
        [data-theme="light"] .ai-panel.analyzing {
            box-shadow:
                0 0 20px rgba(59, 130, 246, 0.3),
                0 0 40px rgba(59, 130, 246, 0.2),
                0 0 60px rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }

        [data-theme="light"] .ai-panel.analyzing::before {
            background: linear-gradient(45deg,
                    transparent,
                    rgba(59, 130, 246, 0.1),
                    transparent,
                    rgba(29, 78, 216, 0.1),
                    transparent);
        }

        [data-theme="light"] .ai-panel.analyzing::after {
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(59, 130, 246, 0.05) 50%,
                    transparent 100%);
        }

        @media (max-width: 768px) {
            .ai-panel.analyzing {
                animation: aiPulseMobile 2s ease-in-out infinite;
            }

            @keyframes aiPulseMobile {

                0%,
                100% {
                    transform: scale(1);
                }

                50% {
                    transform: scale(1.01);
                }
            }
        }

        /* Efecto de análisis elegante - no nave alien */
        .ai-panel.analyzing {
            position: relative;
            animation: aiGentlePulse 2s ease-in-out infinite;
            box-shadow:
                0 0 15px rgba(74, 158, 255, 0.4),
                0 0 25px rgba(74, 158, 255, 0.2);
            border: 1px solid rgba(74, 158, 255, 0.6);
        }

        .ai-panel.analyzing::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(74, 158, 255, 0.2) 50%,
                    transparent 100%);
            animation: aiGentleSweep 3s ease-in-out infinite;
            z-index: 1;
        }

        .ai-panel.analyzing .ai-panel-header,
        .ai-panel.analyzing .ai-analyze-btn,
        .ai-panel.analyzing .ai-suggestions {
            position: relative;
            z-index: 2;
        }

        @keyframes aiGentlePulse {

            0%,
            100% {
                box-shadow:
                    0 0 15px rgba(74, 158, 255, 0.4),
                    0 0 25px rgba(74, 158, 255, 0.2);
            }

            50% {
                box-shadow:
                    0 0 20px rgba(74, 158, 255, 0.6),
                    0 0 35px rgba(74, 158, 255, 0.3);
            }
        }

        @keyframes aiGentleSweep {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        /* Tema claro */
        [data-theme="light"] .ai-panel.analyzing {
            box-shadow:
                0 0 15px rgba(59, 130, 246, 0.4),
                0 0 25px rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.6);
        }

        [data-theme="light"] .ai-panel.analyzing::before {
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(59, 130, 246, 0.2) 50%,
                    transparent 100%);
        }

        /* Scrollbar personalizado para el panel de IA */
        .ai-analysis-results::-webkit-scrollbar {
            width: 6px;
        }

        .ai-analysis-results::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .ai-analysis-results::-webkit-scrollbar-thumb {
            background: rgba(74, 158, 255, 0.3);
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .ai-analysis-results::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 158, 255, 0.5);
        }

        /* Para Firefox */
        .ai-analysis-results {
            scrollbar-width: thin;
            scrollbar-color: rgba(74, 158, 255, 0.3) rgba(255, 255, 255, 0.05);
        }

        /* Tema claro */
        [data-theme="light"] .ai-analysis-results::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .ai-analysis-results::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.4);
        }

        [data-theme="light"] .ai-analysis-results::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.6);
        }

        [data-theme="light"] .ai-analysis-results {
            scrollbar-color: rgba(59, 130, 246, 0.4) rgba(0, 0, 0, 0.05);
        }

        /* Si quieres aplicarlo también al panel completo */
        .ai-panel::-webkit-scrollbar {
            width: 6px;
        }

        .ai-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .ai-panel::-webkit-scrollbar-thumb {
            background: rgba(74, 158, 255, 0.3);
            border-radius: 3px;
        }

        .ai-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 158, 255, 0.5);
        }

        [data-theme="light"] .ai-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .ai-panel::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.4);
        }

        [data-theme="light"] .ai-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.6);
        }

        /* Scrollbar personalizado para toda la página */
        body::-webkit-scrollbar {
            width: 8px;
        }

        body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        body::-webkit-scrollbar-thumb {
            background: rgba(74, 158, 255, 0.4);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        body::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 158, 255, 0.6);
        }

        /* Para contenedores con scroll también */
        .view::-webkit-scrollbar,
        .content-wrapper::-webkit-scrollbar {
            width: 8px;
        }

        .view::-webkit-scrollbar-track,
        .content-wrapper::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .view::-webkit-scrollbar-thumb,
        .content-wrapper::-webkit-scrollbar-thumb {
            background: rgba(74, 158, 255, 0.4);
            border-radius: 4px;
        }

        .view::-webkit-scrollbar-thumb:hover,
        .content-wrapper::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 158, 255, 0.6);
        }

        /* Tema claro */
        [data-theme="light"] body::-webkit-scrollbar-track,
        [data-theme="light"] .view::-webkit-scrollbar-track,
        [data-theme="light"] .content-wrapper::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.08);
        }

        [data-theme="light"] body::-webkit-scrollbar-thumb,
        [data-theme="light"] .view::-webkit-scrollbar-thumb,
        [data-theme="light"] .content-wrapper::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
        }

        [data-theme="light"] body::-webkit-scrollbar-thumb:hover,
        [data-theme="light"] .view::-webkit-scrollbar-thumb:hover,
        [data-theme="light"] .content-wrapper::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.7);
        }

        /* Para Firefox */
        html {
            scrollbar-width: thin;
            scrollbar-color: rgba(74, 158, 255, 0.4) rgba(255, 255, 255, 0.05);
        }

        [data-theme="light"] html {
            scrollbar-color: rgba(59, 130, 246, 0.5) rgba(0, 0, 0, 0.08);
        }

                /* === SIDEBAR CON HOVER - REEMPLAZA EL CSS ANTERIOR === */
.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 80px; /* Inicia colapsado por defecto */
    height: 100vh;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border-right: 1px solid rgba(74, 158, 255, 0.2);
    padding: 20px 12px;
    z-index: 100;
     transition: all 0.5s cubic-bezier(0.5, 0, 0.5, 1);
    overflow: hidden;
}

/* Estado expandido al hacer hover */
.sidebar:hover {
    width: 260px;
    padding: 20px;
}

.sidebar.hidden {
    transform: translateX(-100%);
}

/* Logo adaptable */
.logo {
    display: flex;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    color: #4a9eff;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
    white-space: nowrap;
    overflow: hidden;
    justify-content: center;
}

.sidebar:hover .logo {
    margin-bottom: 40px;
    padding-bottom: 20px;
    justify-content: flex-start;
}

.logo-icon {
    width: 36px;
    height: 36px;
    margin-right: 0;
    background: linear-gradient(45deg, #4a9eff, #00d4ff);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.sidebar:hover .logo-icon {
    margin-right: 12px;
    width: 32px;
    height: 32px;
}

.logo-text {
    width: 0;
    opacity: 0;
    transition: all 0.3s ease;
    overflow: hidden;
}

.sidebar:hover .logo-text {
    width: auto;
    opacity: 1;
}

/* Navegación mejorada */
.nav-menu {
    list-style: none;
}

.nav-item {
    margin-bottom: 8px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 14px 8px;
    color: #8892a6;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s ease;
    font-size: 14px;
    position: relative;
    white-space: nowrap;
    overflow: hidden;
    justify-content: center;
}

.sidebar:hover .nav-link {
    justify-content: flex-start;
    padding: 14px 16px;
}

.nav-link:hover, .nav-link.active {
    background: rgba(74, 158, 255, 0.15);
    color: #4a9eff;
}

.sidebar:hover .nav-link:hover, 
.sidebar:hover .nav-link.active {
    transform: translateX(4px);
}

.nav-link i {
    margin-right: 0;
    width: 20px;
    text-align: center;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.sidebar:hover .nav-link i {
    margin-right: 14px;
}

.nav-link-text {
    width: 0;
    opacity: 0;
    transition: all 0.3s ease;
    overflow: hidden;
}

.sidebar:hover .nav-link-text {
    width: auto;
    opacity: 1;
}

/* Tooltip para iconos (solo visible cuando NO está en hover) */
.nav-link::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 70px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1000;
}

.nav-link::before {
    content: '';
    position: absolute;
    left: 62px;
    top: 50%;
    transform: translateY(-50%);
    border: 6px solid transparent;
    border-right-color: rgba(0, 0, 0, 0.9);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1000;
}

/* Solo mostrar tooltip cuando el sidebar NO está expandido */
.nav-link:hover::after,
.nav-link:hover::before {
    opacity: 1;
    visibility: visible;
}

.sidebar:hover .nav-link:hover::after,
.sidebar:hover .nav-link:hover::before {
    opacity: 0;
    visibility: hidden;
}

/* Ajuste del contenido principal */
.main-content {
    margin-left: 80px; /* Inicia con sidebar colapsado */
    min-height: 100vh;
    padding: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}

.main-content.expanded {
    margin-left: 0;
}

/* Indicador visual de hover */
.sidebar::after {
    content: '';
    position: absolute;
    top: 50%;
    right: -2px;
    transform: translateY(-50%);
    width: 4px;
    height: 40px;
    background: linear-gradient(to bottom, transparent, #4a9eff, transparent);
    border-radius: 2px;
    opacity: 0;
    transition: all 0.3s ease;
}

.sidebar:hover::after {
    opacity: 0.7;
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        width: 260px;
        padding: 20px;
    }
    
    .sidebar.show {
        transform: translateX(0);
    }
    
    .sidebar.show .logo {
        justify-content: flex-start;
        margin-bottom: 40px;
        padding-bottom: 20px;
    }
    
    .sidebar.show .logo-icon {
        margin-right: 12px;
        width: 32px;
        height: 32px;
    }
    
    .sidebar.show .logo-text {
        width: auto;
        opacity: 1;
    }
    
    .sidebar.show .nav-link {
        justify-content: flex-start;
        padding: 14px 16px;
    }
    
    .sidebar.show .nav-link i {
        margin-right: 14px;
    }
    
    .sidebar.show .nav-link-text {
        width: auto;
        opacity: 1;
    }
    
    .main-content {
        margin-left: 0;
    }
    
    /* Ocultar tooltips en móvil */
    .nav-link::after,
    .nav-link::before {
        display: none;
    }
}

/* Estados de hover mejorados */
.nav-link {
    background: linear-gradient(90deg, transparent 0%, rgba(74, 158, 255, 0.1) 100%);
    background-size: 0% 100%;
    background-repeat: no-repeat;
    background-position: left center;
}

.nav-link:hover {
    background-size: 100% 100%;
}

.nav-link.active {
    background: linear-gradient(90deg, rgba(74, 158, 255, 0.2) 0%, rgba(74, 158, 255, 0.1) 100%);
    background-size: 100% 100%;
}

/* Animación de entrada del texto */
@keyframes fadeInText {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.sidebar:hover .nav-link-text,
.sidebar:hover .logo-text {
    animation: fadeInText 0.3s ease-out;
}

/* User Menu Styles */
.user-menu {
    position: relative;
    display: flex;
    align-items: center;
}

.user-menu-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #ffffff;
    font-size: 14px;
}

.user-menu-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #4a9eff;
    transform: translateY(-1px);
}

.user-avatar-small {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    
    object-fit: cover;
    flex-shrink: 0;
}

#headerUserName {
    font-weight: 500;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.user-menu-toggle i.fa-chevron-down {
    font-size: 12px;
    transition: transform 0.3s ease;
}

.user-menu-toggle:hover i.fa-chevron-down {
    transform: rotate(180deg);
}

.user-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.2);
    border-radius: 12px;
    padding: 8px 0;
    min-width: 200px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

.user-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.user-dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: #ffffff;
    text-decoration: none;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}

.user-dropdown-item:hover {
    background-color: rgba(74, 158, 255, 0.1);
    color: #4a9eff;
}

.user-dropdown-item.logout {
    color: #ff6b6b;
}

.user-dropdown-item.logout:hover {
    background-color: rgba(255, 107, 107, 0.1);
    color: #ff8a8a;
}

.user-dropdown-item i {
    width: 16px;
    text-align: center;
    font-size: 14px;
}

.user-dropdown hr {
    margin: 8px 0;
    border: none;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* Tema claro */
[data-theme="light"] .user-menu-toggle {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #1e293b;
}

[data-theme="light"] .user-menu-toggle:hover {
    background: rgba(0, 0, 0, 0.1);
    border-color: #3b82f6;
}

[data-theme="light"] .user-avatar-small {
    border-color: #3b82f6;
}

[data-theme="light"] .user-dropdown {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
}

[data-theme="light"] .user-dropdown-item {
    color: #1e293b;
}

[data-theme="light"] .user-dropdown-item:hover {
    background-color: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

[data-theme="light"] .user-dropdown-item.logout {
    color: #dc2626;
}

[data-theme="light"] .user-dropdown-item.logout:hover {
    background-color: rgba(220, 38, 38, 0.1);
    color: #ef4444;
}

[data-theme="light"] .user-dropdown hr {
    border-top-color: rgba(0, 0, 0, 0.1);
}

.css-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4a9eff, #00d4ff);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 11px;
    border: 2px solid #4a9eff;
    flex-shrink: 0;
    font-family: inherit;
}

[data-theme="light"] .css-avatar {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-color: #3b82f6;
}


.discussion-participants {
    position: relative;
}

.discussion-participants:hover .participants-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.participants-tooltip {
    position: absolute;
    bottom: 100%;
    left: 0;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s ease;
    z-index: 1000;
    margin-bottom: 8px;
}

.participants-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 15px;
    border: 5px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.9);
}


/* Avatares en respuestas */
.reply-author-info {
    display: flex;
    align-items: center;
    gap: 8px;
}

.reply-author-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(74, 158, 255, 0.3);
}

.reply-author-avatar-initial {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4a9eff, #00d4ff);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
    border: 2px solid rgba(74, 158, 255, 0.3);
}

/* Tema claro */
[data-theme="light"] .reply-author-avatar {
    border-color: rgba(59, 130, 246, 0.3);
}

[data-theme="light"] .reply-author-avatar-initial {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-color: rgba(59, 130, 246, 0.3);
}

/* Deshabilitar interacciones cuando está cerrado */
.discussion-closed .reply-form,
.discussion-closed .reply-form-inline {
    display: none !important;
}

.discussion-closed .reply-action-btn[onclick*="showInlineReplyForm"] {
    display: none;
}

/* Estado cerrado más visible */
.discussion-status.closed {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 2px solid #ef4444;
    padding: 4px 12px;
    font-weight: 600;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Deshabilitar COMPLETAMENTE interacciones cuando está cerrado */
.discussion-closed .reply-form,
.discussion-closed .reply-form-inline,
.discussion-closed .reply-textarea,
.discussion-closed .reply-submit,
.discussion-closed .reply-action-btn[onclick*="showInlineReplyForm"] {
    display: none !important;
    pointer-events: none !important;
    opacity: 0 !important;
}

/* Mensaje de cerrado más prominente */
.closed-message {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(185, 28, 28, 0.2));
    border: 2px solid #ef4444;
    color: #ffffff;
    padding: 16px;
    border-radius: 12px;
    text-align: center;
    margin: 20px 0;
    font-size: 16px;
    font-weight: 600;
    animation: slideDown 0.5s ease-out;
}

@keyframes slideDown {
    from { 
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Botones de administración mejorados */
.admin-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #8892a6;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.admin-btn i {
    font-size: 14px;
}

.admin-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.admin-btn.close-btn {
    border-color: rgba(251, 191, 36, 0.5);
    color: #fbbf24;
}

.admin-btn.close-btn:hover {
    background: rgba(251, 191, 36, 0.1);
    border-color: #fbbf24;
    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
}

.admin-btn.open-btn {
    border-color: rgba(34, 197, 94, 0.5);
    color: #22c55e;
}

.admin-btn.open-btn:hover {
    background: rgba(34, 197, 94, 0.1);
    border-color: #22c55e;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.admin-btn.delete-btn {
    border-color: rgba(239, 68, 68, 0.5);
    color: #ef4444;
}

.admin-btn.delete-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

/* Solo mostrar controles a usuarios con permisos */
.discussion-admin-controls:empty {
    display: none;
}

/* Badge de rol del usuario */
.user-role-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-left: 8px;
}

.user-role-badge.owner {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #ffffff;
}

.user-role-badge.admin {
    background: linear-gradient(135deg, #a78bfa, #8b5cf6);
    color: #ffffff;
}

.user-role-badge.member {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
}

/* Avatar del autor en el post principal */
.discussion-post-author-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(74, 158, 255, 0.3);
}

.discussion-post-author-initial {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4a9eff, #00d4ff);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
    border: 2px solid rgba(74, 158, 255, 0.3);
}

/* Tema claro */
[data-theme="light"] .discussion-post-author-avatar {
    border-color: rgba(59, 130, 246, 0.3);
}

[data-theme="light"] .discussion-post-author-initial {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-color: rgba(59, 130, 246, 0.3);
}

/* Contenedor de indicadores de escribiendo */
.typing-indicators-container {
    margin-bottom: 16px;
    min-height: 20px;
}

/* Indicador de escribiendo mejorado */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    margin: 4px 0;
    background: rgba(74, 158, 255, 0.1);
    border-radius: 20px;
    color: #4a9eff;
    font-size: 12px;
    font-style: italic;
    animation: fadeIn 0.3s ease-in;
}

.typing-indicator.show {
    display: flex;
}

.typing-dots {
    display: flex;
    gap: 2px;
}

.typing-dot {
    width: 4px;
    height: 4px;
    background: #4a9eff;
    border-radius: 50%;
    animation: typingBounce 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.typing-dot:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes typingBounce {
    0%, 80%, 100% {
        transform: scale(0);
    }
    40% {
        transform: scale(1);
    }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Fondo principal para tema claro */
[data-theme="light"] .content-wrapper {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
}

[data-theme="light"] .view {
    background: transparent;
}

[data-theme="light"] .discussions-list-view {
    background: transparent;
}

/* Asegurar que el main-content también tenga el fondo correcto */
[data-theme="light"] .main-content {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
}

/* Si el problema persiste, agregar esto también */
[data-theme="light"] body {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%) !important;
}
    </style>
</head>

<body>
       <aside class="sidebar" id="sidebar">
    <!-- Botón toggle se crea automáticamente con JS -->
    
    <div class="logo">
        <div class="logo-icon">
            <i class="fas fa-brain"></i>
        </div>
        <div class="logo-text">OpenMind AI</div>
    </div>
    
    <nav>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span class="nav-link-text">Inicio</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="discussions.html" class="nav-link  active">
                    <i class="fas fa-comments"></i>
                    <span class="nav-link-text">Foros</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="code-editor.html"class="nav-link">
                    <i class="fas fa-code"></i>
                    <span class="nav-link-text">Editor de Código</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="chat-ai.html" class="nav-link">
                    <i class="fas fa-robot"></i>
                    <span class="nav-link-text">MindAssist IA</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="members.html" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span class="nav-link-text">Miembros</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="voice-calls.html" class="nav-link">
                    <i class="fas fa-phone"></i>
                    <span class="nav-link-text">Llamadas</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="settings.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span class="nav-link-text">Configuración</span>
                </a>
            </li>
        </ul>
    </nav>
</aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <div class="page-title" data-i18n="discussions.title">Foros</div>
                    <div class="project-name-header" id="project-name-header">Cargando...</div>
                </div>
            </div>

            <div class="header-controls">
                <button class="control-btn" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                    <span data-i18n="common.themeToggle">Cambiar Tema</span>
                </button>

                <div class="language-selector">
                    <button class="control-btn" onclick="toggleLanguageDropdown()">
                        <i class="fas fa-globe"></i>
                        <span data-i18n="common.language">Idioma</span>
                    </button>
                    <div class="language-dropdown" id="languageDropdown">
                        <!-- Se genera dinámicamente -->
                    </div>
                </div>
                <div class="notifications-container">
                    <button class="control-btn notifications-btn" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count" id="notificationCount" style="display: none;">0</span>
                    </button>
                    <div class="notifications-dropdown" id="notificationsDropdown">
                        <div class="notifications-header">
                            <h4>Notificaciones</h4>
                        </div>
                        <div class="notifications-list" id="notificationsList">
                            <div class="notification-item loading">
                                Cargando...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="user-menu">
    <div class="user-menu-toggle" onclick="toggleUserMenu()">
        <img class="user-avatar-small" id="headerAvatarImg" src="" alt="Avatar">
        <span id="headerUserName">Cargando...</span>
        <i class="fas fa-chevron-down"></i>
    </div>
    <div class="user-dropdown" id="userDropdown">
        <a href="perfil/profile.html" class="user-dropdown-item">
            <i class="fas fa-user"></i>
            Mi Perfil
        </a>
        <a href="perfil/settings-perfil.html" class="user-dropdown-item">
            <i class="fas fa-cog"></i>
            Configuración
        </a>
        <hr style="margin: 8px 0; border: none; border-top: 1px solid var(--border-color);">
        <div class="user-dropdown-item logout" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            Cerrar Sesión
        </div>
    </div>
</div>
            </div>
        </header>



        <!-- Content Wrapper con transiciones -->
        <div class="content-wrapper">
            <!-- Vista de Lista de Discusiones -->
            <div class="view discussions-list-view active" id="discussions-list-view">
                <div class="discussions-header">
                    <h2 class="discussions-title">Foros de Discusión</h2>
                    <button class="new-discussion-btn" id="new-discussion-btn">
                        <i class="fas fa-plus"></i>
                        Nueva Discusión
                    </button>
                </div>

                <div class="discussions-grid" id="discussions-grid">
                    <!-- Se cargan dinámicamente -->
                </div>
            </div>

            <!-- Vista de Detalle de Discusión -->
            <div class="view discussion-detail-view" id="discussion-detail-view">
                <div class="discussion-main">
                    <button class="back-button" onclick="showDiscussionsList()">
                        <i class="fas fa-arrow-left"></i>
                        Volver a las discusiones
                    </button>

                    <!-- Post principal de la discusión -->
                    <div class="discussion-post" id="discussion-post">
                        <!-- Se carga dinámicamente -->
                    </div>

                    <!-- Sección de respuestas -->
                    <div class="replies-section">

                        <div id="typing-indicators-container" class="typing-indicators-container">
                        <!-- Los indicadores se agregan dinámicamente aquí -->
                           </div>
                        <div class="replies-header">
                            <i class="fas fa-comments"></i>
                            Respuestas (<span id="replies-count">0</span>)
                        </div>

                        <!-- Formulario para nueva respuesta -->
                        <div class="reply-form">
                            <textarea class="reply-textarea" id="reply-textarea"
                                placeholder="Escribe tu respuesta..."></textarea>
                            <button class="reply-submit" onclick="submitReply()">
                                <i class="fas fa-paper-plane"></i> Responder
                            </button>
                        </div>

                        <!-- Lista de respuestas -->
                        <div class="replies-list" id="replies-list">
                            <!-- Se cargan dinámicamente -->
                        </div>
                    </div>
                </div>

                <div class="ai-panel">
                    <div class="ai-panel-header">
                        <div class="ai-panel-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="ai-panel-title">Analiza con MindAssist</div>
                    </div>

                    <button class="ai-analyze-btn" onclick="analyzeDiscussion()">
                        <i class="fas fa-brain"></i>
                        Analizar Discusión
                    </button>

                    <div id="ai-analysis-results" class="ai-analysis-results">
                        <div class="ai-intro-section">
                            <h3 class="ai-intro-title">Nuestra IA te ayuda en:</h3>
                            <ul class="ai-features-list">
                                <li><i class="fas fa-comments"></i> Análisis de discusiones</li>
                                <li><i class="fas fa-tags"></i> Temas principales</li>
                                <li><i class="fas fa-magic"></i> Sugerencias técnicas</li>
                                <li><i class="fas fa-user-shield"></i> Moderación</li>
                            </ul>
                        </div>
                    </div>

                   <div class="ai-chat-section" style="display: none;">
                        <div id="ai-chat-history" class="ai-chat-history">
                        </div>
                        <form id="ai-chat-form" class="ai-chat-form">
                            <input type="text" id="ai-chat-input" class="ai-chat-input"
                                placeholder="Escribe tu mensaje a la IA..." autocomplete="off" required />
                            <button type="submit" class="ai-chat-send-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Modal para nueva discusión -->
    <div class="modal-overlay" id="new-discussion-modal">
        <div class="modal">
            <h3>Crear Nueva Discusión</h3>
            <div class="modal-content">
                <div class="form-group">
                    <label>Título:</label>
                    <input type="text" id="discussion-title" placeholder="Título de la discusión">
                </div>
                <div class="form-group">
                    <label>Contenido:</label>
                    <textarea id="discussion-content"
                        placeholder="Escribe el contenido de tu discusión aquí..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeNewDiscussionModal()">Cancelar</button>
                <button class="create-btn" onclick="createNewDiscussion()">Crear</button>
            </div>
        </div>
    </div>
    <div class="delete-modal-overlay" id="delete-modal-overlay">
        <div class="delete-modal">
            <div class="delete-modal-header">
                <div class="delete-modal-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Eliminar Discusión</h3>
            </div>

            <div class="delete-modal-content">
                <div class="delete-modal-warning">
                    <h4>⚠️ Esta acción no se puede deshacer</h4>
                    <ul>
                        <li>Se eliminará la discusión permanentemente</li>
                        <li>Se eliminarán todas las respuestas</li>
                        <li>Se eliminarán todos los likes y reacciones</li>
                        <li>Los miembros perderán acceso a todo el contenido</li>
                    </ul>
                </div>

                <p class="delete-modal-text">
                    ¿Estás completamente seguro de que quieres eliminar esta discusión?
                    Escribe <strong>"ELIMINAR"</strong> para confirmar:
                </p>

                <input type="text" id="delete-confirmation-input" placeholder="Escribe ELIMINAR para confirmar" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); 
                          border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; 
                          color: white; font-size: 14px; margin-top: 12px;">
            </div>

            <div class="delete-modal-actions">
                <button class="delete-cancel-btn" onclick="closeDeleteModal()">
                    Cancelar
                </button>
                <button class="delete-confirm-btn" id="delete-confirm-btn" disabled onclick="confirmDeleteDiscussion()">
                    Eliminar Discusión
                </button>
            </div>
        </div>
    </div>

    <script src="js/project-session.js"></script>
    <script src="js/noti.js"></script>

    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://jatcscioqvicmiofsuqt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphdGNzY2lvcXZpY21pb2ZzdXF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2ODUwNDcsImV4cCI6MjA3MjI2MTA0N30.wZ2dXWG7jq7zhzorqKoQYF7I6xz49k2xaFsouQRscGQ';

        let supabaseClient;
        let currentUser = null;
        let currentProject = null;
        let currentUserRole = null;
        let discussions = [];
        let currentDiscussion = null;
        let currentReplies = [];
        let replyingToId = null;
        let repliesHierarchy = [];
        const INITIAL_NESTED_REPLIES_COUNT = 1;
        let expandedThreads = new Set();
        let projectMembers = [];
        let typingTimer = null;
        let currentMentionInput = null;
        let typingDebounceTimer = null;
        let discussionToDelete = null;
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let currentLanguage = localStorage.getItem('language') || 'es';

        // Idiomas soportados
        const supportedLanguages = {
            'en': { name: 'English', flag: '🇺🇸' },
            'es': { name: 'Español', flag: '🇪🇸' },
            'fr': { name: 'Français', flag: '🇫🇷' },
            'de': { name: 'Deutsch', flag: '🇩🇪' },
            'it': { name: 'Italiano', flag: '🇮🇹' },
            'pt': { name: 'Português', flag: '🇵🇹' },
            'ru': { name: 'Русский', flag: '🇷🇺' },
            'ja': { name: '日本語', flag: '🇯🇵' },
            'ko': { name: '한국어', flag: '🇰🇷' },
            'zh': { name: '中文', flag: '🇨🇳' },
            'ar': { name: 'العربية', flag: '🇸🇦' },
            'hi': { name: 'हिंदी', flag: '🇮🇳' },
            'nl': { name: 'Nederlands', flag: '🇳🇱' }
        };

        const translations = {
            es: {
                'common.themeToggle': 'Cambiar Tema',
                'common.language': 'Idioma',
                'common.logout': 'Salir',
                'discussions.title': 'Foros'
            },
            en: {
                'common.themeToggle': 'Toggle Theme',
                'common.language': 'Language',
                'common.logout': 'Logout',
                'discussions.title': 'Forums'
            }
        };

        // Función para obtener traducción
        function t(key) {
            return translations[currentLanguage] && translations[currentLanguage][key]
                ? translations[currentLanguage][key]
                : translations['es'][key] || key;
        }

        // Reacciones disponibles
        const REACTIONS = {
            'love': '❤️',
            'laugh': '😂',
            'think': '🤔',
            'idea': '💡'
        };



       function showDeleteModal(discussionId) {
    console.log('showDeleteModal called with:', discussionId); // Debug
    
    if (!discussionId) {
        console.error('No discussion ID provided');
        showToast('Error: ID de discusión no válido', 'error');
        return;
    }

    // Verificar permisos antes de mostrar el modal
    const canDelete = currentUserRole === 'admin' || 
                     currentUserRole === 'owner' || 
                     (currentDiscussion && currentDiscussion.created_by === currentUser.id);
    
    if (!canDelete) {
        showToast('No tienes permisos para eliminar esta discusión', 'error');
        return;
    }

    discussionToDelete = discussionId;
    const modal = document.getElementById('delete-modal-overlay');
    const input = document.getElementById('delete-confirmation-input');
    const confirmBtn = document.getElementById('delete-confirm-btn');

    if (!modal || !input || !confirmBtn) {
        console.error('Modal elements not found');
        showToast('Error: Elementos del modal no encontrados', 'error');
        return;
    }

    // Limpiar estado
    input.value = '';
    confirmBtn.disabled = true;
    confirmBtn.style.opacity = '0.5';
    confirmBtn.innerHTML = 'Eliminar Discusión';

    // Mostrar modal
    modal.classList.add('show');
    
    // Focus en el input después de que aparezca el modal
    setTimeout(() => {
        input.focus();
    }, 300);
    
    console.log('Modal shown, discussionToDelete set to:', discussionToDelete); // Debug
}


async function verifyDeletePermissions(discussionId) {
    try {
        // Obtener información de la discusión
        const { data: discussion, error } = await supabaseClient
            .from('discussions')
            .select('created_by, project_id')
            .eq('id', discussionId)
            .single();

        if (error) {
            console.error('Error getting discussion info:', error);
            return false;
        }

        // Verificar si es el autor
        if (discussion.created_by === currentUser.id) {
            return true;
        }

        // Verificar rol en el proyecto
        const { data: membership, error: memberError } = await supabaseClient
            .from('project_members')
            .select('role')
            .eq('project_id', discussion.project_id)
            .eq('user_id', currentUser.id)
            .single();

        if (memberError) {
            console.error('Error checking membership:', memberError);
            return false;
        }

        return membership.role === 'admin' || membership.role === 'owner';

    } catch (error) {
        console.error('Error verifying delete permissions:', error);
        return false;
    }
}

        // Función para cerrar el modal
        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal-overlay');
            const input = document.getElementById('delete-confirmation-input');

            modal.classList.remove('show');
            input.value = '';
            discussionToDelete = null;
        }

        // Función para confirmar eliminación
   
        async function confirmDeleteDiscussion() {
    console.log('confirmDeleteDiscussion called'); // Debug
    console.log('discussionToDelete:', discussionToDelete); // Debug
    
    if (!discussionToDelete) {
        console.error('No discussion to delete');
        showToast('Error: No hay discusión para eliminar', 'error');
        return;
    }

    // Verificar permisos nuevamente
    const canDelete = currentUserRole === 'admin' || 
                     currentUserRole === 'owner' || 
                     (currentDiscussion && currentDiscussion.created_by === currentUser.id);
    
    console.log('Current user role:', currentUserRole); // Debug
    console.log('Can delete:', canDelete); // Debug
    console.log('Discussion created_by:', currentDiscussion?.created_by); // Debug
    console.log('Current user ID:', currentUser?.id); // Debug
    
    if (!canDelete) {
        showToast('No tienes permisos para eliminar esta discusión', 'error');
        closeDeleteModal();
        return;
    }

    // Deshabilitar botón durante la eliminación
    const confirmBtn = document.getElementById('delete-confirm-btn');
    if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
    }

    try {
        console.log('Attempting to delete discussion:', discussionToDelete); // Debug
        
        // PASO 1: Eliminar respuestas primero (para evitar errores de foreign key)
        const { error: repliesError } = await supabaseClient
            .from('discussion_replies')
            .delete()
            .eq('discussion_id', discussionToDelete);

        if (repliesError) {
            console.error('Error deleting replies:', repliesError);
            throw new Error('Error eliminando respuestas: ' + repliesError.message);
        }

        // PASO 2: Eliminar likes de la discusión
        const { error: likesError } = await supabaseClient
            .from('discussion_likes')
            .delete()
            .eq('discussion_id', discussionToDelete);

        if (likesError) {
            console.error('Error deleting likes:', likesError);
            // No lanzar error, continuar
        }

        // PASO 3: Eliminar reacciones de la discusión
        const { error: reactionsError } = await supabaseClient
            .from('discussion_reactions')
            .delete()
            .eq('discussion_id', discussionToDelete);

        if (reactionsError) {
            console.error('Error deleting reactions:', reactionsError);
            // No lanzar error, continuar
        }

        // PASO 4: Eliminar notificaciones de menciones relacionadas
        const { error: mentionsError } = await supabaseClient
            .from('mention_notifications')
            .delete()
            .eq('discussion_id', discussionToDelete);

        if (mentionsError) {
            console.error('Error deleting mentions:', mentionsError);
            // No lanzar error, continuar
        }

        // PASO 5: Finalmente, eliminar la discusión
        const { error: discussionError } = await supabaseClient
            .from('discussions')
            .delete()
            .eq('id', discussionToDelete);

        if (discussionError) {
            console.error('Error deleting discussion:', discussionError);
            throw new Error('Error eliminando discusión: ' + discussionError.message);
        }

        console.log('Discussion deleted successfully'); // Debug
        
        showToast('Discusión eliminada correctamente');
        closeDeleteModal();

        // Volver a la lista de discusiones si estamos en el detalle
        if (currentView === 'discussion-detail') {
            showDiscussionsList();
        }

        // Recargar la lista
        await loadDiscussions();

    } catch (error) {
        console.error('Error in confirmDeleteDiscussion:', error);
        showToast(error.message || 'Error al eliminar la discusión', 'error');
        
        // Restaurar botón
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = 'Eliminar Discusión';
        }
    }
}

      

        document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('delete-confirmation-input');
    const confirmBtn = document.getElementById('delete-confirm-btn');

    if (input && confirmBtn) {
        input.addEventListener('input', function () {
            const inputValue = this.value.trim().toUpperCase();
            const isValid = inputValue === 'ELIMINAR';
            
            console.log('Input value:', inputValue); // Debug
            console.log('Is valid:', isValid); // Debug
            
            confirmBtn.disabled = !isValid;
            confirmBtn.style.opacity = isValid ? '1' : '0.5';
            
            if (isValid) {
                confirmBtn.style.background = 'linear-gradient(45deg, #ef4444, #dc2626)';
            } else {
                confirmBtn.style.background = 'rgba(239, 68, 68, 0.5)';
            }
        });

        // Enter para confirmar si está habilitado
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !confirmBtn.disabled) {
                confirmDeleteDiscussion();
            }
        });
    }
});

        // Cerrar modal con ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('delete-modal-overlay');
                if (modal && modal.classList.contains('show')) {
                    closeDeleteModal();
                }
            }
        });

        // Cerrar modal al hacer clic fuera
        document.getElementById('delete-modal-overlay')?.addEventListener('click', function (e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

       async function loadProjectMembers() {
    try {
        // Paso 1: Obtener user_ids del proyecto
        const { data: members, error: membersError } = await supabaseClient
            .from('project_members')
            .select('user_id, user_email') // AGREGAR user_email
            .eq('project_id', currentProject.id);

        if (membersError) throw membersError;

        // Paso 2: Obtener perfiles por separado
        const userIds = members.map(m => m.user_id);

        const { data: profiles, error: profilesError } = await supabaseClient
            .from('profiles')
            .select('id, username, full_name')
            .in('id', userIds);

        if (profilesError) throw profilesError;

        // Paso 3: Combinar datos CON EMAIL
        projectMembers = profiles.map(profile => {
            const memberData = members.find(m => m.user_id === profile.id);
            return {
                id: profile.id,
                username: profile.username || profile.id.substring(0, 8),
                name: profile.full_name || profile.username || 'Usuario',
                email: memberData?.user_email || 'unknown@email.com' // AGREGAR EMAIL
            };
        });

        console.log('Miembros cargados correctamente:', projectMembers);

    } catch (error) {
        console.error('Error loading project members:', error);
        projectMembers = [];
    }
}

   
async function loadReplies(discussionId) {
    try {
        const { data: replies, error } = await supabaseClient
            .from('discussion_replies')
            .select('*')
            .eq('discussion_id', discussionId)
            .order('created_at', { ascending: true });

        if (error && error.code !== 'PGRST116') {
            console.error('Error loading replies:', error);
            return;
        }

        const repliesWithInfo = await Promise.all((replies || []).map(async (reply) => {
            // Obtener información completa del autor incluyendo avatar
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('username, full_name, avatar_url')
                .eq('id', reply.created_by)
                .single();

            const authorName = profile?.full_name || profile?.username || 'Usuario';
            const authorAvatar = profile?.avatar_url || null;

            const { count: likesCount } = await supabaseClient
                .from('reply_likes')
                .select('*', { count: 'exact', head: true })
                .eq('reply_id', reply.id);

            const { data: userLike } = await supabaseClient
                .from('reply_likes')
                .select('id')
                .eq('reply_id', reply.id)
                .eq('user_id', currentUser.id)
                .maybeSingle();

            return {
                ...reply,
                author_name: authorName,
                author_avatar: authorAvatar,
                likes_count: likesCount || 0,
                is_liked: !!userLike
            };
        }));

        // MANTENER LA ESTRUCTURA JERÁRQUICA ORIGINAL (NO aplanar)
        repliesHierarchy = organizeRepliesHierarchy(repliesWithInfo);
        renderRepliesHierarchy();

        document.getElementById('replies-count').textContent = repliesWithInfo.length;

    } catch (error) {
        console.error('Error loading replies:', error);
        document.getElementById('replies-list').innerHTML =
            '<p style="color: #ef4444; text-align: center;">Error cargando respuestas</p>';
    }
}


        // Organizar respuestas en estructura jerárquica
        function organizeRepliesHierarchy(replies) {
            const repliesMap = new Map();
            const rootReplies = [];

            // Crear mapa de respuestas
            replies.forEach(reply => {
                repliesMap.set(reply.id, { ...reply, children: [] });
            });

            // Organizar jerarquía
            replies.forEach(reply => {
                const replyObj = repliesMap.get(reply.id);

                if (reply.parent_reply_id && repliesMap.has(reply.parent_reply_id)) {
                    // Es una respuesta anidada
                    const parent = repliesMap.get(reply.parent_reply_id);
                    parent.children.push(replyObj);
                } else {
                    // Es una respuesta directa
                    rootReplies.push(replyObj);
                }
            });

            return rootReplies;
        }

        // Renderizar respuestas jerárquicas
        function renderRepliesHierarchy() {
            const container = document.getElementById('replies-list');
            if (!container) return;

            if (repliesHierarchy.length === 0) {
                container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #8892a6;">
                <i class="fas fa-comment" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p>Aún no hay respuestas. ¡Sé el primero en responder!</p>
            </div>
        `;
                return;
            }

            container.innerHTML = '';

            repliesHierarchy.forEach(reply => {
                const threadElement = createReplyThread(reply);
                container.appendChild(threadElement);
            });
        }

 
function createReplyThread(reply, level = 0) {
    const div = document.createElement('div');
    div.className = 'reply-thread';

    // Crear elemento de respuesta principal
    const replyElement = createReplyElement(reply, level);
    div.appendChild(replyElement);

    // Agregar respuestas anidadas si existen
    if (reply.children && reply.children.length > 0) {
        const isExpanded = expandedThreads.has(reply.id);
        const childrenToShow = isExpanded ? reply.children : reply.children.slice(0, INITIAL_NESTED_REPLIES_COUNT);
        
        // CAMBIO: usar conteo recursivo en lugar de solo children.length
        const totalNestedCount = countAllNestedReplies(reply);
        const hasMoreChildren = totalNestedCount > INITIAL_NESTED_REPLIES_COUNT;

        // Crear contenedor para respuestas anidadas
        const nestedContainer = document.createElement('div');
        nestedContainer.className = 'nested-replies-container';
        nestedContainer.id = `nested-${reply.id}`;

        // Agregar respuestas anidadas visibles
        childrenToShow.forEach(childReply => {
            const childThread = createReplyThread(childReply, level + 1);
            nestedContainer.appendChild(childThread);
        });

        div.appendChild(nestedContainer);

        // Agregar botón "Ver más respuestas" si hay más respuestas anidadas
        if (hasMoreChildren && !isExpanded) {
            const hiddenCount = totalNestedCount - INITIAL_NESTED_REPLIES_COUNT;
            const showMoreBtn = document.createElement('button');
            showMoreBtn.className = 'show-more-nested-btn';
            showMoreBtn.innerHTML = `
                <i class="fas fa-chevron-down"></i>
                Ver ${hiddenCount} respuesta${hiddenCount !== 1 ? 's' : ''} más
            `;
            showMoreBtn.onclick = () => expandNestedReplies(reply.id, reply.children, level);
            div.appendChild(showMoreBtn);
        }

        // Agregar botón "Ver menos" si está expandido
        if (isExpanded && hasMoreChildren) {
            const showLessBtn = document.createElement('button');
            showLessBtn.className = 'show-less-nested-btn';
            showLessBtn.innerHTML = `
                <i class="fas fa-chevron-up"></i>
                Ver menos respuestas
            `;
            showLessBtn.onclick = () => collapseNestedReplies(reply.id);
            div.appendChild(showLessBtn);
        }
    }

    return div;
}


        function collapseNestedReplies(parentReplyId) {
            expandedThreads.delete(parentReplyId);

            // Regenerar todo el thread para el reply parent
            const parentReply = findReplyInHierarchy(parentReplyId);
            if (parentReply) {
                const parentElement = document.querySelector(`[data-reply-id="${parentReplyId}"]`).closest('.reply-thread');
                const newThread = createReplyThread(parentReply, 0);
                parentElement.parentElement.replaceChild(newThread, parentElement);
            }
        }


function findReplyInHierarchy(replyId, replies = repliesHierarchy) {
    for (const reply of replies) {
        if (reply.id === replyId) {
            return reply;
        }
        if (reply.children && reply.children.length > 0) {
            const found = findReplyInHierarchy(replyId, reply.children);
            if (found) return found;
        }
    }
    return null;
}

        const additionalCSS = `
.show-more-nested-btn,
.show-less-nested-btn {
    background: rgba(74, 158, 255, 0.1);
    border: 1px solid rgba(74, 158, 255, 0.3);
    color: #4a9eff;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    margin: 12px 0 0 40px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    max-width: fit-content;
}

.show-more-nested-btn:hover,
.show-less-nested-btn:hover {
    background: rgba(74, 158, 255, 0.2);
    border-color: #4a9eff;
    transform: translateY(-1px);
}

.show-more-nested-btn i,
.show-less-nested-btn i {
    font-size: 10px;
}

.nested-replies-container {
    position: relative;
}

/* Animación suave para expansión */
.nested-replies-container {
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
`;

        // Función para inyectar CSS adicional
        function injectAdditionalCSS() {
            const style = document.createElement('style');
            style.textContent = additionalCSS;
            document.head.appendChild(style);
        }

        // Llamar al cargar la página
        document.addEventListener('DOMContentLoaded', function () {
            injectAdditionalCSS();
        });

        function expandNestedReplies(parentReplyId, allChildren, level) {
            expandedThreads.add(parentReplyId);

            const container = document.getElementById(`nested-${parentReplyId}`);
            const showMoreBtn = container.parentElement.querySelector('.show-more-nested-btn');

            if (container) {
                // Limpiar contenedor
                container.innerHTML = '';

                // Agregar todas las respuestas anidadas
                allChildren.forEach(childReply => {
                    const childThread = createReplyThread(childReply, level + 1);
                    container.appendChild(childThread);
                });
            }

            if (showMoreBtn) {
                showMoreBtn.remove();
            }

            // Agregar botón "Ver menos"
            const showLessBtn = document.createElement('button');
            showLessBtn.className = 'show-less-nested-btn';
            showLessBtn.innerHTML = `
        <i class="fas fa-chevron-up"></i>
        Ver menos respuestas
    `;
            showLessBtn.onclick = () => collapseNestedReplies(parentReplyId);
            container.parentElement.appendChild(showLessBtn);
        }


function createReplyElement(reply, level = 0) {
    const div = document.createElement('div');
    div.className = `reply-item ${level > 0 ? 'nested' : ''}`;
    div.dataset.replyId = reply.id;

    const date = new Date(reply.created_at).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    // NUEVO: Obtener información del padre si existe
    let respondingToInfo = '';
    if (reply.parent_reply_id) {
        const parentReply = findReplyInHierarchy(reply.parent_reply_id);
        if (parentReply) {
            respondingToInfo = `
                <div class="nested-indicator">
                    <i class="fas fa-reply" style="margin-right: 4px; color: #4a9eff;"></i>
                    Respondiendo a <strong>${parentReply.author_name}</strong>
                </div>
            `;
        }
    }

    // Generar avatar HTML
    const avatarHTML = reply.author_avatar ? 
        `<img src="${reply.author_avatar}" alt="${reply.author_name}" class="reply-author-avatar">` :
        `<div class="reply-author-avatar-initial">${getInitials(reply.author_name)}</div>`;

    div.innerHTML = `
        ${respondingToInfo}
        <div class="reply-header">
            <div class="reply-author-info">
                ${avatarHTML}
                <span class="reply-author">${reply.author_name}</span>
            </div>
            <span class="reply-date">${date}</span>
        </div>
        <div class="reply-content">${reply.content}</div>
        <div class="reply-actions">
            <button class="reply-action-btn ${reply.is_liked ? 'liked' : ''}" onclick="toggleReplyLike('${reply.id}')">
                <i class="fas fa-thumbs-up"></i>
                <span>${reply.likes_count}</span>
            </button>
            ${!currentDiscussion.is_closed ? `
                <button class="reply-action-btn" onclick="showInlineReplyForm('${reply.id}')">
                    <i class="fas fa-reply"></i>
                    Responder
                </button>
            ` : ''}
        </div>
        
        ${!currentDiscussion.is_closed ? `
            <div class="reply-form-inline" id="inline-form-${reply.id}">
                <textarea class="reply-textarea" id="inline-textarea-${reply.id}" 
                    placeholder="Responde a ${reply.author_name}..."></textarea>
                <div class="reply-form-actions">
                    <button class="reply-form-btn cancel" onclick="hideInlineReplyForm('${reply.id}')">Cancelar</button>
                    <button class="reply-form-btn" onclick="submitInlineReply('${reply.id}')">Responder</button>
                </div>
            </div>
        ` : ''}
    `;

    return div;
}

// Función helper para obtener iniciales
function getInitials(name) {
    return name.split(' ')
        .map(word => word.charAt(0))
        .join('')
        .substring(0, 2)
        .toUpperCase();
}

      
        // Mostrar formulario de respuesta inline
        function showInlineReplyForm(replyId) {
            // Ocultar otros formularios abiertos
            document.querySelectorAll('.reply-form-inline.show').forEach(form => {
                form.classList.remove('show');
            });

            // Mostrar formulario específico
            const form = document.getElementById(`inline-form-${replyId}`);
            const textarea = document.getElementById(`inline-textarea-${replyId}`);

            if (form) {
                form.classList.add('show');
                replyingToId = replyId;
            }
            if (textarea) {
                textarea.focus();
            }

            // Actualizar estado visual del botón
            document.querySelectorAll('.reply-action-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Ocultar formulario de respuesta inline
        function hideInlineReplyForm(replyId) {
            const form = document.getElementById(`inline-form-${replyId}`);
            const textarea = document.getElementById(`inline-textarea-${replyId}`);

            if (form) {
                form.classList.remove('show');
            }
            if (textarea) {
                textarea.value = '';
            }

            replyingToId = null;

            // Remover estado activo del botón
            document.querySelectorAll('.reply-action-btn.active').forEach(btn => {
                btn.classList.remove('active');
            });
        }

     // Función corregida para procesar menciones
async function processMentionsAndNotify(content, discussionId, replyId = null) {
    // Extraer menciones del contenido
    const mentionMatches = content.match(/@(\w+)/g);
    if (!mentionMatches) return [];

    const mentionedUsernames = mentionMatches.map(match => match.replace('@', ''));
    const mentionedUserIds = [];

    // Buscar IDs de usuarios mencionados
    for (const username of mentionedUsernames) {
        const mentionedUser = projectMembers.find(member => 
            member.username.toLowerCase() === username.toLowerCase()
        );

        // EVITAR AUTO-MENCIÓN Y VERIFICAR QUE EXISTE
        if (mentionedUser && mentionedUser.id !== currentUser.id) {
            mentionedUserIds.push(mentionedUser.id);

            // SOLO crear notificación si el usuario NO está en esta discusión
            const isUserInCurrentDiscussion = window.location.pathname.includes('discussions.html') && 
                                            new URLSearchParams(window.location.search).get('discussion') === discussionId;
            
            if (!isUserInCurrentDiscussion) {
                try {
                    await supabaseClient
                        .from('mention_notifications')
                        .insert([{
                            user_id: mentionedUser.id,
                            user_email: mentionedUser.email,
                            mentioned_by_id: currentUser.id,
                            mentioned_by_name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
                            discussion_id: discussionId,
                            reply_id: replyId,
                            discussion_title: currentDiscussion.title,
                            mention_content: content.substring(0, 200) + (content.length > 200 ? '...' : ''),
                            project_id: currentProject.id,
                            project_name: currentProject.name
                        }]);
                } catch (error) {
                    console.error('Error creating mention notification:', error);
                }
            }
        }
    }

    return mentionedUserIds;
}
// Modificar submitReply para incluir menciones


async function submitReply() {
    const textarea = document.getElementById('reply-textarea');
    const content = textarea.value.trim();

    if (!content) {
        showToast('Escribe algo antes de responder', 'error');
        return;
    }

    if (!currentDiscussion) {
        showToast('Error: No hay discusión seleccionada', 'error');
        return;
    }

    // CREAR RESPUESTA TEMPORAL INMEDIATAMENTE
    const tempReply = {
        id: 'temp-' + Date.now(),
        discussion_id: currentDiscussion.id,
        content: content,
        created_by: currentUser.id,
        parent_reply_id: null,
        created_at: new Date().toISOString(),
        author_name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
        author_avatar: null,
        likes_count: 0,
        is_liked: false,
        children: [],
        isTemp: true // Marcar como temporal
    };

    // LIMPIAR TEXTAREA INMEDIATAMENTE
    textarea.value = '';

    // AGREGAR A LA JERARQUÍA Y RENDERIZAR INMEDIATAMENTE
    repliesHierarchy.push(tempReply);
    renderRepliesHierarchy();
    
    // Actualizar contador
    const currentCount = parseInt(document.getElementById('replies-count').textContent) || 0;
    document.getElementById('replies-count').textContent = currentCount + 1;

    // Scroll a la nueva respuesta
    setTimeout(() => {
        const newReplyElement = document.querySelector(`[data-reply-id="${tempReply.id}"]`);
        if (newReplyElement) {
            newReplyElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            // Efecto de highlight temporal
            newReplyElement.style.background = 'rgba(74, 158, 255, 0.1)';
            setTimeout(() => {
                newReplyElement.style.background = '';
            }, 2000);
        }
    }, 100);

    try {
        // Procesar menciones en background
        const mentionedUserIds = await processMentionsAndNotify(content, currentDiscussion.id);

        // Insertar en base de datos
        const { data, error } = await supabaseClient
            .from('discussion_replies')
            .insert([{
                discussion_id: currentDiscussion.id,
                content: content,
                created_by: currentUser.id,
                parent_reply_id: null,
                mentioned_users: mentionedUserIds
            }])
            .select()
            .single();

        if (error) throw error;

        // REEMPLAZAR RESPUESTA TEMPORAL CON LA REAL
        const tempIndex = repliesHierarchy.findIndex(r => r.id === tempReply.id);
        if (tempIndex !== -1) {
            // Crear respuesta real con datos completos
            const realReply = {
                ...data,
                author_name: tempReply.author_name,
                author_avatar: tempReply.author_avatar,
                likes_count: 0,
                is_liked: false,
                children: []
            };
            
            repliesHierarchy[tempIndex] = realReply;
            renderRepliesHierarchy();
        }

        // Toast discreto sin bloquear
        showToast('Respuesta enviada', 'success', 1500);

    } catch (error) {
        console.error('Error submitting reply:', error);
        
        // REMOVER RESPUESTA TEMPORAL EN CASO DE ERROR
        const tempIndex = repliesHierarchy.findIndex(r => r.id === tempReply.id);
        if (tempIndex !== -1) {
            repliesHierarchy.splice(tempIndex, 1);
            renderRepliesHierarchy();
            // Restaurar contador
            document.getElementById('replies-count').textContent = currentCount;
        }
        
        // Restaurar contenido del textarea
        textarea.value = content;
        showToast('Error al enviar la respuesta', 'error');
    }
}


// Enviar respuesta inline (anidada) - CORREGIDA
async function submitInlineReply(parentReplyId) {
    const textarea = document.getElementById(`inline-textarea-${parentReplyId}`);
    const content = textarea.value.trim();

    if (!content) {
        showToast('Escribe algo antes de responder', 'error');
        return;
    }

    if (!currentDiscussion) {
        showToast('Error: No hay discusión seleccionada', 'error');
        return;
    }

    // Obtener información del padre
    const parentReply = findReplyInHierarchy(parentReplyId);
    
    // CREAR RESPUESTA TEMPORAL
    const tempReply = {
        id: 'temp-' + Date.now(),
        discussion_id: currentDiscussion.id,
        content: content,
        created_by: currentUser.id,
        parent_reply_id: parentReplyId,
        created_at: new Date().toISOString(),
        author_name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
        author_avatar: null,
        likes_count: 0,
        is_liked: false,
        children: [],
        isTemp: true
    };

    // AGREGAR A CHILDREN DEL PADRE INMEDIATAMENTE
    if (parentReply) {
        if (!parentReply.children) parentReply.children = [];
        parentReply.children.push(tempReply);
        renderRepliesHierarchy();
        
        // Expandir el thread si no está expandido
        if (!expandedThreads.has(parentReplyId) && parentReply.children.length > INITIAL_NESTED_REPLIES_COUNT) {
            expandedThreads.add(parentReplyId);
            renderRepliesHierarchy();
        }
    }

    // OCULTAR FORMULARIO Y LIMPIAR
    hideInlineReplyForm(parentReplyId);

    try {
        // Procesar menciones
        const mentionedUserIds = await processMentionsAndNotify(content, currentDiscussion.id, parentReplyId);

        const { data, error } = await supabaseClient
            .from('discussion_replies')
            .insert([{
                discussion_id: currentDiscussion.id,
                content: content,
                created_by: currentUser.id,
                parent_reply_id: parentReplyId,
                mentioned_users: mentionedUserIds
            }])
            .select()
            .single();

        if (error) throw error;

        // REEMPLAZAR TEMPORAL CON REAL
        if (parentReply && parentReply.children) {
            const tempIndex = parentReply.children.findIndex(r => r.id === tempReply.id);
            if (tempIndex !== -1) {
                const realReply = {
                    ...data,
                    author_name: tempReply.author_name,
                    author_avatar: tempReply.author_avatar,
                    likes_count: 0,
                    is_liked: false,
                    children: []
                };
                parentReply.children[tempIndex] = realReply;
                renderRepliesHierarchy();
            }
        }

        showToast('Respuesta enviada', 'success', 1500);

    } catch (error) {
        console.error('Error submitting nested reply:', error);
        
        // REMOVER TEMPORAL EN CASO DE ERROR
        if (parentReply && parentReply.children) {
            const tempIndex = parentReply.children.findIndex(r => r.id === tempReply.id);
            if (tempIndex !== -1) {
                parentReply.children.splice(tempIndex, 1);
                renderRepliesHierarchy();
            }
        }
        
        showToast('Error al enviar la respuesta', 'error');
        // Reabrir formulario con el contenido
        showInlineReplyForm(parentReplyId);
        document.getElementById(`inline-textarea-${parentReplyId}`).value = content;
    }
}

// Variables de vista
        let currentView = 'discussions-list';

        // Asegurar project ID
        function ensureProjectId() {
            const urlParams = new URLSearchParams(window.location.search);
            let projectId = urlParams.get('project');
            let code = urlParams.get('code');

            if (!projectId) {
                projectId = localStorage.getItem('current_project_id');
                code = localStorage.getItem('current_project_code');

                if (projectId) {
                    const url = new URL(window.location);
                    url.searchParams.set('project', projectId);
                    if (code) {
                        url.searchParams.set('code', code);
                    }
                    window.history.replaceState({}, '', url);
                } else {
                    console.warn('No se encontró project ID, redirigiendo al dashboard');
                    window.location.href = 'dashboard.html';
                    return null;
                }
            } else {
                localStorage.setItem('current_project_id', projectId);
                if (code) {
                    localStorage.setItem('current_project_code', code);
                }
            }

            return projectId;
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function () {
            if (!ensureProjectId()) {
                return;
            }
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            setupEventListeners();
            checkAuthenticationAndLoadData();
        });

        function setupEventListeners() {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            const menuToggle = document.getElementById('menu-toggle');
            if (menuToggle) menuToggle.addEventListener('click', toggleSidebar);

            const newDiscussionBtn = document.getElementById('new-discussion-btn');
            if (newDiscussionBtn) newDiscussionBtn.addEventListener('click', showNewDiscussionModal);

            // Cerrar modal al hacer clic fuera
            const modal = document.getElementById('new-discussion-modal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeNewDiscussionModal();
                    }
                });
            }
        }

        async function checkAuthenticationAndLoadData() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error || !session) {
                    console.log('No session found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = session.user;

                const userName = currentUser.user_metadata?.full_name ||
                    currentUser.user_metadata?.name ||
                    currentUser.email.split('@')[0];

               // Actualizar header del usuario
                await updateUserHeader();

                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('project');

                if (!projectId) {
                    console.error('No project ID provided');
                    redirectToHome('Proyecto no especificado');
                    return;
                }

                const hasAccess = await verifyProjectAccess(projectId);
                if (!hasAccess) {
                    console.error('User does not have access to this project');
                    redirectToHome('No tienes acceso a este proyecto');
                    return;
                }

                await loadProjectData(projectId);
                await loadDiscussions();

                console.log('Discussions loaded successfully');
                initializeThemeAndLanguage();
                await subscribeToRealtimeChanges();

            } catch (error) {
                console.error('Error in checkAuthenticationAndLoadData:', error);
                redirectToHome('Error cargando el proyecto: ' + error.message);
            }
            initializeSidebar();
setupMenuToggle();
        }

        async function verifyProjectAccess(projectId) {
            try {
                const { data: membership, error } = await supabaseClient
                    .from('project_members')
                    .select('id, role, project_id')
                    .eq('project_id', projectId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error checking project membership:', error);
                    return false;
                }

                if (!membership) {
                    console.log('Usuario no es miembro del proyecto');
                    return false;
                }

                currentUserRole = membership.role;
                return true;

            } catch (error) {
                console.error('Error in verifyProjectAccess:', error);
                return false;
            }
        }

        async function loadProjectData(projectId) {
            try {
                const { data: projectData, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('id', projectId)
                    .single();

                if (error) throw error;

                currentProject = projectData;
                document.getElementById('project-name-header').textContent = projectData.name;

            } catch (error) {
                console.error('Error loading project data:', error);
                redirectToHome('Error cargando datos del proyecto');
            }
        }



async function loadDiscussions() {
    try {
        if (!currentProject) {
            console.warn('No current project for loading discussions');
            return;
        }

        const { data, error } = await supabaseClient
            .from('discussions')
            .select('*')
            .eq('project_id', currentProject.id)
            .order('order_index', { ascending: false });

        if (error && error.code !== 'PGRST116') {
            console.error('Error en consulta de discusiones:', error);
            throw error;
        }

        const discussionsWithInfo = await Promise.all((data || []).map(async (discussion) => {
            const authorName = await getUserName(discussion.created_by);

            let likesCount = 0;
            try {
                const { count } = await supabaseClient
                    .from('discussion_likes')
                    .select('*', { count: 'exact', head: true })
                    .eq('discussion_id', discussion.id);
                likesCount = count || 0;
            } catch (e) {
                console.log('Error contando likes:', e);
            }

            let repliesCount = 0;
            try {
                const { count } = await supabaseClient
                    .from('discussion_replies')
                    .select('*', { count: 'exact', head: true })
                    .eq('discussion_id', discussion.id);
                repliesCount = count || 0;
            } catch (e) {
                console.log('Error contando replies:', e);
            }

            return {
                ...discussion,
                author_name: authorName,
                likes_count: likesCount,
                replies_count: repliesCount
            };
        }));

        discussions = discussionsWithInfo;
        renderDiscussions();

    } catch (error) {
        console.error('Error loading discussions:', error);
        const discussionsGrid = document.getElementById('discussions-grid');
        if (discussionsGrid) {
            discussionsGrid.innerHTML =
                '<p style="color: #ef4444; text-align: center; grid-column: 1 / -1;">Error cargando discusiones</p>';
        }
    }
}


        function renderDiscussions() {
            const container = document.getElementById('discussions-grid');
            if (!container) return;

            if (discussions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-comments"></i>
                        <h3>No hay discusiones aún</h3>
                        <p>Sé el primero en crear una discusión para este proyecto</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            discussions.forEach(async discussion => {
    const discussionElement = await createDiscussionCard(discussion);
    container.appendChild(discussionElement);
});
        }


async function createDiscussionCard(discussion) {
    const div = document.createElement('div');
    div.className = 'discussion-card';
    div.dataset.discussionId = discussion.id; // Importante para identificar la card
    
    // Si es temporal, agregar efecto visual
    if (discussion.isTemp) {
        div.style.opacity = '0.8';
        div.style.border = '2px solid #4a9eff';
    }

    const authorName = discussion.author_name || 'Usuario';
    const date = new Date(discussion.created_at).toLocaleDateString('es-ES', {
        month: 'short',
        day: 'numeric'
    });
    const preview = discussion.content && discussion.content.length > 100
        ? discussion.content.substring(0, 100) + '...'
        : (discussion.content || 'Sin contenido');

    const isClosed = discussion.is_closed;
    
    // Obtener participantes únicos de la discusión
    const participantsData = await getDiscussionParticipants(discussion.id);
    const participantsDisplay = generateParticipantsAvatars(participantsData);

    div.innerHTML = `
        <div class="discussion-card-header">
            <div class="discussion-card-date">${date}</div>
            <div class="discussion-status ${isClosed ? 'closed' : 'open'}">
                <i class="fas fa-${isClosed ? 'lock' : 'unlock'}"></i>
            </div>
        </div>
        
        <div class="discussion-card-content">
            <h3 class="discussion-card-title">${discussion.title || 'Sin título'}</h3>
            <p class="discussion-card-preview">${preview}</p>
        </div>
        
        <div class="discussion-card-footer">
            <div class="discussion-participants">
                ${participantsDisplay.avatarsHtml}
                ${participantsDisplay.countHtml}
                <div class="participants-tooltip">
                    ${participantsData.totalCount} participante${participantsData.totalCount !== 1 ? 's' : ''}
                </div>
            </div>

            <div class="discussion-card-stats">
                <span class="discussion-card-stat">
                    <i class="far fa-comment"></i> ${discussion.replies_count || 0}
                </span>
                <span class="discussion-card-stat">
                    <i class="far fa-thumbs-up"></i> ${discussion.likes_count || 0}
                </span>
            </div>
        </div>
    `;

    div.addEventListener('click', () => openDiscussion(discussion.id));
    return div;
}

const newDiscussionStyles = `
    .discussion-card[data-discussion-id^="temp-"] {
        opacity: 0.8;
        border: 2px solid #4a9eff;
        position: relative;
    }
    
    .discussion-card[data-discussion-id^="temp-"]::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #4a9eff, transparent);
        animation: creatingAnimation 1.5s infinite;
    }
    
    @keyframes creatingAnimation {
        0% { opacity: 0.3; }
        50% { opacity: 1; }
        100% { opacity: 0.3; }
    }
`;

// Inyectar estilos si no existen
if (!document.getElementById('new-discussion-styles')) {
    const style = document.createElement('style');
    style.id = 'new-discussion-styles';
    style.textContent = newDiscussionStyles;
    document.head.appendChild(style);
}

async function getDiscussionParticipants(discussionId) {
    try {
        // Obtener el creador de la discusión
        const { data: discussion } = await supabaseClient
            .from('discussions')
            .select('created_by')
            .eq('id', discussionId)
            .single();

        // Obtener usuarios únicos que han respondido (no contar mensajes)
        const { data: replies } = await supabaseClient
            .from('discussion_replies')
            .select('created_by')
            .eq('discussion_id', discussionId);

        // Usar Set para obtener usuarios únicos solamente
        const uniqueUserIds = new Set();
        
        // Agregar el creador de la discusión
        if (discussion) {
            uniqueUserIds.add(discussion.created_by);
        }
        
        // Agregar usuarios que han respondido (sin duplicados)
        if (replies) {
            replies.forEach(reply => {
                uniqueUserIds.add(reply.created_by);
            });
        }

        // Convertir Set a Array y obtener información de usuarios
        const userIdsArray = Array.from(uniqueUserIds);
        const totalParticipants = userIdsArray.length;
        
        // Tomar solo los primeros 3 para mostrar avatares
        const visibleUserIds = userIdsArray.slice(0, 3);
        const participants = [];

        for (const userId of visibleUserIds) {
            try {
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('username, full_name, avatar_url')
                    .eq('id', userId)
                    .single();

                if (profile) {
                    participants.push({
                        id: userId,
                        name: profile.full_name || profile.username || 'Usuario',
                        avatar: profile.avatar_url
                    });
                } else {
                    participants.push({
                        id: userId,
                        name: 'Usuario',
                        avatar: null
                    });
                }
            } catch (error) {
                participants.push({
                    id: userId,
                    name: 'Usuario',
                    avatar: null
                });
            }
        }

        return {
            participants: participants,
            totalCount: totalParticipants,
            additionalCount: Math.max(0, totalParticipants - 3)
        };
        
    } catch (error) {
        console.error('Error getting participants:', error);
        return {
            participants: [],
            totalCount: 0,
            additionalCount: 0
        };
    }
}



function generateParticipantsAvatars(participantsData) {
    if (!participantsData || !participantsData.participants || participantsData.participants.length === 0) {
        return {
            avatarsHtml: '<div class="participant-avatar empty"><i class="fas fa-user"></i></div>',
            countHtml: ''
        };
    }

    const avatarsHtml = participantsData.participants.map(participant => {
        const initials = participant.name.split(' ')
            .map(word => word.charAt(0))
            .join('')
            .substring(0, 2)
            .toUpperCase();

        if (participant.avatar) {
            return `<div class="participant-avatar">
                        <img src="${participant.avatar}" alt="${participant.name}" title="${participant.name}" />
                    </div>`;
        } else {
            return `<div class="participant-avatar initials" title="${participant.name}">${initials}</div>`;
        }
    }).join('');

    // Solo mostrar +X si hay usuarios adicionales
    const countHtml = participantsData.additionalCount > 0 
        ? `<span class="participants-count">+${participantsData.additionalCount}</span>`
        : '';

    return {
        avatarsHtml,
        countHtml
    };
}


        async function deleteDiscussion(event, discussionId) {
            // Esta función ya no se usa en las cards, pero la mantenemos por compatibilidad
            await deleteDiscussionFromDetail(discussionId);
        }

        async function getUserName(userId) {
            if (!userId) return 'Usuario Anónimo';

            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('username, full_name')
                    .eq('id', userId)
                    .single();

                if (!error && profile) {
                    return profile.full_name || profile.username || 'Usuario';
                }

                if (currentUser && currentUser.id === userId) {
                    return currentUser.user_metadata?.full_name ||
                        currentUser.user_metadata?.name ||
                        currentUser.email.split('@')[0] || 'Usuario';
                }

                return 'Usuario';

            } catch (error) {
                console.log('Error obteniendo nombre de usuario:', error);
                return 'Usuario';
            }
        }

        // Sistema de navegación entre vistas
        function showView(viewName) {
            const currentViewElement = document.querySelector('.view.active');
            const targetViewElement = document.getElementById(viewName + '-view');

            if (!targetViewElement || currentViewElement === targetViewElement) return;

            // Animación de salida
            if (currentViewElement) {
                currentViewElement.classList.add('sliding-out');
                currentViewElement.classList.remove('active');
            }

            // Animación de entrada después de un pequeño delay
            setTimeout(() => {
                targetViewElement.classList.add('active');
                currentView = viewName;

                // Limpiar clase de salida
                if (currentViewElement) {
                    currentViewElement.classList.remove('sliding-out');
                }
            }, 200);
        }

      function showDiscussionsList() {
    showView('discussions-list');
    cleanupRealtimeSubscriptions();
    subscribeToRealtimeChanges();
}

        function showDiscussionDetail(discussionId) {
            showView('discussion-detail');
            loadDiscussionDetail(discussionId);
        }

        async function openDiscussion(discussionId) {
            showDiscussionDetail(discussionId);
        }

 async function loadDiscussionDetail(discussionId) {
    try {
        // Cargar la discusión con verificación de estado
        const { data: discussion, error } = await supabaseClient
            .from('discussions')
            .select('*')
            .eq('id', discussionId)
            .single();

        if (error) throw error;

        // IMPORTANTE: Actualizar currentDiscussion con datos frescos
        currentDiscussion = discussion;

        // Verificar y aplicar el estado de cerrado
        const discussionDetailView = document.getElementById('discussion-detail-view');
        if (discussionDetailView) {
            if (discussion.is_closed) {
                discussionDetailView.classList.add('discussion-closed');
            } else {
                discussionDetailView.classList.remove('discussion-closed');
            }
        }

        const authorName = await getUserName(discussion.created_by);

        const { count: likesCount } = await supabaseClient
            .from('discussion_likes')
            .select('*', { count: 'exact', head: true })
            .eq('discussion_id', discussionId);

        const { data: userLike } = await supabaseClient
            .from('discussion_likes')
            .select('id')
            .eq('discussion_id', discussionId)
            .eq('user_id', currentUser.id)
            .maybeSingle();

        renderDiscussionPost(discussion, authorName, likesCount || 0, !!userLike);

        // Ocultar/mostrar formulario principal basado en el estado
        const replyForm = document.querySelector('.reply-form');
        if (replyForm) {
            replyForm.style.display = discussion.is_closed ? 'none' : 'block';
        }

        await loadReplies(discussionId);
        await initEnhancedFeatures();
        subscribeToReplies(discussionId);

    } catch (error) {
        console.error('Error loading discussion detail:', error);
        showToast('Error cargando la discusión', 'error');
    }
}

async function renderDiscussionPost(discussion, authorName, likesCount, isLiked) {
    const container = document.getElementById('discussion-post');
    if (!container) return;

    const date = new Date(discussion.created_at).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    // NUEVO: Obtener información completa del autor incluyendo avatar
    let authorAvatar = null;
    let authorFullName = authorName;
    
    try {
        const { data: profile } = await supabaseClient
            .from('profiles')
            .select('username, full_name, avatar_url')
            .eq('id', discussion.created_by)
            .single();
        
        if (profile) {
            authorAvatar = profile.avatar_url;
            authorFullName = profile.full_name || profile.username || authorName;
        }
    } catch (error) {
        console.log('Error obteniendo perfil del autor:', error);
    }

    // Generar HTML del avatar
    const authorAvatarHTML = authorAvatar ? 
        `<img src="${authorAvatar}" alt="${authorFullName}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(74, 158, 255, 0.3);">` :
        `<div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #4a9eff, #00d4ff); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid rgba(74, 158, 255, 0.3);">
            ${authorFullName.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase()}
        </div>`;

    const isClosed = discussion.is_closed;
    const statusIcon = isClosed ? 'lock' : 'unlock';
    const statusText = isClosed ? 'Cerrado' : 'Abierto';
    const statusClass = isClosed ? 'closed' : 'open';
    
    const canManageDiscussion = currentUserRole === 'admin' || currentUserRole === 'owner';
    const isAuthor = discussion.created_by === currentUser.id;

    const discussionDetailView = document.getElementById('discussion-detail-view');
    if (discussionDetailView) {
        if (isClosed) {
            discussionDetailView.classList.add('discussion-closed');
        } else {
            discussionDetailView.classList.remove('discussion-closed');
        }
    }

    container.innerHTML = `
        <div class="discussion-post-header">
            <div class="discussion-post-info">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <h1 class="discussion-post-title">${discussion.title || 'Sin título'}</h1>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: -26px; margin-top: 8px;">
                                ${authorAvatarHTML}
                                <span class="discussion-post-author">${authorFullName}</span>
                            </div>
                           
                        </div>
                    </div>
                    <div class="discussion-status ${statusClass}" style="position: static; margin: 0; flex-shrink: 0;">
                        <i class="fas fa-${statusIcon}"></i>
                        <span>${statusText}</span>

                        
                    </div>
                    
                </div>
            </div>
        </div>
        
        <div class="discussion-post-content">
            ${processContentWithMentions(discussion.content || 'Sin contenido')}
        </div>
         <div style="display: flex; align-items: center; gap: 8px; color: #8892a6; margin-left: 5px; ">
                <i class="far fa-clock" style="color: #4a9eff;"></i>
                <span>${date}</span>
         </div>
        
        <div class="discussion-post-actions">
            <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleDiscussionLike('${discussion.id}')">
                <i class="fas fa-thumbs-up"></i>
                <span>${likesCount}</span>
            </button>
            ${!isClosed ? `
                <button class="action-btn" onclick="focusReplyTextarea()">
                    <i class="fas fa-reply"></i>
                    Responder
                </button>
            ` : ''}
            <button class="action-btn" onclick="shareDiscussion('${discussion.id}')">
                <i class="fas fa-share-alt"></i>
                Compartir
            </button>
        </div>
        
        <div class="quick-reactions" id="discussion-reactions">
            <!-- Se cargan dinámicamente -->
        </div>
        
        ${canManageDiscussion || isAuthor ? `
            <div class="discussion-admin-controls">
                ${canManageDiscussion ? `
                    ${isClosed ?
                        `<button class="admin-btn open-btn" onclick="toggleDiscussionStatus('${discussion.id}', false)">
                            <i class="fas fa-unlock"></i> 
                            Reabrir Discusión
                        </button>` :
                        `<button class="admin-btn close-btn" onclick="toggleDiscussionStatus('${discussion.id}', true)">
                            <i class="fas fa-lock"></i> 
                            Cerrar Discusión
                        </button>`
                    }
                ` : ''}
                
                ${(canManageDiscussion || isAuthor) ? `
                    <button class="admin-btn delete-btn" onclick="deleteDiscussionFromDetail('${discussion.id}')">
                        <i class="fas fa-trash-alt"></i>
                        Eliminar Discusión
                    </button>
                ` : ''}
            </div>
        ` : ''}
        
        ${isClosed ? `
            <div class="closed-message">
                <i class="fas fa-lock" style="margin-right: 8px;"></i>
                Esta discusión ha sido cerrada. No se pueden agregar nuevas respuestas.
            </div>
        ` : ''}
    `;

    const replyForm = document.querySelector('.reply-form');
    if (replyForm) {
        replyForm.style.display = isClosed ? 'none' : 'block';
    }

    loadDiscussionReactions(discussion.id);
}


async function deleteDiscussionFromDetail(discussionId) {
    console.log('deleteDiscussionFromDetail called with:', discussionId); // Debug
    
    // Verificar permisos en tiempo real
    const hasPermission = await verifyDeletePermissions(discussionId);
    
    if (!hasPermission) {
        showToast('No tienes permisos para eliminar esta discusión', 'error');
        return;
    }

    showDeleteModal(discussionId);
}

// 6. DEBUGGING: Agregar logs para verificar que las funciones están disponibles
console.log('Delete functions loaded:');
console.log('- showDeleteModal:', typeof showDeleteModal);
console.log('- confirmDeleteDiscussion:', typeof confirmDeleteDiscussion);
console.log('- deleteDiscussionFromDetail:', typeof deleteDiscussionFromDetail);
console.log('- verifyDeletePermissions:', typeof verifyDeletePermissions);


        function processContentWithMentions(content) {
            return content.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
        }

        async function loadDiscussionReactions(discussionId) {
            try {
                const { data: reactions, error } = await supabaseClient
                    .from('discussion_reactions')
                    .select('reaction_type, user_id')
                    .eq('discussion_id', discussionId);

                if (error) throw error;

                const reactionCounts = {};
                const userReactions = new Set();

                reactions.forEach(reaction => {
                    reactionCounts[reaction.reaction_type] = (reactionCounts[reaction.reaction_type] || 0) + 1;
                    if (reaction.user_id === currentUser.id) {
                        userReactions.add(reaction.reaction_type);
                    }
                });

                renderReactions('discussion-reactions', reactionCounts, userReactions, discussionId, 'discussion');

            } catch (error) {
                console.error('Error loading reactions:', error);
            }
        }

        function renderReactions(containerId, reactionCounts, userReactions, targetId, type) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = Object.entries(REACTIONS).map(([key, emoji]) => {
                const count = reactionCounts[key] || 0;
                const isActive = userReactions.has(key);

                return `
            <button class="reaction-btn ${isActive ? 'active' : ''}" 
                    onclick="toggleReaction('${targetId}', '${key}', '${type}')"
                    data-reaction="${key}">
                <span class="emoji">${emoji}</span>
                ${count > 0 ? `<span class="count">${count}</span>` : ''}
            </button>
        `;
            }).join('');
        }

        async function toggleReaction(targetId, reactionType, type) {
            try {
                const table = type === 'discussion' ? 'discussion_reactions' : 'reply_reactions';
                const column = type === 'discussion' ? 'discussion_id' : 'reply_id';

                // Verificar si ya existe la reacción
                const { data: existing, error: checkError } = await supabaseClient
                    .from(table)
                    .select('id')
                    .eq(column, targetId)
                    .eq('user_id', currentUser.id)
                    .eq('reaction_type', reactionType)
                    .maybeSingle();

                if (checkError && checkError.code !== 'PGRST116') throw checkError;

                if (existing) {
                    // Quitar reacción
                    await supabaseClient
                        .from(table)
                        .delete()
                        .eq('id', existing.id);
                } else {
                    // Agregar reacción
                    await supabaseClient
                        .from(table)
                        .insert([{
                            [column]: targetId,
                            user_id: currentUser.id,
                            reaction_type: reactionType
                        }]);
                }

                // Recargar reacciones
                if (type === 'discussion') {
                    loadDiscussionReactions(targetId);
                } else {
                    // Recargar respuestas para actualizar reacciones de replies
                    await loadReplies(currentDiscussion.id);
                }

            } catch (error) {
                console.error('Error toggling reaction:', error);
                showToast('Error al procesar la reacción', 'error');
            }
        }

// Modificar la función toggleDiscussionStatus para actualizar también la lista
async function toggleDiscussionStatus(discussionId, shouldClose) {
    try {
        const updates = {
            is_closed: shouldClose,
            closed_at: shouldClose ? new Date().toISOString() : null,
            closed_by: shouldClose ? currentUser.id : null
        };

        const { data, error } = await supabaseClient
            .from('discussions')
            .update(updates)
            .eq('id', discussionId)
            .select()
            .single();

        if (error) throw error;

        showToast(shouldClose ? 'Discusión cerrada correctamente' : 'Discusión reabierta correctamente');

        // IMPORTANTE: Actualizar el objeto currentDiscussion
        currentDiscussion = data;

        // NUEVO: Actualizar la discusión en el array de discussions
        const index = discussions.findIndex(d => d.id === discussionId);
        if (index !== -1) {
            discussions[index] = {
                ...discussions[index],
                is_closed: shouldClose,
                closed_at: updates.closed_at,
                closed_by: updates.closed_by
            };
            
            // Re-renderizar la card específica sin recargar toda la lista
            updateDiscussionCard(discussionId, shouldClose);
        }

        // Forzar recarga completa del detalle
        await loadDiscussionDetail(discussionId);

        // Resto del código...
    } catch (error) {
        console.error('Error updating discussion status:', error);
        showToast('Error al cambiar el estado de la discusión', 'error');
    }
}

// Nueva función para actualizar solo la card específica
function updateDiscussionCard(discussionId, isClosed) {
    const card = document.querySelector(`[data-discussion-id="${discussionId}"]`);
    if (card) {
        // Actualizar el icono de estado en la card
        const statusElement = card.querySelector('.discussion-status');
        if (statusElement) {
            statusElement.className = `discussion-status ${isClosed ? 'closed' : 'open'}`;
            statusElement.innerHTML = `<i class="fas fa-${isClosed ? 'lock' : 'unlock'}"></i>`;
        }
    }
}

      // MODIFICAR setupTypingIndicator para incluir menciones en inline replies
function setupTypingIndicator() {
    const textarea = document.getElementById('reply-textarea');
    if (!textarea) return;

    textarea.addEventListener('input', () => {
        if (!currentDiscussion) return;

        // Limpiar timer anterior
        if (typingTimer) {
            clearTimeout(typingTimer);
        }

        // Actualizar estado de escribiendo
        updateTypingStatus(true);

        // Limpiar después de 3 segundos de inactividad
        typingTimer = setTimeout(() => {
            updateTypingStatus(false);
        }, 3000);
    });

    textarea.addEventListener('blur', () => {
        updateTypingStatus(false);
    });

    // AGREGAR MENCIONES PARA RESPUESTAS INLINE
    document.addEventListener('input', (e) => {
        if (e.target.classList.contains('reply-textarea') && e.target.id.startsWith('inline-textarea-')) {
            if (!currentDiscussion) return;

            // Typing indicator
            if (typingTimer) {
                clearTimeout(typingTimer);
            }

            updateTypingStatus(true);

            typingTimer = setTimeout(() => {
                updateTypingStatus(false);
            }, 2000);

            // MENCIONES PARA INLINE REPLIES
            const text = e.target.value;
            const cursorPos = e.target.selectionStart;

            // Buscar @ antes del cursor
            const beforeCursor = text.substring(0, cursorPos);
            const atMatch = beforeCursor.match(/@(\w*)$/);

            if (atMatch) {
                currentMentionInput = {
                    textarea: e.target,
                    start: cursorPos - atMatch[0].length,
                    query: atMatch[1]
                };
                showMentionSuggestions(atMatch[1], e.target);
            } else {
                hideMentionSuggestions();
            }
        }
    });
}
        async function updateTypingStatus(isTyping) {
            // Limpiar timer anterior
            if (typingDebounceTimer) {
                clearTimeout(typingDebounceTimer);
            }

            // Debounce de 500ms
            typingDebounceTimer = setTimeout(async () => {
                try {
                    if (isTyping) {
                        const { error } = await supabaseClient
                            .from('typing_status')
                            .upsert({
                                discussion_id: currentDiscussion.id,
                                user_id: currentUser.id,
                                updated_at: new Date().toISOString()
                            }, {
                                onConflict: 'discussion_id,user_id'
                            });

                        if (error) throw error;
                    } else {
                        await supabaseClient
                            .from('typing_status')
                            .delete()
                            .eq('discussion_id', currentDiscussion.id)
                            .eq('user_id', currentUser.id);
                    }
                } catch (error) {
                    console.log('Error updating typing status:', error);
                }
            }, 500);
        }

function setupMentions(textareaId) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;

    textarea.addEventListener('input', (e) => {
        const text = e.target.value;
        const cursorPos = e.target.selectionStart;

        // Buscar @ antes del cursor
        const beforeCursor = text.substring(0, cursorPos);
        const atMatch = beforeCursor.match(/@(\w*)$/);

        if (atMatch) {
            currentMentionInput = {
                textarea: textarea,
                start: cursorPos - atMatch[0].length,
                query: atMatch[1]
            };
            showMentionSuggestions(atMatch[1], textarea);
        } else {
            hideMentionSuggestions();
        }
    });
}


        function showMentionSuggestions(query, textarea) {
            const filtered = projectMembers.filter(member =>
                member.username.toLowerCase().includes(query.toLowerCase()) ||
                member.name.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 5);

            if (filtered.length === 0) {
                hideMentionSuggestions();
                return;
            }

            // Crear o actualizar sugerencias
            let suggestions = document.getElementById('mention-suggestions');
            if (!suggestions) {
                suggestions = document.createElement('div');
                suggestions.id = 'mention-suggestions';
                suggestions.className = 'mention-suggestion';
                document.body.appendChild(suggestions);
            }

            suggestions.innerHTML = filtered.map((member, index) => `
        <div class="mention-item" data-username="${member.username}" data-index="${index}">
            ${member.name} (@${member.username})
        </div>
    `).join('');

            // Posicionar cerca del textarea
            const rect = textarea.getBoundingClientRect();
            suggestions.style.position = 'fixed';
            suggestions.style.top = (rect.bottom + 5) + 'px';
            suggestions.style.left = rect.left + 'px';
            suggestions.style.display = 'block';

            // Event listeners para selección
            suggestions.querySelectorAll('.mention-item').forEach(item => {
                item.addEventListener('click', () => {
                    selectMention(item.dataset.username);
                });
            });
        }

        function selectMention(username) {
            if (!currentMentionInput) return;

            const textarea = currentMentionInput.textarea;
            const start = currentMentionInput.start;
            const end = textarea.selectionStart;

            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);

            textarea.value = before + '@' + username + ' ' + after;
            textarea.focus();
            textarea.setSelectionRange(start + username.length + 2, start + username.length + 2);

            hideMentionSuggestions();
            currentMentionInput = null;
        }


        function hideMentionSuggestions() {
            const suggestions = document.getElementById('mention-suggestions');
            if (suggestions) {
                suggestions.style.display = 'none';
            }
        }

        async function initEnhancedFeatures() {
            await loadProjectMembers();
            setupTypingIndicator();
            setupMentions('reply-textarea');

            // Limpiar estados de escribiendo antiguos
            await supabaseClient
                .from('typing_status')
                .delete()
                .lt('updated_at', new Date(Date.now() - 10000).toISOString());
        }


        async function toggleDiscussionLike(discussionId) {
            try {
                // Verificar si ya existe un like del usuario
                const { data: existingLike, error: checkError } = await supabaseClient
                    .from('discussion_likes')
                    .select('id')
                    .eq('discussion_id', discussionId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('Error checking existing like:', checkError);
                    throw checkError;
                }

                if (existingLike) {
                    // Ya tiene like - quitar like
                    const { error: deleteError } = await supabaseClient
                        .from('discussion_likes')
                        .delete()
                        .eq('id', existingLike.id);

                    if (deleteError) throw deleteError;

                    showToast('Like removido');
                } else {
                    // No tiene like - agregar like
                    const { error: insertError } = await supabaseClient
                        .from('discussion_likes')
                        .insert([{
                            discussion_id: discussionId,
                            user_id: currentUser.id
                        }]);

                    if (insertError) {
                        // Si hay conflicto, significa que se creó entre verificación y inserción
                        if (insertError.code === '23505') {
                            showToast('Ya habías dado like a esta discusión');
                            return;
                        }
                        throw insertError;
                    }

                    showToast('Like agregado');
                }

                // Recargar el detalle de la discusión
                await loadDiscussionDetail(discussionId);

            } catch (error) {
                console.error('Error toggling discussion like:', error);
                showToast('Error al procesar el like', 'error');
            }
        }

        async function toggleReplyLike(replyId) {
            try {
                // Verificar si ya existe un like del usuario
                const { data: existingLike, error: checkError } = await supabaseClient
                    .from('reply_likes')
                    .select('id')
                    .eq('reply_id', replyId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('Error checking existing reply like:', checkError);
                    throw checkError;
                }

                if (existingLike) {
                    // Ya tiene like - quitar like
                    const { error: deleteError } = await supabaseClient
                        .from('reply_likes')
                        .delete()
                        .eq('id', existingLike.id);

                    if (deleteError) throw deleteError;

                    showToast('Like removido');
                } else {
                    // No tiene like - agregar like
                    const { error: insertError } = await supabaseClient
                        .from('reply_likes')
                        .insert([{
                            reply_id: replyId,
                            user_id: currentUser.id
                        }]);

                    if (insertError) {
                        // Si hay conflicto, significa que se creó entre verificación y inserción
                        if (insertError.code === '23505') {
                            showToast('Ya habías dado like a esta respuesta');
                            return;
                        }
                        throw insertError;
                    }

                    showToast('Like agregado');
                }

                // Recargar respuestas
                await loadReplies(currentDiscussion.id);

            } catch (error) {
                console.error('Error toggling reply like:', error);
                showToast('Error al procesar el like', 'error');
            }
        }


        function focusReplyTextarea() {
            const textarea = document.getElementById('reply-textarea');
            if (textarea) {
                textarea.focus();
            }
        }

        // Funcionalidad de IA con análisis real usando tu backend


        async function analyzeDiscussion() {
            if (!currentDiscussion) {
                showToast('No hay discusión para analizar', 'error');
                return;
            }

            const analyzeBtn = document.querySelector('.ai-analyze-btn');
            const suggestionsContainer = document.querySelector('.ai-suggestions');
            const aiPanel = document.querySelector('.ai-panel'); // Agregar esto

            // Mostrar estado de carga
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando...';
            analyzeBtn.disabled = true;
            aiPanel.classList.add('analyzing'); // Agregar clase de análisis

            try {
                const discussionContent = await gatherDiscussionContent();
                const analysis = await performAIAnalysis(discussionContent);
                displayAIAnalysis(analysis, suggestionsContainer);

            } catch (error) {
                console.error('Error en análisis de IA:', error);
                showToast('Error al analizar la discusión', 'error');

                suggestionsContainer.innerHTML = `
            <div style="color: #ef4444; text-align: center; padding: 20px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Error al realizar el análisis</p>
                <small>${error.message}</small>
            </div>
        `;
            } finally {
                // Restaurar botón y quitar efecto
                analyzeBtn.innerHTML = '<i class="fas fa-brain"></i> Analizar Discusión';
                analyzeBtn.disabled = false;
                aiPanel.classList.remove('analyzing'); // Quitar clase de análisis
            }
        }


        async function gatherDiscussionContent() {
            let content = `DISCUSIÓN EN FORO DE DESARROLLO WEB/SOFTWARE\n\n`;
            content += `Título de la discusión: ${currentDiscussion.title}\n\n`;
            content += `Contenido principal del post:\n${currentDiscussion.content}\n\n`;

            if (repliesHierarchy && repliesHierarchy.length > 0) {
                content += "COMENTARIOS Y RESPUESTAS DE LOS PARTICIPANTES:\n";

                function addRepliesRecursively(replies, indent = "") {
                    replies.forEach(reply => {
                        content += `${indent}${reply.author_name} comenta: "${reply.content}"\n`;
                        if (reply.children && reply.children.length > 0) {
                            addRepliesRecursively(reply.children, indent + "  ");
                        }
                    });
                }

                addRepliesRecursively(repliesHierarchy);
            } else {
                content += "\n(No hay comentarios aún en esta discusión)";
            }

            content += `\n\nCONTEXTO: Esta es una discusión en un foro de desarrollo de software/web. Analiza el contenido específico y proporciona sugerencias relevantes al tema discutido.`;

            return content;
        }



        async function performAIAnalysis(content) {
            // CAMBIO PRINCIPAL: llamar a TU backend en lugar de la API directa
            const response = await fetch('https://open-analy.vercel.app/api/analyze-discussion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content })
            });

            if (!response.ok) {
                throw new Error(`Error del servidor: ${response.status}`);
            }

            const result = await response.json();

            // Si el backend devolvió un resultado exitoso
            if (result.success) {
                return result.data;
            }

            // Si hay un fallback, usarlo
            if (result.fallback) {
                return result.fallback;
            }

            throw new Error('Respuesta inesperada del servidor');
        }

        function displayAIAnalysis(analysis) {
            // Apunta al contenedor correcto usando el ID que creamos
            const analysisContainer = document.getElementById('ai-analysis-results');

            // Si no se encuentra el contenedor, muestra un error en la consola
            if (!analysisContainer) {
                console.error("Error: Contenedor 'ai-analysis-results' no encontrado en el HTML.");
                return;
            }

            const html = `
    <div class="ai-analysis-section">
        <div class="ai-analysis-title">📋 Resumen Ejecutivo</div>
        <div class="ai-analysis-content">${analysis.resumen_ejecutivo}</div>
    </div>
    <div class="ai-analysis-section">
        <div class="ai-analysis-title">🕵️‍♂️ Análisis de Perspectivas</div>
        <div class="ai-analysis-content">
            <span class="ai-analysis-label">Puntos de Convergencia:</span>
            <ul class="ai-analysis-list">
                ${(analysis.analisis_de_perspectivas.puntos_de_convergencia || []).map(p => `<li>${p}</li>`).join('')}
            </ul>
            <span class="ai-analysis-label">Puntos de Divergencia:</span>
            <ul class="ai-analysis-list">
                ${(analysis.analisis_de_perspectivas.puntos_de_divergencia || []).map(p => `<li>${p}</li>`).join('')}
            </ul>
        </div>
    </div>
    <div class="ai-analysis-section">
        <div class="ai-analysis-title">⚖️ Evaluación Crítica</div>
        ${(analysis.evaluacion_critica || []).map(ec => `
            <div class="ai-analysis-tag">${ec.aspecto}</div>
            <div class="ai-analysis-content">
                <span class="ai-analysis-label">Fortalezas:</span> ${ec.fortalezas}<br>
                <span class="ai-analysis-label">Debilidades:</span> ${ec.debilidades}<br>
                <span class="ai-analysis-label">Impacto Potencial:</span> ${ec.impacto_potencial}
            </div>
        `).join('')}
    </div>
    <div class="ai-analysis-section">
        <div class="ai-analysis-title">💡 Sugerencias Profesionales</div>
        ${(analysis.recomendaciones_profesionales || []).map(sug => `
            <div class="ai-analysis-tag">${sug.categoria}</div>
            <div class="ai-analysis-content">
                <span class="ai-analysis-label">${sug.titulo}</span><br>
                <span>${sug.descripcion}</span><br>
                <span class="ai-analysis-label">Justificación:</span> ${sug.justificacion}<br>
                <span class="ai-analysis-label">Implementación:</span> ${sug.implementacion}<br>
                <span class="ai-analysis-label">Consideraciones Técnicas:</span> ${sug.consideraciones_tecnicas}
            </div>
        `).join('')}
    </div>
    <div class="ai-analysis-section">
        <div class="ai-analysis-title">🚀 Oportunidades no Consideradas</div>
        <div class="ai-analysis-content">
            <ul class="ai-analysis-list">
                ${(analysis.oportunidades_no_consideradas || []).map(opt => `<li>${opt}</li>`).join('')}
            </ul>
        </div>
    </div>
    <div class="ai-analysis-section">
        <div class="ai-analysis-title">➡️ Siguientes Pasos</div>
        <div class="ai-analysis-content">${analysis.siguiente_pasos_recomendados}</div>
    </div>
    `;

            // Inserta el HTML en el contenedor correcto
            analysisContainer.innerHTML = html;
        }



        // Modal functions
        function showNewDiscussionModal() {
            const modal = document.getElementById('new-discussion-modal');
            const titleInput = document.getElementById('discussion-title');

            if (modal) {
                modal.classList.add('show');
            }
            if (titleInput) {
                titleInput.focus();
            }
        }

        function closeNewDiscussionModal() {
            const modal = document.getElementById('new-discussion-modal');
            const titleInput = document.getElementById('discussion-title');
            const contentInput = document.getElementById('discussion-content');

            if (modal) {
                modal.classList.remove('show');
            }
            if (titleInput) {
                titleInput.value = '';
            }
            if (contentInput) {
                contentInput.value = '';
            }
        }

async function createNewDiscussion() {
    const titleEl = document.getElementById('discussion-title');
    const contentEl = document.getElementById('discussion-content');

    if (!titleEl || !contentEl) {
        showToast('Error en el formulario', 'error');
        return;
    }

    const title = titleEl.value.trim();
    const content = contentEl.value.trim();

    if (!title) {
        showToast('El título es obligatorio', 'error');
        return;
    }

    if (!content) {
        showToast('El contenido es obligatorio', 'error');
        return;
    }

    // CREAR DISCUSIÓN TEMPORAL
    const tempDiscussion = {
    id: 'temp-' + Date.now(),
    project_id: currentProject.id,
    title: title,
    content: content,
    created_by: currentUser.id,
    created_at: new Date().toISOString(),
    order_index: Date.now() * 1000 + Math.floor(Math.random() * 1000), // AGREGAR ESTA LÍNEA
    author_name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
    likes_count: 0,
    replies_count: 0,
    is_closed: false,
    isTemp: true
};

    discussions.unshift(tempDiscussion);
    
    const container = document.getElementById('discussions-grid');
    const newCard = await createDiscussionCard(tempDiscussion);
    
    const emptyState = container.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    container.insertBefore(newCard, container.firstChild);
    
    newCard.style.opacity = '0';
    newCard.style.transform = 'translateY(-20px)';
    setTimeout(() => {
        newCard.style.transition = 'all 0.3s ease';
        newCard.style.opacity = '1';
        newCard.style.transform = 'translateY(0)';
    }, 50);

    closeNewDiscussionModal();

    try {
        const { data, error } = await supabaseClient
    .from('discussions')
    .insert([{
        project_id: currentProject.id,
        title: title,
        content: content,
        created_by: currentUser.id,
        order_index: Date.now() * 1000 + Math.floor(Math.random() * 1000) // AGREGAR ESTA LÍNEA
    }])
    .select()
    .single();

        if (error) throw error;

        // ACTUALIZAR ORDEN GUARDADO CON LA NUEVA DISCUSIÓN
        const tempIndex = discussions.findIndex(d => d.id === tempDiscussion.id);
        if (tempIndex !== -1) {
            const realDiscussion = {
                ...data,
                author_name: tempDiscussion.author_name,
                likes_count: 0,
                replies_count: 0
            };
            
            discussions[tempIndex] = realDiscussion;
            
            // ACTUALIZAR ORDEN EN LOCALSTORAGE
            const storageKey = `discussion_order_${currentProject.id}`;
            const newOrder = discussions.map(d => d.id);
            localStorage.setItem(storageKey, JSON.stringify(newOrder));
            
            const tempCard = document.querySelector(`[data-discussion-id="${tempDiscussion.id}"]`);
            if (tempCard) {
                tempCard.setAttribute('data-discussion-id', data.id);
                tempCard.onclick = () => openDiscussion(data.id);
                tempCard.style.opacity = '1';
                tempCard.style.border = '';
            }
        }

        showToast('Discusión creada correctamente');

    } catch (error) {
        console.error('Error creating discussion:', error);
        
        const tempIndex = discussions.findIndex(d => d.id === tempDiscussion.id);
        if (tempIndex !== -1) {
            discussions.splice(tempIndex, 1);
            
            const tempCard = document.querySelector(`[data-discussion-id="${tempDiscussion.id}"]`);
            if (tempCard) {
                tempCard.style.transition = 'all 0.3s ease';
                tempCard.style.opacity = '0';
                tempCard.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    tempCard.remove();
                    if (discussions.length === 0) {
                        showEmptyState();
                    }
                }, 300);
            }
        }
        
        showToast('Error al crear la discusión', 'error');
    }
}

function showEmptyState() {
    const container = document.getElementById('discussions-grid');
    if (container && discussions.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <i class="fas fa-comments"></i>
                <h3>No hay discusiones aún</h3>
                <p>Sé el primero en crear una discusión para este proyecto</p>
            </div>
        `;
    }
}


        // Utility functions
        async function handleLogout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error logging out:', error);
                showToast('Error al cerrar sesión', 'error');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');

            if (sidebar && mainContent) {
                sidebar.classList.toggle('hidden');
                mainContent.classList.toggle('expanded');
            }
        }

        function redirectToHome(reason) {
            console.log('Redirecting to home:', reason);
            showToast(reason, 'error');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }

function showToast(message, type = 'success', duration = 3000) {
    const toast = document.getElementById('toast');
    if (!toast) return;

    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
    }, duration);
}


const tempReplyStyles = `
    .reply-item[data-reply-id^="temp-"] {
        opacity: 0.8;
        background: rgba(74, 158, 255, 0.05);
        border-left: 3px solid #4a9eff;
        position: relative;
    }
    
    .reply-item[data-reply-id^="temp-"]::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #4a9eff, transparent);
        animation: sendingAnimation 1.5s infinite;
    }
    
    @keyframes sendingAnimation {
        0% { opacity: 0.3; }
        50% { opacity: 1; }
        100% { opacity: 0.3; }
    }
    
    .nested-indicator {
        font-size: 11px;
        color: #6366f1;
        margin-bottom: 8px;
        font-style: italic;
        padding: 4px 8px;
        background: rgba(74, 158, 255, 0.1);
        border-radius: 4px;
        display: inline-block;
    }
    
    .nested-indicator strong {
        color: #4a9eff;
        font-weight: 600;
    }
`;

// Inyectar estilos
if (!document.getElementById('temp-reply-styles')) {
    const style = document.createElement('style');
    style.id = 'temp-reply-styles';
    style.textContent = tempReplyStyles;
    document.head.appendChild(style);
}

// Inyectar estilos
if (!document.getElementById('temp-reply-styles')) {
    const style = document.createElement('style');
    style.id = 'temp-reply-styles';
    style.textContent = tempReplyStyles;
    document.head.appendChild(style);
}


        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            // ESC para cerrar modal o volver
            if (e.key === 'Escape') {
                const modal = document.getElementById('new-discussion-modal');
                if (modal && modal.classList.contains('show')) {
                    closeNewDiscussionModal();
                } else if (currentView === 'discussion-detail') {
                    showDiscussionsList();
                }
            }

            // Ctrl+Enter para enviar respuesta
            if (e.ctrlKey && e.key === 'Enter') {
                const textarea = document.getElementById('reply-textarea');
                if (textarea && document.activeElement === textarea) {
                    submitReply();
                }
            }
        });
        // Inicializar tema e idioma
        function initializeThemeAndLanguage() {
            document.body.setAttribute('data-theme', currentTheme);
            updateThemeIcon();
            updateLanguageContent();
            generateLanguageDropdown();
        }

        // Cambiar tema
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const themeIcon = document.querySelector('.control-btn i.fa-moon, .control-btn i.fa-sun');
            if (themeIcon) {
                themeIcon.className = `fas fa-${currentTheme === 'dark' ? 'sun' : 'moon'}`;
            }
        }

        // Generar dropdown de idiomas
        function generateLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            if (dropdown) {
                dropdown.innerHTML = Object.entries(supportedLanguages).map(([code, lang]) =>
                    `<div class="language-option ${currentLanguage === code ? 'active' : ''}" 
                  onclick="changeLanguage('${code}')">
                ${lang.flag} ${lang.name}
             </div>`
                ).join('');
            }
        }

        // Cambiar idioma
        function changeLanguage(lang) {
            if (supportedLanguages[lang]) {
                currentLanguage = lang;
                localStorage.setItem('language', lang);
                updateLanguageContent();
                generateLanguageDropdown();

                const dropdown = document.getElementById('languageDropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
            }
        }

        // Actualizar contenido del idioma
        function updateLanguageContent() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                const translation = t(key);
                if (translation && translation !== key) {
                    element.textContent = translation;
                }
            });
        }

        // Toggle dropdown con posicionamiento fijo
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            const button = dropdown.parentElement.querySelector('.control-btn');

            if (dropdown) {
                dropdown.classList.toggle('show');
                if (dropdown.classList.contains('show')) {
                    const rect = button.getBoundingClientRect();
                    dropdown.style.top = (rect.bottom + 5) + 'px';
                    dropdown.style.right = (window.innerWidth - rect.right) + 'px';
                }
            }
        }

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function (event) {
            const languageSelector = document.querySelector('.language-selector');
            const dropdown = document.getElementById('languageDropdown');

            if (dropdown && languageSelector && !languageSelector.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

// Variables para subscripciones
let realtimeSubscriptions = [];

// Función para suscribirse a cambios en tiempo real
async function subscribeToRealtimeChanges() {
    if (!currentProject) return;

    // Limpiar suscripciones anteriores
    realtimeSubscriptions.forEach(sub => {
        supabaseClient.removeChannel(sub);
    });
    realtimeSubscriptions = [];

    // 1. Suscripción a nuevas discusiones
    const discussionsChannel = supabaseClient
        .channel('discussions_changes')
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'discussions',
            filter: `project_id=eq.${currentProject.id}`
        }, (payload) => {
            handleNewDiscussion(payload.new);
        })
        .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'discussions',
            filter: `project_id=eq.${currentProject.id}`
        }, (payload) => {
            handleUpdatedDiscussion(payload.new);
        })
        .on('postgres_changes', {
            event: 'DELETE',
            schema: 'public',
            table: 'discussions'
        }, (payload) => {
            handleDeletedDiscussion(payload.old);
        })
        .subscribe();

    realtimeSubscriptions.push(discussionsChannel);

    // 2. Suscripción a respuestas (solo si estamos viendo una discusión)
    if (currentDiscussion) {
        subscribeToReplies(currentDiscussion.id);
    }

    // 3. Suscripción a estado de escritura
    const typingChannel = supabaseClient
        .channel('typing_status')
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'typing_status'
        }, (payload) => {
            handleTypingStatusChange(payload);
        })
        .subscribe();

    realtimeSubscriptions.push(typingChannel);

    const mentionsChannel = supabaseClient
    .channel('mention_notifications')
    .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'mention_notifications',
        filter: `user_id=eq.${currentUser.id}`
    }, (payload) => {
        // Solo mostrar si no está en la discusión actual
        const urlParams = new URLSearchParams(window.location.search);
        const currentViewingDiscussion = urlParams.get('discussion');
        
        if (currentViewingDiscussion !== payload.new.discussion_id) {
            loadNotificationCount();
            showRealtimeNotification(`${payload.new.mentioned_by_name} te mencionó en "${payload.new.discussion_title}"`);
        }
    })
    .subscribe();

realtimeSubscriptions.push(mentionsChannel);
}

// Suscribirse a respuestas de una discusión específica
function subscribeToReplies(discussionId) {
    // Remover suscripción anterior de respuestas si existe
    const existingRepliesChannel = realtimeSubscriptions.find(sub => sub.topic.includes('replies'));
    if (existingRepliesChannel) {
        supabaseClient.removeChannel(existingRepliesChannel);
        realtimeSubscriptions = realtimeSubscriptions.filter(sub => sub !== existingRepliesChannel);
    }

    const repliesChannel = supabaseClient
        .channel(`replies_${discussionId}`)
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'discussion_replies',
            filter: `discussion_id=eq.${discussionId}`
        }, (payload) => {
            handleNewReply(payload.new);
        })
        .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'discussion_replies',
            filter: `discussion_id=eq.${discussionId}`
        }, (payload) => {
            handleUpdatedReply(payload.new);
        })
        .on('postgres_changes', {
            event: 'DELETE',
            schema: 'public',
            table: 'discussion_replies'
        }, (payload) => {
            handleDeletedReply(payload.old);
        })
        .subscribe();

    realtimeSubscriptions.push(repliesChannel);
}

// Manejadores de eventos en tiempo real
async function handleNewDiscussion(discussion) {
    if (currentView === 'discussions-list') {
        // VERIFICAR SI YA EXISTE (para evitar duplicados de real-time)
        const existingIndex = discussions.findIndex(d => d.id === discussion.id);
        if (existingIndex !== -1) {
            return; // Ya existe, no hacer nada
        }
        
        // VERIFICAR SI EXISTE COMO TEMPORAL
        const tempIndex = discussions.findIndex(d => 
            d.isTemp && 
            d.title === discussion.title && 
            d.created_by === discussion.created_by
        );
        
        if (tempIndex !== -1) {
            // Es la versión real de nuestra temporal, ya se manejó en createNewDiscussion
            return;
        }
        
        // ES UNA NUEVA DISCUSIÓN DE OTRO USUARIO
        const authorName = await getUserName(discussion.created_by);
        const discussionWithInfo = {
            ...discussion,
            author_name: authorName,
            likes_count: 0,
            replies_count: 0
        };

        // Agregar al principio de la lista
        discussions.unshift(discussionWithInfo);
        
        // SOLO AGREGAR LA NUEVA CARD (no re-renderizar todo)
        const container = document.getElementById('discussions-grid');
        const emptyState = container.querySelector('.empty-state');
        
        if (emptyState) {
            emptyState.remove();
        }
        
        const newCard = await createDiscussionCard(discussionWithInfo);
        container.insertBefore(newCard, container.firstChild);
        
        // Animación de entrada
        newCard.style.opacity = '0';
        newCard.style.transform = 'translateY(-20px)';
        setTimeout(() => {
            newCard.style.transition = 'all 0.3s ease';
            newCard.style.opacity = '1';
            newCard.style.transform = 'translateY(0)';
        }, 50);

        // Mostrar notificación si no es del usuario actual
        if (discussion.created_by !== currentUser.id) {
            showRealtimeNotification(`${authorName} creó una nueva discusión: "${discussion.title}"`);
        }
    }
}

async function handleUpdatedDiscussion(discussion) {
    // Actualizar en la lista
    const index = discussions.findIndex(d => d.id === discussion.id);
    if (index !== -1) {
        const authorName = await getUserName(discussion.created_by);
        discussions[index] = {
            ...discussion,
            author_name: authorName,
            likes_count: discussions[index].likes_count,
            replies_count: discussions[index].replies_count
        };

        if (currentView === 'discussions-list') {
            renderDiscussions();
        }
    }

    // Si estamos viendo esta discusión, actualizar el detalle
    if (currentDiscussion && currentDiscussion.id === discussion.id) {
        currentDiscussion = discussion;
        await loadDiscussionDetail(discussion.id);
    }
}

function handleDeletedDiscussion(discussion) {
    // Remover de la lista
    discussions = discussions.filter(d => d.id !== discussion.id);
    
    if (currentView === 'discussions-list') {
        renderDiscussions();
    }

    // Si estamos viendo esta discusión, volver a la lista
    if (currentDiscussion && currentDiscussion.id === discussion.id) {
        showDiscussionsList();
        showRealtimeNotification('La discusión que estabas viendo fue eliminada');
    }
}


async function handleNewReply(reply) {
    if (currentDiscussion && reply.discussion_id === currentDiscussion.id) {
        // Verificar si ya existe como temporal
        const existsAsTemp = repliesHierarchy.some(r => 
            r.isTemp && r.content === reply.content && r.created_by === reply.created_by
        );
        
        // Si existe como temporal, no hacer nada (ya se manejó en submitReply)
        if (existsAsTemp) {
            return;
        }
        
        // Si es de otro usuario, recargar normalmente
        if (reply.created_by !== currentUser.id) {
            await loadReplies(currentDiscussion.id);
            
            const authorName = await getUserName(reply.created_by);
            showRealtimeNotification(`${authorName} respondió en la discusión`);
            
            setTimeout(() => {
                const repliesContainer = document.getElementById('replies-list');
                if (repliesContainer) {
                    repliesContainer.scrollTop = repliesContainer.scrollHeight;
                }
            }, 500);
        }
    }
}




function countAllNestedReplies(reply) {
    let count = 0;
    if (reply.children && reply.children.length > 0) {
        count += reply.children.length;
        reply.children.forEach(child => {
            count += countAllNestedReplies(child);
        });
    }
    return count;
}

async function handleUpdatedReply(reply) {
    if (currentDiscussion && reply.discussion_id === currentDiscussion.id) {
        await loadReplies(currentDiscussion.id);
    }
}

function handleDeletedReply(reply) {
    if (currentDiscussion && reply.discussion_id === currentDiscussion.id) {
        loadReplies(currentDiscussion.id);
    }
}

// Manejo del estado de escritura
async function handleTypingStatusChange(payload) {
    if (!currentDiscussion) return;

    const { eventType, new: newData, old: oldData } = payload;
    const data = newData || oldData;

    if (!data || data.discussion_id !== currentDiscussion.id) return;

    // No mostrar nuestro propio estado de escritura
    if (data.user_id === currentUser.id) return;

    if (eventType === 'INSERT' || eventType === 'UPDATE') {
        // Alguien está escribiendo
        const userName = await getUserName(data.user_id);
        showTypingIndicator(userName, data.user_id);
    } else if (eventType === 'DELETE') {
        // Alguien dejó de escribir
        hideTypingIndicator(data.user_id);
    }
}

// Mostrar indicador de escritura
// Mostrar indicador de escritura
function showTypingIndicator(userName, userId) {
    const container = document.getElementById('typing-indicators-container');
    if (!container) {
        console.log('Container typing-indicators-container no encontrado');
        return;
    }

    // Remover indicador existente de este usuario
    const existingIndicator = document.getElementById(`typing-${userId}`);
    if (existingIndicator) {
        existingIndicator.remove();
    }

    // Crear nuevo indicador
    const typingDiv = document.createElement('div');
    typingDiv.id = `typing-${userId}`;
    typingDiv.className = 'typing-indicator show';
    
    // IMPORTANTE: Usar innerHTML correctamente
    typingDiv.innerHTML = `
        <span>${userName} está escribiendo</span>
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;

    container.appendChild(typingDiv);
    console.log('Typing indicator agregado para:', userName);

    // Auto-remover después de 5 segundos
    setTimeout(() => {
        const indicator = document.getElementById(`typing-${userId}`);
        if (indicator) {
            indicator.remove();
        }
    }, 5000);
}

// Ocultar indicador de escritura
// Ocultar indicador de escritura
function hideTypingIndicator(userId) {
    const indicator = document.getElementById(`typing-${userId}`);
    if (indicator) {
        indicator.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
            if (indicator && indicator.parentNode) {
                indicator.remove();
            }
        }, 300);
    }
}

// Función para mostrar notificaciones en tiempo real
function showRealtimeNotification(message) {
    // Crear notificación flotante
    const notification = document.createElement('div');
    notification.className = 'realtime-notification';
    notification.innerHTML = `
        <i class="fas fa-bell"></i>
        <span>${message}</span>
    `;

    // Agregar estilos si no existen
    if (!document.getElementById('realtime-notification-styles')) {
        const styles = document.createElement('style');
        styles.id = 'realtime-notification-styles';
        styles.textContent = `
            .realtime-notification {
                position: fixed;
                top: 80px;
                right: 20px;
                background: rgba(74, 158, 255, 0.95);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                transform: translateX(100%);
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
                max-width: 300px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
            .realtime-notification.show {
                transform: translateX(0);
            }
        `;
        document.head.appendChild(styles);
    }

    document.body.appendChild(notification);

    // Mostrar animación
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);

    // Ocultar después de 4 segundos
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 4000);
}

// Función para limpiar suscripciones
function cleanupRealtimeSubscriptions() {
    realtimeSubscriptions.forEach(sub => {
        supabaseClient.removeChannel(sub);
    });
    realtimeSubscriptions = [];
}

// Función mejorada para actualizar estado de escritura
async function updateTypingStatus(isTyping) {
    if (!currentDiscussion) return;

    // Limpiar timer anterior
    if (typingDebounceTimer) {
        clearTimeout(typingDebounceTimer);
    }

    // Debounce de 300ms
    typingDebounceTimer = setTimeout(async () => {
        try {
            if (isTyping) {
                const { error } = await supabaseClient
                    .from('typing_status')
                    .upsert({
                        discussion_id: currentDiscussion.id,
                        user_id: currentUser.id,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'discussion_id,user_id'
                    });

                if (error) throw error;
            } else {
                await supabaseClient
                    .from('typing_status')
                    .delete()
                    .eq('discussion_id', currentDiscussion.id)
                    .eq('user_id', currentUser.id);
            }
        } catch (error) {
            console.log('Error updating typing status:', error);
        }
    }, 300);
}

// Limpiar al salir de la página
window.addEventListener('beforeunload', () => {
    if (currentDiscussion && currentUser) {
        updateTypingStatus(false);
    }
    cleanupRealtimeSubscriptions();
});


// SISTEMA COMPLETO DE MENCIONES - AGREGAR AL FINAL DEL ARCHIVO
async function initializeMentionSystem() {
    // Solo ejecutar si estamos en discussions.html
    if (!window.location.pathname.includes('discussions.html')) return;
    
    console.log('Inicializando sistema de menciones...');
    
    // 1. Suscripción a notificaciones de menciones en tiempo real
    if (typeof supabaseClient !== 'undefined' && currentUser) {
        const mentionsChannel = supabaseClient
            .channel('mention_notifications_' + currentUser.id)
            .on('postgres_changes', {
                event: 'INSERT',
                schema: 'public',
                table: 'mention_notifications',
                filter: `user_id=eq.${currentUser.id}`
            }, (payload) => {
                // Solo mostrar si NO está viendo esa discusión específica
                const shouldShow = !currentDiscussion || currentDiscussion.id !== payload.new.discussion_id;
                
                if (shouldShow) {
                    if (typeof loadNotificationCount === 'function') {
                        loadNotificationCount();
                    }
                    showRealtimeNotification(`${payload.new.mentioned_by_name} te mencionó en "${payload.new.discussion_title}"`);
                }
            })
            .subscribe();
            
        // Agregar a suscripciones para limpieza
        if (typeof realtimeSubscriptions !== 'undefined') {
            realtimeSubscriptions.push(mentionsChannel);
        }
    }
    
    // 2. Procesar menciones en contenido
    window.processMentions = async function(content, discussionId, replyId = null) {
        const mentionRegex = /@(\w+)/g;
        const mentions = [...content.matchAll(mentionRegex)];
        const mentionedUserIds = [];
        
        for (const match of mentions) {
            const username = match[1];
            const mentionedUser = projectMembers.find(member => 
                member.username && member.username.toLowerCase() === username.toLowerCase()
            );
            
            if (mentionedUser && mentionedUser.id !== currentUser.id) {
                mentionedUserIds.push(mentionedUser.id);
                
                // Crear notificación
                try {
                    await supabaseClient.from('mention_notifications').insert([{
                        user_id: mentionedUser.id,
                        user_email: mentionedUser.email || 'unknown@email.com',
                        mentioned_by_id: currentUser.id,
                        mentioned_by_name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
                        discussion_id: discussionId,
                        reply_id: replyId,
                        discussion_title: currentDiscussion?.title || 'Discusión',
                        mention_content: content.substring(0, 200) + (content.length > 200 ? '...' : ''),
                        project_id: currentProject?.id,
                        project_name: currentProject?.name || 'Proyecto'
                    }]);
                } catch (error) {
                    console.error('Error creating mention notification:', error);
                }
            }
        }
        
        return mentionedUserIds;
    };
    
    // 3. Interceptar envío de respuestas para procesar menciones
    const originalSubmitReply = window.submitReply;
    window.submitReply = async function() {
        const textarea = document.getElementById('reply-textarea');
        const content = textarea.value.trim();

        if (!content || !currentDiscussion) {
            if (originalSubmitReply) return originalSubmitReply();
            return;
        }

        try {
            // Procesar menciones
            const mentionedUserIds = await window.processMentions(content, currentDiscussion.id);

            const { data, error } = await supabaseClient
                .from('discussion_replies')
                .insert([{
                    discussion_id: currentDiscussion.id,
                    content: content,
                    created_by: currentUser.id,
                    parent_reply_id: null,
                    mentioned_users: mentionedUserIds
                }])
                .select()
                .single();

            if (error) throw error;

            showToast('Respuesta enviada correctamente');
            textarea.value = '';
            await loadReplies(currentDiscussion.id);

        } catch (error) {
            console.error('Error submitting reply:', error);
            showToast('Error al enviar la respuesta', 'error');
        }
    };
    
    // 4. Interceptar respuestas inline
    const originalSubmitInlineReply = window.submitInlineReply;
    window.submitInlineReply = async function(parentReplyId) {
        const textarea = document.getElementById(`inline-textarea-${parentReplyId}`);
        const content = textarea.value.trim();

        if (!content || !currentDiscussion) {
            if (originalSubmitInlineReply) return originalSubmitInlineReply(parentReplyId);
            return;
        }

        try {
            // Procesar menciones
            const mentionedUserIds = await window.processMentions(content, currentDiscussion.id, parentReplyId);

            const { data, error } = await supabaseClient
                .from('discussion_replies')
                .insert([{
                    discussion_id: currentDiscussion.id,
                    content: content,
                    created_by: currentUser.id,
                    parent_reply_id: parentReplyId,
                    mentioned_users: mentionedUserIds
                }])
                .select()
                .single();

            if (error) throw error;

            showToast('Respuesta enviada correctamente');
            hideInlineReplyForm(parentReplyId);
            await loadReplies(currentDiscussion.id);

        } catch (error) {
            console.error('Error submitting nested reply:', error);
            showToast('Error al enviar la respuesta', 'error');
        }
    };
    
    // 5. Mejorar sistema de menciones en textareas
    function enhanceMentions() {
        // Para textarea principal
        const mainTextarea = document.getElementById('reply-textarea');
        if (mainTextarea && !mainTextarea.dataset.mentionsEnhanced) {
            mainTextarea.dataset.mentionsEnhanced = 'true';
            setupMentionSuggestions(mainTextarea);
        }
        
        // Para textareas inline (se ejecuta cada vez que se crean)
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('reply-textarea') && 
                e.target.id.startsWith('inline-textarea-') && 
                !e.target.dataset.mentionsEnhanced) {
                e.target.dataset.mentionsEnhanced = 'true';
                setupMentionSuggestions(e.target);
            }
        });
    }
    
    function setupMentionSuggestions(textarea) {
        textarea.addEventListener('input', (e) => {
            const text = e.target.value;
            const cursorPos = e.target.selectionStart;
            const beforeCursor = text.substring(0, cursorPos);
            const atMatch = beforeCursor.match(/@(\w*)$/);

            if (atMatch && projectMembers && projectMembers.length > 0) {
                const query = atMatch[1].toLowerCase();
                const filtered = projectMembers.filter(member =>
                    member.username && member.username.toLowerCase().includes(query)
                ).slice(0, 5);

                if (filtered.length > 0) {
                    showMentionDropdown(filtered, textarea, cursorPos - atMatch[0].length, atMatch[0].length);
                } else {
                    hideMentionDropdown();
                }
            } else {
                hideMentionDropdown();
            }
        });
    }
    
    function showMentionDropdown(members, textarea, start, length) {
        hideMentionDropdown();
        
        const dropdown = document.createElement('div');
        dropdown.id = 'mention-dropdown';
        dropdown.style.cssText = `
            position: absolute;
            background: rgba(15, 20, 25, 0.95);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000;
            min-width: 200px;
            backdrop-filter: blur(20px);
        `;
        
        members.forEach((member, index) => {
            const item = document.createElement('div');
            item.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
                font-size: 12px;
                color: #e2e8f0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                transition: background 0.2s;
            `;
            item.textContent = `${member.name} (@${member.username})`;
            
            item.addEventListener('mouseenter', () => {
                item.style.background = 'rgba(74, 158, 255, 0.1)';
                item.style.color = '#4a9eff';
            });
            
            item.addEventListener('mouseleave', () => {
                item.style.background = 'transparent';
                item.style.color = '#e2e8f0';
            });
            
            item.addEventListener('click', () => {
                const before = textarea.value.substring(0, start);
                const after = textarea.value.substring(start + length);
                textarea.value = before + '@' + member.username + ' ' + after;
                textarea.focus();
                textarea.setSelectionRange(start + member.username.length + 2, start + member.username.length + 2);
                hideMentionDropdown();
            });
            
            dropdown.appendChild(item);
        });
        
        const rect = textarea.getBoundingClientRect();
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.left = rect.left + 'px';
        
        document.body.appendChild(dropdown);
    }
    
    function hideMentionDropdown() {
        const existing = document.getElementById('mention-dropdown');
        if (existing) existing.remove();
    }
    
    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#mention-dropdown') && !e.target.classList.contains('reply-textarea')) {
            hideMentionDropdown();
        }
    });
    
    // 6. Inicializar mejoras
    enhanceMentions();
    
    // 7. Reinicializar cuando se cargan nuevas respuestas
    const originalLoadReplies = window.loadReplies;
    if (originalLoadReplies) {
        window.loadReplies = async function(discussionId) {
            await originalLoadReplies(discussionId);
            setTimeout(enhanceMentions, 100); // Dar tiempo a que se rendericen las respuestas
        };
    }
    
    console.log('Sistema de menciones inicializado correctamente');
}

// Auto-inicializar cuando todo esté listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initializeMentionSystem, 1000);
    });
} else {
    setTimeout(initializeMentionSystem, 1000);
}

// También inicializar cuando se detecten las variables necesarias
const mentionSystemChecker = setInterval(() => {
    if (typeof currentUser !== 'undefined' && currentUser && 
        typeof projectMembers !== 'undefined' && projectMembers.length > 0) {
        initializeMentionSystem();
        clearInterval(mentionSystemChecker);
    }
}, 2000);

// === JAVASCRIPT SIMPLIFICADO PARA SIDEBAR CON HOVER ===
// Reemplaza las funciones del sidebar anterior con estas

// Función para inicializar el sidebar con hover
function initializeSidebar() {
    // Agregar tooltips a los links
    addTooltipsToNavLinks();
    
    // Setup hover events para mejor control si es necesario
    setupSidebarHover();
}

// Agregar tooltips a los nav links
function addTooltipsToNavLinks() {
    const navLinks = document.querySelectorAll('.nav-link');
    const tooltips = {
        'dashboard.html': 'Inicio',
        'discussions.html': 'Foros', 
        'code-editor.html': 'Editor de Código',
        'chat-ai.html': 'MindAssist IA',
        'members.html': 'Miembros',
        'voice-calls.html': 'Llamadas',
        'settings.html': 'Configuración'
    };
    
    navLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (tooltips[href]) {
            link.setAttribute('data-tooltip', tooltips[href]);
        } else {
            // Extraer texto del link si no hay tooltip definido
            const textElement = link.querySelector('.nav-link-text');
            if (textElement) {
                const text = textElement.textContent.trim();
                link.setAttribute('data-tooltip', text);
            }
        }
    });
}

// Setup eventos de hover del sidebar
function setupSidebarHover() {
    const sidebar = document.getElementById('sidebar');
    
    if (!sidebar) return;
    
    // Opcional: hacer layout de Monaco cuando se expande/contrae
    sidebar.addEventListener('mouseenter', () => {
        // Delay para que la animación termine
        setTimeout(() => {
            if (monacoEditor) {
                monacoEditor.layout();
            }
        }, 300);
    });
    
    sidebar.addEventListener('mouseleave', () => {
        // Delay para que la animación termine
        setTimeout(() => {
            if (monacoEditor) {
                monacoEditor.layout();
            }
        }, 300);
    });
}

// Función para el menú móvil (mantener la funcionalidad existente)
function toggleSidebarMobile() {
    const sidebar = document.getElementById('sidebar');
    
    if (window.innerWidth <= 768) {
        sidebar.classList.toggle('show');
    }
}

// Setup del botón de menú móvil
function setupMenuToggle() {
    const menuToggle = document.getElementById('menu-toggle');
    if (menuToggle) {
        menuToggle.addEventListener('click', toggleSidebarMobile);
    }
}

// Detectar cambios de tamaño de ventana
function handleResize() {
    const sidebar = document.getElementById('sidebar');
    
    if (window.innerWidth <= 768) {
        // En móvil, remover la clase show si la ventana se hace más grande
        // El hover automático no funciona bien en móvil
    } else {
        // En desktop, asegurar que no tenga la clase show
        sidebar.classList.remove('show');
    }
}

// Event listeners
window.addEventListener('resize', handleResize);

// Cerrar sidebar en móvil al hacer clic fuera
document.addEventListener('click', function(event) {
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        
        if (sidebar && menuToggle && 
            !sidebar.contains(event.target) && 
            !menuToggle.contains(event.target) &&
            sidebar.classList.contains('show')) {
            sidebar.classList.remove('show');
        }
    }
});

// Función para toggle del user menu
function toggleUserMenu() {
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
}

// Función para actualizar el header con avatar del usuario
async function updateUserHeader() {
    if (!currentUser) {
        console.log('currentUser no disponible aún');
        return;
    }
    
    try {
        const { data: profile } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();

        const userName = profile?.full_name || 
                        currentUser.user_metadata?.full_name || 
                        currentUser.user_metadata?.name || 
                        currentUser.email.split('@')[0];
        
        // Actualizar nombre
        const headerUserName = document.getElementById('headerUserName');
        if (headerUserName) {
            headerUserName.textContent = userName;
        }

        // Actualizar avatar
        const avatarImg = document.getElementById('headerAvatarImg');
        if (avatarImg) {
            const initials = userName.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase();
            
            if (profile?.avatar_url && profile.avatar_url.trim() !== '') {
                avatarImg.src = profile.avatar_url;
                avatarImg.style.display = 'block';
                
                avatarImg.onload = () => {
                    console.log('Imagen de perfil cargada correctamente');
                };
                
                avatarImg.onerror = () => {
                    console.log('Error cargando imagen, usando iniciales');
                    setInitialsAvatar(avatarImg, userName, initials);
                };
            } else {
                console.log('No hay imagen de perfil, usando iniciales:', initials);
                setInitialsAvatar(avatarImg, userName, initials);
            }
        }

    } catch (error) {
        console.error('Error updating user header:', error);
        
        const userName = currentUser.email.split('@')[0];
        const headerUserName = document.getElementById('headerUserName');
        const avatarImg = document.getElementById('headerAvatarImg');
        
        if (headerUserName) headerUserName.textContent = userName;
        if (avatarImg) {
            const initials = userName.substring(0, 2).toUpperCase();
            setInitialsAvatar(avatarImg, userName, initials);
        }
    }
}

function setInitialsAvatar(avatarElement, userName, initials) {
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=4a9eff&color=ffffff&size=128&rounded=true&bold=true`;
    
    avatarElement.src = avatarUrl;
    avatarElement.style.display = 'block';
    
    avatarElement.onload = () => {
        console.log('Avatar con iniciales cargado:', initials);
    };
    
    avatarElement.onerror = () => {
        console.log('UI Avatars falló, creando avatar CSS');
        createCSSAvatar(avatarElement, initials);
    };
}

function createCSSAvatar(avatarElement, initials) {
    avatarElement.style.display = 'none';
    
    let cssAvatar = avatarElement.parentNode.querySelector('.css-avatar');
    
    if (!cssAvatar) {
        cssAvatar = document.createElement('div');
        cssAvatar.className = 'css-avatar';
        avatarElement.parentNode.insertBefore(cssAvatar, avatarElement);
    }
    
    cssAvatar.textContent = initials;
    cssAvatar.style.cssText = `
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4a9eff, #00d4ff);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 11px;
        border: 2px solid #4a9eff;
        flex-shrink: 0;
        font-family: inherit;
    `;
    
    console.log('Avatar CSS creado con iniciales:', initials);
}

// Cerrar dropdown del user menu al hacer clic fuera
document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    const userDropdown = document.getElementById('userDropdown');
    
    if (userDropdown && userMenu && !userMenu.contains(event.target)) {
        userDropdown.classList.remove('show');
    }
});


// Agregar función de compartir
function shareDiscussion(discussionId) {
    const url = `${window.location.origin}/discussions.html?project=${currentProject.id}&discussion=${discussionId}`;
    
    if (navigator.share) {
        navigator.share({
            title: currentDiscussion.title,
            text: 'Mira esta discusión interesante',
            url: url
        }).catch(err => console.log('Error al compartir:', err));
    } else {
        // Fallback: copiar al portapapeles
        navigator.clipboard.writeText(url).then(() => {
            showToast('Enlace copiado al portapapeles');
        }).catch(err => {
            showToast('Error al copiar enlace', 'error');
        });
    }
}
// LLAMAR ESTAS FUNCIONES EN TU checkAuthenticationAndLoadData() AL FINAL:

        window.subscribeToRealtimeChanges = subscribeToRealtimeChanges;
        window.subscribeToReplies = subscribeToReplies;
        window.cleanupRealtimeSubscriptions = cleanupRealtimeSubscriptions;
        window.toggleTheme = toggleTheme;
        window.deleteDiscussion = deleteDiscussion;
        window.showDeleteModal = showDeleteModal;
        window.closeDeleteModal = closeDeleteModal;
        window.confirmDeleteDiscussion = confirmDeleteDiscussion;
        window.deleteDiscussionFromDetail = deleteDiscussionFromDetail;
        window.toggleLanguageDropdown = toggleLanguageDropdown;
        window.changeLanguage = changeLanguage;
        window.deleteDiscussionFromDetail = deleteDiscussionFromDetail;
        window.toggleReaction = toggleReaction;
        window.toggleDiscussionStatus = toggleDiscussionStatus;
        window.selectMention = selectMention;
        window.expandNestedReplies = expandNestedReplies;
        window.collapseNestedReplies = collapseNestedReplies;
        window.showInlineReplyForm = showInlineReplyForm;
        window.hideInlineReplyForm = hideInlineReplyForm;
        window.submitInlineReply = submitInlineReply;
        window.showDiscussionsList = showDiscussionsList;
        window.openDiscussion = openDiscussion;
        window.toggleDiscussionLike = toggleDiscussionLike;
        window.toggleReplyLike = toggleReplyLike;
        window.submitReply = submitReply;
        window.focusReplyTextarea = focusReplyTextarea;
        window.analyzeDiscussion = analyzeDiscussion;
        window.showNewDiscussionModal = showNewDiscussionModal;
        window.closeNewDiscussionModal = closeNewDiscussionModal;
        window.createNewDiscussion = createNewDiscussion;
        window.updateUserHeader = updateUserHeader;
        window.toggleUserMenu = toggleUserMenu;



    </script>
    <script src="js/mi-chat.js"></script>
</body>

</html>