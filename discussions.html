<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foros - OpenMind AI</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/noti.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0f1419 100%);
            color: white;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(74, 158, 255, 0.2);
            padding: 20px;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            background: linear-gradient(45deg, #4a9eff, #00d4ff);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #8892a6;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(74, 158, 255, 0.1);
            color: #4a9eff;
        }

        .nav-link i {
            margin-right: 12px;
            width: 16px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
            padding: 0;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            position: relative;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: #8892a6;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: none;
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #4a9eff;
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .project-name-header {
            font-size: 14px;
            color: #4a9eff;
            font-weight: 500;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .welcome-text {
            color: #8892a6;
            font-size: 13px;
        }

        .user-name {
            color: #4a9eff;
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Contenedor principal con transiciones */
        .content-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 30px;
            overflow-y: auto;
        }

        .view.active {
            opacity: 1;
            transform: translateX(0);
        }

        .view.sliding-out {
            opacity: 0;
            transform: translateX(-100%);
        }

        /* Vista de lista de discusiones */
        .discussions-list-view {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .discussions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .discussions-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(45deg, #4a9eff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .new-discussion-btn {
            background: linear-gradient(45deg, #4a9eff, #0066cc);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .new-discussion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(74, 158, 255, 0.4);
        }

        .discussions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Cambiar de 400px a 280px */
    gap: 16px; /* Reducir de 20px a 16px */
    max-width: 1000px; /* Reducir de 1200px a 1000px */
}

.discussion-card {
    aspect-ratio: 1.2; /* Hacer las cards más cuadradas */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    padding: 20px; /* Reducir de 24px a 20px */
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

/* Badge de estado */


.discussion-status-badge.open {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.4);
}

.discussion-status-badge.closed {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.4);
}

/* Información adicional */
.discussion-card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.discussion-card-title {
    font-size: 16px; /* Reducir de 18px */
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 10px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    
    overflow: hidden;
}

/* Botón de eliminar en las cards - POSICIÓN CORREGIDA */
.discussion-delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;  /* Cambiado de left a right para moverlo a la esquina superior derecha */
    background: rgba(239, 68, 68, 0.8);
    border: 1px solid rgba(239, 68, 68, 0.9);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 10;
}

.discussion-card:hover .discussion-delete-btn {
    opacity: 1;
}

.discussion-delete-btn:hover {
    background: rgba(239, 68, 68, 1);
    transform: scale(1.1);
}

/* Asegurar que no interfiera con el badge de estado */
.discussion-status-badge {
    position: absolute;
    top: 4px;
    right: 4px; /* Aumentado para dar espacio al botón de eliminar */
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Alternativa: Si prefieres el botón en la esquina inferior derecha */

/* Evitar que el click del botón trigger el click de la card */
.discussion-delete-btn,
.discussion-delete-btn-alternative {
    pointer-events: auto;
}
.discussion-card-preview {
    color: #8892a6;
    font-size: 13px; /* Reducir de 14px */
    line-height: 1.4;
    display: -webkit-box;
    -webkit-box-orient: vertical;

    overflow: hidden;
    flex: 1;
    margin-bottom: 15px;
}

.discussion-card-footer {
    margin-top: auto;
}

.discussion-card-meta {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    font-size: 11px; /* Reducir de 12px */
    gap: 10px;
}

.discussion-card-author {
    color: #4a9eff;
    font-weight: 500;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.discussion-delete-action {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #8892a6;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.discussion-card-stats {
    display: flex;
    gap: 12px;
    color: #6366f1;
    flex-shrink: 0;
}
        .discussion-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .discussion-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4a9eff, #00d4ff);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .discussion-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .discussion-card:hover::before {
            opacity: 1;
        }

        .discussion-card-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .discussion-card-preview {
            color: #8892a6;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            
            overflow: hidden;
        }

        .discussion-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .discussion-card-author {
            color: #4a9eff;
            font-weight: 500;
        }

        .discussion-card-stats {
            display: flex;
            gap: 15px;
            color: #6366f1;
        }

        .discussion-card-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8892a6;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
            display: block;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 12px;
            color: #ffffff;
        }

        /* Vista de detalle de discusión */
        .discussion-detail-view {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            height: 100%;
        }

        .discussion-main {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #4a9eff;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            align-self: flex-start;
        }

        .back-button:hover {
            background: rgba(74, 158, 255, 0.1);
            border-color: #4a9eff;
            transform: translateX(-2px);
        }

        .discussion-post {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 32px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
        }

        .discussion-post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .discussion-post-info {
            flex: 1;
        }

        .discussion-post-title {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .discussion-post-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
            color: #8892a6;
        }

        .discussion-post-author {
            color: #4a9eff;
            font-weight: 600;
        }

        .discussion-post-content {
            font-size: 16px;
            line-height: 1.6;
            color: #e2e8f0;
            margin-bottom: 24px;
        }

        .discussion-post-actions {
            display: flex;
            gap: 16px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #8892a6;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: rgba(74, 158, 255, 0.1);
            border-color: #4a9eff;
            color: #4a9eff;
        }

        .action-btn.liked {
            background: rgba(74, 158, 255, 0.2);
            border-color: #4a9eff;
            color: #4a9eff;
        }

        /* Sistema de respuestas */
        .replies-section {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .replies-header {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reply-form {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .reply-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
        }

        .reply-textarea:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
        }

        .reply-submit {
            background: linear-gradient(45deg, #4a9eff, #0066cc);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .reply-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
        }

        .replies-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .reply-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .reply-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .reply-author {
            color: #4a9eff;
            font-weight: 600;
            font-size: 14px;
        }

        .reply-date {
            color: #8892a6;
            font-size: 12px;
        }

        .reply-content {
            color: #e2e8f0;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .reply-actions {
            display: flex;
            gap: 12px;
        }

        .reply-action-btn {
            background: none;
            border: none;
            color: #8892a6;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .reply-action-btn:hover {
            color: #4a9eff;
            background: rgba(74, 158, 255, 0.1);
        }

        /* Panel lateral de IA */
        .ai-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            height: fit-content;
            position: sticky;
            top: 30px;
        }

        .ai-panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .ai-panel-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(45deg, #4a9eff, #00d4ff);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .ai-panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            text-align: center;
        }

        .ai-analyze-btn {
            width: 100%;
            background: linear-gradient(45deg, #4a9eff, #0066cc);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .ai-analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 158, 255, 0.3);
        }

        .ai-suggestions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ai-suggestion-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-suggestion-item:hover {
            background: rgba(74, 158, 255, 0.1);
            border-color: #4a9eff;
        }

        .ai-suggestion-title {
            font-size: 12px;
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 4px;
        }

        .ai-suggestion-text {
            font-size: 11px;
            color: #8892a6;
            line-height: 1.4;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal h3 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #ffffff;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .cancel-btn,
        .create-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .cancel-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .create-btn {
            background: linear-gradient(45deg, #4a9eff, #0066cc);
            color: white;
        }

        .create-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(74, 158, 255, 0.3);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.9);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .discussion-detail-view {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .ai-panel {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: block;
            }

            .discussions-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .discussion-card {
                padding: 20px;
            }

            .view {
                padding: 20px;
            }

            .discussion-post {
                padding: 24px;
            }

            .discussion-post-title {
                font-size: 24px;
            }

            .modal {
                width: 95%;
                padding: 20px;
            }
        }
        /* Estilos para respuestas anidadas */
.reply-thread {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.reply-item.nested {
    margin-left: 40px;
    border-left: 2px solid rgba(74, 158, 255, 0.3);
    padding-left: 20px;
    position: relative;
}

.reply-item.nested::before {
    content: '';
    position: absolute;
    left: -2px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(180deg, rgba(74, 158, 255, 0.3) 0%, transparent 100%);
}

.reply-form-inline {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    padding: 16px;
    margin-top: 12px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    display: none;
}

.reply-form-inline.show {
    display: block;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.reply-form-inline .reply-textarea {
    min-height: 60px;
    margin-bottom: 8px;
}

.reply-form-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.reply-form-btn {
    background: linear-gradient(45deg, #4a9eff, #0066cc);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.reply-form-btn.cancel {
    background: rgba(255, 255, 255, 0.1);
}

.reply-form-btn:hover {
    transform: translateY(-1px);
}

.nested-indicator {
    font-size: 11px;
    color: #6366f1;
    margin-bottom: 8px;
    font-style: italic;
}

.reply-action-btn.active {
    color: #4a9eff;
    background: rgba(74, 158, 255, 0.1);
}

/* Estilos para respuestas anidadas - AGREGAR ESTO */
.reply-thread {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.reply-item.nested {
    margin-left: 40px;
    border-left: 2px solid rgba(74, 158, 255, 0.3);
    padding-left: 20px;
    position: relative;
}

.reply-item.nested::before {
    content: '';
    position: absolute;
    left: -2px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(180deg, rgba(74, 158, 255, 0.3) 0%, transparent 100%);
}

.reply-form-inline {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    padding: 16px;
    margin-top: 12px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    display: none;
}

.reply-form-inline.show {
    display: block;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.reply-form-inline .reply-textarea {
    min-height: 60px;
    margin-bottom: 8px;
}

.reply-form-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.reply-form-btn {
    background: linear-gradient(45deg, #4a9eff, #0066cc);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.reply-form-btn.cancel {
    background: rgba(255, 255, 255, 0.1);
}

.reply-form-btn:hover {
    transform: translateY(-1px);
}

.nested-indicator {
    font-size: 11px;
    color: #6366f1;
    margin-bottom: 8px;
    font-style: italic;
}

.reply-action-btn.active {
    color: #4a9eff;
    background: rgba(74, 158, 255, 0.1);
}

/* ESTOS SON LOS ESTILOS IMPORTANTES PARA LOS BOTONES DE COLAPSO */
.show-more-nested-btn,
.show-less-nested-btn {
    background: rgba(74, 158, 255, 0.1);
    border: 1px solid rgba(74, 158, 255, 0.3);
    color: #4a9eff;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    margin: 12px 0 0 40px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    max-width: fit-content;
}

.show-more-nested-btn:hover,
.show-less-nested-btn:hover {
    background: rgba(74, 158, 255, 0.2);
    border-color: #4a9eff;
    transform: translateY(-1px);
}

.nested-replies-container {
    position: relative;
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.discussion-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.discussion-status.open {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.3);
}

.discussion-status.closed {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.discussion-status i {
    font-size: 8px;
}

/* Reacciones rápidas */
.quick-reactions {
    display: flex;
    gap: 8px;
    margin: 12px 0;
    flex-wrap: wrap;
}

.reaction-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 6px 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: #8892a6;
}

.reaction-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: scale(1.05);
}

.reaction-btn.active {
    background: rgba(74, 158, 255, 0.2);
    border-color: #4a9eff;
    color: #4a9eff;
}

.reaction-btn .emoji {
    font-size: 14px;
}

.reaction-btn .count {
    font-weight: 600;
    min-width: 12px;
    text-align: center;
}

/* Indicador de escribiendo */
.typing-indicator {
    padding: 8px 16px;
    margin: 8px 0;
    background: rgba(74, 158, 255, 0.1);
    border-radius: 20px;
    color: #4a9eff;
    font-size: 12px;
    font-style: italic;
    display: none;
    align-items: center;
    gap: 8px;
}

.typing-indicator.show {
    display: flex;
}

.typing-dots {
    display: flex;
    gap: 2px;
}

.typing-dot {
    width: 4px;
    height: 4px;
    background: #4a9eff;
    border-radius: 50%;
    animation: typingBounce 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typingBounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

/* Vista previa en hover */
.reply-context-preview {
    position: absolute;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 8px;
    padding: 12px;
    max-width: 300px;
    font-size: 12px;
    color: #e2e8f0;
    z-index: 1000;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    pointer-events: none;
}

.reply-context-preview.show {
    opacity: 1;
    transform: translateY(0);
}

.reply-context-preview .preview-author {
    color: #4a9eff;
    font-weight: 600;
    margin-bottom: 4px;
}

/* Botones de admin para cerrar/abrir foro */
.discussion-admin-controls {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.admin-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #8892a6;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.admin-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.admin-btn.close-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    color: #ef4444;
}

.admin-btn.open-btn:hover {
    background: rgba(34, 197, 94, 0.1);
    border-color: #22c55e;
    color: #22c55e;
}

/* Menciones */
.mention {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
    padding: 1px 4px;
    border-radius: 3px;
    font-weight: 600;
}

.mention-suggestion {
    position: absolute;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    min-width: 150px;
}

.mention-item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 12px;
    color: #e2e8f0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.mention-item:hover,
.mention-item.selected {
    background: rgba(74, 158, 255, 0.1);
    color: #4a9eff;
}

/* Respuestas deshabilitadas cuando está cerrado */
.discussion-closed .reply-form,
.discussion-closed .reply-form-inline {
    opacity: 0.5;
    pointer-events: none;
}

.discussion-closed .reply-action-btn {
    opacity: 0.5;
    pointer-events: none;
}

.closed-message {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    margin: 16px 0;
    font-size: 14px;
}
/* Header controls */
.header-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.control-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #8892a6;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.control-btn:hover {
    background: rgba(74, 158, 255, 0.1);
    border-color: #4a9eff;
    color: #4a9eff;
}

/* Language Selector */
.language-selector {
    position: relative;
    z-index: 200;
}

.language-dropdown {
    position: fixed;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.2);
    border-radius: 8px;
    padding: 8px 0;
    min-width: 180px;
    display: none;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 99999;
}

.language-dropdown.show {
    display: block;
}

.language-option {
    padding: 8px 16px;
    cursor: pointer;
    font-size: 12px;
    color: #8892a6;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.language-option:hover {
    background: rgba(74, 158, 255, 0.1);
    color: #4a9eff;
}

.language-option.active {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
}

/* TEMA CLARO - Light theme */
[data-theme="light"] body {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
    color: #1e293b;
}

[data-theme="light"] .sidebar {
    background: rgba(248, 250, 252, 0.95);
    border-right: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .logo {
    color: #3b82f6;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .nav-link {
    color: #64748b;
}

[data-theme="light"] .nav-link:hover,
[data-theme="light"] .nav-link.active {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

[data-theme="light"] .header {
    background: rgba(248, 250, 252, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .page-title {
    color: #1e293b;
}

[data-theme="light"] .project-name-header {
    color: #3b82f6;
}

[data-theme="light"] .welcome-text {
    color: #64748b;
}

[data-theme="light"] .user-name {
    color: #3b82f6;
}

[data-theme="light"] .logout-btn {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #64748b;
}

[data-theme="light"] .logout-btn:hover {
    background: rgba(255, 0, 0, 0.1);
    border-color: #ef4444;
    color: #ef4444;
}

[data-theme="light"] .discussions-title {
    background: linear-gradient(45deg, #3b82f6, #1d4ed8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

[data-theme="light"] .new-discussion-btn {
    background: linear-gradient(45deg, #3b82f6, #1d4ed8);
}

[data-theme="light"] .discussion-card {
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .discussion-card:hover {
    background: rgba(255, 255, 255, 0.95);
}

[data-theme="light"] .discussion-card-title {
    color: #1e293b;
}

[data-theme="light"] .discussion-card-preview {
    color: #64748b;
}

[data-theme="light"] .discussion-card-author {
    color: #3b82f6;
}

[data-theme="light"] .discussion-card-stats {
    color: #3b82f6;
}

[data-theme="light"] .empty-state {
    color: #64748b;
}

[data-theme="light"] .empty-state h3 {
    color: #1e293b;
}

/* Discusión detalle - tema claro */
[data-theme="light"] .discussion-post {
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .discussion-post-title {
    color: #1e293b;
}

[data-theme="light"] .discussion-post-author {
    color: #3b82f6;
}

[data-theme="light"] .discussion-post-meta {
    color: #64748b;
}

[data-theme="light"] .discussion-post-content {
    color: #374151;
}

[data-theme="light"] .action-btn {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #64748b;
}

[data-theme="light"] .action-btn:hover {
    background: rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
    color: #3b82f6;
}

[data-theme="light"] .action-btn.liked {
    background: rgba(59, 130, 246, 0.2);
    border-color: #3b82f6;
    color: #3b82f6;
}

/* Respuestas - tema claro */
[data-theme="light"] .replies-section {
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

[data-theme="light"] .replies-header {
    color: #1e293b;
}

[data-theme="light"] .reply-form {
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .reply-textarea {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #1e293b;
}

[data-theme="light"] .reply-textarea:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

[data-theme="light"] .reply-submit {
    background: linear-gradient(45deg, #3b82f6, #1d4ed8);
}

[data-theme="light"] .reply-item {
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

[data-theme="light"] .reply-item:hover {
    background: rgba(255, 255, 255, 0.8);
}

[data-theme="light"] .reply-author {
    color: #3b82f6;
}

[data-theme="light"] .reply-date {
    color: #64748b;
}

[data-theme="light"] .reply-content {
    color: #374151;
}

[data-theme="light"] .reply-action-btn {
    color: #64748b;
}

[data-theme="light"] .reply-action-btn:hover {
    color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
}

/* Panel IA - tema claro */
[data-theme="light"] .ai-panel {
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .ai-panel-title {
    color: #1e293b;
}

[data-theme="light"] .ai-analyze-btn {
    background: linear-gradient(45deg, #3b82f6, #1d4ed8);
}

[data-theme="light"] .ai-suggestion-item {
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

[data-theme="light"] .ai-suggestion-item:hover {
    background: rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
}

[data-theme="light"] .ai-suggestion-title {
    color: #3b82f6;
}

[data-theme="light"] .ai-suggestion-text {
    color: #64748b;
}

/* Modal - tema claro */
[data-theme="light"] .modal-overlay {
    background: rgba(0, 0, 0, 0.5);
}

[data-theme="light"] .modal {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .modal h3 {
    color: #1e293b;
}

[data-theme="light"] .form-group label {
    color: #1e293b;
}

[data-theme="light"] .form-group input[type="text"],
[data-theme="light"] .form-group textarea {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #1e293b;
}

[data-theme="light"] .form-group input[type="text"]:focus,
[data-theme="light"] .form-group textarea:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

[data-theme="light"] .cancel-btn {
    background: rgba(0, 0, 0, 0.1);
    color: #64748b;
}

[data-theme="light"] .cancel-btn:hover {
    background: rgba(0, 0, 0, 0.15);
}

[data-theme="light"] .create-btn {
    background: linear-gradient(45deg, #3b82f6, #1d4ed8);
}

/* Header controls - tema claro */
[data-theme="light"] .control-btn {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #64748b;
}

[data-theme="light"] .control-btn:hover {
    background: rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
    color: #3b82f6;
}

[data-theme="light"] .language-dropdown {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .language-option {
    color: #64748b;
}

[data-theme="light"] .language-option:hover {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

[data-theme="light"] .language-option.active {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

[data-theme="light"] .menu-toggle {
    color: #64748b;
}

[data-theme="light"] .menu-toggle:hover {
    background: rgba(0, 0, 0, 0.05);
    color: #3b82f6;
}

[data-theme="light"] .back-button {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #3b82f6;
}

[data-theme="light"] .back-button:hover {
    background: rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
}

/* Respuestas anidadas - tema claro */
[data-theme="light"] .reply-item.nested {
    border-left: 2px solid rgba(59, 130, 246, 0.3);
}

[data-theme="light"] .reply-form-inline {
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

[data-theme="light"] .reply-form-btn {
    background: linear-gradient(45deg, #3b82f6, #1d4ed8);
}

[data-theme="light"] .reply-form-btn.cancel {
    background: rgba(0, 0, 0, 0.1);
    color: #64748b;
}

[data-theme="light"] .show-more-nested-btn,
[data-theme="light"] .show-less-nested-btn {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: #3b82f6;
}

[data-theme="light"] .show-more-nested-btn:hover,
[data-theme="light"] .show-less-nested-btn:hover {
    background: rgba(59, 130, 246, 0.2);
    border-color: #3b82f6;
}

[data-theme="light"] .nested-indicator {
    color: #3b82f6;
}

/* Funcionalidades avanzadas - tema claro */
[data-theme="light"] .discussion-status.open {
    background: rgba(34, 197, 94, 0.1);
    color: #16a34a;
    border: 1px solid rgba(34, 197, 94, 0.3);
}

[data-theme="light"] .discussion-status.closed {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

[data-theme="light"] .reaction-btn {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #64748b;
}

[data-theme="light"] .reaction-btn:hover {
    background: rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .reaction-btn.active {
    background: rgba(59, 130, 246, 0.2);
    border-color: #3b82f6;
    color: #3b82f6;
}

[data-theme="light"] .mention {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

[data-theme="light"] .closed-message {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #dc2626;
}

/* Responsive */
@media (max-width: 768px) {
    .header-controls {
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .control-btn span {
        display: none;
    }
}

/* Fondo para tema claro */
[data-theme="light"] .main-content::before {
    content: '';
    position: fixed;
    top: 0;
    left: 260px;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
    z-index: -1;
}

[data-theme="light"] .main-content.expanded::before {
    left: 0;
}

[data-theme="light"] .discussion-status-badge.open {
    background: rgba(34, 197, 94, 0.15);
    color: #16a34a;
    border: 1px solid rgba(34, 197, 94, 0.3);
}

[data-theme="light"] .discussion-status-badge.closed {
    background: rgba(239, 68, 68, 0.15);
    color: #dc2626;
    border: 1px solid rgba(239, 68, 68, 0.3);
}


/* Botón de eliminar en las cards */
.discussion-delete-btn {
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(239, 68, 68, 0.8);
    border: 1px solid rgba(239, 68, 68, 0.9);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 10;
}

.discussion-card:hover .discussion-delete-btn {
    opacity: 1;
}

.discussion-delete-btn:hover {
    background: rgba(239, 68, 68, 1);
    transform: scale(1.1);
}

/* Evitar que el click del botón trigger el click de la card */
.discussion-delete-btn {
    pointer-events: auto;
}


/* Modal de confirmación de eliminación */
.delete-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.delete-modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.delete-modal {
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 16px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    transform: scale(0.9) translateY(20px);
    transition: all 0.3s ease;
}

.delete-modal-overlay.show .delete-modal {
    transform: scale(1) translateY(0);
}

.delete-modal-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.delete-modal-icon {
    width: 40px;
    height: 40px;
    background: rgba(239, 68, 68, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ef4444;
    font-size: 18px;
}

.delete-modal h3 {
    color: #ef4444;
    font-size: 20px;
    font-weight: 600;
    margin: 0;
}

.delete-modal-content {
    margin-bottom: 25px;
}

.delete-modal-warning {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
}

.delete-modal-warning h4 {
    color: #ef4444;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
}

.delete-modal-warning ul {
    color: #e2e8f0;
    font-size: 13px;
    margin: 0;
    padding-left: 20px;
}

.delete-modal-warning li {
    margin-bottom: 4px;
}

.delete-modal-text {
    color: #e2e8f0;
    font-size: 14px;
    line-height: 1.5;
}

.delete-modal-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

.delete-cancel-btn,
.delete-confirm-btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
}

.delete-cancel-btn {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

.delete-cancel-btn:hover {
    background: rgba(255, 255, 255, 0.15);
}

.delete-confirm-btn {
    background: linear-gradient(45deg, #ef4444, #dc2626);
    color: white;
}

.delete-confirm-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
}

/* Tema claro para el modal de eliminación */
[data-theme="light"] .delete-modal {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

[data-theme="light"] .delete-modal h3 {
    color: #dc2626;
}

[data-theme="light"] .delete-modal-warning {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

[data-theme="light"] .delete-modal-warning h4 {
    color: #dc2626;
}

[data-theme="light"] .delete-modal-warning ul {
    color: #374151;
}

[data-theme="light"] .delete-modal-text {
    color: #374151;
}

[data-theme="light"] .delete-cancel-btn {
    background: rgba(0, 0, 0, 0.1);
    color: #64748b;
}

[data-theme="light"] .delete-cancel-btn:hover {
    background: rgba(0, 0, 0, 0.15);
}
/* CSS para el input de confirmación - AGREGAR AL FINAL DEL CSS */

/* Tema oscuro (por defecto) */
#delete-confirmation-input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 8px;
    color: #ffffff !important;
    font-size: 14px;
    font-family: inherit;
    margin-top: 12px;
    transition: all 0.3s ease;
}

#delete-confirmation-input:focus {
    outline: none;
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    background: rgba(255, 255, 255, 0.15) !important;
}

#delete-confirmation-input::placeholder {
    color: rgba(255, 255, 255, 0.5) !important;
    font-style: italic;
}

/* Tema claro */
[data-theme="light"] #delete-confirmation-input {
    background: rgba(0, 0, 0, 0.05) !important;
    border: 1px solid rgba(0, 0, 0, 0.2) !important;
    color: #1e293b !important;
}

[data-theme="light"] #delete-confirmation-input:focus {
    border-color: #dc2626 !important;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    background: rgba(0, 0, 0, 0.08) !important;
}

[data-theme="light"] #delete-confirmation-input::placeholder {
    color: rgba(0, 0, 0, 0.5) !important;
}
/* Estilos para análisis de IA */
.ai-analysis-results {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-height: 500px;
    overflow-y: auto;
    padding-right: 8px;
}

.analysis-section {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    padding: 16px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.analysis-title {
    font-size: 14px;
    font-weight: 600;
    color: #4a9eff;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.analysis-content {
    font-size: 13px;
    color: #e2e8f0;
    line-height: 1.4;
    margin: 0;
}

.topics-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.topic-tag {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.metrics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.metric-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.metric-label {
    font-size: 11px;
    color: #8892a6;
    font-weight: 500;
}

.metric-value {
    font-size: 12px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 6px;
    text-align: center;
}

.sentiment-positivo {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.sentiment-negativo {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.sentiment-neutral {
    background: rgba(156, 163, 175, 0.2);
    color: #9ca3af;
}

.engagement-alto {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.engagement-medio {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
}

.engagement-bajo {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.key-points-list {
    margin: 0;
    padding-left: 16px;
    font-size: 12px;
    color: #e2e8f0;
    line-height: 1.4;
}

.key-points-list li {
    margin-bottom: 4px;
}

.suggestions-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.suggestion-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    padding: 12px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.suggestion-title {
    font-size: 12px;
    font-weight: 600;
    color: #4a9eff;
    margin-bottom: 4px;
}

.suggestion-desc {
    font-size: 11px;
    color: #8892a6;
    line-height: 1.3;
}

.moderator-section {
    border: 1px solid rgba(251, 191, 36, 0.3);
    background: rgba(251, 191, 36, 0.05);
}

.moderator-section .analysis-title {
    color: #fbbf24;
}
/* Análisis de IA - tema claro */
[data-theme="light"] .ai-analysis-results {
    background: rgba(0, 0, 0, 0.02);
}

[data-theme="light"] .analysis-section {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .analysis-title {
    color: #3b82f6;
}

[data-theme="light"] .analysis-content {
    color: #374151;
}

[data-theme="light"] .topic-tag {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

[data-theme="light"] .metric-label {
    color: #64748b;
}

[data-theme="light"] .key-points-list {
    color: #374151;
}

[data-theme="light"] .suggestion-card {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .suggestion-title {
    color: #3b82f6;
}

[data-theme="light"] .suggestion-desc {
    color: #64748b;
}

[data-theme="light"] .moderator-section {
    border: 1px solid rgba(251, 191, 36, 0.4);
    background: rgba(251, 191, 36, 0.1);
}

[data-theme="light"] .moderator-section .analysis-title {
    color: #d97706;
}

.ai-intro-section {
    text-align: center;
    padding: 20px;
}

.ai-intro-title {
    color: #4a9eff;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
}

.ai-features-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.ai-features-list li {
    color: #8892a6;
    font-size: 12px;
    margin-bottom: 6px;
    padding: 4px 0;
}

/* Tema claro */
[data-theme="light"] .ai-intro-title {
    color: #3b82f6;
}

[data-theme="light"] .ai-features-list li {
    color: #64748b;
}

/* Efecto de análisis activo en el panel de IA */
.ai-panel.analyzing {
    position: relative;
    overflow: hidden;
    animation: aiPulse 2s ease-in-out infinite;
    box-shadow: 
        0 0 20px rgba(74, 158, 255, 0.3),
        0 0 40px rgba(74, 158, 255, 0.2),
        0 0 60px rgba(74, 158, 255, 0.1);
    border: 1px solid rgba(74, 158, 255, 0.5);
}

.ai-panel.analyzing::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent,
        rgba(74, 158, 255, 0.1),
        transparent,
        rgba(0, 212, 255, 0.1),
        transparent
    );
    animation: aiSweep 3s linear infinite;
    z-index: 1;
}

.ai-panel.analyzing::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(74, 158, 255, 0.05) 50%,
        transparent 100%
    );
    animation: aiShimmer 2s ease-in-out infinite alternate;
    z-index: 2;
}

.ai-panel.analyzing .ai-panel-header,
.ai-panel.analyzing .ai-analyze-btn,
.ai-panel.analyzing .ai-suggestions {
    position: relative;
    z-index: 3;
}

@keyframes aiPulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 
            0 0 20px rgba(74, 158, 255, 0.3),
            0 0 40px rgba(74, 158, 255, 0.2),
            0 0 60px rgba(74, 158, 255, 0.1);
    }
    50% {
        transform: scale(1.02);
        box-shadow: 
            0 0 30px rgba(74, 158, 255, 0.4),
            0 0 60px rgba(74, 158, 255, 0.3),
            0 0 90px rgba(74, 158, 255, 0.2);
    }
}

@keyframes aiSweep {
    0% {
        transform: translateX(-100%) translateY(-100%) rotate(45deg);
    }
    100% {
        transform: translateX(100%) translateY(100%) rotate(45deg);
    }
}

@keyframes aiShimmer {
    0% {
        opacity: 0.3;
    }
    100% {
        opacity: 0.7;
    }
}

/* Tema claro */
[data-theme="light"] .ai-panel.analyzing {
    box-shadow: 
        0 0 20px rgba(59, 130, 246, 0.3),
        0 0 40px rgba(59, 130, 246, 0.2),
        0 0 60px rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.5);
}

[data-theme="light"] .ai-panel.analyzing::before {
    background: linear-gradient(
        45deg,
        transparent,
        rgba(59, 130, 246, 0.1),
        transparent,
        rgba(29, 78, 216, 0.1),
        transparent
    );
}

[data-theme="light"] .ai-panel.analyzing::after {
    background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(59, 130, 246, 0.05) 50%,
        transparent 100%
    );
}

@media (max-width: 768px) {
    .ai-panel.analyzing {
        animation: aiPulseMobile 2s ease-in-out infinite;
    }
    
    @keyframes aiPulseMobile {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.01);
        }
    }
}

/* Efecto de análisis elegante - no nave alien */
.ai-panel.analyzing {
    position: relative;
    animation: aiGentlePulse 2s ease-in-out infinite;
    box-shadow: 
        0 0 15px rgba(74, 158, 255, 0.4),
        0 0 25px rgba(74, 158, 255, 0.2);
    border: 1px solid rgba(74, 158, 255, 0.6);
}

.ai-panel.analyzing::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(74, 158, 255, 0.2) 50%,
        transparent 100%
    );
    animation: aiGentleSweep 3s ease-in-out infinite;
    z-index: 1;
}

.ai-panel.analyzing .ai-panel-header,
.ai-panel.analyzing .ai-analyze-btn,
.ai-panel.analyzing .ai-suggestions {
    position: relative;
    z-index: 2;
}

@keyframes aiGentlePulse {
    0%, 100% {
        box-shadow: 
            0 0 15px rgba(74, 158, 255, 0.4),
            0 0 25px rgba(74, 158, 255, 0.2);
    }
    50% {
        box-shadow: 
            0 0 20px rgba(74, 158, 255, 0.6),
            0 0 35px rgba(74, 158, 255, 0.3);
    }
}

@keyframes aiGentleSweep {
    0% {
        left: -100%;
    }
    100% {
        left: 100%;
    }
}

/* Tema claro */
[data-theme="light"] .ai-panel.analyzing {
    box-shadow: 
        0 0 15px rgba(59, 130, 246, 0.4),
        0 0 25px rgba(59, 130, 246, 0.2);
    border: 1px solid rgba(59, 130, 246, 0.6);
}

[data-theme="light"] .ai-panel.analyzing::before {
    background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(59, 130, 246, 0.2) 50%,
        transparent 100%
    );
}
/* Scrollbar personalizado para el panel de IA */
.ai-analysis-results::-webkit-scrollbar {
    width: 6px;
}

.ai-analysis-results::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.ai-analysis-results::-webkit-scrollbar-thumb {
    background: rgba(74, 158, 255, 0.3);
    border-radius: 3px;
    transition: all 0.3s ease;
}

.ai-analysis-results::-webkit-scrollbar-thumb:hover {
    background: rgba(74, 158, 255, 0.5);
}

/* Para Firefox */
.ai-analysis-results {
    scrollbar-width: thin;
    scrollbar-color: rgba(74, 158, 255, 0.3) rgba(255, 255, 255, 0.05);
}

/* Tema claro */
[data-theme="light"] .ai-analysis-results::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
}

[data-theme="light"] .ai-analysis-results::-webkit-scrollbar-thumb {
    background: rgba(59, 130, 246, 0.4);
}

[data-theme="light"] .ai-analysis-results::-webkit-scrollbar-thumb:hover {
    background: rgba(59, 130, 246, 0.6);
}

[data-theme="light"] .ai-analysis-results {
    scrollbar-color: rgba(59, 130, 246, 0.4) rgba(0, 0, 0, 0.05);
}

/* Si quieres aplicarlo también al panel completo */
.ai-panel::-webkit-scrollbar {
    width: 6px;
}

.ai-panel::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.ai-panel::-webkit-scrollbar-thumb {
    background: rgba(74, 158, 255, 0.3);
    border-radius: 3px;
}

.ai-panel::-webkit-scrollbar-thumb:hover {
    background: rgba(74, 158, 255, 0.5);
}

[data-theme="light"] .ai-panel::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
}

[data-theme="light"] .ai-panel::-webkit-scrollbar-thumb {
    background: rgba(59, 130, 246, 0.4);
}

[data-theme="light"] .ai-panel::-webkit-scrollbar-thumb:hover {
    background: rgba(59, 130, 246, 0.6);
}
/* Scrollbar personalizado para toda la página */
body::-webkit-scrollbar {
    width: 8px;
}

body::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

body::-webkit-scrollbar-thumb {
    background: rgba(74, 158, 255, 0.4);
    border-radius: 4px;
    transition: all 0.3s ease;
}

body::-webkit-scrollbar-thumb:hover {
    background: rgba(74, 158, 255, 0.6);
}

/* Para contenedores con scroll también */
.view::-webkit-scrollbar,
.content-wrapper::-webkit-scrollbar {
    width: 8px;
}

.view::-webkit-scrollbar-track,
.content-wrapper::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.view::-webkit-scrollbar-thumb,
.content-wrapper::-webkit-scrollbar-thumb {
    background: rgba(74, 158, 255, 0.4);
    border-radius: 4px;
}

.view::-webkit-scrollbar-thumb:hover,
.content-wrapper::-webkit-scrollbar-thumb:hover {
    background: rgba(74, 158, 255, 0.6);
}

/* Tema claro */
[data-theme="light"] body::-webkit-scrollbar-track,
[data-theme="light"] .view::-webkit-scrollbar-track,
[data-theme="light"] .content-wrapper::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.08);
}

[data-theme="light"] body::-webkit-scrollbar-thumb,
[data-theme="light"] .view::-webkit-scrollbar-thumb,
[data-theme="light"] .content-wrapper::-webkit-scrollbar-thumb {
    background: rgba(59, 130, 246, 0.5);
}

[data-theme="light"] body::-webkit-scrollbar-thumb:hover,
[data-theme="light"] .view::-webkit-scrollbar-thumb:hover,
[data-theme="light"] .content-wrapper::-webkit-scrollbar-thumb:hover {
    background: rgba(59, 130, 246, 0.7);
}

/* Para Firefox */
html {
    scrollbar-width: thin;
    scrollbar-color: rgba(74, 158, 255, 0.4) rgba(255, 255, 255, 0.05);
}

[data-theme="light"] html {
    scrollbar-color: rgba(59, 130, 246, 0.5) rgba(0, 0, 0, 0.08);
}
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-brain"></i>
            </div>
            OpenMind AI
        </div>
        <nav>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        Inicio
                    </a>
                </li>
                <li class="nav-item">
                    <a href="discussions.html" class="nav-link active">
                        <i class="fas fa-comments"></i>
                        Foros
                    </a>
                </li>
                <li class="nav-item">
                    <a href="code-editor.html" class="nav-link">
                        <i class="fas fa-code"></i>
                        Editor de Código
                    </a>
                </li>
                <li class="nav-item">
                    <a href="members.html" class="nav-link">
                        <i class="fas fa-users"></i>
                        Miembros
                    </a>
                </li>
                <li class="nav-item">
                    <a href="voice-calls.html" class="nav-link">
                        <i class="fas fa-phone"></i>
                        Llamadas
                    </a>
                </li>
                <li class="nav-item">
                    <a href="settings.html" class="nav-link">
                        <i class="fas fa-cog"></i>
                        Configuración
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <header class="header">
    <div class="header-left">
        <button class="menu-toggle" id="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
        <div>
            <div class="page-title" data-i18n="discussions.title">Foros</div>
            <div class="project-name-header" id="project-name-header">Cargando...</div>
        </div>
    </div>
    
    <div class="header-controls">
        <button class="control-btn" onclick="toggleTheme()">
            <i class="fas fa-moon"></i>
            <span data-i18n="common.themeToggle">Cambiar Tema</span>
        </button>
        
        <div class="language-selector">
            <button class="control-btn" onclick="toggleLanguageDropdown()">
                <i class="fas fa-globe"></i>
                <span data-i18n="common.language">Idioma</span>
            </button>
            <div class="language-dropdown" id="languageDropdown">
                <!-- Se genera dinámicamente -->
            </div>
        </div>
        <div class="notifications-container">
    <button class="control-btn notifications-btn" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span class="notification-count" id="notificationCount" style="display: none;">0</span>
    </button>
    <div class="notifications-dropdown" id="notificationsDropdown">
        <div class="notifications-header">
            <h4>Notificaciones</h4>
        </div>
        <div class="notifications-list" id="notificationsList">
            <div class="notification-item loading">
                Cargando...
            </div>
        </div>
    </div>
</div>
        
        <div class="user-info">
            <div class="welcome-text">
                <span class="user-name" id="user-name">Cargando...</span>
            </div>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i> 
                <span data-i18n="common.logout">Salir</span>
            </button>
        </div>
    </div>
</header>

        

        <!-- Content Wrapper con transiciones -->
        <div class="content-wrapper">
            <!-- Vista de Lista de Discusiones -->
            <div class="view discussions-list-view active" id="discussions-list-view">
                <div class="discussions-header">
                    <h2 class="discussions-title">Foros de Discusión</h2>
                    <button class="new-discussion-btn" id="new-discussion-btn">
                        <i class="fas fa-plus"></i>
                        Nueva Discusión
                    </button>
                </div>
                
                <div class="discussions-grid" id="discussions-grid">
                    <!-- Se cargan dinámicamente -->
                </div>
            </div>

            <!-- Vista de Detalle de Discusión -->
            <div class="view discussion-detail-view" id="discussion-detail-view">
                <div class="discussion-main">
                    <button class="back-button" onclick="showDiscussionsList()">
                        <i class="fas fa-arrow-left"></i>
                        Volver a las discusiones
                    </button>

                    <!-- Post principal de la discusión -->
                    <div class="discussion-post" id="discussion-post">
                        <!-- Se carga dinámicamente -->
                    </div>

                    <!-- Sección de respuestas -->
                    <div class="replies-section">
                        <div class="replies-header">
                            <i class="fas fa-comments"></i>
                            Respuestas (<span id="replies-count">0</span>)
                        </div>

                        <!-- Formulario para nueva respuesta -->
                        <div class="reply-form">
                            <textarea class="reply-textarea" id="reply-textarea" placeholder="Escribe tu respuesta..."></textarea>
                            <button class="reply-submit" onclick="submitReply()">
                                <i class="fas fa-paper-plane"></i> Responder
                            </button>
                        </div>

                        <!-- Lista de respuestas -->
                        <div class="replies-list" id="replies-list">
                            <!-- Se cargan dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Panel lateral de IA -->
                <div class="ai-panel">
                    <div class="ai-panel-header">
                        <div class="ai-panel-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                       <div class="ai-panel-title">Analiza con MindAssist</div>
                    </div>

                    <button class="ai-analyze-btn" onclick="analyzeDiscussion()">
                        <i class="fas fa-brain"></i>
                        Analizar Discusión
                    </button>

                   <div class="ai-suggestions">
    <div class="ai-intro-section">
        <h3 class="ai-intro-title">Nuestra IA te ayuda en:</h3>
        <ul class="ai-features-list">
            <li>Análisis contextual de discusiones</li>
            <li>Identificación de temas principales</li>
            <li>Sugerencias técnicas específicas</li>
            <li>Recomendaciones para moderadores</li>
        </ul>
    </div>
</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Modal para nueva discusión -->
    <div class="modal-overlay" id="new-discussion-modal">
        <div class="modal">
            <h3>Crear Nueva Discusión</h3>
            <div class="modal-content">
                <div class="form-group">
                    <label>Título:</label>
                    <input type="text" id="discussion-title" placeholder="Título de la discusión">
                </div>
                <div class="form-group">
                    <label>Contenido:</label>
                    <textarea id="discussion-content" placeholder="Escribe el contenido de tu discusión aquí..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeNewDiscussionModal()">Cancelar</button>
                <button class="create-btn" onclick="createNewDiscussion()">Crear</button>
            </div>
        </div>
    </div>
    <div class="delete-modal-overlay" id="delete-modal-overlay">
    <div class="delete-modal">
        <div class="delete-modal-header">
            <div class="delete-modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>Eliminar Discusión</h3>
        </div>
        
        <div class="delete-modal-content">
            <div class="delete-modal-warning">
                <h4>⚠️ Esta acción no se puede deshacer</h4>
                <ul>
                    <li>Se eliminará la discusión permanentemente</li>
                    <li>Se eliminarán todas las respuestas</li>
                    <li>Se eliminarán todos los likes y reacciones</li>
                    <li>Los miembros perderán acceso a todo el contenido</li>
                </ul>
            </div>
            
            <p class="delete-modal-text">
                ¿Estás completamente seguro de que quieres eliminar esta discusión? 
                Escribe <strong>"ELIMINAR"</strong> para confirmar:
            </p>
            
            <input type="text" id="delete-confirmation-input" 
                   placeholder="Escribe ELIMINAR para confirmar" 
                   style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); 
                          border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; 
                          color: white; font-size: 14px; margin-top: 12px;">
        </div>
        
        <div class="delete-modal-actions">
            <button class="delete-cancel-btn" onclick="closeDeleteModal()">
                Cancelar
            </button>
            <button class="delete-confirm-btn" id="delete-confirm-btn" disabled 
                    onclick="confirmDeleteDiscussion()">
                Eliminar Discusión
            </button>
        </div>
    </div>
</div>

<script src="js/project-session.js"></script>
<script src="js/noti.js"></script>

    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://jatcscioqvicmiofsuqt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphdGNzY2lvcXZpY21pb2ZzdXF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2ODUwNDcsImV4cCI6MjA3MjI2MTA0N30.wZ2dXWG7jq7zhzorqKoQYF7I6xz49k2xaFsouQRscGQ';

        let supabaseClient;
        let currentUser = null;
        let currentProject = null;
        let currentUserRole = null;
        let discussions = [];
        let currentDiscussion = null;
        let currentReplies = [];
        let replyingToId = null;
        let repliesHierarchy = [];
        const INITIAL_NESTED_REPLIES_COUNT = 1; 
        let expandedThreads = new Set();
        let projectMembers = [];
        let typingTimer = null;
        let currentMentionInput = null;
        let typingDebounceTimer = null;
        let discussionToDelete = null;
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let currentLanguage = localStorage.getItem('language') || 'es';

// Idiomas soportados
const supportedLanguages = {
    'en': { name: 'English', flag: '🇺🇸' },
    'es': { name: 'Español', flag: '🇪🇸' },
    'fr': { name: 'Français', flag: '🇫🇷' },
    'de': { name: 'Deutsch', flag: '🇩🇪' },
    'it': { name: 'Italiano', flag: '🇮🇹' },
    'pt': { name: 'Português', flag: '🇵🇹' },
    'ru': { name: 'Русский', flag: '🇷🇺' },
    'ja': { name: '日本語', flag: '🇯🇵' },
    'ko': { name: '한국어', flag: '🇰🇷' },
    'zh': { name: '中文', flag: '🇨🇳' },
    'ar': { name: 'العربية', flag: '🇸🇦' },
    'hi': { name: 'हिंदी', flag: '🇮🇳' },
    'nl': { name: 'Nederlands', flag: '🇳🇱' }
};

const translations = {
    es: {
        'common.themeToggle': 'Cambiar Tema',
        'common.language': 'Idioma',
        'common.logout': 'Salir',
        'discussions.title': 'Foros'
    },
    en: {
        'common.themeToggle': 'Toggle Theme',
        'common.language': 'Language',
        'common.logout': 'Logout',
        'discussions.title': 'Forums'
    }
};

// Función para obtener traducción
function t(key) {
    return translations[currentLanguage] && translations[currentLanguage][key] 
        ? translations[currentLanguage][key] 
        : translations['es'][key] || key;
}

// Reacciones disponibles
       const REACTIONS = {
          'love': '❤️', 
          'laugh': '😂',
          'think': '🤔',
          'idea': '💡'
         };



         function showDeleteModal(discussionId) {
    discussionToDelete = discussionId;
    const modal = document.getElementById('delete-modal-overlay');
    const input = document.getElementById('delete-confirmation-input');
    const confirmBtn = document.getElementById('delete-confirm-btn');
    
    // Limpiar estado
    input.value = '';
    confirmBtn.disabled = true;
    confirmBtn.style.opacity = '0.5';
    
    // Mostrar modal
    modal.classList.add('show');
    input.focus();
}

// Función para cerrar el modal
function closeDeleteModal() {
    const modal = document.getElementById('delete-modal-overlay');
    const input = document.getElementById('delete-confirmation-input');
    
    modal.classList.remove('show');
    input.value = '';
    discussionToDelete = null;
}

// Función para confirmar eliminación
async function confirmDeleteDiscussion() {
    if (!discussionToDelete) return;
    
    try {
        // Eliminar discusión
        const { error } = await supabaseClient
            .from('discussions')
            .delete()
            .eq('id', discussionToDelete);

        if (error) throw error;
        
        showToast('Discusión eliminada correctamente');
        closeDeleteModal();
        
        // Volver a la lista de discusiones
        showDiscussionsList();
        
        // Recargar la lista
        await loadDiscussions();

    } catch (error) {
        console.error('Error deleting discussion:', error);
        showToast('Error al eliminar la discusión', 'error');
    }
}

// Validación del input de confirmación
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('delete-confirmation-input');
    const confirmBtn = document.getElementById('delete-confirm-btn');
    
    if (input && confirmBtn) {
        input.addEventListener('input', function() {
            const isValid = this.value.trim().toUpperCase() === 'ELIMINAR';
            confirmBtn.disabled = !isValid;
            confirmBtn.style.opacity = isValid ? '1' : '0.5';
        });
        
        // Enter para confirmar si está habilitado
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !confirmBtn.disabled) {
                confirmDeleteDiscussion();
            }
        });
    }
});

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('delete-modal-overlay');
        if (modal && modal.classList.contains('show')) {
            closeDeleteModal();
        }
    }
});

// Cerrar modal al hacer clic fuera
document.getElementById('delete-modal-overlay')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});

async function loadProjectMembers() {
    try {
        // Paso 1: Obtener user_ids del proyecto
        const { data: members, error: membersError } = await supabaseClient
            .from('project_members')
            .select('user_id')
            .eq('project_id', currentProject.id);

        if (membersError) throw membersError;

        // Paso 2: Obtener perfiles por separado
        const userIds = members.map(m => m.user_id);
        
        const { data: profiles, error: profilesError } = await supabaseClient
            .from('profiles')
            .select('id, username, full_name')
            .in('id', userIds);

        if (profilesError) throw profilesError;

        // Paso 3: Combinar datos
        projectMembers = profiles.map(profile => ({
            id: profile.id,
            username: profile.username || profile.id.substring(0, 8),
            name: profile.full_name || profile.username || 'Usuario'
        }));

        console.log('Miembros cargados correctamente:', projectMembers);

    } catch (error) {
        console.error('Error loading project members:', error);
        projectMembers = [];
    }
}


async function loadReplies(discussionId) {
    try {
        const { data: replies, error } = await supabaseClient
            .from('discussion_replies')
            .select('*')
            .eq('discussion_id', discussionId)
            .order('created_at', { ascending: true });

        if (error && error.code !== 'PGRST116') {
            console.error('Error loading replies:', error);
            return;
        }

        const repliesWithInfo = await Promise.all((replies || []).map(async (reply) => {
            const authorName = await getUserName(reply.created_by);
            
            // Obtener likes de la respuesta
            const { count: likesCount } = await supabaseClient
                .from('reply_likes')
                .select('*', { count: 'exact', head: true })
                .eq('reply_id', reply.id);

            // Verificar si el usuario actual ha dado like
            const { data: userLike } = await supabaseClient
                .from('reply_likes')
                .select('id')
                .eq('reply_id', reply.id)
                .eq('user_id', currentUser.id)
                .maybeSingle();

            return {
                ...reply,
                author_name: authorName,
                likes_count: likesCount || 0,
                is_liked: !!userLike
            };
        }));

        // Organizar respuestas en jerarquía
        repliesHierarchy = organizeRepliesHierarchy(repliesWithInfo);
        renderRepliesHierarchy();

        // Actualizar contador
        document.getElementById('replies-count').textContent = repliesWithInfo.length;

    } catch (error) {
        console.error('Error loading replies:', error);
        document.getElementById('replies-list').innerHTML = 
            '<p style="color: #ef4444; text-align: center;">Error cargando respuestas</p>';
    }
}

// Organizar respuestas en estructura jerárquica
function organizeRepliesHierarchy(replies) {
    const repliesMap = new Map();
    const rootReplies = [];
    
    // Crear mapa de respuestas
    replies.forEach(reply => {
        repliesMap.set(reply.id, { ...reply, children: [] });
    });
    
    // Organizar jerarquía
    replies.forEach(reply => {
        const replyObj = repliesMap.get(reply.id);
        
        if (reply.parent_reply_id && repliesMap.has(reply.parent_reply_id)) {
            // Es una respuesta anidada
            const parent = repliesMap.get(reply.parent_reply_id);
            parent.children.push(replyObj);
        } else {
            // Es una respuesta directa
            rootReplies.push(replyObj);
        }
    });
    
    return rootReplies;
}

// Renderizar respuestas jerárquicas
function renderRepliesHierarchy() {
    const container = document.getElementById('replies-list');
    if (!container) return;

    if (repliesHierarchy.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #8892a6;">
                <i class="fas fa-comment" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p>Aún no hay respuestas. ¡Sé el primero en responder!</p>
            </div>
        `;
        return;
    }

    container.innerHTML = '';
    
    repliesHierarchy.forEach(reply => {
        const threadElement = createReplyThread(reply);
        container.appendChild(threadElement);
    });
}

function createReplyThread(reply, level = 0) {
    const div = document.createElement('div');
    div.className = 'reply-thread';
    
    // Crear elemento de respuesta principal
    const replyElement = createReplyElement(reply, level);
    div.appendChild(replyElement);
    
    // Agregar respuestas anidadas si existen
    if (reply.children && reply.children.length > 0) {
        const isExpanded = expandedThreads.has(reply.id);
        const childrenToShow = isExpanded ? reply.children : reply.children.slice(0, INITIAL_NESTED_REPLIES_COUNT);
        const hasMoreChildren = reply.children.length > INITIAL_NESTED_REPLIES_COUNT;
        
        // Crear contenedor para respuestas anidadas
        const nestedContainer = document.createElement('div');
        nestedContainer.className = 'nested-replies-container';
        nestedContainer.id = `nested-${reply.id}`;
        
        // Agregar respuestas anidadas visibles
        childrenToShow.forEach(childReply => {
            const childThread = createReplyThread(childReply, level + 1);
            nestedContainer.appendChild(childThread);
        });
        
        div.appendChild(nestedContainer);
        
        // Agregar botón "Ver más respuestas" si hay más respuestas anidadas
        if (hasMoreChildren && !isExpanded) {
            const showMoreBtn = document.createElement('button');
            showMoreBtn.className = 'show-more-nested-btn';
            showMoreBtn.innerHTML = `
                <i class="fas fa-chevron-down"></i>
                Ver ${reply.children.length - INITIAL_NESTED_REPLIES_COUNT} respuestas más
            `;
            showMoreBtn.onclick = () => expandNestedReplies(reply.id, reply.children, level);
            div.appendChild(showMoreBtn);
        }
        
        // Agregar botón "Ver menos" si está expandido
        if (isExpanded && hasMoreChildren) {
            const showLessBtn = document.createElement('button');
            showLessBtn.className = 'show-less-nested-btn';
            showLessBtn.innerHTML = `
                <i class="fas fa-chevron-up"></i>
                Ver menos respuestas
            `;
            showLessBtn.onclick = () => collapseNestedReplies(reply.id);
            div.appendChild(showLessBtn);
        }
    }
    
    return div;
}

function collapseNestedReplies(parentReplyId) {
    expandedThreads.delete(parentReplyId);
    
    // Regenerar todo el thread para el reply parent
    const parentReply = findReplyInHierarchy(parentReplyId);
    if (parentReply) {
        const parentElement = document.querySelector(`[data-reply-id="${parentReplyId}"]`).closest('.reply-thread');
        const newThread = createReplyThread(parentReply, 0);
        parentElement.parentElement.replaceChild(newThread, parentElement);
    }
}


function findReplyInHierarchy(replyId) {
    function searchInReplies(replies) {
        for (const reply of replies) {
            if (reply.id === replyId) {
                return reply;
            }
            if (reply.children) {
                const found = searchInReplies(reply.children);
                if (found) return found;
            }
        }
        return null;
    }
    
    return searchInReplies(repliesHierarchy);
}

const additionalCSS = `
.show-more-nested-btn,
.show-less-nested-btn {
    background: rgba(74, 158, 255, 0.1);
    border: 1px solid rgba(74, 158, 255, 0.3);
    color: #4a9eff;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    margin: 12px 0 0 40px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    max-width: fit-content;
}

.show-more-nested-btn:hover,
.show-less-nested-btn:hover {
    background: rgba(74, 158, 255, 0.2);
    border-color: #4a9eff;
    transform: translateY(-1px);
}

.show-more-nested-btn i,
.show-less-nested-btn i {
    font-size: 10px;
}

.nested-replies-container {
    position: relative;
}

/* Animación suave para expansión */
.nested-replies-container {
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
`;

// Función para inyectar CSS adicional
function injectAdditionalCSS() {
    const style = document.createElement('style');
    style.textContent = additionalCSS;
    document.head.appendChild(style);
}

// Llamar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    injectAdditionalCSS();
});

function expandNestedReplies(parentReplyId, allChildren, level) {
    expandedThreads.add(parentReplyId);
    
    const container = document.getElementById(`nested-${parentReplyId}`);
    const showMoreBtn = container.parentElement.querySelector('.show-more-nested-btn');
    
    if (container) {
        // Limpiar contenedor
        container.innerHTML = '';
        
        // Agregar todas las respuestas anidadas
        allChildren.forEach(childReply => {
            const childThread = createReplyThread(childReply, level + 1);
            container.appendChild(childThread);
        });
    }
    
    if (showMoreBtn) {
        showMoreBtn.remove();
    }
    
    // Agregar botón "Ver menos"
    const showLessBtn = document.createElement('button');
    showLessBtn.className = 'show-less-nested-btn';
    showLessBtn.innerHTML = `
        <i class="fas fa-chevron-up"></i>
        Ver menos respuestas
    `;
    showLessBtn.onclick = () => collapseNestedReplies(parentReplyId);
    container.parentElement.appendChild(showLessBtn);
}



// Crear elemento de respuesta individual (modificado)
function createReplyElement(reply, level = 0) {
    const div = document.createElement('div');
    div.className = `reply-item ${level > 0 ? 'nested' : ''}`;
    div.dataset.replyId = reply.id;

    const date = new Date(reply.created_at).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    // Indicador de respuesta anidada
    const nestedIndicator = level > 0 && reply.parent_reply_id ? 
        `<div class="nested-indicator">Respondiendo a otra respuesta</div>` : '';

    div.innerHTML = `
        ${nestedIndicator}
        <div class="reply-header">
            <span class="reply-author">${reply.author_name}</span>
            <span class="reply-date">${date}</span>
        </div>
        <div class="reply-content">${reply.content}</div>
        <div class="reply-actions">
            <button class="reply-action-btn ${reply.is_liked ? 'liked' : ''}" onclick="toggleReplyLike('${reply.id}')">
                <i class="fas fa-thumbs-up"></i>
                <span>${reply.likes_count}</span>
            </button>
            <button class="reply-action-btn" onclick="showInlineReplyForm('${reply.id}')">
                <i class="fas fa-reply"></i>
                Responder
            </button>
        </div>
        
        <!-- Formulario de respuesta inline -->
        <div class="reply-form-inline" id="inline-form-${reply.id}">
            <textarea class="reply-textarea" id="inline-textarea-${reply.id}" placeholder="Responde a ${reply.author_name}..."></textarea>
            <div class="reply-form-actions">
                <button class="reply-form-btn cancel" onclick="hideInlineReplyForm('${reply.id}')">Cancelar</button>
                <button class="reply-form-btn" onclick="submitInlineReply('${reply.id}')">Responder</button>
            </div>
        </div>
    `;

    return div;
}

// Mostrar formulario de respuesta inline
function showInlineReplyForm(replyId) {
    // Ocultar otros formularios abiertos
    document.querySelectorAll('.reply-form-inline.show').forEach(form => {
        form.classList.remove('show');
    });
    
    // Mostrar formulario específico
    const form = document.getElementById(`inline-form-${replyId}`);
    const textarea = document.getElementById(`inline-textarea-${replyId}`);
    
    if (form) {
        form.classList.add('show');
        replyingToId = replyId;
    }
    if (textarea) {
        textarea.focus();
    }
    
    // Actualizar estado visual del botón
    document.querySelectorAll('.reply-action-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

// Ocultar formulario de respuesta inline
function hideInlineReplyForm(replyId) {
    const form = document.getElementById(`inline-form-${replyId}`);
    const textarea = document.getElementById(`inline-textarea-${replyId}`);
    
    if (form) {
        form.classList.remove('show');
    }
    if (textarea) {
        textarea.value = '';
    }
    
    replyingToId = null;
    
    // Remover estado activo del botón
    document.querySelectorAll('.reply-action-btn.active').forEach(btn => {
        btn.classList.remove('active');
    });
}

// Enviar respuesta inline (anidada)
async function submitInlineReply(parentReplyId) {
    const textarea = document.getElementById(`inline-textarea-${parentReplyId}`);
    const content = textarea.value.trim();

    if (!content) {
        showToast('Escribe algo antes de responder', 'error');
        return;
    }

    if (!currentDiscussion) {
        showToast('Error: No hay discusión seleccionada', 'error');
        return;
    }

    try {
        const { data, error } = await supabaseClient
            .from('discussion_replies')
            .insert([{
                discussion_id: currentDiscussion.id,
                content: content,
                created_by: currentUser.id,
                parent_reply_id: parentReplyId  // <- Aquí está la magia de la anidación
            }])
            .select()
            .single();

        if (error) throw error;

        showToast('Respuesta enviada correctamente');
        hideInlineReplyForm(parentReplyId);

        // Recargar respuestas
        await loadReplies(currentDiscussion.id);

    } catch (error) {
        console.error('Error submitting nested reply:', error);
        showToast('Error al enviar la respuesta', 'error');
    }
}

        // Variables de vista
        let currentView = 'discussions-list';

        // Asegurar project ID
        function ensureProjectId() {
            const urlParams = new URLSearchParams(window.location.search);
            let projectId = urlParams.get('project');
            let code = urlParams.get('code');
            
            if (!projectId) {
                projectId = localStorage.getItem('current_project_id');
                code = localStorage.getItem('current_project_code');
                
                if (projectId) {
                    const url = new URL(window.location);
                    url.searchParams.set('project', projectId);
                    if (code) {
                        url.searchParams.set('code', code);
                    }
                    window.history.replaceState({}, '', url);
                } else {
                    console.warn('No se encontró project ID, redirigiendo al dashboard');
                    window.location.href = 'dashboard.html';
                    return null;
                }
            } else {
                localStorage.setItem('current_project_id', projectId);
                if (code) {
                    localStorage.setItem('current_project_code', code);
                }
            }
            
            return projectId;
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            if (!ensureProjectId()) {
                return;
            }
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            setupEventListeners();
            checkAuthenticationAndLoadData();
        });

        function setupEventListeners() {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            
            const menuToggle = document.getElementById('menu-toggle');
            if (menuToggle) menuToggle.addEventListener('click', toggleSidebar);

            const newDiscussionBtn = document.getElementById('new-discussion-btn');
            if (newDiscussionBtn) newDiscussionBtn.addEventListener('click', showNewDiscussionModal);

            // Cerrar modal al hacer clic fuera
            const modal = document.getElementById('new-discussion-modal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeNewDiscussionModal();
                    }
                });
            }
        }

        async function checkAuthenticationAndLoadData() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error || !session) {
                    console.log('No session found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = session.user;
                
                const userName = currentUser.user_metadata?.full_name || 
                                currentUser.user_metadata?.name || 
                                currentUser.email.split('@')[0];
                
                document.getElementById('user-name').textContent = userName;

                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('project');

                if (!projectId) {
                    console.error('No project ID provided');
                    redirectToHome('Proyecto no especificado');
                    return;
                }

                const hasAccess = await verifyProjectAccess(projectId);
                if (!hasAccess) {
                    console.error('User does not have access to this project');
                    redirectToHome('No tienes acceso a este proyecto');
                    return;
                }

                await loadProjectData(projectId);
                await loadDiscussions();

                console.log('Discussions loaded successfully');
                initializeThemeAndLanguage();

            } catch (error) {
                console.error('Error in checkAuthenticationAndLoadData:', error);
                redirectToHome('Error cargando el proyecto: ' + error.message);
            }
        }

        async function verifyProjectAccess(projectId) {
            try {
                const { data: membership, error } = await supabaseClient
                    .from('project_members')
                    .select('id, role, project_id')
                    .eq('project_id', projectId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error checking project membership:', error);
                    return false;
                }

                if (!membership) {
                    console.log('Usuario no es miembro del proyecto');
                    return false;
                }

                currentUserRole = membership.role;
                return true;

            } catch (error) {
                console.error('Error in verifyProjectAccess:', error);
                return false;
            }
        }

        async function loadProjectData(projectId) {
            try {
                const { data: projectData, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('id', projectId)
                    .single();

                if (error) throw error;

                currentProject = projectData;
                document.getElementById('project-name-header').textContent = projectData.name;

            } catch (error) {
                console.error('Error loading project data:', error);
                redirectToHome('Error cargando datos del proyecto');
            }
        }

        async function loadDiscussions() {
            try {
                if (!currentProject) {
                    console.warn('No current project for loading discussions');
                    return;
                }

                const { data, error } = await supabaseClient
                    .from('discussions')
                    .select('*')
                    .eq('project_id', currentProject.id)
                    .order('created_at', { ascending: false });

                if (error && error.code !== 'PGRST116') {
                    console.error('Error en consulta de discusiones:', error);
                    throw error;
                }

                const discussionsWithInfo = await Promise.all((data || []).map(async (discussion) => {
                    const authorName = await getUserName(discussion.created_by);
                    
                    let likesCount = 0;
                    try {
                        const { count } = await supabaseClient
                            .from('discussion_likes')
                            .select('*', { count: 'exact', head: true })
                            .eq('discussion_id', discussion.id);
                        likesCount = count || 0;
                    } catch (e) {
                        console.log('Error contando likes:', e);
                    }

                    let repliesCount = 0;
                    try {
                        const { count } = await supabaseClient
                            .from('discussion_replies')
                            .select('*', { count: 'exact', head: true })
                            .eq('discussion_id', discussion.id);
                        repliesCount = count || 0;
                    } catch (e) {
                        console.log('Error contando replies:', e);
                    }

                    return {
                        ...discussion,
                        author_name: authorName,
                        likes_count: likesCount,
                        replies_count: repliesCount
                    };
                }));

                discussions = discussionsWithInfo;
                renderDiscussions();

            } catch (error) {
                console.error('Error loading discussions:', error);
                const discussionsGrid = document.getElementById('discussions-grid');
                if (discussionsGrid) {
                    discussionsGrid.innerHTML = 
                        '<p style="color: #ef4444; text-align: center; grid-column: 1 / -1;">Error cargando discusiones</p>';
                }
            }
        }

        function renderDiscussions() {
            const container = document.getElementById('discussions-grid');
            if (!container) return;
            
            if (discussions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-comments"></i>
                        <h3>No hay discusiones aún</h3>
                        <p>Sé el primero en crear una discusión para este proyecto</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            discussions.forEach(discussion => {
                const discussionElement = createDiscussionCard(discussion);
                container.appendChild(discussionElement);
            });
        }

     
function createDiscussionCard(discussion) {
    const div = document.createElement('div');
    div.className = 'discussion-card';
    div.dataset.discussionId = discussion.id;
    
    const authorName = discussion.author_name || 'Usuario';
    const date = new Date(discussion.created_at).toLocaleDateString('es-ES', {
        month: 'short',
        day: 'numeric'
    });
    const preview = discussion.content && discussion.content.length > 120 
        ? discussion.content.substring(0, 120) + '...' 
        : (discussion.content || 'Sin contenido');
    
    const isClosed = discussion.is_closed;
    const statusBadge = `
        <div class="discussion-status-badge ${isClosed ? 'closed' : 'open'}">
            ${isClosed ? 'Cerrado' : 'Activo'}
        </div>
    `;
    
    // YA NO incluir botón de eliminar aquí
    div.innerHTML = `
        ${statusBadge}
        <div class="discussion-card-content">
            <h3 class="discussion-card-title">${discussion.title || 'Sin título'}</h3>
            <p class="discussion-card-preview">${preview}</p>
        </div>
        <div class="discussion-card-footer">
            <div class="discussion-card-meta">
                <span class="discussion-card-author">${authorName} • ${date}</span>
                <div class="discussion-card-stats">
                    <span class="discussion-card-stat">
                        <i class="far fa-comment"></i> ${discussion.replies_count || 0}
                    </span>
                    <span class="discussion-card-stat">
                        <i class="far fa-thumbs-up"></i> ${discussion.likes_count || 0}
                    </span>
                </div>
            </div>
        </div>
    `;
    
    div.addEventListener('click', () => openDiscussion(discussion.id));
    return div;
}

async function deleteDiscussion(event, discussionId) {
    // Esta función ya no se usa en las cards, pero la mantenemos por compatibilidad
    await deleteDiscussionFromDetail(discussionId);
}

        async function getUserName(userId) {
            if (!userId) return 'Usuario Anónimo';
            
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('username, full_name')
                    .eq('id', userId)
                    .single();
                
                if (!error && profile) {
                    return profile.full_name || profile.username || 'Usuario';
                }
                
                if (currentUser && currentUser.id === userId) {
                    return currentUser.user_metadata?.full_name || 
                           currentUser.user_metadata?.name || 
                           currentUser.email.split('@')[0] || 'Usuario';
                }
                
                return 'Usuario';
                
            } catch (error) {
                console.log('Error obteniendo nombre de usuario:', error);
                return 'Usuario';
            }
        }

        // Sistema de navegación entre vistas
        function showView(viewName) {
            const currentViewElement = document.querySelector('.view.active');
            const targetViewElement = document.getElementById(viewName + '-view');

            if (!targetViewElement || currentViewElement === targetViewElement) return;

            // Animación de salida
            if (currentViewElement) {
                currentViewElement.classList.add('sliding-out');
                currentViewElement.classList.remove('active');
            }

            // Animación de entrada después de un pequeño delay
            setTimeout(() => {
                targetViewElement.classList.add('active');
                currentView = viewName;
                
                // Limpiar clase de salida
                if (currentViewElement) {
                    currentViewElement.classList.remove('sliding-out');
                }
            }, 200);
        }

        function showDiscussionsList() {
            showView('discussions-list');
        }

        function showDiscussionDetail(discussionId) {
            showView('discussion-detail');
            loadDiscussionDetail(discussionId);
        }

        async function openDiscussion(discussionId) {
            showDiscussionDetail(discussionId);
        }

        async function loadDiscussionDetail(discussionId) {
            try {
                // Cargar la discusión
                const { data: discussion, error } = await supabaseClient
                    .from('discussions')
                    .select('*')
                    .eq('id', discussionId)
                    .single();

                if (error) throw error;

                currentDiscussion = discussion;

                // Obtener información del autor
                const authorName = await getUserName(discussion.created_by);

                // Obtener likes de la discusión
                const { count: likesCount } = await supabaseClient
                    .from('discussion_likes')
                    .select('*', { count: 'exact', head: true })
                    .eq('discussion_id', discussionId);

                // Verificar si el usuario actual ha dado like
                const { data: userLike } = await supabaseClient
                    .from('discussion_likes')
                    .select('id')
                    .eq('discussion_id', discussionId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                // Renderizar la discusión
                renderDiscussionPost(discussion, authorName, likesCount || 0, !!userLike);

                // Cargar respuestas
                await loadReplies(discussionId);

                await initEnhancedFeatures();

            } catch (error) {
                console.error('Error loading discussion detail:', error);
                showToast('Error cargando la discusión', 'error');
            }
        }


function renderDiscussionPost(discussion, authorName, likesCount, isLiked) {
    const container = document.getElementById('discussion-post');
    if (!container) return;

    const date = new Date(discussion.created_at).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    const isClosed = discussion.is_closed;
    const statusIcon = isClosed ? 'lock' : 'unlock';
    const statusText = isClosed ? 'Cerrado' : 'Abierto';
    const statusClass = isClosed ? 'closed' : 'open';

    // Agregar clase CSS si está cerrado
    container.parentElement.classList.toggle('discussion-closed', isClosed);

    container.innerHTML = `
        <div class="discussion-post-header">
            <div class="discussion-post-info">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <h1 class="discussion-post-title">${discussion.title || 'Sin título'}</h1>
                    <div class="discussion-status ${statusClass}">
                        <i class="fas fa-${statusIcon}"></i>
                        ${statusText}
                    </div>
                </div>
                <div class="discussion-post-meta">
                    <span class="discussion-post-author">${authorName}</span>
                    <span>•</span>
                    <span>${date}</span>
                </div>
            </div>
        </div>
        <div class="discussion-post-content">
            ${processContentWithMentions(discussion.content || 'Sin contenido')}
        </div>
        <div class="discussion-post-actions">
            <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleDiscussionLike('${discussion.id}')">
                <i class="fas fa-thumbs-up"></i>
                <span id="likes-count">${likesCount}</span>
            </button>
            <button class="action-btn" onclick="focusReplyTextarea()">
                <i class="fas fa-reply"></i>
                Responder
            </button>
            <button class="action-btn">
                <i class="fas fa-share"></i>
                Compartir
            </button>
        </div>
        
        <!-- Reacciones rápidas -->
        <div class="quick-reactions" id="discussion-reactions">
            <!-- Se cargan dinámicamente -->
        </div>
        
        ${currentUserRole === 'admin' || currentUserRole === 'owner' ? `
        <div class="discussion-admin-controls">
            ${isClosed ? 
                `<button class="admin-btn open-btn" onclick="toggleDiscussionStatus('${discussion.id}', false)">
                    <i class="fas fa-unlock"></i> Reabrir Discusión
                </button>` :
                `<button class="admin-btn close-btn" onclick="toggleDiscussionStatus('${discussion.id}', true)">
                    <i class="fas fa-lock"></i> Cerrar Discusión
                </button>`
            }
            <button class="discussion-delete-action" onclick="deleteDiscussionFromDetail('${discussion.id}')">
                <i class="fas fa-trash"></i>
                Eliminar Discusión
            </button>
        </div>
        ` : ''}
        
        ${isClosed ? '<div class="closed-message">Esta discusión ha sido cerrada. No se pueden agregar nuevas respuestas.</div>' : ''}
    `;

    // Cargar reacciones
    loadDiscussionReactions(discussion.id);
}


async function deleteDiscussionFromDetail(discussionId) {
    // Verificar permisos
    if (currentUserRole !== 'admin' && currentUserRole !== 'owner') {
        showToast('No tienes permisos para eliminar discusiones', 'error');
        return;
    }
    
    // Mostrar modal personalizado en lugar de confirm()
    showDeleteModal(discussionId);
}

function processContentWithMentions(content) {
    return content.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
}

async function loadDiscussionReactions(discussionId) {
    try {
        const { data: reactions, error } = await supabaseClient
            .from('discussion_reactions')
            .select('reaction_type, user_id')
            .eq('discussion_id', discussionId);

        if (error) throw error;

        const reactionCounts = {};
        const userReactions = new Set();

        reactions.forEach(reaction => {
            reactionCounts[reaction.reaction_type] = (reactionCounts[reaction.reaction_type] || 0) + 1;
            if (reaction.user_id === currentUser.id) {
                userReactions.add(reaction.reaction_type);
            }
        });

        renderReactions('discussion-reactions', reactionCounts, userReactions, discussionId, 'discussion');

    } catch (error) {
        console.error('Error loading reactions:', error);
    }
}

function renderReactions(containerId, reactionCounts, userReactions, targetId, type) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = Object.entries(REACTIONS).map(([key, emoji]) => {
        const count = reactionCounts[key] || 0;
        const isActive = userReactions.has(key);
        
        return `
            <button class="reaction-btn ${isActive ? 'active' : ''}" 
                    onclick="toggleReaction('${targetId}', '${key}', '${type}')"
                    data-reaction="${key}">
                <span class="emoji">${emoji}</span>
                ${count > 0 ? `<span class="count">${count}</span>` : ''}
            </button>
        `;
    }).join('');
}

async function toggleReaction(targetId, reactionType, type) {
    try {
        const table = type === 'discussion' ? 'discussion_reactions' : 'reply_reactions';
        const column = type === 'discussion' ? 'discussion_id' : 'reply_id';

        // Verificar si ya existe la reacción
        const { data: existing, error: checkError } = await supabaseClient
            .from(table)
            .select('id')
            .eq(column, targetId)
            .eq('user_id', currentUser.id)
            .eq('reaction_type', reactionType)
            .maybeSingle();

        if (checkError && checkError.code !== 'PGRST116') throw checkError;

        if (existing) {
            // Quitar reacción
            await supabaseClient
                .from(table)
                .delete()
                .eq('id', existing.id);
        } else {
            // Agregar reacción
            await supabaseClient
                .from(table)
                .insert([{
                    [column]: targetId,
                    user_id: currentUser.id,
                    reaction_type: reactionType
                }]);
        }

        // Recargar reacciones
        if (type === 'discussion') {
            loadDiscussionReactions(targetId);
        } else {
            // Recargar respuestas para actualizar reacciones de replies
            await loadReplies(currentDiscussion.id);
        }

    } catch (error) {
        console.error('Error toggling reaction:', error);
        showToast('Error al procesar la reacción', 'error');
    }
}

async function toggleDiscussionStatus(discussionId, shouldClose) {
    try {
        const updates = {
            is_closed: shouldClose,
            closed_at: shouldClose ? new Date().toISOString() : null,
            closed_by: shouldClose ? currentUser.id : null
        };

        const { error } = await supabaseClient
            .from('discussions')
            .update(updates)
            .eq('id', discussionId);

        if (error) throw error;

        showToast(shouldClose ? 'Discusión cerrada' : 'Discusión reabierta');
        
        // Recargar detalle
        await loadDiscussionDetail(discussionId);

    } catch (error) {
        console.error('Error updating discussion status:', error);
        showToast('Error al cambiar el estado', 'error');
    }
}



function setupTypingIndicator() {
    const textarea = document.getElementById('reply-textarea');
    if (!textarea) return;

    textarea.addEventListener('input', () => {
        if (!currentDiscussion) return;

        // Limpiar timer anterior
        if (typingTimer) {
            clearTimeout(typingTimer);
        }

        // Actualizar estado de escribiendo
        updateTypingStatus(true);

        // Limpiar después de 3 segundos de inactividad
        typingTimer = setTimeout(() => {
            updateTypingStatus(false);
        }, 3000);
    });

    textarea.addEventListener('blur', () => {
        updateTypingStatus(false);
    });
}

async function updateTypingStatus(isTyping) {
    // Limpiar timer anterior
    if (typingDebounceTimer) {
        clearTimeout(typingDebounceTimer);
    }

    // Debounce de 500ms
    typingDebounceTimer = setTimeout(async () => {
        try {
            if (isTyping) {
                const { error } = await supabaseClient
                    .from('typing_status')
                    .upsert({
                        discussion_id: currentDiscussion.id,
                        user_id: currentUser.id,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'discussion_id,user_id'
                    });
                
                if (error) throw error;
            } else {
                await supabaseClient
                    .from('typing_status')
                    .delete()
                    .eq('discussion_id', currentDiscussion.id)
                    .eq('user_id', currentUser.id);
            }
        } catch (error) {
            console.log('Error updating typing status:', error);
        }
    }, 500);
}

function setupMentions(textareaId) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;

    textarea.addEventListener('input', (e) => {
        const text = e.target.value;
        const cursorPos = e.target.selectionStart;
        
        // Buscar @ antes del cursor
        const beforeCursor = text.substring(0, cursorPos);
        const atMatch = beforeCursor.match(/@(\w*)$/);
        
        if (atMatch) {
            currentMentionInput = {
                textarea: textarea,
                start: cursorPos - atMatch[0].length,
                query: atMatch[1]
            };
            showMentionSuggestions(atMatch[1], textarea);
        } else {
            hideMentionSuggestions();
        }
    });
}


function showMentionSuggestions(query, textarea) {
    const filtered = projectMembers.filter(member => 
        member.username.toLowerCase().includes(query.toLowerCase()) ||
        member.name.toLowerCase().includes(query.toLowerCase())
    ).slice(0, 5);

    if (filtered.length === 0) {
        hideMentionSuggestions();
        return;
    }

    // Crear o actualizar sugerencias
    let suggestions = document.getElementById('mention-suggestions');
    if (!suggestions) {
        suggestions = document.createElement('div');
        suggestions.id = 'mention-suggestions';
        suggestions.className = 'mention-suggestion';
        document.body.appendChild(suggestions);
    }

    suggestions.innerHTML = filtered.map((member, index) => `
        <div class="mention-item" data-username="${member.username}" data-index="${index}">
            ${member.name} (@${member.username})
        </div>
    `).join('');

    // Posicionar cerca del textarea
    const rect = textarea.getBoundingClientRect();
    suggestions.style.position = 'fixed';
    suggestions.style.top = (rect.bottom + 5) + 'px';
    suggestions.style.left = rect.left + 'px';
    suggestions.style.display = 'block';

    // Event listeners para selección
    suggestions.querySelectorAll('.mention-item').forEach(item => {
        item.addEventListener('click', () => {
            selectMention(item.dataset.username);
        });
    });
}

function selectMention(username) {
    if (!currentMentionInput) return;

    const textarea = currentMentionInput.textarea;
    const start = currentMentionInput.start;
    const end = textarea.selectionStart;
    
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);
    
    textarea.value = before + '@' + username + ' ' + after;
    textarea.focus();
    textarea.setSelectionRange(start + username.length + 2, start + username.length + 2);
    
    hideMentionSuggestions();
    currentMentionInput = null;
}


function hideMentionSuggestions() {
    const suggestions = document.getElementById('mention-suggestions');
    if (suggestions) {
        suggestions.style.display = 'none';
    }
}

async function initEnhancedFeatures() {
    await loadProjectMembers();
    setupTypingIndicator();
    setupMentions('reply-textarea');
    
    // Limpiar estados de escribiendo antiguos
    await supabaseClient
        .from('typing_status')
        .delete()
        .lt('updated_at', new Date(Date.now() - 10000).toISOString());
}

    
    async function toggleDiscussionLike(discussionId) {
    try {
        // Verificar si ya existe un like del usuario
        const { data: existingLike, error: checkError } = await supabaseClient
            .from('discussion_likes')
            .select('id')
            .eq('discussion_id', discussionId)
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (checkError && checkError.code !== 'PGRST116') {
            console.error('Error checking existing like:', checkError);
            throw checkError;
        }

        if (existingLike) {
            // Ya tiene like - quitar like
            const { error: deleteError } = await supabaseClient
                .from('discussion_likes')
                .delete()
                .eq('id', existingLike.id);

            if (deleteError) throw deleteError;
            
            showToast('Like removido');
        } else {
            // No tiene like - agregar like
            const { error: insertError } = await supabaseClient
                .from('discussion_likes')
                .insert([{
                    discussion_id: discussionId,
                    user_id: currentUser.id
                }]);

            if (insertError) {
                // Si hay conflicto, significa que se creó entre verificación y inserción
                if (insertError.code === '23505') {
                    showToast('Ya habías dado like a esta discusión');
                    return;
                }
                throw insertError;
            }
            
            showToast('Like agregado');
        }

        // Recargar el detalle de la discusión
        await loadDiscussionDetail(discussionId);

    } catch (error) {
        console.error('Error toggling discussion like:', error);
        showToast('Error al procesar el like', 'error');
    }
}

 async function toggleReplyLike(replyId) {
    try {
        // Verificar si ya existe un like del usuario
        const { data: existingLike, error: checkError } = await supabaseClient
            .from('reply_likes')
            .select('id')
            .eq('reply_id', replyId)
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (checkError && checkError.code !== 'PGRST116') {
            console.error('Error checking existing reply like:', checkError);
            throw checkError;
        }

        if (existingLike) {
            // Ya tiene like - quitar like
            const { error: deleteError } = await supabaseClient
                .from('reply_likes')
                .delete()
                .eq('id', existingLike.id);

            if (deleteError) throw deleteError;
            
            showToast('Like removido');
        } else {
            // No tiene like - agregar like
            const { error: insertError } = await supabaseClient
                .from('reply_likes')
                .insert([{
                    reply_id: replyId,
                    user_id: currentUser.id
                }]);

            if (insertError) {
                // Si hay conflicto, significa que se creó entre verificación y inserción
                if (insertError.code === '23505') {
                    showToast('Ya habías dado like a esta respuesta');
                    return;
                }
                throw insertError;
            }
            
            showToast('Like agregado');
        }

        // Recargar respuestas
        await loadReplies(currentDiscussion.id);

    } catch (error) {
        console.error('Error toggling reply like:', error);
        showToast('Error al procesar el like', 'error');
    }
}


 async function submitReply() {
    const textarea = document.getElementById('reply-textarea');
    const content = textarea.value.trim();

    if (!content) {
        showToast('Escribe algo antes de responder', 'error');
        return;
    }

    if (!currentDiscussion) {
        showToast('Error: No hay discusión seleccionada', 'error');
        return;
    }

    try {
        const { data, error } = await supabaseClient
            .from('discussion_replies')
            .insert([{
                discussion_id: currentDiscussion.id,
                content: content,
                created_by: currentUser.id,
                parent_reply_id: null  // Respuesta directa a la discusión
            }])
            .select()
            .single();

        if (error) throw error;

        showToast('Respuesta enviada correctamente');
        textarea.value = '';

        // Recargar respuestas
        await loadReplies(currentDiscussion.id);

    } catch (error) {
        console.error('Error submitting reply:', error);
        showToast('Error al enviar la respuesta', 'error');
    }
}

        function focusReplyTextarea() {
            const textarea = document.getElementById('reply-textarea');
            if (textarea) {
                textarea.focus();
            }
        }

       // Funcionalidad de IA con análisis real usando tu backend


async function analyzeDiscussion() {
    if (!currentDiscussion) {
        showToast('No hay discusión para analizar', 'error');
        return;
    }

    const analyzeBtn = document.querySelector('.ai-analyze-btn');
    const suggestionsContainer = document.querySelector('.ai-suggestions');
    const aiPanel = document.querySelector('.ai-panel'); // Agregar esto
    
    // Mostrar estado de carga
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando...';
    analyzeBtn.disabled = true;
    aiPanel.classList.add('analyzing'); // Agregar clase de análisis

    try {
        const discussionContent = await gatherDiscussionContent();
        const analysis = await performAIAnalysis(discussionContent);
        displayAIAnalysis(analysis, suggestionsContainer);
        
    } catch (error) {
        console.error('Error en análisis de IA:', error);
        showToast('Error al analizar la discusión', 'error');
        
        suggestionsContainer.innerHTML = `
            <div style="color: #ef4444; text-align: center; padding: 20px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Error al realizar el análisis</p>
                <small>${error.message}</small>
            </div>
        `;
    } finally {
        // Restaurar botón y quitar efecto
        analyzeBtn.innerHTML = '<i class="fas fa-brain"></i> Analizar Discusión';
        analyzeBtn.disabled = false;
        aiPanel.classList.remove('analyzing'); // Quitar clase de análisis
    }
}


async function gatherDiscussionContent() {
    let content = `DISCUSIÓN EN FORO DE DESARROLLO WEB/SOFTWARE\n\n`;
    content += `Título de la discusión: ${currentDiscussion.title}\n\n`;
    content += `Contenido principal del post:\n${currentDiscussion.content}\n\n`;
    
    if (repliesHierarchy && repliesHierarchy.length > 0) {
        content += "COMENTARIOS Y RESPUESTAS DE LOS PARTICIPANTES:\n";
        
        function addRepliesRecursively(replies, indent = "") {
            replies.forEach(reply => {
                content += `${indent}${reply.author_name} comenta: "${reply.content}"\n`;
                if (reply.children && reply.children.length > 0) {
                    addRepliesRecursively(reply.children, indent + "  ");
                }
            });
        }
        
        addRepliesRecursively(repliesHierarchy);
    } else {
        content += "\n(No hay comentarios aún en esta discusión)";
    }
    
    content += `\n\nCONTEXTO: Esta es una discusión en un foro de desarrollo de software/web. Analiza el contenido específico y proporciona sugerencias relevantes al tema discutido.`;
    
    return content;
}



async function performAIAnalysis(content) {
    // CAMBIO PRINCIPAL: llamar a TU backend en lugar de la API directa
    const response = await fetch('https://open-analy.vercel.app/api/analyze-discussion', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content })
    });

    if (!response.ok) {
        throw new Error(`Error del servidor: ${response.status}`);
    }

    const result = await response.json();
    
    // Si el backend devolvió un resultado exitoso
    if (result.success) {
        return result.data;
    }
    
    // Si hay un fallback, usarlo
    if (result.fallback) {
        return result.fallback;
    }
    
    throw new Error('Respuesta inesperada del servidor');
}

function displayAIAnalysis(analysis, container) {
    container.innerHTML = `
        <div class="ai-analysis-results">
            <!-- Resumen -->
            <div class="analysis-section">
                <h4 class="analysis-title">📋 Resumen</h4>
                <p class="analysis-content">${analysis.resumen}</p>
            </div>

            <!-- Temas Principales -->
            <div class="analysis-section">
                <h4 class="analysis-title">🎯 Temas Principales</h4>
                <div class="topics-list">
                    ${analysis.temas_principales.map(tema => 
                        `<span class="topic-tag">${tema}</span>`
                    ).join('')}
                </div>
            </div>

            <!-- Métricas -->
            <div class="analysis-section">
                <h4 class="analysis-title">📊 Análisis</h4>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <span class="metric-label">Sentimiento:</span>
                        <span class="metric-value sentiment-${analysis.sentimiento_general}">
                            ${analysis.sentimiento_general.charAt(0).toUpperCase() + analysis.sentimiento_general.slice(1)}
                        </span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Engagement:</span>
                        <span class="metric-value engagement-${analysis.nivel_engagement}">
                            ${analysis.nivel_engagement.charAt(0).toUpperCase() + analysis.nivel_engagement.slice(1)}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Puntos Clave -->
            <div class="analysis-section">
                <h4 class="analysis-title">🔑 Puntos Clave</h4>
                <ul class="key-points-list">
                    ${analysis.puntos_clave.map(punto => 
                        `<li>${punto}</li>`
                    ).join('')}
                </ul>
            </div>

            <!-- Sugerencias -->
            <div class="analysis-section">
                <h4 class="analysis-title">💡 Sugerencias</h4>
                <div class="suggestions-list">
                    ${analysis.sugerencias.map(sugerencia => `
                        <div class="suggestion-card">
                            <div class="suggestion-title">${sugerencia.titulo}</div>
                            <div class="suggestion-desc">${sugerencia.descripcion}</div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Recomendaciones para Moderador -->
            ${currentUserRole === 'admin' || currentUserRole === 'owner' ? `
            <div class="analysis-section moderator-section">
                <h4 class="analysis-title">👮‍♂️ Para Moderadores</h4>
                <p class="analysis-content">${analysis.recomendaciones_moderador}</p>
            </div>
            ` : ''}
        </div>
    `;
}



        // Modal functions
        function showNewDiscussionModal() {
            const modal = document.getElementById('new-discussion-modal');
            const titleInput = document.getElementById('discussion-title');
            
            if (modal) {
                modal.classList.add('show');
            }
            if (titleInput) {
                titleInput.focus();
            }
        }

        function closeNewDiscussionModal() {
            const modal = document.getElementById('new-discussion-modal');
            const titleInput = document.getElementById('discussion-title');
            const contentInput = document.getElementById('discussion-content');
            
            if (modal) {
                modal.classList.remove('show');
            }
            if (titleInput) {
                titleInput.value = '';
            }
            if (contentInput) {
                contentInput.value = '';
            }
        }

        async function createNewDiscussion() {
            const titleEl = document.getElementById('discussion-title');
            const contentEl = document.getElementById('discussion-content');
            
            if (!titleEl || !contentEl) {
                showToast('Error en el formulario', 'error');
                return;
            }
            
            const title = titleEl.value.trim();
            const content = contentEl.value.trim();
            
            if (!title) {
                showToast('El título es obligatorio', 'error');
                return;
            }
            
            if (!content) {
                showToast('El contenido es obligatorio', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('discussions')
                    .insert([{
                        project_id: currentProject.id,
                        title: title,
                        content: content,
                        created_by: currentUser.id
                    }])
                    .select()
                    .single();

                if (error) throw error;
                
                showToast('Discusión creada correctamente');
                closeNewDiscussionModal();
                
                await loadDiscussions();

            } catch (error) {
                console.error('Error creating discussion:', error);
                showToast('Error al crear la discusión', 'error');
            }
        }

        // Utility functions
        async function handleLogout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error logging out:', error);
                showToast('Error al cerrar sesión', 'error');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            
            if (sidebar && mainContent) {
                sidebar.classList.toggle('hidden');
                mainContent.classList.toggle('expanded');
            }
        }

        function redirectToHome(reason) {
            console.log('Redirecting to home:', reason);
            showToast(reason, 'error');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // ESC para cerrar modal o volver
            if (e.key === 'Escape') {
                const modal = document.getElementById('new-discussion-modal');
                if (modal && modal.classList.contains('show')) {
                    closeNewDiscussionModal();
                } else if (currentView === 'discussion-detail') {
                    showDiscussionsList();
                }
            }
            
            // Ctrl+Enter para enviar respuesta
            if (e.ctrlKey && e.key === 'Enter') {
                const textarea = document.getElementById('reply-textarea');
                if (textarea && document.activeElement === textarea) {
                    submitReply();
                }
            }
        });
        // Inicializar tema e idioma
function initializeThemeAndLanguage() {
    document.body.setAttribute('data-theme', currentTheme);
    updateThemeIcon();
    updateLanguageContent();
    generateLanguageDropdown();
}

// Cambiar tema
function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', currentTheme);
    localStorage.setItem('theme', currentTheme);
    updateThemeIcon();
}

function updateThemeIcon() {
    const themeIcon = document.querySelector('.control-btn i.fa-moon, .control-btn i.fa-sun');
    if (themeIcon) {
        themeIcon.className = `fas fa-${currentTheme === 'dark' ? 'sun' : 'moon'}`;
    }
}

// Generar dropdown de idiomas
function generateLanguageDropdown() {
    const dropdown = document.getElementById('languageDropdown');
    if (dropdown) {
        dropdown.innerHTML = Object.entries(supportedLanguages).map(([code, lang]) => 
            `<div class="language-option ${currentLanguage === code ? 'active' : ''}" 
                  onclick="changeLanguage('${code}')">
                ${lang.flag} ${lang.name}
             </div>`
        ).join('');
    }
}

// Cambiar idioma
function changeLanguage(lang) {
    if (supportedLanguages[lang]) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);
        updateLanguageContent();
        generateLanguageDropdown();
        
        const dropdown = document.getElementById('languageDropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }
}

// Actualizar contenido del idioma
function updateLanguageContent() {
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach(element => {
        const key = element.getAttribute('data-i18n');
        const translation = t(key);
        if (translation && translation !== key) {
            element.textContent = translation;
        }
    });
}

// Toggle dropdown con posicionamiento fijo
function toggleLanguageDropdown() {
    const dropdown = document.getElementById('languageDropdown');
    const button = dropdown.parentElement.querySelector('.control-btn');
    
    if (dropdown) {
        dropdown.classList.toggle('show');
        if (dropdown.classList.contains('show')) {
            const rect = button.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.style.right = (window.innerWidth - rect.right) + 'px';
        }
    }
}

// Cerrar dropdown al hacer clic fuera
document.addEventListener('click', function(event) {
    const languageSelector = document.querySelector('.language-selector');
    const dropdown = document.getElementById('languageDropdown');
    
    if (dropdown && languageSelector && !languageSelector.contains(event.target)) {
        dropdown.classList.remove('show');
    }
});


        // Exponer funciones globales
        window.toggleTheme = toggleTheme;
        
        window.deleteDiscussion = deleteDiscussion;
        window.showDeleteModal = showDeleteModal;
        window.closeDeleteModal = closeDeleteModal;
        window.confirmDeleteDiscussion = confirmDeleteDiscussion;
        window.deleteDiscussionFromDetail = deleteDiscussionFromDetail;
         window.toggleLanguageDropdown = toggleLanguageDropdown;
        window.changeLanguage = changeLanguage;
        window.deleteDiscussionFromDetail = deleteDiscussionFromDetail;
        window.toggleReaction = toggleReaction;
         window.toggleDiscussionStatus = toggleDiscussionStatus;
        window.selectMention = selectMention;
        window.expandNestedReplies = expandNestedReplies;
        window.collapseNestedReplies = collapseNestedReplies;
        window.showInlineReplyForm = showInlineReplyForm;
        window.hideInlineReplyForm = hideInlineReplyForm;
        window.submitInlineReply = submitInlineReply;
        window.showDiscussionsList = showDiscussionsList;
        window.openDiscussion = openDiscussion;
        window.toggleDiscussionLike = toggleDiscussionLike;
        window.toggleReplyLike = toggleReplyLike;
        window.submitReply = submitReply;
        window.focusReplyTextarea = focusReplyTextarea;
        window.analyzeDiscussion = analyzeDiscussion;
        window.showNewDiscussionModal = showNewDiscussionModal;
        window.closeNewDiscussionModal = closeNewDiscussionModal;
        window.createNewDiscussion = createNewDiscussion;
    </script>
</body>
</html>