<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat - Agora</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.agora.io/sdk/release/AgoraRTC_N-4.20.2.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="css/noti.css">

<style>
    * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* Variables CSS para altura móvil */
:root {
    --vh: 1vh;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: #ffffff;
    height: 100vh;
    display: flex;
    overflow: hidden;
}






/* Tema oscuro por defecto */
body:not([data-theme="light"]) {
    background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0f1419 100%);
    color: white;
}

/* Tema claro */
[data-theme="light"] body {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
    color: #1e293b;
}

/* Clase para layout móvil */
.mobile-layout {
    height: calc(var(--vh, 1vh) * 100);
}

/* Efectos de toque móvil */
.touching {
    opacity: 0.7 !important;
    transform: scale(0.95) !important;
    transition: all 0.1s ease;
}

/* === SIDEBAR CON HOVER === */
.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 80px;
    height: 100vh;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border-right: 1px solid rgba(74, 158, 255, 0.2);
    padding: 20px 12px;
    z-index: 100;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

.sidebar:hover {
    width: 260px;
    padding: 20px;
}

.sidebar.hidden {
    transform: translateX(-100%);
}

.logo {
    display: flex;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    color: #4a9eff;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
    white-space: nowrap;
    overflow: hidden;
    justify-content: center;
}

.sidebar:hover .logo {
    margin-bottom: 40px;
    padding-bottom: 20px;
    justify-content: flex-start;
}

.logo-icon {
    width: 36px;
    height: 36px;
    margin-right: 0;
    background: linear-gradient(45deg, #4a9eff, #00d4ff);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.sidebar:hover .logo-icon {
    margin-right: 12px;
    width: 32px;
    height: 32px;
}

.logo-text {
    width: 0;
    opacity: 0;
    transition: all 0.3s ease;
    overflow: hidden;
}

.sidebar:hover .logo-text {
    width: auto;
    opacity: 1;
}

.nav-menu {
    list-style: none;
}

.nav-item {
    margin-bottom: 8px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 14px 8px;
    color: #8892a6;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s ease;
    font-size: 14px;
    position: relative;
    white-space: nowrap;
    overflow: hidden;
    justify-content: center;
}

.sidebar:hover .nav-link {
    justify-content: flex-start;
    padding: 14px 16px;
}

.nav-link:hover, .nav-link.active {
    background: rgba(74, 158, 255, 0.15);
    color: #4a9eff;
}

.sidebar:hover .nav-link:hover, 
.sidebar:hover .nav-link.active {
    transform: translateX(4px);
}

.nav-link i {
    margin-right: 0;
    width: 20px;
    text-align: center;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.sidebar:hover .nav-link i {
    margin-right: 14px;
}

.nav-link-text {
    width: 0;
    opacity: 0;
    transition: all 0.3s ease;
    overflow: hidden;
}

.sidebar:hover .nav-link-text {
    width: auto;
    opacity: 1;
}

/* Tooltips */
.nav-link::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 70px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1000;
}

.nav-link::before {
    content: '';
    position: absolute;
    left: 62px;
    top: 50%;
    transform: translateY(-50%);
    border: 6px solid transparent;
    border-right-color: rgba(0, 0, 0, 0.9);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1000;
}

.nav-link:hover::after,
.nav-link:hover::before {
    opacity: 1;
    visibility: visible;
}

.sidebar:hover .nav-link:hover::after,
.sidebar:hover .nav-link:hover::before {
    opacity: 0;
    visibility: hidden;
}

/* === MAIN CONTENT === */
.main-content {
    margin-left: 80px;
    width: calc(100% - 80px);
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: transparent;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.main-content.expanded {
    margin-left: 0;
    width: 100%;
}

/* === HEADER === */
.header {
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 21px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    z-index: 50;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 20px;
}

.menu-toggle {
    background: none;
    border: none;
    color: #8892a6;
    font-size: 18px;
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.3s ease;
    display: none;
}

.menu-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #4a9eff;
}

.page-title {
    font-size: 18px;
    font-weight: 600;
    color: #ffffff;
}

.header-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.control-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #8892a6;
     padding: 14px 13px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.control-btn:hover {
    background: rgba(74, 158, 255, 0.1);
    border-color: #4a9eff;
    color: #4a9eff;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.welcome-text {
    color: #8892a6;
    font-size: 13px;
}

.user-name {
    color: #4a9eff;
    font-weight: 600;
}

.logout-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.logout-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* === MAIN PANEL (LAYOUT HORIZONTAL) === */
.main-panel {
    flex: 1;
    display: flex;
    height: calc(100vh - 65px);
    overflow: hidden;
}

/* === CHANNELS SIDEBAR (LATERAL) === */
.channels-sidebar {
    width: 300px;
    background: rgba(15, 20, 25, 0.7);
    backdrop-filter: blur(10px);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.channels-header {
    padding: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.channels-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.channels-title h3 {
    font-size: 16px;
    font-weight: 600;
    color: #ffffff;
    display: flex;
    align-items: center;
    gap: 10px;
}

.channels-title i {
    color: #4a9eff;
}

.create-channel-btn {
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.create-channel-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
}

.channels-list {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 20px;
}

.channel-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.channel-item:hover {
    background: rgba(74, 158, 255, 0.1);
    border-color: rgba(74, 158, 255, 0.3);
    transform: translateY(-2px);
}

.channel-item.active {
    background: rgba(74, 158, 255, 0.2);
    border-color: #4a9eff;
}

.channel-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
    margin-right: 12px;
}

.channel-info {
    flex: 1;
    overflow: hidden;
}

.channel-name {
    font-weight: 600;
    color: #ffffff;
    font-size: 14px;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.channel-participants {
    font-size: 12px;
    color: #8892a6;
}

.participants-count {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.empty-channels {
    padding: 40px 20px;
    text-align: center;
    color: #8892a6;
}

.empty-channels i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-channels h4 {
    font-size: 16px;
    margin-bottom: 8px;
    color: #ffffff;
}

/* === CALL CONTENT === */
.call-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: transparent;
    position: relative;
    min-height: 0;
}



.participant-video {
    aspect-ratio: 16/9;
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 12px;
    position: relative;
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.participant-video.speaking {
    border-color: #10b981;
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
    transform: scale(1.02);
}

.participant-video.current-user {
    border-color: #4a9eff;
}

.participant-avatar {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: bold;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    border: 3px solid rgba(255, 255, 255, 0.2);
}

.participant-info {
    position: absolute;
    bottom: 12px;
    left: 12px;
    right: 12px;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    padding: 10px 12px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.participant-name {
    font-weight: 600;
    font-size: 14px;
    color: #ffffff;
}

.participant-status {
    display: flex;
    gap: 4px;
}

.status-icon {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    transition: all 0.2s ease;
}

.mic-on { 
    background: #10b981; 
    color: white;
}

.mic-off { 
    background: #ef4444; 
    color: white;
}

.empty-state {
    text-align: center;
    color: #8892a6;
    max-width: 400px;
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 24px;
    opacity: 0.5;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.empty-state h3 {
    font-size: 24px;
    margin-bottom: 12px;
    color: #ffffff;
}

.empty-state p {
    font-size: 16px;
    line-height: 1.5;
}

/* === CALL CONTROLS === */
.call-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(10px);
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1000;
    min-height: 100px;
}

.control-button {
    width: 60px;
    height: 60px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 20px;
    color: white;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.control-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
}

.control-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.mute-btn {
    background: linear-gradient(135deg, #10b981, #059669);
}

.mute-btn.muted {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.leave-btn {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    width: 70px;
    height: 70px;
    font-size: 24px;
    border-radius: 50%;
}

.settings-btn {
    background: linear-gradient(135deg, #6b7280, #4b5563);
}

.participants-btn {
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    position: relative;
}

.participants-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}


/* === LOADING SPINNER === */
.loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: none;
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* === TOAST === */
.toast {
    position: fixed;
    top: 24px;
    right: 24px;
    background: rgba(30, 41, 59, 0.95);
    color: white;
    padding: 16px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 2000;
    transform: translateX(400px);
    transition: transform 0.4s ease;
    backdrop-filter: blur(10px);
    border: 1px solid #334155;
    max-width: 350px;
}

.toast.show {
    transform: translateX(0);
}

.toast.success {
    border-left: 4px solid #10b981;
}

.toast.error {
    border-left: 4px solid #ef4444;
}

.toast.info {
    border-left: 4px solid #3b82f6;
}

.connection-status {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 8px 16px;
    background: rgba(30, 41, 59, 0.9);
    border-radius: 20px;
    font-size: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid #334155;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.connection-status.connected {
    color: #10b981;
    border-color: rgba(16, 185, 129, 0.3);
}

.connection-status.connecting {
    color: #f59e0b;
    border-color: rgba(245, 158, 11, 0.3);
}

.connection-status.disconnected {
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.3);
}

/* Language Selector */
.language-selector {
    position: relative;
    z-index: 999;
}

.language-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.2);
    border-radius: 12px;
    padding: 8px 0;
    min-width: 200px;
    display: none;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    z-index: 9999;
    animation: dropdownShow 0.2s ease-out;
}

@keyframes dropdownShow {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.language-dropdown.show {
    display: block;
}

.language-option {
    padding: 10px 16px;
    cursor: pointer;
    font-size: 14px;
    color: #8892a6;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}

.language-option:hover {
    background: rgba(74, 158, 255, 0.1);
    color: #4a9eff;
}

.language-option.active {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
    font-weight: 500;
}

.language-flag {
    font-size: 12px;
    font-weight: 600;
    opacity: 0.7;
    min-width: 20px;
}

.language-name {
    flex: 1;
}

/* Light theme */

.call-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 15px 20px;
    background: rgba(15, 20, 25, 0.9);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 500;
    height: 70px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.call-info h2 {
    margin: 0 0 10px 0;
    font-size: 20px;
    color: #ffffff;
}

#call-stats {
    display: flex;
    gap: 20px;
    font-size: 14px;
    color: #8892a6;
}

#call-stats span {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Vista principal de canales */
.channels-main-view {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 30px;
    overflow-y: auto;
}

.channels-header-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.channels-title-main {
    display: flex;
    align-items: center;
    gap: 15px;
}

.channels-title-main i {
    font-size: 28px;
    color: #4a9eff;
}

.channels-title-main h2 {
    font-size: 24px;
    font-weight: 600;
    color: #ffffff;
    margin: 0;
}

.create-channel-btn-main {
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.create-channel-btn-main:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(74, 158, 255, 0.4);
}

/* Grid de canales */
.channels-list-main {
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    width: 100%;
}

/* Tarjetas de canal */
.channel-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 100px;
}

.channel-card:hover {
    background: rgba(74, 158, 255, 0.1);
    border-color: rgba(74, 158, 255, 0.3);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
}

.channel-details h3 {
    font-size: 16px;
    font-weight: 600;
    color: #ffffff;
    margin: 0 0 4px 0;
}

.channel-details p {
    font-size: 13px;
    color: #8892a6;
    margin: 0;
}

.join-btn {
    background: rgba(74, 158, 255, 0.2);
    border: 1px solid #4a9eff;
    color: #4a9eff;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.join-btn:hover {
    background: #4a9eff;
    color: white;
    transform: scale(1.05);
}

/* Estado vacío */
.empty-channels-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    text-align: center;
}

.empty-channels-icon {
    font-size: 64px;
    color: #4a9eff;
    opacity: 0.5;
    margin-bottom: 20px;
}

.empty-channels-state h3 {
    font-size: 20px;
    color: #ffffff;
    margin: 0 0 10px 0;
}

.empty-channels-state p {
    font-size: 14px;
    color: #8892a6;
    margin: 0 0 20px 0;
}

/* Lista de canales en sidebar */
.channels-list-sidebar {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.channel-item-sidebar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.channel-item-sidebar:hover {
    background: rgba(74, 158, 255, 0.1);
    border-color: rgba(74, 158, 255, 0.3);
}

.channel-name-sidebar {
    flex: 1;
    margin: 0 10px;
    font-size: 14px;
    color: #ffffff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.participants-count-sidebar {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.no-channels-sidebar {
    text-align: center;
    padding: 40px 20px;
    color: #8892a6;
}

.no-channels-sidebar i {
    font-size: 36px;
    margin-bottom: 10px;
    opacity: 0.5;
}

.no-channels-sidebar h4 {
    font-size: 14px;
    margin: 10px 0;
    color: #ffffff;
}

.no-channels-sidebar p {
    font-size: 12px;
    margin: 0;
}

/* Modal de crear canal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal {
    background: rgba(30, 41, 59, 0.95);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { 
        transform: translateY(20px);
        opacity: 0;
    }
    to { 
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header h3 {
    font-size: 18px;
    font-weight: 600;
    color: #ffffff;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: #8892a6;
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    transition: all 0.3s ease;
}

.modal-close:hover {
    color: #ef4444;
}

.modal-body {
    padding: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    color: #8892a6;
}

.form-group input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #ffffff;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: #4a9eff;
    background: rgba(255, 255, 255, 0.08);
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
}

.btn-primary, .btn-secondary {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    border: none;
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #8892a6;
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.15);
    color: #ffffff;
}

/* === PERMISOS MODALES === */
.permission-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5000;
}

.permission-modal {
    background: rgba(30, 41, 59, 0.95);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.permission-modal-header {
    text-align: center;
    padding: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.permission-modal-header .icon {
    font-size: 48px;
    color: #4a9eff;
    margin-bottom: 15px;
}

.permission-modal-header h3 {
    font-size: 20px;
    color: #ffffff;
    margin: 0 0 10px 0;
}

.permission-modal-header p {
    color: #8892a6;
    margin: 0;
    font-size: 14px;
}

.permission-modal-body {
    padding: 20px;
}

.permission-item {
    display: flex;
    align-items: center;
    padding: 15px;
    margin-bottom: 15px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.permission-item.checking {
    border-color: #f59e0b;
}

.permission-item.granted {
    border-color: #10b981;
    background: rgba(16, 185, 129, 0.1);
}

.permission-item.denied {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

.permission-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(74, 158, 255, 0.2);
    border-radius: 8px;
    color: #4a9eff;
    margin-right: 15px;
    font-size: 18px;
}

.permission-info {
    flex: 1;
}

.permission-title {
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 4px;
}

.permission-description {
    font-size: 12px;
    color: #8892a6;
}

.permission-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: #8892a6;
}

.permission-modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn-permission {
    flex: 1;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
}

.btn-permission-primary {
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    color: white;
}

.btn-permission-primary:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
}

.btn-permission-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-permission-secondary {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #8892a6;
}

.btn-permission-secondary:hover {
    background: rgba(255, 255, 255, 0.15);
    color: #ffffff;
}

.compatibility-warning {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 15px;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    margin-bottom: 20px;
}

.compatibility-warning .icon {
    color: #ef4444;
    font-size: 20px;
    margin-top: 2px;
}

.compatibility-warning-content h4 {
    color: #ef4444;
    margin: 0 0 5px 0;
    font-size: 14px;
}

.compatibility-warning-content p {
    color: #8892a6;
    margin: 0;
    font-size: 12px;
}

.mobile-tips {
    background: rgba(74, 158, 255, 0.1);
    border: 1px solid rgba(74, 158, 255, 0.2);
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.mobile-tips h4 {
    color: #4a9eff;
    margin: 0 0 10px 0;
    font-size: 14px;
}

.mobile-tips ul {
    margin: 0;
    padding-left: 20px;
    font-size: 12px;
    color: #8892a6;
}

.mobile-tips li {
    margin-bottom: 5px;
}

.device-info {
    margin-top: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.device-info h4 {
    color: #ffffff;
    margin: 0 0 10px 0;
    font-size: 14px;
}

.device-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    font-size: 12px;
}

.device-info-item {
    color: #8892a6;
}

.device-info-value {
    color: #ffffff;
    font-weight: 500;
}

/* === RESPONSIVE MÓVIL === */
@media (max-width: 768px) {
    /* LAYOUT PRINCIPAL */
    .sidebar {
        transform: translateX(-100%);
        width: 280px;
        padding: 20px;
        z-index: 9999;
    }
    
    .sidebar.show {
        transform: translateX(0);
    }
    
    .main-content {
        margin-left: 0;
        width: 100%;
    }
    
    .menu-toggle {
        display: block;
    }
    
    /* PANEL PRINCIPAL - CAMBIO DE DIRECCIÓN */
    .main-panel {
        flex-direction: column;
        height: calc(100vh - 65px);
    }
    
    /* === SIDEBAR DE CANALES HORIZONTAL EN MÓVIL === */
    .channels-sidebar {
        width: 100%;
        height: auto;
        max-height: 180px;
        min-height: 140px;
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    /* Header del sidebar de canales más compacto */
    .channels-header {
        padding: 12px 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
    }
    
    .channels-title {
        margin-bottom: 8px;
    }
    
    .channels-title h3 {
        font-size: 14px;
        gap: 8px;
    }
    
    .create-channel-btn {
        padding: 6px 12px;
        font-size: 11px;
        gap: 4px;
    }
    
    /* === LISTA DE CANALES EN SIDEBAR MÓVIL === */
    .channels-list-sidebar {
        flex: 1;
        overflow-y: auto;
        padding: 8px 15px;
        -webkit-overflow-scrolling: touch;
    }
    
    .channel-item-sidebar {
        padding: 8px 12px;
        margin-bottom: 6px;
        border-radius: 6px;
        font-size: 12px;
        align-items: center;
        display: flex;
    }
    
    .channel-item-sidebar i {
        font-size: 14px;
        margin-right: 8px;
        color: #4a9eff;
        flex-shrink: 0;
    }
    
    .channel-name-sidebar {
        flex: 1;
        margin: 0 8px 0 0;
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .participants-count-sidebar {
        font-size: 10px;
        padding: 1px 6px;
        border-radius: 8px;
        flex-shrink: 0;
    }
    
    .no-channels-sidebar {
        padding: 20px 15px;
        text-align: center;
    }
    
    .no-channels-sidebar i {
        font-size: 24px;
        margin-bottom: 8px;
    }
    
    .no-channels-sidebar h4 {
        font-size: 12px;
        margin: 8px 0 4px 0;
    }
    
    .no-channels-sidebar p {
        font-size: 11px;
        margin: 0;
    }
    
    /* === CONTENIDO DE LLAMADA AJUSTADO === */

    
    /* === OCULTAR LA VISTA PRINCIPAL DE CANALES EN MÓVIL === */
    .channels-main-view {
        display: none !important;
    }
    
    /* === VISTA DE PARTICIPANTES CON ESPACIO PARA CONTROLES === */
    
    /* === CONTROLES DE LLAMADA FIJOS EN MÓVIL === */

    
    /* === BOTONES DE CONTROL REDIMENSIONADOS === */
    .control-button {
        width: 50px !important;
        height: 50px !important;
        font-size: 18px !important;
        border-radius: 50% !important;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    
    .leave-btn {
        width: 60px !important;
        height: 60px !important;
        font-size: 22px !important;
    }
    
  
    
    .call-header h2 {
        font-size: 16px;
        margin-bottom: 4px;
    }
    
    #call-stats {
        font-size: 11px;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    #call-stats span {
        font-size: 10px;
    }
    

    
    /* === PARTICIPANTES MÁS COMPACTOS === */
    .participant-video {
        aspect-ratio: 16/9;
        min-height: 120px;
        max-height: 150px;
    }
    
    .participant-avatar {
        width: 60px !important;
        height: 60px !important;
        font-size: 24px !important;
    }
    
    .participant-info {
        padding: 8px 10px;
        bottom: 8px;
        left: 8px;
        right: 8px;
    }
    
    .participant-name {
        font-size: 13px !important;
    }
    
    /* === ESTADOS VACÍOS MÓVIL === */
    .empty-state {
        padding: 40px 20px;
        text-align: center;
    }
    
    .empty-icon {
        font-size: 48px !important;
        margin-bottom: 16px;
    }
    
    .empty-state h3 {
        font-size: 18px !important;
        margin-bottom: 8px;
    }
    
    .empty-state p {
        font-size: 14px !important;
        margin-bottom: 16px;
    }
    
    /* === MODALES EN MÓVIL === */
    .modal-overlay {
        padding: 10px;
        align-items: center;
    }
    
    .modal {
        width: 95% !important;
        max-width: none !important;
        margin: 0;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .modal-actions {
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
    }
    
    .btn-primary, .btn-secondary {
        width: 100% !important;
        padding: 12px;
        font-size: 14px;
    }
    
    .form-group input {
        font-size: 16px;
    }
    
    /* === HEADER MÓVIL === */
    .header {
        padding: 12px 15px;
    }
    
    .header-controls {
        gap: 8px;
    }
    
    .control-btn {
        padding: 4px 6px;
        font-size: 10px;
    }
    
    .user-info {
        gap: 8px;
    }
    
    .welcome-text {
        font-size: 11px;
    }
    
    .logout-btn {
        padding: 4px 8px;
        font-size: 10px;
    }
    
    /* === CONNECTION STATUS MÓVIL === */
    .connection-status {
        bottom: 90px !important;
        right: 15px;
        font-size: 11px;
        padding: 6px 12px;
        z-index: 999;
    }
    
    /* === TOAST MÓVIL === */
    .toast {
        right: 15px;
        left: 15px;
        max-width: none;
        top: 80px;
    }
    
    /* === DROPDOWN LANGUAGE MÓVIL === */
    .language-dropdown {
        position: fixed !important;
        top: 60px !important;
        right: 10px !important;
        left: 10px !important;
        width: auto !important;
        min-width: auto !important;
    }
    
    /* === PERMISOS MODAL MÓVIL === */
    .permission-modal {
        width: 95%;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .permission-modal-actions {
        flex-direction: column;
        gap: 8px;
    }
    
    .btn-permission {
        width: 100%;
        padding: 12px;
    }
}

/* === LANDSCAPE MÓVIL === */
@media (max-width: 768px) and (orientation: landscape) {
    .channels-sidebar {
        height: 100px !important;
        max-height: 100px !important;
        min-height: 100px !important;
    }
    
    .channels-header {
        padding: 8px 15px;
    }
    
    .channels-title h3 {
        font-size: 12px;
    }
    
    .create-channel-btn {
        padding: 4px 8px;
        font-size: 10px;
    }
    
 
    
    .control-button {
        width: 45px !important;
        height: 45px !important;
        font-size: 16px !important;
    }
    
    .leave-btn {
        width: 55px !important;
        height: 55px !important;
        font-size: 20px !important;
    }
    
    .connection-status {
        bottom: 75px !important;
    }
    
    .participant-video {
        min-height: 100px;
        max-height: 120px;
    }
    
    .participant-avatar {
        width: 50px !important;
        height: 50px !important;
        font-size: 20px !important;
    }
    
    .channel-item-sidebar {
        padding: 6px 10px;
        margin-bottom: 4px;
    }
    
    .channel-name-sidebar {
        font-size: 11px;
    }
    
    .participants-count-sidebar {
        font-size: 9px;
        padding: 1px 4px;
    }
}

.participants-view {
    flex: 1;
    padding: 20px;
    padding-bottom: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    overflow-y: auto;
    min-height: 0;
    padding-top: 200px;
}

.participants-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
}
/* === PREVENIR ZOOM ACCIDENTAL === */
@media (max-width: 768px) {
    input, button, select, textarea {
        font-size: 16px !important;
    }
    
    .channel-item-sidebar,
    .control-button, 
    .join-btn, 
    .btn-primary, 
    .btn-secondary,
    .create-channel-btn,
    .create-channel-btn-main {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        user-select: none;
    }
}

/* === ANIMACIONES MÓVIL === */
@media (max-width: 768px) {
    .channel-item-sidebar:active,
    .control-button:active,
    .join-btn:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
    }
    
    .call-controls {
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
}

/* === ESCRITORIO - ASEGURAR QUE FUNCIONE NORMAL === */

/* === ESCRITORIO - ASEGURAR QUE FUNCIONE NORMAL === */
@media (min-width: 769px) {
  
    
    .channels-sidebar {
        width: 300px;
        height: auto;
        max-height: none;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: none;
    }
    
 
    

    
    .connection-status {
        bottom: 24px !important;
        right: 24px !important;
    }
}


/* === PERMISOS MODALES MEJORADOS === */
.permission-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5000;
    animation: fadeInOverlay 0.3s ease-out;
}

@keyframes fadeInOverlay {
    from { 
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    to { 
        opacity: 1;
        backdrop-filter: blur(8px);
    }
}

.permission-modal {
    background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 20, 25, 0.98));
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 20px;
    width: 90%;
    max-width: 520px;
    box-shadow: 
        0 25px 80px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.05) inset,
        0 1px 0 rgba(255, 255, 255, 0.1) inset;
    animation: slideUpModal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    overflow: hidden;
}

@keyframes slideUpModal {
    from { 
        transform: translateY(30px) scale(0.9);
        opacity: 0;
    }
    to { 
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

.permission-modal-header {
    text-align: center;
    padding: 30px 25px 20px;
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.1), rgba(16, 185, 129, 0.05));
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
}

.permission-modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, #4a9eff, #10b981, transparent);
}

.permission-modal-header .icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    background: linear-gradient(135deg, #4a9eff, #10b981);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: white;
    box-shadow: 
        0 10px 30px rgba(74, 158, 255, 0.4),
        0 0 0 3px rgba(255, 255, 255, 0.1);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.permission-modal-header h3 {
    font-size: 24px;
    color: #ffffff;
    margin: 0 0 10px 0;
    font-weight: 600;
}

.permission-modal-header p {
    color: #94a3b8;
    margin: 0;
    font-size: 16px;
    line-height: 1.5;
}

.permission-modal-body {
    padding: 25px;
}

.permission-item {
    display: flex;
    align-items: center;
    padding: 20px;
    margin-bottom: 15px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.permission-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: #6b7280;
    transition: all 0.3s ease;
}

.permission-item.checking {
    border-color: rgba(245, 158, 11, 0.4);
    background: rgba(245, 158, 11, 0.05);
    animation: checking 1.5s infinite;
}

.permission-item.checking::before {
    background: #f59e0b;
}

@keyframes checking {
    0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
    50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0.1); }
}

.permission-item.granted {
    border-color: rgba(16, 185, 129, 0.4);
    background: rgba(16, 185, 129, 0.08);
    transform: scale(1.02);
}

.permission-item.granted::before {
    background: linear-gradient(135deg, #10b981, #059669);
}

.permission-item.denied {
    border-color: rgba(239, 68, 68, 0.4);
    background: rgba(239, 68, 68, 0.08);
}

.permission-item.denied::before {
    background: #ef4444;
}

.permission-icon {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.2), rgba(74, 158, 255, 0.1));
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 12px;
    color: #4a9eff;
    margin-right: 20px;
    font-size: 20px;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.permission-item.granted .permission-icon {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
    border-color: rgba(16, 185, 129, 0.4);
    color: #10b981;
}

.permission-item.denied .permission-icon {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
    border-color: rgba(239, 68, 68, 0.4);
    color: #ef4444;
}

.permission-info {
    flex: 1;
    margin-right: 15px;
}

.permission-title {
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 6px;
    font-size: 16px;
}

.permission-description {
    font-size: 13px;
    color: #94a3b8;
    line-height: 1.4;
}

.permission-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #6b7280;
    font-weight: 500;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    min-width: 100px;
    justify-content: center;
    transition: all 0.3s ease;
}

.permission-item.granted .permission-status {
    color: #10b981;
    background: rgba(16, 185, 129, 0.15);
    border-color: rgba(16, 185, 129, 0.3);
}

.permission-item.denied .permission-status {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.15);
    border-color: rgba(239, 68, 68, 0.3);
}

.permission-item.checking .permission-status {
    color: #f59e0b;
    background: rgba(245, 158, 11, 0.15);
    border-color: rgba(245, 158, 11, 0.3);
}

.permission-modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-permission {
    flex: 1;
    padding: 16px 24px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    position: relative;
    overflow: hidden;
}

.btn-permission::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.6s ease;
}

.btn-permission:hover:not(:disabled)::before {
    left: 100%;
}

.btn-permission-primary {
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    color: white;
    box-shadow: 0 4px 15px rgba(74, 158, 255, 0.4);
}

.btn-permission-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(74, 158, 255, 0.5);
    background: linear-gradient(135deg, #5ba6ff, #3b7ced);
}

.btn-permission-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-permission-secondary {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #94a3b8;
}

.btn-permission-secondary:hover {
    background: rgba(255, 255, 255, 0.12);
    color: #ffffff;
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
}

/* Estilos mejorados para las advertencias */
.compatibility-warning {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 20px;
    background: rgba(239, 68, 68, 0.08);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 12px;
    margin-bottom: 20px;
    border-left: 4px solid #ef4444;
}

.compatibility-warning .icon {
    color: #ef4444;
    font-size: 24px;
    margin-top: 2px;
    flex-shrink: 0;
}

.compatibility-warning-content h4 {
    color: #ef4444;
    margin: 0 0 8px 0;
    font-size: 16px;
    font-weight: 600;
}

.compatibility-warning-content p {
    color: #94a3b8;
    margin: 0;
    font-size: 14px;
    line-height: 1.5;
}

.mobile-tips {
    background: rgba(74, 158, 255, 0.08);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    border-left: 4px solid #4a9eff;
}

.mobile-tips h4 {
    color: #4a9eff;
    margin: 0 0 12px 0;
    font-size: 16px;
    font-weight: 600;
}

.mobile-tips ul {
    margin: 0;
    padding-left: 20px;
    font-size: 14px;
    color: #94a3b8;
}

.mobile-tips li {
    margin-bottom: 8px;
    line-height: 1.4;
}

/* ====== ESTILOS PARA PANELES LATERALES ====== */

.settings-panel,
.participants-panel {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    z-index: 2000;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.settings-panel.show,
.participants-panel.show {
    opacity: 1;
    pointer-events: all;
}

.panel-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: -1; /* Para que esté detrás del panel-content */
}

.settings-panel,
.participants-panel {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    z-index: 2000 !important;
    pointer-events: none !important;
    opacity: 0 !important;
    transition: opacity 0.3s ease !important;
}

.settings-panel.show,
.participants-panel.show {
    opacity: 1 !important;
    pointer-events: all !important;
}

.panel-overlay {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    background: rgba(0, 0, 0, 0.6) !important;
    backdrop-filter: blur(4px) !important;
    z-index: 1 !important;
}

.panel-content {
    position: absolute !important;
    top: 0 !important;
    right: 0 !important;
    width: 350px !important;
    height: 100% !important;
    backdrop-filter: blur(20px) !important;
    border-left: 1px solid rgba(74, 158, 255, 0.3) !important;
    box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3) !important;
    transform: translateX(100%) !important;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
    z-index: 2 !important;
}

.settings-panel.show .panel-content,
.participants-panel.show .panel-content {
    transform: translateX(0) !important;
}
.panel-content {
    position: absolute;
    top: 0;
    right: 0;
    width: 350px;
    height: 100%;
    background: linear-gradient(145deg, rgba(15, 20, 25, 0.98), rgba(30, 41, 59, 0.95));
    backdrop-filter: blur(20px);
    border-left: 1px solid rgba(74, 158, 255, 0.3);
    box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.settings-panel.show .panel-content,
.participants-panel.show .panel-content {
    transform: translateX(0);
}

.panel-header {
    padding: 20px 25px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(74, 158, 255, 0.1);
    flex-shrink: 0;
}

.panel-header h3 {
    font-size: 18px;
    font-weight: 600;
    color: #ffffff;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.panel-header i {
    color: #4a9eff;
}

.panel-close {
    background: none;
    border: none;
    color: #8892a6;
    font-size: 18px;
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.panel-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #ef4444;
}

.panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px 25px;
}

/* ====== ESTILOS ESPECÍFICOS PARA CONFIGURACIÓN ====== */

.setting-group {
    margin-bottom: 25px;
}

.setting-group label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    font-weight: 500;
    color: #ffffff;
    margin-bottom: 10px;
}

.setting-group label i {
    color: #4a9eff;
    width: 16px;
}

.setting-group select {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #ffffff;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.setting-group select:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(74, 158, 255, 0.5);
}

.setting-group select:focus {
    outline: none;
    border-color: #4a9eff;
    background: rgba(255, 255, 255, 0.1);
}

.setting-group option {
    background: #1e293b;
    color: #ffffff;
    padding: 8px;
}

.audio-test {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.test-btn {
    flex: 1;
    min-width: 120px;
    padding: 10px 16px;
    background: rgba(74, 158, 255, 0.1);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 8px;
    color: #4a9eff;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.test-btn:hover {
    background: rgba(74, 158, 255, 0.2);
    border-color: #4a9eff;
}

.test-btn:active {
    transform: scale(0.98);
}

.warning-message {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 8px;
    color: #f59e0b;
    font-size: 13px;
    margin-top: 15px;
}

.warning-message i {
    color: #f59e0b;
    flex-shrink: 0;
}

/* ====== ESTILOS ESPECÍFICOS PARA PARTICIPANTES ====== */

.participants-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.participant-item {
    display: flex;
    align-items: center;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.participant-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(74, 158, 255, 0.3);
}

.participant-item.current-user {
    border-color: rgba(74, 158, 255, 0.5);
    background: rgba(74, 158, 255, 0.1);
}

.participant-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 16px;
    margin-right: 15px;
    flex-shrink: 0;
}

.participant-details {
    flex: 1;
    min-width: 0;
}

.participant-name {
    font-size: 15px;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.participant-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.join-time {
    font-size: 12px;
    color: #8892a6;
}

.participant-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.mic-status {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    transition: all 0.3s ease;
}

.mic-status.unmuted {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.mic-status.muted {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.empty-participants {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px;
    text-align: center;
    color: #8892a6;
}

.empty-participants i {
    font-size: 36px;
    margin-bottom: 15px;
    opacity: 0.5;
}

.empty-participants p {
    margin: 0;
    font-size: 14px;
}

/* ====== RESPONSIVE MÓVIL PARA PANELES ====== */

@media (max-width: 768px) {
    .panel-content {
        width: 100%;
        max-width: 350px;
        left: 50%;
        transform: translateX(-50%) translateY(100%);
        top: auto;
        bottom: 0;
        height: 70%;
        border-radius: 20px 20px 0 0;
        border-left: none;
        border-top: 1px solid rgba(74, 158, 255, 0.3);
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .settings-panel.show .panel-content,
    .participants-panel.show .panel-content {
        transform: translateX(-50%) translateY(0);
    }
    
    .panel-header {
        padding: 15px 20px;
        border-radius: 20px 20px 0 0;
    }
    
    .panel-body {
        padding: 15px 20px;
    }
    
    .setting-group {
        margin-bottom: 20px;
    }
    
    .audio-test {
        flex-direction: column;
    }
    
    .test-btn {
        min-width: auto;
    }
    
    .participant-item {
        padding: 12px;
    }
    
    .participant-avatar {
        width: 40px;
        height: 40px;
        font-size: 14px;
        margin-right: 12px;
    }
    
    .participant-name {
        font-size: 14px;
    }
}



/* ====== ANIMACIONES Y EFECTOS ====== */

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideInUp {
    from {
        transform: translateX(-50%) translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}

.panel-content {
    animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@media (max-width: 768px) {
    .panel-content {
        animation: slideInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
}

/* ====== SCROLLBAR PERSONALIZADO PARA PANELES ====== */

.panel-body::-webkit-scrollbar {
    width: 6px;
}

.panel-body::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.panel-body::-webkit-scrollbar-thumb {
    background: rgba(74, 158, 255, 0.3);
    border-radius: 3px;
}

.panel-body::-webkit-scrollbar-thumb:hover {
    background: rgba(74, 158, 255, 0.5);
}



/* User Menu Styles */
.user-menu {
    position: relative;
    display: flex;
    align-items: center;
}

.user-menu-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #ffffff;
    font-size: 14px;
}

.user-menu-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #4a9eff;
    transform: translateY(-1px);
}

.user-avatar-small {
    width: 28px;
    height: 28px;
    border-radius: 50%;

    object-fit: cover;
    flex-shrink: 0;
}

#headerUserName {
    font-weight: 500;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.user-menu-toggle i.fa-chevron-down {
    font-size: 12px;
    transition: transform 0.3s ease;
}

.user-menu-toggle:hover i.fa-chevron-down {
    transform: rotate(180deg);
}

.user-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.2);
    border-radius: 12px;
    padding: 8px 0;
    min-width: 200px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

.user-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.user-dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: #ffffff;
    text-decoration: none;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}

.user-dropdown-item:hover {
    background-color: rgba(74, 158, 255, 0.1);
    color: #4a9eff;
}

.user-dropdown-item.logout {
    color: #ff6b6b;
}

.user-dropdown-item.logout:hover {
    background-color: rgba(255, 107, 107, 0.1);
    color: #ff8a8a;
}

.user-dropdown-item i {
    width: 16px;
    text-align: center;
    font-size: 14px;
}

.user-dropdown hr {
    margin: 8px 0;
    border: none;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}







.css-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4a9eff, #00d4ff);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 11px;
    border: 2px solid #4a9eff;
    flex-shrink: 0;
    font-family: inherit;
}



.control-icon-btn {
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 6px;
    background: rgba(74, 158, 255, 0.1);
    color: #4a9eff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.2s ease;
    margin-left: 4px;
}

.control-icon-btn:hover {
    background: rgba(74, 158, 255, 0.2);
    transform: scale(1.1);
}

.control-icon-btn.kick-btn {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.control-icon-btn.kick-btn:hover {
    background: rgba(239, 68, 68, 0.2);
}

.local-mute-indicator {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* ====== TEMA CLARO COMPLETO ====== */
[data-theme="light"] {
    --bg-primary: #ffffff;
    --bg-secondary: #f8fafc;
    --bg-tertiary: #f1f5f9;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #64748b;
    --border-color: #e2e8f0;
    --border-hover: #cbd5e1;
    --accent-primary: #4a9eff;
    --accent-hover: #3b82f6;
    --success: #10b981;
    --error: #ef4444;
    --warning: #f59e0b;
}

[data-theme="light"] body {
    background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 50%, #f8fafc 100%);
    color: var(--text-primary);
}

[data-theme="light"] .sidebar {
    background: rgba(255, 255, 255, 0.95);
    border-right: 1px solid var(--border-color);
}

[data-theme="light"] .logo {
    color: var(--accent-primary);
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .nav-link {
    color: var(--text-secondary);
}

[data-theme="light"] .nav-link:hover,
[data-theme="light"] .nav-link.active {
    background: rgba(74, 158, 255, 0.1);
    color: var(--accent-primary);
}

[data-theme="light"] .header {
    background: rgba(255, 255, 255, 0.8);
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .page-title {
    color: var(--text-primary);
}

[data-theme="light"] .control-btn {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
}

[data-theme="light"] .control-btn:hover {
    background: var(--bg-secondary);
    border-color: var(--accent-primary);
    color: var(--accent-primary);
}

[data-theme="light"] .channels-sidebar {
    background: rgba(255, 255, 255, 0.9);
    border-right: 1px solid var(--border-color);
}

[data-theme="light"] .channels-header {
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .channels-title h3 {
    color: var(--text-primary);
}

[data-theme="light"] .channel-item-sidebar {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--accent-hover);
}

[data-theme="light"] .channel-item-sidebar:hover {
    background: rgba(74, 158, 255, 0.1);
    border-color: var(--accent-primary);
}

[data-theme="light"] .channel-name-sidebar {
    color: var(--text-primary);
}

[data-theme="light"] .participants-count-sidebar {
    background: rgba(74, 158, 255, 0.15);
    color: var(--accent-primary);
}

[data-theme="light"] .call-header {
    background: rgba(255, 255, 255, 0.9);
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .call-header h2 {
    color: var(--text-primary);
}

[data-theme="light"] #call-stats {
    color: var(--text-secondary);
}

[data-theme="light"] .participant-video {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    border: 2px solid var(--border-color);
}

[data-theme="light"] .participant-info {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .participant-name {
    color: var(--text-primary);
}

[data-theme="light"] .call-controls {
    background: rgba(255, 255, 255, 0.95);
    border-top: 1px solid var(--border-color);
}

[data-theme="light"] .empty-state {
    color: var(--text-secondary);
}

[data-theme="light"] .empty-state h3 {
    color: var(--text-primary);
}

[data-theme="light"] .modal {
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .modal-header {
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .modal-header h3 {
    color: var(--text-primary);
}

[data-theme="light"] .modal-close {
    color: var(--text-secondary);
}

[data-theme="light"] .form-group input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

[data-theme="light"] .form-group label {
    color: var(--text-secondary);
}

[data-theme="light"] .connection-status {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .toast {
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

[data-theme="light"] .panel-content {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
    border-left: 1px solid var(--border-color);
}

[data-theme="light"] .panel-header {
    background: rgba(74, 158, 255, 0.08);
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .panel-header h3 {
    color: var(--text-primary);
}

[data-theme="light"] .setting-group select {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

[data-theme="light"] .setting-group option {
    background: var(--bg-primary);
}

[data-theme="light"] .participant-item {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .participant-item:hover {
    background: var(--bg-secondary);
    border-color: var(--accent-primary);
}

[data-theme="light"] .participant-name {
    color: var(--text-primary);
}

[data-theme="light"] .join-time {
    color: var(--text-secondary);
}

[data-theme="light"] .user-menu-toggle {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

[data-theme="light"] .user-dropdown {
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .user-dropdown-item {
    color: var(--text-primary);
}

[data-theme="light"] .user-dropdown-item:hover {
    background: rgba(74, 158, 255, 0.1);
}

[data-theme="light"] .language-dropdown {
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .language-option {
    color: var(--text-secondary);
}

[data-theme="light"] .language-option:hover {
    background: rgba(74, 158, 255, 0.1);
    color: var(--accent-primary);
}

[data-theme="light"] .permission-modal {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
    border: 1px solid var(--border-color);
}

[data-theme="light"] .permission-modal-header {
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.08), rgba(16, 185, 129, 0.05));
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .permission-modal-header h3 {
    color: var(--text-primary);
}

[data-theme="light"] .permission-modal-header p {
    color: var(--text-secondary);
}

[data-theme="light"] .permission-item {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .permission-title {
    color: var(--text-primary);
}

[data-theme="light"] .permission-description {
    color: var(--text-secondary);
}

[data-theme="light"] .no-channels-sidebar h4 {
    color: var(--text-primary);
}

[data-theme="light"] .no-channels-sidebar p {
    color: var(--text-secondary);
}

/* ====== TEMA CLARO - COMPONENTES FALTANTES ====== */

/* Botones de control de llamada */
[data-theme="light"] .control-button {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .control-button:hover:not(:disabled) {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

[data-theme="light"] .mute-btn {
    background: linear-gradient(135deg, #10b981, #059669);
}

[data-theme="light"] .mute-btn.muted {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

[data-theme="light"] .leave-btn {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

[data-theme="light"] .settings-btn {
    background: linear-gradient(135deg, #94a3b8, #64748b);
}

[data-theme="light"] .participants-btn {
    background: linear-gradient(135deg, #4a9eff, #2563eb);
}

/* Panel de participantes - Tema claro */
[data-theme="light"] .participants-panel .panel-overlay {
    background: rgba(0, 0, 0, 0.4);
}

[data-theme="light"] .participants-list {
    border: none;
}

[data-theme="light"] .participant-item.current-user {
    border-color: var(--accent-primary);
    background: rgba(74, 158, 255, 0.1);
}

[data-theme="light"] .participant-avatar {
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    box-shadow: 0 2px 8px rgba(74, 158, 255, 0.3);
}

[data-theme="light"] .mic-status.unmuted {
    background: rgba(16, 185, 129, 0.15);
    color: #059669;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

[data-theme="light"] .mic-status.muted {
    background: rgba(239, 68, 68, 0.15);
    color: #dc2626;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

[data-theme="light"] .empty-participants i {
    color: var(--text-tertiary);
}

[data-theme="light"] .empty-participants p {
    color: var(--text-secondary);
}

/* Panel de configuración - Tema claro */
[data-theme="light"] .settings-panel .panel-overlay {
    background: rgba(0, 0, 0, 0.4);
}

[data-theme="light"] .setting-group label {
    color: var(--text-primary);
}

[data-theme="light"] .setting-group select {
    background: var(--bg-secondary);
}

[data-theme="light"] .setting-group select:hover {
    background: var(--bg-tertiary);
    border-color: var(--accent-primary);
}

[data-theme="light"] .setting-group select:focus {
    border-color: var(--accent-primary);
    background: var(--bg-primary);
}

[data-theme="light"] .test-btn {
    background: rgba(74, 158, 255, 0.1);
    border: 1px solid rgba(74, 158, 255, 0.3);
    color: var(--accent-primary);
}

[data-theme="light"] .test-btn:hover {
    background: rgba(74, 158, 255, 0.2);
    border-color: var(--accent-primary);
}

[data-theme="light"] .warning-message {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    color: #d97706;
}

[data-theme="light"] .warning-message i {
    color: #f59e0b;
}

/* Iconos de control */
[data-theme="light"] .control-icon-btn {
    background: rgba(74, 158, 255, 0.1);
    color: var(--accent-primary);
    border: 1px solid rgba(74, 158, 255, 0.2);
}

[data-theme="light"] .control-icon-btn:hover {
    background: rgba(74, 158, 255, 0.2);
}

[data-theme="light"] .control-icon-btn.kick-btn {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
    border: 1px solid rgba(239, 68, 68, 0.2);
}

[data-theme="light"] .control-icon-btn.kick-btn:hover {
    background: rgba(239, 68, 68, 0.2);
}

/* Indicador de silencio local */
[data-theme="light"] .local-mute-indicator {
    background: rgba(239, 68, 68, 0.95);
    color: white;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

/* Badge de participantes */
[data-theme="light"] .participants-badge {
    background: #ef4444;
    box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
}

/* Scrollbar personalizado - Tema claro */
[data-theme="light"] .panel-body::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
}

[data-theme="light"] .panel-body::-webkit-scrollbar-thumb {
    background: rgba(74, 158, 255, 0.3);
}

[data-theme="light"] .panel-body::-webkit-scrollbar-thumb:hover {
    background: rgba(74, 158, 255, 0.5);
}

[data-theme="light"] .channels-list-sidebar::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
}

[data-theme="light"] .channels-list-sidebar::-webkit-scrollbar-thumb {
    background: rgba(74, 158, 255, 0.3);
}

/* Vista de participantes con video */
[data-theme="light"] .participants-view {
    background: transparent;
}

[data-theme="light"] .participants-grid {
    gap: 16px;
}

[data-theme="light"] .participant-video.speaking {
    border-color: #10b981;
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
}

[data-theme="light"] .participant-video.current-user {
    border-color: var(--accent-primary);
    box-shadow: 0 0 15px rgba(74, 158, 255, 0.4);
}

/* Estados de conexión */
[data-theme="light"] .connection-status.connected {
    color: #059669;
    border-color: rgba(16, 185, 129, 0.3);
    background: rgba(255, 255, 255, 0.95);
}

[data-theme="light"] .connection-status.connecting {
    color: #d97706;
    border-color: rgba(245, 158, 11, 0.3);
    background: rgba(255, 255, 255, 0.95);
}

[data-theme="light"] .connection-status.disconnected {
    color: #dc2626;
    border-color: rgba(239, 68, 68, 0.3);
    background: rgba(255, 255, 255, 0.95);
}

/* Toast con diferentes tipos */
[data-theme="light"] .toast.success {
    border-left: 4px solid #10b981;
    background: rgba(255, 255, 255, 0.98);
}

[data-theme="light"] .toast.error {
    border-left: 4px solid #ef4444;
    background: rgba(255, 255, 255, 0.98);
}

[data-theme="light"] .toast.info {
    border-left: 4px solid #3b82f6;
    background: rgba(255, 255, 255, 0.98);
}

[data-theme="light"] .toast.warning {
    border-left: 4px solid #f59e0b;
    background: rgba(255, 255, 255, 0.98);
}

/* Botones de modal */
[data-theme="light"] .btn-primary {
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    box-shadow: 0 2px 8px rgba(74, 158, 255, 0.3);
}

[data-theme="light"] .btn-primary:hover {
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.4);
}

[data-theme="light"] .btn-secondary {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
}

[data-theme="light"] .btn-secondary:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-color: var(--border-hover);
}

/* Botones de crear canal */
[data-theme="light"] .create-channel-btn,
[data-theme="light"] .create-channel-btn-main {
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    box-shadow: 0 2px 8px rgba(74, 158, 255, 0.3);
}

[data-theme="light"] .create-channel-btn:hover,
[data-theme="light"] .create-channel-btn-main:hover {
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.4);
}

/* Join button */
[data-theme="light"] .join-btn {
    background: rgba(74, 158, 255, 0.15);
    border: 1px solid var(--accent-primary);
    color: var(--accent-primary);
}

[data-theme="light"] .join-btn:hover {
    background: var(--accent-primary);
    color: white;
}

/* Overlay de modales */
[data-theme="light"] .modal-overlay {
    background: rgba(0, 0, 0, 0.6);
}

[data-theme="light"] .permission-modal-overlay {
    background: rgba(0, 0, 0, 0.7);
}

/* Compatibilidad y avisos */
[data-theme="light"] .compatibility-warning {
    background: rgba(239, 68, 68, 0.08);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-left: 4px solid #ef4444;
}

[data-theme="light"] .compatibility-warning .icon {
    color: #ef4444;
}

[data-theme="light"] .compatibility-warning-content h4 {
    color: #dc2626;
}

[data-theme="light"] .compatibility-warning-content p {
    color: var(--text-secondary);
}

[data-theme="light"] .mobile-tips {
    background: rgba(74, 158, 255, 0.08);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-left: 4px solid var(--accent-primary);
}

[data-theme="light"] .mobile-tips h4 {
    color: var(--accent-primary);
}

[data-theme="light"] .mobile-tips ul {
    color: var(--text-secondary);
}

/* Items de permisos */
[data-theme="light"] .permission-item.checking {
    border-color: rgba(245, 158, 11, 0.4);
    background: rgba(245, 158, 11, 0.05);
}

[data-theme="light"] .permission-item.granted {
    border-color: rgba(16, 185, 129, 0.4);
    background: rgba(16, 185, 129, 0.08);
}

[data-theme="light"] .permission-item.denied {
    border-color: rgba(239, 68, 68, 0.4);
    background: rgba(239, 68, 68, 0.08);
}

[data-theme="light"] .permission-icon {
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.15), rgba(74, 158, 255, 0.08));
    border: 1px solid rgba(74, 158, 255, 0.3);
}

[data-theme="light"] .permission-item.granted .permission-icon {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.08));
    border-color: rgba(16, 185, 129, 0.4);
}

[data-theme="light"] .permission-item.denied .permission-icon {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.08));
    border-color: rgba(239, 68, 68, 0.4);
}

[data-theme="light"] .permission-status {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
}

[data-theme="light"] .permission-item.granted .permission-status {
    color: #059669;
    background: rgba(16, 185, 129, 0.1);
    border-color: rgba(16, 185, 129, 0.3);
}

[data-theme="light"] .permission-item.denied .permission-status {
    color: #dc2626;
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
}

[data-theme="light"] .permission-item.checking .permission-status {
    color: #d97706;
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.3);
}

/* Botones de permisos */
[data-theme="light"] .btn-permission-primary {
    background: linear-gradient(135deg, #4a9eff, #2563eb);
    box-shadow: 0 2px 8px rgba(74, 158, 255, 0.3);
}

[data-theme="light"] .btn-permission-primary:hover:not(:disabled) {
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.4);
}

[data-theme="light"] .btn-permission-secondary {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
}

[data-theme="light"] .btn-permission-secondary:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

/* User dropdown */
[data-theme="light"] .user-dropdown hr {
    border-top: 1px solid var(--border-color);
}

[data-theme="light"] .user-dropdown-item.logout {
    color: #dc2626;
}

[data-theme="light"] .user-dropdown-item.logout:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

/* Empty states */
[data-theme="light"] .empty-channels-state {
    color: var(--text-secondary);
}

[data-theme="light"] .empty-channels-state h3 {
    color: var(--text-primary);
}

[data-theme="light"] .empty-channels-icon {
    color: var(--accent-primary);
}

/* Menu toggle */
[data-theme="light"] .menu-toggle {
    color: var(--text-secondary);
}

[data-theme="light"] .menu-toggle:hover {
    background: var(--bg-tertiary);
    color: var(--accent-primary);
}

/* Panel close button */
[data-theme="light"] .panel-close:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}



</style>
</head>
<body>
 <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-brain"></i>
            </div>
            <div class="logo-text">OpenMind AI</div>
        </div>
        
        <nav>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link" data-tooltip="Inicio">
                        <i class="fas fa-home"></i>
                        <span class="nav-link-text">Inicio</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="discussions.html" class="nav-link" data-tooltip="Foros">
                        <i class="fas fa-comments"></i>
                        <span class="nav-link-text">Foros</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="code-editor.html" class="nav-link" data-tooltip="Editor de Código">
                        <i class="fas fa-code"></i>
                        <span class="nav-link-text">Editor de Código</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="chat-ai.html" class="nav-link" data-tooltip="MindAssist IA">
                        <i class="fas fa-robot"></i>
                        <span class="nav-link-text">MindAssist IA</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="members.html" class="nav-link" data-tooltip="Miembros">
                        <i class="fas fa-users"></i>
                        <span class="nav-link-text">Miembros</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="voice-calls.html" class="nav-link active" data-tooltip="Llamadas">
                        <i class="fas fa-phone"></i>
                        <span class="nav-link-text">Llamadas</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="settings.html" class="nav-link" data-tooltip="Configuración">
                        <i class="fas fa-cog"></i>
                        <span class="nav-link-text">Configuración</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>
<!-- Agregar dentro del body, puede ser oculto -->
<div style="display: none;">
    <div id="user-name"></div>
    <div id="user-avatar"></div>
</div>
  <!-- Main Content -->
<main class="main-content" id="main-content">
    <!-- Header -->
    <header class="header">
    
        <div class="header-left">
            <button class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="page-title">Canales de Voz</div>
        </div>
        
        <div class="header-controls">
            <button class="control-btn" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
                <span> Cambiar Tema</span>
            </button>
            
            <div class="language-selector">
                <button class="control-btn" onclick="toggleLanguageDropdown()">
                    <i class="fas fa-globe"></i>
                    <span>Idioma</span>
                </button>
                <div class="language-dropdown" id="languageDropdown">
                    <!-- Se genera dinámicamente -->
                </div>
            </div>
            
            <div class="notifications-container">
                <button class="control-btn notifications-btn" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="notificationCount" style="display: none;">0</span>
                </button>
                <div class="notifications-dropdown" id="notificationsDropdown">
                    <div class="notifications-header">
                        <h4>Notificaciones</h4>
                    </div>
                    <div class="notifications-list" id="notificationsList">
                        <div class="notification-item loading">
                            Cargando...
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="user-menu">
    <div class="user-menu-toggle" onclick="toggleUserMenu()">
        <img class="user-avatar-small" id="headerAvatarImg" src="" alt="Avatar">
        <span id="headerUserName">Cargando...</span>
        <i class="fas fa-chevron-down"></i>
    </div>
    <div class="user-dropdown" id="userDropdown">
        <a href="perfil/profile.html" class="user-dropdown-item">
            <i class="fas fa-user"></i>
            Mi Perfil
        </a>
        <a href="perfil/settings-perfil.html" class="user-dropdown-item">
            <i class="fas fa-cog"></i>
            Configuración
        </a>
        <hr style="margin: 8px 0; border: none; border-top: 1px solid var(--border-color);">
        <div class="user-dropdown-item logout" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            Cerrar Sesión
        </div>
    </div>
</div>
        </div>
    </header>

    <!-- Main Panel (Layout Horizontal) -->
    <div class="main-panel">
        <!-- Channels Sidebar (Lateral) -->
        <div class="channels-sidebar">
            <div class="channels-header">
                <div class="channels-title">
                    <h3>
                        <i class="fas fa-headphones"></i>
                        Canales de Voz
                    </h3>
                    <button class="create-channel-btn" onclick="showCreateChannelModal()">
                        <i class="fas fa-plus"></i>
                        Crear
                    </button>
                </div>
            </div>
            
            <div class="channels-list-sidebar" id="channels-list-sidebar">
                <!-- Aquí van los canales del sidebar -->
                <div class="no-channels-sidebar" id="empty-channels">
                    <i class="fas fa-headphones"></i>
                    <h4>Sin canales</h4>
                    <p>Crea el primer canal para comenzar</p>
                </div>
            </div>
        </div>



<!-- Call Content Area -->
<div class="call-content">
    <!-- CHANNELS MAIN VIEW - OCULTA POR DEFECTO -->
    <div class="channels-main-view" id="channels-main-view" style="display: none;">
        <div class="channels-header-main">
            <div class="channels-title-main">
                <i class="fas fa-headphones"></i>
                <h2>Canales de Voz</h2>
            </div>
            <button class="create-channel-btn-main" onclick="showCreateChannelModal()">
                <i class="fas fa-plus"></i>
                <span>Nuevo Canal</span>
            </button>
        </div>
        
        <div class="channels-list-main" id="channels-list-main">
            <!-- Los canales se cargarán aquí con showChannelsInMainView -->
        </div>
    </div>

    <!-- CALL VIEW - OCULTA POR DEFECTO -->
    <div class="call-view" id="call-view" style="display: none;">
        <div class="call-header">
            <div class="call-info">
                <h2 id="current-channel-name">Canal</h2>
                <div id="call-stats" style="display: none;">
                    <span>Duración: <span id="call-duration">00:00</span></span>
                    <span>Participantes: <span id="participants-count">0</span></span>
                    <span>Calidad: <span id="connection-quality">Buena</span></span>
                </div>
            </div>
        </div>
        
        <div class="participants-view">
            <div id="participants-container">
                <!-- participantes se cargan aquí -->
            </div>
        </div>
        
        <!-- Controles de llamada -->
        <div class="call-controls" id="call-controls">
            <button class="control-button mute-btn" id="mute-btn" onclick="toggleMute()" title="Silenciar/Activar micrófono">
                <i class="fas fa-microphone"></i>
                <div class="loading-spinner"></div>
            </button>
            
            <button class="control-button settings-btn" onclick="openSettings()" title="Configuración">
                <i class="fas fa-cog"></i>
            </button>
            
            <button class="control-button participants-btn" onclick="toggleParticipants()" title="Participantes">
                <i class="fas fa-users"></i>
                <span class="participants-badge" id="participants-badge">0</span>
            </button>
            
            <button class="control-button leave-btn" id="leave-btn" onclick="leaveChannel()" title="Salir de la llamada">
                <i class="fas fa-phone"></i>
                <div class="loading-spinner"></div>
            </button>
        </div>
    </div>

    <!-- VISTA POR DEFECTO - SELECCIONAR CANAL -->
    <div class="default-view" id="default-view" style="display: flex;">
        <div class="participants-view">
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-headphones"></i>
                </div>
                <h3>Selecciona un canal de voz</h3>
                <p>Elige un canal del sidebar para unirte y comenzar a colaborar con tu equipo</p>
            </div>
        </div>
    </div>
</div>
    </div>
</main>

    <!-- Connection Status -->
    <div class="connection-status" id="connection-status">
        <i class="fas fa-circle"></i>
        <span>Conectando...</span>
    </div>

    <!-- Toast Container -->
    <div class="toast" id="toast">
        <span id="toast-message"></span>
    </div>


    <script src="js/project-session.js"></script>
    <script src="js/noti.js"></script>
   
   <script>
        // Configuración
        const SUPABASE_URL = 'https://jatcscioqvicmiofsuqt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphdGNzY2lvcXZpY21pb2ZzdXF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2ODUwNDcsImV4cCI6MjA3MjI2MTA0N30.wZ2dXWG7jq7zhzorqKoQYF7I6xz49k2xaFsouQRscGQ';
        const AGORA_APP_ID = 'c74bac3459c14a88ab92f0c4c78401cc'; 
        const PERMISSIONS_STORAGE_KEY = 'voice_chat_permissions_granted';

        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Variables globales
        let currentUser = null;
        let currentUserId = null;
        let currentUserName = null;
        let currentProjectId = null;
        let currentChannelId = null;
        let currentChannelName = null;
        let agoraClient = null;
        let localAudioTrack = null;
        let remoteUsers = {};
        let isMuted = false;
        let callStartTime = null;
        let currentUserRole = null; // 'owner', 'admin', 'member'
let locallyMutedUsers = new Set(); // Usuarios silenciados localmente
let forceMutedByOwner = false; // Si el owner me silenció
        let callDurationInterval = null;
        let roomChannel = null;
        let isInChannel = false;
        // Variables para tema e idioma
let currentTheme = localStorage.getItem('theme') || 'dark';
let currentLanguage = localStorage.getItem('language') || 'es';
let permissionsGranted = {
    microphone: false,
    notifications: false
};
let deviceInfo = {};
let channelParticipantCounts = {}; // Para rastrear participantes por canal
let audioDevices = {
    microphones: [],
    speakers: []
};
let selectedSpeaker = null;
let participantsPanelOpen = false;
let settingsPanelOpen = false;

// Idiomas soportados
const supportedLanguages = {
    'en': { name: 'English', flag: '🇺🇸' },
    'es': { name: 'Español', flag: '🇪🇸' },
    'fr': { name: 'Français', flag: '🇫🇷' },
    'de': { name: 'Deutsch', flag: '🇩🇪' },
    'it': { name: 'Italiano', flag: '🇮🇹' },
    'pt': { name: 'Português', flag: '🇵🇹' },
    'ru': { name: 'Русский', flag: '🇷🇺' },
    'ja': { name: '日本語', flag: '🇯🇵' },
    'ko': { name: '한국어', flag: '🇰🇷' },
    'zh': { name: '中文', flag: '🇨🇳' },
    'ar': { name: 'العربية', flag: '🇸🇦' },
    'hi': { name: 'हिंदी', flag: '🇮🇳' },
    'nl': { name: 'Nederlands', flag: '🇳🇱' }
};

// Traducciones
const translations = {
    es: {
        'common.themeToggle': 'Cambiar Tema',
        'common.language': 'Idioma'
    },
    en: {
        'common.themeToggle': 'Toggle Theme',
        'common.language': 'Language'
    }
};

// Función para obtener traducción
function t(key) {
    return translations[currentLanguage] && translations[currentLanguage][key] 
        ? translations[currentLanguage][key] 
        : translations['es'][key] || key;
}

        // Inicializar Agora
        AgoraRTC.setLogLevel(1);


async function initializeApp() {
    updateConnectionStatus('connecting', 'Conectando...');
    
    try {
        // Verificar que tenemos las credenciales necesarias
        if (!AGORA_APP_ID) {
            throw new Error('Falta configuración de Agora App ID');
        }
        
        // Verificar compatibilidad del dispositivo
        const compatibility = checkDeviceCompatibility();
        if (!compatibility.isCompatible) {
            console.warn('Dispositivo con problemas de compatibilidad:', compatibility.issues);
        }
        
        // Crear cliente de Agora
        agoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
        
        // Configurar event listeners de Agora
        agoraClient.on('user-published', handleUserPublished);
        agoraClient.on('user-unpublished', handleUserUnpublished);
        agoraClient.on('user-joined', handleUserJoined);
        agoraClient.on('user-left', handleUserLeft);
        agoraClient.on('connection-state-change', handleConnectionStateChange);
        agoraClient.on('network-quality', handleNetworkQuality);
        
        // Token listeners
        agoraClient.on('token-privilege-will-expire', async () => {
            console.log('Token por expirar, renovando...');
            try {
                const { token } = await getAgoraToken();
                await agoraClient.renewToken(token);
                showToast('Sesión renovada', 'info');
            } catch (error) {
                console.error('Error renovando token:', error);
                showToast('Error al renovar sesión', 'error');
            }
        });
        
        agoraClient.on('token-privilege-did-expire', async () => {
            console.error('Token expirado');
            showToast('Sesión expirada, reconectando...', 'warning');
            await leaveChannel();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        });
        
        await loadProjectInfo();
        await loadAndShowChannels();
        await loadAllChannelParticipantCounts();
        await loadUserRole();
console.log('Rol del usuario:', currentUserRole);
        
        updateConnectionStatus('connected', 'Conectado');
        
    } catch (error) {
        console.error('Error al inicializar:', error);
        updateConnectionStatus('disconnected', 'Error de conexión');
        
        let errorMessage = 'Error al conectar con el servidor';
        if (error.message?.includes('token')) {
            errorMessage = 'Error de autenticación. Verifica la configuración del servidor.';
        } else if (error.message?.includes('network')) {
            errorMessage = 'Error de red. Verifica tu conexión a internet.';
        } else if (error.message?.includes('Agora')) {
            errorMessage = 'Error de configuración. Contacta al administrador.';
        }
        
        showToast(errorMessage, 'error');
    }
}


        async function loadProjectInfo() {
            try {
                const { data: project, error } = await supabase
                    .from('projects')
                    .select('name')
                    .eq('id', currentProjectId)
                    .single();

                if (error) throw error;
                
                // Actualizar info del proyecto en sidebar si es necesario
            } catch (error) {
                console.error('Error cargando info del proyecto:', error);
            }
        }

        // FUNCIÓN CORREGIDA PARA CARGAR Y MOSTRAR CANALES
async function loadAndShowChannels() {
    try {
        const channels = await loadVoiceChannels();
        
        // Solo mostrar canales en el sidebar
        showChannelsInSidebar(channels);
        
        // Mostrar la vista por defecto (seleccionar canal)
        showDefaultView();
        
    } catch (error) {
        console.error('Error cargando canales:', error);
        showToast('Error al cargar los canales', 'error');
    }
}


async function checkIfForceMuted() {
    try {
        const { data } = await supabase
            .from('voice_channel_controls')
            .select('*')
            .eq('channel_id', currentChannelId)
            .eq('user_id', currentUserId)
            .eq('action_type', 'mute')
            .maybeSingle();
        
        forceMutedByOwner = !!data;
        
        if (forceMutedByOwner && localAudioTrack) {
            await localAudioTrack.setEnabled(false);
            isMuted = true;
            updateMuteButton();
            showToast('El owner te ha silenciado', 'warning');
        }
        
        return forceMutedByOwner;
    } catch (error) {
        console.error('Error verificando mute:', error);
        return false;
    }
}

function showDefaultView() {
    document.getElementById('default-view').style.display = 'flex';
    document.getElementById('channels-main-view').style.display = 'none';
    document.getElementById('call-view').style.display = 'none';
}



async function loadUserRole() {
    try {
        // Obtener el proyecto actual
        const { data: project } = await supabase
            .from('projects')
            .select('owner_id')
            .eq('id', currentProjectId)
            .single();
        
        if (project && project.owner_id === currentUserId) {
            currentUserRole = 'owner';
            return;
        }
        
        // Si no es owner, verificar membresía
        const { data: member } = await supabase
            .from('project_members')
            .select('role')
            .eq('project_id', currentProjectId)
            .eq('user_id', currentUserId)
            .single();
        
        currentUserRole = member ? member.role : 'member';
        
    } catch (error) {
        console.error('Error cargando rol:', error);
        currentUserRole = 'member';
    }
}


// Mostrar vista de canales (NO SE USA - mantener por compatibilidad)
function showChannelsView() {
    document.getElementById('default-view').style.display = 'none';
    document.getElementById('channels-main-view').style.display = 'none';
    document.getElementById('call-view').style.display = 'none';
    
    // Mostrar vista por defecto en su lugar
    showDefaultView();
}

// Mostrar vista de llamada (cuando se une a un canal)
function showCallView() {
    document.getElementById('default-view').style.display = 'none';
    document.getElementById('channels-main-view').style.display = 'none';
    document.getElementById('call-view').style.display = 'flex';
}


        async function createVoiceChannel(channelName, description = '') {
            try {
                const { data, error } = await supabase
                    .from('voice_channels')
                    .insert([
                        {
                            project_id: currentProjectId,
                            name: channelName, // CORREGIDO: usar 'name' consistentemente
                            description: description,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }
                    ])
                    .select()
                    .single();

                if (error) throw error;
                
                showToast(`Canal "${channelName}" creado exitosamente`, 'success');
                
                // CORREGIDO: Recargar la lista de canales después de crear uno
                await loadAndShowChannels();
                
                return data;
            } catch (error) {
                console.error('Error creando canal:', error);
                showToast('Error al crear el canal de voz', 'error');
                throw error;
            }
        }

        async function loadVoiceChannels() {
            try {
                const { data: channels, error } = await supabase
                    .from('voice_channels')
                    .select('*')
                    .eq('project_id', currentProjectId)
                    .order('created_at', { ascending: true });

                if (error) throw error;
                
                return channels || [];
            } catch (error) {
                console.error('Error cargando canales:', error);
                return [];
            }
        }

        // FUNCIÓN CORREGIDA PARA MOSTRAR CANALES EN SIDEBAR
       function showChannelsInSidebar(channels) {
    const sidebarList = document.getElementById('channels-list-sidebar');
    
    if (!channels || channels.length === 0) {
        sidebarList.innerHTML = `
            <div class="no-channels-sidebar">
                <i class="fas fa-headphones"></i>
                <h4>Sin canales</h4>
                <p>Crea el primer canal para comenzar</p>
            </div>
        `;
        return;
    }
    
    sidebarList.innerHTML = channels.map(channel => `
        <div class="channel-item-sidebar" onclick="joinSpecificChannel('${channel.id}', '${channel.name}')" data-channel-id="${channel.id}">
            <i class="fas fa-volume-up"></i>
            <span class="channel-name-sidebar" title="${channel.name}">${channel.name}</span>
            <span class="participants-count-sidebar">0</span>
        </div>
    `).join('');
}

        function showEmptyChannelState() {
            const container = document.getElementById('participants-container');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <h3>No hay canales de voz</h3>
                    <p>Crea el primer canal de voz para comenzar a colaborar con tu equipo</p>
                </div>
            `;
        }

        function showChannelSelectionState() {
            const container = document.getElementById('participants-container');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-headphones"></i>
                    </div>
                    <h3>Selecciona un canal de voz</h3>
                    <p>Elige un canal del sidebar para unirte y comenzar a colaborar</p>
                </div>
            `;
        }

        function showCreateChannelModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>Crear Canal de Voz</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="channel-name-input">Nombre del canal *</label>
                            <input type="text" id="channel-name-input" placeholder="Ej: Reunión diaria" maxlength="50" required>
                        </div>
                        <div class="form-group">
                            <label for="channel-description-input">Descripción (opcional)</label>
                            <input type="text" id="channel-description-input" placeholder="Ej: Canal para reuniones diarias del equipo" maxlength="200">
                        </div>
                        <div class="modal-actions">
                            <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                                Cancelar
                            </button>
                            <button class="btn-primary" onclick="handleCreateChannel()">
                                Crear Canal
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('channel-name-input').focus();
            
            // Permitir crear con Enter
            document.getElementById('channel-name-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleCreateChannel();
                }
            });
        }

// FUNCIÓN PARA MANEJAR CREACIÓN DE CANAL
async function handleCreateChannel() {
    const nameInput = document.getElementById('channel-name-input');
    const descriptionInput = document.getElementById('channel-description-input');
    const channelName = nameInput.value.trim();
    const channelDescription = descriptionInput.value.trim();
    
    if (!channelName) {
        showToast('Por favor ingresa un nombre para el canal', 'warning');
        nameInput.focus();
        return;
    }
    
    try {
        // Verificar si ya existe un canal con ese nombre
        const { data: existingChannel } = await supabase
            .from('voice_channels')
            .select('id')
            .eq('project_id', currentProjectId)
            .eq('name', channelName)
            .single();
            
        if (existingChannel) {
            showToast('Ya existe un canal con ese nombre', 'warning');
            nameInput.focus();
            return;
        }
        
        const channel = await createVoiceChannel(channelName, channelDescription);
        document.querySelector('.modal-overlay').remove();
        
        // Recargar canales en el sidebar
        await loadAndShowChannels();
        
        showToast(`Canal "${channelName}" creado exitosamente`, 'success');
        
        // Opcional: unirse automáticamente al canal creado
        // await joinSpecificChannel(channel.id, channel.name);
        
    } catch (error) {
        console.error('Error al crear canal:', error);
        showToast('Error al crear el canal', 'error');
    }
}


async function joinSpecificChannel(channelId, channelName) {
    try {
        // Si ya estamos en un canal, salir primero
        if (isInChannel && currentChannelId !== channelId) {
            await leaveChannelInternal();
        }
        
        currentChannelId = channelId;
        currentChannelName = channelName;
        
        // Cambiar a vista de llamada
        showCallView();
        
        // Actualizar UI
        document.getElementById('current-channel-name').textContent = channelName;
        document.getElementById('call-stats').style.display = 'flex';
        document.getElementById('call-controls').style.display = 'flex';
        
        // Mostrar estado de carga en la vista de llamada
        const container = document.getElementById('participants-container');
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-circle-notch fa-spin"></i>
                </div>
                <h3>Conectando...</h3>
                <p>Uniéndote al canal "${channelName}"</p>
            </div>
        `;
        
        updateConnectionStatus('connecting', 'Conectando al canal...');
        
        await joinVoiceChannel();
        
    } catch (error) {
        console.error('Error al unirse al canal:', error);
        showToast('Error al unirse al canal', 'error');
        await backToChannelsList();
    }
}


async function backToChannelsList() {
    try {
        // Si estamos en un canal, salir
        if (isInChannel) {
            await leaveChannelInternal();
        }
        
        // Limpiar variables de canal actual
        currentChannelId = null;
        currentChannelName = null;
        
        // Volver a vista por defecto
        showDefaultView();
        
        // Recargar la lista de canales en el sidebar
        await loadAndShowChannels();
        
        updateConnectionStatus('connected', 'Conectado');
        showToast('Has salido del canal', 'info');
        
    } catch (error) {
        console.error('Error al volver a canales:', error);
        showToast('Error al salir del canal', 'error');
    }
}


        // FUNCIÓN CORREGIDA PARA UNIRSE AL CANAL DE VOZ
        async function joinVoiceChannel() {
            try {
                // Obtener token y UID desde el backend
                const { token, uid } = await getAgoraToken();
                
                // Verificar si estamos en móvil para usar configuración optimizada
                const isMobile = detectDeviceInfo().isMobile;
                
                // Unirse al canal de Agora usando el channelId como nombre del canal
                await agoraClient.join(AGORA_APP_ID, currentChannelId, token, uid);
                
                // Guardar el UID numérico para uso posterior
                window.currentUserNumericUid = uid;
                
                // Crear track de audio con configuración optimizada según dispositivo
                let audioConfig;
                if (isMobile) {
                    audioConfig = {
                        encoderConfig: 'music_standard', // Mejor compatibilidad móvil
                        AEC: true,
                        ANS: true,
                        AGC: true,
                        sampleRate: 44100,
                        channelCount: 1
                    };
                } else {
                    audioConfig = {
                        encoderConfig: 'high_quality',
                        AEC: true,
                        ANS: true,
                        AGC: true
                    };
                }
                
                localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack(audioConfig);
                
                await agoraClient.publish([localAudioTrack]);
                
                isInChannel = true;
                callStartTime = new Date();
                startCallDurationTimer();
                
                // Unirse al canal de Supabase para presencia
                await joinRealtimeChannel();
                // Verificar si estamos silenciados
                await checkIfForceMuted();
                
                showToast(`Te uniste al canal "${currentChannelName}"`, 'success');
                updateConnectionStatus('connected', 'Conectado al canal');
                
            } catch (error) {
                console.error('Error al unirse al canal:', error);
                
                let errorMessage = 'Error al conectar con el servidor de voz';
                
                if (error.message?.includes('token')) {
                    errorMessage = 'Error de autenticación con el servidor de voz';
                } else if (error.message?.includes('network')) {
                    errorMessage = 'Error de red. Verifica tu conexión a internet';
                } else if (error.code === 'PERMISSION_DENIED') {
                    errorMessage = 'Permisos de micrófono denegados';
                } else if (error.code === 'DEVICE_NOT_FOUND') {
                    errorMessage = 'No se encontró ningún micrófono';
                } else if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permisos de micrófono denegados. Intenta recargar la página y dar permisos nuevamente.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No se encontró micrófono en tu dispositivo';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'El micrófono está siendo usado por otra aplicación';
                }
                
                showToast(errorMessage, 'error');
                updateConnectionStatus('disconnected', 'Error de conexión');
                throw error;
            }
        }

        async function getAgoraToken() {
            try {
                const BACKEND_URL = 'https://backend-voice-agora.vercel.app';
                
                const response = await fetch(`${BACKEND_URL}/api/agora/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        channelName: currentChannelId,
                        userId: currentUserId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('Error del servidor:', error);
                    throw new Error(error.error || 'Error al obtener token');
                }

                const data = await response.json();
                console.log('Token recibido, UID:', data.uid);
                
                return {
                    token: data.token,
                    uid: data.uid
                };
                
            } catch (error) {
                console.error('Error obteniendo token:', error);
                throw error;
            }
        }

    
async function joinRealtimeChannel() {
    const realtimeChannelName = `voice_presence_${currentChannelId}`;
    
    roomChannel = supabase.channel(realtimeChannelName, {
        config: {
            presence: {
                key: currentUserId,
            },
        },
    });

    roomChannel
        .on('presence', { event: 'sync' }, () => {
            const newState = roomChannel.presenceState();
            updateParticipantsList(newState);
            updateChannelParticipantCount(currentChannelId, Object.keys(newState).length);
        })
        .on('presence', { event: 'join' }, ({ key, newPresences }) => {
            console.log(`${newPresences[0].userName} se unió`);
            const newState = roomChannel.presenceState();
            updateChannelParticipantCount(currentChannelId, Object.keys(newState).length);
        })
        .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
            console.log(`Usuario ${key} salió`);
            const newState = roomChannel.presenceState();
            updateChannelParticipantCount(currentChannelId, Object.keys(newState).length);
        })
        .on('broadcast', { event: 'owner_mute' }, ({ payload }) => {
            if (payload.userId === currentUserId) {
                forceMutedByOwner = true;
                if (localAudioTrack) {
                    localAudioTrack.setEnabled(false);
                    isMuted = true;
                    updateMuteButton();
                }
                showToast('Has sido silenciado por el owner', 'warning');
            }
        })
        .on('broadcast', { event: 'owner_unmute' }, ({ payload }) => {
            if (payload.userId === currentUserId) {
                forceMutedByOwner = false;
                updateMuteButton();
                showToast('El owner te ha quitado el silencio', 'success');
            }
        })
        .on('broadcast', { event: 'owner_kick' }, async ({ payload }) => {
            if (payload.userId === currentUserId) {
                showToast('Has sido expulsado del canal por el owner', 'error');
                await leaveChannel();
            }
        });

    await roomChannel.subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
            await roomChannel.track({
                userId: currentUserId,
                userName: currentUserName,
                channelId: currentChannelId,
                isMuted: isMuted,
                joinedAt: new Date().toISOString()
            });
        }
    });
}




async function loadAllChannelParticipantCounts() {
    try {
        const channels = await loadVoiceChannels();
        
        for (const channel of channels) {
            // Crear un canal temporal para obtener la presencia
            const tempChannel = supabase.channel(`voice_presence_${channel.id}`, {
                config: { presence: { key: 'temp_checker' } }
            });
            
            await tempChannel.subscribe();
            
            setTimeout(() => {
                const presenceState = tempChannel.presenceState();
                const count = Object.keys(presenceState).length;
                updateChannelParticipantCount(channel.id, count);
                tempChannel.unsubscribe();
            }, 1000);
        }
    } catch (error) {
        console.error('Error cargando conteos de participantes:', error);
    }
}

function updateChannelParticipantCount(channelId, count) {
    // Actualizar en el sidebar
    const sidebarItem = document.querySelector(`[data-channel-id="${channelId}"] .participants-count-sidebar`);
    if (sidebarItem) {
        sidebarItem.textContent = count;
    }
    
    // Guardar en cache local
    channelParticipantCounts[channelId] = count;
}


        function updateParticipantsList(presenceState) {
            const participants = [];
            
            for (const userId in presenceState) {
                const presence = presenceState[userId][0];
                participants.push({
                    id: userId,
                    name: presence.userName,
                    isMuted: presence.isMuted || false,
                    isCurrentUser: userId === currentUserId
                });
            }
            
            showParticipants(participants);
            updateParticipantsCount(participants.length);
        }

        async function handleUserPublished(user, mediaType) {
            if (mediaType === 'audio') {
                await agoraClient.subscribe(user, mediaType);
                user.audioTrack.play();
                remoteUsers[user.uid] = user;
                
                // Detectar actividad de voz
                detectVoiceActivity(user);
            }
        }

        function handleUserUnpublished(user, mediaType) {
            if (mediaType === 'audio') {
                delete remoteUsers[user.uid];
            }
        }

        function handleUserJoined(user) {
            console.log('Usuario se unió con UID:', user.uid);
            remoteUsers[user.uid] = user;
            
            const participantsCount = Object.keys(remoteUsers).length + 1;
            updateParticipantsCount(participantsCount);
        }

        function handleUserLeft(user) {
            console.log('Usuario salió con UID:', user.uid);
            delete remoteUsers[user.uid];
            
            const participantElement = document.querySelector(`[data-user-id="${user.uid}"]`);
            if (participantElement) {
                participantElement.remove();
            }
            
            const participantsCount = Object.keys(remoteUsers).length + 1;
            updateParticipantsCount(participantsCount);
        }

        function handleConnectionStateChange(curState, prevState) {
            console.log(`Estado de conexión: ${prevState} -> ${curState}`);
            
            if (curState === 'CONNECTED') {
                updateConnectionStatus('connected', 'Conectado al canal');
            } else if (curState === 'CONNECTING') {
                updateConnectionStatus('connecting', 'Conectando...');
            } else if (curState === 'DISCONNECTED') {
                updateConnectionStatus('disconnected', 'Desconectado');
            }
        }

        function handleNetworkQuality(stats) {
            const quality = stats.uplinkNetworkQuality;
            let qualityText = 'Desconocida';
            
            switch(quality) {
                case 1: qualityText = 'Excelente'; break;
                case 2: qualityText = 'Buena'; break;
                case 3: qualityText = 'Regular'; break;
                case 4: qualityText = 'Mala'; break;
                case 5: qualityText = 'Muy mala'; break;
            }
            
            const qualityElement = document.getElementById('connection-quality');
            if (qualityElement) {
                qualityElement.textContent = qualityText;
            }
        }

        function detectVoiceActivity(user) {
            if (!user.audioTrack) return;
            
            const checkInterval = setInterval(() => {
                if (!remoteUsers[user.uid]) {
                    clearInterval(checkInterval);
                    return;
                }
                
                const level = user.audioTrack.getVolumeLevel();
                const participantElement = document.querySelector(`[data-user-id="${user.uid}"]`);
                
                if (participantElement) {
                    if (level > 0.01) {
                        participantElement.classList.add('speaking');
                    } else {
                        participantElement.classList.remove('speaking');
                    }
                }
            }, 100);
        }

    async function toggleMute() {
    if (!localAudioTrack) return;

    // Si estás silenciado por el owner, no puedes activar el micrófono
    if (forceMutedByOwner && !isMuted) {
        showToast('El owner te ha silenciado. No puedes activar el micrófono.', 'error');
        return;
    }

    const muteBtn = document.getElementById('mute-btn');
    showLoadingSpinner(muteBtn);

    try {
        isMuted = !isMuted;
        await localAudioTrack.setEnabled(!isMuted);

        updateMuteButton();

        // Actualizar estado en presencia
        if (roomChannel) {
            await roomChannel.track({
                userId: currentUserId,
                userName: currentUserName,
                channelId: currentChannelId,
                isMuted: isMuted,
                joinedAt: new Date().toISOString()
            });
        }

        showToast(isMuted ? 'Micrófono silenciado' : 'Micrófono activado', 'info');
        
    } catch (error) {
        console.error('Error al cambiar estado del micrófono:', error);
        showToast('Error al cambiar estado del micrófono', 'error');
    } finally {
        hideLoadingSpinner(muteBtn);
    }
}

function updateMuteButton() {
    const muteBtn = document.getElementById('mute-btn');
    const muteIcon = muteBtn.querySelector('i');
    
    if (isMuted || forceMutedByOwner) {
        muteBtn.classList.add('muted');
        muteIcon.className = 'fas fa-microphone-slash';
        
        if (forceMutedByOwner) {
            muteBtn.style.opacity = '0.6';
            muteBtn.title = 'Silenciado por el owner';
        }
    } else {
        muteBtn.classList.remove('muted');
        muteIcon.className = 'fas fa-microphone';
        muteBtn.style.opacity = '1';
        muteBtn.title = 'Silenciar/Activar micrófono';
    }
}


// Silenciar usuario (solo owner)
async function ownerMuteUser(targetUserId) {
    // Ahora owner Y admin pueden usar esta función
    if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
        showToast('No tienes permisos para silenciar usuarios', 'error');
        return;
    }
    
    // Si eres admin, verificar que no intentes silenciar a owner u otros admins
    if (currentUserRole === 'admin') {
        // Verificar si el target es owner
        const { data: project } = await supabase
            .from('projects')
            .select('owner_id')
            .eq('id', currentProjectId)
            .single();
        
        if (project.owner_id === targetUserId) {
            showToast('No puedes silenciar al owner del proyecto', 'error');
            return;
        }
        
        // Verificar si el target es admin
        const { data: targetMember } = await supabase
            .from('project_members')
            .select('role')
            .eq('project_id', currentProjectId)
            .eq('user_id', targetUserId)
            .single();
        
        if (targetMember?.role === 'admin') {
            showToast('No puedes silenciar a otros administradores', 'error');
            return;
        }
    }
    
    try {
        const { error } = await supabase
            .from('voice_channel_controls')
            .upsert({
                channel_id: currentChannelId,
                user_id: targetUserId,
                action_type: 'mute',
                applied_by: currentUserId
            });
        
        if (error) throw error;
        
        showToast('Usuario silenciado', 'success');
        
        if (roomChannel) {
            await roomChannel.send({
                type: 'broadcast',
                event: 'owner_mute',
                payload: { userId: targetUserId }
            });
        }
        
    } catch (error) {
        console.error('Error silenciando usuario:', error);
        showToast('Error al silenciar usuario', 'error');
    }
}


// Quitar silencio (solo owner)
async function ownerUnmuteUser(targetUserId) {
    if (currentUserRole !== 'owner' && currentUserRole !== 'admin') {
        showToast('No tienes permisos', 'error');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('voice_channel_controls')
            .delete()
            .eq('channel_id', currentChannelId)
            .eq('user_id', targetUserId)
            .eq('action_type', 'mute');
        
        if (error) throw error;
        
        showToast('Usuario desactivado del silencio', 'success');
        
        if (roomChannel) {
            await roomChannel.send({
                type: 'broadcast',
                event: 'owner_unmute',
                payload: { userId: targetUserId }
            });
        }
        
    } catch (error) {
        console.error('Error quitando silencio:', error);
    }
}

// Expulsar usuario (solo owner)
async function ownerKickUser(userId) {
    if (currentUserRole !== 'owner') {
        showToast('Solo el owner puede expulsar usuarios', 'error');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('voice_channel_controls')
            .insert({
                channel_id: currentChannelId,
                user_id: userId,
                action_type: 'kick',
                applied_by: currentUserId,
                expires_at: new Date(Date.now() + 60000).toISOString() // Expira en 1 min
            });
        
        if (error) throw error;
        
        showToast('Usuario expulsado del canal', 'success');
        
        if (roomChannel) {
            await roomChannel.send({
                type: 'broadcast',
                event: 'owner_kick',
                payload: { userId }
            });
        }
        
    } catch (error) {
        console.error('Error expulsando usuario:', error);
        showToast('Error al expulsar usuario', 'error');
    }
}

// Silenciar localmente (todos los usuarios)
function localMuteUser(userId) {
    if (locallyMutedUsers.has(userId)) {
        locallyMutedUsers.delete(userId);
        showToast('Usuario desactivado del silencio local', 'info');
    } else {
        locallyMutedUsers.add(userId);
        showToast('Usuario silenciado localmente (solo para ti)', 'info');
    }
    
    // Aplicar el mute al track de audio
    const user = remoteUsers[userId];
    if (user && user.audioTrack) {
        user.audioTrack.setVolume(locallyMutedUsers.has(userId) ? 0 : 100);
    }
    
    // Actualizar UI
    updateParticipantMuteStatus(userId);
}

function updateParticipantMuteStatus(userId) {
    const participantElement = document.querySelector(`[data-user-id="${userId}"]`);
    if (participantElement) {
        const muteIndicator = participantElement.querySelector('.local-mute-indicator');
        if (locallyMutedUsers.has(userId)) {
            if (!muteIndicator) {
                const indicator = document.createElement('div');
                indicator.className = 'local-mute-indicator';
                indicator.innerHTML = '<i class="fas fa-volume-mute"></i>';
                participantElement.appendChild(indicator);
            }
        } else if (muteIndicator) {
            muteIndicator.remove();
        }
    }
}

        // FUNCIÓN INTERNA PARA LIMPIAR SIN MOSTRAR LOADING
        async function leaveChannelInternal() {
            try {
                // Salir del canal de Agora
                if (localAudioTrack) {
                    localAudioTrack.stop();
                    localAudioTrack.close();
                    localAudioTrack = null;
                }
                
                if (agoraClient && isInChannel) {
                    await agoraClient.leave();
                }

                // Salir del canal de presencia
                if (roomChannel) {
                    await roomChannel.untrack();
                    await roomChannel.unsubscribe();
                    roomChannel = null;
                }

                isInChannel = false;
                remoteUsers = {};
                stopCallDurationTimer();
                
            } catch (error) {
                console.error('Error al salir del canal internamente:', error);
            }
        }

        // FUNCIÓN PÚBLICA PARA SALIR DEL CANAL
       async function leaveChannel() {
    await backToChannelsList();
}

        // FUNCIÓN CORREGIDA PARA RESETEAR AL ESTADO DE SELECCIÓN
    async function resetToChannelSelection() {
    await backToChannelsList();
}


        function showParticipants(participants) {
            const container = document.getElementById('participants-container');
            
            if (participants.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-microphone-slash"></i>
                        </div>
                        <h3>Solo tú en el canal</h3>
                        <p>Esperando que otros se unan a "${currentChannelName}"</p>
                    </div>
                `;
                return;
            }

            let grid = container.querySelector('.participants-grid');
            if (!grid) {
                grid = document.createElement('div');
                grid.className = 'participants-grid';
                container.innerHTML = '';
                container.appendChild(grid);
            }

            // Limpiar participantes existentes
            grid.innerHTML = '';

            participants.forEach(participant => {
                const video = document.createElement('div');
                video.className = 'participant-video fade-in';
                video.setAttribute('data-user-id', participant.id);
                
                if (participant.isCurrentUser) {
                    video.classList.add('current-user');
                }

                const avatarLetter = participant.name.charAt(0).toUpperCase();
                const avatarColor = `hsl(${(participant.id.charCodeAt(0) * 137.508) % 360}, 70%, 60%)`;

                video.innerHTML = `
                    <div class="participant-avatar" style="background: ${avatarColor}">
                        ${avatarLetter}
                    </div>
                    <div class="participant-info">
                        <div class="participant-name">
                            ${participant.name}${participant.isCurrentUser ? ' (Tú)' : ''}
                        </div>
                        <div class="participant-status">
                            <div class="status-icon ${participant.isMuted ? 'mic-off' : 'mic-on'}">
                                <i class="fas fa-${participant.isMuted ? 'microphone-slash' : 'microphone'}"></i>
                            </div>
                        </div>
                    </div>
                `;

                grid.appendChild(video);
            });
        }

        function updateParticipantsCount(count) {
            document.getElementById('participants-count').textContent = count;
            document.getElementById('participants-badge').textContent = count;
        }

        function hideLoadingSpinner(elementSelector) {
    const element = typeof elementSelector === 'string' ? 
        document.querySelector(elementSelector) : elementSelector;
    if (element) {
        const spinner = element.querySelector('.loading-spinner');
        const text = element.querySelector('span');
        const icon = element.querySelector('i');
        
        if (spinner) spinner.style.display = 'none';
        if (text) text.style.opacity = '1';
        if (icon) icon.style.opacity = '1';
        element.disabled = false;
    }
}
        function startCallDurationTimer() {
            callDurationInterval = setInterval(() => {
                if (callStartTime) {
                    const duration = Math.floor((new Date() - callStartTime) / 1000);
                    const hours = Math.floor(duration / 3600);
                    const minutes = Math.floor((duration % 3600) / 60);
                    const seconds = duration % 60;
                    
                    let timeString = '';
                    if (hours > 0) {
                        timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    } else {
                        timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                    
                    document.getElementById('call-duration').textContent = timeString;
                }
            }, 1000);
        }

        function stopCallDurationTimer() {
            if (callDurationInterval) {
                clearInterval(callDurationInterval);
                callDurationInterval = null;
            }
            callStartTime = null;
            document.getElementById('call-duration').textContent = '00:00';
        }

       async function openSettings() {
    if (settingsPanelOpen) {
        closeSettingsPanel();
        return;
    }
    
    // Cerrar panel de participantes si está abierto
    if (participantsPanelOpen) {
        closeParticipantsPanel();
    }
    
    settingsPanelOpen = true;
    
    // Cargar dispositivos
    await loadAudioDevices();
    
    const panel = document.createElement('div');
    panel.className = 'settings-panel';
    panel.id = 'settings-panel';
    
    panel.innerHTML = `
        <div class="panel-overlay" onclick="closeSettingsPanel()"></div>
        <div class="panel-content">
            <div class="panel-header">
                <h3>
                    <i class="fas fa-cog"></i>
                    Configuración de Audio
                </h3>
                <button class="panel-close" onclick="closeSettingsPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="panel-body">
                <div class="setting-group">
                    <label>
                        <i class="fas fa-microphone"></i>
                        Micrófono
                    </label>
                    <select id="microphone-select" onchange="changeMicrophone(this.value)">
                        ${audioDevices.microphones.map(device => 
                            `<option value="${device.deviceId}">${device.label || 'Micrófono ' + (audioDevices.microphones.indexOf(device) + 1)}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="setting-group">
                    <label>
                        <i class="fas fa-volume-up"></i>
                        Altavoces / Audífonos
                    </label>
                    <select id="speaker-select" onchange="changeSpeaker(this.value)">
                        <option value="default">Dispositivo predeterminado</option>
                        ${audioDevices.speakers.map(device => 
                            `<option value="${device.deviceId}" ${selectedSpeaker === device.deviceId ? 'selected' : ''}>
                                ${device.label || 'Altavoz ' + (audioDevices.speakers.indexOf(device) + 1)}
                            </option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="setting-group">
                    <label>
                        <i class="fas fa-sliders-h"></i>
                        Prueba de Audio
                    </label>
                    <div class="audio-test">
                        <button class="test-btn" onclick="testMicrophone()">
                            <i class="fas fa-microphone"></i>
                            Probar Micrófono
                        </button>
                        <button class="test-btn" onclick="testSpeakers()">
                            <i class="fas fa-volume-up"></i>
                            Probar Altavoces
                        </button>
                    </div>
                </div>
                
                ${audioDevices.speakers.length === 0 ? `
                    <div class="warning-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Tu navegador no permite cambiar dispositivos de salida</span>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    document.body.appendChild(panel);
    
    // Animar entrada
    setTimeout(() => panel.classList.add('show'), 10);
}

function closeSettingsPanel() {
    const panel = document.getElementById('settings-panel');
    if (panel) {
        panel.classList.remove('show');
        setTimeout(() => {
            panel.remove();
            settingsPanelOpen = false;
        }, 300);
    }
}

async function changeMicrophone(deviceId) {
    try {
        if (localAudioTrack) {
            localAudioTrack.stop();
            localAudioTrack.close();
        }
        
        const newTrack = await AgoraRTC.createMicrophoneAudioTrack({
            microphoneId: deviceId,
            encoderConfig: 'high_quality',
            AEC: true,
            ANS: true,
            AGC: true
        });
        
        if (agoraClient && isInChannel) {
            await agoraClient.unpublish(localAudioTrack);
            await agoraClient.publish(newTrack);
        }
        
        localAudioTrack = newTrack;
        showToast('Micrófono cambiado exitosamente', 'success');
        
    } catch (error) {
        console.error('Error cambiando micrófono:', error);
        showToast('Error al cambiar micrófono', 'error');
    }
}


async function changeSpeaker(deviceId) {
    try {
        selectedSpeaker = deviceId;
        
        // Cambiar dispositivo de salida para todos los tracks remotos
        for (const userId in remoteUsers) {
            const user = remoteUsers[userId];
            if (user.audioTrack && user.audioTrack.setPlaybackDevice) {
                await user.audioTrack.setPlaybackDevice(deviceId);
            }
        }
        
        localStorage.setItem('selectedSpeaker', deviceId);
        showToast('Dispositivo de salida cambiado', 'success');
        
    } catch (error) {
        console.error('Error cambiando altavoces:', error);
        showToast('Error al cambiar dispositivo de salida', 'error');
    }
}


       function toggleParticipants() {
    if (participantsPanelOpen) {
        closeParticipantsPanel();
    } else {
        openParticipantsPanel();
    }
}

function openParticipantsPanel() {
    if (participantsPanelOpen) return;
    
    // Cerrar configuración si está abierto
    if (settingsPanelOpen) {
        closeSettingsPanel();
    }
    
    participantsPanelOpen = true;
    
    const panel = document.createElement('div');
    panel.className = 'participants-panel';
    panel.id = 'participants-panel';
    
    // Obtener participantes actuales
    const participants = [];
    if (roomChannel) {
        const presenceState = roomChannel.presenceState();
        for (const userId in presenceState) {
            const presence = presenceState[userId][0];
            participants.push({
                id: userId,
                name: presence.userName,
                isMuted: presence.isMuted || false,
                isCurrentUser: userId === currentUserId,
                joinedAt: presence.joinedAt
            });
        }
    }
    
    panel.innerHTML = `
        <div class="panel-overlay" onclick="closeParticipantsPanel()"></div>
        <div class="panel-content">
            <div class="panel-header">
                <h3>
                    <i class="fas fa-users"></i>
                    Participantes (${participants.length})
                </h3>
                <button class="panel-close" onclick="closeParticipantsPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="panel-body">
                <div class="participants-list">
                    ${participants.length === 0 ? `
    <div class="empty-participants">
        <i class="fas fa-user-slash"></i>
        <p>No hay participantes conectados</p>
    </div>
` : participants.map(participant => `
    <div class="participant-item ${participant.isCurrentUser ? 'current-user' : ''}">
        <div class="participant-avatar">
            ${participant.name.charAt(0).toUpperCase()}
        </div>
        <div class="participant-details">
            <div class="participant-name">
                ${participant.name}
                ${participant.isCurrentUser ? ' (Tú)' : ''}
            </div>
            <div class="participant-info">
                <span class="join-time">
                    Conectado ${formatJoinTime(participant.joinedAt)}
                </span>
                <div class="participant-controls">
                    <div class="mic-status ${participant.isMuted ? 'muted' : 'unmuted'}">
                        <i class="fas fa-${participant.isMuted ? 'microphone-slash' : 'microphone'}"></i>
                    </div>
                   ${!participant.isCurrentUser ? `
    ${currentUserRole === 'owner' || currentUserRole === 'admin' ? `
        <button class="control-icon-btn" onclick="ownerMuteUser('${participant.id}')" title="Silenciar usuario">
            <i class="fas fa-ban"></i>
        </button>
        ${currentUserRole === 'owner' ? `
            <button class="control-icon-btn kick-btn" onclick="ownerKickUser('${participant.id}')" title="Expulsar del canal">
                <i class="fas fa-user-times"></i>
            </button>
        ` : ''}
    ` : `
        <button class="control-icon-btn" onclick="localMuteUser('${participant.id}')" title="Silenciar localmente">
            <i class="fas fa-volume-${locallyMutedUsers.has(participant.id) ? 'mute' : 'up'}"></i>
        </button>
    `}
` : ''}
                </div>
            </div>
        </div>
    </div>
`).join('')}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(panel);
    setTimeout(() => panel.classList.add('show'), 10);
}

function closeParticipantsPanel() {
    const panel = document.getElementById('participants-panel');
    if (panel) {
        panel.classList.remove('show');
        setTimeout(() => {
            panel.remove();
            participantsPanelOpen = false;
        }, 300);
    }
}

function formatJoinTime(joinedAt) {
    try {
        const now = new Date();
        const joined = new Date(joinedAt);
        const diffMs = now - joined;
        const diffMins = Math.floor(diffMs / 60000);
        
        if (diffMins < 1) return 'hace menos de 1 min';
        if (diffMins < 60) return `hace ${diffMins} min`;
        
        const diffHours = Math.floor(diffMins / 60);
        return `hace ${diffHours}h ${diffMins % 60}m`;
    } catch (error) {
        return 'recientemente';
    }
}


        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connection-status');
            const statusText = statusElement.querySelector('span');
            const statusIcon = statusElement.querySelector('i');
            
            statusText.textContent = message;
            statusElement.className = `connection-status ${status}`;
            
            if (status === 'connected') {
                statusIcon.className = 'fas fa-circle';
            } else if (status === 'connecting') {
                statusIcon.className = 'fas fa-circle-notch fa-spin';
            } else {
                statusIcon.className = 'fas fa-exclamation-circle';
            }
        }

        function showToast(message, type = 'info', duration = 4000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.classList.remove('show');
                setTimeout(() => existingToast.remove(), 400);
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-${getToastIcon(type)}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 400);
                }
            }, duration);

            toast.addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 400);
            });
        }

        function getToastIcon(type) {
            switch (type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                case 'info': 
                default: return 'info-circle';
            }
        }

      function showLoadingSpinner(elementSelector) {
    const element = typeof elementSelector === 'string' ? 
        document.querySelector(elementSelector) : elementSelector;
    if (element) {
        const spinner = element.querySelector('.loading-spinner');
        const text = element.querySelector('span');
        const icon = element.querySelector('i');
        
        if (spinner) spinner.style.display = 'block'; 
        if (text) text.style.opacity = '0.5'; 
        if (icon) icon.style.opacity = '0.5'; 
        element.disabled = true; 
    }
}


        // Event listeners
        document.addEventListener('keydown', (e) => {
            // Mute/unmute con Ctrl+M
            if (e.ctrlKey && e.key === 'm' && isInChannel) {
                e.preventDefault();
                toggleMute();
            }
            
            // Salir del canal con Ctrl+L
            if (e.ctrlKey && e.key === 'l' && isInChannel) {
                e.preventDefault();
                leaveChannel();
            }
        });

        // Manejar visibilidad de la página
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && localAudioTrack) {
                console.log('Página oculta');
            } else if (!document.hidden && localAudioTrack) {
                console.log('Página visible');
            }
        });

        // Manejar cierre de ventana/pestaña
        window.addEventListener('beforeunload', async (e) => {
            if (isInChannel) {
                if (roomChannel) {
                    await roomChannel.untrack();
                }
                
                if (localAudioTrack) {
                    localAudioTrack.stop();
                    localAudioTrack.close();
                }
                
                if (agoraClient) {
                    await agoraClient.leave();
                }
            }
        });

        // Función para detectar información del dispositivo MEJORADA
        function detectDeviceInfo() {
            const ua = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const isAndroid = /Android/.test(ua);
            const isChrome = /Chrome/.test(ua) && !/Edge/.test(ua);
            const isFirefox = /Firefox/.test(ua);
            const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);
            const isEdge = /Edge/.test(ua);
            
            // Detectar navegadores móviles específicos
            const isMobileChrome = isAndroid && isChrome;
            const isMobileSafari = isIOS && isSafari;
            const isSamsung = /SamsungBrowser/.test(ua);
            
            deviceInfo = {
                isMobile,
                isIOS,
                isAndroid,
                isChrome,
                isFirefox,
                isSafari,
                isEdge,
                isMobileChrome,
                isMobileSafari,
                isSamsung,
                userAgent: ua,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                // Agregar más info útil
                screen: {
                    width: screen.width,
                    height: screen.height,
                    orientation: screen.orientation?.type || 'unknown'
                }
            };
            
            return deviceInfo;
        }

        // FUNCIÓN CORREGIDA PARA VERIFICAR COMPATIBILIDAD
        function checkDeviceCompatibility() {
            const info = detectDeviceInfo();
            const issues = [];
            
            // Verificar soporte básico
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                issues.push('Tu navegador no soporta acceso a micrófono');
            }
            
            // Verificar WebRTC
            if (!window.RTCPeerConnection) {
                issues.push('Tu navegador no soporta WebRTC');
            }
            
            // CORREGIDO: Condiciones más permisivas para móviles
            
            // Para iOS - Solo bloquear versiones muy antiguas
            if (info.isIOS && info.isSafari) {
                const iosVersion = parseInt(info.userAgent.match(/OS (\d+)/)?.[1]);
                if (iosVersion && iosVersion < 12) { // Cambiar de 14 a 12
                    issues.push('Safari en iOS requiere versión 12.0 o superior');
                }
            }
            
            // Para Android - Solo advertir, no bloquear WebView
            if (info.isAndroid && info.userAgent.includes('wv')) {
                console.warn('Android WebView detectado - puede tener limitaciones');
                // NO agregar a issues, solo log
            }
            
            // Verificar HTTPS (requerido para getUserMedia en producción)
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                issues.push('Se requiere HTTPS para acceso al micrófono');
            }
            
            return {
                isCompatible: issues.length === 0,
                issues,
                deviceInfo: info
            };
        }

        // Función para verificar si los permisos ya fueron concedidos antes
        function hasGrantedPermissionsBefore() {
            try {
                const stored = localStorage.getItem(PERMISSIONS_STORAGE_KEY);
                return stored === 'true';
            } catch (error) {
                console.error('Error leyendo permisos guardados:', error);
                return false;
            }
        }

        // Función para marcar permisos como concedidos permanentemente
        function markPermissionsAsGranted() {
            try {
                localStorage.setItem(PERMISSIONS_STORAGE_KEY, 'true');
            } catch (error) {
                console.error('Error guardando permisos:', error);
            }
        }

        // Función para verificar permisos actuales sin mostrar modal
        async function checkCurrentPermissions() {
            try {
                // Verificar micrófono
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                stream.getTracks().forEach(track => track.stop());
                permissionsGranted.microphone = true;
                
                // Verificar notificaciones
                if ('Notification' in window) {
                    permissionsGranted.notifications = Notification.permission === 'granted';
                }
                
                return true;
            } catch (error) {
                console.error('Error verificando permisos actuales:', error);
                permissionsGranted.microphone = false;
                return false;
            }
        }

        // FUNCIÓN MEJORADA PARA MOSTRAR MODAL DE PERMISOS
        async function showPermissionsModal() {
            const modal = document.createElement('div');
            modal.className = 'permission-modal-overlay';
            
            const compatibility = checkDeviceCompatibility();
            const deviceInfo = compatibility.deviceInfo;
            
            // Mensaje específico para móviles
            const isMobile = deviceInfo.isMobile;
            const mobileMessage = isMobile ? 
                'En dispositivos móviles, asegúrate de dar permisos cuando el navegador lo solicite.' : 
                'Para usar el chat de voz necesitamos acceso a tu micrófono';
            
            modal.innerHTML = `
                <div class="permission-modal">
                    <div class="permission-modal-header">
                        <div class="icon">
                            <i class="fas fa-microphone"></i>
                        </div>
                        <h3>Permisos Requeridos</h3>
                        <p>${mobileMessage}</p>
                    </div>
                    <div class="permission-modal-body">
                        ${!compatibility.isCompatible ? `
                            <div class="compatibility-warning">
                                <div class="icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="compatibility-warning-content">
                                    <h4>Problemas de Compatibilidad Detectados</h4>
                                    <p>${compatibility.issues.join('. ')}</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="permission-item" id="microphone-permission">
                            <div class="permission-icon">
                                <i class="fas fa-microphone"></i>
                            </div>
                            <div class="permission-info">
                                <div class="permission-title">Micrófono</div>
                                <div class="permission-description">
                                    ${isMobile ? 'Toca "Permitir" cuando aparezca la solicitud' : 'Necesario para participar en llamadas de voz'}
                                </div>
                            </div>
                            <div class="permission-status">
                                <i class="fas fa-clock"></i>
                                <span>Pendiente</span>
                            </div>
                        </div>
                        
                        <div class="permission-item" id="notifications-permission">
                            <div class="permission-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="permission-info">
                                <div class="permission-title">Notificaciones</div>
                                <div class="permission-description">Para recibir avisos de llamadas (opcional)</div>
                            </div>
                            <div class="permission-status">
                                <i class="fas fa-clock"></i>
                                <span>Pendiente</span>
                            </div>
                        </div>
                        
                        ${isMobile ? `
                            <div class="mobile-tips">
                                <h4>Consejos para móvil:</h4>
                                <ul>
                                    <li>Asegúrate de estar en una página HTTPS</li>
                                    <li>Da permisos cuando el navegador lo solicite</li>
                                    <li>Si no funciona, recarga la página e intenta de nuevo</li>
                                    <li>Usa Chrome o Safari para mejor compatibilidad</li>
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div class="permission-modal-actions">
                            <button class="btn-permission btn-permission-secondary" onclick="handlePermissionDenial()">
                                ${isMobile ? 'Saltar permisos' : 'Continuar sin permisos'}
                            </button>
                            <button class="btn-permission btn-permission-primary" onclick="requestPermissions()" ${!compatibility.isCompatible ? 'disabled' : ''}>
                                ${!compatibility.isCompatible ? 'Dispositivo no compatible' : (isMobile ? 'Dar Permisos' : 'Solicitar Permisos')}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            return modal;
        }

        // FUNCIÓN MEJORADA PARA SOLICITAR PERMISOS EN MÓVIL
        async function requestPermissions() {
            const micItem = document.getElementById('microphone-permission');
            const notifItem = document.getElementById('notifications-permission');
            const isMobile = detectDeviceInfo().isMobile;
            
            try {
                // Solicitar permisos de micrófono con configuración optimizada para móvil
                updatePermissionStatus(micItem, 'checking', isMobile ? 'Esperando respuesta...' : 'Verificando...');
                
                try {
                    let constraints;
                    
                    if (isMobile) {
                        // Configuración específica para móviles
                        constraints = {
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                autoGainControl: true,
                                sampleRate: 44100,
                                channelCount: 1,
                                // Configuraciones adicionales para móvil
                                latency: 0.1,
                                volume: 1.0
                            }
                        };
                    } else {
                        // Configuración para escritorio
                        constraints = {
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                autoGainControl: true
                            }
                        };
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Verificar que el stream es válido
                    if (stream.getAudioTracks().length === 0) {
                        throw new Error('No se pudo acceder al micrófono');
                    }
                    
                    // En móvil, verificar que el audio funciona
                    if (isMobile) {
                        const audioTrack = stream.getAudioTracks()[0];
                        if (!audioTrack || audioTrack.readyState !== 'live') {
                            throw new Error('El micrófono no está funcionando correctamente');
                        }
                    }
                    
                    stream.getTracks().forEach(track => track.stop());
                    
                    permissionsGranted.microphone = true;
                    updatePermissionStatus(micItem, 'granted', 'Concedido');
                    
                } catch (micError) {
                    console.error('Error con micrófono:', micError);
                    permissionsGranted.microphone = false;
                    
                    let errorMsg = 'Denegado';
                    if (micError.name === 'NotFoundError') {
                        errorMsg = isMobile ? 'Sin micrófono' : 'No se encontró micrófono';
                    } else if (micError.name === 'NotAllowedError') {
                        errorMsg = isMobile ? 'Permisos denegados - Ve a configuración' : 'Permisos denegados';
                    } else if (micError.name === 'NotReadableError') {
                        errorMsg = isMobile ? 'Micrófono ocupado' : 'Micrófono en uso';
                    } else if (micError.name === 'OverconstrainedError') {
                        errorMsg = isMobile ? 'Configuración no soportada' : 'Error de configuración';
                    }
                    
                    updatePermissionStatus(micItem, 'denied', errorMsg);
                }
                
                // Solicitar notificaciones (con timeout para móvil)
                updatePermissionStatus(notifItem, 'checking', 'Verificando...');
                
                try {
                    if ('Notification' in window) {
                        // En móvil, usar timeout para evitar bloqueos
                        const permission = isMobile ? 
                            await Promise.race([
                                Notification.requestPermission(),
                                new Promise(resolve => setTimeout(() => resolve('default'), 5000))
                            ]) :
                            await Notification.requestPermission();
                            
                        if (permission === 'granted') {
                            permissionsGranted.notifications = true;
                            updatePermissionStatus(notifItem, 'granted', 'Concedido');
                        } else {
                            permissionsGranted.notifications = false;
                            updatePermissionStatus(notifItem, 'denied', permission === 'default' ? 'Sin respuesta' : 'Denegado');
                        }
                    } else {
                        permissionsGranted.notifications = false;
                        updatePermissionStatus(notifItem, 'denied', 'No soportado');
                    }
                } catch (notifError) {
                    console.error('Error con notificaciones:', notifError);
                    permissionsGranted.notifications = false;
                    updatePermissionStatus(notifItem, 'denied', 'Error');
                }
                
                // Evaluar resultados
                setTimeout(() => {
                    handlePermissionResults();
                }, isMobile ? 2000 : 1500); // Más tiempo en móvil
                
            } catch (error) {
                console.error('Error general en permisos:', error);
                showToast(isMobile ? 'Error con permisos. Reinicia el navegador.' : 'Error al solicitar permisos', 'error');
            }
        }

        // Función para actualizar estado visual de permisos
        function updatePermissionStatus(element, status, message) {
            element.className = `permission-item ${status}`;
            
            const statusElement = element.querySelector('.permission-status');
            const icon = statusElement.querySelector('i');
            const text = statusElement.querySelector('span');
            
            switch (status) {
                case 'checking':
                    icon.className = 'fas fa-circle-notch fa-spin';
                    element.classList.add('checking');
                    break;
                case 'granted':
                    icon.className = 'fas fa-check';
                    break;
                case 'denied':
                    icon.className = 'fas fa-times';
                    break;
            }
            
            text.textContent = message;
        }

        function handlePermissionResults() {
            const modal = document.querySelector('.permission-modal-overlay');
            
            if (permissionsGranted.microphone) {
                // Marcar como concedidos para siempre
                markPermissionsAsGranted();
                
                modal.remove();
                showToast('Permisos concedidos. Iniciando aplicación...', 'success');
                setTimeout(continueInitialization, 1000);
            } else {
                // Mostrar opciones si no hay micrófono
                showPermissionDenialOptions();
            }
        }

        // Función para manejar denegación de permisos
        function handlePermissionDenial() {
            const modal = document.querySelector('.permission-modal-overlay');
            modal.remove();
            
            showPermissionDenialOptions();
        }

        // Función para mostrar opciones cuando se deniegan permisos
        function showPermissionDenialOptions() {
            const container = document.getElementById('participants-container');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-microphone-slash"></i>
                    </div>
                    <h3>Sin Acceso al Micrófono</h3>
                    <p>Para usar las llamadas de voz necesitas dar permisos de micrófono</p>
                    <div style="margin-top: 20px;">
                        <button class="btn-primary" onclick="showPermissionsModal()" style="margin-right: 10px;">
                            Intentar de Nuevo
                        </button>
                        <button class="btn-secondary" onclick="goToDashboard()">
                            Volver al Dashboard
                        </button>
                    </div>
                </div>
            `;
            
            updateConnectionStatus('disconnected', 'Sin permisos de micrófono');
        }

        // Función para continuar inicialización después de permisos
        async function continueInitialization() {
            try {
                await initializeApp();
            } catch (error) {
                console.error('Error en inicialización:', error);
                showToast('Error al inicializar la aplicación', 'error');
            }
        }

        // Función para ir al dashboard
        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        // Función para manejar mejor el layout en móvil
        function adjustMobileLayout() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Ajustar altura de la aplicación para móvil
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // Agregar clase para móvil
                document.body.classList.add('mobile-layout');
                
                // Manejar orientación
                function handleOrientationChange() {
                    setTimeout(() => {
                        const vh = window.innerHeight * 0.01;
                        document.documentElement.style.setProperty('--vh', `${vh}px`);
                    }, 300);
                }
                
                window.addEventListener('orientationchange', handleOrientationChange);
                window.addEventListener('resize', handleOrientationChange);
            } else {
                document.body.classList.remove('mobile-layout');
            }
        }

        // Función para mejorar el toque en móvil
        function improveMobileInteractions() {
            const isMobile = detectDeviceInfo().isMobile;
            
            if (isMobile) {
                // Prevenir zoom accidental en inputs
                const metaViewport = document.querySelector('meta[name="viewport"]');
                if (metaViewport) {
                    metaViewport.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no');
                }
                
                // Mejorar toques en botones
                document.addEventListener('touchstart', function(e) {
                    if (e.target.matches('.control-button, .join-btn, .channel-card, .btn-primary, .btn-secondary')) {
                        e.target.classList.add('touching');
                    }
                }, { passive: true });
                
                document.addEventListener('touchend', function(e) {
                    document.querySelectorAll('.touching').forEach(el => {
                        el.classList.remove('touching');
                    });
                }, { passive: true });
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
    try {
        updateConnectionStatus('connecting', 'Conectando...');
        
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error || !session) {
            console.log('No hay sesión, redirigiendo al login');
            window.location.href = 'login.html';
            return;
        }

        currentUser = session.user;
        currentUserId = currentUser.id;
        currentUserName = currentUser.user_metadata?.full_name || 
                        currentUser.user_metadata?.name || 
                        currentUser.email?.split('@')[0] || 
                        'Usuario';

        console.log('Usuario autenticado:', currentUserName, currentUserId);
        initializeThemeAndLanguage();

        // Actualizar info del usuario
        document.getElementById('user-name').textContent = currentUserName;
        document.getElementById('user-avatar').textContent = currentUserName.charAt(0).toUpperCase();
        // Actualizar header del usuario
await updateUserHeader();

        const urlParams = new URLSearchParams(window.location.search);
        currentProjectId = urlParams.get('project');

        if (!currentProjectId) {
            console.error('No se proporcionó project ID');
            window.location.href = 'dashboard.html';
            return;
        }

        // Verificar membresía del proyecto
        const { data: membership } = await supabase
            .from('project_members')
            .select('id, role')
            .eq('project_id', currentProjectId)
            .eq('user_id', currentUserId)
            .maybeSingle();

        if (!membership) {
            showToast('No tienes acceso a este proyecto', 'error');
            setTimeout(() => window.location.href = 'dashboard.html', 2000);
            return;
        }

        // Detectar dispositivo y ajustar layout
        detectDeviceInfo();
        adjustMobileLayout();
        improveMobileInteractions();
        
        // Verificar si ya concedió permisos antes
        if (hasGrantedPermissionsBefore()) {
            console.log('Usuario ya concedió permisos antes, verificando...');
            
            // Verificar permisos actuales silenciosamente
            const permissionsOk = await checkCurrentPermissions();
            
            if (permissionsOk && permissionsGranted.microphone) {
                console.log('Permisos verificados, iniciando aplicación directamente...');
                await continueInitialization();
            } else {
                console.log('Permisos ya no están disponibles, solicitando nuevamente...');
                await showPermissionsModal();
            }
        } else {
            // Primera vez, mostrar modal
            console.log('Primera vez, solicitando permisos...');
            await showPermissionsModal();
        }

    } catch (error) {
        console.error('Error en inicialización:', error);
        showToast('Error al inicializar la aplicación', 'error');
        updateConnectionStatus('disconnected', 'Error de conexión');
    }
});

        // Funciones de tema e idioma
function initializeThemeAndLanguage() {
    document.body.setAttribute('data-theme', currentTheme);
    updateThemeIcon();
    generateLanguageDropdown();
}

function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', currentTheme);
    localStorage.setItem('theme', currentTheme);
    updateThemeIcon();
}

function updateThemeIcon() {
    const themeIcon = document.querySelector('.control-btn i.fa-moon, .control-btn i.fa-sun');
    if (themeIcon) {
        themeIcon.className = `fas fa-${currentTheme === 'dark' ? 'sun' : 'moon'}`;
    }
}

function generateLanguageDropdown() {
    const dropdown = document.getElementById('languageDropdown');
    if (dropdown) {
        dropdown.innerHTML = Object.entries(supportedLanguages).map(([code, lang]) => 
            `<div class="language-option ${currentLanguage === code ? 'active' : ''}" 
                  onclick="changeLanguage('${code}')">
                ${lang.flag} ${lang.name}
             </div>`
        ).join('');
    }
}

function changeLanguage(lang) {
    if (supportedLanguages[lang]) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);
        generateLanguageDropdown();
        
        const dropdown = document.getElementById('languageDropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }
}

function toggleLanguageDropdown() {
    const dropdown = document.getElementById('languageDropdown');
    const button = dropdown?.parentElement?.querySelector('.control-btn');
    
    if (dropdown) {
        dropdown.classList.toggle('show');
        if (dropdown.classList.contains('show') && button) {
            const rect = button.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.style.right = (window.innerWidth - rect.right) + 'px';
        }
    }
}

async function handleLogout() {
    try {
        // Salir del canal si estamos en uno
        if (isInChannel) {
            await leaveChannelInternal();
        }
        
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        
        showToast('Sesión cerrada', 'info');
        window.location.href = 'login.html';
    } catch (error) {
        console.error('Error cerrando sesión:', error);
        showToast('Error al cerrar sesión', 'error');
    }
}

// Cerrar dropdown al hacer clic fuera
document.addEventListener('click', function(event) {
    const languageSelector = document.querySelector('.language-selector');
    const dropdown = document.getElementById('languageDropdown');
    
    if (dropdown && languageSelector && !languageSelector.contains(event.target)) {
        dropdown.classList.remove('show');
    }
});

function showChannelInfo(channelId) {
    // Implementar modal con información del canal
    showToast('Información del canal próximamente', 'info');
}

function createChannelCard(channel) {
    const participantsCount = 0; // Aquí puedes agregar lógica para contar participantes reales
    
    return `
        <div class="channel-card" onclick="joinSpecificChannel('${channel.id}', '${channel.name}')">
            <div class="channel-card-header">
                <div class="channel-info">
                    <div class="channel-icon">
                        <i class="fas fa-volume-up"></i>
                    </div>
                    <div class="channel-details">
                        <h3>${channel.name}</h3>
                        <p class="channel-description">${channel.description || 'Canal de voz del equipo'}</p>
                    </div>
                </div>
                <div class="channel-status">
                    <div class="participants-indicator">
                        <i class="fas fa-users"></i>
                        <span>${participantsCount}</span>
                    </div>
                </div>
            </div>
            
            <div class="channel-actions">
                <button class="join-btn" onclick="event.stopPropagation(); joinSpecificChannel('${channel.id}', '${channel.name}')">
                    <i class="fas fa-phone"></i>
                    Unirse
                </button>
                <button class="info-btn" onclick="event.stopPropagation(); showChannelInfo('${channel.id}')">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
        </div>
    `;
}


function showChannelsInMainView(channels) {
    // Esta función ya no se usa porque eliminamos la vista principal de canales
    console.log('showChannelsInMainView: función obsoleta');
}




function addMobileStyles() {
    if (detectDeviceInfo().isMobile) {
        const mobileStyles = document.createElement('style');
        mobileStyles.innerHTML = `
            .mobile-layout {
                height: calc(var(--vh, 1vh) * 100);
            }

           
            
        `;
        document.head.appendChild(mobileStyles);
    }
}
async function testMicrophone() {
    try {
        const button = event.target.closest('.test-btn');
        button.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Grabando...';
        
        // Crear un track temporal para prueba
        const testTrack = await AgoraRTC.createMicrophoneAudioTrack();
        
        // Simular prueba por 3 segundos
        setTimeout(() => {
            testTrack.stop();
            testTrack.close();
            button.innerHTML = '<i class="fas fa-microphone"></i> Probar Micrófono';
            showToast('Prueba de micrófono completada', 'success');
        }, 3000);
        
    } catch (error) {
        console.error('Error probando micrófono:', error);
        showToast('Error al probar micrófono', 'error');
        event.target.closest('.test-btn').innerHTML = '<i class="fas fa-microphone"></i> Probar Micrófono';
    }
}

// ====== FUNCIÓN PARA PROBAR ALTAVOCES ======
function testSpeakers() {
    try {
        const button = event.target.closest('.test-btn');
        button.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Reproduciendo...';
        
        // Crear audio de prueba
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        
        oscillator.start();
        
        setTimeout(() => {
            oscillator.stop();
            button.innerHTML = '<i class="fas fa-volume-up"></i> Probar Altavoces';
            showToast('Prueba de altavoces completada', 'success');
        }, 2000);
        
    } catch (error) {
        console.error('Error probando altavoces:', error);
        showToast('Error al probar altavoces', 'error');
        event.target.closest('.test-btn').innerHTML = '<i class="fas fa-volume-up"></i> Probar Altavoces';
    }
}

async function loadAudioDevices() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        
        audioDevices.microphones = devices.filter(device => device.kind === 'audioinput');
        audioDevices.speakers = devices.filter(device => device.kind === 'audiooutput');
        
        console.log('Dispositivos encontrados:', {
            microphones: audioDevices.microphones.length,
            speakers: audioDevices.speakers.length
        });
        
        return audioDevices;
    } catch (error) {
        console.error('Error cargando dispositivos:', error);
        return { microphones: [], speakers: [] };
    }
}

// Función para toggle del user menu
function toggleUserMenu() {
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
}

// Función para actualizar el header con avatar del usuario
async function updateUserHeader() {
    if (!currentUser) {
        console.log('currentUser no disponible aún');
        return;
    }
    
    try {
        const { data: profile } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();

        const userName = profile?.full_name || 
                        currentUser.user_metadata?.full_name || 
                        currentUser.user_metadata?.name || 
                        currentUser.email.split('@')[0];
        
        // Actualizar nombre
        const headerUserName = document.getElementById('headerUserName');
        if (headerUserName) {
            headerUserName.textContent = userName;
        }

        // Actualizar avatar
        const avatarImg = document.getElementById('headerAvatarImg');
        if (avatarImg) {
            const initials = userName.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase();
            
            if (profile?.avatar_url && profile.avatar_url.trim() !== '') {
                avatarImg.src = profile.avatar_url;
                avatarImg.style.display = 'block';
                
                avatarImg.onload = () => {
                    console.log('Imagen de perfil cargada correctamente');
                };
                
                avatarImg.onerror = () => {
                    console.log('Error cargando imagen, usando iniciales');
                    setInitialsAvatar(avatarImg, userName, initials);
                };
            } else {
                console.log('No hay imagen de perfil, usando iniciales:', initials);
                setInitialsAvatar(avatarImg, userName, initials);
            }
        }

    } catch (error) {
        console.error('Error updating user header:', error);
        
        const userName = currentUser.email.split('@')[0];
        const headerUserName = document.getElementById('headerUserName');
        const avatarImg = document.getElementById('headerAvatarImg');
        
        if (headerUserName) headerUserName.textContent = userName;
        if (avatarImg) {
            const initials = userName.substring(0, 2).toUpperCase();
            setInitialsAvatar(avatarImg, userName, initials);
        }
    }
}

function setInitialsAvatar(avatarElement, userName, initials) {
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=4a9eff&color=ffffff&size=128&rounded=true&bold=true`;
    
    avatarElement.src = avatarUrl;
    avatarElement.style.display = 'block';
    
    avatarElement.onload = () => {
        console.log('Avatar con iniciales cargado:', initials);
    };
    
    avatarElement.onerror = () => {
        console.log('UI Avatars falló, creando avatar CSS');
        createCSSAvatar(avatarElement, initials);
    };
}

function createCSSAvatar(avatarElement, initials) {
    avatarElement.style.display = 'none';
    
    let cssAvatar = avatarElement.parentNode.querySelector('.css-avatar');
    
    if (!cssAvatar) {
        cssAvatar = document.createElement('div');
        cssAvatar.className = 'css-avatar';
        avatarElement.parentNode.insertBefore(cssAvatar, avatarElement);
    }
    
    cssAvatar.textContent = initials;
    cssAvatar.style.cssText = `
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4a9eff, #00d4ff);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 11px;
        border: 2px solid #4a9eff;
        flex-shrink: 0;
        font-family: inherit;
    `;
    
    console.log('Avatar CSS creado con iniciales:', initials);
}

// Cerrar dropdown del user menu al hacer clic fuera
document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    const userDropdown = document.getElementById('userDropdown');
    
    if (userDropdown && userMenu && !userMenu.contains(event.target)) {
        userDropdown.classList.remove('show');
    }
});


// Función para toggle del user menu
function toggleUserMenu() {
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
}

// Función para actualizar el header con avatar del usuario
async function updateUserHeader() {
    if (!currentUser) {
        console.log('currentUser no disponible aún');
        return;
    }
    
    try {
        const { data: profile } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();

        const userName = profile?.full_name || 
                        currentUser.user_metadata?.full_name || 
                        currentUser.user_metadata?.name || 
                        currentUser.email.split('@')[0];
        
        // Actualizar nombre
        const headerUserName = document.getElementById('headerUserName');
        if (headerUserName) {
            headerUserName.textContent = userName;
        }

        // Actualizar avatar
        const avatarImg = document.getElementById('headerAvatarImg');
        if (avatarImg) {
            const initials = userName.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase();
            
            if (profile?.avatar_url && profile.avatar_url.trim() !== '') {
                avatarImg.src = profile.avatar_url;
                avatarImg.style.display = 'block';
                
                avatarImg.onload = () => {
                    console.log('Imagen de perfil cargada correctamente');
                };
                
                avatarImg.onerror = () => {
                    console.log('Error cargando imagen, usando iniciales');
                    setInitialsAvatar(avatarImg, userName, initials);
                };
            } else {
                console.log('No hay imagen de perfil, usando iniciales:', initials);
                setInitialsAvatar(avatarImg, userName, initials);
            }
        }

    } catch (error) {
        console.error('Error updating user header:', error);
        
        const userName = currentUser.email.split('@')[0];
        const headerUserName = document.getElementById('headerUserName');
        const avatarImg = document.getElementById('headerAvatarImg');
        
        if (headerUserName) headerUserName.textContent = userName;
        if (avatarImg) {
            const initials = userName.substring(0, 2).toUpperCase();
            setInitialsAvatar(avatarImg, userName, initials);
        }
    }
}

function setInitialsAvatar(avatarElement, userName, initials) {
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=4a9eff&color=ffffff&size=128&rounded=true&bold=true`;
    
    avatarElement.src = avatarUrl;
    avatarElement.style.display = 'block';
    
    avatarElement.onload = () => {
        console.log('Avatar con iniciales cargado:', initials);
    };
    
    avatarElement.onerror = () => {
        console.log('UI Avatars falló, creando avatar CSS');
        createCSSAvatar(avatarElement, initials);
    };
}

function createCSSAvatar(avatarElement, initials) {
    avatarElement.style.display = 'none';
    
    let cssAvatar = avatarElement.parentNode.querySelector('.css-avatar');
    
    if (!cssAvatar) {
        cssAvatar = document.createElement('div');
        cssAvatar.className = 'css-avatar';
        avatarElement.parentNode.insertBefore(cssAvatar, avatarElement);
    }
    
    cssAvatar.textContent = initials;
    cssAvatar.style.cssText = `
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4a9eff, #00d4ff);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 11px;
        border: 2px solid #4a9eff;
        flex-shrink: 0;
        font-family: inherit;
    `;
    
    console.log('Avatar CSS creado con iniciales:', initials);
}

// Cerrar dropdown del user menu al hacer clic fuera
document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    const userDropdown = document.getElementById('userDropdown');
    
    if (userDropdown && userMenu && !userMenu.contains(event.target)) {
        userDropdown.classList.remove('show');
    }
});

// Cerrar paneles al hacer clic fuera
// Cerrar paneles al hacer clic en el overlay
document.addEventListener('click', function(event) {
    // Cerrar panel de configuración
    const settingsPanel = document.getElementById('settings-panel');
    const settingsBtn = document.querySelector('.settings-btn');
    
    if (settingsPanel && settingsPanel.classList.contains('show')) {
        const panelOverlay = settingsPanel.querySelector('.panel-overlay');
        const panelContent = settingsPanel.querySelector('.panel-content');
        
        // Si hizo clic en el overlay O fuera del panel (pero no en el botón)
        if (event.target === panelOverlay || 
            (!settingsBtn.contains(event.target) && !panelContent.contains(event.target))) {
            closeSettingsPanel();
        }
    }
    
    // Cerrar panel de participantes
    const participantsPanel = document.getElementById('participants-panel');
    const participantsBtn = document.querySelector('.participants-btn');
    
    if (participantsPanel && participantsPanel.classList.contains('show')) {
        const panelOverlay = participantsPanel.querySelector('.panel-overlay');
        const panelContent = participantsPanel.querySelector('.panel-content');
        
        // Si hizo clic en el overlay O fuera del panel (pero no en el botón)
        if (event.target === panelOverlay || 
            (!participantsBtn.contains(event.target) && !panelContent.contains(event.target))) {
            closeParticipantsPanel();
        }
    }
});

// Exponer funciones globales
// Exponer funciones globales completas y actualizadas
window.updateUserHeader = updateUserHeader;
window.toggleUserMenu = toggleUserMenu;
window.handleLogout = handleLogout;
window.toggleTheme = toggleTheme;
window.toggleLanguageDropdown = toggleLanguageDropdown;
window.changeLanguage = changeLanguage;
window.backToChannelsList = backToChannelsList;
window.showChannelInfo = showChannelInfo;
window.joinSpecificChannel = joinSpecificChannel;
window.showCreateChannelModal = showCreateChannelModal;
window.handleCreateChannel = handleCreateChannel;
window.toggleMute = toggleMute;
window.leaveChannel = leaveChannel;
window.openSettings = openSettings;
window.toggleParticipants = toggleParticipants;
window.showPermissionsModal = showPermissionsModal;
window.requestPermissions = requestPermissions;
window.handlePermissionDenial = handlePermissionDenial;
window.goToDashboard = goToDashboard;
window.loadAndShowChannels = loadAndShowChannels;
window.showChannelsInSidebar = showChannelsInSidebar;
window.showChannelsInMainView = showChannelsInMainView;
window.showChannelsView = showChannelsView;
window.showCallView = showCallView;
window.showDefaultView = showDefaultView;
window.openSettings = openSettings;
window.closeSettingsPanel = closeSettingsPanel;
window.changeMicrophone = changeMicrophone;
window.changeSpeaker = changeSpeaker;
window.testMicrophone = testMicrophone;
window.testSpeakers = testSpeakers;
window.toggleParticipants = toggleParticipants;
window.openParticipantsPanel = openParticipantsPanel;
window.ownerMuteUser = ownerMuteUser;
window.ownerUnmuteUser = ownerUnmuteUser;
window.ownerKickUser = ownerKickUser;
window.localMuteUser = localMuteUser;
window.closeParticipantsPanel = closeParticipantsPanel;
// Hacer supabaseClient disponible globalmente para noti.js
window.supabaseClient = supabase;
// Función para debug
window.debugVoiceChat = function() {
    console.log('=== DEBUG VOICE CHAT ===');
    console.log('Usuario actual:', currentUserId, currentUserName);
    console.log('UID numérico:', window.currentUserNumericUid);
    console.log('Proyecto actual:', currentProjectId);
    console.log('Canal actual:', currentChannelId, currentChannelName);
    console.log('Estado Agora:', agoraClient?.connectionState);
    console.log('Usuarios remotos:', Object.keys(remoteUsers));
    console.log('Audio local:', localAudioTrack?.enabled);
    console.log('Muted:', isMuted);
    console.log('En canal:', isInChannel);
    console.log('Dispositivo:', deviceInfo);
    console.log('Permisos:', permissionsGranted);
    console.log('Backend URL:', 'https://backend-voice-agora.vercel.app');
    console.log('========================');
};

// Agregar estilos móviles cuando el DOM esté listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addMobileStyles);
} else {
    addMobileStyles();
}

    </script>
</body>
</html> 