
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor - OpenMind AI</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="css/noti.css">


<style>


* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0f1419 100%);
    color: white;
    min-height: 100vh;
    overflow: hidden;
}



.delete-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    background: #ef4444;
    color: white;
}

.delete-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
}

.delete-btn:disabled {
    background: rgba(239, 68, 68, 0.5) !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
}

.logo {
    display: flex;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    color: #4a9eff;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.logo-icon {
    width: 24px;
    height: 24px;
    margin-right: 8px;
    background: linear-gradient(45deg, #4a9eff, #00d4ff);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
}

.nav-menu {
    list-style: none;
}

.nav-item {
    margin-bottom: 8px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    color: #8892a6;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-size: 14px;
}

.nav-link:hover, .nav-link.active {
    background: rgba(74, 158, 255, 0.1);
    color: #4a9eff;
}

.nav-link i {
    margin-right: 12px;
    width: 16px;
    text-align: center;
}

/* Main Content */
.main-content {
    margin-left: 260px;
    min-height: 100vh;
    padding: 0;
    transition: margin-left 0.3s ease;
    display: flex;
    flex-direction: column;
}

.main-content.expanded {
    margin-left: 0;
}

/* Header */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 30px;
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
    position: relative;
    z-index: 50;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 20px;
}

.menu-toggle {
    background: none;
    border: none;
    color: #8892a6;
    font-size: 18px;
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.3s ease;
    display: none;
}

.menu-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #4a9eff;
}

.page-title {
    font-size: 18px;
    font-weight: 600;
    color: #ffffff;
}

.project-name-header {
    font-size: 14px;
    color: #4a9eff;
    font-weight: 500;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.welcome-text {
    color: #8892a6;
    font-size: 13px;
}

.user-name {
    color: #4a9eff;
    font-weight: 600;
}

.logout-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.logout-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* Header controls */
.header-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.control-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #8892a6;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.control-btn:hover {
    background: rgba(74, 158, 255, 0.1);
    border-color: #4a9eff;
    color: #4a9eff;
}

/* Language Selector */
.language-selector {
    position: relative;
    z-index: 200;
}

.language-dropdown {
    position: fixed;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.2);
    border-radius: 8px;
    padding: 8px 0;
    min-width: 180px;
    display: none;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 99999;
}

.language-dropdown.show {
    display: block;
}

.language-option {
    padding: 8px 16px;
    cursor: pointer;
    font-size: 12px;
    color: #8892a6;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.language-option:hover {
    background: rgba(74, 158, 255, 0.1);
    color: #4a9eff;
}

.language-option.active {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
}

/* Code Editor View */
.code-editor-container {
    flex: 1 !important;
    display: flex !important;
    flex-direction: row !important;
    height: 100% !important;
    overflow: hidden !important;
}

.file-explorer {
    width: 250px;
    background: rgba(15, 20, 25, 0.8);
    border-right: 1px solid rgba(74, 158, 255, 0.2);
    display: flex;
    flex-direction: column;
}

.explorer-header {
    padding: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.explorer-title {
    font-size: 14px;
    font-weight: 600;
    color: #ffffff;
    flex: 1;
}

.new-file-btn {
    background: rgba(74, 158, 255, 0.2);
    border: none;
    color: #4a9eff;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    margin-left: 5px;
}

.new-file-btn:hover {
    background: rgba(74, 158, 255, 0.3);
}

.file-tree {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.file-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 13px;
    color: #8892a6;
    transition: all 0.3s ease;
    margin-bottom: 2px;
}

.file-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #ffffff;
}

.file-item.active {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
}

.file-item i {
    margin-right: 8px;
    width: 16px;
    text-align: center;
}

.folder-item {
    font-weight: 500;
}

.folder-content {
    overflow: hidden;
    transition: all 0.2s ease;
}

.editor-main {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    min-height: 0 !important; /* CLAVE: Permite que se contraiga */
    min-width: 0 !important;  /* CLAVE: Permite que se contraiga horizontalmente */
    max-width: 100% !important;
    overflow: hidden !important; /* Evita desbordamientos */
    position: relative !important;
    background: rgba(15, 20, 25, 0.95) !important;
    border-left: 1px solid rgba(74, 158, 255, 0.1) !important;
}


/* === PESTAÑAS CORREGIDAS === */



.editor-tab i {
    flex-shrink: 0 !important;
    width: 14px !important;
    margin-right: 4px !important;
    font-size: 12px !important;
}

.editor-tab > span:not(.close-tab) {
    flex: 1 !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    max-width: 70px !important; /* Reducido para dar más espacio al botón cerrar */
    line-height: 1.2 !important;
    display: block !important;
}


.editor-tab .close-tab {
    position: absolute !important;
    right: 6px !important; /* Reducido de 8px a 6px */
    top: 50% !important;
    transform: translateY(-50%) !important;
    font-size: 14px !important;
    font-weight: bold !important;
    opacity: 0.7 !important;
    padding: 0 !important;
    margin: 0 !important;
    border-radius: 2px !important;
    transition: all 0.2s ease !important;
    background: transparent !important;
    color: inherit !important;
    width: 16px !important;
    height: 16px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex-shrink: 0 !important;
    z-index: 100 !important;
    cursor: pointer !important;
    line-height: 1 !important;
}

.editor-tab.active {
    background: rgba(74, 158, 255, 0.2) !important;
    color: #4a9eff !important;
    border-color: rgba(74, 158, 255, 0.3) !important;
}

.editor-tab.modified > span:not(.close-tab) {
    color: #fbbf24 !important;
}

.editor-tab.modified > span:not(.close-tab)::after {
    content: " •" !important;
    color: #fbbf24 !important;
}

.editor-tab:hover {
    background: rgba(255, 255, 255, 0.1) !important;
}

.editor-tab .close-tab:hover {
    opacity: 1 !important;
    background: rgba(239, 68, 68, 0.2) !important;
    color: #ef4444 !important;
}

.editor-tabs::-webkit-scrollbar {
    height: 6px !important;
}

.editor-tabs::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05) !important;
    
}

.editor-tabs::-webkit-scrollbar-thumb {
    background: linear-gradient(90deg, #4a9eff 0%, #00d4ff 100%) !important;
    border-radius: 3px !important;
  
}

.editor-tabs::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(90deg, #5aa8ff 0%, #20ddff 100%) !important;
}

.editor-workspace {
    flex: 1 !important;
    display: flex !important;
    min-height: 0 !important; /* CLAVE: Permite que el contenedor se reduzca */
    overflow: hidden !important;
}

.code-editor {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    min-height: 0 !important;
    overflow: hidden !important;
}

.editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0; /* CLAVE: Permite que el contenedor se reduzca */
    overflow: hidden; /* Evita desbordamientos */
}
.editor-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: rgba(255, 255, 255, 0.02);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    gap: 15px;
    flex-wrap: wrap;
}

.editor-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
}

.editor-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.file-name-display {
    font-size: 14px;
    color: #ffffff;
    font-weight: 500;
    flex: 1;
}

.save-status {
    font-size: 12px;
    color: #8892a6;
    display: flex;
    align-items: center;
    gap: 5px;
}

.save-status.saving {
    color: #fbbf24;
}

.save-status.saved {
    color: #10b981;
}

.preview-btn {
    background: rgba(74, 158, 255, 0.2);
    border: none;
    color: #4a9eff;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.preview-btn:hover {
    background: rgba(74, 158, 255, 0.3);
}

/* === MONACO EDITOR CORREGIDO === */
#monaco-editor-container {
    flex: 1 !important;
    min-height: 0 !important; /* CLAVE: Permite redimensionamiento */
    width: 100% !important;
    position: relative !important;
    overflow: hidden !important;
    background: #1e1e1e !important;
}

#monaco-editor-container .monaco-editor {
    height: 100% !important;
    width: 100% !important;
    padding-bottom: 40px !important;
}

#monaco-editor-container .monaco-editor .view-lines {
    padding-bottom: 20px !important;
   
}

#monaco-editor-container .monaco-editor .lines-content {
    padding-bottom: 40px !important;
  
}
#monaco-editor-container .monaco-editor .overflow-guard::after {
    display: none !important;
}
#monaco-editor-container .monaco-scrollable-element .scrollbar.vertical {
    right: 0px !important;
    width: 14px !important;
    background: rgba(0, 0, 0, 0.1) !important;
}

#monaco-editor-container .monaco-scrollable-element .scrollbar.vertical .slider {
    background: rgba(74, 158, 255, 0.7) !important;
    border-radius: 7px !important;
    width: 12px !important;
    margin: 1px !important;
}

#monaco-editor-container .monaco-scrollable-element .scrollbar.vertical .slider:hover {
    background: rgba(74, 158, 255, 1) !important;
}

#monaco-editor-container .monaco-scrollable-element > .scrollbar > .scroll-decoration {
    bottom: 40px !important;
}

#monaco-editor-container .monaco-editor .overflow-guard {
    height: calc(100% + 60px) !important;
}


@media (max-width: 1200px) {
    .editor-tab {
        width: 110px !important;
        min-width: 110px !important;
        max-width: 110px !important;
        padding: 8px 8px !important;
    }
    
    .editor-tab > span:not(.close-tab) {
        max-width: 65px !important;
    }
    
    .editor-tab .close-tab {
        right: 5px !important;
    }
}

/* Para pantallas pequeñas */
@media (max-width: 768px) {
    .editor-tab {
        width: 100px !important;
        min-width: 100px !important;
        max-width: 100px !important;
        padding: 6px 6px !important;
        font-size: 11px !important;
    }
    
    .editor-tab > span:not(.close-tab) {
        max-width: 60px !important;
    }
    
    .editor-tab .close-tab {
        right: 4px !important;
        font-size: 12px !important;
        width: 14px !important;
        height: 14px !important;
    }
    
    .editor-tabs {
        gap: 1px !important;
    }
}

/* Para pantallas muy pequeñas */
@media (max-width: 480px) {
    .editor-tab {
        width: 90px !important;
        min-width: 90px !important;
        max-width: 90px !important;
        padding: 6px 4px !important;
    }
    
    .editor-tab > span:not(.close-tab) {
        max-width: 55px !important;
    }
    
    .editor-tab i {
        width: 12px !important;
        font-size: 10px !important;
    }
}


.editor-tabs::before {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 6px; /* Espacio para scrollbar */
    width: 20px;
    background: linear-gradient(to left, rgba(15, 20, 25, 0.8) 0%, transparent 100%);
    pointer-events: none;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.editor-tabs:hover::before {
    opacity: 1;
}

.empty-editor {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #8892a6;
    text-align: center;
    padding: 40px;
}

.empty-editor i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
    display: block;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    /* AGREGAR ESTAS LÍNEAS */
    overflow-y: auto;
    padding: 20px;
}
.modal {
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 16px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    /* AGREGAR ESTAS LÍNEAS */
    max-height: 90vh;
    overflow-y: auto;
    margin: auto;
}


.modal h3 {
    color: #ffffff;
    margin-bottom: 20px;
    font-size: 20px;
}

.modal-content {
    margin-bottom: 25px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: #ffffff;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
}

.form-group input[type="text"],
.form-group select {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    font-size: 14px;
}

.form-group input[type="text"]:focus,
.form-group select:focus {
    outline: none;
    border-color: #4a9eff;
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
}

.form-group small {
    color: #8892a6;
    font-size: 12px;
    margin-top: 5px;
    display: block;
}

.form-group input[type="checkbox"] {
    margin-right: 8px;
}

.modal-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

.cancel-btn,
.create-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
}

.cancel-btn {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

.cancel-btn:hover {
    background: rgba(255, 255, 255, 0.15);
}

.create-btn {
    background: linear-gradient(45deg, #4a9eff, #0066cc);
    color: white;
}

.create-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(74, 158, 255, 0.3);
}

/* Toast */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(34, 197, 94, 0.9);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    transform: translateY(-100px);
    opacity: 0;
    transition: all 0.3s ease;
}

.toast.show {
    transform: translateY(0);
    opacity: 1;
}

.toast.error {
    background: rgba(239, 68, 68, 0.9);
}

/* Menú contextual */
.context-menu {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.context-menu:hover {
    backdrop-filter: blur(25px);
}

/* Console Panel */
.console-panel {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 35%;
    background: #1e1e1e;
    border-top: 2px solid #007acc;
    display: none;
    flex-direction: column;
    z-index: 10;
}

.console-panel.open {
    display: flex;
}

.console-header {
    background: #2d2d30;
    color: #cccccc;
    padding: 8px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #3c3c3c;
    font-size: 13px;
    font-weight: 600;
}

.console-tabs {
    display: flex;
    gap: 15px;
}

.console-tab {
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 3px;
    transition: all 0.2s;
}

.console-tab.active {
    background: #007acc;
    color: white;
}

.console-tab:hover:not(.active) {
    background: rgba(255, 255, 255, 0.1);
}

.console-controls {
    display: flex;
    gap: 10px;
}

.console-btn {
    background: none;
    border: none;
    color: #cccccc;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 12px;
    transition: all 0.2s;
}

.console-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.console-btn.close:hover {
    background: #dc3545;
    color: white;
}

.console-output {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    font-family: 'Courier New', 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.4;
    background: #1e1e1e;
}

.console-line {
    margin: 2px 0;
    padding: 2px 5px;
    border-radius: 2px;
}

.console-line.output {
    color: #d4d4d4;
}

.console-line.error {
    color: #f48771;
    background: rgba(244, 135, 113, 0.1);
}

.console-line.warning {
    color: #dcdcaa;
    background: rgba(220, 220, 170, 0.1);
}

.console-line.info {
    color: #4fc1ff;
}

.console-line.success {
    color: #4ec9b0;
}

.console-input-container {
    background: #2d2d30;
    border-top: 1px solid #3c3c3c;
    padding: 8px 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.console-prompt {
    color: #4fc1ff;
    font-family: 'Courier New', 'Consolas', monospace;
    font-size: 13px;
    font-weight: bold;
}

.console-input {
    flex: 1;
    background: none;
    border: none;
    color: #d4d4d4;
    font-family: 'Courier New', 'Consolas', monospace;
    font-size: 13px;
    outline: none;
    padding: 4px;
}

.console-input::placeholder {
    color: #6a6a6a;
}

.run-code-btn {
    background: #007acc;
    border: none;
    color: white;
    padding: 5px 12px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s;
}

.run-code-btn:hover {
    background: #005a9e;
}

.run-code-btn:disabled {
    background: #555;
    cursor: not-allowed;
}

.editor-workspace.with-console {
    height: calc(100% - 35%);
}

.console-toggle-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #d4d4d4;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.console-toggle-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #007acc;
}

.console-toggle-btn.active {
    background: #007acc;
    color: white;
    border-color: #007acc;
}

.console-resize-handle {
    position: absolute;
    top: -2px;
    left: 0;
    right: 0;
    height: 4px;
    background: transparent;
    cursor: ns-resize;
    z-index: 11;
}

.console-resize-handle:hover,
.console-resize-handle.dragging {
    background: #007acc;
}

.console-output::-webkit-scrollbar {
    width: 8px;
}

.console-output::-webkit-scrollbar-track {
    background: #2d2d30;
}

.console-output::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
}

.console-output::-webkit-scrollbar-thumb:hover {
    background: #666;
}

/* Active Editors Display */
#active-editors-display {
    display: none;
    gap: 10px;
    align-items: center;
    margin-left: 15px;
    flex-wrap: wrap;
}

.active-editor {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    color: #ffffff;
    position: relative;
    animation: slideIn 0.3s ease-out;
}

.active-editor::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    border-radius: 6px 0 0 6px;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Collaborative Features */
.collaborative-cursor {
    position: absolute;
    width: 2px;
    height: 20px;
    z-index: 1000;
    pointer-events: none;
}

.cursor-label {
    position: absolute;
    top: -25px;
    left: 0;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 500;
    white-space: nowrap;
    z-index: 1001;
    color: white;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.collaborative-cursor:hover .cursor-label {
    opacity: 1;
}

.cursor-blink {
    animation: cursorBlink 1s infinite;
}

@keyframes cursorBlink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

/* Connection Status */
.connection-status {
    position: fixed;
    top: 80px;
    right: 20px;
    background: rgba(15, 20, 25, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    color: #ffffff;
    display: flex;
    align-items: center;
    gap: 6px;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.connection-status.show {
    opacity: 1;
}

.connection-status.connected {
    border-color: rgba(34, 197, 94, 0.5);
}

.connection-status.connected .status-indicator {
    background: #22c55e;
}

.connection-status.disconnected {
    border-color: rgba(239, 68, 68, 0.5);
}

.connection-status.disconnected .status-indicator {
    background: #ef4444;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #6b7280;
}

/* Real-time indicators */
.real-time-indicator {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(34, 197, 94, 0.2);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 11px;
    color: #22c55e;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    pointer-events: none;
}

.real-time-indicator.show {
    opacity: 1;
    transform: translateY(0);
}

.changes-indicator {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    color: #8892a6;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.changes-indicator.show {
    opacity: 1;
}

.collaborator-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.collaborator-tooltip.show {
    opacity: 1;
}

.recent-change {
    background: rgba(74, 158, 255, 0.1);
    animation: fadeHighlight 2s ease-out;
}

@keyframes fadeHighlight {
    0% { background: rgba(74, 158, 255, 0.3); }
    100% { background: rgba(74, 158, 255, 0.1); }
}

.conflict-indicator {
    position: absolute;
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.4);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 11px;
    color: #ef4444;
    z-index: 1000;
}
.editor-tab {
    position: relative !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
    padding: 8px 10px !important; /* Reducir padding */
    background: rgba(255, 255, 255, 0.05) !important;
    border-radius: 8px 8px 0 0 !important;
    font-size: 12px !important;
    color: #8892a6 !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    white-space: nowrap !important;
    margin-top: 6px !important;
    border: 1px solid transparent !important;
    
    /* CLAVE: Ancho fijo más pequeño y flexible */
    width: 120px !important; /* Reducido de 140px a 120px */
    min-width: 120px !important;
    max-width: 120px !important;
    height: 34px !important;
    max-height: 34px !important;
    min-height: 34px !important;
    
    flex-shrink: 0 !important; /* NO permitir que se contraigan */
    flex-grow: 0 !important;   /* NO permitir que crezcan */
    overflow: hidden !important;
    box-sizing: border-box !important;
}

/* LIGHT THEME */
[data-theme="light"] body {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
    color: #1e293b;
}



[data-theme="light"] .logo {
    color: #3b82f6;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .nav-link {
    color: #64748b;
}

[data-theme="light"] .nav-link:hover,
[data-theme="light"] .nav-link.active {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

[data-theme="light"] .header {
    background: rgba(248, 250, 252, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .page-title {
    color: #1e293b;
}

[data-theme="light"] .project-name-header {
    color: #3b82f6;
}

[data-theme="light"] .welcome-text {
    color: #64748b;
}

[data-theme="light"] .user-name {
    color: #3b82f6;
}

[data-theme="light"] .logout-btn {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #64748b;
}

[data-theme="light"] .logout-btn:hover {
    background: rgba(255, 0, 0, 0.1);
    border-color: #ef4444;
    color: #ef4444;
}

[data-theme="light"] .file-explorer {
    background: rgba(248, 250, 252, 0.8);
    border-right: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .explorer-title {
    color: #1e293b;
}

[data-theme="light"] .file-item {
    color: #64748b;
}

[data-theme="light"] .file-item:hover {
    background: rgba(0, 0, 0, 0.05);
    color: #1e293b;
}

[data-theme="light"] .file-item.active {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

[data-theme="light"] .editor-tabs {
    background: rgba(248, 250, 252, 0.6) !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
}

[data-theme="light"] .editor-tab {
    background: rgba(255, 255, 255, 0.7) !important;
    color: #64748b !important;
}

[data-theme="light"] .editor-tab.active {
    background: rgba(59, 130, 246, 0.15) !important;
    color: #3b82f6 !important;
    border-color: rgba(59, 130, 246, 0.3) !important;
}

[data-theme="light"] .editor-toolbar {
    background: rgba(255, 255, 255, 0.8);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .file-name-display {
    color: #1e293b;
}

[data-theme="light"] .save-status {
    color: #64748b;
}

[data-theme="light"] .preview-btn,
[data-theme="light"] .new-file-btn {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

[data-theme="light"] .preview-btn:hover,
[data-theme="light"] .new-file-btn:hover {
    background: rgba(59, 130, 246, 0.2);
}

[data-theme="light"] #monaco-editor-container {
    background: #ffffff !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor,
[data-theme="light"] #monaco-editor-container .monaco-editor .view-lines {
    background: #ffffff !important;
    color: #1e293b !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .margin {
    background: #f8fafc !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .line-numbers {
    color: #64748b !important;
}

[data-theme="light"] #monaco-editor-container .monaco-scrollable-element .scrollbar.vertical .slider {
    background: rgba(59, 130, 246, 0.7) !important;
}

[data-theme="light"] .empty-editor {
    color: #64748b;
}

[data-theme="light"] .modal-overlay {
    background: rgba(0, 0, 0, 0.5);
}

[data-theme="light"] .modal {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .modal h3 {
    color: #1e293b;
}

[data-theme="light"] .form-group label {
    color: #1e293b;
}

[data-theme="light"] .form-group input[type="text"],
[data-theme="light"] .form-group select {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #1e293b;
}

[data-theme="light"] .control-btn {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #64748b;
}

[data-theme="light"] .control-btn:hover {
    background: rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
    color: #3b82f6;
}

[data-theme="light"] .language-dropdown {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .language-option {
    color: #64748b;
}

[data-theme="light"] .language-option:hover {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

[data-theme="light"] .language-option.active {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

[data-theme="light"] .menu-toggle {
    color: #64748b;
}

[data-theme="light"] .menu-toggle:hover {
    background: rgba(0, 0, 0, 0.05);
    color: #3b82f6;
}

[data-theme="light"] .cancel-btn {
    background: rgba(0, 0, 0, 0.1);
    color: #64748b;
}

[data-theme="light"] .create-btn {
    background: linear-gradient(45deg, #3b82f6, #1d4ed8);
}

[data-theme="light"] .main-content::before {
    content: '';
    position: fixed;
    top: 0;
    left: 260px;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
    z-index: -1;
}

[data-theme="light"] .main-content.expanded::before {
    left: 0;
}

[data-theme="light"] .editor-tabs::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05) !important;
}

[data-theme="light"] .editor-tabs::-webkit-scrollbar-thumb {
    background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%) !important;
}

[data-theme="light"] .editor-tabs::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(90deg, #4f90f7 0%, #2563eb 100%) !important;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3) !important;
}



.editor-tabs {
    display: flex !important;
    background: rgba(15, 20, 25, 0.8) !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    height: 45px !important;
    min-height: 45px !important;
    max-height: 45px !important;
    flex-shrink: 0 !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    padding: 0 !important;
    margin: 0 !important;
    gap: 2px !important; /* Reducir gap para ahorrar espacio */
    
    /* CLAVE: Limitar el ancho máximo del contenedor */
    max-width: 100% !important;
    width: 100% !important;
    
    /* Scrollbar personalizada mejorada */
    scrollbar-width: 1px;
    scrollbar-color: rgba(0, 0, 0, 0);
}




/* RESPONSIVE */
@media (max-width: 768px) {


    .main-content {
        margin-left: 0;
    }

    .menu-toggle {
        display: block;
    }

    .file-explorer {
        width: 200px;
    }

    .header-controls {
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .control-btn span {
        display: none;
    }

    #active-editors-display {
        margin-left: 8px;
        gap: 6px;
    }
    
    .active-editor {
        padding: 3px 6px;
        font-size: 11px;
    }
    
    .connection-status {
        right: 10px;
        top: 70px;
        padding: 6px 10px;
        font-size: 11px;
    }


    
    .editor-tab > span:not(.close-tab) {
        max-width: 75px !important;
    }
    
    .editor-tab .close-tab {
        right: 6px !important;
        font-size: 14px !important;
    }
}

/* === SIDEBAR CON HOVER - REEMPLAZA EL CSS ANTERIOR === */
.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 80px; /* Inicia colapsado por defecto */
    height: 100vh;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border-right: 1px solid rgba(74, 158, 255, 0.2);
    padding: 20px 12px;
    z-index: 100;
    transition: all 0.5s cubic-bezier(0.5, 0, 0.5, 1);
    overflow: hidden;
}

/* Estado expandido al hacer hover */
.sidebar:hover {
    width: 260px;
    padding: 20px;
}

.sidebar.hidden {
    transform: translateX(-100%);
}

/* Logo adaptable */
.logo {
    display: flex;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    color: #4a9eff;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
    white-space: nowrap;
    overflow: hidden;
    justify-content: center;
}

.sidebar:hover .logo {
    margin-bottom: 40px;
    padding-bottom: 20px;
    justify-content: flex-start;
}

.logo-icon {
    width: 36px;
    height: 36px;
    margin-right: 0;
    background: linear-gradient(45deg, #4a9eff, #00d4ff);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.sidebar:hover .logo-icon {
    margin-right: 12px;
    width: 32px;
    height: 32px;
}

.logo-text {
    width: 0;
    opacity: 0;
    transition: all 0.3s ease;
    overflow: hidden;
}

.sidebar:hover .logo-text {
    width: auto;
    opacity: 1;
}

/* Navegación mejorada */
.nav-menu {
    list-style: none;
}

.nav-item {
    margin-bottom: 8px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 14px 8px;
    color: #8892a6;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s ease;
    font-size: 14px;
    position: relative;
    white-space: nowrap;
    overflow: hidden;
    justify-content: center;
}

.sidebar:hover .nav-link {
    justify-content: flex-start;
    padding: 14px 16px;
}

.nav-link:hover, .nav-link.active {
    background: rgba(74, 158, 255, 0.15);
    color: #4a9eff;
}

.sidebar:hover .nav-link:hover, 
.sidebar:hover .nav-link.active {
    transform: translateX(4px);
}

.nav-link i {
    margin-right: 0;
    width: 20px;
    text-align: center;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.sidebar:hover .nav-link i {
    margin-right: 14px;
}

.nav-link-text {
    width: 0;
    opacity: 0;
    transition: all 0.3s ease;
    overflow: hidden;
}

.sidebar:hover .nav-link-text {
    width: auto;
    opacity: 1;
}

/* Tooltip para iconos (solo visible cuando NO está en hover) */
.nav-link::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 70px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1000;
}

.nav-link::before {
    content: '';
    position: absolute;
    left: 62px;
    top: 50%;
    transform: translateY(-50%);
    border: 6px solid transparent;
    border-right-color: rgba(0, 0, 0, 0.9);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1000;
}

/* Solo mostrar tooltip cuando el sidebar NO está expandido */
.nav-link:hover::after,
.nav-link:hover::before {
    opacity: 1;
    visibility: visible;
}

.sidebar:hover .nav-link:hover::after,
.sidebar:hover .nav-link:hover::before {
    opacity: 0;
    visibility: hidden;
}

/* Ajuste del contenido principal */
.main-content {
    margin-left: 80px; /* Inicia con sidebar colapsado */
    min-height: 100vh;
    padding: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}

.main-content.expanded {
    margin-left: 0;
}

/* Indicador visual de hover */
.sidebar::after {
    content: '';
    position: absolute;
    top: 50%;
    right: -2px;
    transform: translateY(-50%);
    width: 4px;
    height: 40px;
    background: linear-gradient(to bottom, transparent, #4a9eff, transparent);
    border-radius: 2px;
    opacity: 0;
    transition: all 0.3s ease;
}

.sidebar:hover::after {
    opacity: 0.7;
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        width: 260px;
        padding: 20px;
    }
    
    .sidebar.show {
        transform: translateX(0);
    }
    
    .sidebar.show .logo {
        justify-content: flex-start;
        margin-bottom: 40px;
        padding-bottom: 20px;
    }
    
    .sidebar.show .logo-icon {
        margin-right: 12px;
        width: 32px;
        height: 32px;
    }
    
    .sidebar.show .logo-text {
        width: auto;
        opacity: 1;
    }
    
    .sidebar.show .nav-link {
        justify-content: flex-start;
        padding: 14px 16px;
    }
    
    .sidebar.show .nav-link i {
        margin-right: 14px;
    }
    
    .sidebar.show .nav-link-text {
        width: auto;
        opacity: 1;
    }
    
    .main-content {
        margin-left: 0;
    }
    
    /* Ocultar tooltips en móvil */
    .nav-link::after,
    .nav-link::before {
        display: none;
    }
}

/* Estados de hover mejorados */
.nav-link {
    background: linear-gradient(90deg, transparent 0%, rgba(74, 158, 255, 0.1) 100%);
    background-size: 0% 100%;
    background-repeat: no-repeat;
    background-position: left center;
}

.nav-link:hover {
    background-size: 100% 100%;
}

.nav-link.active {
    background: linear-gradient(90deg, rgba(74, 158, 255, 0.2) 0%, rgba(74, 158, 255, 0.1) 100%);
    background-size: 100% 100%;
}

/* Animación de entrada del texto */
@keyframes fadeInText {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.sidebar:hover .nav-link-text,
.sidebar:hover .logo-text {
    animation: fadeInText 0.3s ease-out;
}

/* AI Tools */
.ai-tools {
    display: flex;
    gap: 10px;
    align-items: center;
}

.ai-btn, .export-btn {
    background: linear-gradient(45deg, #10b981, #059669);
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.ai-btn:hover {
    background: linear-gradient(45deg, #059669, #047857);
    transform: translateY(-1px);
}

.export-btn {
    background: linear-gradient(45deg, #3b82f6, #1d4ed8);
}

.export-btn:hover {
    background: linear-gradient(45deg, #1d4ed8, #1e3a8a);
    transform: translateY(-1px);
}

/* AI Modal */
.ai-companion-modal-content {
    max-width: 800px;
    width: 90%;
}

.ai-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.ai-action-btn {
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #8892a6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 12px;
}

.ai-action-btn.active {
    background: rgba(16, 185, 129, 0.2);
    border-color: #10b981;
    color: #10b981;
}

.ai-action-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
}

.ai-action-btn i {
    font-size: 20px;
}

#ai-prompt {
    width: 100%;
    min-height: 100px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    padding: 12px;
    font-size: 14px;
    resize: vertical;
}

.ai-response {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    border-left: 4px solid #10b981;
}

.response-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.response-header h4 {
    color: #10b981;
    margin: 0;
}

.apply-code-btn {
    background: #10b981;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
}

.response-content {
    background: #1e1e1e;
    border-radius: 6px;
    padding: 15px;
    overflow-x: auto;
}

.response-content pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.response-content code {
    color: #d4d4d4;
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.5;
}

/* Error Inspector */
.error-inspector {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 400px;
    background: rgba(239, 68, 68, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid #ef4444;
    border-radius: 12px;
    z-index: 1000;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.error-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px 12px 0 0;
    color: white;
    font-weight: 600;
}

.close-error-btn {
    margin-left: auto;
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
}

.error-message {
    padding: 15px;
    color: white;
    font-size: 14px;
    line-height: 1.4;
}

.fix-error-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 10px 15px;
    margin: 0 15px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.fix-error-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Typing Effect */
.typing-effect {
    border-right: 2px solid #10b981;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { border-color: transparent; }
    51%, 100% { border-color: #10b981; }
}

.code-response {
    white-space: pre-line; /* Preserva saltos de línea */
    line-height: 1.6;
}

/* O si quieres más control */
.code-response {
    white-space: pre-wrap; /* Preserva espacios y saltos */
}

        </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
    <!-- Botón toggle se crea automáticamente con JS -->
    
    <div class="logo">
        <div class="logo-icon">
            <i class="fas fa-brain"></i>
        </div>
        <div class="logo-text">OpenMind AI</div>
    </div>
    
    <nav>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span class="nav-link-text">Inicio</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="discussions.html" class="nav-link">
                    <i class="fas fa-comments"></i>
                    <span class="nav-link-text">Foros</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="code-editor.html" class="nav-link active">
                    <i class="fas fa-code"></i>
                    <span class="nav-link-text">Editor de Código</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="ai-chat.html" class="nav-link">
                    <i class="fas fa-robot"></i>
                    <span class="nav-link-text">MindAssist IA</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="members.html" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span class="nav-link-text">Miembros</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="voice-calls.html" class="nav-link">
                    <i class="fas fa-phone"></i>
                    <span class="nav-link-text">Llamadas</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="settings.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span class="nav-link-text">Configuración</span>
                </a>
            </li>
        </ul>
    </nav>
</aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <!-- Header -->
        <header class="header">
    <div class="header-left">
        <button class="menu-toggle" id="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
        <div>
            <div class="page-title" data-i18n="editor.title">Editor de Código</div>
            <div class="project-name-header" id="project-name-header">Cargando...</div>
        </div>
    </div>
    
    <div class="header-controls">
        <button class="control-btn" onclick="toggleTheme()">
            <i class="fas fa-moon"></i>
            <span data-i18n="common.themeToggle">Cambiar Tema</span>
        </button>
        
        <div class="language-selector">
            <button class="control-btn" onclick="toggleLanguageDropdown()">
                <i class="fas fa-globe"></i>
                <span data-i18n="common.language">Idioma</span>
            </button>
            <div class="language-dropdown" id="languageDropdown">
                <!-- Se genera dinámicamente -->
            </div>
        </div>
             <div class="notifications-container">
    <button class="control-btn notifications-btn" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span class="notification-count" id="notificationCount" style="display: none;">0</span>
    </button>
    <div class="notifications-dropdown" id="notificationsDropdown">
        <div class="notifications-header">
            <h4>Notificaciones</h4>
        </div>
        <div class="notifications-list" id="notificationsList">
            <div class="notification-item loading">
                Cargando...
            </div>
        </div>
    </div>
</div>
        
        <div class="user-info">
            <div class="welcome-text">
                <span class="user-name" id="user-name">Cargando...</span>
            </div>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i> 
                <span data-i18n="common.logout">Salir</span>
            </button>
        </div>
    </div>
</header>

        <!-- Code Editor View -->
        <div class="code-editor-container">
            <div class="file-explorer">
                <div class="explorer-header">
                    <div class="explorer-title">Archivos</div>
                    <div style="display: flex; gap: 5px;">
                        <button class="new-file-btn" id="upload-folder-btn" title="Subir carpeta">
                            <i class="fas fa-upload"></i>
                        </button>
                        <button class="new-file-btn" id="new-file-btn" title="Nuevo archivo">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="file-tree" id="file-tree">
                    <div style="text-align: center; color: #8892a6; padding: 20px;">
                        Cargando archivos...
                    </div>
                </div>
            </div>
            
            <div class="editor-main">
                <div class="editor-tabs" id="editor-tabs">
                    <!-- Tabs dinámicos -->
                </div>
                
                <div class="editor-workspace">
                    <div class="code-editor">
                        <div class="editor-toolbar">
                            <div class="file-name-display" id="current-file-name">Selecciona un archivo</div>
                            <div class="save-status" id="save-status">
                                <i class="fas fa-save"></i>
                                <span>Guardado</span>
                            </div>
                            <button class="preview-btn" id="preview-btn">
                                <i class="fas fa-eye"></i>
                                Vista Previa
                            </button>
                            <div class="ai-tools">
    <button class="ai-btn" id="ai-companion-btn" title="IA Code Companion">
        <i class="fas fa-robot"></i>
        IA Companion
    </button>
    <button class="export-btn" id="export-project-btn" title="Exportar Archivo Actual">
        <i class="fas fa-download"></i>
        Exportar Archivo
    </button>
</div>
                        </div>
                        
                        <div id="monaco-editor-container">
                            <div class="empty-editor">
                                <div>
                                    <i class="fas fa-code"></i>
                                    <h3>Selecciona un archivo para comenzar</h3>
                                    <p>Usa el explorador de archivos para abrir un archivo existente<br>o crea uno nuevo</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Input oculto para subir carpeta -->
    <input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;">

    <!-- Modal para nuevo archivo -->
    <div class="modal-overlay" id="new-file-modal" style="display: none;">
        <div class="modal">
            <h3>Crear Nuevo Archivo</h3>
            <div class="modal-content">
                <div class="form-group">
                    <label>Nombre del archivo:</label>
                    <input type="text" id="new-file-name" placeholder="ej: app.py, server.js, style.css, component.vue, etc.">
                    <small>Puedes usar cualquier extensión (.py, .java, .cpp, .rb, .go, .php, etc.)</small>
                </div>
                <div class="form-group">
                    <label>Carpeta destino:</label>
                    <select id="new-file-folder">
                        <option value="/">/</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is-folder-checkbox"> Es una carpeta
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeNewFileModal()">Cancelar</button>
                <button class="create-btn" onclick="createNewFile()">Crear</button>
            </div>
        </div>
    </div>


    <!-- Modal IA Code Companion -->
<div class="modal-overlay" id="ai-companion-modal" style="display: none;">
    <div class="modal ai-companion-modal-content">
        <h3>🤖 IA Code Companion</h3>
        <div class="modal-content">
            <div class="ai-actions">
                <button class="ai-action-btn active" data-action="generate" style="display: none;">
                    <i class="fas fa-code"></i>
                    Generar Código
                </button>
                <button class="ai-action-btn" data-action="review">
                    <i class="fas fa-search"></i>
                    Revisar Código
                </button>
                <button class="ai-action-btn" data-action="fix">
                    <i class="fas fa-wrench"></i>
                    Corregir Error
                </button>
                <button class="ai-action-btn" data-action="explain">
                    <i class="fas fa-graduation-cap"></i>
                    Explicar Código
                </button>
            </div>
            
            <div class="form-group">
                <label>Describe qué necesitas:</label>
                <textarea id="ai-prompt" rows="4" 
                    placeholder="Ej: Crea una función para validar emails, genera un componente React para login, explica este algoritmo..."></textarea>
            </div>
            
            <div class="ai-response" id="ai-response" style="display: none;">
                <div class="response-header">
                    <h4>Respuesta de IA:</h4>
                    <button class="apply-code-btn" id="apply-code-btn" style="display: none;">
                        <i class="fas fa-check"></i>
                        Aplicar al Editor
                    </button>
                </div>
                <div class="response-content" id="ai-response-content"></div>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="cancel-btn" onclick="closeAIModal()">Cancelar</button>
            <button class="create-btn" id="ask-ai-btn">
                <i class="fas fa-paper-plane"></i>
                Consultar IA
            </button>
        </div>
    </div>
</div>

<!-- Modal Error Inspector -->
<div class="error-inspector" id="error-inspector" style="display: none;">
    <div class="error-content">
        <div class="error-header">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Error Detectado</span>
            <button class="close-error-btn" onclick="closeErrorInspector()">×</button>
        </div>
        <div class="error-message" id="error-message"></div>
        <button class="fix-error-btn" id="fix-error-btn">
            <i class="fas fa-magic"></i>
            Corregir con IA
        </button>
    </div>
</div>
    <script src="js/project-session.js"></script>
   <script src="js/noti.js"></script>

  <script>
// Configuración de Supabase
const SUPABASE_URL = 'https://jatcscioqvicmiofsuqt.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphdGNzY2lvcXZpY21pb2ZzdXF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2ODUwNDcsImV4cCI6MjA3MjI2MTA0N30.wZ2dXWG7jq7zhzorqKoQYF7I6xz49k2xaFsouQRscGQ';

// Para preview/visualización
const PREVIEW_BACKEND_URL = 'https://bakd-pvd8.vercel.app';

// Para IA y análisis
const AI_BACKEND_URL = 'https://open-analy.vercel.app';


let supabaseClient;
let projectRepositories = [];
let currentUser = null;
let currentProject = null;
let currentUserRole = null;
let projectFiles = [];
let openTabs = [];
let activeTab = null;
let saveTimeout = null;
let expandedFolders = new Set();
let currentAIAction = 'generate';
let isGeneratingCode = false;
let currentViewMode = 'repositories'; // 'repositories' o 'files'
let selectedRepository = null;
// Variables para sincronización simplificada
let syncInterval = null;
let lastSyncTime = 0;
let isEditing = false;
let allProjectFiles = []; // Nueva variable para todos los archivos
// Monaco Editor variables
let monacoEditor = null;
let monacoInitialized = false;

// Variables para tema e idioma
let currentTheme = localStorage.getItem('theme') || 'dark';
let currentLanguage = localStorage.getItem('language') || 'es';

// Idiomas soportados
const supportedLanguages = {
    'en': { name: 'English', flag: '🇺🇸' },
    'es': { name: 'Español', flag: '🇪🇸' },
    'fr': { name: 'Français', flag: '🇫🇷' },
    'de': { name: 'Deutsch', flag: '🇩🇪' },
    'it': { name: 'Italiano', flag: '🇮🇹' },
    'pt': { name: 'Português', flag: '🇵🇹' },
    'ru': { name: 'Русский', flag: '🇷🇺' },
    'ja': { name: '日本語', flag: '🇯🇵' },
    'ko': { name: '한국어', flag: '🇰🇷' },
    'zh': { name: '中文', flag: '🇨🇳' },
    'ar': { name: 'العربية', flag: '🇸🇦' },
    'hi': { name: 'हिंदी', flag: '🇮🇳' },
    'nl': { name: 'Nederlands', flag: '🇳🇱' }
};

// Traducciones
const translations = {
    es: {
        'common.themeToggle': 'Cambiar Tema',
        'common.language': 'Idioma',
        'common.logout': 'Salir',
        'editor.title': 'Editor de Código'
    },
    en: {
        'common.themeToggle': 'Toggle Theme',
        'common.language': 'Language',
        'common.logout': 'Logout',
        'editor.title': 'Code Editor'
    }
};

// Función para obtener traducción
function t(key) {
    return translations[currentLanguage] && translations[currentLanguage][key] 
        ? translations[currentLanguage][key] 
        : translations['es'][key] || key;
}

function ensureProjectId() {
    const urlParams = new URLSearchParams(window.location.search);
    let projectId = urlParams.get('project');
    let code = urlParams.get('code');
    
    if (!projectId) {
        projectId = localStorage.getItem('current_project_id');
        code = localStorage.getItem('current_project_code');
        
        if (projectId) {
            const url = new URL(window.location);
            url.searchParams.set('project', projectId);
            if (code) {
                url.searchParams.set('code', code);
            }
            window.history.replaceState({}, '', url);
            console.log('Parámetros recuperados y agregados a URL:', projectId, code);
        } else {
            console.warn('No se encontró project ID, redirigiendo al dashboard');
            window.location.href = 'dashboard.html';
            return null;
        }
    } else {
        localStorage.setItem('current_project_id', projectId);
        if (code) {
            localStorage.setItem('current_project_code', code);
        }
    }
    
    return projectId;
}

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    if (!ensureProjectId()) {
        return;
    }
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    setupEventListeners();
    checkAuthenticationAndLoadData();
    initializeThemeAndLanguage();

     const aiCompanionBtn = document.getElementById('ai-companion-btn');
    if (aiCompanionBtn) aiCompanionBtn.addEventListener('click', showAICompanionModal);
    
    const exportBtn = document.getElementById('export-project-btn');
    if (exportBtn) exportBtn.addEventListener('click', exportCurrentFile);
    
    const askAIBtn = document.getElementById('ask-ai-btn');
    if (askAIBtn) askAIBtn.addEventListener('click', askAI);
    
   const applyCodeBtn = document.getElementById('apply-code-btn');
if (applyCodeBtn) applyCodeBtn.addEventListener('click', applyCodePatch);
    
    // Action buttons
    document.querySelectorAll('.ai-action-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.ai-action-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentAIAction = btn.dataset.action;
        });
    });
    
    // Error detection setup
    setupErrorDetection();

});

function setupEventListeners() {
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
    
    const menuToggle = document.getElementById('menu-toggle');
    if (menuToggle) menuToggle.addEventListener('click', toggleSidebar);
    
    const previewBtn = document.getElementById('preview-btn');
    if (previewBtn) previewBtn.addEventListener('click', openPreviewInNewTab);
    
    const newFileBtn = document.getElementById('new-file-btn');
    if (newFileBtn) newFileBtn.addEventListener('click', showNewFileModal);
    
    const uploadFolderBtn = document.getElementById('upload-folder-btn');
    if (uploadFolderBtn) uploadFolderBtn.addEventListener('click', triggerFolderUpload);
    
    const folderInput = document.getElementById('folder-input');
    if (folderInput) folderInput.addEventListener('change', handleFolderUpload);
}

async function checkAuthenticationAndLoadData() {
    try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error || !session) {
            console.log('No session found, redirecting to login');
            window.location.href = 'login.html';
            return;
        }

        currentUser = session.user;
        
        const userName = currentUser.user_metadata?.full_name || 
                        currentUser.user_metadata?.name || 
                        currentUser.email.split('@')[0];
        
        document.getElementById('user-name').textContent = userName;
        await ensureUserProfile();

        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('project');

        if (!projectId) {
            console.error('No project ID provided');
            redirectToHome('Proyecto no especificado');
            return;
        }

        const hasAccess = await verifyProjectAccess(projectId);
        if (!hasAccess) {
            console.error('User does not have access to this project');
            redirectToHome('No tienes acceso a este proyecto');
            return;
        }
        updateUserRoleDisplay();

        await initMonacoEditor();

        await Promise.all([
            loadProjectData(projectId),
            
        ]);
        await loadProjectRepositories(projectId);

        console.log('Code editor loaded successfully');

    } catch (error) {
        console.error('Error in checkAuthenticationAndLoadData:', error);
        redirectToHome('Error cargando el proyecto: ' + error.message);
    }

    initializeSidebar();
setupMenuToggle();
}

function initMonacoEditor() {
    if (monacoInitialized) return Promise.resolve();
    
    return new Promise((resolve, reject) => {
        require.config({ 
            paths: { 
                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' 
            }
        });
        
        require(['vs/editor/editor.main'], function () {
            const container = document.getElementById('monaco-editor-container');
            if (!container) {
                console.error('Monaco container not found');
                reject(new Error('Container not found'));
                return;
            }

            try {
                container.innerHTML = '';
                
                monacoEditor = monaco.editor.create(container, {
                    value: '// Selecciona un archivo para comenzar a editar...',
                    language: 'javascript',
                    theme: currentTheme === 'dark' ? 'vs-dark' : 'vs',
                    automaticLayout: true,
                    minimap: { enabled: true },
                    scrollBeyondLastLine: false,
                    fontSize: 14,
                    tabSize: 2,
                    insertSpaces: true,
                    wordWrap: 'on',
                    lineNumbers: 'on',
                    folding: true,
                    renderWhitespace: 'selection',
                    readOnly: true
                });

                monacoEditor.onDidChangeModelContent(() => {
                    if (activeTab && monacoEditor && !monacoEditor.getOption(monaco.editor.EditorOption.readOnly)) {
                        const newContent = monacoEditor.getValue();
                        if (newContent !== activeTab.content) {
                            activeTab.content = newContent;
                            activeTab.modified = true;
                            isEditing = true;
                            renderTabs();
                            updateSaveStatus('saving');
                            debounceAutoSave();
                        }
                    }
                });

                monacoInitialized = true;
                console.log('Monaco Editor inicializado correctamente');
                resolve();
            } catch (error) {
                console.error('Error inicializando Monaco:', error);
                reject(error);
            }
        });
    });
}

// Sistema de sincronización simplificado
function startPeriodicSync() {
    if (syncInterval) {
        clearInterval(syncInterval);
    }
    
    syncInterval = setInterval(async () => {
        if (activeTab) {
            await syncFileChanges();
            await checkForOtherEditors();
        }
    }, 10000);
    
    console.log('Sincronización iniciada cada 10 segundos para archivo:', activeTab?.name);
}

function stopPeriodicSync() {
    if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
        console.log('Sincronización detenida');
    }
}

async function syncFileChanges() {
    if (!activeTab) return;
    
    try {
        // 1. Verificar si hay cambios remotos más recientes
        const { data: remoteFile, error: fetchError } = await supabaseClient
            .from('project_files')
            .select('content, updated_at')
            .eq('id', activeTab.id)
            .single();

        if (fetchError) {
            console.error('Error fetching remote file:', fetchError);
            return;
        }

        const remoteUpdateTime = new Date(remoteFile.updated_at).getTime();
        
        // 2. Si el archivo remoto es más reciente y no estamos editando, actualizar
        if (remoteUpdateTime > lastSyncTime && !isEditing) {
            if (remoteFile.content !== activeTab.content) {
                activeTab.content = remoteFile.content;
                if (monacoEditor) {
                    monacoEditor.setValue(remoteFile.content);
                }
                showToast('Archivo actualizado por otro usuario', 'info');
            }
        }
        
        // 3. Si tenemos cambios locales, guardarlos
        if (activeTab.modified && isEditing) {
            await saveFileChanges();
            isEditing = false;
        }
        
        lastSyncTime = Date.now();
        
    } catch (error) {
        console.error('Error in syncFileChanges:', error);
    }
}

async function saveFileChanges() {
    if (!activeTab || !activeTab.modified) return;
    
    // CAMBIO: Permitir a owner Y admin guardar
    if (currentUserRole === 'member') {
        console.log('Member no puede guardar cambios');
        return;
    }

    try {
        if (monacoEditor) {
            activeTab.content = monacoEditor.getValue();
        }

        const { error } = await supabaseClient
            .from('project_files')
            .update({ 
                content: activeTab.content,
                updated_at: new Date().toISOString()
            })
            .eq('id', activeTab.id);

        if (error) throw error;

        activeTab.modified = false;
        renderTabs();
        updateSaveStatus('saved');

    } catch (error) {
        console.error('Error saving file changes:', error);
        updateSaveStatus('error');
    }
}


async function checkForOtherEditors() {
    if (!activeTab) return;
    
    try {
        // Registrar nuestra actividad
        await registerActivity();
        
        // Obtener otros usuarios activos en este archivo
        const { data: activeUsers, error } = await supabaseClient
            .from('file_activity')
            .select('user_id, user_name, last_activity')
            .eq('file_id', activeTab.id)
            .neq('user_id', currentUser.id)
            .gte('last_activity', new Date(Date.now() - 30000).toISOString());

        if (error) {
            console.error('Error checking other editors:', error);
            return;
        }

        updateActiveUsersDisplay(activeUsers || []);
        
    } catch (error) {
        console.error('Error in checkForOtherEditors:', error);
    }
}

async function registerActivity() {
    if (!activeTab) return;
    
    try {
        const { error } = await supabaseClient
            .from('file_activity')
            .upsert({
                file_id: activeTab.id,
                user_id: currentUser.id,
                user_name: getUserName(),
                last_activity: new Date().toISOString()
            }, {
                onConflict: 'file_id,user_id'
            });

        if (error) throw error;
    } catch (error) {
        console.error('Error registering activity:', error);
    }
}

function updateActiveUsersDisplay(activeUsers) {
    let container = document.getElementById('active-users-display');
    
    if (!container) {
        container = document.createElement('div');
        container.id = 'active-users-display';
        container.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(15, 20, 25, 0.9);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            z-index: 1000;
            min-width: 200px;
            display: none;
        `;
        document.body.appendChild(container);
    }
    
    if (activeUsers.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    container.innerHTML = `
        <div style="color: #ffffff; font-size: 12px; margin-bottom: 8px; font-weight: bold;">
            Usuarios editando:
        </div>
        ${activeUsers.map(user => `
            <div style="color: #60a5fa; font-size: 11px; margin: 3px 0;">
                <i class="fas fa-user" style="margin-right: 5px;"></i>
                ${user.user_name}
            </div>
        `).join('')}
    `;
    
    setTimeout(() => {
        if (container) {
            container.style.display = 'none';
        }
    }, 5000);
}

function getUserName() {
    return currentUser.user_metadata?.full_name || 
           currentUser.user_metadata?.name || 
           currentUser.email.split('@')[0];
}


async function verifyProjectAccess(projectId) {
    try {
        const { data: membership, error } = await supabaseClient
            .from('project_members')
            .select('id, role, project_id')
            .eq('project_id', projectId)
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (error && error.code !== 'PGRST116') {
            console.error('Error checking project membership:', error);
            return false;
        }

        if (!membership) {
            console.log('Usuario no es miembro del proyecto');
            return false;
        }

        currentUserRole = membership.role;
        
        // DEBUG: Verificar que el rol se asigna correctamente
        console.log('=== DEBUG ROL ===');
        console.log('Rol obtenido de DB:', membership.role);
        console.log('Rol asignado a currentUserRole:', currentUserRole);
        console.log('Puede editar:', ['owner', 'admin'].includes(currentUserRole));
        console.log('==================');
        
        return true;

    } catch (error) {
        console.error('Error in verifyProjectAccess:', error);
        return false;
    }
}


function updateUserRoleDisplay() {
    const userInfo = document.querySelector('.user-info');
    if (userInfo && currentUserRole) {
        let roleIndicator = document.getElementById('role-indicator');
        if (!roleIndicator) {
            roleIndicator = document.createElement('div');
            roleIndicator.id = 'role-indicator';
            roleIndicator.style.cssText = `
                font-size: 11px;
                color: #4a9eff;
                background: rgba(74, 158, 255, 0.1);
                padding: 2px 6px;
                border-radius: 4px;
                margin-left: 8px;
            `;
            userInfo.insertBefore(roleIndicator, userInfo.firstChild);
        }
        roleIndicator.textContent = currentUserRole.toUpperCase();
    }

}
async function loadProjectData(projectId) {
    try {
        const { data: projectData, error } = await supabaseClient
            .from('projects')
            .select('*')
            .eq('id', projectId)
            .single();

        if (error) throw error;

        currentProject = projectData;
        document.getElementById('project-name-header').textContent = projectData.name;

    } catch (error) {
        console.error('Error loading project data:', error);
        redirectToHome('Error cargando datos del proyecto');
    }
}

async function loadProjectFiles(projectId) {
    try {
        const { data: files, error } = await supabaseClient
            .from('project_files')
            .select('*')
            .eq('project_id', projectId)
            .order('file_path', { ascending: true });

        if (error && error.code !== 'PGRST116') throw error;

        projectFiles = files || [];
        renderFileTree();
        console.log('Archivos cargados:', projectFiles.length);

    } catch (error) {
        console.error('Error loading project files:', error);
        const fileTree = document.getElementById('file-tree');
        if (fileTree) {
            fileTree.innerHTML = 
                '<p style="color: #ef4444; text-align: center; padding: 10px;">Error cargando archivos</p>';
        }
    }
}

async function loadRepositoryFiles(repositoryId) {
    try {
        const { data: files, error } = await supabaseClient
            .from('project_files')
            .select('*')
            .eq('repository_id', repositoryId)
            .order('file_path', { ascending: true });

        if (error && error.code !== 'PGRST116') throw error;

        projectFiles = files || [];
        renderRepositoryFiles();
        console.log('Archivos del repositorio cargados:', projectFiles.length);

    } catch (error) {
        console.error('Error loading repository files:', error);
        showToast('Error cargando archivos del repositorio', 'error');
    }
}

function renderRepositoryFiles() {
    const fileTree = document.getElementById('file-tree');
    fileTree.innerHTML = '';

    // Header con botón de regreso
    const header = document.createElement('div');
    header.style.cssText = `
        padding: 12px 15px;
        background: rgba(74, 158, 255, 0.1);
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 3px solid #4a9eff;
        display: flex;
        align-items: center;
        justify-content: space-between;
    `;

    header.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <button onclick="backToRepositories()" style="
                background: rgba(74, 158, 255, 0.2);
                border: none;
                color: #4a9eff;
                padding: 8px 10px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
            ">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h3 style="color: #4a9eff; font-size: 14px; margin: 0; font-weight: 600;">
                    ${selectedRepository?.name || 'Repositorio'}
                </h3>
                <p style="color: #8892a6; font-size: 11px; margin: 0;">
                    ${projectFiles.length} archivos
                </p>
            </div>
        </div>
        <div style="display: flex; gap: 5px;">
            <button onclick="triggerFolderUpload()" style="background: rgba(74, 158, 255, 0.2); border: none; color: #4a9eff; padding: 6px 8px; border-radius: 4px; cursor: pointer;" title="Subir carpeta">
                <i class="fas fa-upload"></i>
            </button>
            <button onclick="showNewFileModal()" style="background: rgba(74, 158, 255, 0.2); border: none; color: #4a9eff; padding: 6px 8px; border-radius: 4px; cursor: pointer;" title="Nuevo archivo">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    `;
    
    fileTree.appendChild(header);

    if (projectFiles.length === 0) {
        fileTree.innerHTML += `
            <div style="text-align: center; padding: 30px; color: #8892a6;">
                <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                <p style="font-size: 1.1rem; margin-bottom: 5px;">Repositorio vacío</p>
                <p style="font-size: 0.9rem; opacity: 0.7;">Sube archivos o crea nuevos para comenzar</p>
            </div>
        `;
        return;
    }

    const tree = buildFileTree(projectFiles);
    renderFileTreeNode(tree, fileTree, 0);
}

function backToRepositories() {
    currentViewMode = 'repositories';
    selectedRepository = null;
    renderRepositories();
}

window.backToRepositories = backToRepositories;

function renderFileTree() {
    const fileTree = document.getElementById('file-tree');
    if (!fileTree) return;
    
    if (currentViewMode === 'repositories') {
        renderRepositories();
    } else {
        renderRepositoryFiles();
    }
}

function renderRepositories() {
    const fileTree = document.getElementById('file-tree');
    fileTree.innerHTML = '';

    // Header SIN botones de crear archivo
    const header = document.createElement('div');
    header.style.cssText = `
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 15px;
    `;
    
    header.innerHTML = `
        <h3 style="color: #ffffff; font-size: 16px; margin: 0;">
            <i class="fas fa-code-branch" style="margin-right: 8px; color: #4a9eff;"></i>
            Repositorios
        </h3>
        <button onclick="showCreateRepositoryModal()" style="
            background: linear-gradient(45deg, #4a9eff, #00d4ff);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        ">
            <i class="fas fa-plus"></i> Nuevo
        </button>
    `;
    
    fileTree.appendChild(header);

    if (projectRepositories.length === 0) {
        fileTree.innerHTML += `
            <div style="text-align: center; padding: 40px 20px; color: #8892a6;">
                <i class="fas fa-code-branch" style="font-size: 3rem; margin-bottom: 15px; display: block; opacity: 0.3;"></i>
                <h3 style="color: #ffffff; margin-bottom: 8px;">No hay repositorios</h3>
                <p style="font-size: 14px; margin-bottom: 20px; opacity: 0.8;">Crea tu primer repositorio para organizar tu código</p>
                <button onclick="showCreateRepositoryModal()" style="
                    background: linear-gradient(45deg, #4a9eff, #00d4ff);
                    border: none;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">
                    <i class="fas fa-plus"></i> Crear Repositorio
                </button>
            </div>
        `;
        return;
    }

    // Cards de repositorios
    projectRepositories.forEach(repo => {
        const card = createRepositoryCard(repo);
        fileTree.appendChild(card);
    });
}



function createRepositoryCard(repository) {
    const card = document.createElement('div');
    card.style.cssText = `
        background: linear-gradient(135deg, rgba(74, 158, 255, 0.1) 0%, rgba(74, 158, 255, 0.05) 100%);
        border: 1px solid rgba(74, 158, 255, 0.2);
        border-radius: 12px;
        padding: 9px;
        margin-top: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    `;

const filesCount = allProjectFiles.filter(f => f.repository_id === repository.id && !f.is_folder).length;

    card.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 15px;">
            <div style="
                width: 56px;
                height: 56px;
                background: linear-gradient(45deg, #4a9eff, #00d4ff);
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                color: white;
                box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
                flex-shrink: 0;
            ">
                <i class="fas fa-code-branch"></i>
            </div>
            <div style="flex: 1; min-width: 0;">
                <h3 style="color: #ffffff; font-size: 16px; margin: 0 0 8px 0; font-weight: 600;">
                    ${repository.name}
                </h3>
                <p style="color: #8892a6; font-size: 13px; margin: 0 0 8px 0; line-height: 1.4;">
                    ${repository.description || 'Sin descripción'}
                </p>
                <div style="display: flex; gap: 15px; font-size: 11px; color: #8892a6;">
                    <span><i class="fas fa-file"></i> ${filesCount} archivos</span>
                    <span><i class="fas fa-clock"></i> ${new Date(repository.updated_at).toLocaleDateString('es-ES')}</span>
                </div>
            </div>
            <div style="color: #4a9eff; font-size: 18px; align-self: center;">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
        
        <!-- Botón eliminar (solo visible al hacer hover) -->
        <button class="delete-repo-btn" style="
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(239, 68, 68, 0.8);
            border: none;
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        " title="Eliminar repositorio">
            <i class="fas fa-trash"></i>
        </button>
    `;

    // Event listeners
    card.onmouseover = () => {
        card.style.transform = 'translateY(-3px)';
        card.style.boxShadow = '0 12px 30px rgba(74, 158, 255, 0.25)';
        card.style.borderColor = '#4a9eff';
        
        // Mostrar botón eliminar
        const deleteBtn = card.querySelector('.delete-repo-btn');
        if (deleteBtn && ['owner', 'admin'].includes(currentUserRole)) {
            deleteBtn.style.opacity = '1';
        }
    };

    card.onmouseout = () => {
        card.style.transform = 'translateY(0)';
        card.style.boxShadow = 'none';
        card.style.borderColor = 'rgba(74, 158, 255, 0.2)';
        
        // Ocultar botón eliminar
        const deleteBtn = card.querySelector('.delete-repo-btn');
        if (deleteBtn) {
            deleteBtn.style.opacity = '0';
        }
    };

    // Click para abrir repositorio
    card.onclick = (e) => {
        // No abrir si se hizo clic en el botón eliminar
        if (e.target.closest('.delete-repo-btn')) {
            return;
        }
        openRepository(repository);
    };

    // Click para eliminar repositorio
    const deleteBtn = card.querySelector('.delete-repo-btn');
    if (deleteBtn) {
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            showDeleteRepositoryModal(repository);
        };
    }

    return card;
}


function showDeleteRepositoryModal(repository) {
    // Solo owner y admin pueden eliminar
    if (!['owner', 'admin'].includes(currentUserRole)) {
        showToast('No tienes permisos para eliminar repositorios', 'error');
        return;
    }

    // Remover modal existente si hay uno
    const existingModal = document.querySelector('.delete-repo-modal');
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.className = 'modal-overlay delete-repo-modal';
    modal.innerHTML = `
        <div class="modal" style="border-color: rgba(239, 68, 68, 0.3);">
            <h3 style="color: #ef4444; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-exclamation-triangle"></i>
                Eliminar Repositorio
            </h3>
            <div class="modal-content">
                <p style="color: #ffffff; margin-bottom: 15px; line-height: 1.5;">
                    Esta acción <strong>eliminará permanentemente</strong> el repositorio 
                    <strong>"${repository.name}"</strong> y todos sus archivos.
                </p>
                <p style="color: #ef4444; margin-bottom: 20px; font-size: 14px;">
                    Esta acción NO se puede deshacer.
                </p>
                <div class="form-group">
                    <label style="color: #ffffff;">
                        Para confirmar, escribe <strong>eliminar</strong> en el campo:
                    </label>
                    <input type="text" id="delete-confirmation" placeholder="eliminar" 
                           style="margin-top: 8px;" autocomplete="off">
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" id="cancel-delete-btn">Cancelar</button>
                <button class="delete-btn" id="confirm-delete-btn" disabled style="
                    background: rgba(239, 68, 68, 0.5);
                    color: white;
                    cursor: not-allowed;
                ">
                    <i class="fas fa-trash"></i> Eliminar Repositorio
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Referencias a elementos
    const confirmationInput = document.getElementById('delete-confirmation');
    const confirmBtn = document.getElementById('confirm-delete-btn');
    const cancelBtn = document.getElementById('cancel-delete-btn');
    
    // Validar texto de confirmación
    confirmationInput.oninput = () => {
        const isValid = confirmationInput.value.toLowerCase().trim() === 'eliminar';
        
        if (isValid) {
            confirmBtn.disabled = false;
            confirmBtn.style.background = '#ef4444';
            confirmBtn.style.cursor = 'pointer';
        } else {
            confirmBtn.disabled = true;
            confirmBtn.style.background = 'rgba(239, 68, 68, 0.5)';
            confirmBtn.style.cursor = 'not-allowed';
        }
    };
    
    // Event listeners
    cancelBtn.onclick = () => modal.remove();
    
    confirmBtn.onclick = async () => {
        if (confirmationInput.value.toLowerCase().trim() === 'eliminar') {
            await deleteRepository(repository);
            modal.remove();
        }
    };
    
    // Focus en el input
    confirmationInput.focus();
    
    // Cerrar con Escape
    document.addEventListener('keydown', function escapeHandler(e) {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', escapeHandler);
        }
    });
}

async function deleteRepository(repository) {
    try {
        showToast('Eliminando repositorio...', 'info');
        
        // 1. Primero eliminar todos los archivos del repositorio
        const { data: repositoryFiles, error: filesError } = await supabaseClient
            .from('project_files')
            .select('id')
            .eq('repository_id', repository.id);
            
        if (filesError) throw filesError;
        
        if (repositoryFiles && repositoryFiles.length > 0) {
            // Cerrar tabs de archivos que pertenecen a este repositorio
            repositoryFiles.forEach(file => {
                const openTab = openTabs.find(tab => tab.id === file.id);
                if (openTab) {
                    closeTab(openTab.id);
                }
            });
            
            // Eliminar archivos de la base de datos
            const fileIds = repositoryFiles.map(f => f.id);
            const { error: deleteFilesError } = await supabaseClient
                .from('project_files')
                .delete()
                .in('id', fileIds);
                
            if (deleteFilesError) throw deleteFilesError;
        }
        
        // 2. Eliminar el repositorio
        const { error: deleteRepoError } = await supabaseClient
            .from('repositories')
            .delete()
            .eq('id', repository.id);
            
        if (deleteRepoError) throw deleteRepoError;
        
        // 3. Si estábamos dentro del repositorio eliminado, volver a la vista de repositorios
        if (selectedRepository && selectedRepository.id === repository.id) {
            currentViewMode = 'repositories';
            selectedRepository = null;
            clearEditor();
        }
        
        // 4. Recargar la lista de repositorios
        await loadProjectRepositories(currentProject.id);
        
        showToast(`Repositorio "${repository.name}" eliminado correctamente`, 'success');
        
    } catch (error) {
        console.error('Error deleting repository:', error);
        showToast('Error eliminando el repositorio', 'error');
    }
}


function buildFileTree(files) {
    const tree = { children: {}, files: [] };
    
    files.forEach(file => {
        const pathParts = file.file_path.split('/').filter(part => part.length > 0);
        let currentNode = tree;
        
        for (let i = 0; i < pathParts.length - 1; i++) {
            const part = pathParts[i];
            if (!currentNode.children[part]) {
                currentNode.children[part] = { children: {}, files: [] };
            }
            currentNode = currentNode.children[part];
        }
        
        if (file.is_folder) {
            const folderName = pathParts[pathParts.length - 1];
            if (!currentNode.children[folderName]) {
                currentNode.children[folderName] = { children: {}, files: [], folderData: file };
            }
        } else {
            currentNode.files.push(file);
        }
    });
    
    return tree;
}

function renderFileTreeNode(node, container, depth) {
    Object.keys(node.children).sort().forEach(folderName => {
        const folderNode = node.children[folderName];
        const folderPath = folderNode.folderData ? folderNode.folderData.file_path : `/${folderName}`;
        const isExpanded = expandedFolders.has(folderPath);
        
        const folderElement = document.createElement('div');
        folderElement.className = 'file-item folder-item';
        folderElement.style.paddingLeft = `${depth * 15 + 12}px`;
        
        const hasContent = Object.keys(folderNode.children).length > 0 || folderNode.files.length > 0;
        
        folderElement.innerHTML = `
            <i class="fas ${hasContent ? (isExpanded ? 'fa-chevron-down' : 'fa-chevron-right') : ''}" 
               style="width: 12px; margin-right: 5px; font-size: 0.8rem; color: #8892a6;"></i>
            <i class="fas fa-folder${isExpanded ? '-open' : ''}" style="color: #fbbf24; margin-right: 8px;"></i>
            <span>${folderName}</span>
        `;
        
        if (hasContent) {
            folderElement.style.cursor = 'pointer';
            folderElement.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFolder(folderPath, folderElement);
            });
        }
        
        if (folderNode.folderData && ['owner', 'admin'].includes(currentUserRole)) {
            folderElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e, folderNode.folderData);
            });
        }
        
        container.appendChild(folderElement);
        
        const folderContent = document.createElement('div');
        folderContent.className = 'folder-content';
        folderContent.style.display = isExpanded ? 'block' : 'none';
        
        if (isExpanded) {
            renderFileTreeNode(folderNode, folderContent, depth + 1);
        }
        
        container.appendChild(folderContent);
    });
    
    node.files.sort((a, b) => a.file_name.localeCompare(b.file_name)).forEach(file => {
        const fileElement = createFileElement(file, depth);
        container.appendChild(fileElement);
    });
}

function toggleFolder(folderPath, folderElement) {
    const isExpanded = expandedFolders.has(folderPath);
    
    if (isExpanded) {
        expandedFolders.delete(folderPath);
    } else {
        expandedFolders.add(folderPath);
    }
    
    renderFileTree();
}

function createFileElement(file, depth = 0) {
    const div = document.createElement('div');
    div.className = 'file-item';
    div.style.paddingLeft = `${depth * 15 + 29}px`;
    div.dataset.fileId = file.id;
    div.dataset.filePath = file.file_path;

    const icon = getFileIcon(file.file_type);
    
    div.innerHTML = `
        <i class="fas ${icon}" style="margin-right: 8px; color: #60a5fa;"></i>
        <span>${file.file_name}</span>
    `;

    div.addEventListener('click', () => openFile(file));
    
    div.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        if (['owner', 'admin'].includes(currentUserRole)) {
            showContextMenu(e, file);
        }
    });
    
    return div;
}


function showContextMenu(event, file) {
    const existingMenu = document.querySelector('.context-menu');
    if (existingMenu) {
        existingMenu.remove();
    }

    // CAMBIO: Solo mostrar menú contextual a owner y admin
    if (!['owner', 'admin'].includes(currentUserRole)) {
        return;
    }

    const menu = document.createElement('div');
    menu.className = 'context-menu';
    menu.style.cssText = `
        position: fixed;
        top: ${event.clientY}px;
        left: ${event.clientX}px;
        background: rgba(15, 20, 25, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(74, 158, 255, 0.3);
        border-radius: 8px;
        padding: 8px 0;
        z-index: 1000;
        min-width: 150px;
    `;

    const menuItems = [
        {
            text: 'Eliminar',
            icon: 'fa-trash',
            action: () => deleteFile(file)
        }
    ];

    menuItems.forEach(item => {
        const menuItem = document.createElement('div');
        menuItem.style.cssText = `
            padding: 8px 16px;
            color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        `;
        
        menuItem.innerHTML = `<i class="fas ${item.icon}"></i> ${item.text}`;
        
        menuItem.addEventListener('mouseenter', () => {
            menuItem.style.background = 'rgba(239, 68, 68, 0.2)';
        });
        
        menuItem.addEventListener('mouseleave', () => {
            menuItem.style.background = 'transparent';
        });
        
        menuItem.addEventListener('click', () => {
            item.action();
            menu.remove();
        });
        
        menu.appendChild(menuItem);
    });

    document.body.appendChild(menu);

    setTimeout(() => {
        document.addEventListener('click', function removeMenu() {
            menu.remove();
            document.removeEventListener('click', removeMenu);
        });
    }, 100);
}


async function deleteFile(file) {
    const isFolder = file.is_folder;
    const confirmText = isFolder 
        ? `¿Eliminar la carpeta "${file.file_name}" y todo su contenido?`
        : `¿Eliminar el archivo "${file.file_name}"?`;
    
    if (!confirm(confirmText)) return;

    try {
        if (isFolder) {
            const childFiles = projectFiles.filter(f => 
                f.file_path.startsWith(file.file_path + '/') || f.file_path === file.file_path
            );
            
            childFiles.forEach(childFile => {
                const openTab = openTabs.find(tab => tab.id === childFile.id);
                if (openTab) {
                    closeTab(openTab.id);
                }
            });
            
            const fileIds = childFiles.map(f => f.id);
            const { error } = await supabaseClient
                .from('project_files')
                .delete()
                .in('id', fileIds);

            if (error) throw error;
            
            showToast(`Carpeta "${file.file_name}" eliminada`);
        } else {
            const openTab = openTabs.find(tab => tab.id === file.id);
            if (openTab) {
                closeTab(openTab.id);
            }
            
            const { error } = await supabaseClient
                .from('project_files')
                .delete()
                .eq('id', file.id);

            if (error) throw error;
            
            showToast(`Archivo "${file.file_name}" eliminado`);
        }

        await loadProjectFiles(currentProject.id);
        
    } catch (error) {
        console.error('Error deleting file:', error);
        showToast('Error eliminando el archivo', 'error');
    }
}

async function openFile(file) {
    try {
        let existingTab = openTabs.find(tab => tab.id === file.id);
        
        if (existingTab) {
            setActiveTab(existingTab);
            return;
        }

        const { data: fileData, error } = await supabaseClient
            .from('project_files')
            .select('content')
            .eq('id', file.id)
            .single();

        if (error) throw error;

        const newTab = {
            id: file.id,
            name: file.file_name,
            type: file.file_type,
            content: fileData.content || '',
            modified: false,
            filePath: file.file_path
        };

        openTabs.push(newTab);
        setActiveTab(newTab);
        renderTabs();

    } catch (error) {
        console.error('Error opening file:', error);
        showToast('Error abriendo el archivo', 'error');
    }
}

function getFileIcon(fileType) {
    const icons = {
        'html': 'fa-file-code',
        'css': 'fa-file-code', 
        'js': 'fa-file-code',
        'jsx': 'fa-file-code',
        'ts': 'fa-file-code',
        'tsx': 'fa-file-code',
        'json': 'fa-file-code',
        'xml': 'fa-file-code',
        'php': 'fa-file-code',
        'py': 'fa-file-code',
        'rb': 'fa-file-code',
        'java': 'fa-file-code',
        'cs': 'fa-file-code',
        'cpp': 'fa-file-code',
        'c': 'fa-file-code',
        'go': 'fa-file-code',
        'rs': 'fa-file-code',
        'swift': 'fa-file-code',
        'kt': 'fa-file-code',
        'scala': 'fa-file-code',
        'sh': 'fa-file-code',
        'bash': 'fa-file-code',
        'sql': 'fa-file-code',
        'yml': 'fa-file-code',
        'yaml': 'fa-file-code',
        'md': 'fa-file-alt',
        'txt': 'fa-file-alt',
        'pdf': 'fa-file-pdf',
        'doc': 'fa-file-word',
        'docx': 'fa-file-word',
        'xls': 'fa-file-excel',
        'xlsx': 'fa-file-excel',
        'ppt': 'fa-file-powerpoint',
        'pptx': 'fa-file-powerpoint',
        'zip': 'fa-file-archive',
        'rar': 'fa-file-archive',
        '7z': 'fa-file-archive',
        'jpg': 'fa-file-image',
        'jpeg': 'fa-file-image',
        'png': 'fa-file-image',
        'gif': 'fa-file-image',
        'svg': 'fa-file-image',
        'mp4': 'fa-file-video',
        'avi': 'fa-file-video',
        'mov': 'fa-file-video',
        'mp3': 'fa-file-audio',
        'wav': 'fa-file-audio'
    };
    
    return icons[fileType] || 'fa-file';
}

function renderTabs() {
    try {
        const tabsContainer = document.getElementById('editor-tabs');
        if (!tabsContainer) return;
        
        tabsContainer.innerHTML = '';
        
        openTabs.forEach((tab, index) => {
            const tabElement = document.createElement('div');
            tabElement.className = 'editor-tab';
            
            if (activeTab && tab.id === activeTab.id) {
                tabElement.classList.add('active');
            }
            if (tab.modified) {
                tabElement.classList.add('modified');
            }
            
            tabElement.innerHTML = `
                <i class="fas ${getFileIcon(tab.type)}"></i>
                <span>${tab.name}${tab.modified ? '*' : ''}</span>
                <span class="close-tab" data-tab-id="${tab.id}">×</span>
            `;
            
            tabElement.addEventListener('click', (e) => {
                if (!e.target.classList.contains('close-tab')) {
                    setActiveTab(tab);
                }
            });
            
            const closeBtn = tabElement.querySelector('.close-tab');
            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeTab(tab.id);
                });
            }
            
            tabsContainer.appendChild(tabElement);
        });
        
    } catch (error) {
        console.error('Error rendering tabs:', error);
    }
}

function closeTab(tabId) {
    try {
        const tabIndex = openTabs.findIndex(tab => tab.id === tabId);
        if (tabIndex === -1) return;

        const tab = openTabs[tabIndex];
        
        if (tab.modified) {
            const shouldSave = confirm(`¿Guardar cambios en ${tab.name}?`);
            if (shouldSave) {
                autoSave();
            }
        }
        
        openTabs.splice(tabIndex, 1);
        
        if (activeTab && activeTab.id === tabId) {
            if (openTabs.length > 0) {
                let newActiveIndex;
                if (tabIndex > 0) {
                    newActiveIndex = Math.min(tabIndex - 1, openTabs.length - 1);
                } else {
                    newActiveIndex = 0;
                }
                setActiveTab(openTabs[newActiveIndex]);
            } else {
                clearEditor();
            }
        }
        
        renderTabs();
        
    } catch (error) {
        console.error('Error closing tab:', error);
        showToast('Error al cerrar el archivo', 'error');
    }
}

function getMonacoLanguage(fileType) {
    const languageMap = {
        'js': 'javascript',
        'jsx': 'javascript',
        'ts': 'typescript',
        'tsx': 'typescript',
        'html': 'html',
        'css': 'css',
        'scss': 'scss',
        'less': 'less',
        'json': 'json',
        'xml': 'xml',
        'py': 'python',
        'java': 'java',
        'cpp': 'cpp',
        'c': 'c',
        'cs': 'csharp',
        'php': 'php',
        'rb': 'ruby',
        'go': 'go',
        'rs': 'rust',
        'swift': 'swift',
        'kt': 'kotlin',
        'scala': 'scala',
        'sh': 'shell',
        'bash': 'shell',
        'sql': 'sql',
        'md': 'markdown',
        'yml': 'yaml',
        'yaml': 'yaml',
        'dockerfile': 'dockerfile'
    };
    return languageMap[fileType] || 'plaintext';
}

function setActiveTab(tab) {
    if (!tab) return;
    
    activeTab = tab;
    
    // Detener sincronización del archivo anterior
    stopPeriodicSync();
    
    // Actualizar Monaco Editor
    if (monacoEditor) {
        const language = getMonacoLanguage(tab.type);
        const model = monaco.editor.createModel(tab.content, language);
        monacoEditor.setModel(model);
        
        // CAMBIO: Solo members no pueden editar
        const canEdit = currentUserRole !== 'member';
        monacoEditor.updateOptions({ readOnly: !canEdit });
        
        console.log(`Usuario con rol '${currentUserRole}' ${canEdit ? 'puede' : 'no puede'} editar`);
    }
    
    // Actualizar UI
    document.getElementById('current-file-name').textContent = tab.name;
    updateFileTreeVisual();
    updateTabsVisual();
    
    // Iniciar sincronización para el nuevo archivo
    startPeriodicSync();
}

function clearEditor() {
    activeTab = null;
    
    // Detener sincronización
    stopPeriodicSync();
    
    if (monacoEditor) {
        const model = monaco.editor.createModel('// Selecciona un archivo para comenzar a editar...', 'javascript');
        monacoEditor.setModel(model);
        monacoEditor.updateOptions({ readOnly: true });
    }
    
    const fileNameEl = document.getElementById('current-file-name');
    if (fileNameEl) {
        fileNameEl.textContent = 'Selecciona un archivo';
    }
    
    updateFileTreeVisual();
}

function updateTabsVisual() {
    try {
        document.querySelectorAll('.editor-tab').forEach((el, index) => {
            if (openTabs[index]) {
                el.classList.toggle('active', openTabs[index].id === activeTab?.id);
                el.classList.toggle('modified', openTabs[index].modified);
            }
        });
    } catch (error) {
        console.error('Error updating tabs visual:', error);
    }
}

function updateFileTreeVisual() {
    try {
        document.querySelectorAll('.file-item').forEach(el => {
            el.classList.toggle('active', el.dataset.fileId === activeTab?.id);
        });
    } catch (error) {
        console.error('Error updating file tree visual:', error);
    }
}

function debounceAutoSave() {
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(autoSave, 2000);
}

async function autoSave() {
    if (!activeTab || !activeTab.modified) return;
    
    // CAMBIO: Permitir a owner Y admin auto-guardar
    if (currentUserRole === 'member') {
        console.log('Member no puede auto-guardar');
        return;
    }

    try {
        if (monacoEditor) {
            activeTab.content = monacoEditor.getValue();
        }

        const { error } = await supabaseClient
            .from('project_files')
            .update({ 
                content: activeTab.content,
                updated_at: new Date().toISOString()
            })
            .eq('id', activeTab.id);

        if (error) throw error;

        activeTab.modified = false;
        renderTabs();
        updateSaveStatus('saved');

    } catch (error) {
        console.error('Error auto-saving:', error);
        updateSaveStatus('error');
    }
}

function updateSaveStatus(status) {
    const statusElement = document.getElementById('save-status');
    if (!statusElement) return;
    
    const statusTexts = {
        'saving': { text: 'Guardando...', class: 'saving', icon: 'fa-spinner fa-spin' },
        'saved': { text: 'Guardado', class: 'saved', icon: 'fa-check' },
        'error': { text: 'Error', class: 'error', icon: 'fa-exclamation-triangle' }
    };

    const config = statusTexts[status];
    if (config) {
        statusElement.className = `save-status ${config.class}`;
        statusElement.innerHTML = `<i class="fas ${config.icon}"></i><span>${config.text}</span>`;
    }
}

async function openPreviewInNewTab() {
    if (!activeTab || !['html', 'css', 'js'].includes(activeTab.type)) {
        showToast('Solo HTML, CSS y JS', 'error');
        return;
    }

    const content = monacoEditor ? monacoEditor.getValue() : activeTab.content;
    
    if (!content || !content.trim()) {
        showToast('Archivo vacío', 'error');
        return;
    }

    try {
        showToast('Generando preview...', 'info');
        
        const response = await fetch(`${PREVIEW_BACKEND_URL}/api/preview`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                content: content,
                type: activeTab.type,
                filename: activeTab.name
            })
        });

        if (response.ok) {
            const html = await response.text();
            const win = window.open('', '_blank', 'width=1200,height=800');
            if (win) {
                win.document.write(html);
                win.document.close();
                showToast('Preview abierto', 'success');
            } else {
                showToast('Permite ventanas emergentes', 'error');
            }
        } else {
            throw new Error('Error del servidor');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error conectando con servidor', 'error');
    }
}

function showNewFileModal() {
    // CAMBIO: Permitir a owner Y admin crear archivos
    if (!['owner', 'admin'].includes(currentUserRole)) {
        showToast('No tienes permisos para crear archivos', 'error');
        return;
    }

    const folderSelect = document.getElementById('new-file-folder');
    if (folderSelect) {
        folderSelect.innerHTML = '<option value="/">/</option>';
        
        const folders = projectFiles.filter(f => f.is_folder);
        folders.forEach(folder => {
            const option = document.createElement('option');
            option.value = folder.file_path;
            option.textContent = folder.file_path;
            folderSelect.appendChild(option);
        });
    }

    const modal = document.getElementById('new-file-modal');
    const nameInput = document.getElementById('new-file-name');
    
    if (modal) modal.style.display = 'flex';
    if (nameInput) nameInput.focus();
}

function closeNewFileModal() {
    const modal = document.getElementById('new-file-modal');
    const nameInput = document.getElementById('new-file-name');
    const checkboxInput = document.getElementById('is-folder-checkbox');
    
    if (modal) modal.style.display = 'none';
    if (nameInput) nameInput.value = '';
    if (checkboxInput) checkboxInput.checked = false;
}

async function createNewFile() {
    const nameInput = document.getElementById('new-file-name');
    const folderSelect = document.getElementById('new-file-folder');
    const checkboxInput = document.getElementById('is-folder-checkbox');
    
    if (!nameInput || !folderSelect || !checkboxInput) {
        showToast('Error en el formulario', 'error');
        return;
    }
    
    const fileName = nameInput.value.trim();
    const parentPath = folderSelect.value;
    const isFolder = checkboxInput.checked;

    if (!fileName) {
        showToast('Ingresa un nombre para el archivo', 'error');
        return;
    }

    // VERIFICAR QUE ESTAMOS EN UN REPOSITORIO
    if (!selectedRepository) {
        showToast('Debes estar dentro de un repositorio para crear archivos', 'error');
        return;
    }

    if (!/^[\w\-. ]+$/.test(fileName)) {
        showToast('El nombre solo puede contener letras, números, espacios, puntos y guiones', 'error');
        return;
    }

    let fileType = 'txt';
    if (!isFolder && fileName.includes('.')) {
        fileType = fileName.split('.').pop().toLowerCase();
    } else if (isFolder) {
        fileType = 'folder';
    }

    const fullPath = parentPath === '/' ? `/${fileName}` : `${parentPath}/${fileName}`;

    const existingFile = projectFiles.find(f => f.file_path === fullPath);
    if (existingFile) {
        showToast('Ya existe un archivo con ese nombre en esa ubicación', 'error');
        return;
    }

    try {
        const { data, error } = await supabaseClient
            .from('project_files')
            .insert([{
                project_id: currentProject.id,
                repository_id: selectedRepository.id, // ESTO ES CLAVE
                file_name: fileName,
                file_path: fullPath,
                file_type: fileType,
                content: getDefaultContent(fileType),
                is_folder: isFolder,
                created_by: currentUser.id
            }])
            .select()
            .single();

        if (error) throw error;

        showToast(`${isFolder ? 'Carpeta' : 'Archivo'} creado correctamente`);
        closeNewFileModal();
        
        // RECARGAR ARCHIVOS DEL REPOSITORIO ACTUAL
        await loadRepositoryFiles(selectedRepository.id);
        
        if (!isFolder) {
            openFile(data);
        }

    } catch (error) {
        console.error('Error creating file:', error);
        showToast('Error creando el archivo', 'error');
    }
}
function getDefaultContent(fileType) {
    const templates = {
        'html': `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Hola Mundo</h1>
</body>
</html>`,
        'css': `/* Estilos CSS */
body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
}`,
        'js': `// JavaScript
console.log('Hola Mundo');`,
        'py': `# Python
print("Hola Mundo")`,
        'java': `public class Main {
    public static void main(String[] args) {
        System.out.println("Hola Mundo");
    }
}`,
        'cpp': `#include <iostream>
using namespace std;

int main() {
    cout << "Hola Mundo" << endl;
    return 0;
}`,
        'json': `{
    "mensaje": "Hola Mundo",
    "version": "1.0.0"
}`,
        'md': `# Mi Archivo

## Descripción
Este es un archivo de documentación.`,
        'txt': 'Archivo de texto'
    };

    return templates[fileType] || `// Archivo ${fileType}\n// Contenido inicial`;
}

function triggerFolderUpload() {
    // CAMBIO: Permitir a owner Y admin subir carpetas
    if (!['owner', 'admin'].includes(currentUserRole)) {
        showToast('No tienes permisos para subir carpetas', 'error');
        return;
    }
    
    const folderInput = document.getElementById('folder-input');
    if (folderInput) {
        folderInput.click();
    }
}


async function handleFolderUpload(event) {
    const files = Array.from(event.target.files);
    
    if (files.length === 0) return;
    
    // VERIFICAR QUE ESTAMOS EN UN REPOSITORIO
    if (!selectedRepository) {
        showToast('Debes estar dentro de un repositorio para subir carpetas', 'error');
        return;
    }

    showToast('Subiendo carpeta...', 'success');
    
    try {
        const progressInfo = { total: files.length, completed: 0 };
        
        const batchSize = 5;
        for (let i = 0; i < files.length; i += batchSize) {
            const batch = files.slice(i, i + batchSize);
            await Promise.all(batch.map(file => processUploadedFile(file, progressInfo)));
            
            showToast(`Subiendo: ${progressInfo.completed}/${progressInfo.total} archivos`, 'success');
        }

        showToast(`Carpeta subida correctamente (${files.length} archivos)`, 'success');
        // RECARGAR ARCHIVOS DEL REPOSITORIO ACTUAL
        await loadRepositoryFiles(selectedRepository.id);
        
    } catch (error) {
        console.error('Error uploading folder:', error);
        showToast('Error subiendo la carpeta', 'error');
    }

    event.target.value = '';
}


async function processUploadedFile(file, progressInfo) {
    try {
        const relativePath = file.webkitRelativePath || file.name;
        const fullPath = `/${relativePath}`;
        const fileType = getFileTypeFromName(file.name);
        const content = await readFileContent(file);
        
        const existingFile = projectFiles.find(f => f.file_path === fullPath);
        if (existingFile) {
            console.log(`Archivo ya existe: ${fullPath}`);
            progressInfo.completed++;
            return;
        }

        await ensureParentFolders(fullPath);

        const { error } = await supabaseClient
            .from('project_files')
            .insert([{
                project_id: currentProject.id,
                repository_id: selectedRepository?.id, // AGREGAR ESTO
                file_name: file.name,
                file_path: fullPath,
                file_type: fileType,
                content: content,
                is_folder: false,
                created_by: currentUser.id
            }]);

        if (error) {
            console.error(`Error subiendo ${file.name}:`, error);
            return;
        }

        progressInfo.completed++;

    } catch (error) {
        console.error(`Error procesando archivo ${file.name}:`, error);
        progressInfo.completed++;
    }
}


function readFileContent(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            resolve(e.target.result);
        };
        
        reader.onerror = function() {
            reject(new Error('Error leyendo el archivo'));
        };

        if (isTextFile(file.name)) {
            reader.readAsText(file);
        } else {
            reader.readAsDataURL(file);
        }
    });
}

function isTextFile(fileName) {
    const textExtensions = [
        'txt', 'md', 'html', 'css', 'js', 'json', 'xml', 'yml', 'yaml',
        'py', 'java', 'cpp', 'c', 'h', 'php', 'rb', 'go', 'rs', 'swift',
        'kt', 'scala', 'sh', 'bat', 'ps1', 'sql', 'env', 'dockerfile',
        'tsx', 'jsx', 'vue', 'svelte', 'ts', 'cs', 'vb', 'fs', 'dart'
    ];
    
    const extension = fileName.split('.').pop().toLowerCase();
    return textExtensions.includes(extension) || !fileName.includes('.');
}

function getFileTypeFromName(fileName) {
    if (!fileName.includes('.')) return 'txt';
    return fileName.split('.').pop().toLowerCase();
}

async function ensureParentFolders(filePath) {
    const pathParts = filePath.split('/').filter(part => part.length > 0);
    pathParts.pop();
    
    let currentPath = '';
    
    for (const part of pathParts) {
        currentPath += `/${part}`;
        
        const existingFolder = projectFiles.find(f => f.file_path === currentPath && f.is_folder);
        if (existingFolder) continue;

        try {
            const { error } = await supabaseClient
                .from('project_files')
                .insert([{
                    project_id: currentProject.id,
                    file_name: part,
                    file_path: currentPath,
                    file_type: 'folder',
                    content: '',
                    is_folder: true,
                    created_by: currentUser.id
                }]);

            if (error) {
                console.error(`Error creando carpeta ${currentPath}:`, error);
            } else {
                projectFiles.push({
                    file_path: currentPath,
                    is_folder: true
                });
            }
        } catch (err) {
            console.error(`Error en ensureParentFolders para ${currentPath}:`, err);
        }
    }
}

async function handleLogout() {
    try {
        stopPeriodicSync();
        
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        window.location.href = 'login.html';
    } catch (error) {
        console.error('Error logging out:', error);
        showToast('Error al cerrar sesión', 'error');
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('main-content');
    
    if (sidebar && mainContent) {
        sidebar.classList.toggle('hidden');
        mainContent.classList.toggle('expanded');
    }
}

function redirectToHome(reason) {
    console.log('Redirecting to home:', reason);
    showToast(reason, 'error');
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 1000);
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

async function ensureUserProfile() {
    try {
        const { data: existingProfile, error: selectError } = await supabaseClient
            .from('profiles')
            .select('id')
            .eq('id', currentUser.id)
            .maybeSingle();

        if (selectError && selectError.code !== 'PGRST116') {
            throw selectError;
        }

        if (!existingProfile) {
            const userName = currentUser.user_metadata?.full_name || 
                           currentUser.user_metadata?.name || 
                           currentUser.email.split('@')[0];

            const { error: insertError } = await supabaseClient
                .from('profiles')
                .insert([{
                    id: currentUser.id,
                    username: userName.toLowerCase().replace(/\s+/g, '_'),
                    full_name: userName,
                    avatar_url: currentUser.user_metadata?.avatar_url || null
                }]);

            if (insertError) {
                console.error('Error creating profile:', insertError);
            } else {
                console.log('User profile created successfully');
            }
        }
    } catch (error) {
        console.error('Error ensuring user profile:', error);
    }
}

// Funciones de tema e idioma
function initializeThemeAndLanguage() {
    document.body.setAttribute('data-theme', currentTheme);
    updateThemeIcon();
    updateLanguageContent();
    generateLanguageDropdown();
    
    if (window.monaco && monacoEditor) {
        monacoEditor.updateOptions({
            theme: currentTheme === 'dark' ? 'vs-dark' : 'vs'
        });
    }
}

function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', currentTheme);
    localStorage.setItem('theme', currentTheme);
    updateThemeIcon();
    
    if (window.monaco && monacoEditor) {
        monacoEditor.updateOptions({
            theme: currentTheme === 'dark' ? 'vs-dark' : 'vs'
        });
    }
}

function updateThemeIcon() {
    const themeIcon = document.querySelector('.control-btn i.fa-moon, .control-btn i.fa-sun');
    if (themeIcon) {
        themeIcon.className = `fas fa-${currentTheme === 'dark' ? 'sun' : 'moon'}`;
    }
}

function generateLanguageDropdown() {
    const dropdown = document.getElementById('languageDropdown');
    if (dropdown) {
        dropdown.innerHTML = Object.entries(supportedLanguages).map(([code, lang]) => 
            `<div class="language-option ${currentLanguage === code ? 'active' : ''}" 
                  onclick="changeLanguage('${code}')">
                ${lang.flag} ${lang.name}
             </div>`
        ).join('');
    }
}

function changeLanguage(lang) {
    if (supportedLanguages[lang]) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);
        updateLanguageContent();
        generateLanguageDropdown();
        
        const dropdown = document.getElementById('languageDropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }
}

function updateLanguageContent() {
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach(element => {
        const key = element.getAttribute('data-i18n');
        const translation = t(key);
        if (translation && translation !== key) {
            element.textContent = translation;
        }
    });
}

function toggleLanguageDropdown() {
    const dropdown = document.getElementById('languageDropdown');
    const button = dropdown?.parentElement?.querySelector('.control-btn');
    
    if (dropdown) {
        dropdown.classList.toggle('show');
        if (dropdown.classList.contains('show') && button) {
            const rect = button.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.style.right = (window.innerWidth - rect.right) + 'px';
        }
    }
}

// Event listeners
document.addEventListener('click', function(event) {
    const languageSelector = document.querySelector('.language-selector');
    const dropdown = document.getElementById('languageDropdown');
    
    if (dropdown && languageSelector && !languageSelector.contains(event.target)) {
        dropdown.classList.remove('show');
    }
});

window.addEventListener('beforeunload', async () => {
    stopPeriodicSync();
});

window.addEventListener('focus', () => {
    if (activeTab) {
        startPeriodicSync();
    }
});

async function loadProjectRepositories(projectId) {
    try {
        // PRIMERO cargar los repositorios
        const { data: repositories, error } = await supabaseClient
            .from('repositories')
            .select('*')
            .eq('project_id', projectId)
            .order('updated_at', { ascending: false });

        if (error) throw error;

        // SEGUNDO cargar todos los archivos del proyecto para el conteo
        const { data: allFiles, error: filesError } = await supabaseClient
            .from('project_files')
            .select('*')
            .eq('project_id', projectId);

        if (!filesError) {
            allProjectFiles = allFiles || [];
        }

        projectRepositories = repositories || [];
        renderFileTree(); // Cambié esto porque renderRepositories() no existe

    } catch (error) {
        console.error('Error loading repositories:', error);
    }
}

function showCreateRepositoryModal() {
    // Verificar si ya existe un modal
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }

    // Crear modal dinámicamente
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal">
            <h3>Crear Nuevo Repositorio</h3>
            <div class="modal-content">
                <div class="form-group">
                    <label>Nombre del repositorio:</label>
                    <input type="text" id="repo-name" placeholder="mi-proyecto-web">
                </div>
                <div class="form-group">
                    <label>Descripción (opcional):</label>
                    <input type="text" id="repo-description" placeholder="Descripción del repositorio">
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" id="cancel-repo-btn">Cancelar</button>
                <button class="create-btn" id="create-repo-btn">Crear</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Event listeners únicos
    document.getElementById('cancel-repo-btn').onclick = () => {
        modal.remove();
    };
    
    document.getElementById('create-repo-btn').onclick = async () => {
        await createRepository();
        modal.remove();
    };
    
    document.getElementById('repo-name').focus();
}


async function createRepository() {
    const name = document.getElementById('repo-name').value.trim();
    const description = document.getElementById('repo-description').value.trim();

    if (!name) {
        showToast('Ingresa un nombre para el repositorio', 'error');
        return;
    }

    try {
        const { data, error } = await supabaseClient
            .from('repositories')
            .insert([{
                name: name,
                description: description,
                project_id: currentProject.id,
                created_by: currentUser.id
            }])
            .select()
            .single();

        if (error) throw error;

        showToast('Repositorio creado correctamente');
        closeRepositoryModal();
        await loadProjectRepositories(currentProject.id);

    } catch (error) {
        console.error('Error creating repository:', error);
        showToast('Error creando el repositorio', 'error');
    }
}

function openRepository(repository) {
    selectedRepository = repository;
    currentViewMode = 'files';
    loadRepositoryFiles(repository.id);
}


// === JAVASCRIPT SIMPLIFICADO PARA SIDEBAR CON HOVER ===
// Reemplaza las funciones del sidebar anterior con estas

// Función para inicializar el sidebar con hover
function initializeSidebar() {
    // Agregar tooltips a los links
    addTooltipsToNavLinks();
    
    // Setup hover events para mejor control si es necesario
    setupSidebarHover();
}

// Agregar tooltips a los nav links
function addTooltipsToNavLinks() {
    const navLinks = document.querySelectorAll('.nav-link');
    const tooltips = {
        'dashboard.html': 'Inicio',
        'discussions.html': 'Foros', 
        'code-editor.html': 'Editor de Código',
        'ai-chat.html': 'MindAssist IA',
        'members.html': 'Miembros',
        'voice-calls.html': 'Llamadas',
        'settings.html': 'Configuración'
    };
    
    navLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (tooltips[href]) {
            link.setAttribute('data-tooltip', tooltips[href]);
        } else {
            // Extraer texto del link si no hay tooltip definido
            const textElement = link.querySelector('.nav-link-text');
            if (textElement) {
                const text = textElement.textContent.trim();
                link.setAttribute('data-tooltip', text);
            }
        }
    });
}

// Setup eventos de hover del sidebar
function setupSidebarHover() {
    const sidebar = document.getElementById('sidebar');
    
    if (!sidebar) return;
    
    // Opcional: hacer layout de Monaco cuando se expande/contrae
    sidebar.addEventListener('mouseenter', () => {
        // Delay para que la animación termine
        setTimeout(() => {
            if (monacoEditor) {
                monacoEditor.layout();
            }
        }, 300);
    });
    
    sidebar.addEventListener('mouseleave', () => {
        // Delay para que la animación termine
        setTimeout(() => {
            if (monacoEditor) {
                monacoEditor.layout();
            }
        }, 300);
    });
}

// Función para el menú móvil (mantener la funcionalidad existente)
function toggleSidebarMobile() {
    const sidebar = document.getElementById('sidebar');
    
    if (window.innerWidth <= 768) {
        sidebar.classList.toggle('show');
    }
}

// Setup del botón de menú móvil
function setupMenuToggle() {
    const menuToggle = document.getElementById('menu-toggle');
    if (menuToggle) {
        menuToggle.addEventListener('click', toggleSidebarMobile);
    }
}

// Detectar cambios de tamaño de ventana
function handleResize() {
    const sidebar = document.getElementById('sidebar');
    
    if (window.innerWidth <= 768) {
        // En móvil, remover la clase show si la ventana se hace más grande
        // El hover automático no funciona bien en móvil
    } else {
        // En desktop, asegurar que no tenga la clase show
        sidebar.classList.remove('show');
    }
}

// Event listeners
window.addEventListener('resize', handleResize);

// Cerrar sidebar en móvil al hacer clic fuera
document.addEventListener('click', function(event) {
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        
        if (sidebar && menuToggle && 
            !sidebar.contains(event.target) && 
            !menuToggle.contains(event.target) &&
            sidebar.classList.contains('show')) {
            sidebar.classList.remove('show');
        }
    }
});






function getFileTypeDescription(fileType) {
    const descriptions = {
        'html': 'página web completa',
        'css': 'hoja de estilos moderna',
        'js': 'script funcional',
        'jsx': 'componente React',
        'py': 'programa Python',
        'java': 'clase Java'
    };
    return descriptions[fileType] || 'archivo de código';
}

function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') {
        return String(unsafe);
    }
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function getContextualSuggestions(code, fileType) {
    const suggestions = {
        'html': [
            'agrega un menú de navegación',
            'mejora la estructura semántica',
            'agrega un footer responsive',
            'incluye meta tags para SEO'
        ],
        'css': [
            'hazlo responsive con media queries',
            'agrega animaciones hover',
            'mejora la tipografía y espaciado',
            'agrega modo oscuro'
        ],
        'js': [
            'agrega validación de formularios',
            'implementa manejo de errores',
            'optimiza el performance',
            'agrega funcionalidad de búsqueda'
        ],
        'jsx': [
            'convierte a componente funcional',
            'agrega manejo de estado',
            'implementa loading states',
            'agrega PropTypes'
        ]
    };
    
    const options = suggestions[fileType] || ['mejora este código', 'agrega funcionalidad', 'optimiza el código'];
    return options[Math.floor(Math.random() * options.length)];
}



async function askAI() {
    if (isGeneratingCode) return;
    
    const prompt = document.getElementById('ai-prompt').value.trim();
    if (!prompt) {
        showToast('Describe qué necesitas que haga la IA', 'error');
        return;
    }
    
    isGeneratingCode = true;
    const askBtn = document.getElementById('ask-ai-btn');
    const responseDiv = document.getElementById('ai-response');
    const responseContent = document.getElementById('ai-response-content');
    
    askBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Consultando IA...';
    askBtn.disabled = true;
    responseDiv.style.display = 'block';
    responseContent.innerHTML = '<div class="typing-effect">IA está analizando tu código...</div>';
    
    try {
        const currentCode = (activeTab && monacoEditor) ? monacoEditor.getValue() : '';
        const language = activeTab ? activeTab.type : 'javascript';
        
        console.log('=== DEBUG FRONTEND ===');
        console.log('Current action:', currentAIAction);
        console.log('Language:', language);
        console.log('Has existing code:', !!currentCode);
        console.log('Code length:', currentCode.length);
        console.log('Prompt:', prompt);
        
      let finalPrompt = prompt;

if (currentAIAction === 'fix' && currentCode && currentCode.trim()) {
    finalPrompt = `IDENTIFICA Y CORRIGE SOLO LA PARTE PROBLEMÁTICA:

CÓDIGO COMPLETO:
${currentCode}

ERROR A CORREGIR: ${prompt}

INSTRUCCIONES IMPORTANTES:
- Identifica SOLO las líneas que necesitan corrección
- Devuelve ÚNICAMENTE el fragmento de código corregido
- Incluye 1-2 líneas de contexto antes y después si es necesario
- NO devuelvas todo el código, solo la parte que cambias
- NO agregues explicaciones
- Formato: [líneas de código corregidas]`;
} else if (currentAIAction === 'generate' && currentCode && currentCode.trim()) {
    finalPrompt = `MEJORA/AGREGA AL CÓDIGO EXISTENTE: ${prompt}

Instrucciones específicas:
- Analiza el código actual para mantener consistencia
- Mantén todo lo que ya funciona
- Agrega solo lo que solicito
- Asegúrate de que todo sea compatible`;
}

const requestBody = {
    prompt: finalPrompt,
    code: currentCode,
    language: language,
    action: currentAIAction
};

        
        console.log('Sending request:', requestBody);
        
        const response = await fetch(`${AI_BACKEND_URL}/api/code-companion`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Response received:', {
            success: data.success,
            hasExistingCode: data.hasExistingCode,
            responseLength: data.response ? data.response.length : 0,
            action: data.action
        });
        
// BUSCA esta parte que empieza con "if (data.success && data.response)" y REEMPLÁZALA:
if (data.success && data.response) {
    const aiResponse = data.response.trim();
    
    if (!aiResponse) {
        throw new Error('La IA devolvió una respuesta vacía');
    }
    
    // NUEVO: Manejo específico según la acción
    if (currentAIAction === 'fix') {
        // Para correcciones, extraer solo el código sin explicaciones
        const cleanCode = cleanGeneratedCode(aiResponse);
        
        responseContent.innerHTML = `
            <div style="margin-bottom: 15px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; border-radius: 4px;">
                <strong>🔧 Errores corregidos</strong>
                <br><small style="color: #8892a6;">Código con correcciones listo para aplicar</small>
            </div>
            <pre><code class="language-${language}">${escapeHtml(cleanCode)}</code></pre>
        `;
        
        // Almacenar código limpio para aplicar
        responseContent.dataset.fullCode = cleanCode;
        responseContent.dataset.isContextual = 'false';
        
        // Highlight syntax
        if (typeof hljs !== 'undefined') {
            hljs.highlightAll();
        }
        
        // Mostrar botón aplicar SOLO para fix
        const applyBtn = document.getElementById('apply-code-btn');
        if (applyBtn) {
            applyBtn.style.display = 'inline-block';
            applyBtn.innerHTML = '<i class="fas fa-wrench"></i> Aplicar Correcciones';
        }
        
    } else {
        // Para explicaciones y revisiones, solo texto
        await typeWriterEffect(responseContent, aiResponse);
        
        // Ocultar botón aplicar para otras acciones
        const applyBtn = document.getElementById('apply-code-btn');
        if (applyBtn) {
            applyBtn.style.display = 'none';
        }
    }
    
} else {
    throw new Error(data.error || 'Respuesta inválida de la IA');
}
 } catch (error) {
    console.error('Error asking AI:', error);
    const currentCode = (activeTab && monacoEditor) ? monacoEditor.getValue() : '';
    
    responseContent.innerHTML = `
        <div style="color: #ef4444; padding: 15px; border: 1px solid #ef4444; border-radius: 8px;">
            <strong>❌ Error:</strong> ${error.message}
            <br><small style="margin-top: 8px; display: block; opacity: 0.8;">
                ${currentCode ? 'Intenta reformular tu pregunta sobre el código existente' : 'Verifica tu conexión e intenta de nuevo'}
            </small>
        </div>`;
}
    
    askBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Consultar IA';
    askBtn.disabled = false;
    isGeneratingCode = false;
}









function applyCodePatch() {
    if (!activeTab || !monacoEditor) {
        showToast('Abre un archivo primero', 'error');
        return;
    }
    
    const responseContent = document.getElementById('ai-response-content');
    let patchCode = responseContent.dataset.fullCode || '';
    
    if (!patchCode.trim()) {
        showToast('No hay corrección para aplicar', 'error');
        return;
    }
    
    const currentCode = monacoEditor.getValue();
    const correctedCode = applyIntelligentPatch(currentCode, patchCode);
    
    if (correctedCode && correctedCode !== currentCode) {
        monacoEditor.setValue(correctedCode);
        
        if (activeTab) {
            activeTab.modified = true;
            activeTab.content = correctedCode;
            renderTabs();
            isEditing = true;
        }
        
        showToast('Corrección aplicada correctamente', 'success');
        closeAIModal();
    } else {
        showToast('No se pudo aplicar la corrección automáticamente', 'error');
    }
}

function applyIntelligentPatch(originalCode, patchCode) {
    // Limpiar el código del parche
    const cleanPatch = cleanGeneratedCode(patchCode);
    const originalLines = originalCode.split('\n');
    const patchLines = cleanPatch.split('\n');
    
    // Buscar patrones similares para encontrar dónde aplicar el parche
    for (let i = 0; i <= originalLines.length - patchLines.length; i++) {
        let matchScore = 0;
        
        for (let j = 0; j < patchLines.length; j++) {
            const originalLine = originalLines[i + j]?.trim() || '';
            const patchLine = patchLines[j].trim();
            
            // Calcular similitud (simple)
            if (originalLine === patchLine) {
                matchScore += 1;
            } else if (originalLine.length > 0 && patchLine.length > 0) {
                // Similitud parcial para líneas modificadas
                const similarity = calculateSimilarity(originalLine, patchLine);
                if (similarity > 0.5) {
                    matchScore += similarity;
                }
            }
        }
        
        // Si hay suficiente similitud, aplicar el parche
        if (matchScore / patchLines.length > 0.7) {
            const newLines = [
                ...originalLines.slice(0, i),
                ...patchLines,
                ...originalLines.slice(i + patchLines.length)
            ];
            return newLines.join('\n');
        }
    }
    
    // Si no encuentra coincidencia exacta, intentar reemplazo por palabras clave
    return applyKeywordBasedPatch(originalCode, cleanPatch);
}

function applyKeywordBasedPatch(originalCode, patchCode) {
    // Buscar líneas con errores comunes y reemplazarlas
    const errorPatterns = [
        /firebase\.database\);/g,  // Error de Firebase
        /console\.log\(/g,         // Errores de console
        /function\s+\w+\(/g,       // Errores de función
        /var\s+\w+\s*=/g,         // Errores de variables
    ];
    
    let correctedCode = originalCode;
    
    errorPatterns.forEach(pattern => {
        const originalMatches = originalCode.match(pattern);
        const patchMatches = patchCode.match(pattern);
        
        if (originalMatches && patchMatches && originalMatches.length === patchMatches.length) {
            originalMatches.forEach((match, index) => {
                if (patchMatches[index] !== match) {
                    correctedCode = correctedCode.replace(match, patchMatches[index]);
                }
            });
        }
    });
    
    return correctedCode;
}

function calculateSimilarity(str1, str2) {
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;
    
    if (longer.length === 0) return 1.0;
    
    const editDistance = levenshteinDistance(longer, shorter);
    return (longer.length - editDistance) / longer.length;
}

function levenshteinDistance(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    return matrix[str2.length][str1.length];
}

async function typeWriterEffect(element, text) {
    element.innerHTML = '';
    const words = text.split(' ');
    
    for (let i = 0; i < words.length; i++) {
        element.innerHTML += words[i] + ' ';
        await new Promise(resolve => setTimeout(resolve, 50));
    }
}

function cleanGeneratedCode(code) {
    let cleaned = code
        // Remover markdown
        .replace(/```[\w]*\n?/g, '')
        .replace(/```\n?/g, '')
        .replace(/^\s*```[\w]*$/gm, '')
        .replace(/^\s*```\s*$/gm, '')
        
        // Remover explicaciones típicas de IA (más agresivo)
        .replace(/^(Aquí tienes|Este código|El siguiente código|Aquí está|He corregido|Los errores han sido|Correcciones aplicadas).*?[:\.]\s*/gi, '')
        .replace(/^(Errores encontrados|Problemas detectados|Correcciones realizadas).*?\n/gi, '')
        .replace(/^(Análisis|Explicación|Descripción|Resumen).*?\n/gi, '')
        .replace(/^(Error \d+:|Corrección \d+:|Línea \d+:).*?\n/gi, '')
        
        // Remover líneas que son pura explicación
        .split('\n')
        .filter(line => {
            const trimmedLine = line.trim();
            // Filtrar líneas explicativas
            return !trimmedLine.match(/^(El error estaba|El problema era|Ahora el código|La corrección|Se ha corregido)/i) &&
                   !trimmedLine.match(/^(Cambios realizados|Errores solucionados|Modificaciones)/i);
        })
        .join('\n')
        
        // Limpiar espacios
        .replace(/^\s*\n+/, '')
        .replace(/\n+\s*$/, '')
        .trim();
    
    return cleaned;
}

function applyCodeToEditor() {
    if (!activeTab || !monacoEditor) {
        showToast('Abre un archivo primero', 'error');
        return;
    }
    
    const responseContent = document.getElementById('ai-response-content');
    let codeToApply = responseContent.dataset.fullCode || '';
    const isContextual = responseContent.dataset.isContextual === 'true';
    
    if (!codeToApply.trim()) {
        // Fallback a método anterior
        const codeElement = responseContent.querySelector('code');
        codeToApply = codeElement ? codeElement.textContent : responseContent.textContent;
    }
    
    if (!codeToApply.trim()) {
        showToast('No hay código para aplicar', 'error');
        return;
    }
    
    // Limpiar código
    codeToApply = cleanGeneratedCode(codeToApply);
    
    // Validar código por tipo de archivo
    const fileType = activeTab.type.toLowerCase();
    if (!validateGeneratedCode(codeToApply, fileType)) {
        showToast(`El código generado no es válido para archivos ${fileType.toUpperCase()}`, 'error');
        return;
    }
    
    // Mostrar confirmación si es actualización contextual de código grande
    if (isContextual && activeTab.content.length > 500) {
        const confirmMsg = `¿Aplicar los cambios sugeridos por la IA al archivo ${activeTab.name}?\n\nEsto reemplazará todo el código actual.`;
        if (!confirm(confirmMsg)) {
            return;
        }
    }
    
    // Aplicar código con animación suave
    monacoEditor.setValue('');
    setTimeout(() => {
        monacoEditor.setValue(codeToApply.trim());
        
        if (activeTab) {
            activeTab.modified = true;
            activeTab.content = codeToApply.trim();
            renderTabs();
            isEditing = true;
        }
        
        const message = isContextual 
            ? `Código actualizado con las mejoras de la IA`
            : `Código aplicado correctamente`;
        showToast(message, 'success');
        
        closeAIModal();
    }, 100);
}

function validateGeneratedCode(code, fileType) {
    const trimmed = code.trim();
    
    const validators = {
        'html': () => trimmed.includes('<') && trimmed.includes('>') && trimmed.length > 20,
        'css': () => trimmed.includes('{') && trimmed.includes('}') && trimmed.includes(':'),
        'js': () => trimmed.length > 10 && (
            trimmed.includes('function') || trimmed.includes('=>') || 
            trimmed.includes('const') || trimmed.includes('let') || 
            trimmed.includes('var') || trimmed.includes('class')
        ),
        'jsx': () => trimmed.includes('React') || trimmed.includes('<') || trimmed.includes('=>'),
        'ts': () => trimmed.includes('interface') || trimmed.includes('type') || trimmed.includes('function'),
        'tsx': () => (trimmed.includes('React') || trimmed.includes('<')) && 
                    (trimmed.includes('interface') || trimmed.includes('type')),
        'py': () => trimmed.includes('def ') || trimmed.includes('class ') || 
                   trimmed.includes('import ') || trimmed.includes('from '),
        'java': () => trimmed.includes('class ') || trimmed.includes('public ') || 
                     trimmed.includes('private '),
        'php': () => trimmed.includes('<?php') || trimmed.includes('function ') || 
                    trimmed.includes('class '),
        'go': () => trimmed.includes('package ') || trimmed.includes('func '),
        'rs': () => trimmed.includes('fn ') || trimmed.includes('struct ') || 
                   trimmed.includes('impl '),
        'default': () => trimmed.length > 5
    };
    
    const validator = validators[fileType] || validators['default'];
    return validator();
}

async function typeCodeIntoEditor(code) {
    const lines = code.split('\n');
    let currentContent = '';
    
    for (const line of lines) {
        currentContent += line + '\n';
        monacoEditor.setValue(currentContent);
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    if (activeTab) {
        activeTab.modified = true;
        activeTab.content = code;
        renderTabs();
        isEditing = true;
    }
}

async function exportCurrentFile() {
    if (!activeTab || !monacoEditor) {
        showToast('Abre un archivo para exportar', 'error');
        return;
    }
    
    try {
        const currentContent = monacoEditor.getValue();
        if (!currentContent.trim()) {
            showToast('El archivo está vacío', 'error');
            return;
        }
        
        showToast('Preparando exportación del archivo...', 'info');
        
        const response = await fetch(`${AI_BACKEND_URL}/api/export-current-file`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                fileName: activeTab.name,
                content: currentContent,
                fileType: activeTab.type
            })
        });
        
        if (!response.ok) throw new Error('Error en exportación');
        
        const data = await response.json();
        
        if (data.success) {
            const blob = new Blob([data.data.content], { 
                type: getContentType(data.data.type)
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = data.data.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`${data.data.name} exportado correctamente`, 'success');
        }
        
    } catch (error) {
        console.error('Error exporting file:', error);
        showToast('Error exportando archivo', 'error');
    }
}
function getContentType(fileType) {
    const contentTypes = {
        // Web Technologies
        'html': 'text/html',
        'htm': 'text/html',
        'css': 'text/css',
        'scss': 'text/css',
        'sass': 'text/css',
        'less': 'text/css',
        'stylus': 'text/css',
        'js': 'text/javascript',
        'jsx': 'text/javascript',
        'ts': 'text/typescript',
        'tsx': 'text/typescript',
        'xml': 'application/xml',
        'svg': 'image/svg+xml',
        'vue': 'text/x-vue',
        'svelte': 'text/x-svelte',
        'astro': 'text/x-astro',
        'solid': 'text/x-solid',
        
        // Data Formats
        'json': 'application/json',
        'json5': 'application/json5',
        'jsonl': 'application/jsonl',
        'ndjson': 'application/x-ndjson',
        'csv': 'text/csv',
        'tsv': 'text/tab-separated-values',
        'yaml': 'text/x-yaml',
        'yml': 'text/x-yaml',
        'toml': 'text/x-toml',
        'ini': 'text/x-ini',
        'cfg': 'text/x-ini',
        'properties': 'text/x-properties',
        'avro': 'application/avro',
        'parquet': 'application/x-parquet',
        'orc': 'application/x-orc',
        
        // Programming Languages - Popular
        'py': 'text/x-python',
        'python': 'text/x-python',
        'pyw': 'text/x-python',
        'java': 'text/x-java-source',
        'class': 'application/java-vm',
        'c': 'text/x-c',
        'cpp': 'text/x-c++',
        'cxx': 'text/x-c++',
        'cc': 'text/x-c++',
        'c++': 'text/x-c++',
        'h': 'text/x-c',
        'hpp': 'text/x-c++',
        'hxx': 'text/x-c++',
        'cs': 'text/x-csharp',
        'csproj': 'application/xml',
        'php': 'text/x-php',
        'php3': 'text/x-php',
        'php4': 'text/x-php',
        'php5': 'text/x-php',
        'phtml': 'text/x-php',
        'rb': 'text/x-ruby',
        'ruby': 'text/x-ruby',
        'go': 'text/x-go',
        'rs': 'text/x-rust',
        'swift': 'text/x-swift',
        'kt': 'text/x-kotlin',
        'kts': 'text/x-kotlin',
        'scala': 'text/x-scala',
        'sc': 'text/x-scala',
        
        // Programming Languages - Scripting
        'pl': 'text/x-perl',
        'pm': 'text/x-perl',
        'r': 'text/x-r',
        'rmd': 'text/x-r-markdown',
        'matlab': 'text/x-matlab',
        'm': 'text/x-objectivec',
        'mm': 'text/x-objectivec',
        'lua': 'text/x-lua',
        'tcl': 'text/x-tcl',
        'tk': 'text/x-tcl',
        
        // Shell & Scripts
        'sh': 'text/x-shellscript',
        'bash': 'text/x-shellscript',
        'zsh': 'text/x-shellscript',
        'fish': 'text/x-shellscript',
        'csh': 'text/x-shellscript',
        'ksh': 'text/x-shellscript',
        'ps1': 'text/x-powershell',
        'psm1': 'text/x-powershell',
        'psd1': 'text/x-powershell',
        'bat': 'text/x-batch',
        'cmd': 'text/x-batch',
        
        // Database & Query Languages
        'sql': 'text/x-sql',
        'mysql': 'text/x-sql',
        'pgsql': 'text/x-sql',
        'sqlite': 'text/x-sql',
        'plsql': 'text/x-plsql',
        'mongodb': 'text/x-mongodb',
        'redis': 'text/x-redis',
        'cassandra': 'text/x-cql',
        'cql': 'text/x-cql',
        'neo4j': 'text/x-cypher',
        'cypher': 'text/x-cypher',
        'sparql': 'application/sparql-query',
        'xquery': 'application/xquery',
        'graphql': 'application/graphql',
        'gql': 'application/graphql',
        
        // Functional Languages
        'hs': 'text/x-haskell',
        'haskell': 'text/x-haskell',
        'lhs': 'text/x-haskell',
        'ml': 'text/x-ocaml',
        'mli': 'text/x-ocaml',
        'fs': 'text/x-fsharp',
        'fsi': 'text/x-fsharp',
        'fsx': 'text/x-fsharp',
        'clj': 'text/x-clojure',
        'cljs': 'text/x-clojure',
        'cljc': 'text/x-clojure',
        'elm': 'text/x-elm',
        'erl': 'text/x-erlang',
        'hrl': 'text/x-erlang',
        'ex': 'text/x-elixir',
        'exs': 'text/x-elixir',
        'lisp': 'text/x-lisp',
        'lsp': 'text/x-lisp',
        'scm': 'text/x-scheme',
        'scheme': 'text/x-scheme',
        
        // Mobile Development
        'dart': 'text/x-dart',
        'flutter': 'text/x-dart',
        'xaml': 'application/xml',
        
        // Game Development & Graphics
        'gdscript': 'text/x-gdscript',
        'gd': 'text/x-gdscript',
        'unity': 'text/x-csharp',
        'hlsl': 'text/x-hlsl',
        'glsl': 'text/x-glsl',
        'shader': 'text/x-shader',
        'vert': 'text/x-glsl',
        'frag': 'text/x-glsl',
        
        // JVM Languages
        'groovy': 'text/x-groovy',
        'gradle': 'text/x-gradle',
        'sbt': 'text/x-sbt',
        
        // Configuration & Infrastructure
        'dockerfile': 'text/x-dockerfile',
        'docker': 'text/x-dockerfile',
        'dockerignore': 'text/plain',
        'terraform': 'text/x-terraform',
        'tf': 'text/x-terraform',
        'tfvars': 'text/x-terraform',
        'hcl': 'text/x-hcl',
        'nomad': 'text/x-nomad',
        'consul': 'text/x-consul',
        'ansible': 'text/x-yaml',
        'puppet': 'text/x-puppet',
        'pp': 'text/x-puppet',
        'chef': 'text/x-ruby',
        'vagrant': 'text/x-ruby',
        'vagrantfile': 'text/x-ruby',
        
        // Documentation
        'md': 'text/markdown',
        'markdown': 'text/markdown',
        'mdown': 'text/markdown',
        'mkd': 'text/markdown',
        'mdx': 'text/x-mdx',
        'rst': 'text/x-rst',
        'tex': 'text/x-tex',
        'latex': 'text/x-tex',
        'bib': 'text/x-bibtex',
        'txt': 'text/plain',
        'text': 'text/plain',
        'log': 'text/plain',
        'readme': 'text/plain',
        'changelog': 'text/plain',
        'license': 'text/plain',
        'authors': 'text/plain',
        'contributors': 'text/plain',
        'news': 'text/plain',
        'todo': 'text/plain',
        
        // Assembly & Low Level
        'asm': 'text/x-assembly',
        's': 'text/x-assembly',
        'nasm': 'text/x-assembly',
        'masm': 'text/x-assembly',
        'gas': 'text/x-assembly',
        
        // DSLs & Domain Specific
        'prisma': 'text/x-prisma',
        'proto': 'text/x-protobuf',
        'protobuf': 'text/x-protobuf',
        'thrift': 'text/x-thrift',
        'avdl': 'text/x-avro-idl',
        'capnp': 'text/x-capnp',
        
        // Web Frameworks & Templates
        'jsp': 'text/x-jsp',
        'jspx': 'text/x-jsp',
        'asp': 'text/x-asp',
        'aspx': 'text/x-aspx',
        'ascx': 'text/x-aspx',
        'erb': 'text/x-ruby-template',
        'ejs': 'text/x-ejs',
        'hbs': 'text/x-handlebars',
        'handlebars': 'text/x-handlebars',
        'mustache': 'text/x-mustache',
        'twig': 'text/x-twig',
        'smarty': 'text/x-smarty',
        'tpl': 'text/x-smarty',
        'blade': 'text/x-blade',
        'razor': 'text/x-razor',
        'cshtml': 'text/x-razor',
        'vbhtml': 'text/x-razor',
        'pug': 'text/x-pug',
        'jade': 'text/x-jade',
        'haml': 'text/x-haml',
        'slim': 'text/x-slim',
        
        // Blockchain & Crypto
        'solidity': 'text/x-solidity',
        'sol': 'text/x-solidity',
        'move': 'text/x-move',
        'cairo': 'text/x-cairo',
        'vyper': 'text/x-vyper',
        'vy': 'text/x-vyper',
        'clarity': 'text/x-clarity',
        'clar': 'text/x-clarity',
        
        // Scientific & Statistical
        'sas': 'text/x-sas',
        'spss': 'text/x-spss',
        'stata': 'text/x-stata',
        'do': 'text/x-stata',
        'ado': 'text/x-stata',
        'jupyter': 'application/x-ipynb+json',
        'ipynb': 'application/x-ipynb+json',
        'mathematica': 'text/x-mathematica',
        'nb': 'application/mathematica',
        'wl': 'text/x-wolfram',
        'wls': 'text/x-wolfram',
        
        // Legacy & Specialized
        'fortran': 'text/x-fortran',
        'f': 'text/x-fortran',
        'f77': 'text/x-fortran',
        'f90': 'text/x-fortran',
        'f95': 'text/x-fortran',
        'f03': 'text/x-fortran',
        'f08': 'text/x-fortran',
        'for': 'text/x-fortran',
        'cobol': 'text/x-cobol',
        'cob': 'text/x-cobol',
        'cbl': 'text/x-cobol',
        'pascal': 'text/x-pascal',
        'pas': 'text/x-pascal',
        'delphi': 'text/x-pascal',
        'dfm': 'text/x-pascal',
        'ada': 'text/x-ada',
        'adb': 'text/x-ada',
        'ads': 'text/x-ada',
        'vb': 'text/x-vb',
        'vbs': 'text/x-vbscript',
        'vba': 'text/x-vba',
        'basic': 'text/x-basic',
        'bas': 'text/x-basic',
        
        // Version Control
        'gitignore': 'text/plain',
        'gitattributes': 'text/plain',
        'gitconfig': 'text/plain',
        'gitmodules': 'text/plain',
        'hgignore': 'text/plain',
        'bzrignore': 'text/plain',
        'svnignore': 'text/plain',
        
        // Package Managers & Dependencies
        'lock': 'application/json',
        'sum': 'text/plain',
        'mod': 'text/plain',
        'sum': 'text/plain',
        'requirements': 'text/plain',
        'pipfile': 'text/x-toml',
        'gemfile': 'text/x-ruby',
        'podfile': 'text/x-ruby',
        'cartfile': 'text/plain',
        'package': 'application/json',
        'composer': 'application/json',
        'cargo': 'text/x-toml',
        'mix': 'text/x-elixir',
        'rebar': 'text/x-erlang',
        
        // Environment & Secrets
        'env': 'text/plain',
        'environment': 'text/plain',
        'dotenv': 'text/plain',
        'secrets': 'text/plain',
        'vault': 'text/plain',
        
        // Build Systems
        'makefile': 'text/x-makefile',
        'make': 'text/x-makefile',
        'cmake': 'text/x-cmake',
        'cmakecache': 'text/x-cmake',
        'ninja': 'text/x-ninja',
        'bazel': 'text/x-bazel',
        'buck': 'text/x-buck',
        'pants': 'text/x-pants',
        'scons': 'text/x-scons',
        'rake': 'text/x-ruby',
        'rakefile': 'text/x-ruby',
        'ant': 'application/xml',
        'maven': 'application/xml',
        'pom': 'application/xml',
        'ivy': 'application/xml',
        
        // CI/CD
        'jenkinsfile': 'text/x-groovy',
        'travis': 'text/x-yaml',
        'circle': 'text/x-yaml',
        'appveyor': 'text/x-yaml',
        'github': 'text/x-yaml',
        'gitlab': 'text/x-yaml',
        'azure': 'text/x-yaml',
        'bitbucket': 'text/x-yaml',
        
        // Testing
        'test': 'text/javascript',
        'spec': 'text/javascript',
        'feature': 'text/x-gherkin',
        'story': 'text/x-gherkin',
        'cucumber': 'text/x-gherkin',
        
        // IDE & Editor
        'editorconfig': 'text/x-editorconfig',
        'eslintrc': 'application/json',
        'prettierrc': 'application/json',
        'babelrc': 'application/json',
        'tsconfig': 'application/json',
        'jsconfig': 'application/json',
        'webpack': 'text/javascript',
        'rollup': 'text/javascript',
        'vite': 'text/javascript',
        'gulpfile': 'text/javascript',
        'gruntfile': 'text/javascript',
        
        // Documentation Formats
        'adoc': 'text/x-asciidoc',
        'asciidoc': 'text/x-asciidoc',
        'creole': 'text/x-creole',
        'textile': 'text/x-textile',
        'pod': 'text/x-pod',
        'wiki': 'text/x-wiki',
        'mediawiki': 'text/x-mediawiki',
        
        // Binary Formats (for reference, usually not editable)
        'exe': 'application/octet-stream',
        'dll': 'application/octet-stream',
        'so': 'application/octet-stream',
        'dylib': 'application/octet-stream',
        'bin': 'application/octet-stream',
        
        // Default fallback
        'default': 'text/plain'
    };
    
    // Clean the file type and make it lowercase
    const cleanFileType = fileType.toLowerCase().trim();
    
    // Return the content type or default to text/plain
    return contentTypes[cleanFileType] || contentTypes['default'];
}
function setupErrorDetection() {
    if (!monacoEditor) return;
    
    monacoEditor.onDidChangeModelContent(() => {
        if (activeTab) {
            setTimeout(() => checkForErrors(), 1000);
        }
    });
}

function checkForErrors() {
    if (!monacoEditor || !activeTab) return;
    
    const code = monacoEditor.getValue();
    const markers = monaco.editor.getModelMarkers({ owner: 'typescript' });
    
    if (markers.length > 0) {
        const firstError = markers[0];
        showErrorInspector(firstError.message, firstError);
    }
}

function showErrorInspector(message, errorDetails) {
    const inspector = document.getElementById('error-inspector');
    const messageEl = document.getElementById('error-message');
    
    if (inspector && messageEl) {
        messageEl.textContent = message;
        inspector.style.display = 'block';
        
        setTimeout(() => {
            inspector.style.display = 'none';
        }, 10000);
    }
    
    const fixBtn = document.getElementById('fix-error-btn');
    if (fixBtn) {
        fixBtn.onclick = () => fixErrorWithAI(message, errorDetails);
    }
}

function closeErrorInspector() {
    const inspector = document.getElementById('error-inspector');
    if (inspector) inspector.style.display = 'none';
}

async function fixErrorWithAI(errorMessage, errorDetails) {
    closeErrorInspector();
    
    currentAIAction = 'fix';
    document.querySelectorAll('.ai-action-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.ai-action-btn[data-action="fix"]').classList.add('active');
    
    const prompt = document.getElementById('ai-prompt');
    prompt.value = `Tengo este error: ${errorMessage}\n\nPor favor corrige el código.`;
    
    showAICompanionModal();
    setTimeout(() => askAI(), 500);
}


// Convertir \n\n a <br><br> o <p>
function formatResponse(text) {
    return text
        .split('\n\n')
        .map(paragraph => `<p>${paragraph.trim()}</p>`)
        .join('');
}

// O simplemente reemplazar saltos
function formatResponseSimple(text) {
    return text.replace(/\n\n/g, '<br><br>');
}


// === FUNCIÓN SIMPLE PARA PRESERVAR RESPUESTAS DE IA ===

// Variable global para guardar la última respuesta
let lastAIResponse = null;

// Función para guardar respuesta cuando la IA responde
function saveLastAIResponse() {
    const prompt = document.getElementById('ai-prompt')?.value || '';
    const responseContent = document.getElementById('ai-response-content')?.innerHTML || '';
    const fullCode = document.getElementById('ai-response-content')?.dataset.fullCode || '';
    
    if (prompt || responseContent) {
        lastAIResponse = {
            prompt: prompt,
            responseHTML: responseContent,
            fullCode: fullCode,
            action: currentAIAction,
            timestamp: new Date().toISOString(),
            fileName: activeTab?.name || 'Sin archivo'
        };
        
        // Guardar en localStorage para que persista entre sesiones
        try {
            localStorage.setItem('lastAIResponse', JSON.stringify(lastAIResponse));
            console.log('Respuesta IA guardada');
        } catch (error) {
            console.error('Error guardando respuesta:', error);
        }
    }
}

// Función para restaurar la última respuesta cuando se abre el modal
function restoreLastAIResponse() {
    try {
        // Primero intentar desde memoria
        if (!lastAIResponse) {
            const stored = localStorage.getItem('lastAIResponse');
            if (stored) {
                lastAIResponse = JSON.parse(stored);
            }
        }
        
        if (lastAIResponse) {
            const prompt = document.getElementById('ai-prompt');
            const response = document.getElementById('ai-response');
            const responseContent = document.getElementById('ai-response-content');
            
            // Restaurar prompt solo si está vacío
            if (prompt && !prompt.value.trim()) {
                prompt.value = lastAIResponse.prompt;
            }
            
            // Restaurar respuesta
            if (response && responseContent && lastAIResponse.responseHTML) {
                response.style.display = 'block';
                responseContent.innerHTML = `
                    <div style="margin-bottom: 10px; padding: 8px; background: rgba(74, 158, 255, 0.1); border-left: 3px solid #4a9eff; border-radius: 4px; font-size: 12px;">
                        📝 Última respuesta guardada - ${lastAIResponse.fileName}
                    </div>
                    ${lastAIResponse.responseHTML}
                `;
                
                // Restaurar código si existe
                if (lastAIResponse.fullCode) {
                    responseContent.dataset.fullCode = lastAIResponse.fullCode;
                    
                    const applyBtn = document.getElementById('apply-code-btn');
                    if (applyBtn && lastAIResponse.action === 'fix') {
                        applyBtn.style.display = 'inline-block';
                    }
                }
                
                showToast('Respuesta anterior restaurada', 'info');
            }
        }
    } catch (error) {
        console.error('Error restaurando respuesta:', error);
    }
}

// Modificar la función closeAIModal (REEMPLAZAR la existente)
function closeAIModal() {
    // GUARDAR antes de cerrar
    saveLastAIResponse();
    
    const modal = document.getElementById('ai-companion-modal');
    if (modal) modal.style.display = 'none';
    
    // NO limpiar nada, solo ocultar el modal
    // Resetear solo la acción
    currentAIAction = 'generate';
    document.querySelectorAll('.ai-action-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.ai-action-btn[data-action="generate"]')?.classList.add('active');
}

// Modificar showAICompanionModal (REEMPLAZAR la existente)
function showAICompanionModal() {
    if (!['owner', 'admin'].includes(currentUserRole)) {
        showToast('No tienes permisos para usar IA Companion', 'error');
        return;
    }
    
    const modal = document.getElementById('ai-companion-modal');
    if (modal) modal.style.display = 'flex';
    
    // Restaurar respuesta anterior
    setTimeout(() => restoreLastAIResponse(), 100);
    
    // Focus en prompt
    const prompt = document.getElementById('ai-prompt');
    if (prompt) prompt.focus();
}


function addSaveToAskAI() {
    // Esta función modifica la askAI existente
    const originalAskAI = window.askAI;
    
    window.askAI = async function() {
        await originalAskAI();
        // Guardar después de que la IA responde
        setTimeout(() => saveLastAIResponse(), 500);
    };
}

// Función para limpiar respuestas guardadas (opcional)
function clearSavedAIResponse() {
    lastAIResponse = null;
    localStorage.removeItem('lastAIResponse');
    showToast('Respuestas guardadas eliminadas', 'success');
}

// Inicializar al cargar la página 
document.addEventListener('DOMContentLoaded', function() {
    
    addSaveToAskAI();
    
    console.log('Sistema de persistencia IA inicializado');
});

// Función extra: Botón para ver respuesta guardada (opcional)
function addViewSavedResponseButton() {
    const aiActions = document.querySelector('.ai-actions');
    if (aiActions) {
        const button = document.createElement('button');
        button.className = 'ai-action-btn';
        button.innerHTML = '<i class="fas fa-history"></i>Última Respuesta';
        button.onclick = () => {
            restoreLastAIResponse();
        };
        aiActions.appendChild(button);
    }
}

// Hacer funciones globales
window.closeAIModal = closeAIModal;
window.closeErrorInspector = closeErrorInspector;
window.showDeleteRepositoryModal = showDeleteRepositoryModal;
window.showCreateRepositoryModal = showCreateRepositoryModal;
window.createRepository = createRepository;
window.closeRepositoryModal = () => {
    document.querySelector('.modal-overlay')?.remove();
};
window.closeTab = closeTab;
window.closeNewFileModal = closeNewFileModal;
window.createNewFile = createNewFile;
window.toggleTheme = toggleTheme;
window.toggleLanguageDropdown = toggleLanguageDropdown;
window.changeLanguage = changeLanguage;
</script>
</body>
</html>


