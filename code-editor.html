<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor - OpenMind AI</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="css/noti.css">
<style>


* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: white;
    min-height: 100vh;
    overflow: hidden;
}



/* Tema oscuro por defecto */
body:not([data-theme="light"]) {
    background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0f1419 100%);
    color: white;
}

/* Tema claro */
[data-theme="light"] body {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
    color: #1e293b;
}



.delete-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    background: #ef4444;
    color: white;
}

.delete-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
}

.delete-btn:disabled {
    background: rgba(239, 68, 68, 0.5) !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
}

.logo {
    display: flex;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    color: #4a9eff;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.logo-icon {
    width: 24px;
    height: 24px;
    margin-right: 8px;
    background: linear-gradient(45deg, #4a9eff, #00d4ff);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
}

.nav-menu {
    list-style: none;
}

.nav-item {
    margin-bottom: 8px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    color: #8892a6;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-size: 14px;
}

.nav-link:hover, .nav-link.active {
    background: rgba(74, 158, 255, 0.1);
    color: #4a9eff;
}

.nav-link i {
    margin-right: 12px;
    width: 16px;
    text-align: center;
}

/* Main Content */
.main-content {
    margin-left: 260px;
    min-height: 100vh;
    padding: 0;
    transition: margin-left 0.3s ease;
    display: flex;
    flex-direction: column;
}

.main-content.expanded {
    margin-left: 0;
}

/* Header */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 30px;
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
    position: relative;
    z-index: 50;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 20px;
}

.menu-toggle {
    background: none;
    border: none;
    color: #8892a6;
    font-size: 18px;
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.3s ease;
    display: none;
}

.menu-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #4a9eff;
}

.page-title {
    font-size: 18px;
    font-weight: 600;
    color: #ffffff;
}

.project-name-header {
    font-size: 14px;
    color: #4a9eff;
    font-weight: 500;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.welcome-text {
    color: #8892a6;
    font-size: 13px;
}

.user-name {
    color: #4a9eff;
    font-weight: 600;
}

.logout-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.logout-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* Header controls */
.header-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.control-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #8892a6;
     padding: 14px 13px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.control-btn:hover {
    background: rgba(74, 158, 255, 0.1);
    border-color: #4a9eff;
    color: #4a9eff;
}

/* Language Selector */
.language-selector {
    position: relative;
    z-index: 200;
}

.language-dropdown {
    position: fixed;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.2);
    border-radius: 8px;
    padding: 8px 0;
    min-width: 180px;
    display: none;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 99999;
}

.language-dropdown.show {
    display: block;
}

.language-option {
    padding: 8px 16px;
    cursor: pointer;
    font-size: 12px;
    color: #8892a6;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.language-option:hover {
    background: rgba(74, 158, 255, 0.1);
    color: #4a9eff;
}

.language-option.active {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
}

/* Code Editor View */
.code-editor-container {
    flex: 1 !important;
    display: flex !important;
    flex-direction: row !important;
    height: 100% !important;
    overflow: hidden !important;
}

.file-explorer {
    width: 250px;
    background: rgba(15, 20, 25, 0.8);
    border-right: 1px solid rgba(74, 158, 255, 0.2);
    display: flex;
    flex-direction: column;
}

.explorer-header {
    padding: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.explorer-title {
    font-size: 14px;
    font-weight: 600;
    color: #ffffff;
    flex: 1;
}

.new-file-btn {
    background: rgba(74, 158, 255, 0.2);
    border: none;
    color: #4a9eff;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    margin-left: 5px;
}

.new-file-btn:hover {
    background: rgba(74, 158, 255, 0.3);
}

/* === FIX SCROLLBAR FILE EXPLORER === */
/* === FIX SCROLLBAR FILE EXPLORER === */
.file-tree {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 10px;
    /* CLAVE: Altura calculada para no tapar status bar */
    max-height: calc(100vh - 180px); /* Ajustado para status bar */
    min-height: 0;
    
    /* Scrollbar personalizada */
    scrollbar-width: thin;
    scrollbar-color: rgba(74, 158, 255, 0.6) rgba(255, 255, 255, 0.1);
}

/* Scrollbar para WebKit browsers */
.file-tree::-webkit-scrollbar {
    width: 8px;
    background: transparent;
}

.file-tree::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    margin: 4px 0;
}

.file-tree::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #4a9eff, #00d4ff);
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

.file-tree::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #5aa8ff, #20ddff);
    box-shadow: 0 0 8px rgba(74, 158, 255, 0.4);
}


.file-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 13px;
    color: #8892a6;
    transition: all 0.3s ease;
    margin-bottom: 2px;
}

.file-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #ffffff;
}

.file-item.active {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
}

.file-item i {
    margin-right: 8px;
    width: 16px;
    text-align: center;
}

.folder-item {
    font-weight: 500;
}

.folder-content {
    overflow: hidden;
    transition: all 0.2s ease;
    margin-left: 13px;
}

.editor-main {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    min-height: 0 !important; /* CLAVE: Permite que se contraiga */
    min-width: 0 !important;  /* CLAVE: Permite que se contraiga horizontalmente */
    max-width: 100% !important;
    overflow: hidden !important; /* Evita desbordamientos */
    position: relative !important;
    background: rgba(15, 20, 25, 0.95) !important;
    border-left: 1px solid rgba(74, 158, 255, 0.1) !important;
}


/* === PESTAÑAS CORREGIDAS === */



.editor-tab i {
    flex-shrink: 0 !important;
    width: 14px !important;
    margin-right: 4px !important;
    font-size: 12px !important;
}

.editor-tab > span:not(.close-tab) {
    flex: 1 !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    max-width: 70px !important; /* Reducido para dar más espacio al botón cerrar */
    line-height: 1.2 !important;
    display: block !important;
}



.editor-tab .close-tab {
    position: absolute !important;
    right: 6px !important; /* Reducido de 8px a 6px */
    top: 50% !important;
    transform: translateY(-50%) !important;
    font-size: 14px !important;
    font-weight: bold !important;
    opacity: 0.7 !important;
    padding: 0 !important;
    margin: 0 !important;
    border-radius: 2px !important;
    transition: all 0.2s ease !important;
    background: transparent !important;
    color: inherit !important;
    width: 16px !important;
    height: 16px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex-shrink: 0 !important;
    z-index: 1 !important;
    cursor: pointer !important;
    line-height: 1 !important;
}

.editor-tab.active {
    background: rgba(74, 158, 255, 0.2) !important;
    color: #4a9eff !important;
    border-color: rgba(74, 158, 255, 0.3) !important;
}

.editor-tab.modified > span:not(.close-tab) {
    color: #fbbf24 !important;
}

.editor-tab.modified > span:not(.close-tab)::after {
    content: " •" !important;
    color: #fbbf24 !important;
}

.editor-tab:hover {
    background: rgba(255, 255, 255, 0.1) !important;
}

.editor-tab .close-tab:hover {
    opacity: 1 !important;
    background: rgba(239, 68, 68, 0.2) !important;
    color: #ef4444 !important;
}

.editor-tabs::-webkit-scrollbar {
    height: 6px !important;
}

.editor-tabs::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05) !important;
    
}

.editor-tabs::-webkit-scrollbar-thumb {
    background: linear-gradient(90deg, #4a9eff 0%, #00d4ff 100%) !important;
    border-radius: 3px !important;
  
}

.editor-tabs::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(90deg, #5aa8ff 0%, #20ddff 100%) !important;
}

.editor-workspace {
    flex: 1 !important;
    display: flex !important;
    min-height: 0 !important; /* CLAVE: Permite que el contenedor se reduzca */
    overflow: hidden !important;
}

.code-editor {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    min-height: 0 !important;
    overflow: hidden !important;
}

.editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0; /* CLAVE: Permite que el contenedor se reduzca */
    overflow: hidden; /* Evita desbordamientos */
}
.editor-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: rgba(255, 255, 255, 0.02);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    gap: 15px;
    flex-wrap: wrap;
}

.editor-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
}

.editor-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.file-name-display {
    font-size: 14px;
    color: #ffffff;
    font-weight: 500;
    flex: 1;
}

.save-status {
    font-size: 12px;
    color: #8892a6;
    display: flex;
    align-items: center;
    gap: 5px;
}

.save-status.saving {
    color: #fbbf24;
}

.save-status.saved {
    color: #10b981;
}

.preview-btn {
    background: rgba(74, 158, 255, 0.2);
    border: none;
    color: #4a9eff;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.preview-btn:hover {
    background: rgba(74, 158, 255, 0.3);
}

/* === MONACO EDITOR CORREGIDO === */
#monaco-editor-container {
    flex: 1 !important;
    min-height: 0 !important; /* CLAVE: Permite redimensionamiento */
    width: 100% !important;
    position: relative !important;
    overflow: hidden !important;
    background: #1e1e1e !important;
}

#monaco-editor-container .monaco-editor {
    height: 100% !important;
    width: 100% !important;
    padding-bottom: 40px !important;
}

#monaco-editor-container .monaco-editor .view-lines {
    padding-bottom: 20px !important;
   
}

#monaco-editor-container .monaco-editor .lines-content {
    padding-bottom: 40px !important;
  
}
#monaco-editor-container .monaco-editor .overflow-guard::after {
    display: none !important;
}
#monaco-editor-container .monaco-scrollable-element .scrollbar.vertical {
    right: 0px !important;
    width: 14px !important;
    background: rgba(0, 0, 0, 0.1) !important;
}

#monaco-editor-container .monaco-scrollable-element .scrollbar.vertical .slider {
    background: rgb(54, 53, 53) !important;
    border-radius: 7px !important;
    width: 3px !important;
    margin: 1px !important;
}

#monaco-editor-container .monaco-scrollable-element .scrollbar.vertical .slider:hover {
    background: rgba(74, 158, 255, 1) !important;
}

#monaco-editor-container .monaco-scrollable-element > .scrollbar > .scroll-decoration {
    bottom: 40px !important;
}

#monaco-editor-container .monaco-editor .overflow-guard {
    height: calc(100% + 60px) !important;
}


@media (max-width: 1200px) {
    .editor-tab {
        width: 110px !important;
        min-width: 110px !important;
        max-width: 110px !important;
        padding: 8px 8px !important;
    }
    
    .editor-tab > span:not(.close-tab) {
        max-width: 65px !important;
    }
    
    .editor-tab .close-tab {
        right: 5px !important;
    }
}

/* Para pantallas pequeñas */
@media (max-width: 768px) {
    .editor-tab {
        width: 100px !important;
        min-width: 100px !important;
        max-width: 100px !important;
        padding: 6px 6px !important;
        font-size: 11px !important;
    }
    
    .editor-tab > span:not(.close-tab) {
        max-width: 60px !important;
    }
    
    .editor-tab .close-tab {
        right: 4px !important;
        font-size: 12px !important;
        width: 14px !important;
        height: 14px !important;
    }
    
    .editor-tabs {
        gap: 1px !important;
    }
}

/* Para pantallas muy pequeñas */
@media (max-width: 480px) {
    .editor-tab {
        width: 90px !important;
        min-width: 90px !important;
        max-width: 90px !important;
        padding: 6px 4px !important;
    }
    
    .editor-tab > span:not(.close-tab) {
        max-width: 55px !important;
    }
    
    .editor-tab i {
        width: 12px !important;
        font-size: 10px !important;
    }
}


.editor-tabs::before {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 6px; /* Espacio para scrollbar */
    width: 20px;
    background: linear-gradient(to left, rgba(15, 20, 25, 0.8) 0%, transparent 100%);
    pointer-events: none;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.editor-tabs:hover::before {
    opacity: 1;
}

.empty-editor {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #8892a6;
    text-align: center;
    padding: 40px;
}

.empty-editor i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
    display: block;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    /* AGREGAR ESTAS LÍNEAS */
    overflow-y: auto;
    padding: 20px;
}
.modal {
    background: #2d2d30 ;
    backdrop-filter: blur(20px);
    border: 1px solid #2d2d30 ;
    padding: 3px  6px;
    width: 90%;
    max-width: 500px;
    overflow-y: auto;
    margin-left: 319px;

}


.modal h3 {
    color: #ffffff;
    margin-bottom: 20px;
    font-size: 20px;
}

.modal-content {
    margin-bottom: 25px;
}

.form-group {
    margin-bottom: -21px;
}

.form-group label {
    display: block;
    color: #ffffff;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
}

.form-group input[type="text"],
.form-group select {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    font-size: 14px;
}

.form-group input[type="text"]:focus,
.form-group select:focus {
    outline: none;
    border-color: #4a9eff;
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
}

.form-group small {
    color: #8892a6;
    font-size: 12px;
    margin-top: 5px;
    display: block;
}

.form-group input[type="checkbox"] {
    margin-right: 8px;
}

.modal-actions {
    display: flex;
    gap: 4px;
    justify-content: flex-end;
}

.cancel-btn, .create-btn {
    padding: 7px 10px;

    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
}

.cancel-btn {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

.cancel-btn:hover {
    background: rgba(255, 255, 255, 0.15);
}

.create-btn {
    background: linear-gradient(45deg, #4a9eff, #0066cc);
    color: white;
}

.create-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(74, 158, 255, 0.3);
}

/* Toast */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(34, 197, 94, 0.9);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    transform: translateY(-100px);
    opacity: 0;
    transition: all 0.3s ease;
}

.toast.show {
    transform: translateY(0);
    opacity: 1;
}

.toast.error {
    background: rgba(239, 68, 68, 0.9);
}

/* Menú contextual */
.context-menu {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.context-menu:hover {
    backdrop-filter: blur(25px);
}


/* Active Editors Display */
#active-editors-display {
    display: none;
    gap: 10px;
    align-items: center;
    margin-left: 15px;
    flex-wrap: wrap;
}

.active-editor {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    color: #ffffff;
    position: relative;
    animation: slideIn 0.3s ease-out;
}

.active-editor::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    border-radius: 6px 0 0 6px;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Collaborative Features */
.collaborative-cursor {
    position: absolute;
    width: 2px;
    height: 20px;
    z-index: 1000;
    pointer-events: none;
}

.cursor-label {
    position: absolute;
    top: -25px;
    left: 0;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 500;
    white-space: nowrap;
    z-index: 1001;
    color: white;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.collaborative-cursor:hover .cursor-label {
    opacity: 1;
}

.cursor-blink {
    animation: cursorBlink 1s infinite;
}

@keyframes cursorBlink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

/* Connection Status */
.connection-status {
    position: fixed;
    top: 80px;
    right: 20px;
    background: rgba(15, 20, 25, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    color: #ffffff;
    display: flex;
    align-items: center;
    gap: 6px;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.connection-status.show {
    opacity: 1;
}

.connection-status.connected {
    border-color: rgba(34, 197, 94, 0.5);
}

.connection-status.connected .status-indicator {
    background: #22c55e;
}

.connection-status.disconnected {
    border-color: rgba(239, 68, 68, 0.5);
}

.connection-status.disconnected .status-indicator {
    background: #ef4444;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #6b7280;
}

/* Real-time indicators */
.real-time-indicator {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(34, 197, 94, 0.2);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 11px;
    color: #22c55e;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    pointer-events: none;
}

.real-time-indicator.show {
    opacity: 1;
    transform: translateY(0);
}

.changes-indicator {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    color: #8892a6;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.changes-indicator.show {
    opacity: 1;
}

.collaborator-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.collaborator-tooltip.show {
    opacity: 1;
}

.recent-change {
    background: rgba(74, 158, 255, 0.1);
    animation: fadeHighlight 2s ease-out;
}

@keyframes fadeHighlight {
    0% { background: rgba(74, 158, 255, 0.3); }
    100% { background: rgba(74, 158, 255, 0.1); }
}

.conflict-indicator {
    position: absolute;
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.4);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 11px;
    color: #ef4444;
    z-index: 1000;
}
.editor-tab {
    position: relative !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
    padding: 8px 10px !important; /* Reducir padding */
    background: rgba(255, 255, 255, 0.05) !important;
    border-radius: 8px 8px 0 0 !important;
    font-size: 12px !important;
    color: #8892a6 !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    white-space: nowrap !important;
    margin-top: 6px !important;
    border: 1px solid transparent !important;
    
    /* CLAVE: Ancho fijo más pequeño y flexible */
    width: 120px !important; /* Reducido de 140px a 120px */
    min-width: 120px !important;
    max-width: 120px !important;
    height: 34px !important;
    max-height: 34px !important;
    min-height: 34px !important;
    
    flex-shrink: 0 !important; /* NO permitir que se contraigan */
    flex-grow: 0 !important;   /* NO permitir que crezcan */
    overflow: hidden !important;
    box-sizing: border-box !important;
}









.editor-tabs {
    display: flex !important;
    background: rgba(15, 20, 25, 0.8) !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    height: 45px !important;
    min-height: 45px !important;
    max-height: 45px !important;
    flex-shrink: 0 !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    padding: 0 !important;
    margin: 0 !important;
    gap: 2px !important; /* Reducir gap para ahorrar espacio */
    
    /* CLAVE: Limitar el ancho máximo del contenedor */
    max-width: 100% !important;
    width: 100% !important;
    
    /* Scrollbar personalizada mejorada */
    scrollbar-width: 1px;
    scrollbar-color: rgba(0, 0, 0, 0);
}




/* RESPONSIVE */
@media (max-width: 768px) {


    .main-content {
        margin-left: 0;
    }

    .menu-toggle {
        display: block;
    }

    .file-explorer {
        width: 200px;
    }

    .header-controls {
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .control-btn span {
        display: none;
    }

    #active-editors-display {
        margin-left: 8px;
        gap: 6px;
    }
    
    .active-editor {
        padding: 3px 6px;
        font-size: 11px;
    }
    
    .connection-status {
        right: 10px;
        top: 70px;
        padding: 6px 10px;
        font-size: 11px;
    }


    
    .editor-tab > span:not(.close-tab) {
        max-width: 75px !important;
    }
    
    .editor-tab .close-tab {
        right: 6px !important;
        font-size: 14px !important;
    }
}

/* === SIDEBAR CON HOVER - REEMPLAZA EL CSS ANTERIOR === */
.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 80px; /* Inicia colapsado por defecto */
    height: 100vh;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border-right: 1px solid rgba(74, 158, 255, 0.2);
    padding: 20px 12px;
    z-index: 100;
    transition: all 0.5s cubic-bezier(0.5, 0, 0.5, 1);
    overflow: hidden;
}

/* Estado expandido al hacer hover */
.sidebar:hover {
    width: 260px;
    padding: 20px;
}

.sidebar.hidden {
    transform: translateX(-100%);
}

/* Logo adaptable */
.logo {
    display: flex;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    color: #4a9eff;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
    white-space: nowrap;
    overflow: hidden;
    justify-content: center;
}

.sidebar:hover .logo {
    margin-bottom: 40px;
    padding-bottom: 20px;
    justify-content: flex-start;
}

.logo-icon {
    width: 36px;
    height: 36px;
    margin-right: 0;
    background: linear-gradient(45deg, #4a9eff, #00d4ff);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.sidebar:hover .logo-icon {
    margin-right: 12px;
    width: 32px;
    height: 32px;
}

.logo-text {
    width: 0;
    opacity: 0;
    transition: all 0.3s ease;
    overflow: hidden;
}

.sidebar:hover .logo-text {
    width: auto;
    opacity: 1;
}

/* Navegación mejorada */
.nav-menu {
    list-style: none;
}

.nav-item {
    margin-bottom: 8px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 14px 8px;
    color: #8892a6;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s ease;
    font-size: 14px;
    position: relative;
    white-space: nowrap;
    overflow: hidden;
    justify-content: center;
}

.sidebar:hover .nav-link {
    justify-content: flex-start;
    padding: 14px 16px;
}

.nav-link:hover, .nav-link.active {
    background: rgba(74, 158, 255, 0.15);
    color: #4a9eff;
}

.sidebar:hover .nav-link:hover, 
.sidebar:hover .nav-link.active {
    transform: translateX(4px);
}

.nav-link i {
    margin-right: 0;
    width: 20px;
    text-align: center;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.sidebar:hover .nav-link i {
    margin-right: 14px;
}

.nav-link-text {
    width: 0;
    opacity: 0;
    transition: all 0.3s ease;
    overflow: hidden;
}

.sidebar:hover .nav-link-text {
    width: auto;
    opacity: 1;
}

/* Tooltip para iconos (solo visible cuando NO está en hover) */
.nav-link::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 70px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1000;
}

.nav-link::before {
    content: '';
    position: absolute;
    left: 62px;
    top: 50%;
    transform: translateY(-50%);
    border: 6px solid transparent;
    border-right-color: rgba(0, 0, 0, 0.9);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1000;
}

/* Solo mostrar tooltip cuando el sidebar NO está expandido */
.nav-link:hover::after,
.nav-link:hover::before {
    opacity: 1;
    visibility: visible;
}

.sidebar:hover .nav-link:hover::after,
.sidebar:hover .nav-link:hover::before {
    opacity: 0;
    visibility: hidden;
}

/* Ajuste del contenido principal */
.main-content {
    margin-left: 80px; /* Inicia con sidebar colapsado */
    min-height: 100vh;
    padding: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}

.main-content.expanded {
    margin-left: 0;
}

/* Indicador visual de hover */
.sidebar::after {
    content: '';
    position: absolute;
    top: 50%;
    right: -2px;
    transform: translateY(-50%);
    width: 4px;
    height: 40px;
    background: linear-gradient(to bottom, transparent, #4a9eff, transparent);
    border-radius: 2px;
    opacity: 0;
    transition: all 0.3s ease;
}

.sidebar:hover::after {
    opacity: 0.7;
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        width: 260px;
        padding: 20px;
    }
    
    .sidebar.show {
        transform: translateX(0);
    }
    
    .sidebar.show .logo {
        justify-content: flex-start;
        margin-bottom: 40px;
        padding-bottom: 20px;
    }
    
    .sidebar.show .logo-icon {
        margin-right: 12px;
        width: 32px;
        height: 32px;
    }
    
    .sidebar.show .logo-text {
        width: auto;
        opacity: 1;
    }
    
    .sidebar.show .nav-link {
        justify-content: flex-start;
        padding: 14px 16px;
    }
    
    .sidebar.show .nav-link i {
        margin-right: 14px;
    }
    
    .sidebar.show .nav-link-text {
        width: auto;
        opacity: 1;
    }
    
    .main-content {
        margin-left: 0;
    }
    
    /* Ocultar tooltips en móvil */
    .nav-link::after,
    .nav-link::before {
        display: none;
    }
}

/* Estados de hover mejorados */
.nav-link {
    background: linear-gradient(90deg, transparent 0%, rgba(74, 158, 255, 0.1) 100%);
    background-size: 0% 100%;
    background-repeat: no-repeat;
    background-position: left center;
}

.nav-link:hover {
    background-size: 100% 100%;
}

.nav-link.active {
    background: linear-gradient(90deg, rgba(74, 158, 255, 0.2) 0%, rgba(74, 158, 255, 0.1) 100%);
    background-size: 100% 100%;
}

/* Animación de entrada del texto */
@keyframes fadeInText {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.sidebar:hover .nav-link-text,
.sidebar:hover .logo-text {
    animation: fadeInText 0.3s ease-out;
}

/* AI Tools */
.ai-tools {
    display: flex;
    gap: 10px;
    align-items: center;
}

.ai-btn, .export-btn {
    background: linear-gradient(45deg, #10b981, #059669);
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.ai-btn:hover {
    background: linear-gradient(45deg, #059669, #047857);
    transform: translateY(-1px);
}

.export-btn {
    background: linear-gradient(45deg, #3b82f6, #1d4ed8);
}

.export-btn:hover {
    background: linear-gradient(45deg, #1d4ed8, #1e3a8a);
    transform: translateY(-1px);
}

/* AI Modal */
.ai-companion-modal-content {
    max-width: 800px;
    width: 90%;
}

.ai-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.ai-action-btn {
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #8892a6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 12px;
}

.ai-action-btn.active {
    background: rgba(16, 185, 129, 0.2);
    border-color: #10b981;
    color: #10b981;
}

.ai-action-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
}

.ai-action-btn i {
    font-size: 20px;
}

#ai-prompt {
    width: 100%;
    min-height: 100px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    padding: 12px;
    font-size: 14px;
    resize: vertical;
}

.ai-response {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    border-left: 4px solid #10b981;
}

.response-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.response-header h4 {
    color: #10b981;
    margin: 0;
}

.apply-code-btn {
    background: #10b981;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
}

.response-content {
    background: #1e1e1e;
    border-radius: 6px;
    padding: 15px;
    overflow-x: auto;
}

.response-content pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.response-content code {
    color: #d4d4d4;
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.5;
}

/* Error Inspector */
.error-inspector {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 400px;
    background: rgba(239, 68, 68, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid #ef4444;
    border-radius: 12px;
    z-index: 1000;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.error-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px 12px 0 0;
    color: white;
    font-weight: 600;
}

.close-error-btn {
    margin-left: auto;
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
}

.error-message {
    padding: 15px;
    color: white;
    font-size: 14px;
    line-height: 1.4;
}

.fix-error-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 10px 15px;
    margin: 0 15px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.fix-error-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Typing Effect */
.typing-effect {
    border-right: 2px solid #10b981;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { border-color: transparent; }
    51%, 100% { border-color: #10b981; }
}

.code-response {
    white-space: pre-line; /* Preserva saltos de línea */
    line-height: 1.6;
}

/* O si quieres más control */
.code-response {
    white-space: pre-wrap; /* Preserva espacios y saltos */
}

/* User Menu Styles */
.user-menu {
    position: relative;
    display: flex;
    align-items: center;
}

.user-menu-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #ffffff;
    font-size: 14px;
}

.user-menu-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #4a9eff;
    transform: translateY(-1px);
}

.user-avatar-small {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    
    object-fit: cover;
    flex-shrink: 0;
}

#headerUserName {
    font-weight: 500;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.user-menu-toggle i.fa-chevron-down {
    font-size: 12px;
    transition: transform 0.3s ease;
}

.user-menu-toggle:hover i.fa-chevron-down {
    transform: rotate(180deg);
}

.user-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.2);
    border-radius: 12px;
    padding: 8px 0;
    min-width: 200px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

.user-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.user-dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: #ffffff;
    text-decoration: none;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}

.user-dropdown-item:hover {
    background-color: rgba(74, 158, 255, 0.1);
    color: #4a9eff;
}

.user-dropdown-item.logout {
    color: #ff6b6b;
}

.user-dropdown-item.logout:hover {
    background-color: rgba(255, 107, 107, 0.1);
    color: #ff8a8a;
}

.user-dropdown-item i {
    width: 16px;
    text-align: center;
    font-size: 14px;
}

.user-dropdown hr {
    margin: 8px 0;
    border: none;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}





@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}
/* Estilos para modal de repositorios */
.repo-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    overflow-y: auto;
    padding: 20px;
    backdrop-filter: blur(5px);
}

.repo-modal {
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 12px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.repo-modal h3 {
    color: #4a9eff;
    margin-bottom: 25px;
    font-size: 22px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.repo-modal h3::before {
    content: '🗂️';
    font-size: 24px;
}

.repo-modal-content {
    margin-bottom: 30px;
}

.repo-form-group {
    margin-bottom: 20px;
}

.repo-form-group label {
    display: block;
    color: #ffffff;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 600;
}

.repo-form-group input[type="text"] {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    font-size: 14px;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.repo-form-group input[type="text"]:focus {
    outline: none;
    border-color: #4a9eff;
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.2);
    background: rgba(255, 255, 255, 0.08);
}

.repo-form-group input[type="text"]::placeholder {
    color: #8892a6;
    opacity: 0.8;
}

.repo-modal-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    align-items: center;
}

.repo-cancel-btn,
.repo-create-btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 100px;
    justify-content: center;
}

.repo-cancel-btn {
    background: rgba(255, 255, 255, 0.1);
    color: #8892a6;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.repo-cancel-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    color: #ffffff;
    transform: translateY(-1px);
}

.repo-create-btn {
    background: linear-gradient(45deg, #4a9eff, #00d4ff);
    color: white;
    box-shadow: 0 4px 15px rgba(74, 158, 255, 0.3);
}

.repo-create-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(74, 158, 255, 0.4);
}

.repo-create-btn:disabled {
    background: rgba(74, 158, 255, 0.5) !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
}







/* Responsive para móviles */
@media (max-width: 768px) {
    .export-dropdown-menu {
        right: auto;
        left: 0;
    }
    
    .ai-contextual-modal-content {
        width: 95vw;
        max-width: none;
    }
    
    .repo-modal {
        padding: 25px;
        margin: 20px;
        width: calc(100% - 40px);
    }
    
    .repo-modal-actions {
        flex-direction: column;
        gap: 10px;
    }
    
    .repo-cancel-btn,
    .repo-create-btn {
        width: 100%;
        min-width: auto;
    }
    
    .repo-modal h3 {
        font-size: 20px;
    }
}

/* FIX GLOBAL PARA SELECT */
select, select option {
    background-color: #1e1e1e !important;
    color: #ffffff !important;
}


select:focus {
    outline: none;
    border-color: #4a9eff !important;
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.2) !important;
}
.css-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4a9eff, #00d4ff);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 11px;
    border: 2px solid #4a9eff;
    flex-shrink: 0;
    font-family: inherit;
}



/* MODAL CREAR ARCHIVO */
.new-file-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    overflow-y: auto;
    padding: 20px;
}

.new-file-modal {
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 12px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    margin-left: 319px;
}

.new-file-modal-title {
    color: #4a9eff;
    margin-bottom: 25px;
    font-size: 20px;
    text-align: center;
}

.new-file-modal-content {
    margin-bottom: 25px;
}

.new-file-form-group {
    margin-bottom: 20px;
}

.new-file-label {
    display: block;
    color: #ffffff;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
}

.new-file-input, .new-file-select {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    font-size: 14px;
    box-sizing: border-box;
}

.new-file-input:focus, .new-file-select:focus {
    outline: none;
    border-color: #4a9eff;
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
}

.new-file-help {
    color: #8892a6;
    font-size: 12px;
    margin-top: 5px;
    display: block;
}

.new-file-checkbox-label {
    display: flex;
    align-items: center;
    color: #ffffff;
    font-size: 14px;
    cursor: pointer;
}

.new-file-checkbox {
    margin-right: 8px;
}

.new-file-modal-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

.new-file-cancel-btn, .new-file-create-btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
}

.new-file-cancel-btn {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

.new-file-cancel-btn:hover {
    background: rgba(255, 255, 255, 0.15);
}

.new-file-create-btn {
    background: linear-gradient(45deg, #4a9eff, #0066cc);
    color: white;
}

.new-file-create-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(74, 158, 255, 0.3);
}








@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}


/* MODAL RENOMBRAR - CLASES ÚNICAS */
.rename-modal-wrapper {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0, 0, 0, 0.7) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    z-index: 1000 !important;
    overflow-y: auto !important;
    padding: 20px !important;
}

.rename-modal-container {
    background: rgba(15, 20, 25, 0.95) !important;
    backdrop-filter: blur(20px) !important;
    border: 1px solid rgba(239, 68, 68, 0.3) !important;
    border-radius: 12px !important;
    padding: 30px !important;
    width: 90% !important;
    max-width: 500px !important;
    animation: modalSlideIn 0.3s ease-out !important;
}

.rename-modal-title {
    color: #ef4444 !important;
    margin-bottom: 25px !important;
    font-size: 20px !important;
    text-align: center !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 10px !important;
}

.rename-modal-content {
    margin-bottom: 25px !important;
}

.rename-form-group {
    margin-bottom: 20px !important;
}

.rename-label {
    display: block !important;
    color: #ffffff !important;
    margin-bottom: 8px !important;
    font-size: 14px !important;
    font-weight: 500 !important;
}

.rename-input {
    width: 100% !important;
    padding: 12px 16px !important;
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 8px !important;
    color: white !important;
    font-size: 14px !important;
    box-sizing: border-box !important;
    transition: all 0.3s ease !important;
}

.rename-input:focus {
    outline: none !important;
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
    background: rgba(255, 255, 255, 0.08) !important;
}

.rename-modal-actions {
    display: flex !important;
    gap: 15px !important;
    justify-content: flex-end !important;
    align-items: center !important;
}

.rename-cancel-btn, .rename-create-btn {
    padding: 12px 24px !important;
    border-radius: 8px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    border: none !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    min-width: 100px !important;
    justify-content: center !important;
}

.rename-cancel-btn {
    background: rgba(255, 255, 255, 0.1) !important;
    color: #8892a6 !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.rename-cancel-btn:hover {
    background: rgba(255, 255, 255, 0.15) !important;
    color: #ffffff !important;
    transform: translateY(-1px) !important;
}

.rename-create-btn {
    background: linear-gradient(45deg, #ef4444, #dc2626) !important;
    color: white !important;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3) !important;
}

.rename-create-btn:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4) !important;
}




/* MODAL CREAR CARPETA */
.new-folder-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    overflow-y: auto;
    padding: 20px;
}

.new-folder-modal {
    background: rgba(15, 20, 25, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 12px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    margin-left: 319px;
}

.new-folder-modal-title {
    color: #22c55e;
    margin-bottom: 25px;
    font-size: 20px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.new-folder-modal-content {
    margin-bottom: 25px;
}

.new-folder-form-group {
    margin-bottom: 20px;
}

.new-folder-label {
    display: block;
    color: #ffffff;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
}

.new-folder-input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    font-size: 14px;
    box-sizing: border-box;
}

.new-folder-input:focus {
    outline: none;
    border-color: #22c55e;
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
}

.new-folder-parent-display {
    padding: 12px 16px;
    background: rgba(34, 197, 94, 0.1);
    border-radius: 8px;
    color: #22c55e;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.new-folder-modal-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

.new-folder-cancel-btn, .new-folder-create-btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
}

.new-folder-cancel-btn {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

.new-folder-cancel-btn:hover {
    background: rgba(255, 255, 255, 0.15);
}

.new-folder-create-btn {
    background: linear-gradient(45deg, #22c55e, #16a34a);
    color: white;
}

.new-folder-create-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
}


/* MODAL MOVER ARCHIVO - CLASES ÚNICAS */
.move-file-modal-wrapper {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0, 0, 0, 0.7) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    z-index: 1000 !important;
    overflow-y: auto !important;
    padding: 20px !important;
    backdrop-filter: blur(5px) !important;
}



.move-file-modal-title {
    color: #4a9eff !important;
    margin-bottom: 25px !important;
    font-size: 20px !important;
    text-align: center !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 10px !important;
}

.move-file-modal-content {
    margin-bottom: 25px !important;
}

.move-file-form-group {
    margin-bottom: 20px !important;
}

.move-file-label {
    display: block !important;
    color: #ffffff !important;
    margin-bottom: 8px !important;
    font-size: 14px !important;
    font-weight: 500 !important;
}

.move-file-input, .move-file-select {
    width: 100% !important;
    padding: 12px 16px !important;
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 8px !important;
    color: white !important;
    font-size: 14px !important;
    box-sizing: border-box !important;
    transition: all 0.3s ease !important;
}

.move-file-input:focus, .move-file-select:focus {
    outline: none !important;
    border-color: #4a9eff !important;
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.2) !important;
    background: rgba(255, 255, 255, 0.08) !important;
}

.move-file-display-box {
    padding: 10px 12px !important;
    background: rgba(74, 158, 255, 0.1) !important;
    border-radius: 6px !important;
    color: #4a9eff !important;
    margin-bottom: 15px !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
}

.move-file-modal-actions {
    display: flex !important;
    gap: 15px !important;
    justify-content: flex-end !important;
    align-items: center !important;
}

.move-file-cancel-btn, .move-file-confirm-btn {
    padding: 12px 24px !important;
    border-radius: 8px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    border: none !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    min-width: 100px !important;
    justify-content: center !important;
}

.move-file-cancel-btn {
    background: rgba(255, 255, 255, 0.1) !important;
    color: #8892a6 !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.move-file-cancel-btn:hover {
    background: rgba(255, 255, 255, 0.15) !important;
    color: #ffffff !important;
    transform: translateY(-1px) !important;
}

.move-file-confirm-btn {
    background: linear-gradient(45deg, #4a9eff, #00d4ff) !important;
    color: white !important;
    box-shadow: 0 4px 15px rgba(74, 158, 255, 0.3) !important;
}

.move-file-confirm-btn:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 25px rgba(74, 158, 255, 0.4) !important;
}







/* CONSOLA PYTHON - Agregar al final de tu CSS */
.console-panel {
    position: fixed;
    bottom: 0;
    left: 260px;
    right: 0;
    height: 35%;
    background: #1a1a1a;
    border-top: 2px solid #4a9eff;
    display: none;
    flex-direction: column;
    z-index: 50;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
}

.console-panel.open {
    display: flex;
}

.console-header {
    background: #2d2d30;
    color: #cccccc;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #3c3c3c;
    min-height: 45px;
}

.console-tabs {
    display: flex;
    gap: 15px;
}

.console-tab {
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
    color: #8892a6;
}

.console-tab.active {
    background: #4a9eff;
    color: white;
}

.console-tab:hover:not(.active) {
    background: rgba(74, 158, 255, 0.2);
    color: #4a9eff;
}

.console-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

.console-btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: #cccccc;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.console-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.console-btn.run-btn {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.3);
}

.console-btn.run-btn:hover {
    background: rgba(34, 197, 94, 0.3);
}

.console-btn.close:hover {
    background: #dc3545;
    color: white;
}

.console-content {
    flex: 1;
    overflow: hidden;
}

.console-tab-content {
    display: none;
    height: 100%;
    overflow-y: auto;
}

.console-tab-content.active {
    display: block;
}

.console-output {
    padding: 12px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.4;
    height: 100%;
    overflow-y: auto;
    background: #1a1a1a;
}

.console-line {
    margin: 3px 0;
    padding: 4px 8px;
    border-radius: 3px;
    display: flex;
    align-items: flex-start;
    gap: 8px;
    word-wrap: break-word;
}

.console-line.output {
    color: #d4d4d4;
}

.console-line.error {
    color: #f48771;
    background: rgba(244, 135, 113, 0.1);
}

.console-line.warning {
    color: #dcdcaa;
    background: rgba(220, 220, 170, 0.1);
}

.console-line.info {
    color: #4fc1ff;
}

.console-line.success {
    color: #4ec9b0;
    background: rgba(78, 201, 176, 0.1);
}

.console-toggle-wrapper {
    position: fixed;
    bottom: 20px;
    left: 280px;
    z-index: 100;
}

.console-toggle-btn {
    background: rgba(74, 158, 255, 0.9);
    border: 1px solid #4a9eff;
    color: white;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
}

.console-toggle-btn:hover {
    background: #4a9eff;
    transform: translateY(-2px);
}

.console-toggle-btn.active {
    background: #ef4444;
    border-color: #ef4444;
}

.dependencies-container {
    padding: 15px;
    height: 100%;
    background: #1e1e1e;
}

.dependencies-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #3c3c3c;
}

.dependencies-header h4 {
    color: #4a9eff;
    margin: 0;
    font-size: 16px;
}

.scan-deps-btn {
    background: rgba(74, 158, 255, 0.2);
    border: 1px solid #4a9eff;
    color: #4a9eff;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.scan-deps-btn:hover {
    background: rgba(74, 158, 255, 0.3);
}

.dependencies-list {
    overflow-y: auto;
    max-height: calc(100% - 60px);
}

.empty-deps {
    text-align: center;
    color: #8892a6;
    padding: 40px 20px;
}

.empty-deps i {
    font-size: 2.5rem;
    margin-bottom: 15px;
    opacity: 0.5;
    display: block;
}

.dependency-item {
    background: rgba(74, 158, 255, 0.1);
    border: 1px solid rgba(74, 158, 255, 0.2);
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.dependency-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.dependency-name {
    font-weight: 600;
    color: #4a9eff;
    font-size: 14px;
}

.dependency-version {
    font-size: 12px;
    color: #8892a6;
}

.dependency-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
}

.dependency-status.installed {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.dependency-status.missing {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.execution-url {
    background: rgba(74, 158, 255, 0.1);
    border: 1px solid #4a9eff;
    border-radius: 6px;
    padding: 12px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.execution-url a {
    color: #4a9eff;
    text-decoration: none;
    font-weight: 500;
}

.execution-url button {
    background: none;
    border: none;
    color: #4a9eff;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.2s;
}

.execution-url button:hover {
    background: rgba(74, 158, 255, 0.2);
}

@media (max-width: 768px) {
    .console-panel {
        left: 0;
        height: 40%;
    }
    
    .console-toggle-wrapper {
        left: 20px;
    }
}

/* Estilo VS Code-like para el editor */
.editor-main {
    background: #1e1e1e !important;
    border-left: none !important;
}

/* Breadcrumbs de navegación */
.editor-breadcrumbs {
    background: #2d2d30;
    border-bottom: 1px solid #3c3c3c;
    padding: 8px 16px;
    font-size: 13px;
    color: #cccccc;
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #cccccc;
    text-decoration: none;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.2s;
}

.breadcrumb-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.breadcrumb-separator {
    color: #858585;
    font-size: 12px;
}

.breadcrumb-item.active {
    color: #4fc1ff;
}

/* Mejorar las pestañas para que se vean más como VS Code */
.editor-tabs {
    background: #2d2d30 !important;
    border-bottom: 1px solid #3c3c3c !important;
    padding: 0 !important;
    min-height: 35px !important;
    max-height: 35px !important;
}

.editor-tab {
    background: #2d2d30 !important;
    color: #cccccc !important;
    border: none !important;
    border-radius: 0 !important;
    margin-top: 0 !important;
    border-right: 1px solid #3c3c3c !important;
    height: 35px !important;
    min-height: 35px !important;
    max-height: 35px !important;
    padding: 0 12px !important;
    font-size: 13px !important;
}

.editor-tab:hover {
    background: #383838 !important;
}

.editor-tab.active {
    background: #1e1e1e !important;
    color: #ffffff !important;
    border-bottom: 2px solid #007acc !important;
}

.editor-tab.modified > span:not(.close-tab) {
    color: #ffffff !important;
}

.editor-tab.modified > span:not(.close-tab)::after {
    content: " ●" !important;
    color: #ffffff !important;
    font-size: 16px !important;
}

/* Mejorar la toolbar del editor */
.editor-toolbar {
    background: #2d2d30 !important;
    border-bottom: 1px solid #3c3c3c !important;
    padding: 8px 16px !important;
    color: #cccccc !important;
}

.file-name-display {
    font-family: 'Monaco', 'Consolas', 'Courier New', monospace !important;
    font-size: 13px !important;
    color: #cccccc !important;
}

/* Monaco Editor mejorado */
#monaco-editor-container {
    background: #1e1e1e !important;
}

#monaco-editor-container .monaco-editor {
    background: #1e1e1e !important;
}

#monaco-editor-container .monaco-editor .margin {
    background: #1e1e1e !important;
}

/* File Explorer estilo VS Code */
.file-explorer {
    background: #252526 !important;
    border-right: 1px solid #3c3c3c !important;
}

.explorer-header {
    background: #2d2d30 !important;
    border-bottom: 1px solid #3c3c3c !important;
    padding: 12px 16px !important;
}

.explorer-title {
    color: #cccccc !important;
    font-size: 11px !important;
    text-transform: uppercase !important;
    font-weight: 600 !important;
    letter-spacing: 1px !important;
}

.file-item {
    color: #cccccc !important;
    font-size: 13px !important;
    font-family: 'Monaco', 'Consolas', 'Courier New', monospace !important;
    padding: 4px 8px !important;
    border-radius: 0 !important;
}

.file-item:hover {
    background: rgba(255, 255, 255, 0.1) !important;
}

.file-item.active {
    background: #094771 !important;
    color: #ffffff !important;
}

.editor-status-bar {
    background: #2d2d30;
    color: #ffffff;
    font-size: 12px;
    padding: 4px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #3c3c3c;
    font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
    min-height: 24px;
}

.status-left, .status-right {
    display: flex;
    gap: 16px;
    align-items: center;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 3px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 12px;
    white-space: nowrap;
}

.status-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

#cursor-position {
    font-weight: 600;
}

#editor-language {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}







/* === MENU SUPERIOR VS CODE STYLE === */
.vscode-menu-bar {
    background: #2d2d30;
    color: #cccccc;
    height: 30px;
    display: flex;
    align-items: center;
    font-size: 13px;
    border-bottom: 1px solid #3c3c3c;
    position: relative;
    z-index: 10;
}

.menu-item {
    padding: 6px 12px;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
}

.menu-item:hover {
    background: #383838;
}

.menu-item.active {
    background: #0e639c;
}

.menu-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    background: #2d2d30;
    border: 1px solid #464647;
    border-radius: 3px;
    min-width: 200px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    display: none;
    z-index: 1001;
}

.menu-dropdown.show {
    display: block;
}

.menu-dropdown-item {
    padding: 8px 16px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    border-bottom: 1px solid #3c3c3c;
}

.menu-dropdown-item:last-child {
    border-bottom: none;
}

.menu-dropdown-item:hover {
    background: #383838;
}

.menu-dropdown-item.disabled {
    color: #666;
    cursor: not-allowed;
}

.menu-dropdown-item.disabled:hover {
    background: transparent;
}

.menu-shortcut {
    color: #8a8a8a;
    font-size: 12px;
}

.menu-separator {
    height: 1px;
    
    margin: 4px 0;
}

/* === ICONOS HOVER EN EXPLORADOR === */
.explorer-actions {
    display: flex;
    gap: 5px;
  
    transition: opacity 0.3s ease;
}



.explorer-action-btn {
    background: rgba(74, 158, 255, 0.2);
    border: none;
    color: #4a9eff;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.explorer-action-btn:hover {
    background: rgba(74, 158, 255, 0.3);
}

/* === BREADCRUMBS MEJORADOS CON BOTONES === */
.breadcrumb-path {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.breadcrumb-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.breadcrumb-btn {
    background: rgba(74, 158, 255, 0.2);
    border: none;
    color: #4a9eff;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.breadcrumb-btn:hover {
    background: rgba(74, 158, 255, 0.3);
}

.breadcrumb-btn.save-btn.saved {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.breadcrumb-btn.save-btn.saving {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
}








/* === MEJORAS PARA REPOSITORIOS === */

/* Tarjetas de repositorio más compactas y profesionales */
.repository-card {
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.04) 0%, rgba(74, 158, 255, 0.02) 100%) !important;
    border: 1px solid rgba(74, 158, 255, 0.15) !important;
    border-radius: 8px !important;
    padding: 18px 14px !important;
    margin-bottom: 8px !important;
    cursor: pointer !important;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
    position: relative !important;
    overflow: hidden !important;
    max-height: 70px !important;
}

.repository-card:hover {
    background: linear-gradient(135deg, rgba(74, 158, 255, 0.08) 0%, rgba(74, 158, 255, 0.04) 100%) !important;
    border-color: rgba(74, 158, 255, 0.3) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.15) !important;
}

/* Layout interno más compacto */
.repository-card > div:first-child {
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
}

/* Icono más pequeño */
.repository-card .repo-icon {
    width: 36px !important;
    height: 36px !important;
    background: linear-gradient(45deg, #4a9eff, #00d4ff) !important;
    border-radius: 8px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 16px !important;
    color: white !important;
    flex-shrink: 0 !important;
    box-shadow: 0 2px 8px rgba(74, 158, 255, 0.2) !important;
}

/* Contenido del repositorio más compacto */
.repository-card h3 {
    color: #ffffff !important;
    font-size: 14px !important;
    margin: 0 0 4px 0 !important;
    font-weight: 600 !important;
    line-height: 1.2 !important;
}

.repository-card p {
    color: #8892a6 !important;
    font-size: 11px !important;
    margin: 0 0 6px 0 !important;
    line-height: 1.3 !important;
    opacity: 0.8 !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
}

/* Stats más pequeños */
.repository-card > div:first-child > div:nth-child(2) > div {
    display: flex !important;
    gap: 12px !important;
    font-size: 10px !important;
    color: #8892a6 !important;
}

/* Chevron más sutil */
.repository-card > div:first-child > div:last-child {
    color: #4a9eff !important;
    font-size: 12px !important;
    align-self: center !important;
    opacity: 0.6 !important;
    transition: all 0.2s ease !important;
}

/* Header de repositorios más compacto */
.repository-header {
    padding: 2px 1px 8px 1px !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08) !important;
    margin-bottom: 12px !important;
}

.repository-header h3 {
    color: #ffffff !important;
    font-size: 16px !important;
    margin: 0 !important;
    font-weight: 600 !important;
}

.repository-header button {
    background: linear-gradient(45deg, #4a9eff, #00d4ff) !important;
    border: none !important;
    color: white !important;
    padding: 8px 14px !important;
    border-radius: 6px !important;
    font-size: 12px !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    font-weight: 500 !important;
    box-shadow: 0 2px 6px rgba(74, 158, 255, 0.25) !important;
}

/* === MEJORAS PARA EXPLORADOR DE ARCHIVOS === */

/* Header del repositorio abierto mejorado */
.repository-open-header {
   
    margin-bottom: 16px !important;
  
    display: flex !important;
  
}

.repository-open-header > div:first-child {
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
    flex: 1 !important;
    min-width: 0 !important;
}

.repository-open-header button {
    background: rgba(74, 158, 255, 0.15) !important;
    border: none !important;
    color: #4a9eff !important;
    padding: 8px 10px !important;
    border-radius: 6px !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    font-weight: 500 !important;
    font-size: 12px !important;
    flex-shrink: 0 !important;
}

.repository-open-header button:hover {
    background: rgba(74, 158, 255, 0.25) !important;
}

/* Título del repositorio truncado */
.repository-open-header h3 {
    color: #4a9eff !important;
    font-size: 14px !important;
    margin: 0 !important;
    font-weight: 600 !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    max-width: 150px !important;
}

.repository-open-header p {
    color: #8892a6 !important;
    font-size: 11px !important;
    margin: 0 !important;
    opacity: 0.7 !important;
}

/* === MEJORAS PARA ICONOS DE ARCHIVOS === */

/* Iconos de archivos más consistentes y profesionales */
.file-item i {
    margin-right: 8px !important;
    width: 16px !important;
    text-align: center !important;
    font-size: 13px !important;
    opacity: 0.9 !important;
}

/* Colores específicos para cada tipo de archivo */
.file-item i.fa-html5 { color: #e34f26 !important; }
.file-item i.fa-css3-alt { color: #1572b6 !important; }
.file-item i.fa-js-square { color: #f7df1e !important; }
.file-item i.fa-python { color: #3776ab !important; }
.file-item i.fa-java { color: #ed8b00 !important; }
.file-item i.fa-file-code { color: #6f9bd4 !important; }
.file-item i.fa-file-alt { color: #8892a6 !important; }
.file-item i.fa-database { color: #336791 !important; }
.file-item i.fa-markdown { color: #083fa1 !important; }
.file-item i.fa-react { color: #61dafb !important; }
.file-item i.fa-php { color: #777bb4 !important; }
.file-item i.fa-gem { color: #cc342d !important; }
.file-item i.fa-docker { color: #0db7ed !important; }
.file-item i.fa-git-alt { color: #f05032 !important; }

/* Carpetas con color consistente */
.file-item.folder-item i.fa-folder,
.file-item.folder-item i.fa-folder-open {
    color: #fbbf24 !important;
}

.file-item.folder-item i.fa-chevron-right,
.file-item.folder-item i.fa-chevron-down {
    color: #8892a6 !important;
    opacity: 0.7 !important;
}

/* === MEJORAS PARA EL TÍTULO "ARCHIVOS" === */

/* Ocultar título "Archivos" en vista de repositorios */
.explorer-header {
    display: none !important;
}

/* Mostrar solo cuando hay repositorio seleccionado */
.repository-files-view .explorer-header {
    display: flex !important;
    padding: 12px 16px !important;
    background: rgba(74, 158, 255, 0.04) !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08) !important;
    justify-content: space-between !important;
    align-items: center !important;
}

.explorer-title {
    color: #8892a6 !important;
    font-size: 11px !important;
    text-transform: uppercase !important;
    font-weight: 600 !important;
    letter-spacing: 0.8px !important;
    opacity: 0.8 !important;
}

/* === MEJORAS GENERALES === */

/* Espaciado más consistente */
.file-tree {
    padding: 8px !important;
}

/* Items de archivo más compactos */
.file-item {
    padding: 4px 1px !important;
 
    border-radius: 4px !important;
    font-size: 12px !important;
    transition: all 0.15s ease !important;
}

.file-item:hover {
    background: rgba(255, 255, 255, 0.06) !important;
}

.file-item.active {
    background: rgba(74, 158, 255, 0.15) !important;
    color: #4a9eff !important;
}

/* Botones de acción más sutiles */
.explorer-actions button {
    background: rgba(74, 158, 255, 0.1) !important;
    border: none !important;
    color: #4a9eff !important;
    padding: 6px 8px !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    font-size: 11px !important;
    transition: all 0.2s ease !important;
    opacity: 0.8 !important;
}

.explorer-actions button:hover {
    background: rgba(74, 158, 255, 0.2) !important;
    opacity: 1 !important;
}

/* === ESTADO VACÍO MEJORADO === */
.empty-repository-state {
    text-align: center !important;
    padding: 32px 20px !important;
    color: #8892a6 !important;
}

.empty-repository-state i {
    font-size: 2.5rem !important;
    margin-bottom: 16px !important;
    display: block !important;
    opacity: 0.4 !important;
    color: #4a9eff !important;
}

.empty-repository-state h3 {
    color: #ffffff !important;
    margin-bottom: 8px !important;
    font-size: 16px !important;
}

.empty-repository-state p {
    font-size: 13px !important;
    margin-bottom: 20px !important;
    opacity: 0.8 !important;
    line-height: 1.4 !important;
}

.empty-repository-state button {
    background: linear-gradient(45deg, #4a9eff, #00d4ff) !important;
    border: none !important;
    color: white !important;
    padding: 10px 20px !important;
    border-radius: 6px !important;
    font-size: 13px !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    font-weight: 600 !important;
    box-shadow: 0 3px 12px rgba(74, 158, 255, 0.3) !important;
}

/* === RESPONSIVE === */
@media (max-width: 768px) {
    .repository-card {
        padding: 12px !important;
        max-height: 64px !important;
    }
    
    .repository-card .repo-icon {
        width: 32px !important;
        height: 32px !important;
        font-size: 14px !important;
    }
    
    .repository-card h3 {
        font-size: 13px !important;
    }
    
    .repository-open-header {
        padding: 10px 12px !important;
    }
    
    .repository-open-header h3 {
        max-width: 120px !important;
        font-size: 13px !important;
    }
}


/* ===================================
   SISTEMA UNIFICADO DE MODALES - AGREGAR ESTAS CLASES
   ================================= */

/* === OVERLAY BASE === */
.unified-modal-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0, 0, 0, 0.85) !important;
    backdrop-filter: blur(8px) !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    z-index: 1000 !important;
    overflow-y: auto !important;
    padding: 20px !important;
}

/* === CONTENEDOR MODAL BASE === */
.unified-modal {
    background: linear-gradient(145deg, #1f1f1f 0%, #171717 100%) !important;
    border-radius: 12px !important;
    width: 90% !important;
    max-width: 420px !important;
    box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(255, 255, 255, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
    border: 1px solid #333 !important;
    overflow: hidden !important;
    position: relative !important;
    animation: unifiedModalSlideIn 0.3s ease-out !important;
}

.unified-modal::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    height: 1px !important;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent) !important;
}

@keyframes unifiedModalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* === HEADER MODAL === */
.unified-modal-header {
    padding: 24px 24px 0 24px !important;
    position: relative !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08) !important;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.03) 0%, transparent 100%) !important;
}

.unified-modal-title {
    color: #f8f9fa !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    margin-bottom: 20px !important;
    padding-right: 30px !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5) !important;
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
}

.unified-close-btn {
    position: absolute !important;
    top: 16px !important;
    right: 16px !important;
    background: none !important;
    border: none !important;
    color: #666 !important;
    font-size: 18px !important;
    cursor: pointer !important;
    width: 20px !important;
    height: 20px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    line-height: 1 !important;
    transition: color 0.3s ease !important;
}

.unified-close-btn:hover {
    color: #999 !important;
}

/* === VARIANTES DE HEADER SEGÚN TIPO === */
.unified-modal-header.create-type .unified-modal-title {
    color: #4a9eff !important;
}

.unified-modal-header.warning-type .unified-modal-title {
    color: #0066cc  !important;
}

.unified-modal-header.danger-type .unified-modal-title {
    color: #ef4444 !important;
}

.unified-modal-header.success-type .unified-modal-title {
    color: #0066cc  !important;
}

/* === SECCIÓN DE ADVERTENCIA (SOLO PARA MODALES PELIGROSOS) === */
.unified-warning-section {
    background: linear-gradient(135deg, 
        rgba(255, 107, 74, 0.15) 0%, 
        rgba(220, 53, 69, 0.08) 100%) !important;
    border-left: 3px solid #ff6b4a !important;
    border-bottom: 1px solid rgba(255, 107, 74, 0.2) !important;
    padding: 18px 24px !important;
    display: flex !important;
    align-items: flex-start !important;
    gap: 14px !important;
    position: relative !important;
}

.unified-warning-section::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    height: 1px !important;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 107, 74, 0.3), 
        transparent) !important;
}

.unified-warning-icon {
    background: linear-gradient(135deg, #ff6b4a 0%, #e55347 100%) !important;
    color: #000000 !important;
    width: 22px !important;
    height: 22px !important;
    border-radius: 4px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 12px !important;
    font-weight: 900 !important;
    flex-shrink: 0 !important;
    margin-top: 1px !important;
    box-shadow: 
        0 2px 4px rgba(255, 107, 74, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
}

.unified-warning-content h3 {
    color: #ffffff !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    margin-bottom: 4px !important;
}

.unified-warning-content p {
    color: #cccccc !important;
    font-size: 13px !important;
    line-height: 1.4 !important;
}

/* === BODY MODAL === */
.unified-modal-body {
    padding: 20px !important;
}

.unified-confirmation-text {
    color: #ffffff !important;
    font-size: 14px !important;
    margin-bottom: 24px !important;
    line-height: 1.4 !important;
}

/* === FORMULARIOS === */
.unified-form-group {
    margin-bottom: 20px !important;
}

.unified-form-label {
    display: block !important;
    color: #ffffff !important;
    margin-bottom: 8px !important;
    font-size: 14px !important;
    font-weight: 500 !important;
}

.unified-form-input,
.unified-form-select,
.unified-form-textarea {
    width: 100% !important;
    padding: 12px 16px !important;
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 8px !important;
    color: white !important;
    font-size: 14px !important;
    transition: all 0.3s ease !important;
    box-sizing: border-box !important;
}

.unified-form-input:focus,
.unified-form-select:focus,
.unified-form-textarea:focus {
    outline: none !important;
    border-color: #4a9eff !important;
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1) !important;
    background: rgba(255, 255, 255, 0.08) !important;
}

.unified-form-textarea {
    resize: vertical !important;
    min-height: 100px !important;
}

.unified-form-help {
    color: #8892a6 !important;
    font-size: 12px !important;
    margin-top: 5px !important;
    display: block !important;
}

.unified-form-checkbox-wrapper {
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    color: #ffffff !important;
    font-size: 14px !important;
    cursor: pointer !important;
}

.unified-form-checkbox {
    margin: 0 !important;
}

/* === CAJAS DE INFORMACIÓN === */
.unified-info-box {
    padding: 12px 16px !important;
    border-radius: 8px !important;
    margin-bottom: 15px !important;
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
    font-size: 14px !important;
}

.unified-info-box.primary {
    background: rgba(74, 158, 255, 0.1) !important;
    border: 1px solid rgba(74, 158, 255, 0.2) !important;
    color: #4a9eff !important;
}

.unified-info-box.success {
   background: rgba(255, 255, 255, 0.05) !important;
   border: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: #7b7b7b  !important;
}

.unified-info-box.warning {
    background: rgba(251, 191, 36, 0.1) !important;
    border: 1px solid rgba(251, 191, 36, 0.2) !important;
    color: #fbbf24 !important;
}

.unified-info-box.danger {
    background: rgba(239, 68, 68, 0.1) !important;
    border: 1px solid rgba(239, 68, 68, 0.2) !important;
    color: #ef4444 !important;
}

/* === ACCIONES/BOTONES === */
.unified-modal-actions {
    display: flex !important;
    gap: 8px !important;
    justify-content: flex-end !important;
    margin-top: 20px !important;
    padding: 15px;
}

.unified-btn {
    padding: 12px 24px !important;
    border-radius: 6px !important;
    border: none !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    flex: 1 !important;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
    height: 40px !important;
    position: relative !important;
    overflow: hidden !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 6px !important;
}

.unified-btn::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: -100% !important;
    width: 100% !important;
    height: 100% !important;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.1), 
        transparent) !important;
    transition: left 0.5s !important;
}

.unified-btn:hover::before {
    left: 100% !important;
}

/* === VARIANTES DE BOTONES === */
.unified-btn.cancel {
    background: linear-gradient(135deg, #454545 0%, #363636 100%) !important;
    color: #f8f9fa !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 
        0 2px 4px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
}

.unified-btn.cancel:hover {
    background: linear-gradient(135deg, #525252 0%, #424242 100%) !important;
    transform: translateY(-1px) !important;
    box-shadow: 
        0 4px 8px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.15) !important;
}

.unified-btn.primary {
    background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%) !important;
    color: #ffffff !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 
        0 2px 4px rgba(74, 158, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
}

.unified-btn.primary:hover {
    background: linear-gradient(135deg, #5aa8ff 0%, #0080ff 100%) !important;
    transform: translateY(-1px) !important;
    box-shadow: 
        0 4px 8px rgba(74, 158, 255, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.25) !important;
}

.unified-btn.success {
    background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%) !important;
    color: #ffffff !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;

}

.unified-btn.success:hover {
    background-color:   linear-gradient(135deg, #4a9eff 0%, #0066cc 100%) !important;
    transform: translateY(-1px) !important;

}

.unified-btn.warning {
    background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%) !important;
    color: #ffffff !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
}

.unified-btn.warning:hover {
    background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%) !important;
    color: #ffffff !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
}

.unified-btn.danger {
    background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%) !important;
    color: #ffffff !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 
        0 2px 4px rgba(220, 53, 69, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
}

.unified-btn.danger:hover {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
    transform: translateY(-1px) !important;
    box-shadow: 
        0 4px 8px rgba(220, 53, 69, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.25) !important;
}

.unified-btn:focus {
    outline: none !important;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2) !important;
}

.unified-btn:disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
}

/* === MODALES ESPECÍFICOS === */

/* Modal amplio para IA */
.unified-modal.ai-modal {
    max-width: 600px !important;
    width: 95% !important;
}

.unified-modal.ai-modal .unified-form-textarea {
    min-height: 120px !important;
}

/* Modal de confirmación simple */
.unified-modal.confirmation-modal {
    max-width: 450px !important;
}

/* Modal de formulario */
.unified-modal.form-modal {
    max-width: 480px !important;
}





/* === RESPONSIVE === */
@media (max-width: 768px) {
    .unified-modal {
        width: 95% !important;
        max-width: none !important;
        margin: 20px !important;
    }
    
    .unified-modal-header {
        padding: 20px 20px 0 20px !important;
    }
    
    .unified-modal-body {
        padding: 15px !important;
    }
    
    .unified-modal-actions {
        flex-direction: column !important;
        gap: 10px !important;
    }
    
    .unified-btn {
        flex: none !important;
        width: 100% !important;
    }
    
    .unified-modal.ai-modal {
        width: 98% !important;
        height: 90vh !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
    }
}


/* ================================
   PANEL DE UTILIDADES
================================ */
.utilities-panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(5px);
    z-index: 5000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}


.utilities-panel {
    background: linear-gradient(145deg, #0a0e13 0%, #141b26 50%, #0a0e13 100%);
    border-radius: 0; /* ← SIN BORDES REDONDEADOS */
    width: 95%;
    max-width: 1600px;
    height: 92vh;
    display: flex;
    overflow: hidden;
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7);
    border: none; /* ← SIN BORDE */
}

.utilities-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(74, 158, 255, 0.5), 
        transparent);
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* SIDEBAR */
.utilities-sidebar {
    width: 300px;
    background: linear-gradient(180deg, rgba(15, 20, 25, 0.95) 0%, rgba(10, 14, 19, 0.98) 100%);
    border-right: 1px solid rgba(74, 158, 255, 0.15);
    display: flex;
    flex-direction: column;
    position: relative;
}

.utilities-sidebar::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 1px;
    height: 100%;
    background: linear-gradient(180deg,
        transparent,
        rgba(74, 158, 255, 0.3),
        transparent);
}

.utilities-sidebar-header {
    padding: 32px 24px;
    border-bottom: 1px solid rgba(74, 158, 255, 0.1);
    background: linear-gradient(180deg, 
        rgba(74, 158, 255, 0.05) 0%, 
        transparent 100%);
}


.utilities-sidebar-header h2 {
    color: #4a9eff;
    font-size: 24px;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
    text-shadow: 0 2px 10px rgba(74, 158, 255, 0.3);
}

.utilities-nav {
    flex: 1;
    padding: 24px 12px;
    overflow-y: auto;
}


.utilities-nav-item {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 20px;
    background: transparent;
    border: none;
    border-radius: 12px;
    color: #8892a6;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin-bottom: 8px;
    position: relative;
    overflow: hidden;
}

.utilities-nav-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 3px;
    background: linear-gradient(180deg, #4a9eff, #00d4ff);
    transform: scaleY(0);
    transition: transform 0.3s ease;
}

.utilities-nav-item:hover {
    background: linear-gradient(90deg, 
        rgba(74, 158, 255, 0.12) 0%, 
        rgba(74, 158, 255, 0.05) 100%);
    color: #4a9eff;
    transform: translateX(4px);
}

.utilities-nav-item.active {
    background: linear-gradient(90deg, 
        rgba(74, 158, 255, 0.2) 0%, 
        rgba(74, 158, 255, 0.08) 100%);
    color: #4a9eff;
    font-weight: 600;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.utilities-nav-item.active::before {
    transform: scaleY(1);
}

.utilities-nav-item i {
    font-size: 20px;
    width: 24px;
    transition: transform 0.3s ease;
}


.utilities-nav-item:hover i {
    transform: scale(1.1);
}
.utilities-sidebar-footer {
    padding: 24px;
    border-top: 1px solid rgba(74, 158, 255, 0.1);
    background: linear-gradient(180deg, 
        transparent 0%, 
        rgba(74, 158, 255, 0.03) 100%);
}

.close-utilities-panel {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: white;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.close-utilities-panel:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
}
/* CONTENIDO PRINCIPAL */
.utilities-main-content {
    flex: 1;
    overflow-y: auto;
    padding: 40px;
    background: linear-gradient(135deg, 
        rgba(15, 20, 25, 0.4) 0%, 
        rgba(26, 35, 50, 0.2) 100%);
}

.utilities-section {
    display: none;
    animation: slideInContent 0.4s ease-out;
}


.utilities-section.active {
    display: block;
}

.utilities-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(74, 158, 255, 0.15);
    position: relative;
}

.utilities-section-header::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 120px;
    height: 2px;
    background: linear-gradient(90deg, #4a9eff, #00d4ff);
    border-radius: 2px;
}

.utilities-section-header h3 {
    color: #ffffff;
    font-size: 28px;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.add-new-btn {
    padding: 12px 24px;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
}


.add-new-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(34, 197, 94, 0.4);
    background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
}

.utilities-search {
    position: relative;
    margin-bottom: 20px;
}

.utilities-search i {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #8892a6;
}

.utilities-search input {
    width: 100%;
    padding: 12px 12px 12px 45px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: white;
    font-size: 14px;
}

.utilities-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

.filter-chip {
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    color: #8892a6;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s;
}

.filter-chip:hover {
    background: rgba(255, 255, 255, 0.08);
}

.filter-chip.active {
    background: linear-gradient(45deg, #4a9eff, #00d4ff);
    border-color: transparent;
    color: white;
}

.utilities-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}
/* CARDS DE UTILIDADES */
.utility-card {
    background: rgba(255, 255, 255, 0.02);
    border: none; /* ← SIN BORDES */
    border-radius: 8px;
    padding: 20px;
    transition: all 0.3s ease;
}


.utility-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
}

.utility-card:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

.utility-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.utility-card h4 {
    font-size: 16px;
    font-weight: 600;
    color: #ffffff;
    margin: 0;
}

.utility-badge {
    padding: 4px 10px;
    background: rgba(74, 158, 255, 0.15);
    color: #4a9eff;
    border-radius: 6px;
    font-size: 11px;
    text-transform: uppercase;
    font-weight: 600;
}

.utility-card p {
    color: #8892a6;
    font-size: 13px;
    margin-bottom: 12px;
    line-height: 1.4;
}

.utility-code-preview {
    background: rgba(0, 0, 0, 0.4);
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 12px;
    max-height: 60px;
    overflow-y: auto;
}

.utility-code-preview code {
    color: #d4d4d4;
    font-family: 'Courier New', monospace;
    font-size: 11px;
    line-height: 1.5;
}

.utility-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}
 .btn-preview, .btn-delete {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.btn-copy, .btn-download {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
}


.btn-copy {
    background: rgba(34, 197, 94, 0.12);
    color: #22c55e;
}

.btn-copy:hover {
    background: rgba(34, 197, 94, 0.2);
}

.btn-download {
    background: rgba(59, 130, 246, 0.12);
    color: #3b82f6;
}

.btn-download:hover {
    background: rgba(59, 130, 246, 0.2);
}

.btn-delete {
    padding: 8px;
    background: rgba(239, 68, 68, 0.12);
    color: #ef4444;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-delete:hover {
    background: rgba(239, 68, 68, 0.3);
}

/* MODALES DE AGREGAR */
.add-utility-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 6000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.add-utility-modal {
    background: #1f1f1f;
    border-radius: 12px;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.add-utility-modal.large {
    max-width: 800px;
}

.add-utility-header {
    padding: 20px 25px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.add-utility-header h3 {
    color: #4a9eff;
    font-size: 20px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.add-utility-header button {
    background: none;
    border: none;
    color: #666;
    font-size: 28px;
    cursor: pointer;
    transition: color 0.3s;
}

.add-utility-header button:hover {
    color: #999;
}

.add-utility-modal form {
    padding: 25px;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: #ffffff;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    font-size: 14px;
}

.form-group textarea {
    resize: vertical;
    font-family: 'Courier New', monospace;
}

.form-group small {
    display: block;
    color: #8892a6;
    font-size: 12px;
    margin-top: 5px;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 25px;
}

.btn-cancel, .btn-save {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-cancel {
    background: rgba(255, 255, 255, 0.1);
    color: #8892a6;
}

.btn-cancel:hover {
    background: rgba(255, 255, 255, 0.15);
}

.btn-save {
    background: linear-gradient(45deg, #4a9eff, #00d4ff);
    color: white;
}

.btn-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.4);
}

/* MODAL PREVIEW */
.preview-design-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 7000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
}

.preview-design-modal {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    overflow: hidden;
}

.preview-header {
    padding: 20px 25px;
    background: #f8f9fa;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.preview-header h3 {
    margin: 0;
    color: #1f2937;
}

.preview-header button {
    background: none;
    border: none;
    color: #6b7280;
    font-size: 24px;
    cursor: pointer;
}

.preview-content {
    padding: 40px;
    overflow-y: auto;
    max-height: calc(90vh - 80px);
}




/* ================================
   CARDS DE DISEÑO - VERSIÓN MEJORADA
================================ */

.design-card {
    background: rgba(255, 255, 255, 0.02);
    border: none; /* ← SIN BORDES */
    border-radius: 8px;
    padding: 16px;
    transition: all 0.3s ease;
}

.design-render-box {
    background: 
        linear-gradient(45deg, #e8e8e8 25%, transparent 25%),
        linear-gradient(-45deg, #e8e8e8 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #e8e8e8 75%),
        linear-gradient(-45deg, transparent 75%, #e8e8e8 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    background-color: #f8f8f8;
    border-radius: 8px;
    padding: 30px;
    min-height: 300px; /* ← Más pequeño */
    max-height: 300px; /* ← Limitado */
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: auto;
}
.design-card.expanded {
    grid-column: 1 / -1;
    max-width: 100%;
   
    top: 0;
    
    right: 0;
    bottom: 0;
    z-index: 100;
    background: rgba(15, 20, 25, 0.98);
    backdrop-filter: blur(10px);
    padding: 30px;
    overflow-y: auto;
    margin: 0;
}

/* Ocultar el grid cuando hay una card expandida */
.utilities-grid:has(.design-card.expanded) {
    position: relative;
}

.utilities-grid:has(.design-card.expanded) > .design-card:not(.expanded) {
    display: none;
}

/* Header fijo de la card */
.design-card-header-fixed {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.design-card-header-fixed > div {
    display: flex;
    align-items: center;
    gap: 12px;
}

.design-card-header-fixed h4 {
    color: #ffffff;
    font-size: 16px;
    margin: 0;
}

.btn-delete-header {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.btn-delete-header:hover {
    background: rgba(239, 68, 68, 0.3);
    transform: scale(1.05);
}

/* ===== MODO PREVIEW ===== */
.design-preview-mode {
    display: none;
    position: relative;
}

.design-preview-mode.active {
    display: block;
}


.design-render-box {
    background: 
        linear-gradient(45deg, #e8e8e8 25%, transparent 25%),
        linear-gradient(-45deg, #e8e8e8 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #e8e8e8 75%),
        linear-gradient(-45deg, transparent 75%, #e8e8e8 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    background-color: #f8f8f8;
    border-radius: 10px;
    padding: 40px;
    min-height: 457px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: auto;
    width: 100%;
}

/* Contenedor principal con altura controlada */
.split-view-container {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 20px !important;
    height: auto !important;
}

/* Renderizado SIN scroll */
.split-render {
    background: 
        linear-gradient(45deg, #e8e8e8 25%, transparent 25%),
        linear-gradient(-45deg, #e8e8e8 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #e8e8e8 75%),
        linear-gradient(-45deg, transparent 75%, #e8e8e8 75%) !important;
    background-size: 20px 20px !important;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px !important;
    background-color: #f8f8f8 !important;
    border-radius: 10px !important;
    padding: 30px !important;
    overflow: visible !important; /* SIN SCROLL */
}

/* Lado derecho - Código CON SCROLL VERTICAL */
.split-code {
    display: flex !important;
    flex-direction: column !important;
    background: rgba(0, 0, 0, 0.3) !important;
    border-radius: 10px !important;
    overflow: hidden !important;
    max-height: 600px !important; /* Altura máxima */
}

.code-tabs-header {
    background: rgba(0, 0, 0, 0.4) !important;
    padding: 12px 15px !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    flex-shrink: 0 !important;
}

/* AQUÍ ES DONDE APARECE EL SCROLL VERTICAL */
.code-content-area {
    flex: 1 !important;
    overflow-y: scroll !important;
    overflow-x: hidden !important;
    padding: 20px !important;
    min-height: 400px !important;
    max-height: 500px !important;
    background: #1e1e1e !important; /* Fondo aquí */
    border-radius: 8px !important;
}


.code-block.active {
    display: block !important;
}

.code-block code {
    font-family: 'Courier New', Consolas, Monaco, monospace !important;
    font-size: 13px !important;
    line-height: 1.7 !important;
    white-space: pre-wrap !important; /* Wrap del texto */
    word-wrap: break-word !important;
    display: block !important;
    padding: 0 !important;
}

/* Scrollbar VERTICAL bonita */
.code-content-area::-webkit-scrollbar {
    width: 14px !important; /* Ancho del scrollbar VERTICAL */
    height: 0 !important; /* Sin scrollbar horizontal */
}

.code-content-area::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1) !important;
    border-radius: 7px !important;
}

.code-content-area::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #4a9eff, #00d4ff) !important;
    border-radius: 7px !important;
    border: 2px solid rgba(0, 0, 0, 0.3) !important;
}

.code-content-area::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #5aa8ff, #20ddff) !important;
}

/* Lo mismo para el split-render */
.split-render {
    background: 
        linear-gradient(45deg, #e8e8e8 25%, transparent 25%),
        linear-gradient(-45deg, #e8e8e8 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #e8e8e8 75%),
        linear-gradient(-45deg, transparent 75%, #e8e8e8 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    background-color: #f8f8f8;
    border-radius: 10px;
    padding: 30px;
    overflow: visible; /* SIN SCROLL */
}
/* Botón Get Code en esquina superior derecha */
.btn-get-code-corner {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 10px 18px;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(74, 158, 255, 0.5);
    border-radius: 8px;
    color: #4a9eff;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 10;
}

.design-card:hover .btn-get-code-corner {
    opacity: 1;
}

.btn-get-code-corner:hover {
    background: rgba(74, 158, 255, 0.2);
    border-color: #4a9eff;
    transform: scale(1.05);
}

/* ===== MODO CÓDIGO (Vista dividida) ===== */
.design-code-mode {
    display: none;
    flex-direction: column;
    position: relative;
}

.design-code-mode.active {
    display: flex;
}

/* Botón Go Back */
.btn-go-back-corner {
    align-self: flex-start;
    padding: 10px 18px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: #8892a6;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.btn-go-back-corner:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #4a9eff;
    border-color: #4a9eff;
}

/* Contenedor dividido */
.split-view-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    min-height: 450px;
}

/* Lado izquierdo - Renderizado */


.split-render-content {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100%;
}

/* Lado derecho - Código */
.split-code {
    display: flex;
    flex-direction: column;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    overflow: hidden;
    height: 100%;
}

.code-tabs-header {
    background: rgba(0, 0, 0, 0.4);
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.code-tabs {
    display: flex;
    gap: 5px;
}

.code-tab {
    padding: 8px 15px;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: #8892a6;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    border-radius: 6px 6px 0 0;
}

.code-tab:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #4a9eff;
}

.code-tab.active {
    color: #4a9eff;
    background: rgba(74, 158, 255, 0.1);
    border-bottom-color: #4a9eff;
}

.btn-copy-inline {
    padding: 7px 14px;
    background: rgba(34, 197, 94, 0.2);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 6px;
    color: #22c55e;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
}

.btn-copy-inline:hover {
    background: rgba(34, 197, 94, 0.3);
}


.code-content-area::-webkit-scrollbar {
    width: 10px;
}

.code-content-area::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 5px;
}

.code-content-area::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #4a9eff, #00d4ff);
    border-radius: 5px;
}

.code-block {
    display: none;
    margin: 0;
    height: 100%;
}

.code-block.active {
    display: block;
}

.code-block code {
    color: #d4d4d4;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
}

/* Scrollbar personalizado */
.split-render::-webkit-scrollbar,
.code-content-area::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.split-render::-webkit-scrollbar-track,
.code-content-area::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.split-render::-webkit-scrollbar-thumb,
.code-content-area::-webkit-scrollbar-thumb {
    background: rgba(74, 158, 255, 0.5);
    border-radius: 4px;
}

.split-render::-webkit-scrollbar-thumb:hover,
.code-content-area::-webkit-scrollbar-thumb:hover {
    background: rgba(74, 158, 255, 0.7);
}

/* Responsive */
@media (max-width: 1024px) {
    .split-view-container {
        grid-template-columns: 1fr;
    }
}




.code-block.active {
    display: block;
}

.code-block code {
    font-family: 'Courier New', Consolas, Monaco, monospace;
    font-size: 13px;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    display: block;
    padding: 0;
}

/* Sobrescribir estilos de highlight.js si es necesario */
.code-block code.hljs {
    background: transparent;
    padding: 0;
}

/* ========================================
   TEMA CLARO - COMPLETO
   ======================================== */

[data-theme="light"] {
    /* === COLORES BASE === */
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-tertiary: #e8e8e8;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --text-tertiary: #9ca3af;
    --border-color: #d1d5db;
    --accent-primary: #2563eb;
    --accent-secondary: #3b82f6;
    --shadow-color: rgba(0, 0, 0, 0.1);
}

[data-theme="light"] body {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
    color: var(--text-primary);
}

/* === SIDEBAR === */
[data-theme="light"] .sidebar {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-right: 1px solid var(--border-color);
}

[data-theme="light"] .sidebar::after {
    background: linear-gradient(to bottom, transparent, var(--accent-primary), transparent);
}

[data-theme="light"] .logo {
    color: var(--accent-primary);
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .logo-icon {
    background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
}

[data-theme="light"] .nav-link {
    color: var(--text-secondary);
}

[data-theme="light"] .nav-link:hover,
[data-theme="light"] .nav-link.active {
    background: rgba(37, 99, 235, 0.1);
    color: var(--accent-primary);
}

/* === HEADER === */
[data-theme="light"] .header {
    background: rgba(255, 255, 255, 0.95);
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .page-title {
    color: var(--text-primary);
}

[data-theme="light"] .project-name-header {
    color: var(--accent-primary);
}

[data-theme="light"] .control-btn {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
}

[data-theme="light"] .control-btn:hover {
    background: rgba(37, 99, 235, 0.1);
    border-color: var(--accent-primary);
    color: var(--accent-primary);
}

/* === FILE EXPLORER === */
[data-theme="light"] .file-explorer {
    background: rgba(255, 255, 255, 0.95);
    border-right: 1px solid var(--border-color);
}

[data-theme="light"] .explorer-header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .explorer-title {
    color: var(--text-primary);
}

[data-theme="light"] .new-file-btn {
    background: rgba(37, 99, 235, 0.15);
    color: var(--accent-primary);
}

[data-theme="light"] .file-item {
    color: var(--text-secondary);
}

[data-theme="light"] .file-item:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

[data-theme="light"] .file-item.active {
    background: rgba(37, 99, 235, 0.15);
    color: var(--accent-primary);
}

/* === EDITOR === */
[data-theme="light"] .editor-main {
    background: var(--bg-primary);
}

[data-theme="light"] .editor-tabs {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .editor-tab {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border-right: 1px solid var(--border-color);
}

[data-theme="light"] .editor-tab:hover {
    background: var(--bg-tertiary);
}

[data-theme="light"] .editor-tab.active {
    background: var(--bg-primary);
    color: var(--text-primary);
    border-bottom: 2px solid var(--accent-primary);
}

[data-theme="light"] .editor-toolbar {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .file-name-display {
    color: var(--text-primary);
}

[data-theme="light"] #monaco-editor-container {
    background: var(--bg-primary) !important;
}

/* === BREADCRUMBS === */
[data-theme="light"] .editor-breadcrumbs {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    color: var(--text-secondary);
}

[data-theme="light"] .breadcrumb-item {
    color: var(--text-secondary);
}

[data-theme="light"] .breadcrumb-item.active {
    color: var(--accent-primary);
}

/* === STATUS BAR === */
[data-theme="light"] .editor-status-bar {
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    color: var(--text-primary);
}

/* === MODALES === */
[data-theme="light"] .modal-overlay {
    background: rgba(0, 0, 0, 0.5);
}

[data-theme="light"] .modal {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .modal h3 {
    color: var(--text-primary);
}

[data-theme="light"] .form-group label {
    color: var(--text-primary);
}

[data-theme="light"] .form-group input,
[data-theme="light"] .form-group select,
[data-theme="light"] .form-group textarea {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

[data-theme="light"] .form-group input:focus,
[data-theme="light"] .form-group select:focus,
[data-theme="light"] .form-group textarea:focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

/* === BOTONES === */
[data-theme="light"] .cancel-btn {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .cancel-btn:hover {
    background: var(--bg-secondary);
}

[data-theme="light"] .create-btn,
[data-theme="light"] .unified-btn.primary {
    background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
}

/* === REPOSITORIOS === */
[data-theme="light"] .repository-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .repository-card:hover {
    background: var(--bg-secondary);
    border-color: var(--accent-primary);
    box-shadow: 0 4px 12px var(--shadow-color);
}

[data-theme="light"] .repository-card h3 {
    color: var(--text-primary);
}

[data-theme="light"] .repository-card p {
    color: var(--text-secondary);
}

/* === UTILIDADES PANEL === */
[data-theme="light"] .utilities-panel {
    background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
}

[data-theme="light"] .utilities-sidebar {
    background: var(--bg-primary);
    border-right: 1px solid var(--border-color);
}

[data-theme="light"] .utilities-nav-item {
    color: var(--text-secondary);
}

[data-theme="light"] .utilities-nav-item:hover,
[data-theme="light"] .utilities-nav-item.active {
    background: rgba(37, 99, 235, 0.1);
    color: var(--accent-primary);
}

[data-theme="light"] .utility-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .utility-card:hover {
    background: var(--bg-secondary);
    box-shadow: 0 4px 12px var(--shadow-color);
}

/* === MENU SUPERIOR === */
[data-theme="light"] .vscode-menu-bar {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
}

[data-theme="light"] .menu-item:hover {
    background: var(--bg-tertiary);
}

[data-theme="light"] .menu-item.active {
    background: rgba(37, 99, 235, 0.15);
}

[data-theme="light"] .menu-dropdown {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .menu-dropdown-item {
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
}

[data-theme="light"] .menu-dropdown-item:hover {
    background: var(--bg-secondary);
}

/* === TOAST === */
[data-theme="light"] .toast {
    background: rgba(37, 99, 235, 0.95);
    box-shadow: 0 4px 12px var(--shadow-color);
}

[data-theme="light"] .toast.error {
    background: rgba(220, 38, 38, 0.95);
}

/* === SCROLLBAR === */
[data-theme="light"] ::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

[data-theme="light"] ::-webkit-scrollbar-thumb {
    background: var(--border-color);
}

[data-theme="light"] ::-webkit-scrollbar-thumb:hover {
    background: var(--text-tertiary);
}

/* === USER MENU === */
[data-theme="light"] .user-menu-toggle {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

[data-theme="light"] .user-dropdown {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
}

[data-theme="light"] .user-dropdown-item {
    color: var(--text-primary);
}

[data-theme="light"] .user-dropdown-item:hover {
    background: var(--bg-secondary);
    color: var(--accent-primary);
}

/* ========================================
   TEMA CLARO - EDITOR TABS, TOOLBAR, FILE EXPLORER
   ======================================== */

/* === EDITOR TABS === */
[data-theme="light"] .editor-tabs {
    background: #f3f4f6 !important;
    border-bottom: 1px solid #d1d5db !important;
}

[data-theme="light"] .editor-tabs::before {
    background: linear-gradient(to left, rgba(243, 244, 246, 0.95) 0%, transparent 100%);
}

[data-theme="light"] .editor-tab {
    background: #e5e7eb !important;
    color: #6b7280 !important;
    border: 1px solid #d1d5db !important;
    border-bottom: none !important;
}

[data-theme="light"] .editor-tab:hover {
    background: #d1d5db !important;
    color: #1f2937 !important;
}

[data-theme="light"] .editor-tab.active {
    background: #ffffff !important;
    color: #1f2937 !important;
    border-color: #d1d5db !important;
    border-bottom: 2px solid #2563eb !important;
}

[data-theme="light"] .editor-tab.modified > span:not(.close-tab) {
    color: #d97706 !important;
}

[data-theme="light"] .editor-tab.modified > span:not(.close-tab)::after {
    color: #d97706 !important;
}

[data-theme="light"] .editor-tab .close-tab {
    color: #6b7280 !important;
}

[data-theme="light"] .editor-tab .close-tab:hover {
    background: rgba(220, 38, 38, 0.15) !important;
    color: #dc2626 !important;
}

/* === EDITOR TOOLBAR === */
[data-theme="light"] .editor-toolbar {
    background: #f9fafb !important;
    border-bottom: 1px solid #e5e7eb !important;
}

[data-theme="light"] .file-name-display {
    color: #1f2937 !important;
}

[data-theme="light"] .save-status {
    color: #6b7280 !important;
}

[data-theme="light"] .save-status.saving {
    color: #d97706 !important;
}

[data-theme="light"] .save-status.saved {
    color: #059669 !important;
}

[data-theme="light"] .preview-btn {
    background: rgba(37, 99, 235, 0.1) !important;
    border: 1px solid rgba(37, 99, 235, 0.2) !important;
    color: #2563eb !important;
}

[data-theme="light"] .preview-btn:hover {
    background: rgba(37, 99, 235, 0.2) !important;
}

/* === EXPORT DROPDOWN === */
[data-theme="light"] .export-tools {
    color: #1f2937;
}

[data-theme="light"] .export-dropdown-menu {
    background: #ffffff !important;
    border: 1px solid #d1d5db !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
}

[data-theme="light"] .export-option {
    color: #1f2937 !important;
    border-bottom: 1px solid #e5e7eb !important;
}

[data-theme="light"] .export-option:hover {
    background: #f3f4f6 !important;
    color: #2563eb !important;
}

[data-theme="light"] .export-option i {
    color: #2563eb !important;
}

[data-theme="light"] #export-dropdown-btn {
    background: rgba(37, 99, 235, 0.1) !important;
    border: 1px solid rgba(37, 99, 235, 0.2) !important;
    color: #2563eb !important;
}

[data-theme="light"] #export-dropdown-btn:hover {
    background: rgba(37, 99, 235, 0.2) !important;
}

/* === FILE EXPLORER === */
[data-theme="light"] .file-explorer {
    background: #f9fafb !important;
    border-right: 1px solid #d1d5db !important;
}

[data-theme="light"] .file-explorer.improved-explorer {
    background: #f9fafb !important;
}

[data-theme="light"] .explorer-header {
    background: #f3f4f6 !important;
    border-bottom: 1px solid #e5e7eb !important;
}

[data-theme="light"] .explorer-title {
    color: #1f2937 !important;
}

[data-theme="light"] .explorer-actions {
    opacity: 1 !important;
}

[data-theme="light"] .explorer-action-btn {
    background: rgba(37, 99, 235, 0.08) !important;
    color: #2563eb !important;
    border: 1px solid rgba(37, 99, 235, 0.15) !important;
}

[data-theme="light"] .explorer-action-btn:hover {
    background: rgba(37, 99, 235, 0.15) !important;
}

[data-theme="light"] .new-file-btn {
    background: rgba(37, 99, 235, 0.1) !important;
    color: #2563eb !important;
}

[data-theme="light"] .new-file-btn:hover {
    background: rgba(37, 99, 235, 0.2) !important;
}

/* === FILE TREE === */
[data-theme="light"] .file-tree {
    scrollbar-color: rgba(37, 99, 235, 0.6) #f3f4f6 !important;
}

[data-theme="light"] .file-tree::-webkit-scrollbar-track {
    background: #f3f4f6 !important;
}

[data-theme="light"] .file-tree::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #2563eb, #3b82f6) !important;
    border: 1px solid #e5e7eb !important;
}

[data-theme="light"] .file-tree::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #1d4ed8, #2563eb) !important;
}

[data-theme="light"] .file-item {
    color: #6b7280 !important;
}

[data-theme="light"] .file-item:hover {
    background: #f3f4f6 !important;
    color: #1f2937 !important;
}

[data-theme="light"] .file-item.active {
    background: rgba(37, 99, 235, 0.1) !important;
    color: #2563eb !important;
}

[data-theme="light"] .file-item i {
    color: inherit !important;
}

[data-theme="light"] .folder-item {
    font-weight: 600 !important;
    color: #1f2937 !important;
}

[data-theme="light"] .folder-content {
    border-left: 1px solid #e5e7eb !important;
}

/* === REPOSITORY FILES VIEW === */
[data-theme="light"] .repository-files-view .explorer-header {
    display: flex !important;
    background: #f3f4f6 !important;
    border-bottom: 1px solid #d1d5db !important;
}

[data-theme="light"] .repository-open-header {
    background: #f3f4f6 !important;
    border-bottom: 1px solid #d1d5db !important;
    padding: 4px 1px !important;
    margin-top: -6px;
}

[data-theme="light"] .repository-open-header button {
    background: rgba(37, 99, 235, 0.1) !important;
    border: 1px solid rgba(37, 99, 235, 0.2) !important;
    color: #2563eb !important;
}

[data-theme="light"] .repository-open-header button:hover {
    background: rgba(37, 99, 235, 0.2) !important;
}

[data-theme="light"] .repository-open-header h3 {
    color: #2563eb !important;
}

[data-theme="light"] .repository-open-header p {
    color: #6b7280 !important;
}

/* === REPOSITORY CARDS === */
[data-theme="light"] .repository-header {
    padding: 16px !important;
    border-bottom: 1px solid #e5e7eb !important;
}

[data-theme="light"] .repository-header h3 {
    color: #1f2937 !important;
}

[data-theme="light"] .repository-header button {
    background: linear-gradient(45deg, #2563eb, #3b82f6) !important;
    box-shadow: 0 2px 6px rgba(37, 99, 235, 0.25) !important;
}

[data-theme="light"] .repository-card {
    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%) !important;
    border: 1px solid #e5e7eb !important;
}

[data-theme="light"] .repository-card:hover {
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%) !important;
    border-color: rgba(37, 99, 235, 0.3) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
}

[data-theme="light"] .repository-card .repo-icon {
    background: linear-gradient(45deg, #2563eb, #3b82f6) !important;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2) !important;
}

[data-theme="light"] .repository-card h3 {
    color: #1f2937 !important;
}

[data-theme="light"] .repository-card p {
    color: #6b7280 !important;
}

[data-theme="light"] .repository-card > div:first-child > div:nth-child(2) > div {
    color: #6b7280 !important;
}

[data-theme="light"] .repository-card > div:first-child > div:last-child {
    color: #2563eb !important;
}

[data-theme="light"] .delete-repo-btn,
[data-theme="light"] .btn-delete-header {
    background: rgba(220, 38, 38, 0.1) !important;
    border: 1px solid rgba(220, 38, 38, 0.2) !important;
    color: #dc2626 !important;
}

[data-theme="light"] .delete-repo-btn:hover,
[data-theme="light"] .btn-delete-header:hover {
    background: rgba(220, 38, 38, 0.2) !important;
}

/* === EMPTY STATES === */
[data-theme="light"] .empty-repository-state {
    color: #6b7280 !important;
}

[data-theme="light"] .empty-repository-state i {
    color: #2563eb !important;
}

[data-theme="light"] .empty-repository-state h3 {
    color: #1f2937 !important;
}

[data-theme="light"] .empty-repository-state button {
    background: linear-gradient(45deg, #2563eb, #3b82f6) !important;
    box-shadow: 0 3px 12px rgba(37, 99, 235, 0.3) !important;
}

/* === ICONOS DE ARCHIVOS EN TEMA CLARO === */
[data-theme="light"] .file-item i.fa-html5 { color: #e34f26 !important; }
[data-theme="light"] .file-item i.fa-css3-alt { color: #1572b6 !important; }
[data-theme="light"] .file-item i.fa-js-square { color: #f7df1e !important; }
[data-theme="light"] .file-item i.fa-python { color: #3776ab !important; }
[data-theme="light"] .file-item i.fa-java { color: #ed8b00 !important; }
[data-theme="light"] .file-item i.fa-react { color: #61dafb !important; }
[data-theme="light"] .file-item i.fa-php { color: #777bb4 !important; }
[data-theme="light"] .file-item i.fa-gem { color: #cc342d !important; }
[data-theme="light"] .file-item i.fa-docker { color: #0db7ed !important; }
[data-theme="light"] .file-item i.fa-git-alt { color: #f05032 !important; }
[data-theme="light"] .file-item i.fa-database { color: #336791 !important; }
[data-theme="light"] .file-item i.fa-markdown { color: #083fa1 !important; }

[data-theme="light"] .file-item.folder-item i.fa-folder,
[data-theme="light"] .file-item.folder-item i.fa-folder-open {
    color: #f59e0b !important;
}

[data-theme="light"] .file-item.folder-item i.fa-chevron-right,
[data-theme="light"] .file-item.folder-item i.fa-chevron-down {
    color: #6b7280 !important;
}

/* ========================================
   TEMA CLARO - NÚMEROS DE LÍNEA Y GUTTER DE MONACO
   ======================================== */

/* === MONACO EDITOR GUTTER (números de línea) === */
[data-theme="light"] #monaco-editor-container .monaco-editor {
    background: #ffffff !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .margin {
    background: #f9fafb !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .margin-view-overlays {
    background: #f9fafb !important;
}

/* Números de línea */
[data-theme="light"] #monaco-editor-container .monaco-editor .line-numbers {
    color: #9ca3af !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .line-numbers.active-line-number {
    color: #1f2937 !important;
    font-weight: 600 !important;
}

/* Área de contenido */
[data-theme="light"] #monaco-editor-container .monaco-editor .lines-content {
    background: #ffffff !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .view-lines {
    background: #ffffff !important;
}

/* Línea actual (highlight) */
[data-theme="light"] #monaco-editor-container .monaco-editor .view-overlays .current-line {
    background: #f3f4f6 !important;
    border: none !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .view-overlays .current-line-margin {
    background: #e5e7eb !important;
    border: none !important;
}

/* Selección de texto */
[data-theme="light"] #monaco-editor-container .monaco-editor .selected-text {
    background: rgba(37, 99, 235, 0.2) !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .view-overlays .selected-text {
    background: rgba(37, 99, 235, 0.15) !important;
}

/* Cursor */
[data-theme="light"] #monaco-editor-container .monaco-editor .cursor {
    background: #1f2937 !important;
    border-color: #1f2937 !important;
}

/* Scrollbar de Monaco */
[data-theme="light"] #monaco-editor-container .monaco-scrollable-element .scrollbar.vertical {
    background: #f3f4f6 !important;
}

[data-theme="light"] #monaco-editor-container .monaco-scrollable-element .scrollbar.vertical .slider {
    background: #d1d5db !important;
}

[data-theme="light"] #monaco-editor-container .monaco-scrollable-element .scrollbar.vertical .slider:hover {
    background: #2563eb !important;
}

[data-theme="light"] #monaco-editor-container .monaco-scrollable-element .scrollbar.horizontal {
    background: #f3f4f6 !important;
}

[data-theme="light"] #monaco-editor-container .monaco-scrollable-element .scrollbar.horizontal .slider {
    background: #d1d5db !important;
}

/* Minimap */
[data-theme="light"] #monaco-editor-container .monaco-editor .minimap {
    background: #f9fafb !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .minimap-slider {
    background: rgba(37, 99, 235, 0.15) !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .minimap-slider:hover {
    background: rgba(37, 99, 235, 0.25) !important;
}

/* Borde del editor */
[data-theme="light"] #monaco-editor-container .monaco-editor .editor-scrollable {
    background: #ffffff !important;
}

/* Sugerencias/Autocomplete */
[data-theme="light"] .monaco-editor .suggest-widget {
    background: #ffffff !important;
    border: 1px solid #d1d5db !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
}

[data-theme="light"] .monaco-editor .suggest-widget .monaco-list-row {
    color: #1f2937 !important;
}

[data-theme="light"] .monaco-editor .suggest-widget .monaco-list-row.focused {
    background: #f3f4f6 !important;
}

[data-theme="light"] .monaco-editor .suggest-widget .monaco-list-row.focused .monaco-highlighted-label {
    color: #2563eb !important;
}

/* Find/Replace Widget */
[data-theme="light"] .monaco-editor .find-widget {
    background: #ffffff !important;
    border: 1px solid #d1d5db !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
}

[data-theme="light"] .monaco-editor .find-widget .monaco-inputbox {
    background: #f9fafb !important;
    border: 1px solid #d1d5db !important;
}

[data-theme="light"] .monaco-editor .find-widget .monaco-inputbox input {
    color: #1f2937 !important;
    background: transparent !important;
}

/* Paréntesis coincidentes */
[data-theme="light"] #monaco-editor-container .monaco-editor .bracket-match {
    background: rgba(37, 99, 235, 0.1) !important;
    border: 1px solid rgba(37, 99, 235, 0.3) !important;
}

/* Indentación */
[data-theme="light"] #monaco-editor-container .monaco-editor .lines-content .cigr {
    background: #e5e7eb !important;
}

/* Whitespace (espacios visibles) */
[data-theme="light"] #monaco-editor-container .monaco-editor .mtk22 {
    color: #d1d5db !important;
}

/* ========================================
   TEMA CLARO - MENÚ CONTEXTUAL (CLIC DERECHO)
   ======================================== */

/* === CONTEXT MENU === */
[data-theme="light"] .context-menu {
    background: #ffffff !important;
    backdrop-filter: blur(20px) !important;
    border: 1px solid #d1d5db !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
}

[data-theme="light"] .context-menu::before {
    background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.05), transparent) !important;
}

/* Items del menú contextual */
[data-theme="light"] .contextual-menu-item,
[data-theme="light"] .context-menu > div {
    color: #1f2937 !important;
    background: transparent !important;
}

[data-theme="light"] .contextual-menu-item:hover,
[data-theme="light"] .context-menu > div:hover {
    background: #f3f4f6 !important;
    color: #2563eb !important;
}

/* Iconos del menú contextual */
[data-theme="light"] .contextual-menu-item i,
[data-theme="light"] .context-menu > div i {
    color: #2563eb !important;
}

/* Items peligrosos (eliminar) */
[data-theme="light"] .contextual-menu-item.danger,
[data-theme="light"] .context-menu > div:last-child {
    color: #dc2626 !important;
}

[data-theme="light"] .contextual-menu-item.danger:hover,
[data-theme="light"] .context-menu > div:last-child:hover {
    background: rgba(220, 38, 38, 0.1) !important;
    color: #dc2626 !important;
}

[data-theme="light"] .contextual-menu-item.danger i,
[data-theme="light"] .context-menu > div:last-child i {
    color: #dc2626 !important;
}

/* Separadores del menú */
[data-theme="light"] .context-menu-separator {
    background: #e5e7eb !important;
    height: 1px !important;
    margin: 4px 0 !important;
}

/* === MENU CONTEXTUAL ESPECÍFICO (showContextMenu) === */
[data-theme="light"] .contextual-menu {
    background: #ffffff !important;
    border: 1px solid #d1d5db !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
}

/* Estilos inline del menú que se genera dinámicamente */
[data-theme="light"] body > div[style*="position: fixed"][style*="background: #2d2d30"] {
    background: #ffffff !important;
    border: 1px solid #d1d5db !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
}

/* Items generados dinámicamente */
[data-theme="light"] body > div[style*="position: fixed"] > div[style*="padding: 8px 14px"] {
    color: #1f2937 !important;
}

[data-theme="light"] body > div[style*="position: fixed"] > div[style*="padding: 8px 14px"]:hover {
    background: #f3f4f6 !important;
    color: #2563eb !important;
}

/* Separadores generados dinámicamente */
[data-theme="light"] body > div[style*="position: fixed"] > div[style*="height: 1px"] {
    background: #e5e7eb !important;
}

/* === MENÚ DROPDOWN GENERAL === */
[data-theme="light"] .dropdown-menu,
[data-theme="light"] .context-menu-dropdown {
    background: #ffffff !important;
    border: 1px solid #d1d5db !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
}

[data-theme="light"] .dropdown-item,
[data-theme="light"] .context-menu-item {
    color: #1f2937 !important;
}

[data-theme="light"] .dropdown-item:hover,
[data-theme="light"] .context-menu-item:hover {
    background: #f3f4f6 !important;
    color: #2563eb !important;
}

/* === USER DROPDOWN === */
[data-theme="light"] .user-dropdown {
    background: #ffffff !important;
    border: 1px solid #d1d5db !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
}

[data-theme="light"] .user-dropdown-item {
    color: #1f2937 !important;
}

[data-theme="light"] .user-dropdown-item:hover {
    background: #f3f4f6 !important;
    color: #2563eb !important;
}

[data-theme="light"] .user-dropdown-item.logout {
    color: #dc2626 !important;
}

[data-theme="light"] .user-dropdown-item.logout:hover {
    background: rgba(220, 38, 38, 0.1) !important;
    color: #dc2626 !important;
}

[data-theme="light"] .user-dropdown hr {
    border-top: 1px solid #e5e7eb !important;
}




/* ========================================
   TEMA CLARO - NÚMEROS DE LÍNEA Y GUTTER DE MONACO
   ======================================== */

/* === MONACO EDITOR GUTTER (números de línea) === */
[data-theme="light"] #monaco-editor-container .monaco-editor {
    background: #ffffff !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .margin {
    background: #f9fafb !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .margin-view-overlays {
    background: #f9fafb !important;
}

/* Números de línea */
[data-theme="light"] #monaco-editor-container .monaco-editor .line-numbers {
    color: #9ca3af !important;
}

[data-theme="light"] #monaco-editor-container .monaco-editor .line-numbers.active-line-number {
    color: #1f2937 !important;
    font-weight: 600 !important;
}

/* ========================================
   TEMA CLARO - MODAL DE UTILIDADES COMPLETO
   ======================================== */

/* PANEL PRINCIPAL */
[data-theme="light"] .utilities-panel {
    background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%) !important;
}

/* SIDEBAR */
[data-theme="light"] .utilities-sidebar {
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 249, 250, 0.98) 100%) !important;
    border-right: 1px solid #d1d5db !important;
}

[data-theme="light"] .utilities-sidebar::after {
    background: linear-gradient(180deg,
        transparent,
        rgba(37, 99, 235, 0.3),
        transparent) !important;
}

[data-theme="light"] .utilities-sidebar-header {
    background: linear-gradient(180deg, 
        rgba(37, 99, 235, 0.05) 0%, 
        transparent 100%) !important;
    border-bottom: 1px solid #e5e7eb !important;
}

[data-theme="light"] .utilities-sidebar-header h2 {
    color: #2563eb !important;
    text-shadow: 0 2px 10px rgba(37, 99, 235, 0.2) !important;
}

/* NAVEGACIÓN */
[data-theme="light"] .utilities-nav-item {
    color: #6b7280 !important;
}

[data-theme="light"] .utilities-nav-item:hover {
    background: linear-gradient(90deg, 
        rgba(37, 99, 235, 0.1) 0%, 
        rgba(37, 99, 235, 0.05) 100%) !important;
    color: #2563eb !important;
}

[data-theme="light"] .utilities-nav-item.active {
    background: linear-gradient(90deg, 
        rgba(37, 99, 235, 0.15) 0%, 
        rgba(37, 99, 235, 0.08) 100%) !important;
    color: #2563eb !important;
}

[data-theme="light"] .utilities-nav-item::before {
    background: linear-gradient(180deg, #2563eb, #3b82f6) !important;
}

/* FOOTER */
[data-theme="light"] .utilities-sidebar-footer {
    background: linear-gradient(180deg, 
        transparent 0%, 
        rgba(37, 99, 235, 0.03) 100%) !important;
    border-top: 1px solid #e5e7eb !important;
}

[data-theme="light"] .close-utilities-panel {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
}

/* CONTENIDO PRINCIPAL */
[data-theme="light"] .utilities-main-content {
    background: #ffffff !important;
}

/* HEADER DE SECCIÓN */
[data-theme="light"] .utilities-section-header {
    border-bottom: 2px solid #e5e7eb !important;
}

[data-theme="light"] .utilities-section-header::after {
    background: linear-gradient(90deg, #2563eb, #3b82f6) !important;
}

[data-theme="light"] .utilities-section-header h3 {
    color: #1f2937 !important;
}

[data-theme="light"] .add-new-btn {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
}

/* BÚSQUEDA */
[data-theme="light"] .utilities-search input {
    background: #f9fafb !important;
    border: 1px solid #d1d5db !important;
    color: #1f2937 !important;
}

[data-theme="light"] .utilities-search input:focus {
    background: #ffffff !important;
    border-color: #2563eb !important;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1) !important;
}

[data-theme="light"] .utilities-search i {
    color: #6b7280 !important;
}

/* FILTROS */
[data-theme="light"] .filter-chip {
    background: #f3f4f6 !important;
    border: 1px solid #d1d5db !important;
    color: #6b7280 !important;
}

[data-theme="light"] .filter-chip:hover {
    background: #e5e7eb !important;
}

[data-theme="light"] .filter-chip.active {
    background: linear-gradient(45deg, #2563eb, #3b82f6) !important;
    border-color: transparent !important;
    color: white !important;
}

/* CARDS DE UTILIDADES */
[data-theme="light"] .utility-card {
    background: #ffffff !important;
    border: 1px solid #e5e7eb !important;
}

[data-theme="light"] .utility-card:hover {
    background: #f9fafb !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
    border-color: rgba(37, 99, 235, 0.3) !important;
}

[data-theme="light"] .utility-card h4 {
    color: #1f2937 !important;
}

[data-theme="light"] .utility-card p {
    color: #6b7280 !important;
}

[data-theme="light"] .utility-badge {
    background: rgba(37, 99, 235, 0.1) !important;
    color: #2563eb !important;
}

/* CÓDIGO PREVIEW */
[data-theme="light"] .utility-code-preview {
    background: #f3f4f6 !important;
    border: 1px solid #e5e7eb !important;
}

[data-theme="light"] .utility-code-preview code {
    color: #1f2937 !important;
}

/* BOTONES DE ACCIÓN */
[data-theme="light"] .btn-copy {
    background: rgba(34, 197, 94, 0.1) !important;
    color: #16a34a !important;
    border: 1px solid rgba(34, 197, 94, 0.2) !important;
}

[data-theme="light"] .btn-copy:hover {
    background: rgba(34, 197, 94, 0.2) !important;
}

[data-theme="light"] .btn-download {
    background: rgba(59, 130, 246, 0.1) !important;
    color: #2563eb !important;
    border: 1px solid rgba(59, 130, 246, 0.2) !important;
}

[data-theme="light"] .btn-download:hover {
    background: rgba(59, 130, 246, 0.2) !important;
}

[data-theme="light"] .btn-delete {
    background: rgba(239, 68, 68, 0.1) !important;
    color: #dc2626 !important;
    border: 1px solid rgba(239, 68, 68, 0.2) !important;
}

[data-theme="light"] .btn-delete:hover {
    background: rgba(239, 68, 68, 0.2) !important;
}

/* MODALES */
[data-theme="light"] .add-utility-modal-overlay {
    background: rgba(0, 0, 0, 0.4) !important;
}

[data-theme="light"] .add-utility-modal {
    background: #ffffff !important;
    border: 1px solid #d1d5db !important;
}

[data-theme="light"] .add-utility-header {
    background: #f9fafb !important;
    border-bottom: 1px solid #e5e7eb !important;
}

[data-theme="light"] .add-utility-header h3 {
    color: #2563eb !important;
}

[data-theme="light"] .add-utility-header button {
    color: #6b7280 !important;
}

[data-theme="light"] .add-utility-header button:hover {
    color: #1f2937 !important;
}

[data-theme="light"] .form-group label {
    color: #1f2937 !important;
}

[data-theme="light"] .form-group input,
[data-theme="light"] .form-group select,
[data-theme="light"] .form-group textarea {
    background: #f9fafb !important;
    border: 1px solid #d1d5db !important;
    color: #1f2937 !important;
}

[data-theme="light"] .form-group input:focus,
[data-theme="light"] .form-group select:focus,
[data-theme="light"] .form-group textarea:focus {
    background: #ffffff !important;
    border-color: #2563eb !important;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1) !important;
}

[data-theme="light"] .form-group small {
    color: #6b7280 !important;
}

[data-theme="light"] .btn-cancel {
    background: #f3f4f6 !important;
    color: #6b7280 !important;
    border: 1px solid #d1d5db !important;
}

[data-theme="light"] .btn-cancel:hover {
    background: #e5e7eb !important;
}

[data-theme="light"] .btn-save {
    background: linear-gradient(45deg, #2563eb, #3b82f6) !important;
}

/* DISEÑOS - RENDERIZADO */
[data-theme="light"] .design-render-box {
    background: 
        linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
        linear-gradient(-45deg, #f3f4f6 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #f3f4f6 75%),
        linear-gradient(-45deg, transparent 75%, #f3f4f6 75%) !important;
    background-size: 20px 20px !important;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px !important;
    background-color: #ffffff !important;
}

[data-theme="light"] .split-render {
    background: 
        linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
        linear-gradient(-45deg, #f3f4f6 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #f3f4f6 75%),
        linear-gradient(-45deg, transparent 75%, #f3f4f6 75%) !important;
    background-size: 20px 20px !important;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px !important;
    background-color: #ffffff !important;
}

/* CÓDIGO DE DISEÑOS */
[data-theme="light"] .split-code {
    background: #f9fafb !important;
}

[data-theme="light"] .code-tabs-header {
    background: #f3f4f6 !important;
    border-bottom: 1px solid #d1d5db !important;
}

[data-theme="light"] .code-tab {
    color: #6b7280 !important;
}

[data-theme="light"] .code-tab:hover {
    background: #e5e7eb !important;
    color: #2563eb !important;
}

[data-theme="light"] .code-tab.active {
    color: #2563eb !important;
    background: #ffffff !important;
    border-bottom-color: #2563eb !important;
}

[data-theme="light"] .code-content-area {
    background: #ffffff !important;
}

[data-theme="light"] .code-content-area::-webkit-scrollbar-track {
    background: #f3f4f6 !important;
}

[data-theme="light"] .code-content-area::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #2563eb, #3b82f6) !important;
}

[data-theme="light"] .btn-copy-inline {
    background: rgba(34, 197, 94, 0.1) !important;
    border: 1px solid rgba(34, 197, 94, 0.2) !important;
    color: #16a34a !important;
}

[data-theme="light"] .btn-copy-inline:hover {
    background: rgba(34, 197, 94, 0.2) !important;
}

[data-theme="light"] .btn-get-code-corner {
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid #d1d5db !important;
    color: #2563eb !important;
}

[data-theme="light"] .btn-get-code-corner:hover {
    background: #ffffff !important;
    border-color: #2563eb !important;
}

[data-theme="light"] .btn-go-back-corner {
    background: #f3f4f6 !important;
    border: 1px solid #d1d5db !important;
    color: #6b7280 !important;
}

[data-theme="light"] .btn-go-back-corner:hover {
    background: #e5e7eb !important;
    color: #2563eb !important;
    border-color: #2563eb !important;
}

[data-theme="light"] .btn-delete-header {
    background: rgba(239, 68, 68, 0.1) !important;
    border: 1px solid rgba(239, 68, 68, 0.2) !important;
    color: #dc2626 !important;
}

[data-theme="light"] .btn-delete-header:hover {
    background: rgba(239, 68, 68, 0.2) !important;
}


/* ================================
   OPTIMIZACIÓN MODAL UTILIDADES - MÁS COMPACTO
================================ */

/* SIDEBAR MÁS DELGADO */
.utilities-sidebar {
    width: 220px !important;
    padding: 16px 10px !important;
}

.utilities-sidebar-header {
    padding: 20px 16px !important;
    margin-bottom: 16px !important;
}

.utilities-sidebar-header h2 {
    font-size: 20px !important;
}

/* NAVEGACIÓN MÁS COMPACTA */
.utilities-nav {
    padding: 16px 8px !important;
}

.utilities-nav-item {
    padding: 10px 14px !important;
    margin-bottom: 6px !important;
    font-size: 13px !important;
}

.utilities-nav-item i {
    font-size: 15px !important;
}

/* FOOTER MÁS PEQUEÑO */
.utilities-sidebar-footer {
    padding: 16px !important;
}

.close-utilities-panel {
    padding: 10px !important;
    font-size: 13px !important;
}

/* CONTENIDO PRINCIPAL MÁS COMPACTO */
.utilities-main-content {
    padding: 24px !important;
}

/* HEADER DE SECCIÓN */
.utilities-section-header {
    margin-bottom: 20px !important;
    padding-bottom: 14px !important;
}

.utilities-section-header h3 {
    font-size: 22px !important;
}

.add-new-btn {
    padding: 9px 18px !important;
    font-size: 13px !important;
}

/* BÚSQUEDA MÁS PEQUEÑA */
.utilities-search {
    margin-bottom: 16px !important;
}

.utilities-search input {
    padding: 10px 10px 10px 38px !important;
    font-size: 13px !important;
}

/* FILTROS MÁS COMPACTOS */
.utilities-filters {
    gap: 8px !important;
    margin-bottom: 18px !important;
}

.filter-chip {
    padding: 6px 12px !important;
    font-size: 12px !important;
}

/* GRID MÁS COMPACTO */
.utilities-grid {
    gap: 12px !important;
}

/* CARDS MÁS PEQUEÑAS */
.utility-card {
    padding: 14px !important;
    border-radius: 10px !important;
}

.utility-card-header {
    margin-bottom: 8px !important;
}

.utility-card h4 {
    font-size: 14px !important;
    margin-bottom: 2px !important;
}

.utility-card h4 + small {
    font-size: 11px !important;
}

.utility-card p {
    font-size: 12px !important;
    margin-bottom: 8px !important;
    line-height: 1.4 !important;
}

.utility-badge {
    padding: 3px 8px !important;
    font-size: 10px !important;
}

/* CÓDIGO PREVIEW - SOLUCIÓN PARA URLs LARGAS */
.utility-code-preview {
    padding: 10px !important;
    margin-bottom: 10px !important;
    max-height: 80px !important;
    overflow-y: auto !important;
}

.utility-code-preview code {
    font-size: 11px !important;
    line-height: 1.4 !important;
    word-break: break-all !important;
    white-space: pre-wrap !important;
    display: block !important;
}

/* BOTONES DE ACCIÓN MÁS PEQUEÑOS */
.utility-actions {
    gap: 6px !important;
}

.btn-copy, .btn-download {
    padding: 7px 10px !important;
    font-size: 11px !important;
    gap: 4px !important;
}

.btn-delete {
    padding: 7px !important;
    width: 32px !important;
    height: 32px !important;
    font-size: 11px !important;
}

/* MODALES MÁS COMPACTOS */
.add-utility-modal {
    padding: 20px !important;
    max-width: 480px !important;
}

.add-utility-header {
    padding: 16px 20px !important;
    margin: -20px -20px 20px -20px !important;
}

.add-utility-header h3 {
    font-size: 18px !important;
    margin-bottom: 0 !important;
}

.add-utility-header button {
    font-size: 24px !important;
}

.add-utility-modal form {
    padding: 0 !important;
}

.form-group {
    margin-bottom: 16px !important;
}

.form-group label {
    margin-bottom: 6px !important;
    font-size: 13px !important;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 10px 12px !important;
    font-size: 13px !important;
}

.form-group small {
    font-size: 11px !important;
    margin-top: 4px !important;
}

.form-actions {
    gap: 10px !important;
    margin-top: 20px !important;
}

.btn-cancel, .btn-save {
    padding: 10px 18px !important;
    font-size: 13px !important;
}

/* DISEÑOS - CARDS MÁS COMPACTAS */
.design-card {
    padding: 14px !important;
}

.design-card-header-fixed {
    margin-bottom: 10px !important;
    padding-bottom: 10px !important;
}

.design-card-header-fixed h4 {
    font-size: 14px !important;
}

.design-render-box {
    padding: 20px !important;
    min-height: 200px !important;
    max-height: 200px !important;
}

.split-render {
    padding: 20px !important;
}

/* BOTONES DE DISEÑO MÁS PEQUEÑOS */
.btn-get-code-corner {
    padding: 8px 14px !important;
    font-size: 12px !important;
    top: 8px !important;
    right: 8px !important;
}

.btn-go-back-corner {
    padding: 8px 14px !important;
    font-size: 12px !important;
    margin-bottom: 12px !important;
}

.btn-delete-header {
    width: 28px !important;
    height: 28px !important;
    font-size: 11px !important;
}

/* CÓDIGO DE DISEÑOS MÁS COMPACTO */
.code-tabs-header {
    padding: 10px 12px !important;
}

.code-tab {
    padding: 6px 12px !important;
    font-size: 12px !important;
    gap: 5px !important;
}

.code-tab i {
    font-size: 11px !important;
}

.btn-copy-inline {
    padding: 6px 12px !important;
    font-size: 11px !important;
    gap: 5px !important;
}

.code-content-area {
    padding: 16px !important;
    min-height: 300px !important;
    max-height: 380px !important;
}

.code-block code {
    font-size: 12px !important;
    line-height: 1.6 !important;
}

/* SCROLLBAR MÁS DELGADO */
.utility-code-preview::-webkit-scrollbar,
.code-content-area::-webkit-scrollbar {
    width: 6px !important;
    height: 6px !important;
}

.utility-code-preview::-webkit-scrollbar-track,
.code-content-area::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05) !important;
}

.utility-code-preview::-webkit-scrollbar-thumb,
.code-content-area::-webkit-scrollbar-thumb {
    background: rgba(74, 158, 255, 0.5) !important;
    border-radius: 3px !important;
}

/* TEMA CLARO - SCROLLBAR */
[data-theme="light"] .utility-code-preview::-webkit-scrollbar-track,
[data-theme="light"] .code-content-area::-webkit-scrollbar-track {
    background: #f3f4f6 !important;
}

[data-theme="light"] .utility-code-preview::-webkit-scrollbar-thumb,
[data-theme="light"] .code-content-area::-webkit-scrollbar-thumb {
    background: #d1d5db !important;
}

/* RESPONSIVE - AJUSTES ADICIONALES */
@media (max-width: 1200px) {
    .utilities-sidebar {
        width: 200px !important;
    }
    
    .utilities-main-content {
        padding: 20px !important;
    }
    
    .utilities-grid {
        grid-template-columns: 1fr !important;
    }
}

@media (max-width: 768px) {
    .utilities-sidebar {
        width: 180px !important;
    }
    
    .utilities-sidebar-header h2 {
        font-size: 18px !important;
    }
    
    .utilities-nav-item {
        font-size: 12px !important;
        padding: 8px 10px !important;
    }
    
    .utility-card {
        padding: 12px !important;
    }
}

/* AUMENTAR HEIGHT DE CARDS DE DISEÑOS */

/* Vista preview (sin expandir) */
.design-render-box {
    padding: 30px !important;
    min-height: 350px !important;  /* Cambia este valor (estaba en 200px) */
    max-height: 350px !important;  /* Cambia este valor (estaba en 200px) */
}

/* ================================
   SCROLLBAR MODAL UTILIDADES
================================ */

/* Scrollbar del contenido principal */
.utilities-main-content::-webkit-scrollbar {
    width: 4px !important;
}

.utilities-main-content::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05) !important;
    border-radius: 0px !important;
}

.utilities-main-content::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #4a9eff, #00d4ff) !important;
    border-radius: 0px !important;
    border: 0px solid rgba(0, 0, 0, 0.2) !important;
}

.utilities-main-content::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #5aa8ff, #20ddff) !important;
}

/* Scrollbar de la sidebar de navegación */
.utilities-nav::-webkit-scrollbar {
    width: 4px !important;
}

.utilities-nav::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05) !important;
    border-radius: 4px !important;
}

.utilities-nav::-webkit-scrollbar-thumb {
    background: rgba(74, 158, 255, 0.6) !important;
    border-radius: 4px !important;
}

.utilities-nav::-webkit-scrollbar-thumb:hover {
    background: rgba(74, 158, 255, 0.8) !important;
}

/* TEMA CLARO - Scrollbars */
[data-theme="light"] .utilities-main-content::-webkit-scrollbar-track {
    background: #f3f4f6 !important;
}

[data-theme="light"] .utilities-main-content::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #2563eb, #3b82f6) !important;
    border: 2px solid #e5e7eb !important;
}

[data-theme="light"] .utilities-main-content::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #1d4ed8, #2563eb) !important;
}

[data-theme="light"] .utilities-nav::-webkit-scrollbar-track {
    background: #f3f4f6 !important;
}

[data-theme="light"] .utilities-nav::-webkit-scrollbar-thumb {
    background: #d1d5db !important;
}

[data-theme="light"] .utilities-nav::-webkit-scrollbar-thumb:hover {
    background: #2563eb !important;
}


        </style>


</head>
<body>


    <aside class="sidebar" id="sidebar">
    <!-- Botón toggle se crea automáticamente con JS -->
    
    <div class="logo">
        <div class="logo-icon">
            <i class="fas fa-brain"></i>
        </div>
        <div class="logo-text">OpenMind AI</div>
    </div>
    
    <nav>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span class="nav-link-text">Inicio</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="discussions.html" class="nav-link">
                    <i class="fas fa-comments"></i>
                    <span class="nav-link-text">Foros</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="code-editor.html" class="nav-link active">
                    <i class="fas fa-code"></i>
                    <span class="nav-link-text">Editor de Código</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="chat-ai.html" class="nav-link">
                    <i class="fas fa-robot"></i>
                    <span class="nav-link-text">MindAssist IA</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="members.html" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span class="nav-link-text">Miembros</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="voice-calls.html" class="nav-link">
                    <i class="fas fa-phone"></i>
                    <span class="nav-link-text">Llamadas</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="settings.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span class="nav-link-text">Configuración</span>
                </a>
            </li>
        </ul>
    </nav>
</aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <!-- Header -->
        <header class="header">
    <div class="header-left">
        <button class="menu-toggle" id="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
        <div>
            <div class="page-title" data-i18n="editor.title">Editor de Código</div>
            <div class="project-name-header" id="project-name-header">Cargando...</div>
        </div>
    </div>
    
    <div class="header-controls">
        <!-- Después del botón de idioma, antes de notificaciones -->
<button class="control-btn" id="utilities-btn" onclick="openUtilitiesPanel()">
    <i class="fas fa-cubes"></i>
    <span>Utilidades</span>
</button>
        <button class="control-btn" onclick="toggleTheme()">
            <i class="fas fa-moon"></i>
            <span data-i18n="common.themeToggle">Cambiar Tema</span>
        </button>
        
        <div class="language-selector">
            <button class="control-btn" onclick="toggleLanguageDropdown()">
                <i class="fas fa-globe"></i>
                <span data-i18n="common.language">Idioma</span>
            </button>
            <div class="language-dropdown" id="languageDropdown">
                <!-- Se genera dinámicamente -->
            </div>
        </div>
             <div class="notifications-container">
    <button class="control-btn notifications-btn" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span class="notification-count" id="notificationCount" style="display: none;">0</span>
    </button>
    <div class="notifications-dropdown" id="notificationsDropdown">
        <div class="notifications-header">
            <h4>Notificaciones</h4>
        </div>
        <div class="notifications-list" id="notificationsList">
            <div class="notification-item loading">
                Cargando...
            </div>
        </div>
    </div>
</div>
        
        <div class="user-menu">
    <div class="user-menu-toggle" onclick="toggleUserMenu()">
        <img class="user-avatar-small" id="headerAvatarImg" src="" alt="Avatar">
        <span id="headerUserName">Cargando...</span>
        <i class="fas fa-chevron-down"></i>
    </div>
    <div class="user-dropdown" id="userDropdown">
         <a href="perfil/profile.html" class="user-dropdown-item">
            <i class="fas fa-user"></i>
            Mi Perfil
        </a>
        <a href="perfil/settings-perfil.html" class="user-dropdown-item">
            <i class="fas fa-cog"></i>
            Configuración
        </a>
        <hr style="margin: 8px 0; border: none; border-top: 1px solid var(--border-color);">
        <div class="user-dropdown-item logout" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            Cerrar Sesión
        </div>
    </div>
</div>
    </div>
</header>


<!-- === MENU SUPERIOR VS CODE === -->
<div class="vscode-menu-bar">
    <div class="menu-item" data-menu="file">
        <span>File</span>
        <div class="menu-dropdown" id="file-menu">
            <div class="menu-dropdown-item" onclick="showNewFileModal()">
                <span>New File</span>
                <span class="menu-shortcut">Ctrl+N</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerFileOpen()">
               <span>Open File</span>
               <span class="menu-shortcut">Ctrl+O</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerFolderUpload()">
                <span>Open Folder...</span>
                <span class="menu-shortcut">Ctrl+K </span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-dropdown-item" onclick="saveCurrentFile()">
                <span>Save</span>
                <span class="menu-shortcut">Ctrl+S</span>
            </div>
            <div class="menu-dropdown-item" onclick="saveAllFiles()">
                <span>Save All</span>
                <span class="menu-shortcut">Ctrl+K S</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-dropdown-item" onclick="closeCurrentFile()">
                <span>Close Editor</span>
                <span class="menu-shortcut">Ctrl+F4</span>
            </div>
            <div class="menu-dropdown-item" onclick="closeAllFiles()">
                <span>Close All Editors</span>
                <span class="menu-shortcut">Ctrl+K Ctrl+W</span>
            </div>
        </div>
    </div>
    
    <div class="menu-item" data-menu="edit">
        <span>Edit</span>
        <div class="menu-dropdown" id="edit-menu">
            <div class="menu-dropdown-item" onclick="triggerUndo()">
                <span>Undo</span>
                <span class="menu-shortcut">Ctrl+Z</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerRedo()">
                <span>Redo</span>
                <span class="menu-shortcut">Ctrl+Y</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-dropdown-item" onclick="triggerCut()">
                <span>Cut</span>
                <span class="menu-shortcut">Ctrl+X</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerCopy()">
                <span>Copy</span>
                <span class="menu-shortcut">Ctrl+C</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerPaste()">
                <span>Paste</span>
                <span class="menu-shortcut">Ctrl+V</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-dropdown-item" onclick="triggerFind()">
                <span>Find</span>
                <span class="menu-shortcut">Ctrl+F</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerReplace()">
                <span>Replace</span>
                <span class="menu-shortcut">Ctrl+H</span>
            </div>
        </div>
    </div>
    
    <div class="menu-item" data-menu="selection">
        <span>Selection</span>
        <div class="menu-dropdown" id="selection-menu">
            <div class="menu-dropdown-item" onclick="triggerSelectAll()">
                <span>Select All</span>
                <span class="menu-shortcut">Ctrl+A</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerExpandSelection()">
                <span>Expand Selection</span>
                <span class="menu-shortcut">Shift+Alt+Right</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerShrinkSelection()">
                <span>Shrink Selection</span>
                <span class="menu-shortcut">Shift+Alt+Left</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-dropdown-item" onclick="triggerCopyLinesUp()">
                <span>Copy Line Up</span>
                <span class="menu-shortcut">Shift+Alt+Up</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerCopyLinesDown()">
                <span>Copy Line Down</span>
                <span class="menu-shortcut">Shift+Alt+Down</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerMoveLinesUp()">
                <span>Move Line Up</span>
                <span class="menu-shortcut">Alt+Up</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerMoveLinesDown()">
                <span>Move Line Down</span>
                <span class="menu-shortcut">Alt+Down</span>
            </div>
        </div>
    </div>
    
    <div class="menu-item" data-menu="view">
        <span>View</span>
        <div class="menu-dropdown" id="view-menu">
            <div class="menu-dropdown-item" onclick="triggerCommandPalette()">
                <span>Command Palette...</span>
                <span class="menu-shortcut">Ctrl+Shift+P</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-dropdown-item" onclick="toggleExplorer()">
                <span>Explorer</span>
                <span class="menu-shortcut">Ctrl+Shift+E</span>
            </div>
            <div class="menu-dropdown-item" onclick="toggleTerminal()" style="display: none;">
                <span>Terminal</span>
                <span class="menu-shortcut">Ctrl+`</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-dropdown-item" onclick="zoomIn()">
                <span>Zoom In</span>
                <span class="menu-shortcut">Ctrl+=</span>
            </div>
            <div class="menu-dropdown-item" onclick="zoomOut()">
                <span>Zoom Out</span>
                <span class="menu-shortcut">Ctrl+-</span>
            </div>
            <div class="menu-dropdown-item" onclick="resetZoom()">
                <span>Reset Zoom</span>
                <span class="menu-shortcut">Ctrl+0</span>
            </div>
        </div>
    </div>
    
    <div class="menu-item" data-menu="go">
        <span>Go</span>
        <div class="menu-dropdown" id="go-menu">
            <div class="menu-dropdown-item" onclick="triggerGoToFile()">
                <span>Go to File...</span>
                <span class="menu-shortcut">Ctrl+P</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerGoToLine()">
                <span>Go to Line...</span>
                <span class="menu-shortcut">Ctrl+G</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerGoToSymbol()">
                <span>Go to Symbol...</span>
                <span class="menu-shortcut">Ctrl+Shift+O</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-dropdown-item" onclick="triggerGoBack()">
                <span>Go Back</span>
                <span class="menu-shortcut">Alt+Left</span>
            </div>
            <div class="menu-dropdown-item" onclick="triggerGoForward()">
                <span>Go Forward</span>
                <span class="menu-shortcut">Alt+Right</span>
            </div>
        </div>
    </div>
    

    
    <div class="menu-item" data-menu="help">
        <span>Help</span>
        <div class="menu-dropdown" id="help-menu">
            <div class="menu-dropdown-item" onclick="showWelcome()">
                <span>Welcome</span>
            </div>
            <div class="menu-dropdown-item" onclick="showKeyboardShortcuts()">
                <span>Keyboard Shortcuts Reference</span>
                <span class="menu-shortcut">Ctrl+K Ctrl+R</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-dropdown-item" onclick="showAbout()">
                <span>About</span>
            </div>
        </div>
    </div>
</div>
        <!-- Code Editor View -->
        <div class="code-editor-container">
            <div class="file-explorer">
               <div class="explorer-header">
    <div class="explorer-title">Archivos</div>
    <div class="explorer-actions" id="repository-level-controls">
        <button class="explorer-action-btn" onclick="triggerFolderUpload()" title="Subir carpeta">
            <i class="fas fa-upload"></i>
        </button>
        <button class="explorer-action-btn" onclick="showNewFileModal()" title="Nuevo archivo">
            <i class="fas fa-plus"></i>
        </button>
        <button class="explorer-action-btn" onclick="showCreateRepositoryModal()" title="Nuevo repositorio">
            <i class="fas fa-code-branch"></i>
        </button>
    </div>
</div>
                <div class="file-tree" id="file-tree">
                    <div style="text-align: center; color: #8892a6; padding: 20px;">
                        Cargando archivos...
                    </div>
                </div>
            </div>
            
            <div class="editor-main">
                <div class="editor-tabs" id="editor-tabs">
        <!-- Tabs dinámicos -->
    </div>
    
    
<div class="editor-breadcrumbs" id="editor-breadcrumbs">
    <div class="breadcrumb-path">
        <div class="breadcrumb-item">
            <i class="fas fa-home"></i>
            <span>Selecciona un archivo</span>
        </div>
    </div>
   
</div>

                
                <div class="editor-workspace">
                    <div class="code-editor">
                        <div class="editor-toolbar">
                            <div class="file-name-display" id="current-file-name">Selecciona un archivo</div>
                            <div class="save-status" id="save-status">
                                <i class="fas fa-save"></i>
                                <span>Guardado</span>
                            </div>
                            <button class="preview-btn" id="preview-btn">
                                <i class="fas fa-eye"></i>
                                Vista Previa
                            </button>
                             <div class="export-tools">
            <div class="export-dropdown">
                <button class="breadcrumb-btn" id="export-dropdown-btn" title="Exportar">
                    <i class="fas fa-download"></i>
                    Exportar
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="export-dropdown-menu" id="export-dropdown-menu">
                    <button class="export-option" id="export-file-btn">
                        <i class="fas fa-file"></i>
                        Exportar Archivo
                    </button>
                    <button class="export-option" id="export-repository-btn">
                        <i class="fas fa-folder-open"></i>
                        Exportar Repositorio (.zip)
                    </button>
                </div>
            </div>
        </div>
                        </div>
                        
                        <div id="monaco-editor-container">
                            <div class="empty-editor">
                                <div>
                                    <i class="fas fa-code"></i>
                                    <h3>Selecciona un archivo para comenzar</h3>
                                    <p>Usa el explorador de archivos para abrir un archivo existente<br>o crea uno nuevo</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

      

<!-- MODAL DE UTILIDADES CON SIDEBAR -->
<div class="utilities-panel-overlay" id="utilities-panel" style="display: none;">
    <div class="utilities-panel">
        <!-- SIDEBAR -->
        <div class="utilities-sidebar">
            <div class="utilities-sidebar-header">
                <h2><i class="fas fa-cubes"></i> Utilidades</h2>
            </div>
            
            <div class="utilities-nav">
                <button class="utilities-nav-item active" onclick="switchUtilitiesSection('libraries')">
                    <i class="fas fa-link"></i>
                    <span>Librerías CDN</span>
                </button>
                <button class="utilities-nav-item" onclick="switchUtilitiesSection('designs')">
                    <i class="fas fa-palette"></i>
                    <span>Diseños</span>
                </button>
            </div>
            
            <div class="utilities-sidebar-footer">
                <button class="close-utilities-panel" onclick="closeUtilitiesPanel()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
        
        <!-- CONTENIDO PRINCIPAL -->
        <div class="utilities-main-content">
            <!-- SECCIÓN LIBRERÍAS -->
            <div id="libraries-section" class="utilities-section active">
                <div class="utilities-section-header">
                    <h3>Librerías CDN</h3>
                    <button class="add-new-btn" onclick="openAddLibraryModal()">
                        <i class="fas fa-plus"></i> Agregar Librería
                    </button>
                </div>
                
                <div class="utilities-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-libraries" placeholder="Buscar librería..." oninput="filterUtilities('libraries')">
                </div>
                
                <div class="utilities-filters">
                    <button class="filter-chip active" data-filter="all" onclick="filterLibrariesByCategory('all')">Todas</button>
                    <button class="filter-chip" data-filter="css" onclick="filterLibrariesByCategory('css')">CSS</button>
                    <button class="filter-chip" data-filter="js" onclick="filterLibrariesByCategory('js')">JavaScript</button>
                    <button class="filter-chip" data-filter="icons" onclick="filterLibrariesByCategory('icons')">Iconos</button>
                    <button class="filter-chip" data-filter="fonts" onclick="filterLibrariesByCategory('fonts')">Fuentes</button>
                </div>
                
                <div id="libraries-grid" class="utilities-grid">
                    <!-- Se llena dinámicamente -->
                </div>
            </div>
            
            <!-- SECCIÓN DISEÑOS -->
            <div id="designs-section" class="utilities-section">
                <div class="utilities-section-header">
                    <h3>Componentes de Diseño</h3>
                    <button class="add-new-btn" onclick="openAddDesignModal()">
                        <i class="fas fa-plus"></i> Agregar Diseño
                    </button>
                </div>
                
                <div class="utilities-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-designs" placeholder="Buscar diseño..." oninput="filterUtilities('designs')">
                </div>
                
                <div class="utilities-filters">
                    <button class="filter-chip active" data-filter="all" onclick="filterDesignsByCategory('all')">Todos</button>
                    <button class="filter-chip" data-filter="buttons" onclick="filterDesignsByCategory('buttons')">Botones</button>
                    <button class="filter-chip" data-filter="cards" onclick="filterDesignsByCategory('cards')">Cards</button>
                    <button class="filter-chip" data-filter="forms" onclick="filterDesignsByCategory('forms')">Formularios</button>
                    <button class="filter-chip" data-filter="navbars" onclick="filterDesignsByCategory('navbars')">Navbars</button>
                    <button class="filter-chip" data-filter="modals" onclick="filterDesignsByCategory('modals')">Modales</button>
                </div>
                
                <div id="designs-grid" class="utilities-grid">
                    <!-- Se llena dinámicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA AGREGAR LIBRERÍA -->
<div class="add-utility-modal-overlay" id="add-library-modal" style="display: none;">
    <div class="add-utility-modal">
        <div class="add-utility-header">
            <h3><i class="fas fa-link"></i> Agregar Nueva Librería</h3>
            <button onclick="closeAddLibraryModal()">×</button>
        </div>
        <form id="add-library-form" onsubmit="saveNewLibrary(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nombre de la librería *</label>
                    <input type="text" id="lib-name" required placeholder="Ej: Bootstrap CSS">
                </div>
                <div class="form-group">
                    <label>Versión</label>
                    <input type="text" id="lib-version" placeholder="Ej: 5.2.3">
                </div>
            </div>
            <div class="form-group">
                <label>Descripción</label>
                <textarea id="lib-description" rows="2" placeholder="Describe brevemente la librería..."></textarea>
            </div>
            <div class="form-group">
                <label>Categoría *</label>
                <select id="lib-category" required>
                    <option value="">Selecciona una categoría</option>
                    <option value="css">CSS</option>
                    <option value="js">JavaScript</option>
                    <option value="icons">Iconos</option>
                    <option value="fonts">Fuentes</option>
                </select>
            </div>
            <div class="form-group">
                <label>Link CDN *</label>
                <textarea id="lib-link" rows="3" required placeholder="Pega aquí el link CDN..."></textarea>
                <small>Pega el link completo del CDN (puede ser CSS o JS)</small>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeAddLibraryModal()">Cancelar</button>
                <button type="submit" class="btn-save">Guardar Librería</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL PARA AGREGAR DISEÑO -->
<div class="add-utility-modal-overlay" id="add-design-modal" style="display: none;">
    <div class="add-utility-modal large">
        <div class="add-utility-header">
            <h3><i class="fas fa-palette"></i> Agregar Nuevo Diseño</h3>
            <button onclick="closeAddDesignModal()">×</button>
        </div>
        <form id="add-design-form" onsubmit="saveNewDesign(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nombre del componente *</label>
                    <input type="text" id="design-name" required placeholder="Ej: Botón Gradiente">
                </div>
                <div class="form-group">
                    <label>Categoría *</label>
                    <select id="design-category" required>
                        <option value="">Selecciona una categoría</option>
                        <option value="buttons">Botones</option>
                        <option value="cards">Cards</option>
                        <option value="forms">Formularios</option>
                        <option value="navbars">Navbars</option>
                        <option value="modals">Modales</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Descripción</label>
                <textarea id="design-description" rows="2" placeholder="Describe el componente..."></textarea>
            </div>
            <div class="form-group">
                <label>Código HTML *</label>
                <textarea id="design-html" rows="6" required placeholder='<div class="mi-componente">...</div>'></textarea>
            </div>
            <div class="form-group">
                <label>Código CSS</label>
                <textarea id="design-css" rows="6" placeholder='.mi-componente { ... }'></textarea>
            </div>
            <div class="form-group">
                <label>Código JavaScript (opcional)</label>
                <textarea id="design-js" rows="4" placeholder='// Código JS si es necesario'></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeAddDesignModal()">Cancelar</button>
                <button type="submit" class="btn-save">Guardar Diseño</button>
            </div>
        </form>
    </div>
</div>



<div class="editor-status-bar">
    <div class="status-left">
        <div class="status-item" id="cursor-position">
            <span>Ln 1, Col 1</span>
        </div>
        <div class="status-item" id="file-encoding">
            <span>UTF-8</span>
        </div>
        <div class="status-item" id="line-ending">
            <span>LF</span>
        </div>
    </div>
    <div class="status-right">
        <div class="status-item" id="editor-language">
            <span>Texto plano</span>
        </div>
        <div class="status-item" id="file-size">
            <span>0 bytes</span>
        </div>
        <div class="status-item" id="selection-info" style="display: none;">
            <span>0 seleccionado</span>
        </div>
    </div>
</div>


    </main>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Input oculto para subir carpeta -->
    <input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;">

    <!-- Modal para nuevo archivo -->
    <!-- Modal para nuevo archivo -->


    <!-- Modal IA Contextual Mejorado -->
<div class="modal-overlay" id="ai-contextual-modal" style="display: none;">
    <div class="modal ai-contextual-modal-content">
        <div class="modal-content">
            <div class="form-group">
                <label>Describe los cambios que quieres hacer:</label>
                <textarea id="ai-contextual-prompt" rows="4" 
                    placeholder="Ej: Optimiza este código, corrige errores, agrega validación, etc."
                    style="
                        width: 100%;
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        color: white;
                        vertical-align: top;
                        display: flex;
                        padding-top: 10px;
                        line-height: 0.3;
                        resize: vertical;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    "></textarea>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="cancel-btn" onclick="cancelAIChanges()">
                 Cancelar
            </button>
            <button class="create-btn" id="generate-contextual-btn">
                 Aplicar Cambios
            </button>
        </div>
    </div>
</div>

    <!-- Menú contextual para selección de código -->
    <div class="contextual-menu" id="contextual-menu" style="display: none;">
        <button class="contextual-menu-item" id="edit-with-ai-btn">
            <i class="fas fa-magic"></i>
            Editar con IA
        </button>
    </div>

    <script src="js/project-session.js"></script>
   <script src="js/noti.js"></script>

<script>



// Funciones de tema e idioma optimizadas

function initializeThemeAndLanguage() {
    document.body.setAttribute('data-theme', currentTheme);
    updateThemeIcon();
    updateLanguageContent();
    generateLanguageDropdown();
    
    if (window.monaco && monacoEditor) {
        monacoEditor.updateOptions({
            theme: currentTheme === 'dark' ? 'vs-dark' : 'vs'
        });
    }
}

function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', currentTheme);
    localStorage.setItem('theme', currentTheme);
    updateThemeIcon();
    
    if (window.monaco && monacoEditor) {
        monacoEditor.updateOptions({
            theme: currentTheme === 'dark' ? 'vs-dark' : 'vs'
        });
    }
}

function updateThemeIcon() {
    const themeIcon = document.querySelector('.control-btn i.fa-moon, .control-btn i.fa-sun');
    if (themeIcon) {
        themeIcon.className = `fas fa-${currentTheme === 'dark' ? 'sun' : 'moon'}`;
    }
}

function generateLanguageDropdown() {
    const dropdown = document.getElementById('languageDropdown');
    if (dropdown) {
        dropdown.innerHTML = Object.entries(supportedLanguages).map(([code, lang]) => 
            `<div class="language-option ${currentLanguage === code ? 'active' : ''}" 
                  onclick="changeLanguage('${code}')">
                ${lang.flag} ${lang.name}
             </div>`
        ).join('');
    }
}

function changeLanguage(lang) {
    if (supportedLanguages[lang]) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);
        updateLanguageContent();
        generateLanguageDropdown();
        
        const dropdown = document.getElementById('languageDropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }
}

function updateLanguageContent() {
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach(element => {
        const key = element.getAttribute('data-i18n');
        const translation = t(key);
        if (translation && translation !== key) {
            element.textContent = translation;
        }
    });
}

function toggleLanguageDropdown() {
    const dropdown = document.getElementById('languageDropdown');
    const button = dropdown?.parentElement?.querySelector('.control-btn');
    
    if (dropdown) {
        dropdown.classList.toggle('show');
        if (dropdown.classList.contains('show') && button) {
            const rect = button.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.style.right = (window.innerWidth - rect.right) + 'px';
        }
    }
}

// Funciones de repositorio optimizadas


function showCreateRepositoryModal() {
    const existingModal = document.querySelector('.unified-modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.className = 'unified-modal-overlay';
    modal.innerHTML = `
        <div class="unified-modal form-modal">
            <div class="unified-modal-header create-type">
                <h3 class="unified-modal-title">
                    <i class="fas fa-code-branch"></i>
                    Crear Nuevo Repositorio
                </h3>
                <button class="unified-close-btn" onclick="this.closest('.unified-modal-overlay').remove()">×</button>
            </div>
            
            <div class="unified-modal-body">
                <div class="unified-form-group">
                    <label class="unified-form-label">Nombre del repositorio:</label>
                    <input type="text" class="unified-form-input" id="repo-name" placeholder="mi-proyecto-web">
                    <small class="unified-form-help">Solo letras, números, guiones y guiones bajos</small>
                </div>
                
                <div class="unified-form-group">
                    <label class="unified-form-label">Descripción (opcional):</label>
                    <input type="text" class="unified-form-input" id="repo-description" placeholder="Descripción del repositorio">
                </div>
            </div>
            
            <div class="unified-modal-actions">
                <button class="unified-btn cancel" onclick="this.closest('.unified-modal-overlay').remove()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="unified-btn primary" onclick="createRepository(); this.closest('.unified-modal-overlay').remove();">
                    <i class="fas fa-plus"></i> Crear
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.getElementById('repo-name').focus();
}



async function createRepository() {
    const name = document.getElementById('repo-name').value.trim();
    const description = document.getElementById('repo-description').value.trim();

    if (!name) {
        showToast('Ingresa un nombre para el repositorio', 'error');
        return;
    }

    try {
        const { data, error } = await supabaseClient
            .from('repositories')
            .insert([{
                name: name,
                description: description,
                project_id: currentProject.id,
                created_by: currentUser.id
            }])
            .select()
            .single();

        if (error) throw error;

        showToast('Repositorio creado correctamente');
        await loadProjectRepositories(currentProject.id);

    } catch (error) {
        console.error('Error creating repository:', error);
        showToast('Error creando el repositorio', 'error');
    }
}

function openRepository(repository) {
    selectedRepository = repository;
    currentViewMode = 'files';
    loadRepositoryFiles(repository.id);
}




function showDeleteRepositoryModal(repository) {
    if (!['owner', 'admin'].includes(currentUserRole)) {
        showToast('No tienes permisos para eliminar repositorios', 'error');
        return;
    }

    const existingModal = document.querySelector('.unified-modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.className = 'unified-modal-overlay';
    modal.innerHTML = `
        <div class="unified-modal confirmation-modal">
            <div class="unified-modal-header danger-type">
                <h3 class="unified-modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Eliminar Repositorio
                </h3>
                <button class="unified-close-btn" onclick="this.closest('.unified-modal-overlay').remove()">×</button>
            </div>
            
            <div class="unified-warning-section">
                <div class="unified-warning-icon">!</div>
                <div class="unified-warning-content">
                    <h3>Acción irreversible</h3>
                    <p>Esta acción eliminará permanentemente todos los archivos y datos del repositorio.</p>
                </div>
            </div>
            
            <div class="unified-modal-body">
                <p class="unified-confirmation-text">
                    Estás a punto de eliminar el repositorio <strong>"${repository.name}"</strong> y todos sus archivos.
                </p>
                
                <div class="unified-form-group">
                    <label class="unified-form-label">
                        Para confirmar, escribe <strong>eliminar</strong> en el campo:
                    </label>
                    <input type="text" class="unified-form-input" id="delete-confirmation" placeholder="eliminar" autocomplete="off">
                </div>
            </div>
            
            <div class="unified-modal-actions">
                <button class="unified-btn cancel" onclick="this.closest('.unified-modal-overlay').remove()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="unified-btn danger" id="confirm-delete-btn" disabled onclick="deleteRepositoryFromModal('${repository.id}')">
                    <i class="fas fa-trash"></i> Eliminar Repositorio
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    const confirmationInput = document.getElementById('delete-confirmation');
    const confirmBtn = document.getElementById('confirm-delete-btn');
    
    confirmationInput.oninput = () => {
        const isValid = confirmationInput.value.toLowerCase().trim() === 'eliminar';
        confirmBtn.disabled = !isValid;
        
        if (isValid) {
            confirmBtn.style.opacity = '1';
            confirmBtn.style.cursor = 'pointer';
        } else {
            confirmBtn.style.opacity = '0.5';
            confirmBtn.style.cursor = 'not-allowed';
        }
    };
    
    confirmationInput.focus();
}


function deleteRepositoryFromModal(repositoryId) {
    const repository = projectRepositories.find(r => r.id === repositoryId);
    if (!repository) {
        showToast('Repositorio no encontrado', 'error');
        return;
    }
    
    const modal = document.querySelector('.unified-modal-overlay');
    modal.remove();
    
    deleteRepository(repository);
}


async function deleteRepository(repository) {
    try {
        showToast('Eliminando repositorio...', 'info');
        
        const { data: repositoryFiles, error: filesError } = await supabaseClient
            .from('project_files')
            .select('id')
            .eq('repository_id', repository.id);
            
        if (filesError) throw filesError;
        
        if (repositoryFiles && repositoryFiles.length > 0) {
            repositoryFiles.forEach(file => {
                const openTab = openTabs.find(tab => tab.id === file.id);
                if (openTab) {
                    closeTab(openTab.id);
                }
            });
            
            const fileIds = repositoryFiles.map(f => f.id);
            const { error: deleteFilesError } = await supabaseClient
                .from('project_files')
                .delete()
                .in('id', fileIds);
                
            if (deleteFilesError) throw deleteFilesError;
        }
        
        const { error: deleteRepoError } = await supabaseClient
            .from('repositories')
            .delete()
            .eq('id', repository.id);
            
        if (deleteRepoError) throw deleteRepoError;
        
        if (selectedRepository && selectedRepository.id === repository.id) {
            currentViewMode = 'repositories';
            selectedRepository = null;
            clearEditor();
        }
        
        await loadProjectRepositories(currentProject.id);
        showToast(`Repositorio "${repository.name}" eliminado correctamente`, 'success');
        
    } catch (error) {
        console.error('Error deleting repository:', error);
        showToast('Error eliminando el repositorio', 'error');
    }
}

// Funciones de creación de archivos simplificadas

function showNewFileModal() {
    if (!['owner', 'admin'].includes(currentUserRole)) {
        showToast('No tienes permisos para crear archivos', 'error');
        return;
    }

    if (!selectedRepository) {
        showToast('Selecciona un repositorio primero para crear archivos', 'error');
        return;
    }

    const existingModal = document.querySelector('.unified-modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }

    // Construir opciones de carpetas
    let folderOptions = '<option value="/">/</option>';
    const folders = projectFiles.filter(f => f.is_folder && f.repository_id === selectedRepository.id);
    folders.forEach(folder => {
        folderOptions += `<option value="${folder.file_path}">${folder.file_path}</option>`;
    });

    const modal = document.createElement('div');
    modal.className = 'unified-modal-overlay';
    modal.innerHTML = `
        <div class="unified-modal form-modal">
            <div class="unified-modal-header create-type">
                <h3 class="unified-modal-title">
                    <i class="fas fa-file-plus"></i>
                    Crear Nuevo Archivo
                </h3>
                <button class="unified-close-btn" onclick="closeNewFileModal()">×</button>
            </div>
            
            <div class="unified-modal-body">
                <div class="unified-form-group">
                    <label class="unified-form-label">Nombre del archivo:</label>
                    <input type="text" class="unified-form-input" id="new-file-name" placeholder="ej: app.py, server.js, style.css">
                    <small class="unified-form-help">Puedes usar cualquier extensión (.py, .java, .cpp, .rb, .go, .php, etc.)</small>
                </div>
                
                <div class="unified-form-group">
                    <label class="unified-form-label">Carpeta destino:</label>
                    <select class="unified-form-select" id="new-file-folder">
                        ${folderOptions}
                    </select>
                </div>
                
                <div class="unified-form-group">
                    <label class="unified-form-checkbox-wrapper">
                        <input type="checkbox" class="unified-form-checkbox" id="is-folder-checkbox">
                        Es una carpeta
                    </label>
                </div>
            </div>
            
            <div class="unified-modal-actions">
                <button class="unified-btn cancel" onclick="closeNewFileModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="unified-btn success" onclick="createNewFile()">
                    <i class="fas fa-plus"></i> Crear
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    setTimeout(() => {
        document.getElementById('new-file-name').focus();
    }, 100);
}



function closeNewFileModal() {
    const modal = document.querySelector('.unified-modal-overlay');
    if (modal) modal.remove();
}


async function createNewFile() {
    const nameInput = document.getElementById('new-file-name');
    const folderSelect = document.getElementById('new-file-folder');
    const checkboxInput = document.getElementById('is-folder-checkbox');
    
    if (!nameInput || !folderSelect || !checkboxInput) {
        console.error('Elementos del formulario no encontrados');
        showToast('Error en el formulario', 'error');
        return;
    }
    
    const fileName = nameInput.value.trim();
    const parentPath = folderSelect.value;
    const isFolder = checkboxInput.checked;

    if (!fileName) {
        showToast('Ingresa un nombre para el archivo', 'error');
        return;
    }

    if (!selectedRepository) {
        showToast('Debes estar dentro de un repositorio para crear archivos', 'error');
        return;
    }

    if (!/^[\w\-. ]+$/.test(fileName)) {
        showToast('El nombre solo puede contener letras, números, espacios, puntos y guiones', 'error');
        return;
    }

    let fileType = 'txt';
    if (!isFolder && fileName.includes('.')) {
        fileType = fileName.split('.').pop().toLowerCase();
    } else if (isFolder) {
        fileType = 'folder';
    }

    const fullPath = parentPath === '/' ? `/${fileName}` : `${parentPath}/${fileName}`;

    const existingFile = projectFiles.find(f => f.file_path === fullPath);
    if (existingFile) {
        showToast('Ya existe un archivo con ese nombre en esa ubicación', 'error');
        return;
    }

    try {
        const { data, error } = await supabaseClient
            .from('project_files')
            .insert([{
                project_id: currentProject.id,
                repository_id: selectedRepository.id,
                file_name: fileName,
                file_path: fullPath,
                file_type: fileType,
                content: getDefaultContent(fileType),
                is_folder: isFolder,
                created_by: currentUser.id
            }])
            .select()
            .single();

        if (error) throw error;

        showToast(`${isFolder ? 'Carpeta' : 'Archivo'} creado correctamente`);
        closeNewFileModal();
        
        await loadRepositoryFiles(selectedRepository.id);
        
        if (!isFolder) {
            openFile(data);
        }

    } catch (error) {
        console.error('Error creating file:', error);
        showToast('Error creando el archivo: ' + error.message, 'error');
    }
}

// Función para abrir archivo individual con todos los tipos soportados
function triggerFileOpen() {
    const extensions = [
        // Web Technologies
        '.html', '.htm', '.xhtml', '.css', '.scss', '.sass', '.less', '.js', '.jsx', '.mjs', '.ts', '.tsx', '.vue', '.svelte', '.astro',
        // Backend Languages
        '.py', '.pyw', '.java', '.class', '.jsp', '.php', '.php3', '.php4', '.php5', '.php7', '.phtml', '.rb', '.rbw', '.gem', '.rake',
        '.go', '.rs', '.swift', '.kt', '.kts', '.scala', '.sc', '.dart', '.lua', '.perl', '.pl', '.pm',
        // System Programming
        '.c', '.h', '.cpp', '.cxx', '.cc', '.hpp', '.hxx', '.cs', '.vb', '.fs', '.fsx', '.fsi',
        // Functional Languages
        '.hs', '.lhs', '.elm', '.ml', '.mli', '.clj', '.cljs', '.cljc', '.erl', '.hrl', '.ex', '.exs',
        // Scripting
        '.sh', '.bash', '.zsh', '.fish', '.ps1', '.psm1', '.bat', '.cmd',
        // Data & Config
        '.json', '.jsonc', '.json5', '.xml', '.xsl', '.xsd', '.yml', '.yaml', '.toml', '.ini', '.cfg', '.conf', '.properties',
        // Databases
        '.sql', '.mysql', '.pgsql', '.plsql', '.tsql',
        // Markup & Documentation
        '.md', '.markdown', '.mdown', '.mkd', '.rst', '.tex', '.latex', '.org',
        // Mobile Development
        '.m', '.mm', '.gradle', '.groovy', '.gvy',
        // Other Languages
        '.r', '.R', '.rmd', '.matlab', '.jl', '.nim', '.nims', '.cr', '.zig', '.v', '.sol',
        // Templates
        '.hbs', '.handlebars', '.mustache', '.twig', '.liquid', '.ejs', '.pug', '.jade',
        // Docker & DevOps
        '.dockerfile', '.dockerignore', '.vagrantfile', '.makefile', '.make',
        // Version Control
        '.gitignore', '.gitattributes', '.gitmodules', '.hgignore',
        // Package Managers
        '.package', '.composer', '.bower', '.yarn', '.lock',
        // Assembly
        '.asm', '.s', '.nasm',
        // Text files
        '.txt', '.log', '.readme'
    ];
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = extensions.join(',');
    input.onchange = handleSingleFileUpload;
    input.click();
    closeAllMenus();
}

async function handleSingleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!selectedRepository) {
        showToast('Selecciona un repositorio primero para abrir archivos', 'error');
        return;
    }
    
    try {
        showToast('Subiendo archivo...', 'info');
        
        const content = await readFileContent(file);
        const fileType = getFileTypeFromName(file.name);
        const fullPath = `/${file.name}`;
        
        // Verificar si ya existe
        const existingFile = projectFiles.find(f => f.file_path === fullPath);
        if (existingFile) {
            showToast('Ya existe un archivo con ese nombre', 'error');
            return;
        }
        
        const { data, error } = await supabaseClient
            .from('project_files')
            .insert([{
                project_id: currentProject.id,
                repository_id: selectedRepository.id,
                file_name: file.name,
                file_path: fullPath,
                file_type: fileType,
                content: content,
                is_folder: false,
                created_by: currentUser.id
            }])
            .select()
            .single();
            
        if (error) throw error;
        
        showToast('Archivo abierto correctamente');
        await loadRepositoryFiles(selectedRepository.id);
        
        // Abrir el archivo automáticamente
        if (data) {
            openFile(data);
        }
        
    } catch (error) {
        console.error('Error opening file:', error);
        showToast('Error abriendo archivo: ' + error.message, 'error');
    }
    
    // Limpiar el input
    event.target.value = '';
}



function getDefaultContent(fileType) {
    const templates = {
        'html': `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Hola Mundo</h1>
</body>
</html>`,
        'css': `/* Estilos CSS */
body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
}`,
        'js': `// JavaScript
console.log('Hola Mundo');`,
        'py': `# Python
print("Hola Mundo")`,
        'java': `public class Main {
    public static void main(String[] args) {
        System.out.println("Hola Mundo");
    }
}`,
        'cpp': `#include <iostream>
using namespace std;

int main() {
    cout << "Hola Mundo" << endl;
    return 0;
}`,
        'c': `#include <stdio.h>

int main() {
    printf("Hola Mundo\\n");
    return 0;
}`,
        'cs': `using System;

class Program {
    static void Main() {
        Console.WriteLine("Hola Mundo");
    }
}`,
        'go': `package main

import "fmt"

func main() {
    fmt.Println("Hola Mundo")
}`,
        'rs': `fn main() {
    println!("Hola Mundo");
}`,
        'php': `<?php
echo "Hola Mundo";
?>`,
        'rb': `# Ruby
puts "Hola Mundo"`,
        'swift': `import Foundation

print("Hola Mundo")`,
        'kt': `fun main() {
    println("Hola Mundo")
}`,
        'dart': `void main() {
    print('Hola Mundo');
}`,
        'r': `# R
print("Hola Mundo")`,
        'sql': `-- SQL
SELECT 'Hola Mundo' AS mensaje;`,
        'sh': `#!/bin/bash
echo "Hola Mundo"`,
        'json': `{
    "mensaje": "Hola Mundo",
    "version": "1.0.0"
}`,
        'yml': `# YAML
mensaje: "Hola Mundo"
version: "1.0.0"`,
        'md': `# Mi Archivo

## Descripción
Este es un archivo de documentación.`,
        'dockerfile': `FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3000
CMD ["npm", "start"]`,
        'txt': 'Archivo de texto'
    };

    return templates[fileType] || `// Archivo ${fileType}
// Contenido inicial`;
}
// Funciones auxiliares de utilidad

function triggerFolderUpload() {
    if (!['owner', 'admin'].includes(currentUserRole)) {
        showToast('No tienes permisos para subir carpetas', 'error');
        return;
    }
    
    const folderInput = document.getElementById('folder-input');
    if (folderInput) {
        folderInput.click();
    }
}

async function openPreviewInNewTab() {
    if (!activeTab || !['html', 'css', 'js'].includes(activeTab.type)) {
        showToast('Solo HTML, CSS y JS', 'error');
        return;
    }

    const content = monacoEditor ? monacoEditor.getValue() : activeTab.content;
    
    if (!content || !content.trim()) {
        showToast('Archivo vacío', 'error');
        return;
    }

    try {
        showToast('Generando preview...', 'info');
        
        const response = await fetch(`${PREVIEW_BACKEND_URL}/api/preview`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                content: content,
                type: activeTab.type,
                filename: activeTab.name
            })
        });

        if (response.ok) {
            const html = await response.text();
            const win = window.open('', '_blank', 'width=1200,height=800');
            if (win) {
                win.document.write(html);
                win.document.close();
                showToast('Preview abierto', 'success');
            } else {
                showToast('Permite ventanas emergentes', 'error');
            }
        } else {
            throw new Error('Error del servidor');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error conectando con servidor', 'error');
    }
}

async function exportCurrentFile() {
    if (!activeTab || !monacoEditor) {
        showToast('Abre un archivo para exportar', 'error');
        return;
    }
    
    try {
        const currentContent = monacoEditor.getValue();
        if (!currentContent.trim()) {
            showToast('El archivo está vacío', 'error');
            return;
        }
        
        const blob = new Blob([currentContent], { 
            type: getContentType(activeTab.type)
        });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = activeTab.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(`${activeTab.name} exportado correctamente`, 'success');
        
    } catch (error) {
        console.error('Error exporting file:', error);
        showToast('Error exportando archivo', 'error');
    }
}

async function exportCurrentRepository() {
    if (!selectedRepository) {
        showToast('Debes estar dentro de un repositorio para exportarlo', 'error');
        return;
    }
    
    try {
        showToast('Preparando exportación del repositorio...', 'info');
        
        const { data: repositoryFiles, error } = await supabaseClient
            .from('project_files')
            .select('*')
            .eq('repository_id', selectedRepository.id)
            .eq('is_folder', false);
            
        if (error) throw error;
        
        if (!repositoryFiles || repositoryFiles.length === 0) {
            showToast('El repositorio está vacío', 'error');
            return;
        }
        
        const JSZip = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm');
        const zip = new JSZip.default();
        
        repositoryFiles.forEach(file => {
            const filePath = file.file_path.startsWith('/') ? file.file_path.substring(1) : file.file_path;
            zip.file(filePath, file.content || '');
        });
        
        const content = await zip.generateAsync({ type: 'blob' });
        
        const url = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${selectedRepository.name}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(`Repositorio "${selectedRepository.name}" exportado correctamente`, 'success');
        
    } catch (error) {
        console.error('Error exporting repository:', error);
        showToast('Error exportando repositorio', 'error');
    }
}

function getContentType(fileType) {
    const contentTypes = {
        'html': 'text/html',
        'css': 'text/css',
        'js': 'text/javascript',
        'json': 'application/json',
        'py': 'text/x-python',
        'java': 'text/x-java-source',
        'md': 'text/markdown',
        'txt': 'text/plain'
    };
    
    return contentTypes[fileType] || 'text/plain';
}

// Funciones de manejo de eventos y UI

async function handleLogout() {
    try {
        stopPeriodicSync();
        
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        window.location.href = 'login.html';
    } catch (error) {
        console.error('Error logging out:', error);
        showToast('Error al cerrar sesión', 'error');
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('main-content');
    
    if (sidebar && mainContent) {
        sidebar.classList.toggle('hidden');
        mainContent.classList.toggle('expanded');
    }
}

function redirectToHome(reason) {
    console.log('Redirecting to home:', reason);
    showToast(reason, 'error');
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 1000);
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

function initializeSidebar() {
    addTooltipsToNavLinks();
    setupSidebarHover();
}

function addTooltipsToNavLinks() {
    const navLinks = document.querySelectorAll('.nav-link');
    const tooltips = {
        'dashboard.html': 'Inicio',
        'discussions.html': 'Foros', 
        'code-editor.html': 'Editor de Código',
        'chat-ai.html': 'MindAssist IA',
        'members.html': 'Miembros',
        'voice-calls.html': 'Llamadas',
        'settings.html': 'Configuración'
    };
    
    navLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (tooltips[href]) {
            link.setAttribute('data-tooltip', tooltips[href]);
        } else {
            const textElement = link.querySelector('.nav-link-text');
            if (textElement) {
                const text = textElement.textContent.trim();
                link.setAttribute('data-tooltip', text);
            }
        }
    });
}

function setupSidebarHover() {
    const sidebar = document.getElementById('sidebar');
    
    if (!sidebar) return;
    
    sidebar.addEventListener('mouseenter', () => {
        setTimeout(() => {
            if (monacoEditor) {
                monacoEditor.layout();
            }
        }, 300);
    });
    
    sidebar.addEventListener('mouseleave', () => {
        setTimeout(() => {
            if (monacoEditor) {
                monacoEditor.layout();
            }
        }, 300);
    });
}

function toggleSidebarMobile() {
    const sidebar = document.getElementById('sidebar');
    
    if (window.innerWidth <= 768) {
        sidebar.classList.toggle('show');
    }
}

function setupMenuToggle() {
    const menuToggle = document.getElementById('menu-toggle');
    if (menuToggle) {
        menuToggle.addEventListener('click', toggleSidebarMobile);
    }
}

function toggleUserMenu() {
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
}

async function updateUserHeader() {
    if (!currentUser) {
        console.log('currentUser no disponible aún');
        return;
    }
    
    try {
        const { data: profile } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();

        const userName = profile?.full_name || 
                        currentUser.user_metadata?.full_name || 
                        currentUser.user_metadata?.name || 
                        currentUser.email.split('@')[0];
        
        const headerUserName = document.getElementById('headerUserName');
        if (headerUserName) {
            headerUserName.textContent = userName;
        }

        const avatarImg = document.getElementById('headerAvatarImg');
        if (avatarImg) {
            const initials = userName.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase();
            
            if (profile?.avatar_url && profile.avatar_url.trim() !== '') {
                avatarImg.src = profile.avatar_url;
                avatarImg.style.display = 'block';
                
                avatarImg.onerror = () => {
                    setInitialsAvatar(avatarImg, userName, initials);
                };
            } else {
                setInitialsAvatar(avatarImg, userName, initials);
            }
        }

    } catch (error) {
        console.error('Error updating user header:', error);
        
        const userName = currentUser.email.split('@')[0];
        const headerUserName = document.getElementById('headerUserName');
        const avatarImg = document.getElementById('headerAvatarImg');
        
        if (headerUserName) headerUserName.textContent = userName;
        if (avatarImg) {
            const initials = userName.substring(0, 2).toUpperCase();
            setInitialsAvatar(avatarImg, userName, initials);
        }
    }
}

function setInitialsAvatar(avatarElement, userName, initials) {
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=4a9eff&color=ffffff&size=128&rounded=true&bold=true`;
    
    avatarElement.src = avatarUrl;
    avatarElement.style.display = 'block';
    
    avatarElement.onerror = () => {
        createCSSAvatar(avatarElement, initials);
    };
}

function createCSSAvatar(avatarElement, initials) {
    avatarElement.style.display = 'none';
    
    let cssAvatar = avatarElement.parentNode.querySelector('.css-avatar');
    
    if (!cssAvatar) {
        cssAvatar = document.createElement('div');
        cssAvatar.className = 'css-avatar';
        avatarElement.parentNode.insertBefore(cssAvatar, avatarElement);
    }
    
    cssAvatar.textContent = initials;
    cssAvatar.style.cssText = `
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4a9eff, #00d4ff);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 11px;
        border: 2px solid #4a9eff;
        flex-shrink: 0;
        font-family: inherit;
    `;
}

// Event listeners optimizados

document.addEventListener('click', function(event) {
    const languageSelector = document.querySelector('.language-selector');
    const dropdown = document.getElementById('languageDropdown');
    
    if (dropdown && languageSelector && !languageSelector.contains(event.target)) {
        dropdown.classList.remove('show');
    }
    
    const userMenu = document.querySelector('.user-menu');
    const userDropdown = document.getElementById('userDropdown');
    
    if (userDropdown && userMenu && !userMenu.contains(event.target)) {
        userDropdown.classList.remove('show');
    }
});

window.addEventListener('beforeunload', async () => {
    stopPeriodicSync();
    
    if (realTimeCollab) {
        await cleanupRealTime();
    }
});

window.addEventListener('focus', () => {
    if (activeTab) {
        startPeriodicSync();
    }
});

// Funciones globales requeridas



// 8. HACER FUNCIONES GLOBALES
window.showContextMenu = showContextMenu;
window.showRenameModal = showRenameModal;
window.renameFile = renameFile;
window.showMoveFileModal = showMoveFileModal;
window.moveFile = moveFile;
window.duplicateFile = duplicateFile;
window.showNewFileModalInFolder = showNewFileModalInFolder;
window.showNewFolderModalInFolder = showNewFolderModalInFolder;
window.deleteFile = deleteFile;


window.updateUserHeader = updateUserHeader;
window.toggleUserMenu = toggleUserMenu;
window.backToRepositories = backToRepositories;
window.closeContextualAIModal = closeContextualAIModal;
window.showDeleteRepositoryModal = showDeleteRepositoryModal;
window.showCreateRepositoryModal = showCreateRepositoryModal;
window.createRepository = createRepository;
window.closeTab = closeTab;
window.closeNewFileModal = closeNewFileModal;
window.createNewFile = createNewFile;
window.resetModalToInitialState = resetModalToInitialState;
window.toggleTheme = toggleTheme;
window.toggleLanguageDropdown = toggleLanguageDropdown;
window.changeLanguage = changeLanguage;
window.cancelAIChanges = cancelAIChanges;
window.confirmAIChanges = confirmAIChanges;
window.initializeRealTimeForFile = initializeRealTimeForFile;
window.cleanupRealTime = cleanupRealTime;
window.cancelUpload = cancelUpload;




// Agregar estilos CSS para las animaciones de colaboración
const styleSheet = document.createElement('style');
styleSheet.textContent = `
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    .collaborator-cursor {
        position: relative;
    }
    
    .collaborator-selection {
        position: relative;
    }
`;
document.head.appendChild(styleSheet);
// Sistema de depuración optimizado
window.debugRealTime = {
    diagnose: async () => {
        console.log('=== DIAGNÓSTICO DE TIEMPO REAL ===');
        
        try {
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('id')
                .eq('id', currentUser.id)
                .single();
                
            console.log('✓ Conexión a Supabase OK');
        } catch (error) {
            console.error('✗ Error de conexión:', error);
        }
        
        if (realTimeCollab) {
            console.log('✓ Sistema de tiempo real inicializado');
            console.log('- Archivo activo:', realTimeCollab.activeFile);
            console.log('- Colaboradores:', realTimeCollab.collaborators.size);
            console.log('- Conectado:', realTimeCollab.isConnected);
        } else {
            console.log('✗ Sistema de tiempo real no inicializado');
        }
        
        console.log('=== FIN DIAGNÓSTICO ===');
    },
    
    status: () => {
        console.log('Estado del tiempo real:', {
            initialized: !!realTimeCollab,
            activeFile: activeTab?.id,
            collaborators: realTimeCollab?.collaborators?.size || 0,
            connected: realTimeCollab?.isConnected
        });
    },
    
    restart: async () => {
        if (realTimeCollab) {
            await cleanupRealTime();
        }
        if (activeTab && currentUser) {
            const userName = currentUser.user_metadata?.full_name || 
                            currentUser.user_metadata?.name || 
                            currentUser.email.split('@')[0];
            await initializeRealTimeForFile(activeTab.id, currentUser.id, userName);
        }
        console.log('Sistema de tiempo real reiniciado');
    }
};


// Función mejorada de inicialización que incluye validación
async function initializeUserProfile() {
    try {
        // Validar que la tabla existe
        const tableExists = await validateProfilesTable();
        if (!tableExists) {
            throw new Error('Tabla profiles no disponible');
        }

        // Asegurar que el perfil existe
        const profile = await ensureUserProfile();
        
        // Actualizar header con datos del perfil
        if (profile) {
            await updateUserHeader();
        }
        
        return profile;
        
    } catch (error) {
        console.error('Error initializing user profile:', error);
        showToast('Error inicializando perfil de usuario', 'error');
        throw error;
    }
}

// Funciones auxiliares para menús contextuales (simplificadas)

function showContextMenu(event, file) {
    const existingMenu = document.querySelector('.context-menu');
    if (existingMenu) {
        existingMenu.remove();
    }

    if (!['owner', 'admin'].includes(currentUserRole)) {
        return;
    }

    const menu = document.createElement('div');
    menu.className = 'context-menu';
    menu.style.cssText = `
        position: fixed;
        top: ${event.clientY}px;
        left: ${event.clientX}px;
        background: #2d2d30;
        backdrop-filter: blur(20px);
        border: 1px solid #464647;
    
        padding: 4px 0;
        z-index: 1000;
        min-width: 180px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        font-size: 13px;
    `;

    let menuItems = [];
    
    if (file.is_folder) {
        menuItems = [
            {
                text: 'Nuevo Archivo',
                icon: 'fa-file-plus',
                action: () => showNewFileModalInFolder(file)
            },
            {
                text: 'Nueva Carpeta',
                icon: 'fa-folder-plus',
                action: () => showNewFolderModalInFolder(file)
            },
            { type: 'separator' },
            {
                text: 'Renombrar',
                icon: 'fa-edit',
                action: () => showRenameModal(file)
            },
            { type: 'separator' },
            {
                text: 'Eliminar',
                icon: 'fa-trash',
                action: () => deleteFile(file),
                danger: true
            }
        ];
    } else {
        menuItems = [
            {
                text: 'Abrir',
                icon: 'fa-external-link-alt',
                action: () => openFile(file)
            },
            { type: 'separator' },
            {
                text: 'Renombrar',
                icon: 'fa-edit',
                action: () => showRenameModal(file)
            },
            {
                text: 'Mover',
                icon: 'fa-arrows-alt',
                action: () => showMoveFileModal(file)
            },
            { type: 'separator' },
            {
                text: 'Duplicar',
                icon: 'fa-copy',
                action: () => duplicateFile(file)
            },
            { type: 'separator' },
            {
                text: 'Eliminar',
                icon: 'fa-trash',
                action: () => deleteFile(file),
                danger: true
            }
        ];
    }

    menuItems.forEach(item => {
        if (item.type === 'separator') {
            const separator = document.createElement('div');
            separator.style.cssText = `
                height: 1px;
                background: #464647;
              
            `;
            menu.appendChild(separator);
        } else {
            const menuItem = document.createElement('div');
            menuItem.style.cssText = `
                padding: 8px 14px;
                color: ${item.danger ? '#ef4444' : '#ffffff'};
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                transition: all 0.2s ease;
                font-weight: 500;
            `;
            
            menuItem.innerHTML = `
                <i class="fas ${item.icon}" style="
                    width: 12px; 
                    font-size: 12px; 
                    color: ${item.danger ? '#ef4444' : '#4fc1ff'};
                "></i> 
                <span>${item.text}</span>
            `;
            
            menuItem.addEventListener('mouseenter', () => {
                menuItem.style.background = item.danger 
                    ? 'rgba(239, 68, 68, 0.15)' 
                    : 'rgba(74, 158, 255, 0.15)';
            });
            
            menuItem.addEventListener('mouseleave', () => {
                menuItem.style.background = 'transparent';
            });
            
            menuItem.addEventListener('click', () => {
                item.action();
                menu.remove();
            });
            
            menu.appendChild(menuItem);
        }
    });

    document.body.appendChild(menu);
    
    const rect = menu.getBoundingClientRect();
    if (rect.right > window.innerWidth) {
        menu.style.left = (event.clientX - rect.width) + 'px';
    }
    if (rect.bottom > window.innerHeight) {
        menu.style.top = (event.clientY - rect.height) + 'px';
    }

    setTimeout(() => {
        document.addEventListener('click', function removeMenu() {
            if (menu.parentNode) {
                menu.remove();
            }
            document.removeEventListener('click', removeMenu);
        });
    }, 100);
}


function showRenameModal(file) {
    const existingModal = document.querySelector('.unified-modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.className = 'unified-modal-overlay';
    modal.innerHTML = `
        <div class="unified-modal form-modal">
            <div class="unified-modal-header warning-type">
                <h3 class="unified-modal-title">
                    <i class="fas ${file.is_folder ? 'fa-folder' : 'fa-file'}"></i>
                    Renombrar ${file.is_folder ? 'Carpeta' : 'Archivo'}
                </h3>
                <button class="unified-close-btn" onclick="this.closest('.unified-modal-overlay').remove()">×</button>
            </div>
            
            <div class="unified-modal-body">
                <div class="unified-info-box primary">
                    <i class="fas fa-info-circle"></i>
                    <span>Renombrando: <strong>${file.file_name}</strong></span>
                </div>
                
                <div class="unified-form-group">
                    <label class="unified-form-label">Nuevo nombre:</label>
                    <input type="text" class="unified-form-input" id="rename-input" value="${file.file_name}">
                </div>
            </div>
            
            <div class="unified-modal-actions">
                <button class="unified-btn cancel" onclick="this.closest('.unified-modal-overlay').remove()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="unified-btn warning" onclick="renameFileFromModal('${file.id}', '${file.is_folder}')">
                    <i class="fas fa-edit"></i> Renombrar
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    const input = document.getElementById('rename-input');
    // Seleccionar nombre sin extensión
    const dotIndex = file.file_name.lastIndexOf('.');
    if (dotIndex > 0 && !file.is_folder) {
        input.setSelectionRange(0, dotIndex);
    } else {
        input.select();
    }
    input.focus();
    
    // Enter para confirmar
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            renameFileFromModal(file.id, file.is_folder);
        }
    });
}

function renameFileFromModal(fileId, isFolder) {
    const newName = document.getElementById('rename-input').value.trim();
    const file = projectFiles.find(f => f.id === fileId);
    
    if (!file) {
        showToast('Archivo no encontrado', 'error');
        return;
    }
    
    const modal = document.querySelector('.unified-modal-overlay');
    renameFile(file, newName, { remove: () => modal.remove() });
}



async function renameFile(file, newName, modal) {
    if (!newName || newName === file.file_name) {
        modal.remove();
        return;
    }

    if (!/^[\w\-. ]+$/.test(newName)) {
        showToast('El nombre solo puede contener letras, números, espacios, puntos y guiones', 'error');
        return;
    }

    try {
        const pathParts = file.file_path.split('/');
        pathParts[pathParts.length - 1] = newName;
        const newPath = pathParts.join('/');

        const existingFile = projectFiles.find(f => f.file_path === newPath && f.id !== file.id);
        if (existingFile) {
            showToast('Ya existe un archivo con ese nombre', 'error');
            return;
        }

        const { error } = await supabaseClient
            .from('project_files')
            .update({ 
                file_name: newName,
                file_path: newPath
            })
            .eq('id', file.id);

        if (error) throw error;

        const openTab = openTabs.find(tab => tab.id === file.id);
        if (openTab) {
            openTab.name = newName;
            openTab.filePath = newPath;
            renderTabs();
        }

        showToast(`${file.is_folder ? 'Carpeta' : 'Archivo'} renombrado correctamente`);
        modal.remove();
        
        if (selectedRepository) {
            await loadRepositoryFiles(selectedRepository.id);
        }

    } catch (error) {
        console.error('Error renaming file:', error);
        showToast('Error al renombrar: ' + error.message, 'error');
    }
}

// 4. FUNCIÓN PARA MOVER ARCHIVOS
function showMoveFileModal(file) {
    if (file.is_folder) {
        showToast('No se pueden mover carpetas aún', 'error');
        return;
    }

    const existingModal = document.querySelector('.unified-modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }

    // Construir opciones de carpetas
    let folderOptions = '<option value="/">/</option>';
    const folders = projectFiles.filter(f => 
        f.is_folder && 
        f.repository_id === selectedRepository?.id &&
        f.file_path !== file.file_path
    );
    folders.forEach(folder => {
        folderOptions += `<option value="${folder.file_path}">${folder.file_path}</option>`;
    });

    const modal = document.createElement('div');
    modal.className = 'unified-modal-overlay';
    modal.innerHTML = `
        <div class="unified-modal form-modal">
            <div class="unified-modal-header create-type">
                <h3 class="unified-modal-title">
                    <i class="fas fa-arrows-alt"></i>
                    Mover Archivo
                </h3>
                <button class="unified-close-btn" onclick="this.closest('.unified-modal-overlay').remove()">×</button>
            </div>
            
            <div class="unified-modal-body">
                <div class="unified-info-box primary">
                    <i class="fas ${getFileIcon(file.file_type)}"></i>
                    <span><strong>${file.file_name}</strong></span>
                </div>
                
                <div class="unified-form-group">
                    <label class="unified-form-label">Mover a carpeta:</label>
                    <select class="unified-form-select" id="move-folder-select">
                        ${folderOptions}
                    </select>
                </div>
            </div>
            
            <div class="unified-modal-actions">
                <button class="unified-btn cancel" onclick="this.closest('.unified-modal-overlay').remove()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="unified-btn primary" onclick="moveFileFromModal('${file.id}')">
                    <i class="fas fa-arrows-alt"></i> Mover
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function moveFileFromModal(fileId) {
    const targetFolder = document.getElementById('move-folder-select').value;
    const file = projectFiles.find(f => f.id === fileId);
    
    if (!file) {
        showToast('Archivo no encontrado', 'error');
        return;
    }
    
    const modal = document.querySelector('.unified-modal-overlay');
    moveFile(file, targetFolder, { remove: () => modal.remove() });
}


async function moveFile(file, targetFolder, modal) {
    try {
        const newPath = targetFolder === '/' ? `/${file.file_name}` : `${targetFolder}/${file.file_name}`;
        
        const existingFile = projectFiles.find(f => f.file_path === newPath);
        if (existingFile) {
            showToast('Ya existe un archivo con ese nombre en esa carpeta', 'error');
            return;
        }

        const { error } = await supabaseClient
            .from('project_files')
            .update({ file_path: newPath })
            .eq('id', file.id);

        if (error) throw error;

        showToast('Archivo movido correctamente');
        modal.remove();
        
        if (selectedRepository) {
            await loadRepositoryFiles(selectedRepository.id);
        }

    } catch (error) {
        console.error('Error moving file:', error);
        showToast('Error al mover el archivo', 'error');
    }
}


function showNewFileModalInFolder(folder) {
    const folderSelect = document.getElementById('new-file-folder');
    if (folderSelect) {
        folderSelect.innerHTML = '<option value="/">/</option>';
        const folders = projectFiles.filter(f => f.is_folder && f.repository_id === selectedRepository?.id);
        folders.forEach(f => {
            const option = document.createElement('option');
            option.value = f.file_path;
            option.textContent = f.file_path;
            folderSelect.appendChild(option);
        });
        
        folderSelect.value = folder.file_path;
    }
    
    showNewFileModal();
}



function showNewFolderModalInFolder(parentFolder) {
    const existingModal = document.querySelector('.unified-modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.className = 'unified-modal-overlay';
    modal.innerHTML = `
        <div class="unified-modal form-modal">
            <div class="unified-modal-header success-type">
                <h3 class="unified-modal-title">
                    <i class="fas fa-folder-plus"></i>
                    Crear Nueva Carpeta
                </h3>
                <button class="unified-close-btn" onclick="this.closest('.unified-modal-overlay').remove()">×</button>
            </div>
            
            <div class="unified-modal-body">
                <div class="unified-form-group">
                    <label class="unified-form-label">Nombre de la carpeta:</label>
                    <input type="text" class="unified-form-input" id="new-folder-name" placeholder="mi-carpeta">
                </div>
                
                <div class="unified-info-box success">
                    <i class="fas fa-folder"></i>
                    <span>Se creará en: <strong>${parentFolder.file_path}</strong></span>
                </div>
            </div>
            
            <div class="unified-modal-actions">
                <button class="unified-btn cancel" onclick="this.closest('.unified-modal-overlay').remove()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="unified-btn success" onclick="createFolderFromModal('${parentFolder.file_path}')">
                    <i class="fas fa-folder-plus"></i> Crear
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.getElementById('new-folder-name').focus();
}


function createFolderFromModal(parentPath) {
    const folderName = document.getElementById('new-folder-name').value.trim();
    if (!folderName) {
        showToast('Ingresa un nombre para la carpeta', 'error');
        return;
    }

    const newPath = `${parentPath}/${folderName}`;
    
    // Crear carpeta usando la función existente
    createNewFolderAtPath(folderName, newPath);
    
    const modal = document.querySelector('.unified-modal-overlay');
    modal.remove();
}


async function createNewFolderAtPath(folderName, fullPath) {
    try {
        const existingFolder = projectFiles.find(f => f.file_path === fullPath);
        if (existingFolder) {
            showToast('Ya existe una carpeta con ese nombre', 'error');
            return;
        }

        const { error } = await supabaseClient
            .from('project_files')
            .insert([{
                project_id: currentProject.id,
                repository_id: selectedRepository.id,
                file_name: folderName,
                file_path: fullPath,
                file_type: 'folder',
                content: '',
                is_folder: true,
                created_by: currentUser.id
            }]);

        if (error) throw error;

        showToast('Carpeta creada correctamente');
        
        if (selectedRepository) {
            await loadRepositoryFiles(selectedRepository.id);
        }

    } catch (error) {
        console.error('Error creating folder:', error);
        showToast('Error creando la carpeta', 'error');
    }
}


async function deleteFile(file) {
    const isFolder = file.is_folder;
    const confirmText = isFolder 
        ? `¿Eliminar la carpeta "${file.file_name}" y todo su contenido?`
        : `¿Eliminar el archivo "${file.file_name}"?`;
    
    if (!confirm(confirmText)) return;

    try {
        if (isFolder) {
            const childFiles = projectFiles.filter(f => 
                f.file_path.startsWith(file.file_path + '/') || f.file_path === file.file_path
            );
            
            childFiles.forEach(childFile => {
                const openTab = openTabs.find(tab => tab.id === childFile.id);
                if (openTab) {
                    closeTab(openTab.id);
                }
            });
            
            const fileIds = childFiles.map(f => f.id);
            const { error } = await supabaseClient
                .from('project_files')
                .delete()
                .in('id', fileIds);

            if (error) throw error;
            
            showToast(`Carpeta "${file.file_name}" eliminada`);
        } else {
            const openTab = openTabs.find(tab => tab.id === file.id);
            if (openTab) {
                closeTab(openTab.id);
            }
            
            const { error } = await supabaseClient
                .from('project_files')
                .delete()
                .eq('id', file.id);

            if (error) throw error;
            
            showToast(`Archivo "${file.file_name}" eliminado`);
        }

        if (selectedRepository) {
            await loadRepositoryFiles(selectedRepository.id);
        }
        
    } catch (error) {
        console.error('Error deleting file:', error);
        showToast('Error eliminando el archivo', 'error');
    }
}


async function duplicateFile(file) {
    if (file.is_folder) {
        showToast('No se pueden duplicar carpetas', 'error');
        return;
    }

    try {
        const nameWithoutExt = file.file_name.replace(/\.[^/.]+$/, "");
        const extension = file.file_name.includes('.') ? '.' + file.file_name.split('.').pop() : '';
        let copyNumber = 1;
        let newName = `${nameWithoutExt}_copia${extension}`;
        
        while (projectFiles.find(f => f.file_name === newName && f.file_path.startsWith(file.file_path.substring(0, file.file_path.lastIndexOf('/'))))) {
            copyNumber++;
            newName = `${nameWithoutExt}_copia${copyNumber}${extension}`;
        }

        const newPath = file.file_path.substring(0, file.file_path.lastIndexOf('/')) + '/' + newName;

        const { data: originalFile, error: fetchError } = await supabaseClient
            .from('project_files')
            .select('content')
            .eq('id', file.id)
            .single();

        if (fetchError) throw fetchError;

        const { error } = await supabaseClient
            .from('project_files')
            .insert([{
                project_id: currentProject.id,
                repository_id: selectedRepository.id,
                file_name: newName,
                file_path: newPath,
                file_type: file.file_type,
                content: originalFile.content,
                is_folder: false,
                created_by: currentUser.id
            }]);

        if (error) throw error;

        showToast('Archivo duplicado correctamente');
        
        if (selectedRepository) {
            await loadRepositoryFiles(selectedRepository.id);
        }

    } catch (error) {
        console.error('Error duplicating file:', error);
        showToast('Error al duplicar el archivo', 'error');
    }
}

// 6. FUNCIONES AUXILIARES PARA CARPETAS
function showNewFileModalInFolder(folder) {
    const folderSelect = document.getElementById('new-file-folder');
    if (folderSelect) {
        folderSelect.innerHTML = '<option value="/">/</option>';
        const folders = projectFiles.filter(f => f.is_folder && f.repository_id === selectedRepository?.id);
        folders.forEach(f => {
            const option = document.createElement('option');
            option.value = f.file_path;
            option.textContent = f.file_path;
            folderSelect.appendChild(option);
        });
        
        folderSelect.value = folder.file_path;
    }
    
    showNewFileModal();
}
// Mensaje de carga completada
console.log(`
🚀 Editor de Código Optimizado Cargado
=====================================
✅ Sistema de colaboración en tiempo real
✅ Indicadores de carga optimizados  
✅ Barra de progreso para subida de archivos
✅ Rendimiento mejorado
✅ Auto-guardado inteligente

Comandos de debugging disponibles:
- debugRealTime.diagnose()
- debugRealTime.status()
- debugRealTime.restart()

Nuevas características:
- Carga de repositorios con skeleton loading
- Barra de progreso con cancelación para subida
- Renderizado optimizado con animaciones suaves
- Sistema de tiempo real simplificado pero funcional
`);// Configuración de Supabase
const SUPABASE_URL = 'https://jatcscioqvicmiofsuqt.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphdGNzY2lvcXZpY21pb2ZzdXF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2ODUwNDcsImV4cCI6MjA3MjI2MTA0N30.wZ2dXWG7jq7zhzorqKoQYF7I6xz49k2xaFsouQRscGQ';

const PREVIEW_BACKEND_URL = 'https://bakd-pvd8.vercel.app';
const AI_BACKEND_URL = 'https://open-analy.vercel.app';

// Variables globales
let supabaseClient;
let projectRepositories = [];
let currentUser = null;
let currentProject = null;
let currentUserRole = null;
let projectFiles = [];
let openTabs = [];
let activeTab = null;
let saveTimeout = null;
let expandedFolders = new Set();
let currentViewMode = 'repositories';
let selectedRepository = null;
let syncInterval = null;
let lastSyncTime = 0;
let isEditing = false;
let allProjectFiles = [];
let monacoEditor = null;
let monacoInitialized = false;
let originalContent = '';
let isPreviewMode = false;
let previewTimeout = null;
let selectedCodeRange = null;
let selectedCodeText = '';
let currentTheme = localStorage.getItem('theme') || 'dark';
let currentLanguage = localStorage.getItem('language') || 'es';
let realTimeCollab = null;

// Variable para control de subida de archivos
let uploadAbortController = null;

// NUEVO: Agregar estilos CSS para indicadores de carga
const loadingStyles = document.createElement('style');
loadingStyles.textContent = `
/* Indicadores de carga optimizados */
.loading-spinner {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 3px solid rgba(74, 158, 255, 0.3);
    border-radius: 50%;
    border-top-color: #4a9eff;
    animation: spin 0.8s ease-in-out infinite;
}

.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 50px 20px;
    color: #8892a6;
    min-height: 250px;
}

.loading-text {
    margin-top: 15px;
    font-size: 15px;
    color: #4a9eff;
    font-weight: 500;
}

.skeleton-card {
    background: linear-gradient(90deg, 
        rgba(74, 158, 255, 0.05) 25%, 
        rgba(74, 158, 255, 0.15) 50%, 
        rgba(74, 158, 255, 0.05) 75%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.2s ease-in-out infinite;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 12px;
    height: 85px;
    border: 1px solid rgba(74, 158, 255, 0.1);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes skeleton-loading {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.fade-in {
    animation: fadeIn 0.4s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Barra de progreso para subida de archivos */
.upload-progress-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    backdrop-filter: blur(5px);
}

.upload-progress-container {
    background: linear-gradient(135deg, rgba(15, 20, 25, 0.95) 0%, rgba(26, 35, 50, 0.95) 100%);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 16px;
    padding: 40px;
    width: 90%;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.upload-progress-title {
    color: #4a9eff;
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.upload-progress-bar {
    width: 100%;
    height: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    overflow: hidden;
    margin: 20px 0;
    position: relative;
}

.upload-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4a9eff 0%, #00d4ff 100%);
    border-radius: 6px;
    transition: width 0.3s ease;
    position: relative;
    overflow: hidden;
}

.upload-progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: progress-shine 1.5s infinite;
}

@keyframes progress-shine {
    0% { left: -100%; }
    100% { left: 100%; }
}

.upload-progress-text {
    color: #ffffff;
    font-size: 16px;
    margin: 15px 0;
    font-weight: 500;
}

.upload-progress-details {
    color: #8892a6;
    font-size: 14px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.upload-cancel-btn {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid #ef4444;
    color: #ef4444;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    margin-top: 25px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
}

.upload-cancel-btn:hover {
    background: rgba(239, 68, 68, 0.3);
    transform: translateY(-1px);
}

.upload-success {
    color: #22c55e;
    font-size: 18px;
    font-weight: 600;
    margin: 20px 0;
}
`;
document.head.appendChild(loadingStyles);

// Idiomas soportados (optimizado)
const supportedLanguages = {
    'en': { name: 'English', flag: '🇺🇸' },
    'es': { name: 'Español', flag: '🇪🇸' },
    'fr': { name: 'Français', flag: '🇫🇷' },
    'de': { name: 'Deutsch', flag: '🇩🇪' }
};

const translations = {
    es: {
        'common.themeToggle': 'Cambiar Tema',
        'common.language': 'Idioma',
        'common.logout': 'Salir',
        'editor.title': 'Editor de Código'
    },
    en: {
        'common.themeToggle': 'Toggle Theme',
        'common.language': 'Language',
        'common.logout': 'Logout',
        'editor.title': 'Code Editor'
    }
};

// Sistema de colaboración en tiempo real simplificado
class RealTimeCollaboration {
    constructor(supabaseClient, monacoEditor) {
        this.supabase = supabaseClient;
        this.editor = monacoEditor;
        this.currentUser = null;
        this.activeFile = null;
        this.collaborators = new Map();
        this.decorationCollections = new Map();
        this.isConnected = false;
        this.isApplyingRemoteChange = false;
        this.fileChannel = null;
        this.collaborationChannel = null;
        this.SAVE_DELAY = 300;
        this.CURSOR_UPDATE_DELAY = 100;
        this.initializeRealTime();
    }

    async initializeRealTime() {
        try {
            this.setupFileChannel();
            this.setupCollaborationChannel();
            this.setupEditorEvents();
            console.log('Sistema de tiempo real inicializado');
        } catch (error) {
            console.error('Error inicializando tiempo real:', error);
        }
    }

    setupFileChannel() {
        this.fileChannel = this.supabase
            .channel('file_changes')
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'project_files'
            }, (payload) => {
                if (!this.isApplyingRemoteChange) {
                    this.handleFileChange(payload);
                }
            })
            .subscribe((status) => {
                this.isConnected = status === 'SUBSCRIBED';
            });
    }

    setupCollaborationChannel() {
        this.collaborationChannel = this.supabase
            .channel('collaboration')
            .on('broadcast', { event: 'cursor_move' }, (payload) => {
                this.handleCursorUpdate(payload);
            })
            .on('broadcast', { event: 'text_change' }, (payload) => {
                if (payload.payload.userId !== this.currentUser?.id) {
                    this.handleTextChange(payload);
                }
            })
            .subscribe();
    }

    handleFileChange(payload) {
        console.log('File change detected:', payload);
    }

    setupEditorEvents() {
        if (!this.editor) return;

        this.editor.onDidChangeModelContent((e) => {
            if (!this.isApplyingRemoteChange && this.activeFile && this.currentUser) {
                this.handleLocalTextChange(e);
            }
        });

        this.editor.onDidChangeCursorPosition(
            this.debounce((e) => {
                if (this.activeFile) {
                    this.broadcastCursorPosition(e.position);
                }
            }, this.CURSOR_UPDATE_DELAY)
        );
    }

    handleLocalTextChange(changeEvent) {
        const changes = changeEvent.changes;
        
        changes.forEach(change => {
            const operation = {
                type: 'text_change',
                fileId: this.activeFile,
                userId: this.currentUser.id,
                userName: this.currentUser.name,
                range: change.range,
                text: change.text,
                rangeLength: change.rangeLength,
                timestamp: new Date().toISOString(),
                version: Date.now()
            };

            this.collaborationChannel.send({
                type: 'broadcast',
                event: 'text_change',
                payload: operation
            });

            this.debouncedSave();
        });
    }

    handleTextChange(payload) {
        const operation = payload.payload;
        
        try {
            this.isApplyingRemoteChange = true;
            
            const model = this.editor.getModel();
            if (model) {
                model.pushEditOperations([], [{
                    range: operation.range,
                    text: operation.text
                }], () => null);
            }

        } catch (error) {
            console.error('Error aplicando cambio remoto:', error);
        } finally {
            setTimeout(() => {
                this.isApplyingRemoteChange = false;
            }, 10);
        }
    }

    handleCursorUpdate(payload) {
        const data = payload.payload;
        
        if (data.userId === this.currentUser?.id) return;

        this.clearUserDecorations(data.userId);

        this.collaborators.set(data.userId, {
            id: data.userId,
            name: data.userName,
            position: data.position,
            selection: data.selection,
            type: data.type,
            lastUpdate: new Date(),
            color: this.getUserColor(data.userId)
        });

        this.updateCollaboratorIndicators(data.userId);
    }

    clearUserDecorations(userId) {
        const collection = this.decorationCollections.get(userId);
        if (collection) {
            collection.clear();
            this.decorationCollections.delete(userId);
        }
        
        const styleIds = [`cursor-style-${userId}`, `selection-style-${userId}`];
        styleIds.forEach(id => {
            const style = document.getElementById(id);
            if (style) style.remove();
        });
    }

    updateCollaboratorIndicators(userId) {
        const collaborator = this.collaborators.get(userId);
        if (!collaborator) return;

        const decorations = [];

        if (collaborator.position) {
            decorations.push({
                range: new monaco.Range(
                    collaborator.position.lineNumber,
                    collaborator.position.column,
                    collaborator.position.lineNumber,
                    collaborator.position.column
                ),
                options: {
                    className: `collaborator-cursor cursor-${userId}`,
                    stickiness: monaco.editor.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges
                }
            });
        }

        if (decorations.length > 0) {
            const collection = this.editor.createDecorationsCollection(decorations);
            this.decorationCollections.set(userId, collection);
            this.addUserStyles(userId, collaborator.color, collaborator.name);
        }
    }

    addUserStyles(userId, color, userName) {
        const cursorStyleId = `cursor-style-${userId}`;
        let cursorStyle = document.getElementById(cursorStyleId);
        
        if (!cursorStyle) {
            cursorStyle = document.createElement('style');
            cursorStyle.id = cursorStyleId;
            document.head.appendChild(cursorStyle);
        }

        cursorStyle.textContent = `
            .cursor-${userId} {
                border-left: 2px solid ${color} !important;
                position: relative;
            }
            
            .cursor-${userId}::after {
                content: '${userName}';
                position: absolute;
                top: -20px;
                left: 0;
                background: ${color};
                color: white;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 11px;
                white-space: nowrap;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            }
            
            .cursor-${userId}:hover::after {
                opacity: 1;
            }
        `;
    }

    broadcastCursorPosition(position) {
        if (!this.collaborationChannel || !this.currentUser || !this.activeFile) return;
        
        this.collaborationChannel.send({
            type: 'broadcast',
            event: 'cursor_move',
            payload: {
                userId: this.currentUser.id,
                userName: this.currentUser.name,
                fileId: this.activeFile,
                position: position,
                type: 'cursor',
                timestamp: new Date().toISOString()
            }
        });
    }

    async joinFile(fileId, userId, userName) {
        try {
            this.activeFile = fileId;
            this.currentUser = { id: userId, name: userName };
            await this.registerUserActivity(fileId, userId, userName);
            console.log(`Usuario ${userName} se unió al archivo ${fileId}`);
        } catch (error) {
            console.error('Error joining file:', error);
        }
    }

    async leaveFile() {
        if (!this.activeFile || !this.currentUser) return;

        try {
            this.clearAllDecorations();
            this.activeFile = null;
            this.currentUser = null;
        } catch (error) {
            console.error('Error leaving file:', error);
        }
    }

    clearAllDecorations() {
        this.decorationCollections.forEach(collection => {
            collection.clear();
        });
        this.decorationCollections.clear();
        
        this.collaborators.forEach(collaborator => {
            this.clearUserDecorations(collaborator.id);
        });
        this.collaborators.clear();
    }

    async registerUserActivity(fileId, userId, userName) {
        try {
            await this.supabase
                .from('file_activity')
                .upsert({
                    file_id: fileId,
                    user_id: userId,
                    user_name: userName,
                    last_activity: new Date().toISOString()
                }, {
                    onConflict: 'file_id,user_id'
                });
        } catch (error) {
            console.error('Error registering activity:', error);
        }
    }

    debouncedSave = this.debounce(async () => {
        await this.saveToServer();
    }, this.SAVE_DELAY);

    async saveToServer() {
        try {
            if (!this.activeFile || !this.editor) return;

            const content = this.editor.getValue();
            
            const { error } = await this.supabase
                .from('project_files')
                .update({ 
                    content: content,
                    updated_at: new Date().toISOString()
                })
                .eq('id', this.activeFile);

            if (!error) {
                console.log('Archivo guardado en servidor');
            }
            
        } catch (error) {
            console.error('Error guardando en servidor:', error);
        }
    }

    getUserColor(userId) {
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
            '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
        ];
        
        const hash = userId.split('').reduce((a, b) => {
            a = ((a << 5) - a) + b.charCodeAt(0);
            return a & a;
        }, 0);
        
        return colors[Math.abs(hash) % colors.length];
    }

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    destroy() {
        if (this.fileChannel) {
            this.supabase.removeChannel(this.fileChannel);
        }
        if (this.collaborationChannel) {
            this.supabase.removeChannel(this.collaborationChannel);
        }
        this.clearAllDecorations();
    }
}

// Función para obtener traducción
function t(key) {
    return translations[currentLanguage] && translations[currentLanguage][key] 
        ? translations[currentLanguage][key] 
        : translations['es'][key] || key;
}

function ensureProjectId() {
    const urlParams = new URLSearchParams(window.location.search);
    let projectId = urlParams.get('project');
    let code = urlParams.get('code');
    
    if (!projectId) {
        projectId = localStorage.getItem('current_project_id');
        code = localStorage.getItem('current_project_code');
        
        if (projectId) {
            const url = new URL(window.location);
            url.searchParams.set('project', projectId);
            if (code) {
                url.searchParams.set('code', code);
            }
            window.history.replaceState({}, '', url);
        } else {
            console.warn('No se encontró project ID, redirigiendo al dashboard');
            window.location.href = 'dashboard.html';
            return null;
        }
    } else {
        localStorage.setItem('current_project_id', projectId);
        if (code) {
            localStorage.setItem('current_project_code', code);
        }
    }
    
    return projectId;
}

// Inicialización optimizada
document.addEventListener('DOMContentLoaded', function() {
    if (!ensureProjectId()) return;
    
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Cargar en paralelo para mejor rendimiento
    Promise.all([
        setupEventListeners(),
        initializeThemeAndLanguage(),
        setupContextualAI(),
        setupExportDropdown()
    ]).then(() => {
        checkAuthenticationAndLoadData();
    });
});

function setupEventListeners() {
    return new Promise(resolve => {
        const handlers = [
            ['logout-btn', 'click', handleLogout],
            ['menu-toggle', 'click', toggleSidebar],
            ['preview-btn', 'click', openPreviewInNewTab],
            ['new-file-btn', 'click', showNewFileModal],
            ['upload-folder-btn', 'click', triggerFolderUpload],
            ['folder-input', 'change', handleFolderUpload]
        ];

        handlers.forEach(([id, event, handler]) => {
            const element = document.getElementById(id);
            if (element) element.addEventListener(event, handler);
        });

        resolve();
    });
}

function setupContextualAI() {
    const generateBtn = document.getElementById('generate-contextual-btn');
    if (generateBtn) {
        generateBtn.addEventListener('click', generateContextualAI);
    }

    const applyBtn = document.getElementById('apply-contextual-code-btn');
    if (applyBtn) {
        applyBtn.addEventListener('click', applyContextualChanges);
    }
}

function setupExportDropdown() {
    const exportDropdownBtn = document.getElementById('export-dropdown-btn');
    const exportDropdownMenu = document.getElementById('export-dropdown-menu');
    const exportFileBtn = document.getElementById('export-file-btn');
    const exportRepositoryBtn = document.getElementById('export-repository-btn');

    if (exportDropdownBtn) {
        exportDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            exportDropdownMenu.style.display = 
                exportDropdownMenu.style.display === 'block' ? 'none' : 'block';
        });
    }

    if (exportFileBtn) {
        exportFileBtn.addEventListener('click', () => {
            exportCurrentFile();
            exportDropdownMenu.style.display = 'none';
        });
    }

    if (exportRepositoryBtn) {
        exportRepositoryBtn.addEventListener('click', () => {
            exportCurrentRepository();
            exportDropdownMenu.style.display = 'none';
        });
    }

    document.addEventListener('click', () => {
        if (exportDropdownMenu) {
            exportDropdownMenu.style.display = 'none';
        }
    });
}

async function checkAuthenticationAndLoadData() {
    try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error || !session) {
            console.log('No session found, redirecting to login');
            window.location.href = 'login.html';
            return;
        }

        currentUser = session.user;
        
        await updateUserHeader();
        await ensureUserProfile();

        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('project');

        if (!projectId) {
            console.error('No project ID provided');
            redirectToHome('Proyecto no especificado');
            return;
        }

        const hasAccess = await verifyProjectAccess(projectId);
        if (!hasAccess) {
            console.error('User does not have access to this project');
            redirectToHome('No tienes acceso a este proyecto');
            return;
        }
        
        updateUserRoleDisplay();
        await initMonacoEditor();
        await Promise.all([
            loadProjectData(projectId),
            loadProjectRepositories(projectId)
        ]);

        console.log('Code editor loaded successfully');

    } catch (error) {
        console.error('Error in checkAuthenticationAndLoadData:', error);
        redirectToHome('Error cargando el proyecto: ' + error.message);
    }

    initializeSidebar();
    setupMenuToggle();
}

function initMonacoEditor() {
    if (monacoInitialized) return Promise.resolve();
    
    return new Promise((resolve, reject) => {
        require.config({ 
            paths: { 
                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' 
            }
        });
        
        require(['vs/editor/editor.main'], function () {
            const container = document.getElementById('monaco-editor-container');
            if (!container) {
                reject(new Error('Container not found'));
                return;
            }

            try {
                container.innerHTML = '';
                
                monacoEditor = monaco.editor.create(container, {
                    value: '// Selecciona un archivo para comenzar a editar...',
                    language: 'javascript',
                    theme: currentTheme === 'dark' ? 'vs-dark' : 'vs',
                    automaticLayout: true,
                    minimap: { enabled: true },
                    scrollBeyondLastLine: false,
                    fontSize: 14,
                    tabSize: 2,
                    insertSpaces: true,
                    wordWrap: 'on',
                    lineNumbers: 'on',
                    folding: true,
                    renderWhitespace: 'selection',
                    readOnly: true
                });

                monacoEditor.onDidChangeModelContent(() => {
                    if (activeTab && monacoEditor && !monacoEditor.getOption(monaco.editor.EditorOption.readOnly)) {
                        const newContent = monacoEditor.getValue();
                        if (newContent !== activeTab.content) {
                            activeTab.content = newContent;
                            activeTab.modified = true;
                            isEditing = true;
                            renderTabs();
                            updateSaveStatus('saving');
                            debounceAutoSave();
                        }
                    }
                });

                monacoEditor.addAction({
                    id: 'edit-with-ai',
                    label: 'Editar con IA',
                    contextMenuGroupId: 'modification',
                    contextMenuOrder: 1.5,
                    precondition: null,
                    keybindingContext: null,
                    run: function(ed) {
                        const selection = ed.getSelection();
                        if (selection && !selection.isEmpty()) {
                            selectedCodeRange = selection;
                            selectedCodeText = ed.getModel().getValueInRange(selection);
                            openContextualAIModal();
                        } else {
                            showToast('Selecciona código para editar con IA', 'error');
                        }
                    }
                });

                monacoInitialized = true;
                console.log('Monaco Editor inicializado correctamente');
                resolve();
            } catch (error) {
                console.error('Error inicializando Monaco:', error);
                reject(error);
            }
        });
    });
}

// FUNCIONES OPTIMIZADAS PARA CARGA DE REPOSITORIOS

function showRepositoryLoadingState() {
    const fileTree = document.getElementById('file-tree');
    if (!fileTree) return;
    
    fileTree.innerHTML = `
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Cargando repositorios...</div>
        </div>
    `;
}

function showRepositorySkeletonLoading() {
    const fileTree = document.getElementById('file-tree');
    if (!fileTree) return;
    
    fileTree.innerHTML = `
        <div style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #ffffff; font-size: 16px; margin: 0;">
                    <i class="fas fa-code-branch" style="margin-right: 8px; color: #4a9eff;"></i>
                    Repositorios
                </h3>
                <div style="width: 80px; height: 32px; background: rgba(74, 158, 255, 0.1); border-radius: 6px;"></div>
            </div>
            ${Array(3).fill(0).map(() => `<div class="skeleton-card"></div>`).join('')}
        </div>
    `;
}


async function loadProjectRepositories(projectId) {
    const fileTree = document.getElementById('file-tree');
    
    // Mostrar skeleton loading inmediatamente
    showRepositorySkeletonLoading();
    
    try {
        // CORREGIDO: Cargar repositorios correctamente
        const { data: repositories, error: repoError } = await supabaseClient
            .from('repositories')  // ← TABLA CORRECTA
            .select('*')
            .eq('project_id', projectId)
            .order('updated_at', { ascending: false });

        if (repoError) throw repoError;

        // Cargar todos los archivos del proyecto
        const { data: allFiles, error: filesError } = await supabaseClient
            .from('project_files')
            .select('*')
            .eq('project_id', projectId);

        if (filesError) throw filesError;

        // Procesar datos de forma optimizada
        projectRepositories = repositories || [];
        allProjectFiles = allFiles || [];
        
        // Renderizar con animación suave
        await renderRepositoriesWithAnimation();

    } catch (error) {
        console.error('Error loading repositories:', error);
        showRepositoryErrorState();
    }
}

function showRepositoryErrorState() {
    const fileTree = document.getElementById('file-tree');
    if (!fileTree) return;
    
    fileTree.innerHTML = `
        <div style="text-align: center; padding: 50px 20px; color: #ef4444;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px; display: block; opacity: 0.7;"></i>
            <h3 style="margin-bottom: 8px;">Error cargando repositorios</h3>
            <p style="font-size: 14px; margin-bottom: 20px; opacity: 0.8;">No se pudieron cargar los repositorios</p>
            <button onclick="loadProjectRepositories('${currentProject?.id}')" style="
                background: linear-gradient(45deg, #4a9eff, #00d4ff);
                border: none;
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.3s ease;
            ">
                <i class="fas fa-redo"></i> Reintentar
            </button>
        </div>
    `;
}

async function renderRepositoriesWithAnimation() {
    const fileTree = document.getElementById('file-tree');
    fileTree.innerHTML = '';

    // Header optimizado
    const header = createRepositoryHeader();
    fileTree.appendChild(header);

    if (projectRepositories.length === 0) {
        fileTree.appendChild(createEmptyRepositoryState());
        return;
    }

    // Renderizar repositorios con delay escalonado para animación suave
    const cardsContainer = document.createElement('div');
    fileTree.appendChild(cardsContainer);
    
    // Renderizar en lotes pequeños para mejor rendimiento
    const batchSize = 2;
    for (let i = 0; i < projectRepositories.length; i += batchSize) {
        const batch = projectRepositories.slice(i, i + batchSize);
        
        // Crear promesas para cada tarjeta del lote
        const cardPromises = batch.map((repo, batchIndex) => {
            return new Promise(resolve => {
                setTimeout(() => {
                    const card = createOptimizedRepositoryCard(repo);
                    card.classList.add('fade-in');
                    cardsContainer.appendChild(card);
                    resolve();
                }, batchIndex * 150); // Delay escalonado dentro del lote
            });
        });
        
        // Esperar a que se complete el lote actual
        await Promise.all(cardPromises);
        
        // Pausa entre lotes
        if (i + batchSize < projectRepositories.length) {
            await new Promise(resolve => setTimeout(resolve, 100));
        }
    }
}

function createRepositoryHeader() {
    const header = document.createElement('div');
    header.className = 'repository-header';
    
    header.innerHTML = `
        <h3>
            <i class="fas fa-code-branch" style="margin-right: 8px; color: #4a9eff;"></i>
            Repositorios
        </h3>
        <button onclick="showCreateRepositoryModal()">
            <i class="fas fa-plus"></i> Nuevo
        </button>
    `;
    
    return header;
}

function createEmptyRepositoryState() {
    const emptyState = document.createElement('div');
    emptyState.style.cssText = `
        text-align: center;
        padding: 50px 20px;
        color: #8892a6;
    `;
    
    emptyState.innerHTML = `
        <i class="fas fa-code-branch" style="font-size: 4rem; margin-bottom: 20px; display: block; opacity: 0.3; color: #4a9eff;"></i>
        <h3 style="color: #ffffff; margin-bottom: 12px; font-size: 20px;">No hay repositorios</h3>
        <p style="font-size: 15px; margin-bottom: 25px; opacity: 0.8; line-height: 1.4;">Crea tu primer repositorio para organizar tu código</p>
        <button onclick="showCreateRepositoryModal()" style="
            background: linear-gradient(45deg, #4a9eff, #00d4ff);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(74, 158, 255, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(74, 158, 255, 0.4)';"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(74, 158, 255, 0.3)';">
            <i class="fas fa-plus"></i> Crear Repositorio
        </button>
    `;
    
    return emptyState;
}

function createOptimizedRepositoryCard(repository) {
    const card = document.createElement('div');
    card.className = 'repository-card';

    // Calcular archivos de forma más eficiente
    const filesCount = allProjectFiles.filter(f => 
        f.repository_id === repository.id && !f.is_folder
    ).length;

    card.innerHTML = `
        <div>
            <div class="repo-icon">
                <i class="fas fa-code-branch"></i>
            </div>
            <div style="flex: 1; min-width: 0;">
                <h3>${repository.name}</h3>
                <p style="display: none">${repository.description || 'Sin descripción'}</p>
                <div>
                    <span>
                        <i class="fas fa-file"></i> 
                        ${filesCount} archivos
                    </span>
                    <span>
                        <i class="fas fa-clock"></i> 
                        ${new Date(repository.updated_at).toLocaleDateString('es-ES')}
                    </span>
                </div>
            </div>
            <div>
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
        
        <button class="delete-repo-btn" style="
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.8);
            border: none;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
        " title="Eliminar repositorio">
            <i class="fas fa-trash"></i>
        </button>
    `;

    // Event listeners optimizados
    card.addEventListener('mouseenter', () => {
        card.style.transform = 'translateY(-2px)';
        card.style.boxShadow = '0 6px 20px rgba(74, 158, 255, 0.2)';
        card.style.borderColor = 'rgba(74, 158, 255, 0.4)';
        
        const chevron = card.querySelector('.fas.fa-chevron-right').parentElement;
        chevron.style.opacity = '1';
        chevron.style.transform = 'translateX(2px)';
        
        // Mostrar botón eliminar si tiene permisos
        const deleteBtn = card.querySelector('.delete-repo-btn');
        if (deleteBtn && ['owner', 'admin'].includes(currentUserRole)) {
            deleteBtn.style.opacity = '1';
        }
    });

    card.addEventListener('mouseleave', () => {
        card.style.transform = 'translateY(0)';
        card.style.boxShadow = 'none';
        card.style.borderColor = 'rgba(74, 158, 255, 0.15)';
        
        const chevron = card.querySelector('.fas.fa-chevron-right').parentElement;
        chevron.style.opacity = '0.6';
        chevron.style.transform = 'translateX(0)';
        
        // Ocultar botón eliminar
        const deleteBtn = card.querySelector('.delete-repo-btn');
        if (deleteBtn) {
            deleteBtn.style.opacity = '0';
        }
    });

    // Click para abrir repositorio
    card.addEventListener('click', (e) => {
        if (e.target.closest('.delete-repo-btn')) {
            return;
        }
        openRepository(repository);
    });

    // Click para eliminar repositorio
    const deleteBtn = card.querySelector('.delete-repo-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showDeleteRepositoryModal(repository);
        });
    }

    return card;
}

// FUNCIONES OPTIMIZADAS PARA SUBIDA DE ARCHIVOS CON BARRA DE PROGRESO

function createUploadProgressModal() {
    const modal = document.createElement('div');
    modal.className = 'upload-progress-modal';
    modal.id = 'upload-progress-modal';
    
    modal.innerHTML = `
        <div class="upload-progress-container">
            <div class="upload-progress-title">
                <i class="fas fa-cloud-upload-alt"></i>
                Subiendo archivos
            </div>
            
            <div class="upload-progress-bar">
                <div class="upload-progress-fill" id="upload-progress-fill" style="width: 0%;"></div>
            </div>
            
            <div class="upload-progress-text" id="upload-progress-text">
                Preparando subida...
            </div>
            
            <div class="upload-progress-details">
                <span id="upload-current-file">Iniciando...</span>
                <span id="upload-file-count">0 / 0</span>
            </div>
            
            <button class="upload-cancel-btn" id="upload-cancel-btn" onclick="cancelUpload()">
                <i class="fas fa-times"></i>
                Cancelar subida
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    return modal;
}

function updateUploadProgress(completed, total, currentFileName = '', percentage = 0) {
    const progressFill = document.getElementById('upload-progress-fill');
    const progressText = document.getElementById('upload-progress-text');
    const currentFile = document.getElementById('upload-current-file');
    const fileCount = document.getElementById('upload-file-count');
    
    if (progressFill) {
        progressFill.style.width = `${percentage}%`;
    }
    
    if (progressText) {
        if (completed === total) {
            progressText.innerHTML = '<div class="upload-success"><i class="fas fa-check-circle"></i> ¡Subida completada!</div>';
        } else {
            progressText.textContent = `Subiendo archivos... ${Math.round(percentage)}%`;
        }
    }
    
    if (currentFile && currentFileName) {
        // Truncar nombre si es muy largo
        const displayName = currentFileName.length > 40 
            ? currentFileName.substring(0, 37) + '...' 
            : currentFileName;
        currentFile.textContent = `Subiendo: ${displayName}`;
    }
    
    if (fileCount) {
        fileCount.textContent = `${completed} / ${total}`;
    }
}

function removeUploadProgressModal() {
    const modal = document.getElementById('upload-progress-modal');
    if (modal) {
        // Animación de salida
        modal.style.opacity = '0';
        modal.style.transform = 'scale(0.9)';
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

function cancelUpload() {
    if (uploadAbortController) {
        uploadAbortController.abort();
        uploadAbortController = null;
    }
    
    showToast('Subida cancelada', 'info');
    removeUploadProgressModal();
}

async function handleFolderUpload(event) {
    const files = Array.from(event.target.files);
    
    if (files.length === 0) return;
    
    // Verificaciones previas
    if (currentViewMode === 'repositories') {
        showToast('Selecciona un repositorio primero para subir archivos', 'error');
        return;
    }
    
    if (!selectedRepository) {
        showToast('Debes estar dentro de un repositorio para subir carpetas', 'error');
        return;
    }

    // Crear controlador de aborto para cancelación
    uploadAbortController = new AbortController();
    
    // Crear y mostrar modal de progreso
    const progressModal = createUploadProgressModal();
    
    try {
        const progressInfo = { 
            total: files.length, 
            completed: 0,
            errors: 0
        };
        
        updateUploadProgress(0, files.length, 'Iniciando...', 0);

        // Procesar archivos en lotes más pequeños para mejor rendimiento
        const batchSize = 3; // Reducido para mejor control
        
        for (let i = 0; i < files.length; i += batchSize) {
            // Verificar si se canceló la subida
            if (uploadAbortController.signal.aborted) {
                throw new Error('Upload cancelled');
            }
            
            const batch = files.slice(i, i + batchSize);
            
            // Procesar lote en paralelo
            await Promise.allSettled(
                batch.map(file => processUploadedFileWithProgress(file, progressInfo))
            );
            
            // Actualizar progreso
            const percentage = (progressInfo.completed / progressInfo.total) * 100;
            updateUploadProgress(
                progressInfo.completed, 
                progressInfo.total, 
                batch[batch.length - 1]?.name || '', 
                percentage
            );
            
            // Pequeña pausa entre lotes
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        // Mostrar resultado final
        if (progressInfo.errors === 0) {
            updateUploadProgress(
                progressInfo.completed, 
                progressInfo.total, 
                '¡Todos los archivos subidos correctamente!', 
                100
            );
            showToast(`Carpeta subida correctamente (${files.length} archivos)`, 'success');
        } else {
            showToast(`Subida completada con ${progressInfo.errors} errores`, 'warning');
        }
        
        // Recargar archivos
        await loadRepositoryFiles(selectedRepository.id);
        
        // Cerrar modal después de 2 segundos
        setTimeout(() => {
            removeUploadProgressModal();
        }, 2000);

    } catch (error) {
        console.error('Error uploading folder:', error);
        
        if (error.message === 'Upload cancelled') {
            // Ya manejado en cancelUpload()
            return;
        }
        
        showToast('Error subiendo la carpeta', 'error');
        removeUploadProgressModal();
    }

    // Limpiar
    uploadAbortController = null;
    event.target.value = '';
}

async function processUploadedFileWithProgress(file, progressInfo) {
    try {
        // Verificar si se canceló
        if (uploadAbortController?.signal.aborted) {
            throw new Error('Upload cancelled');
        }
        
        const relativePath = file.webkitRelativePath || file.name;
        const fullPath = `/${relativePath}`;
        const fileType = getFileTypeFromName(file.name);
        const content = await readFileContent(file);
        
        const existingFile = projectFiles.find(f => f.file_path === fullPath);
        if (existingFile) {
            console.log(`Archivo ya existe: ${fullPath}`);
            progressInfo.completed++;
            return;
        }

        await ensureParentFolders(fullPath);

        const { error } = await supabaseClient
            .from('project_files')
            .insert([{
                project_id: currentProject.id,
                repository_id: selectedRepository?.id,
                file_name: file.name,
                file_path: fullPath,
                file_type: fileType,
                content: content,
                is_folder: false,
                created_by: currentUser.id
            }]);

        if (error) {
            console.error(`Error subiendo ${file.name}:`, error);
            progressInfo.errors++;
        }

        progressInfo.completed++;

    } catch (error) {
        if (error.message !== 'Upload cancelled') {
            console.error(`Error procesando archivo ${file.name}:`, error);
            progressInfo.errors++;
        }
        progressInfo.completed++;
    }
}

// Funciones de utilidad optimizadas

function openContextualAIModal() {
    if (!selectedCodeText.trim()) {
        showToast('Selecciona código para editar con IA', 'error');
        return;
    }

    originalContent = monacoEditor.getValue();
    isPreviewMode = false;
    
    const prompt = document.getElementById('ai-contextual-prompt');
    if (prompt) {
        prompt.value = '';
    }

    const modal = document.getElementById('ai-contextual-modal');
    if (modal) {
        modal.style.display = 'flex';
        
        setTimeout(() => {
            if (prompt) {
                prompt.focus();
            }
        }, 100);
    }
}

async function generateContextualAI() {
    const prompt = document.getElementById('ai-contextual-prompt');
    const generateBtn = document.getElementById('generate-contextual-btn');

    if (!prompt.value.trim()) {
        showToast('Describe qué cambios quieres hacer', 'error');
        return;
    }

    if (!selectedCodeText.trim()) {
        showToast('No hay código seleccionado', 'error');
        return;
    }

    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    generateBtn.disabled = true;

    try {
        const contextualPrompt = `CÓDIGO A MODIFICAR:
${selectedCodeText}

CAMBIOS SOLICITADOS: ${prompt.value.trim()}

INSTRUCCIONES:
- Modifica ÚNICAMENTE el código seleccionado según los cambios solicitados
- Mantén la funcionalidad existente que no se solicita cambiar
- Devuelve SOLO el código mejorado, sin explicaciones adicionales
- Asegúrate de que el código sea funcional y mantenga el estilo`;

        const requestBody = {
            prompt: contextualPrompt,
            code: selectedCodeText,
            language: activeTab ? activeTab.type : 'javascript',
            action: 'contextual_edit'
        };

        const response = await fetch(`${AI_BACKEND_URL}/api/contextual-edit`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();

        if (data.success && data.response) {
            const improvedCode = cleanGeneratedCode(data.response.trim());
            
            applyPreviewChanges(improvedCode);
            showConfirmationButtons();
            
            showToast('Cambios aplicados en modo preview', 'success');
            
        } else {
            throw new Error(data.error || 'Respuesta inválida de la IA');
        }

    } catch (error) {
        console.error('Error en IA contextual:', error);
        showToast('Error procesando con IA: ' + error.message, 'error');
        
        generateBtn.innerHTML = '<i class="fas fa-magic"></i> Aplicar Cambios';
        generateBtn.disabled = false;
    }
}

function showConfirmationButtons() {
    const modalActions = document.querySelector('#ai-contextual-modal .modal-actions');
    if (modalActions) {
        modalActions.innerHTML = `
            <button class="cancel-btn" onclick="cancelAIChanges()" style="
                background: rgba(239, 68, 68, 0.2);
                border: 1px solid #ef4444;
                color: #ef4444;
            ">
                <i class="fas fa-undo"></i> Cancelar Cambios
            </button>
            <button class="create-btn" onclick="confirmAIChanges()" style="
                background: rgba(34, 197, 94, 0.2);
                border: 1px solid #22c55e;
                color: #22c55e;
            ">
                <i class="fas fa-check"></i> Confirmar Cambios
            </button>
        `;
    }
}

function cancelAIChanges() {
    if (isPreviewMode && originalContent !== '') {
        monacoEditor.setValue(originalContent);
        
        if (activeTab) {
            activeTab.content = originalContent;
            activeTab.modified = false;
            renderTabs();
        }
        
        showToast('Cambios cancelados', 'info');
    }
    
    resetModalToInitialState();
    closeContextualAIModal();
}

function confirmAIChanges() {
    if (isPreviewMode) {
        if (activeTab) {
            activeTab.content = monacoEditor.getValue();
            activeTab.modified = true;
            renderTabs();
        }
        
        showToast('Cambios confirmados y aplicados', 'success');
    }
    
    resetModalToInitialState();
    closeContextualAIModal();
}

function resetModalToInitialState() {
    const modalActions = document.querySelector('#ai-contextual-modal .modal-actions');
    if (modalActions) {
        modalActions.innerHTML = `
            <button class="cancel-btn" onclick="closeContextualAIModal()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="create-btn" id="generate-contextual-btn">
                <i class="fas fa-magic"></i> Aplicar Cambios
            </button>
        `;
        
        const generateBtn = document.getElementById('generate-contextual-btn');
        if (generateBtn) {
            generateBtn.onclick = generateContextualAI;
        }
    }
    
    const prompt = document.getElementById('ai-contextual-prompt');
    if (prompt) {
        prompt.value = '';
    }
}

function applyPreviewChanges(improvedCode) {
    if (!activeTab || !monacoEditor || !selectedCodeRange) {
        return;
    }
    
    const model = monacoEditor.getModel();
    const edit = {
        range: selectedCodeRange,
        text: improvedCode.trim()
    };
    
    model.pushEditOperations([], [edit], () => null);
    isPreviewMode = true;
    
    if (activeTab) {
        activeTab.modified = true;
        renderTabs();
    }
}

function closeContextualAIModal() {
    const modal = document.getElementById('ai-contextual-modal');
    if (modal) modal.style.display = 'none';
    
    isPreviewMode = false;
    originalContent = '';
    selectedCodeRange = null;
    selectedCodeText = '';
    
    if (previewTimeout) {
        clearTimeout(previewTimeout);
        previewTimeout = null;
    }
    
    resetModalToInitialState();
}

// Funciones principales optimizadas

async function verifyProjectAccess(projectId) {
    try {
        const { data: membership, error } = await supabaseClient
            .from('project_members')
            .select('id, role, project_id')
            .eq('project_id', projectId)
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (error && error.code !== 'PGRST116') {
            console.error('Error checking project membership:', error);
            return false;
        }

        if (!membership) {
            console.log('Usuario no es miembro del proyecto');
            return false;
        }

        currentUserRole = membership.role;
        return true;

    } catch (error) {
        console.error('Error in verifyProjectAccess:', error);
        return false;
    }
}

function updateUserRoleDisplay() {
    const userInfo = document.querySelector('.user-info');
    if (userInfo && currentUserRole) {
        let roleIndicator = document.getElementById('role-indicator');
        if (!roleIndicator) {
            roleIndicator = document.createElement('div');
            roleIndicator.id = 'role-indicator';
            roleIndicator.style.cssText = `
                font-size: 11px;
                color: #4a9eff;
                background: rgba(74, 158, 255, 0.1);
                padding: 2px 6px;
                border-radius: 4px;
                margin-left: 8px;
            `;
            userInfo.insertBefore(roleIndicator, userInfo.firstChild);
        }
        roleIndicator.textContent = currentUserRole.toUpperCase();
    }
}

async function loadProjectData(projectId) {
    try {
        const { data: projectData, error } = await supabaseClient
            .from('projects')
            .select('*')
            .eq('id', projectId)
            .single();

        if (error) throw error;

        currentProject = projectData;
        document.getElementById('project-name-header').textContent = projectData.name;

    } catch (error) {
        console.error('Error loading project data:', error);
        redirectToHome('Error cargando datos del proyecto');
    }
}

async function loadRepositoryFiles(repositoryId) {
    try {
        const { data: files, error } = await supabaseClient
            .from('project_files')
            .select('*')
            .eq('repository_id', repositoryId)
            .order('file_path', { ascending: true });

        if (error && error.code !== 'PGRST116') throw error;

        projectFiles = files || [];
        renderRepositoryFiles();
        console.log('Archivos del repositorio cargados:', projectFiles.length);

    } catch (error) {
        console.error('Error loading repository files:', error);
        showToast('Error cargando archivos del repositorio', 'error');
    }
}


function renderRepositoryFiles() {
    const fileTree = document.getElementById('file-tree');
    fileTree.innerHTML = '';
    
    // Agregar clase para identificar que estamos en vista de archivos
    fileTree.parentElement.classList.add('repository-files-view');

    // Header con botón de regreso optimizado
    const header = document.createElement('div');
    header.className = 'repository-open-header';

    header.innerHTML = `
        <div>
            <button onclick="backToRepositories()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h3>${selectedRepository?.name || 'Repositorio'}</h3>
                <p>${projectFiles.length} archivos</p>
            </div>
        </div>
       
    `;
    
    fileTree.appendChild(header);

    if (projectFiles.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-repository-state';
        emptyState.innerHTML = `
            <i class="fas fa-folder-open"></i>
            <h3>Repositorio vacío</h3>
            <p>Sube archivos o crea nuevos para comenzar</p>
        `;
        fileTree.appendChild(emptyState);
        return;
    }

    const tree = buildFileTree(projectFiles);
    renderFileTreeNode(tree, fileTree, 0);
}

function backToRepositories() {
    currentViewMode = 'repositories';
    selectedRepository = null;
    
    // Remover clase de vista de archivos
    const fileTree = document.getElementById('file-tree');
    if (fileTree && fileTree.parentElement) {
        fileTree.parentElement.classList.remove('repository-files-view');
    }
    
    renderRepositories();

}


function moveControlsToRepositoryLevel() {
    const repositoryControls = document.getElementById('repository-level-controls');
    if (repositoryControls && currentViewMode === 'repositories') {
        repositoryControls.innerHTML = `
            <button class="new-file-btn" onclick="triggerFolderUpload()" title="Subir carpeta" style="background: rgba(74, 158, 255, 0.2); border: none; color: #4a9eff; padding: 8px 10px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-upload"></i>
            </button>
        `;
    } else if (repositoryControls) {
        repositoryControls.innerHTML = '';
    }
}

function renderFileTree() {
    const fileTree = document.getElementById('file-tree');
    if (!fileTree) return;
    
    if (currentViewMode === 'repositories') {
        renderRepositories();
        moveControlsToRepositoryLevel();
    } else {
        renderRepositoryFiles();
    }
}

function renderRepositories() {
    const fileTree = document.getElementById('file-tree');
    fileTree.innerHTML = '';

    const header = createRepositoryHeader();
    fileTree.appendChild(header);

    if (projectRepositories.length === 0) {
        fileTree.appendChild(createEmptyRepositoryState());
        return;
    }

    // Renderizar repositorios directamente sin delay para mejor rendimiento
    projectRepositories.forEach(repo => {
        const card = createOptimizedRepositoryCard(repo);
        card.classList.add('fade-in');
        fileTree.appendChild(card);
    });
}

// Funciones de archivos optimizadas

function buildFileTree(files) {
    const tree = { children: {}, files: [] };
    
    files.forEach(file => {
        const pathParts = file.file_path.split('/').filter(part => part.length > 0);
        let currentNode = tree;
        
        for (let i = 0; i < pathParts.length - 1; i++) {
            const part = pathParts[i];
            if (!currentNode.children[part]) {
                currentNode.children[part] = { children: {}, files: [] };
            }
            currentNode = currentNode.children[part];
        }
        
        if (file.is_folder) {
            const folderName = pathParts[pathParts.length - 1];
            if (!currentNode.children[folderName]) {
                currentNode.children[folderName] = { children: {}, files: [], folderData: file };
            }
        } else {
            currentNode.files.push(file);
        }
    });
    
    return tree;
}



function renderFileTreeNode(node, container, depth) {
    // Renderizar carpetas primero
    Object.keys(node.children).sort().forEach(folderName => {
        const folderNode = node.children[folderName];
        const folderPath = folderNode.folderData ? folderNode.folderData.file_path : `/${folderName}`;
        const isExpanded = expandedFolders.has(folderPath);
        
        const folderElement = document.createElement('div');
        folderElement.className = 'file-item folder-item';
        folderElement.style.paddingLeft = `${depth * 12 + 8}px`;
        
        const hasContent = Object.keys(folderNode.children).length > 0 || folderNode.files.length > 0;
        
        folderElement.innerHTML = `
            <i class="fas ${hasContent ? (isExpanded ? 'fa-chevron-down' : 'fa-chevron-right') : ''}" 
               style="width: 12px; margin-right: 4px; font-size: 10px;"></i>
            <i class="fas fa-folder${isExpanded ? '-open' : ''}"></i>
            <span>${folderName}</span>
        `;
        
        if (hasContent) {
            folderElement.style.cursor = 'pointer';
            folderElement.addEventListener('click', (e) => {
                if (e.button === 0) {
                    e.stopPropagation();
                    toggleFolder(folderPath, folderElement);
                }
            });
        }
        
        if (folderNode.folderData && ['owner', 'admin'].includes(currentUserRole)) {
            folderElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showContextMenu(e, folderNode.folderData);
            });
        }
        
        container.appendChild(folderElement);
        
        const folderContent = document.createElement('div');
        folderContent.className = 'folder-content';
        folderContent.style.display = isExpanded ? 'block' : 'none';
        
        if (isExpanded) {
            renderFileTreeNode(folderNode, folderContent, depth + 1);
        }
        
        container.appendChild(folderContent);
    });
    
    // Renderizar archivos después
    node.files.sort((a, b) => a.file_name.localeCompare(b.file_name)).forEach(file => {
        const fileElement = createFileElement(file, depth);
        container.appendChild(fileElement);
    });
}

function applyDesignImprovements() {
    // Agregar clases necesarias
    const fileExplorer = document.querySelector('.file-explorer');
    if (fileExplorer) {
        fileExplorer.classList.add('improved-explorer');
    }
    
    // Ocultar header de archivos por defecto
    const explorerHeader = document.querySelector('.explorer-header');
    if (explorerHeader && currentViewMode === 'repositories') {
        explorerHeader.style.display = '';
    }
}

// Ejecutar mejoras al cargar
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(applyDesignImprovements, 100);
});

// También ejecutar cuando cambie el modo de vista
const originalOpenRepository = openRepository;
openRepository = function(repository) {
    originalOpenRepository.call(this, repository);
    setTimeout(applyDesignImprovements, 100);
};

const originalBackToRepositories = backToRepositories;
backToRepositories = function() {
    originalBackToRepositories.call(this);
    setTimeout(applyDesignImprovements, 100);
};

function toggleFolder(folderPath, folderElement) {
    const isExpanded = expandedFolders.has(folderPath);
    
    if (isExpanded) {
        expandedFolders.delete(folderPath);
    } else {
        expandedFolders.add(folderPath);
    }
    
    renderFileTree();
}

function createFileElement(file, depth = 0) {
    const div = document.createElement('div');
    div.className = 'file-item';
    div.style.paddingLeft = `${depth * 12 + 8}px`;
    div.dataset.fileId = file.id;
    div.dataset.filePath = file.file_path;

    const icon = getFileIcon(file.file_type);
    
    div.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${file.file_name}</span>
    `;

    div.addEventListener('click', (e) => {
        if (e.button === 0) {
            openFile(file);
        }
    });
    
    div.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (['owner', 'admin'].includes(currentUserRole)) {
            showContextMenu(e, file);
        }
    });
    
    return div;
}
function getFileIcon(fileType) {
    const icons = {
        // Web Technologies
        'html': 'fab fa-html5',
        'htm': 'fab fa-html5',
        'xhtml': 'fab fa-html5',
        'css': 'fab fa-css3-alt',
        'scss': 'fab fa-sass',
        'sass': 'fab fa-sass',
        'less': 'fab fa-less',
        'js': 'fab fa-js-square',
        'jsx': 'fab fa-react',
        'mjs': 'fab fa-js-square',
        'ts': 'fas fa-file-code',
        'tsx': 'fab fa-react',
        'vue': 'fab fa-vuejs',
        'svelte': 'fas fa-file-code',
        'astro': 'fas fa-rocket',
        
        // Backend Languages
        'py': 'fab fa-python',
        'pyw': 'fab fa-python',
        'java': 'fab fa-java',
        'class': 'fab fa-java',
        'jsp': 'fab fa-java',
        'php': 'fab fa-php',
        'php3': 'fab fa-php',
        'php4': 'fab fa-php',
        'php5': 'fab fa-php',
        'php7': 'fab fa-php',
        'phtml': 'fab fa-php',
        'rb': 'fas fa-gem',
        'rbw': 'fas fa-gem',
        'gem': 'fas fa-gem',
        'rake': 'fas fa-gem',
        'go': 'fas fa-file-code',
        'rs': 'fas fa-cog',
        'swift': 'fab fa-swift',
        'kt': 'fas fa-mobile-alt',
        'kts': 'fas fa-mobile-alt',
        'scala': 'fas fa-file-code',
        'sc': 'fas fa-file-code',
        'dart': 'fas fa-file-code',
        'lua': 'fas fa-moon',
        'perl': 'fas fa-file-code',
        'pl': 'fas fa-file-code',
        'pm': 'fas fa-file-code',
        
        // System Programming
        'c': 'fas fa-file-code',
        'h': 'fas fa-file-code',
        'cpp': 'fas fa-file-code',
        'cxx': 'fas fa-file-code',
        'cc': 'fas fa-file-code',
        'hpp': 'fas fa-file-code',
        'hxx': 'fas fa-file-code',
        'cs': 'fas fa-file-code',
        'vb': 'fas fa-file-code',
        'fs': 'fas fa-file-code',
        'fsx': 'fas fa-file-code',
        'fsi': 'fas fa-file-code',
        
        // Functional Languages
        'hs': 'fas fa-file-code',
        'lhs': 'fas fa-file-code',
        'elm': 'fas fa-tree',
        'ml': 'fas fa-file-code',
        'mli': 'fas fa-file-code',
        'clj': 'fas fa-file-code',
        'cljs': 'fas fa-file-code',
        'cljc': 'fas fa-file-code',
        'erl': 'fas fa-file-code',
        'hrl': 'fas fa-file-code',
        'ex': 'fas fa-flask',
        'exs': 'fas fa-flask',
        
        // Scripting
        'sh': 'fas fa-terminal',
        'bash': 'fas fa-terminal',
        'zsh': 'fas fa-terminal',
        'fish': 'fas fa-terminal',
        'ps1': 'fas fa-terminal',
        'psm1': 'fas fa-terminal',
        'bat': 'fas fa-terminal',
        'cmd': 'fas fa-terminal',
        
        // Data & Config
        'json': 'fas fa-file-code',
        'jsonc': 'fas fa-file-code',
        'json5': 'fas fa-file-code',
        'xml': 'fas fa-file-code',
        'xsl': 'fas fa-file-code',
        'xsd': 'fas fa-file-code',
        'yml': 'fas fa-cog',
        'yaml': 'fas fa-cog',
        'toml': 'fas fa-cog',
        'ini': 'fas fa-cog',
        'cfg': 'fas fa-cog',
        'conf': 'fas fa-cog',
        'properties': 'fas fa-cog',
        
        // Databases
        'sql': 'fas fa-database',
        'mysql': 'fas fa-database',
        'pgsql': 'fas fa-database',
        'plsql': 'fas fa-database',
        'tsql': 'fas fa-database',
        
        // Markup & Documentation
        'md': 'fab fa-markdown',
        'markdown': 'fab fa-markdown',
        'mdown': 'fab fa-markdown',
        'mkd': 'fab fa-markdown',
        'rst': 'fas fa-file-alt',
        'tex': 'fas fa-file-alt',
        'latex': 'fas fa-file-alt',
        'org': 'fas fa-file-alt',
        
        // Mobile Development
        'm': 'fab fa-apple',
        'mm': 'fab fa-apple',
        'gradle': 'fab fa-android',
        'groovy': 'fas fa-file-code',
        'gvy': 'fas fa-file-code',
        
        // Other Languages
        'r': 'fas fa-chart-line',
        'R': 'fas fa-chart-line',
        'rmd': 'fas fa-chart-line',
        'matlab': 'fas fa-calculator',
        'jl': 'fas fa-atom',
        'nim': 'fas fa-crown',
        'nims': 'fas fa-crown',
        'cr': 'fas fa-gem',
        'zig': 'fas fa-bolt',
        'v': 'fas fa-file-code',
        'sol': 'fab fa-ethereum',
        
        // Templates
        'hbs': 'fas fa-file-code',
        'handlebars': 'fas fa-file-code',
        'mustache': 'fas fa-file-code',
        'twig': 'fas fa-file-code',
        'liquid': 'fas fa-file-code',
        'ejs': 'fas fa-file-code',
        'pug': 'fas fa-file-code',
        'jade': 'fas fa-file-code',
        
        // Docker & DevOps
        'dockerfile': 'fab fa-docker',
        'dockerignore': 'fab fa-docker',
        'vagrantfile': 'fas fa-box',
        'makefile': 'fas fa-hammer',
        'make': 'fas fa-hammer',
        
        // Version Control
        'gitignore': 'fab fa-git-alt',
        'gitattributes': 'fab fa-git-alt',
        'gitmodules': 'fab fa-git-alt',
        'hgignore': 'fas fa-code-branch',
        
        // Package Managers
        'package': 'fab fa-npm',
        'composer': 'fas fa-box',
        'bower': 'fas fa-box',
        'yarn': 'fab fa-yarn',
        'lock': 'fas fa-lock',
        
        // Assembly
        'asm': 'fas fa-microchip',
        's': 'fas fa-microchip',
        'nasm': 'fas fa-microchip',
        
        // Archives & Images
        'zip': 'fas fa-file-archive',
        'rar': 'fas fa-file-archive',
        '7z': 'fas fa-file-archive',
        'tar': 'fas fa-file-archive',
        'gz': 'fas fa-file-archive',
        'jpg': 'fas fa-file-image',
        'jpeg': 'fas fa-file-image',
        'png': 'fas fa-file-image',
        'gif': 'fas fa-file-image',
        'svg': 'fas fa-file-image',
        'ico': 'fas fa-file-image',
        'webp': 'fas fa-file-image',
        
        // Media
        'mp4': 'fas fa-file-video',
        'avi': 'fas fa-file-video',
        'mov': 'fas fa-file-video',
        'webm': 'fas fa-file-video',
        'mp3': 'fas fa-file-audio',
        'wav': 'fas fa-file-audio',
        'flac': 'fas fa-file-audio',
        'ogg': 'fas fa-file-audio',
        
        // Documents
        'pdf': 'fas fa-file-pdf',
        'doc': 'fas fa-file-word',
        'docx': 'fas fa-file-word',
        'xls': 'fas fa-file-excel',
        'xlsx': 'fas fa-file-excel',
        'ppt': 'fas fa-file-powerpoint',
        'pptx': 'fas fa-file-powerpoint',
        'txt': 'fas fa-file-alt',
        'rtf': 'fas fa-file-alt',
        
        // Fonts
        'ttf': 'fas fa-font',
        'otf': 'fas fa-font',
        'woff': 'fas fa-font',
        'woff2': 'fas fa-font',
        'eot': 'fas fa-font',
        
        // Certificates & Keys
        'pem': 'fas fa-certificate',
        'crt': 'fas fa-certificate',
        'key': 'fas fa-key',
        'p12': 'fas fa-certificate',
        'pfx': 'fas fa-certificate'
    };
    
    return icons[fileType.toLowerCase()] || 'fas fa-file';
}
async function openFile(file) {
    try {
        let existingTab = openTabs.find(tab => tab.id === file.id);
        
        if (existingTab) {
            setActiveTab(existingTab);
            return;
        }

        const { data: fileData, error } = await supabaseClient
            .from('project_files')
            .select('content')
            .eq('id', file.id)
            .single();

        if (error) throw error;

        const newTab = {
            id: file.id,
            name: file.file_name,
            type: file.file_type,
            content: fileData.content || '',
            modified: false,
            filePath: file.file_path
        };

        openTabs.push(newTab);
        setActiveTab(newTab);
        renderTabs();

    } catch (error) {
        console.error('Error opening file:', error);
        showToast('Error abriendo el archivo', 'error');
    }
}

function renderTabs() {
    try {
        const tabsContainer = document.getElementById('editor-tabs');
        if (!tabsContainer) return;
        
        tabsContainer.innerHTML = '';
        
        openTabs.forEach((tab, index) => {
            const tabElement = document.createElement('div');
            tabElement.className = 'editor-tab';
            
            if (activeTab && tab.id === activeTab.id) {
                tabElement.classList.add('active');
            }
            if (tab.modified) {
                tabElement.classList.add('modified');
            }
            
            tabElement.innerHTML = `
                <i class="fas ${getFileIcon(tab.type)}"></i>
                <span>${tab.name}${tab.modified ? '*' : ''}</span>
                <span class="close-tab" data-tab-id="${tab.id}">×</span>
            `;
            
            tabElement.addEventListener('click', (e) => {
                if (!e.target.classList.contains('close-tab')) {
                    setActiveTab(tab);
                }
            });
            
            const closeBtn = tabElement.querySelector('.close-tab');
            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeTab(tab.id);
                });
            }
            
            tabsContainer.appendChild(tabElement);
        });
        
    } catch (error) {
        console.error('Error rendering tabs:', error);
    }
}

function closeTab(tabId) {
    try {
        const tabIndex = openTabs.findIndex(tab => tab.id === tabId);
        if (tabIndex === -1) return;

        const tab = openTabs[tabIndex];
        
        if (activeTab && activeTab.id === tabId && realTimeCollab) {
            realTimeCollab.leaveFile();
        }
        
        if (tab.modified) {
            const shouldSave = confirm(`¿Guardar cambios en ${tab.name}?`);
            if (shouldSave && realTimeCollab) {
                realTimeCollab.saveToServer();
            } else if (shouldSave) {
                autoSave();
            }
        }
        
        openTabs.splice(tabIndex, 1);
        
        if (activeTab && activeTab.id === tabId) {
            if (openTabs.length > 0) {
                let newActiveIndex;
                if (tabIndex > 0) {
                    newActiveIndex = Math.min(tabIndex - 1, openTabs.length - 1);
                } else {
                    newActiveIndex = 0;
                }
                setActiveTab(openTabs[newActiveIndex]);
            } else {
                clearEditor();
            }
        }
        
        renderTabs();
        
    } catch (error) {
        console.error('Error closing tab:', error);
        showToast('Error al cerrar el archivo', 'error');
    }
}

function getMonacoLanguage(fileType) {
    const languageMap = {
        // Web Technologies
        'html': 'html',
        'htm': 'html',
        'xhtml': 'html',
        'css': 'css',
        'scss': 'scss',
        'sass': 'scss',
        'less': 'less',
        'js': 'javascript',
        'jsx': 'javascript',
        'mjs': 'javascript',
        'ts': 'typescript',
        'tsx': 'typescript',
        'vue': 'html',
        'svelte': 'html',
        'astro': 'html',
        
        // Backend Languages
        'py': 'python',
        'pyw': 'python',
        'java': 'java',
        'class': 'java',
        'jsp': 'java',
        'php': 'php',
        'php3': 'php',
        'php4': 'php',
        'php5': 'php',
        'php7': 'php',
        'phtml': 'php',
        'rb': 'ruby',
        'rbw': 'ruby',
        'gem': 'ruby',
        'rake': 'ruby',
        'go': 'go',
        'rs': 'rust',
        'swift': 'swift',
        'kt': 'kotlin',
        'kts': 'kotlin',
        'scala': 'scala',
        'sc': 'scala',
        'dart': 'dart',
        'lua': 'lua',
        'perl': 'perl',
        'pl': 'perl',
        'pm': 'perl',
        
        // System Programming
        'c': 'c',
        'h': 'c',
        'cpp': 'cpp',
        'cxx': 'cpp',
        'cc': 'cpp',
        'hpp': 'cpp',
        'hxx': 'cpp',
        'cs': 'csharp',
        'vb': 'vb',
        'fs': 'fsharp',
        'fsx': 'fsharp',
        'fsi': 'fsharp',
        
        // Functional Languages
        'hs': 'haskell',
        'lhs': 'haskell',
        'elm': 'elm',
        'ml': 'ocaml',
        'mli': 'ocaml',
        'clj': 'clojure',
        'cljs': 'clojure',
        'cljc': 'clojure',
        'erl': 'erlang',
        'hrl': 'erlang',
        'ex': 'elixir',
        'exs': 'elixir',
        
        // Scripting
        'sh': 'shell',
        'bash': 'shell',
        'zsh': 'shell',
        'fish': 'shell',
        'ps1': 'powershell',
        'psm1': 'powershell',
        'bat': 'batch',
        'cmd': 'batch',
        
        // Data & Config
        'json': 'json',
        'jsonc': 'json',
        'json5': 'json',
        'xml': 'xml',
        'xsl': 'xml',
        'xsd': 'xml',
        'yml': 'yaml',
        'yaml': 'yaml',
        'toml': 'ini',
        'ini': 'ini',
        'cfg': 'ini',
        'conf': 'ini',
        'properties': 'properties',
        
        // Databases
        'sql': 'sql',
        'mysql': 'sql',
        'pgsql': 'sql',
        'plsql': 'sql',
        'tsql': 'sql',
        
        // Markup & Documentation
        'md': 'markdown',
        'markdown': 'markdown',
        'mdown': 'markdown',
        'mkd': 'markdown',
        'rst': 'restructuredtext',
        'tex': 'latex',
        'latex': 'latex',
        'org': 'org',
        
        // Mobile Development
        'm': 'objective-c',
        'mm': 'objective-cpp',
        'gradle': 'groovy',
        'groovy': 'groovy',
        'gvy': 'groovy',
        
        // Other Languages
        'r': 'r',
        'R': 'r',
        'rmd': 'r',
        'matlab': 'matlab',
        'm': 'matlab',
        'jl': 'julia',
        'nim': 'nim',
        'nims': 'nim',
        'cr': 'crystal',
        'zig': 'zig',
        'v': 'v',
        'sol': 'solidity',
        
        // Templates
        'hbs': 'handlebars',
        'handlebars': 'handlebars',
        'mustache': 'handlebars',
        'twig': 'twig',
        'liquid': 'liquid',
        'ejs': 'html',
        'pug': 'pug',
        'jade': 'pug',
        
        // Docker & DevOps
        'dockerfile': 'dockerfile',
        'dockerignore': 'dockerfile',
        'vagrantfile': 'ruby',
        'makefile': 'makefile',
        'make': 'makefile',
        
        // Version Control
        'gitignore': 'ignore',
        'gitattributes': 'ignore',
        'gitmodules': 'ignore',
        'hgignore': 'ignore',
        
        // Package Managers
        'package': 'json',
        'composer': 'json',
        'bower': 'json',
        'yarn': 'yaml',
        'lock': 'yaml',
        
        // Assembly
        'asm': 'asm',
        's': 'asm',
        'nasm': 'asm'
    };
    
    return languageMap[fileType.toLowerCase()] || 'plaintext';
}

function setActiveTab(tab) {
    if (!tab) return;
    
    if (activeTab && realTimeCollab) {
        realTimeCollab.leaveFile();
    }
    
    activeTab = tab;
    
    stopPeriodicSync();
    
    if (monacoEditor) {
        const language = getMonacoLanguage(tab.type);
        const model = monaco.editor.createModel(tab.content, language);
        monacoEditor.setModel(model);
        
        const canEdit = ['owner', 'admin'].includes(currentUserRole);
        monacoEditor.updateOptions({ readOnly: !canEdit });
        
        // Agregar event listeners para el status bar
        monacoEditor.onDidChangeCursorPosition(() => {
            updateStatusBar();
        });

        monacoEditor.onDidChangeCursorSelection(() => {
            updateStatusBar();
        });

        monacoEditor.onDidChangeModelContent(() => {
            updateStatusBar();
        });
    }
    
    document.getElementById('current-file-name').textContent = tab.name;
    updateFileTreeVisual();
    updateTabsVisual();
    
    // Crear breadcrumbs
    createBreadcrumbs(tab.filePath, tab.name);
    
    // Actualizar status bar después de un breve delay para que Monaco se inicialice
    setTimeout(() => {
        updateStatusBar();
    }, 100);
    
    if (currentUser && tab.id) {
        const userName = currentUser.user_metadata?.full_name || 
                        currentUser.user_metadata?.name || 
                        currentUser.email.split('@')[0];
        
        initializeRealTimeForFile(tab.id, currentUser.id, userName);
    } else {
        startPeriodicSync();
    }
}

function clearEditor() {
    if (realTimeCollab) {
        realTimeCollab.leaveFile();
    }

    activeTab = null;
    stopPeriodicSync();
    
    if (monacoEditor) {
        const model = monaco.editor.createModel('// Selecciona un archivo para comenzar a editar...', 'javascript');
        monacoEditor.setModel(model);
        monacoEditor.updateOptions({ readOnly: true });
    }
    
    const fileNameEl = document.getElementById('current-file-name');
    if (fileNameEl) {
        fileNameEl.textContent = 'Selecciona un archivo';
    }
    
    updateFileTreeVisual();
}

function updateTabsVisual() {
    try {
        document.querySelectorAll('.editor-tab').forEach((el, index) => {
            if (openTabs[index]) {
                el.classList.toggle('active', openTabs[index].id === activeTab?.id);
                el.classList.toggle('modified', openTabs[index].modified);
            }
        });
    } catch (error) {
        console.error('Error updating tabs visual:', error);
    }
}

function updateFileTreeVisual() {
    try {
        document.querySelectorAll('.file-item').forEach(el => {
            el.classList.toggle('active', el.dataset.fileId === activeTab?.id);
        });
    } catch (error) {
        console.error('Error updating file tree visual:', error);
    }
}

function debounceAutoSave() {
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(autoSave, 2000);
}

async function autoSave() {
    if (!activeTab || !activeTab.modified) return;
    
    if (!['owner', 'admin'].includes(currentUserRole)) {
        console.log('Member no puede auto-guardar');
        return;
    }

    try {
        if (monacoEditor) {
            activeTab.content = monacoEditor.getValue();
        }

        const { error } = await supabaseClient
            .from('project_files')
            .update({ 
                content: activeTab.content,
                updated_at: new Date().toISOString()
            })
            .eq('id', activeTab.id);

        if (error) throw error;

        activeTab.modified = false;
        renderTabs();
        updateSaveStatus('saved');

    } catch (error) {
        console.error('Error auto-saving:', error);
        updateSaveStatus('error');
    }
}

function updateSaveStatus(status) {
    const statusElement = document.getElementById('save-status');
    if (!statusElement) return;
    
    const statusTexts = {
        'saving': { text: 'Guardando...', class: 'saving', icon: 'fa-spinner fa-spin' },
        'saved': { text: 'Guardado', class: 'saved', icon: 'fa-check' },
        'error': { text: 'Error', class: 'error', icon: 'fa-exclamation-triangle' }
    };

    const config = statusTexts[status];
    if (config) {
        statusElement.className = `save-status ${config.class}`;
        statusElement.innerHTML = `<i class="fas ${config.icon}"></i><span>${config.text}</span>`;
    }
}

// Sistema de sincronización simplificado

function startPeriodicSync() {
    if (syncInterval) {
        clearInterval(syncInterval);
    }
    
    syncInterval = setInterval(async () => {
        if (activeTab) {
            await syncFileChanges();
        }
    }, 10000);
}

function stopPeriodicSync() {
    if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
    }
}

async function syncFileChanges() {
    if (!activeTab) return;
    
    try {
        const { data: remoteFile, error: fetchError } = await supabaseClient
            .from('project_files')
            .select('content, updated_at')
            .eq('id', activeTab.id)
            .single();

        if (fetchError) {
            console.error('Error fetching remote file:', fetchError);
            return;
        }

        const remoteUpdateTime = new Date(remoteFile.updated_at).getTime();
        
        if (remoteUpdateTime > lastSyncTime && !isEditing) {
            if (remoteFile.content !== activeTab.content) {
                activeTab.content = remoteFile.content;
                if (monacoEditor) {
                    monacoEditor.setValue(remoteFile.content);
                }
                showToast('Archivo actualizado por otro usuario', 'info');
            }
        }
        
        if (activeTab.modified && isEditing) {
            await saveFileChanges();
            isEditing = false;
        }
        
        lastSyncTime = Date.now();
        
    } catch (error) {
        console.error('Error in syncFileChanges:', error);
    }
}

async function saveFileChanges() {
    if (!activeTab || !activeTab.modified) return;
    
    if (!['owner', 'admin'].includes(currentUserRole)) {
        console.log('Member no puede guardar cambios');
        return;
    }

    try {
        if (monacoEditor) {
            activeTab.content = monacoEditor.getValue();
        }

        const { error } = await supabaseClient
            .from('project_files')
            .update({ 
                content: activeTab.content,
                updated_at: new Date().toISOString()
            })
            .eq('id', activeTab.id);

        if (error) throw error;

        activeTab.modified = false;
        renderTabs();
        updateSaveStatus('saved');

    } catch (error) {
        console.error('Error saving file changes:', error);
        updateSaveStatus('error');
    }
}

// Funciones de tiempo real

async function initializeRealTimeForFile(fileId, userId, userName) {
    try {
        if (realTimeCollab) {
            await realTimeCollab.leaveFile();
        }
        
        realTimeCollab = new RealTimeCollaboration(supabaseClient, monacoEditor);
        await realTimeCollab.joinFile(fileId, userId, userName);
        console.log('Tiempo real inicializado para archivo:', fileId);
    } catch (error) {
        console.error('Error inicializando tiempo real:', error);
        startPeriodicSync();
    }
}

async function cleanupRealTime() {
    if (realTimeCollab) {
        await realTimeCollab.leaveFile();
        realTimeCollab.destroy();
        realTimeCollab = null;
    }
}

// Funciones de utilidades

function readFileContent(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            resolve(e.target.result);
        };
        
        reader.onerror = function() {
            reject(new Error('Error leyendo el archivo'));
        };

        if (isTextFile(file.name)) {
            reader.readAsText(file);
        } else {
            reader.readAsDataURL(file);
        }
    });
}

function isTextFile(fileName) {
    const textExtensions = [
        'txt', 'md', 'html', 'css', 'js', 'json', 'xml', 'yml', 'yaml',
        'py', 'java', 'cpp', 'c', 'h', 'php', 'rb', 'go', 'rs', 'swift',
        'kt', 'scala', 'sh', 'bat', 'ps1', 'sql', 'env', 'dockerfile',
        'tsx', 'jsx', 'vue', 'svelte', 'ts', 'cs', 'vb', 'fs', 'dart'
    ];
    
    const extension = fileName.split('.').pop().toLowerCase();
    return textExtensions.includes(extension) || !fileName.includes('.');
}

function getFileTypeFromName(fileName) {
    if (!fileName.includes('.')) return 'txt';
    return fileName.split('.').pop().toLowerCase();
}

async function ensureParentFolders(filePath) {
    const pathParts = filePath.split('/').filter(part => part.length > 0);
    pathParts.pop();
    
    let currentPath = '';
    
    for (const part of pathParts) {
        currentPath += `/${part}`;
        
        const existingFolder = projectFiles.find(f => f.file_path === currentPath && f.is_folder);
        if (existingFolder) continue;

        try {
            const { error } = await supabaseClient
                .from('project_files')
                .insert([{
                    project_id: currentProject.id,
                    repository_id: selectedRepository?.id,
                    file_name: part,
                    file_path: currentPath,
                    file_type: 'folder',
                    content: '',
                    is_folder: true,
                    created_by: currentUser.id
                }]);

            if (error) {
                console.error(`Error creando carpeta ${currentPath}:`, error);
            } else {
                projectFiles.push({
                    file_path: currentPath,
                    is_folder: true
                });
            }
        } catch (err) {
            console.error(`Error en ensureParentFolders para ${currentPath}:`, err);
        }
    }
}

// Funciones restantes simplificadas

function cleanGeneratedCode(code) {
    let cleaned = code
        .replace(/```[\w]*\n?/g, '')
        .replace(/```\n?/g, '')
        .replace(/^\s*```[\w]*$/gm, '')
        .replace(/^\s*```\s*$/gm, '')
        .replace(/^(Aquí tienes|Este código|El siguiente código|Aquí está|He corregido|Los errores han sido|Correcciones aplicadas).*?[:\.]\s*/gi, '')
        .replace(/^(Errores encontrados|Problemas detectados|Correcciones realizadas).*?\n/gi, '')
        .replace(/^(Análisis|Explicación|Descripción|Resumen).*?\n/gi, '')
        .replace(/^(Error \d+:|Corrección \d+:|Línea \d+:).*?\n/gi, '')
        .split('\n')
        .filter(line => {
            const trimmedLine = line.trim();
            return !trimmedLine.match(/^(El error estaba|El problema era|Ahora el código|La corrección|Se ha corregido)/i) &&
                   !trimmedLine.match(/^(Cambios realizados|Errores solucionados|Modificaciones)/i);
        })
        .join('\n')
        .replace(/^\s*\n+/, '')
        .replace(/\n+\s*$/, '')
        .trim();
    
    return cleaned;
}



async function ensureUserProfile() {
    try {
        // Verificar si ya existe un perfil para este usuario
        const { data: existingProfile, error: selectError } = await supabaseClient
            .from('profiles')
            .select('id, username, full_name, avatar_url')
            .eq('id', currentUser.id)
            .maybeSingle();

        // Manejar errores de selección (excepto PGRST116 que significa "no encontrado")
        if (selectError && selectError.code !== 'PGRST116') {
            console.error('Error checking existing profile:', selectError);
            throw selectError;
        }

        // Si no existe perfil, crear uno nuevo
        if (!existingProfile) {
            console.log('Creating new user profile...');
            
            // Obtener datos del usuario desde la metadata
            const userMetadata = currentUser.user_metadata || {};
            const userName = userMetadata.full_name || 
                           userMetadata.name || 
                           currentUser.email.split('@')[0];
            
            // Crear username único
            const baseUsername = userName.toLowerCase()
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
            
            let username = baseUsername;
            let counter = 1;
            
            // Verificar si el username ya existe y crear uno único
            while (true) {
                const { data: existingUsername } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('username', username)
                    .maybeSingle();
                
                if (!existingUsername) break;
                
                username = `${baseUsername}_${counter}`;
                counter++;
            }

            // Insertar nuevo perfil
            const { data: newProfile, error: insertError } = await supabaseClient
                .from('profiles')
                .insert([{
                    id: currentUser.id,
                    username: username,
                    full_name: userName,
                    avatar_url: userMetadata.avatar_url || null,
                    email: currentUser.email,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }])
                .select()
                .single();

            if (insertError) {
                console.error('Error creating profile:', insertError);
                throw insertError;
            }

            console.log('User profile created successfully:', newProfile);
            return newProfile;
        } else {
            console.log('User profile already exists');
            return existingProfile;
        }

    } catch (error) {
        console.error('Error in ensureUserProfile:', error);
        
        // Mostrar toast con error específico
        if (error.code === '23505') {
            showToast('Error: Usuario duplicado', 'error');
        } else if (error.code === '23503') {
            showToast('Error: Referencia inválida', 'error');
        } else {
            showToast('Error creando perfil de usuario', 'error');
        }
        
        // Re-lanzar el error para manejo superior si es necesario
        throw error;
    }
}

// Función auxiliar para validar la estructura de la tabla profiles
async function validateProfilesTable() {
    try {
        const { data, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .limit(1);
            
        if (error && error.code === '42P01') {
            console.error('La tabla "profiles" no existe en la base de datos');
            throw new Error('Tabla profiles no encontrada');
        }
        
        return true;
    } catch (error) {
        console.error('Error validating profiles table:', error);
        return false;
    }
}

// ================================
// 1. REEMPLAZA tu función ensureUserProfile con esta versión completa
// ================================

async function ensureUserProfile() {
    try {
        // Verificar si ya existe un perfil para este usuario
        const { data: existingProfile, error: selectError } = await supabaseClient
            .from('profiles')
            .select('id, username, full_name, avatar_url')
            .eq('id', currentUser.id)
            .maybeSingle();

        // Manejar errores de selección (excepto PGRST116 que significa "no encontrado")
        if (selectError && selectError.code !== 'PGRST116') {
            console.error('Error checking existing profile:', selectError);
            throw selectError;
        }

        // Si no existe perfil, crear uno nuevo
        if (!existingProfile) {
            console.log('Creating new user profile...');
            
            // Obtener datos del usuario desde la metadata
            const userMetadata = currentUser.user_metadata || {};
            const userName = userMetadata.full_name || 
                           userMetadata.name || 
                           currentUser.email.split('@')[0];
            
            // Crear username único
            const baseUsername = userName.toLowerCase()
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
            
            let username = baseUsername;
            let counter = 1;
            
            // Verificar si el username ya existe y crear uno único
            while (true) {
                const { data: existingUsername } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('username', username)
                    .maybeSingle();
                
                if (!existingUsername) break;
                
                username = `${baseUsername}_${counter}`;
                counter++;
            }

            // Insertar nuevo perfil
            const { data: newProfile, error: insertError } = await supabaseClient
                .from('profiles')
                .insert([{
                    id: currentUser.id,
                    username: username,
                    full_name: userName,
                    avatar_url: userMetadata.avatar_url || null,
                    email: currentUser.email,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }])
                .select()
                .single();

            if (insertError) {
                console.error('Error creating profile:', insertError);
                throw insertError;
            }

            console.log('User profile created successfully:', newProfile);
            return newProfile;
        } else {
            console.log('User profile already exists');
            return existingProfile;
        }

    } catch (error) {
        console.error('Error in ensureUserProfile:', error);
        
        // Mostrar toast con error específico
        if (error.code === '23505') {
            showToast('Error: Usuario duplicado', 'error');
        } else if (error.code === '23503') {
            showToast('Error: Referencia inválida', 'error');
        } else {
            showToast('Error creando perfil de usuario', 'error');
        }
        
        // Re-lanzar el error para manejo superior si es necesario
        throw error;
    }
}

// ================================
// 2. AGREGAR ESTILOS CSS FALTANTES (agregar al <head> o archivo CSS)
// ================================

const missingStyles = document.createElement('style');
missingStyles.textContent = `
/* Estilos para modales de manejo de archivos */
.rename-modal-wrapper, .move-file-modal-wrapper, .new-folder-modal-overlay, .repo-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    backdrop-filter: blur(5px);
}



.rename-modal-title, .move-file-modal-title, .new-folder-modal-title {
    color: #4a9eff;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.rename-form-group, .move-file-form-group, .new-folder-form-group, .repo-form-group {
    margin-bottom: 20px;
}

.rename-label, .move-file-label, .new-folder-label {
    display: block;
    color: #ffffff;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
}

.rename-input, .move-file-select, .new-folder-input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(74, 158, 255, 0.3);
    border-radius: 8px;
    color: #ffffff;
    font-size: 14px;
    transition: all 0.3s ease;
}

.rename-input:focus, .move-file-select:focus, .new-folder-input:focus {
    outline: none;
    border-color: #4a9eff;
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
}

.move-file-display-box, .new-folder-parent-display {
    padding: 12px 16px;
    background: rgba(74, 158, 255, 0.1);
    border: 1px solid rgba(74, 158, 255, 0.2);
    border-radius: 8px;
    color: #4a9eff;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.rename-modal-actions, .move-file-modal-actions, .new-folder-modal-actions, .repo-modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 25px;
}

.rename-cancel-btn, .move-file-cancel-btn, .new-folder-cancel-btn, .repo-cancel-btn {
    background: rgba(107, 114, 128, 0.2);
    border: 1px solid #6b7280;
    color: #d1d5db;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.rename-create-btn, .move-file-confirm-btn, .new-folder-create-btn, .repo-create-btn {
    background: linear-gradient(45deg, #4a9eff, #00d4ff);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(74, 158, 255, 0.3);
}

.rename-cancel-btn:hover, .move-file-cancel-btn:hover, .new-folder-cancel-btn:hover, .repo-cancel-btn:hover {
    background: rgba(107, 114, 128, 0.3);
    transform: translateY(-1px);
}

.rename-create-btn:hover, .move-file-confirm-btn:hover, .new-folder-create-btn:hover, .repo-create-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(74, 158, 255, 0.4);
}
`;
document.head.appendChild(missingStyles);

// ================================
// 3. FUNCIONES FALTANTES PARA EL MENÚ CONTEXTUAL
// ================================

// Modal para renombrar archivos/carpetas

async function renameFile(file, newName, modal) {
    if (!newName || newName === file.file_name) {
        modal.remove();
        return;
    }

    if (!/^[\w\-. ]+$/.test(newName)) {
        showToast('El nombre solo puede contener letras, números, espacios, puntos y guiones', 'error');
        return;
    }

    try {
        // Construir nueva ruta
        const pathParts = file.file_path.split('/');
        pathParts[pathParts.length - 1] = newName;
        const newPath = pathParts.join('/');

        // Verificar que no exista ya
        const existingFile = projectFiles.find(f => f.file_path === newPath && f.id !== file.id);
        if (existingFile) {
            showToast('Ya existe un archivo con ese nombre', 'error');
            return;
        }

        if (file.is_folder) {
            // Para carpetas: actualizar la carpeta y todos sus archivos hijos
            const oldPath = file.file_path;
            
            // 1. Obtener todos los archivos que están dentro de esta carpeta
            const childFiles = projectFiles.filter(f => 
                f.file_path.startsWith(oldPath + '/') || f.file_path === oldPath
            );

            // 2. Preparar actualizaciones en lote
            const updates = childFiles.map(childFile => {
                let newChildPath;
                if (childFile.id === file.id) {
                    // La carpeta misma
                    newChildPath = newPath;
                } else {
                    // Archivos dentro de la carpeta
                    newChildPath = childFile.file_path.replace(oldPath, newPath);
                }

                return {
                    id: childFile.id,
                    file_name: childFile.id === file.id ? newName : childFile.file_name,
                    file_path: newChildPath
                };
            });

            // 3. Actualizar en la base de datos
            for (const update of updates) {
                const { error } = await supabaseClient
                    .from('project_files')
                    .update({ 
                        file_name: update.file_name,
                        file_path: update.file_path
                    })
                    .eq('id', update.id);

                if (error) {
                    console.error('Error updating file:', update, error);
                    throw error;
                }
            }

            // 4. Cerrar pestañas de archivos que estaban dentro de la carpeta renombrada
            childFiles.forEach(childFile => {
                if (!childFile.is_folder) {
                    const openTab = openTabs.find(tab => tab.id === childFile.id);
                    if (openTab) {
                        // Actualizar la ruta en la pestaña en lugar de cerrarla
                        const newTabPath = childFile.file_path.replace(oldPath, newPath);
                        openTab.filePath = newTabPath;
                    }
                }
            });

        } else {
            // Para archivos: actualización simple
            const { error } = await supabaseClient
                .from('project_files')
                .update({ 
                    file_name: newName,
                    file_path: newPath
                })
                .eq('id', file.id);

            if (error) throw error;

            // Si es un archivo abierto, actualizar la pestaña
            const openTab = openTabs.find(tab => tab.id === file.id);
            if (openTab) {
                openTab.name = newName;
                openTab.filePath = newPath;
                renderTabs();
            }
        }

        showToast(`${file.is_folder ? 'Carpeta' : 'Archivo'} renombrado correctamente`);
        modal.remove();
        
        // Recargar vista
        if (selectedRepository) {
            await loadRepositoryFiles(selectedRepository.id);
        }

    } catch (error) {
        console.error('Error renaming file:', error);
        showToast('Error al renombrar: ' + error.message, 'error');
    }
}

// Modal para mover archivos


function showMoveFileModal(file) {
    if (file.is_folder) {
        showToast('No se pueden mover carpetas aún', 'error');
        return;
    }

    const existingModal = document.querySelector('.unified-modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }

    // Construir opciones de carpetas
    let folderOptions = '<option value="/">/</option>';
    const folders = projectFiles.filter(f => 
        f.is_folder && 
        f.repository_id === selectedRepository?.id &&
        f.file_path !== file.file_path
    );
    folders.forEach(folder => {
        folderOptions += `<option value="${folder.file_path}">${folder.file_path}</option>`;
    });

    const modal = document.createElement('div');
    modal.className = 'unified-modal-overlay';
    modal.innerHTML = `
        <div class="unified-modal form-modal">
            <div class="unified-modal-header create-type">
                <h3 class="unified-modal-title">
                    <i class="fas fa-arrows-alt"></i>
                    Mover Archivo
                </h3>
                <button class="unified-close-btn" onclick="this.closest('.unified-modal-overlay').remove()">×</button>
            </div>
            
            <div class="unified-modal-body">
                <div class="unified-info-box primary">
                    <i class="fas ${getFileIcon(file.file_type)}"></i>
                    <span><strong>${file.file_name}</strong></span>
                </div>
                
                <div class="unified-form-group">
                    <label class="unified-form-label">Mover a carpeta:</label>
                    <select class="unified-form-select" id="move-folder-select">
                        ${folderOptions}
                    </select>
                </div>
            </div>
            
            <div class="unified-modal-actions">
                <button class="unified-btn cancel" onclick="this.closest('.unified-modal-overlay').remove()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="unified-btn primary" onclick="moveFileFromModal('${file.id}')">
                    <i class="fas fa-arrows-alt"></i> Mover
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function moveFileFromModal(fileId) {
    const targetFolder = document.getElementById('move-folder-select').value;
    const file = projectFiles.find(f => f.id === fileId);
    
    if (!file) {
        showToast('Archivo no encontrado', 'error');
        return;
    }
    
    const modal = document.querySelector('.unified-modal-overlay');
    moveFile(file, targetFolder, { remove: () => modal.remove() });
}



// Función para mover archivo
async function moveFile(file, targetFolder, modal) {
    try {
        const newPath = targetFolder === '/' ? `/${file.file_name}` : `${targetFolder}/${file.file_name}`;
        
        // Verificar que no exista ya
        const existingFile = projectFiles.find(f => f.file_path === newPath);
        if (existingFile) {
            showToast('Ya existe un archivo con ese nombre en esa carpeta', 'error');
            return;
        }

        // Actualizar en la base de datos
        const { error } = await supabaseClient
            .from('project_files')
            .update({ file_path: newPath })
            .eq('id', file.id);

        if (error) throw error;

        showToast('Archivo movido correctamente');
        modal.remove();
        
        // Recargar vista
        if (selectedRepository) {
            await loadRepositoryFiles(selectedRepository.id);
        }

    } catch (error) {
        console.error('Error moving file:', error);
        showToast('Error al mover el archivo', 'error');
    }
}

// Función para duplicar archivo
async function duplicateFile(file) {
    if (file.is_folder) {
        showToast('No se pueden duplicar carpetas', 'error');
        return;
    }

    try {
        // Generar nombre único
        const nameWithoutExt = file.file_name.replace(/\.[^/.]+$/, "");
        const extension = file.file_name.includes('.') ? '.' + file.file_name.split('.').pop() : '';
        let copyNumber = 1;
        let newName = `${nameWithoutExt}_copia${extension}`;
        
        while (projectFiles.find(f => f.file_name === newName && f.file_path.startsWith(file.file_path.substring(0, file.file_path.lastIndexOf('/'))))) {
            copyNumber++;
            newName = `${nameWithoutExt}_copia${copyNumber}${extension}`;
        }

        const newPath = file.file_path.substring(0, file.file_path.lastIndexOf('/')) + '/' + newName;

        // Obtener contenido del archivo original
        const { data: originalFile, error: fetchError } = await supabaseClient
            .from('project_files')
            .select('content')
            .eq('id', file.id)
            .single();

        if (fetchError) throw fetchError;

        // Crear archivo duplicado
        const { error } = await supabaseClient
            .from('project_files')
            .insert([{
                project_id: currentProject.id,
                repository_id: selectedRepository.id,
                file_name: newName,
                file_path: newPath,
                file_type: file.file_type,
                content: originalFile.content,
                is_folder: false,
                created_by: currentUser.id
            }]);

        if (error) throw error;

        showToast('Archivo duplicado correctamente');
        
        // Recargar vista
        if (selectedRepository) {
            await loadRepositoryFiles(selectedRepository.id);
        }

    } catch (error) {
        console.error('Error duplicating file:', error);
        showToast('Error al duplicar el archivo', 'error');
    }
}


// Event listeners adicionales para responsive
document.addEventListener('click', function(event) {
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        
        if (sidebar && menuToggle && 
            !sidebar.contains(event.target) && 
            !menuToggle.contains(event.target) &&
            sidebar.classList.contains('show')) {
            sidebar.classList.remove('show');
        }
    }
});

window.addEventListener('resize', () => {
    const sidebar = document.getElementById('sidebar');
    
    if (window.innerWidth <= 768) {
        // Mobile behavior
    } else {
        sidebar.classList.remove('show');
    }
});

// Cleanup global al cerrar ventana
window.addEventListener('beforeunload', () => {
    if (uploadAbortController) {
        uploadAbortController.abort();
    }
});
// Agregar después de la función setActiveTab()
function createBreadcrumbs(filePath, fileName) {
    const breadcrumbsContainer = document.getElementById('editor-breadcrumbs');
    if (!breadcrumbsContainer) return;
    
    const pathParts = filePath.split('/').filter(part => part.length > 0);
    let html = '';
    
    // Icono del repositorio
    html += `
        <div class="breadcrumb-item">
            <i class="fas fa-code-branch"></i>
            <span>${selectedRepository?.name || 'Repositorio'}</span>
        </div>
    `;
    
    // Carpetas del path
    let currentPath = '';
    pathParts.slice(0, -1).forEach((part, index) => {
        currentPath += `/${part}`;
        html += `
            <span class="breadcrumb-separator">›</span>
            <div class="breadcrumb-item">
                <i class="fas fa-folder"></i>
                <span>${part}</span>
            </div>
        `;
    });
    
    // Archivo actual
    if (fileName) {
        html += `
            <span class="breadcrumb-separator">›</span>
            <div class="breadcrumb-item active">
                <i class="fas ${getFileIcon(fileName.split('.').pop())}"></i>
                <span>${fileName}</span>
            </div>
        `;
    }
    
    breadcrumbsContainer.innerHTML = html;
}

// Actualizar la función setActiveTab() para incluir breadcrumbs
const originalSetActiveTab = setActiveTab;
setActiveTab = function(tab) {
    originalSetActiveTab.call(this, tab);
    
    if (tab) {
        createBreadcrumbs(tab.filePath, tab.name);
    }
};

// Función para actualizar el status bar
function updateStatusBar() {
    if (!monacoEditor || !activeTab) return;
    
    const model = monacoEditor.getModel();
    if (!model) return;
    
    // Actualizar posición del cursor
    const position = monacoEditor.getPosition();
    const cursorElement = document.getElementById('cursor-position');
    if (cursorElement && position) {
        cursorElement.innerHTML = `<span>Ln ${position.lineNumber}, Col ${position.column}</span>`;
    }
    
    // Actualizar lenguaje
    const languageElement = document.getElementById('editor-language');
    if (languageElement) {
        const languageMap = {
            'javascript': 'JavaScript',
            'typescript': 'TypeScript',
            'html': 'HTML',
            'css': 'CSS',
            'scss': 'SCSS',
            'python': 'Python',
            'java': 'Java',
            'cpp': 'C++',
            'c': 'C',
            'csharp': 'C#',
            'php': 'PHP',
            'ruby': 'Ruby',
            'go': 'Go',
            'rust': 'Rust',
            'swift': 'Swift',
            'kotlin': 'Kotlin',
            'dart': 'Dart',
            'json': 'JSON',
            'xml': 'XML',
            'yaml': 'YAML',
            'markdown': 'Markdown',
            'sql': 'SQL',
            'shell': 'Shell',
            'dockerfile': 'Dockerfile',
            'plaintext': 'Texto plano'
        };
        
        const currentLanguage = model.getLanguageId();
        const displayName = languageMap[currentLanguage] || currentLanguage.charAt(0).toUpperCase() + currentLanguage.slice(1);
        languageElement.innerHTML = `<span>${displayName}</span>`;
    }
    
    // Actualizar tamaño del archivo
    const fileSizeElement = document.getElementById('file-size');
    if (fileSizeElement) {
        const content = model.getValue();
        const bytes = new Blob([content]).size;
        const size = formatFileSize(bytes);
        fileSizeElement.innerHTML = `<span>${size}</span>`;
    }
    
    // Actualizar información de selección
    const selection = monacoEditor.getSelection();
    const selectionElement = document.getElementById('selection-info');
    if (selectionElement && selection && !selection.isEmpty()) {
        const selectedText = model.getValueInRange(selection);
        const selectedLength = selectedText.length;
        const selectedLines = selectedText.split('\n').length;
        
        if (selectedLength > 0) {
            let selectionText = '';
            if (selectedLines > 1) {
                selectionText = `${selectedLength} caracteres, ${selectedLines} líneas`;
            } else {
                selectionText = `${selectedLength} seleccionado`;
            }
            selectionElement.innerHTML = `<span>${selectionText}</span>`;
            selectionElement.style.display = 'block';
        } else {
            selectionElement.style.display = 'none';
        }
    } else if (selectionElement) {
        selectionElement.style.display = 'none';
    }
}

// Función para formatear el tamaño del archivo
function formatFileSize(bytes) {
    if (bytes === 0) return '0 bytes';
    
    const k = 1024;
    const sizes = ['bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Función para obtener información del proyecto actual
function updateProjectInfo() {
    const projectElement = document.getElementById('project-info');
    if (projectElement && currentProject) {
        projectElement.innerHTML = `
            <i class="fas fa-folder"></i>
            <span>${currentProject.name}</span>
        `;
    }
}

// Función para contar líneas totales del proyecto
async function getProjectStats() {
    if (!selectedRepository) return { files: 0, lines: 0 };
    
    const codeFiles = projectFiles.filter(f => 
        !f.is_folder && 
        ['js', 'ts', 'html', 'css', 'py', 'java', 'cpp', 'c', 'php', 'rb'].includes(f.file_type)
    );
    
    let totalLines = 0;
    codeFiles.forEach(file => {
        if (file.content) {
            totalLines += file.content.split('\n').length;
        }
    });
    
    return { files: codeFiles.length, lines: totalLines };
}
// === FUNCIONES DEL MENU SUPERIOR ===

let activeMenu = null;

// Inicializar menú superior
document.addEventListener('DOMContentLoaded', function() {
    setupMenuSystem();
    setupKeyboardShortcuts();
});

function setupMenuSystem() {
    const menuItems = document.querySelectorAll('.menu-item');
    
    menuItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            const menuType = this.dataset.menu;
            if (activeMenu && activeMenu !== menuType) {
                closeAllMenus();
                openMenu(menuType, this);
            }
        });
        
        item.addEventListener('click', function() {
            const menuType = this.dataset.menu;
            if (activeMenu === menuType) {
                closeAllMenus();
            } else {
                closeAllMenus();
                openMenu(menuType, this);
            }
        });
    });
    
    // Cerrar menús al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.menu-item')) {
            closeAllMenus();
        }
    });
}

function openMenu(menuType, element) {
    const dropdown = element.querySelector('.menu-dropdown');
    if (dropdown) {
        element.classList.add('active');
        dropdown.classList.add('show');
        activeMenu = menuType;
    }
}

function closeAllMenus() {
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
        const dropdown = item.querySelector('.menu-dropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    });
    activeMenu = null;
}

// === FUNCIONES DE COMANDOS MONACO ===

function triggerUndo() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'undo', null);
    }
    closeAllMenus();
}

function triggerRedo() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'redo', null);
    }
    closeAllMenus();
}

function triggerCut() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.clipboardCutAction', null);
    }
    closeAllMenus();
}

function triggerCopy() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.clipboardCopyAction', null);
    }
    closeAllMenus();
}

function triggerPaste() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.clipboardPasteAction', null);
    }
    closeAllMenus();
}

function triggerFind() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'actions.find', null);
    }
    closeAllMenus();
}

function triggerReplace() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.startFindReplaceAction', null);
    }
    closeAllMenus();
}

function triggerSelectAll() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.selectAll', null);
    }
    closeAllMenus();
}

function triggerExpandSelection() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.smartSelect.expand', null);
    }
    closeAllMenus();
}

function triggerShrinkSelection() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.smartSelect.shrink', null);
    }
    closeAllMenus();
}

function triggerCopyLinesUp() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.copyLinesUpAction', null);
    }
    closeAllMenus();
}

function triggerCopyLinesDown() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.copyLinesDownAction', null);
    }
    closeAllMenus();
}

function triggerMoveLinesUp() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.moveLinesUpAction', null);
    }
    closeAllMenus();
}

function triggerMoveLinesDown() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.moveLinesDownAction', null);
    }
    closeAllMenus();
}

function triggerCommandPalette() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.quickCommand', null);
    }
    closeAllMenus();
}

function triggerGoToFile() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'workbench.action.quickOpen', null);
    }
    closeAllMenus();
}

function triggerGoToLine() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.gotoLine', null);
    }
    closeAllMenus();
}

function triggerGoToSymbol() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.quickOutline', null);
    }
    closeAllMenus();
}

function triggerGoBack() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'workbench.action.navigateBack', null);
    }
    closeAllMenus();
}

function triggerGoForward() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'workbench.action.navigateForward', null);
    }
    closeAllMenus();
}

// === FUNCIONES DE ARCHIVO ===

function saveCurrentFile() {
    // Aquí conectas con tu función de guardado existente
    if (typeof autoSave === 'function') {
        autoSave();
    }
    showToast('Archivo guardado', 'success');
    closeAllMenus();
}

function saveAllFiles() {
    // Guardar todos los archivos abiertos
    showToast('Todos los archivos guardados', 'success');
    closeAllMenus();
}

function closeCurrentFile() {
    // Aquí conectas con tu función de cerrar pestaña existente
    if (activeTab && typeof closeTab === 'function') {
        closeTab(activeTab.id);
    }
    closeAllMenus();
}

function closeAllFiles() {
    // Cerrar todas las pestañas
    if (typeof openTabs !== 'undefined' && openTabs.length > 0) {
        openTabs.forEach(tab => {
            if (typeof closeTab === 'function') {
                closeTab(tab.id);
            }
        });
    }
    closeAllMenus();
}

// === FUNCIONES DE VISTA ===

function toggleExplorer() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('main-content');
    
    if (sidebar && mainContent) {
        sidebar.classList.toggle('hidden');
        mainContent.classList.toggle('expanded');
    }
    closeAllMenus();
}

function toggleTerminal() {
    showToast('Vista previa disponible en breadcrumbs', 'info');
    closeAllMenus();
}

function zoomIn() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.fontZoomIn', null);
    }
    closeAllMenus();
}

function zoomOut() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.fontZoomOut', null);
    }
    closeAllMenus();
}

function resetZoom() {
    if (monacoEditor) {
        monacoEditor.trigger('keyboard', 'editor.action.fontZoomReset', null);
    }
    closeAllMenus();
}

// === FUNCIONES DE EJECUCIÓN ===

function runCurrentFile() {
    showToast('Ejecutando archivo...', 'info');
    closeAllMenus();
}

function debugCurrentFile() {
    showToast('Iniciando debug...', 'info');
    closeAllMenus();
}

// === FUNCIONES DE TERMINAL ===

function createNewTerminal() {
    showToast('Nueva terminal creada', 'success');
    closeAllMenus();
}

function splitTerminal() {
    showToast('Terminal dividida', 'success');
    closeAllMenus();
}

function runInTerminal() {
    showToast('Ejecutando en terminal...', 'info');
    closeAllMenus();
}

// === FUNCIONES DE AYUDA ===

function showWelcome() {
    showToast('Bienvenido a OpenMind AI Editor', 'info');
    closeAllMenus();
}

function showKeyboardShortcuts() {
    const shortcuts = `
        Atajos de Teclado:
        
        Archivo:
        • Ctrl+N - Nuevo archivo
        • Ctrl+S - Guardar
        • Ctrl+K S - Guardar todo
        
        Edición:
        • Ctrl+Z - Deshacer
        • Ctrl+Y - Rehacer
        • Ctrl+F - Buscar
        • Ctrl+H - Reemplazar
        
        Selección:
        • Ctrl+A - Seleccionar todo
        • Alt+Up/Down - Mover línea
        • Shift+Alt+Up/Down - Duplicar línea
        
        Navegación:
        • Ctrl+P - Ir a archivo
        • Ctrl+G - Ir a línea
        • Ctrl+Shift+O - Ir a símbolo
        
        Vista:
        • Ctrl+Shift+E - Toggle explorador
        • Alt+P - Vista previa
    `;
    alert(shortcuts);
    closeAllMenus();
}

function showAbout() {
    showToast('OpenMind AI Editor v1.0 - Editor colaborativo', 'info');
    closeAllMenus();
}

// === ATAJOS DE TECLADO ===

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl+N - Nuevo archivo
        if (e.ctrlKey && e.key === 'n' && !e.shiftKey) {
            e.preventDefault();
            if (typeof showNewFileModal === 'function') {
                showNewFileModal();
            }
        }
        if (e.ctrlKey && e.key === 'o' && !e.shiftKey) {
    e.preventDefault();
    triggerFileOpen();
}
        
        // Ctrl+S - Guardar
        if (e.ctrlKey && e.key === 's' && !e.shiftKey) {
            e.preventDefault();
            saveCurrentFile();
        }
        
        // Alt+P - Preview
        if (e.altKey && e.key === 'p') {
            e.preventDefault();
            if (typeof openPreviewInNewTab === 'function') {
                openPreviewInNewTab();
            }
        }
        
        // Ctrl+Shift+E - Toggle Explorer
        if (e.ctrlKey && e.shiftKey && e.key === 'E') {
            e.preventDefault();
            toggleExplorer();
        }
    });
}

// === FUNCIÓN AUXILIAR TOAST ===
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}


// ================================
// VARIABLES GLOBALES UTILIDADES
// ================================
let allLibraries = [];
let allDesigns = [];
let currentLibraryFilter = 'all';
let currentDesignFilter = 'all';

// ================================
// FUNCIONES PRINCIPALES DEL PANEL
// ================================

function openUtilitiesPanel() {
    const panel = document.getElementById('utilities-panel');
    if (panel) {
        panel.style.display = 'flex';
        loadLibrariesFromDB();
        loadDesignsFromDB();
    }
}

function closeUtilitiesPanel() {
    const panel = document.getElementById('utilities-panel');
    if (panel) {
        panel.style.display = 'none';
    }
}

function switchUtilitiesSection(section) {
    // Actualizar navegación activa
    document.querySelectorAll('.utilities-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.utilities-nav-item').classList.add('active');
    
    // Mostrar sección correspondiente
    document.querySelectorAll('.utilities-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    if (section === 'libraries') {
        document.getElementById('libraries-section').classList.add('active');
    } else if (section === 'designs') {
        document.getElementById('designs-section').classList.add('active');
    }
}

// ================================
// CARGAR LIBRERÍAS DESDE SUPABASE
// ================================

async function loadLibrariesFromDB() {
    try {
        const { data: libraries, error } = await supabaseClient
            .from('cdn_libraries')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;

        allLibraries = libraries || [];
        renderLibraries(allLibraries);
        
    } catch (error) {
        console.error('Error cargando librerías:', error);
        showToast('Error cargando librerías', 'error');
    }
}

function renderLibraries(libraries) {
    const grid = document.getElementById('libraries-grid');
    if (!grid) return;
    
    if (libraries.length === 0) {
        grid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #8892a6;">
                <i class="fas fa-link" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                <h3 style="color: #ffffff; margin-bottom: 8px;">No hay librerías</h3>
                <p>Agrega tu primera librería CDN</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = libraries.map(lib => `
        <div class="utility-card" data-category="${lib.category}">
            <div class="utility-card-header">
                <div>
                    <h4>${lib.name}</h4>
                    ${lib.version ? `<small style="color: #8892a6;">${lib.version}</small>` : ''}
                </div>
                <span class="utility-badge">${lib.category}</span>
            </div>
            <p>${lib.description || 'Sin descripción'}</p>
            <div class="utility-code-preview">
                <code>${escapeHtml(lib.cdn_link)}</code>
            </div>
           <div class="utility-actions">
    <button class="btn-copy" onclick="copyLibraryLink('${lib.id}')">
        <i class="fas fa-copy"></i> Copiar
    </button>
    <button class="btn-download" onclick="downloadLibrary('${lib.id}')">
        <i class="fas fa-download"></i> Descargar
    </button>
    <button class="btn-delete" onclick="deleteLibrary('${lib.id}')">
        <i class="fas fa-trash"></i>
    </button>
</div>
        </div>
    `).join('');
}


async function downloadLibrary(libraryId) {
    try {
        const library = allLibraries.find(lib => lib.id === libraryId);
        if (!library) return;
        
        const response = await fetch(library.cdn_link);
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = library.name.replace(/\s+/g, '-') + '.' + (library.category === 'css' ? 'css' : 'js');
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('Librería descargada', 'success');
    } catch (error) {
        console.error('Error:', error);
        showToast('Error al descargar', 'error');
    }
}

function filterLibrariesByCategory(category) {
    currentLibraryFilter = category;
    
    // Actualizar botones activos
    document.querySelectorAll('#libraries-section .filter-chip').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === category) {
            btn.classList.add('active');
        }
    });
    
    const filtered = category === 'all' 
        ? allLibraries 
        : allLibraries.filter(lib => lib.category === category);
    
    renderLibraries(filtered);
}

function filterUtilities(type) {
    const searchInput = document.getElementById(`search-${type}`);
    const searchTerm = searchInput.value.toLowerCase();
    
    if (type === 'libraries') {
        let filtered = currentLibraryFilter === 'all' 
            ? allLibraries 
            : allLibraries.filter(lib => lib.category === currentLibraryFilter);
        
        if (searchTerm) {
            filtered = filtered.filter(lib => 
                lib.name.toLowerCase().includes(searchTerm) ||
                (lib.description && lib.description.toLowerCase().includes(searchTerm))
            );
        }
        
        renderLibraries(filtered);
    } else if (type === 'designs') {
        let filtered = currentDesignFilter === 'all' 
            ? allDesigns 
            : allDesigns.filter(design => design.category === currentDesignFilter);
        
        if (searchTerm) {
            filtered = filtered.filter(design => 
                design.name.toLowerCase().includes(searchTerm) ||
                (design.description && design.description.toLowerCase().includes(searchTerm))
            );
        }
        
        renderDesigns(filtered);
    }
}

async function copyLibraryLink(libraryId) {
    try {
        const library = allLibraries.find(lib => lib.id === libraryId);
        if (!library) return;
        
        await navigator.clipboard.writeText(library.cdn_link);
        showToast('Link copiado al portapapeles', 'success');
        
    } catch (error) {
        console.error('Error copiando link:', error);
        showToast('Error al copiar', 'error');
    }
}

async function deleteLibrary(libraryId) {
    if (!confirm('¿Eliminar esta librería?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('cdn_libraries')
            .delete()
            .eq('id', libraryId);
        
        if (error) throw error;
        
        showToast('Librería eliminada', 'success');
        await loadLibrariesFromDB();
        
    } catch (error) {
        console.error('Error eliminando librería:', error);
        showToast('Error al eliminar', 'error');
    }
}

// ================================
// CARGAR DISEÑOS DESDE SUPABASE
// ================================

async function loadDesignsFromDB() {
    try {
        const { data: designs, error } = await supabaseClient
            .from('design_components')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;

        allDesigns = designs || [];
        renderDesigns(allDesigns);
        
    } catch (error) {
        console.error('Error cargando diseños:', error);
        showToast('Error cargando diseños', 'error');
    }
}

function renderDesigns(designs) {
    const grid = document.getElementById('designs-grid');
    if (!grid) return;
    
    if (designs.length === 0) {
        grid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #8892a6;">
                <i class="fas fa-palette" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                <h3 style="color: #ffffff; margin-bottom: 8px;">No hay diseños</h3>
                <p>Agrega tu primer componente de diseño</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = designs.map(design => `
        <div class="utility-card design-card" data-category="${design.category}" id="design-card-${design.id}">
            <!-- HEADER FIJO -->
            <div class="design-card-header-fixed">
                <div>
                    <h4>${design.name}</h4>
                    <span class="utility-badge">${design.category}</span>
                </div>
                <button class="btn-delete-header" onclick="deleteDesign('${design.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <!-- Vista Preview (modo inicial) -->
            <div class="design-preview-mode active">
                <div class="design-render-box">
                    <style>${design.css_code || ''}</style>
                    ${design.html_code}
                </div>
                
                <!-- Botón Get Code en esquina superior derecha -->
                <button class="btn-get-code-corner" onclick="toggleCodeView('${design.id}')">
                    <i class="fas fa-code"></i>
                </button>
            </div>
            
            <!-- Vista Código (modo expandido) -->
            <div class="design-code-mode">
                <!-- Botón Go Back -->
                <button class="btn-go-back-corner" onclick="toggleCodeView('${design.id}')">
                    <i class="fas fa-arrow-left"></i> Go back
                </button>
                
                <!-- Layout dividido: Render | Code -->
                <div class="split-view-container">
                    <!-- Lado izquierdo: Renderizado -->
                    <div class="split-render">
                        <div class="split-render-content">
                            <style>${design.css_code || ''}</style>
                            ${design.html_code}
                        </div>
                    </div>
                    
                    <!-- Lado derecho: Código -->
                    <div class="split-code">
                        <div class="code-tabs-header">
                            <div class="code-tabs">
                                <button class="code-tab active" onclick="switchCodeTab('${design.id}', 'html')">
                                    <i class="fab fa-html5"></i> HTML
                                </button>
                                ${design.css_code ? `
                                <button class="code-tab" onclick="switchCodeTab('${design.id}', 'css')">
                                    <i class="fab fa-css3-alt"></i> CSS
                                </button>` : ''}
                                ${design.js_code ? `
                                <button class="code-tab" onclick="switchCodeTab('${design.id}', 'js')">
                                    <i class="fab fa-js"></i> JS
                                </button>` : ''}
                            </div>
                            <button class="btn-copy-inline" onclick="copyCurrentCode('${design.id}')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        
                        <div class="code-content-area">
                            <pre class="code-block active" data-lang="html"><code class="language-html">${escapeHtml(formatCode(design.html_code, 'html'))}</code></pre>
                            ${design.css_code ? `<pre class="code-block" data-lang="css"><code class="language-css">${escapeHtml(formatCode(design.css_code, 'css'))}</code></pre>` : ''}
                           ${design.js_code ? `<pre class="code-block" data-lang="js"><code class="language-javascript">${escapeHtml(formatCode(design.js_code, 'js'))}</code></pre>` : ''}

                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}


function toggleCodeView(designId) {
    const card = document.getElementById(`design-card-${designId}`);
    if (!card) return;
    
    const previewMode = card.querySelector('.design-preview-mode');
    const codeMode = card.querySelector('.design-code-mode');
    
    if (previewMode.classList.contains('active')) {
        previewMode.classList.remove('active');
        codeMode.classList.add('active');
        card.classList.add('expanded');
        
        // Aplicar syntax highlighting
        setTimeout(() => {
            card.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }, 100);
    } else {
        codeMode.classList.remove('active');
        previewMode.classList.add('active');
        card.classList.remove('expanded');
    }
}


// Mostrar código del diseño
function showDesignCode(designId) {
    const card = document.getElementById(`design-card-${designId}`);
    if (!card) return;
    
    const previewView = card.querySelector('.design-preview-view');
    const codeView = card.querySelector('.design-code-view');
    
    previewView.classList.remove('active');
    codeView.classList.add('active');
}

// Volver a mostrar preview
function showDesignPreview(designId) {
    const card = document.getElementById(`design-card-${designId}`);
    if (!card) return;
    
    const previewView = card.querySelector('.design-preview-view');
    const codeView = card.querySelector('.design-code-view');
    
    codeView.classList.remove('active');
    previewView.classList.add('active');
}

// Cambiar entre pestañas de código
function switchCodeTab(designId, lang) {
    const card = document.getElementById(`design-card-${designId}`);
    if (!card) return;
    
    // Actualizar pestañas activas
    card.querySelectorAll('.code-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    card.querySelector(`.code-tab[onclick*="${lang}"]`).classList.add('active');
    
    // Actualizar código visible
    card.querySelectorAll('.code-block').forEach(block => {
        block.classList.remove('active');
    });
    card.querySelector(`.code-block[data-lang="${lang}"]`).classList.add('active');
}

// Copiar código actual visible
async function copyCurrentCode(designId) {
    const card = document.getElementById(`design-card-${designId}`);
    if (!card) return;
    
    const activeBlock = card.querySelector('.code-block.active code');
    if (!activeBlock) return;
    
    try {
        await navigator.clipboard.writeText(activeBlock.textContent);
        showToast('Código copiado', 'success');
    } catch (error) {
        console.error('Error copiando código:', error);
        showToast('Error al copiar', 'error');
    }
}

function filterDesignsByCategory(category) {
    currentDesignFilter = category;
    
    // Actualizar botones activos
    document.querySelectorAll('#designs-section .filter-chip').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === category) {
            btn.classList.add('active');
        }
    });
    
    const filtered = category === 'all' 
        ? allDesigns 
        : allDesigns.filter(design => design.category === category);
    
    renderDesigns(filtered);
}

function previewDesign(designId) {
    const design = allDesigns.find(d => d.id === designId);
    if (!design) return;
    
    const modal = document.getElementById('preview-design-modal');
    const content = document.getElementById('preview-content');
    
    // Crear un iframe aislado para el preview
    content.innerHTML = `
        <style>${design.css_code || ''}</style>
        ${design.html_code}
        ${design.js_code ? `<script>${design.js_code}<\/script>` : ''}
    `;
    
    modal.style.display = 'flex';
}

function closePreviewModal() {
    const modal = document.getElementById('preview-design-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

async function copyDesignCode(designId) {
    const design = allDesigns.find(d => d.id === designId);
    if (!design) return;
    
    const fullCode = `<!-- HTML -->
${design.html_code}

<!-- CSS -->
<style>
${design.css_code || '/* Sin CSS */'}
</style>

${design.js_code ? `<!-- JavaScript -->
<script>
${design.js_code}
<\/script>` : ''}`;
    
    try {
        await navigator.clipboard.writeText(fullCode);
        showToast('Código completo copiado', 'success');
    } catch (error) {
        console.error('Error copiando código:', error);
        showToast('Error al copiar', 'error');
    }
}

async function deleteDesign(designId) {
    if (!confirm('¿Eliminar este diseño?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('design_components')
            .delete()
            .eq('id', designId);
        
        if (error) throw error;
        
        showToast('Diseño eliminado', 'success');
        await loadDesignsFromDB();
        
    } catch (error) {
        console.error('Error eliminando diseño:', error);
        showToast('Error al eliminar', 'error');
    }
}

// ================================
// MODALES PARA AGREGAR
// ================================

function openAddLibraryModal() {
    const modal = document.getElementById('add-library-modal');
    if (modal) {
        modal.style.display = 'flex';
        document.getElementById('add-library-form').reset();
    }
}

function closeAddLibraryModal() {
    const modal = document.getElementById('add-library-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

async function saveNewLibrary(event) {
    event.preventDefault();
    
    const libraryData = {
        name: document.getElementById('lib-name').value.trim(),
        version: document.getElementById('lib-version').value.trim() || null,
        description: document.getElementById('lib-description').value.trim() || null,
        category: document.getElementById('lib-category').value,
        cdn_link: document.getElementById('lib-link').value.trim()
    };
    
    try {
        const { error } = await supabaseClient
            .from('cdn_libraries')
            .insert([libraryData]);
        
        if (error) throw error;
        
        showToast('Librería agregada correctamente', 'success');
        closeAddLibraryModal();
        await loadLibrariesFromDB();
        
    } catch (error) {
        console.error('Error guardando librería:', error);
        showToast('Error al guardar: ' + error.message, 'error');
    }
}

function openAddDesignModal() {
    const modal = document.getElementById('add-design-modal');
    if (modal) {
        modal.style.display = 'flex';
        document.getElementById('add-design-form').reset();
    }
}

function closeAddDesignModal() {
    const modal = document.getElementById('add-design-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

async function saveNewDesign(event) {
    event.preventDefault();
    
    const designData = {
        name: document.getElementById('design-name').value.trim(),
        category: document.getElementById('design-category').value,
        description: document.getElementById('design-description').value.trim() || null,
        html_code: document.getElementById('design-html').value.trim(),
        css_code: document.getElementById('design-css').value.trim() || null,
        js_code: document.getElementById('design-js').value.trim() || null
    };
    
    try {
        const { error } = await supabaseClient
            .from('design_components')
            .insert([designData]);
        
        if (error) throw error;
        
        showToast('Diseño agregado correctamente', 'success');
        closeAddDesignModal();
        await loadDesignsFromDB();
        
    } catch (error) {
        console.error('Error guardando diseño:', error);
        showToast('Error al guardar: ' + error.message, 'error');
    }
}



// ================================
// FUNCIÓN AUXILIAR
// ================================

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Función para formatear código (pretty print)
function formatCode(code, language) {
    if (!code) return '';
    
    // Para HTML
    if (language === 'html') {
        return code
            .replace(/></g, '>\n<')  // Saltos de línea entre tags
            .replace(/\n\s*\n/g, '\n')  // Eliminar líneas vacías múltiples
            .split('\n')
            .map(line => line.trim())
            .filter(line => line)
            .join('\n');
    }
    
    // Para CSS
    if (language === 'css') {
        return code
            .replace(/\{/g, ' {\n  ')
            .replace(/\}/g, '\n}\n')
            .replace(/;/g, ';\n  ')
            .replace(/\n\s*\n/g, '\n')
            .trim();
    }
    
    // Para JS
    if (language === 'js') {
        return code
            .replace(/\{/g, ' {\n  ')
            .replace(/\}/g, '\n}\n')
            .replace(/;/g, ';\n  ')
            .replace(/\n\s*\n/g, '\n')
            .trim();
    }
    
    return code;
}

// Cerrar modales al hacer clic fuera
document.addEventListener('click', function(e) {
    const addLibModal = document.getElementById('add-library-modal');
    const addDesignModal = document.getElementById('add-design-modal');
    const previewModal = document.getElementById('preview-design-modal');
    
    if (e.target === addLibModal) closeAddLibraryModal();
    if (e.target === addDesignModal) closeAddDesignModal();
    if (e.target === previewModal) closePreviewModal();
});



// Interceptar los redibujos de Monaco
if (document.getElementById('monaco-editor-container')) {
    const observer = new MutationObserver(() => {
        if (currentTheme === 'light') {
            const viewLines = document.querySelectorAll('.view-line');
            viewLines.forEach(line => {
                line.style.background = 'transparent';
            });
        }
    });
    
    observer.observe(document.getElementById('monaco-editor-container'), {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style']
    });
}
</script>






<style>
/* Estilos para el dropdown de exportación */

/* === SOLUCIÓN DEFINITIVA - FORZAR OPACIDAD EN CAPAS === */

/* Quitar el fondo blanco que tapa la selección */



/* La capa que TAPA la selección - hacerla transparente */

/* Forzar que la selección sea visible */
[data-theme="light"] .monaco-editor .selected-text {
    background: rgba(59, 130, 246, 0.35) !important;

    z-index: 999999 !important;
}



.export-tools {
    position: relative;
    display: inline-block;
}

.export-dropdown {
    position: relative;
}

.export-btn {
    background: linear-gradient(45deg, #4a9eff, #00d4ff);
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s ease;
}

.export-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
}

.export-dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background: #252526 !important;
    backdrop-filter: blur(20px);
    border: 1px solid #3c3c3c;
   
    padding: 8px 0;
    min-width: 200px;
    z-index: 1000;
    margin-top: 5px;
}

.export-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: none;
    border: none;
    color: #ffffff;
    cursor: pointer;
    font-size: 14px;
    width: 100%;
    text-align: left;
    transition: background 0.2s;
}

.export-option:hover {
    background: rgba(74, 158, 255, 0.2);
}

/* Estilos para IA contextual */
.ai-contextual-modal-content {
    max-width: 2000px;
    width: 89vw;
}

.ai-contextual-modal-content h3 {
    text-align: center;
    margin-bottom: 25px;
    font-size: 22px;
    color: #4a9eff;
}


.ai-contextual-modal-content textarea {
    transition: all 0.3s ease;
}

.ai-contextual-modal-content textarea:focus {
    border-color: #4a9eff;
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
    outline: none;
}

.modal-actions .cancel-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.modal-actions .create-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

@media (max-width: 768px) {
    .ai-contextual-modal-content {
        width: 95vw;
        padding: 20px;
    }
    
    .modal-actions {
        flex-direction: column;
        gap: 10px;
    }
    
    .modal-actions .cancel-btn,
    .modal-actions .create-btn {
        width: 100%;
        justify-content: center;
    }
}

.modal-actions .cancel-btn,
.modal-actions .create-btn {
    padding: 5px ;
    font-size: 10px;

    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.ai-contextual-modal-content .form-group label {
    font-size: 13px;
    font-weight: 600;
    color: #ffffff;
    
}

.selected-code-preview {
    margin-bottom: 20px;
}

.typing-effect {
    color: #4a9eff;
    font-style: italic;
    padding: 15px;
}

.response-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.apply-code-btn {
    background: rgba(34, 197, 94, 0.2);
    border: 1px solid #22c55e;
    color: #22c55e;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.apply-code-btn:hover {
    background: rgba(34, 197, 94, 0.3);
    transform: translateY(-1px);
}

/* Responsive para móviles */
@media (max-width: 768px) {
    .export-dropdown-menu {
        right: auto;
        left: 0;
    }
    
    .ai-contextual-modal-content {
        width: 95vw;
        max-width: none;
    }
}
</style>
</body>
</html>